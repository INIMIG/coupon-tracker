<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025年社區消費大獎賞追蹤器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE', 'primary-dark': '#4B4AB2',
            'boc': '#c1272d', 'boc-dark': '#a01e21',
            'icbc': '#c7000a', 'icbc-dark': '#a00008',
            'macaupass': '#0c6e4f', 'macaupass-dark': '#095338',
            'luso': '#00529b', 'luso-dark': '#003e75',
            'ant': '#2c64ae', 'ant-dark': '#1a4d8a',
            'mpay': '#1e469a', 'mpay-dark': '#173777',
            'gdb': '#e83828', 'gdb-dark': '#b82116'
          }
        }
      }
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
  <div class="max-w-md mx-auto p-4">
    <!-- 標題和計數器 -->
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold text-primary dark:text-primary mb-2">2025年社區消費大獎賞追蹤器</h1>
      <div class="text-sm bg-blue-50 dark:bg-blue-900 p-2 rounded-lg">
        <div>今天：<span id="current-date">載入中...</span> | <span id="current-week">載入中...</span></div>
      </div>
    </div>

    <!-- 主要功能選項卡 -->
    <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
      <ul class="flex flex-wrap" id="tabs">
        <li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-primary dark:text-primary border-b-2 border-primary dark:border-primary tab-active" data-tab="earn">賺取</button></li>
        <li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="redeem">兑換</button></li>
        <li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="history">已兑換</button></li>
        <li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="stats">統計</button></li>
        <li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="charts">圖表</button></li>
        <li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="info">資訊</button></li>
      </ul>
    </div>

    <!-- 賺取優惠券面板 -->
    <div class="tab-content" id="earn-content">
      <!-- 銀行選擇按鈕組 -->
      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <div class="text-sm font-medium">選擇支付工具 (點擊銀行添加優惠券)</div>
        </div>
        <div class="flex justify-between items-center mb-2">
          <button id="bank-display-settings-btn" class="text-xs px-2 py-1 flex items-center bg-primary text-white rounded hover:bg-primary-dark">
            <i class="ri-settings-3-line mr-1"></i> 設定
          </button>
        </div>

        <!-- 銀行優惠券總覽 -->
        <div class="mb-4">
          <h3 class="text-sm font-bold mb-2">各銀行優惠券總覽</h3>
          <div id="bank-overview-list" class="space-y-3"></div>
        </div>
        
        <!-- 銀行顯示設置模態框 -->
        <div id="bank-display-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-full max-w-sm mx-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-lg font-bold">支付工具顯示設定</h3>
              <button id="close-bank-display-settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="ri-close-line text-xl"></i>
              </button>
            </div>
            
            <div class="mb-3">
              <div class="text-sm mb-2">選擇要在主界面顯示的支付工具:</div>
              <div class="flex flex-wrap gap-2 mb-3" id="bank-filters"></div>
              
              <div class="flex space-x-2 mb-2">
                <button id="select-all-display-banks" class="flex-1 bg-primary text-white py-1 px-3 rounded-lg text-sm">全選</button>
                <button id="clear-display-banks" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-1 px-3 rounded-lg text-sm">清空</button>
              </div>
            </div>
            
            <div class="flex justify-end">
              <button id="save-bank-display-settings" class="bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark">
                確定
              </button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-4 gap-2" id="bank-buttons"></div>
      </div>

      <!-- 快速添加優惠券 (當選中銀行時顯示) -->
      <div id="quick-add-container" class="mb-4 hidden">
        <div class="flex justify-between items-center mb-2">
          <div class="text-sm font-medium"><span id="selected-bank-name-display">銀行</span>優惠券 (總計: <span id="total-draws">0</span>/3次)</div>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
          <button data-amount="10" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">10元</button>
          <button data-amount="20" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">20元</button>
          <button data-amount="50" class="quick-add py-2 px-1 bg-green-100 dark:bg-green-900 rounded-lg text-center hover:bg-green-200 dark:hover:bg-green-800 transition-colors">50元</button>
          <button data-amount="100" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">100元</button>
          <button data-amount="200" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">200元</button>
          <button data-amount="0" class="quick-add py-2 px-1 bg-yellow-100 dark:bg-yellow-900 rounded-lg text-center hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors">😄</button>
        </div>
      </div>

      <!-- 數據管理按鈕 -->
      <div class="mt-6 grid grid-cols-2 gap-2">
        <button id="export-data-btn" class="bg-primary hover:bg-primary-dark text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
          <i class="ri-download-line mr-1"></i> 匯出數據
        </button>
        <button id="data-management-btn" class="bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
          <i class="ri-database-2-line mr-1"></i> 備份/恢復
        </button>
      </div>
      
      <!-- 存儲使用量顯示 -->
      <div class="mt-4 p-3 border rounded-lg bg-gray-50 dark:bg-gray-800 text-sm">
        <div class="font-medium mb-2 flex justify-between items-center">
          <span>本地存儲使用量</span>
          <span id="storage-size" class="px-2 py-1 bg-blue-100 dark:bg-blue-900 rounded text-xs">計算中...</span>
        </div>
        <div class="relative pt-1">
          <div class="flex mb-1 items-center justify-between">
            <div class="text-xs text-gray-500">已使用</div>
            <div class="text-xs text-right"><span id="storage-percentage">0</span>%</div>
          </div>
          <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200 dark:bg-gray-700">
            <div id="storage-bar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary" style="width: 0%"></div>
          </div>
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          瀏覽器存儲限制：約 5 MB (移動設備可能更少)
        </div>
      </div>
    </div>

    <!-- 兑換優惠券面板 -->
    <div class="tab-content hidden" id="redeem-content">
      <!-- 優惠券計算器 -->
      <div class="mb-4 bg-green-50 dark:bg-green-900/20 rounded-lg p-3 shadow">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-sm font-medium">優惠券計算器</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">輸入金額計算最佳組合</div>
          </div>
        </div>
        
        <div class="flex space-x-2">
          <input type="number" id="payment-amount" min="1" placeholder="輸入消費金額" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
          <button id="calculate-recommendation" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
            計算
          </button>
        </div>
        
        <!-- 計算結果區域 -->
        <div id="recommendation-result" class="mt-3 border rounded-lg p-3 bg-white dark:bg-gray-800 hidden"></div>
      </div>
      
      <!-- 可用優惠券總覽 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-sm font-bold">可用優惠券總覽</h3>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            未使用: <span id="unused-vouchers-count" class="font-bold text-green-600 dark:text-green-400">0</span>張
          </div>
        </div>
        <div id="redeemable-vouchers-list" class="space-y-2"></div>
      </div>

      <!-- 完全合併後的優惠券選擇和兑換區域 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-sm font-bold">選擇並兑換優惠券</h3>
          <div id="selection-summary" class="text-sm">
            已選: <span id="selected-vouchers-count">0</span>張 (<span id="selected-vouchers-value">0</span>元)
          </div>
        </div>
        
        <!-- 優惠券選擇區域 -->
        <div id="redeem-voucher-selection" class="space-y-3 mb-4"></div>
        
        <!-- 兑換操作區域 - 只在有選擇優惠券時顯示 -->
        <div id="redeem-operations" class="mt-3 hidden">
          <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            消費金額必須為優惠券總額的3倍或以上才能兑換
          </div>
          <div class="grid grid-cols-1 gap-2">
            <div id="redeem-amount-info" class="text-sm text-gray-700 dark:text-gray-300 py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
              最低需消費金額: <span id="min-redeem-amount">0</span>元
            </div>
            <div>
              <input type="number" id="manual-spend-amount" placeholder="實際消費金額" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600 mb-2">
              
              <div class="mb-2">
                <div class="text-sm font-medium mb-2">消費類別 (可多選):</div>
                <div class="grid grid-cols-4 gap-2">
                  <label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
                    <input type="checkbox" name="expense-category" value="food" class="expense-category">
                    <span class="text-sm">食品</span>
                  </label>
                  <label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
                    <input type="checkbox" name="expense-category" value="clothing" class="expense-category">
                    <span class="text-sm">服飾</span>
                  </label>
                  <label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
                    <input type="checkbox" name="expense-category" value="entertainment" class="expense-category">
                    <span class="text-sm">娛樂</span>
                  </label>
                  <label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
                    <input type="checkbox" name="expense-category" value="pet" class="expense-category">
                    <span class="text-sm">寵物</span>
                  </label>
                  <label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
                    <input type="checkbox" name="expense-category" value="transport" class="expense-category">
                    <span class="text-sm">交通</span>
                  </label>
                  <label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
                    <input type="checkbox" name="expense-category" value="children" class="expense-category">
                    <span class="text-sm">兒童</span>
                  </label>
                  <label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
                    <input type="checkbox" name="expense-category" value="electronics" class="expense-category">
                    <span class="text-sm">電子</span>
                  </label>
                  <label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
                    <input type="checkbox" name="expense-category" value="other" class="expense-category">
                    <span class="text-sm">其他</span>
                  </label>
                </div>
              </div>
              
              <textarea id="redeem-remark" placeholder="消費内容備註 (選填)" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600 mb-2" rows="2"></textarea>
              <button id="redeem-selected-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
                兑換優惠券
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 已兑換記錄面板 -->
    <div class="tab-content hidden" id="history-content">
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">兑換記錄</h3>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            總計: <span id="redeemed-total-count" class="font-bold">0</span>張
          </div>
        </div>
        
        <div id="redemption-history-list" class="space-y-3">
          <div class="text-center text-gray-500 dark:text-gray-400 py-4">尚無兑換記錄</div>
        </div>
      </div>
    </div>

    <!-- 統計圖表面板 -->
    <div class="tab-content hidden" id="stats-content">
      <!-- 總體統計 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
        <h3 class="font-bold mb-2">總體統計</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">總優惠券</div>
            <div class="text-xl font-bold" id="total-vouchers">0張</div>
          </div>
          <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">總價值</div>
            <div class="text-xl font-bold" id="total-value">0元</div>
          </div>
          <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">已兑換率</div>
            <div class="text-xl font-bold" id="usage-rate">0%</div>
          </div>
          <div class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">已過期率</div>
            <div class="text-xl font-bold" id="expiry-rate">0%</div>
          </div>
        </div>
      </div>
      
      <!-- 深入分析報告 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <h3 class="font-bold mb-3">深入分析報告</h3>
        <div id="detailed-analysis" class="space-y-4">
          <div>
            <h4 class="font-medium text-primary dark:text-primary mb-2">面值分佈分析</h4>
            <div id="value-distribution-analysis" class="text-sm space-y-2">
              <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                <span>面值</span>
                <span>數量</span>
                <span>佔比</span>
              </div>
              <div id="value-distribution-rows">
                <div class="text-center text-gray-500 dark:text-gray-400 py-2">加載中...</div>
              </div>
              <div id="value-distribution-summary" class="mt-2 text-gray-600 dark:text-gray-300"></div>
            </div>
          </div>
          
          <div>
            <h4 class="font-medium text-primary dark:text-primary mb-2">銀行優惠券分析</h4>
            <div id="bank-distribution-analysis" class="text-sm space-y-2">
              <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                <span>銀行</span>
                <span>數量</span>
                <span>總值</span>
              </div>
              <div id="bank-distribution-rows">
                <div class="text-center text-gray-500 dark:text-gray-400 py-2">加載中...</div>
              </div>
              <div id="bank-distribution-summary" class="mt-2 text-gray-600 dark:text-gray-300"></div>
            </div>
          </div>
          
          <div>
            <h4 class="font-medium text-primary dark:text-primary mb-2">使用狀態分析</h4>
            <div id="status-distribution-analysis" class="text-sm space-y-2">
              <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                <span>狀態</span>
                <span>數量</span>
                <span>佔比</span>
              </div>
              <div id="status-distribution-rows">
                <div class="text-center text-gray-500 dark:text-gray-400 py-2">加載中...</div>
              </div>
              <div id="status-distribution-summary" class="mt-2 text-gray-600 dark:text-gray-300"></div>
            </div>
          </div>
          
          <div>
            <h4 class="font-medium text-primary dark:text-primary mb-2">兑換效率分析</h4>
            <div id="redemption-efficiency-analysis" class="text-sm space-y-2">
              <div id="redemption-efficiency-content">
                <div class="text-center text-gray-500 dark:text-gray-400 py-2">加載中...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 週次記錄 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">週次記錄</h3>
          <div class="flex space-x-2">
            <select id="week-history-select" class="text-sm border rounded-lg px-2 py-1 dark:bg-gray-700 dark:border-gray-600">
              <option value="">-- 選擇週次 --</option>
            </select>
          </div>
        </div>
        <div id="week-records-list" class="space-y-3"></div>
      </div>
    </div>
    
    <!-- 圖表分析面板 -->
    <div class="tab-content hidden" id="charts-content">
      <!-- 狀態分佈圖表 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <h3 class="font-bold mb-3">優惠券狀態分佈</h3>
        <div class="h-60">
          <canvas id="status-chart"></canvas>
        </div>
      </div>
      
      <!-- 面值和銀行分佈圖表 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <h3 class="font-bold mb-3">優惠券分佈</h3>
        <div class="flex justify-center gap-4 mb-2">
          <button id="show-value-chart" class="bg-primary text-white px-3 py-1 rounded text-sm">面值分佈</button>
          <button id="show-bank-chart" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded text-sm">銀行金額</button>
        </div>
        <div class="h-72">
          <canvas id="combined-chart"></canvas>
        </div>
      </div>
      
      <!-- 消費類別分佈圖表 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <h3 class="font-bold mb-3">消費類別分佈</h3>
        <div class="flex justify-center gap-4 mb-2">
          <button id="show-category-count" class="bg-primary text-white px-3 py-1 rounded text-sm">按次數</button>
          <button id="show-category-amount" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded text-sm">按金額</button>
        </div>
        <div class="h-60">
          <canvas id="category-chart"></canvas>
        </div>
      </div>
      
      <!-- 週次趨勢圖表 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <h3 class="font-bold mb-3">週次優惠券金額趨勢</h3>
        <div class="h-60">
          <canvas id="weekly-trend-chart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- 活動資訊面板 -->
    <div class="tab-content hidden" id="info-content">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">活動時間</h3>
        <p class="mb-2">2025年3月24日至2025年6月1日</p>
        <h3 class="font-bold mb-2 mt-4">抽獎資格</h3>
        <p class="mb-2">週一至週五在每間承辦機構支付工具消費滿50澳門元，可獲3次抽獎機會</p>
        <p class="mb-2">週末消費滿50澳門元，可獲得週抽獎及終極大抽獎資格</p>
        <h3 class="font-bold mb-2 mt-4">優惠券面值</h3>
        <p class="mb-2">10、20、50、100 或 200 澳門元，或是抽中「笑臉」</p>
        <h3 class="font-bold mb-2 mt-4">使用限制</h3>
        <p class="mb-2">優惠券須於獲得後緊接的週六及週日使用，逾期無效</p>
        <p class="mb-2">兑換時消費金額必須為優惠券總額的3倍或以上</p>
        <p class="mb-2">抽中「笑臉」的優惠券不能兑換</p>
        <h3 class="font-bold mb-2 mt-4">週期時間表</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b dark:border-gray-700">
                <th class="text-left py-2">週次</th>
                <th class="text-left py-2">活動時間</th>
                <th class="text-left py-2">清零時間</th>
              </tr>
            </thead>
            <tbody id="week-schedule"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 查看週次詳情模態框 -->
    <div id="week-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold" id="week-detail-title">週次詳情</h3>
          <button id="close-week-detail" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        <div id="week-detail-content"></div>
        <div class="mt-4 flex justify-end">
          <button id="close-detail-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            關閉
          </button>
        </div>
      </div>
    </div>
    
    <!-- 確認兑換模態框 -->
    <div id="confirm-redeem-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">確認兑換</h3>
        <p class="mb-4 text-sm">確定要兑換以下優惠券嗎？</p>
        <div id="redeem-vouchers-info" class="mb-4 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"></div>
        <div class="flex space-x-2">
          <button id="cancel-redeem" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">取消</button>
          <button id="confirm-redeem" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">確認兑換</button>
        </div>
      </div>
    </div>
    
    <!-- 兑換記錄詳情模態框 -->
    <div id="redemption-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold" id="redemption-detail-title">兑換詳情</h3>
          <button id="close-redemption-detail" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        <div id="redemption-detail-content"></div>
        <div class="mt-4 flex justify-end space-x-2">
          <!-- 撤回兑換按鈕 -->
          <button id="withdraw-redemption-btn" class="py-2 px-4 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors">
            撤回兑換
          </button>
          <button id="close-redemption-detail-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            關閉
          </button>
        </div>
      </div>
    </div>
    
    <!-- 數據管理模態框 -->
    <div id="data-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">數據管理</h3>
          <button id="close-data-management" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div class="space-y-4">
          <!-- 存儲使用信息 -->
          <div class="mb-3 border-b pb-4 dark:border-gray-700">
            <h4 class="font-medium mb-2">存儲使用情況</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded">
                <div class="text-xs text-gray-500 dark:text-gray-400">已使用空間</div>
                <div id="storage-used-modal" class="font-bold">計算中...</div>
              </div>
              <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded">
                <div class="text-xs text-gray-500 dark:text-gray-400">瀏覽器限制</div>
                <div id="storage-limit" class="font-bold">5 MB (預估)</div>
              </div>
            </div>
            <div class="mt-2">
              <div class="relative pt-1">
                <div class="flex mb-1 items-center justify-between">
                  <div class="text-xs">已使用空間</div>
                  <div class="text-xs text-right"><span id="storage-percentage-modal">0</span>%</div>
                </div>
                <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200 dark:bg-gray-700">
                  <div id="storage-bar-modal" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary" style="width: 0%"></div>
                </div>
              </div>
            </div>
            
            <!-- 添加詳細存儲信息 -->
            <div class="mt-3 text-xs">
              <div class="font-medium mb-1">存儲內容明細：</div>
              <div class="space-y-1 pl-2">
                <div class="flex justify-between">
                  <span>優惠券記錄:</span>
                  <span id="vouchers-size">計算中...</span>
                </div>
                <div class="flex justify-between">
                  <span>兑換記錄:</span>
                  <span id="redemption-size">計算中...</span>
                </div>
                <div class="flex justify-between">
                  <span>週次記錄:</span>
                  <span id="week-records-size">計算中...</span>
                </div>
                <div class="flex justify-between">
                  <span>其他數據:</span>
                  <span id="other-data-size">計算中...</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="border-b pb-4 dark:border-gray-700">
            <h4 class="font-medium mb-2">備份數據</h4>
            <p class="text-sm mb-2">將您的數據備份到手機，以防止數據丟失。</p>
            
            <div class="border p-2 bg-gray-50 dark:bg-gray-700 rounded-lg mb-3">
              <p class="text-xs mb-1 text-gray-500 dark:text-gray-400">您的備份碼：</p>
              <p id="backup-code" class="text-xs break-all font-mono bg-white dark:bg-gray-800 p-2 rounded border max-h-20 overflow-y-auto"></p>
            </div>
            
            <div class="flex space-x-2">
              <button id="copy-backup-code" class="flex-1 bg-primary text-white py-2 px-3 rounded-lg hover:bg-primary-dark flex items-center justify-center">
                <i class="ri-file-copy-line mr-1"></i> 複製備份碼
              </button>
            </div>
          </div>
          
          <div>
            <h4 class="font-medium mb-2">恢復數據</h4>
            <p class="text-sm mb-2">從之前的備份中恢復您的數據。</p>
            
            <div class="bg-yellow-50 dark:bg-yellow-900/30 p-2 rounded-lg text-sm text-yellow-800 dark:text-yellow-200 mb-3">
              <strong>注意：</strong> 恢復數據將覆蓋當前所有數據，無法撤銷！
            </div>
            
            <textarea id="import-data-textarea" class="w-full h-24 p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-sm font-mono mb-3" placeholder="在此粘貼您的備份碼..."></textarea>
            
            <div class="flex space-x-2">
              <button id="restore-data-btn" class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700 flex items-center justify-center">
                <i class="ri-refresh-line mr-1"></i> 恢復數據
              </button>
            </div>
          </div>
        </div>
        
        <div class="mt-4 flex justify-end">
          <button id="close-management-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            關閉
          </button>
        </div>
      </div>
    </div>
    
    <!-- 匯出數據模態框 -->
    <div id="export-data-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">匯出數據</h3>
          <button id="close-export-data" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div>
          <p class="mb-2 text-sm">以下是您的優惠券統計數據：</p>
          
          <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg mb-3 text-sm space-y-4">
            <div>
              <h4 class="font-medium mb-1 text-primary">優惠券總覽</h4>
              <div id="export-summary" class="space-y-1"></div>
            </div>
            
            <div>
              <h4 class="font-medium mb-1 text-primary">面值分佈</h4>
              <div id="export-value-distribution" class="space-y-1"></div>
            </div>
            
            <div>
              <h4 class="font-medium mb-1 text-primary">銀行分佈</h4>
              <div id="export-bank-distribution" class="space-y-1"></div>
            </div>
            
            <div>
              <h4 class="font-medium mb-1 text-primary">消費類別分佈</h4>
              <div id="export-category-distribution" class="space-y-1"></div>
            </div>
            
            <div>
              <h4 class="font-medium mb-1 text-primary">週次數據</h4>
              <div id="export-weekly-data" class="space-y-1"></div>
            </div>
            
            <button id="download-export-btn" class="w-full py-2 px-3 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors flex items-center justify-center">
              <i class="ri-download-line mr-1"></i> 下載統計報告
            </button>
          </div>
          
          <div class="flex space-x-2">
            <button id="copy-export-data-btn" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">
              複製報告
            </button>
            <button id="close-export-modal-btn" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
              關閉
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 確認撤回兑換模態框 -->
    <div id="confirm-withdraw-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">確認撤回兑換</h3>
        <p class="mb-4 text-sm text-yellow-600 dark:text-yellow-400">
          <i class="ri-alert-line text-lg mr-1"></i>
          此操作將撤回所選兑換記錄，並將優惠券狀態恢復為未使用。請確認這是您想要的操作。
        </p>
        <div id="withdraw-vouchers-info" class="mb-4 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"></div>
        <div class="flex space-x-2">
          <button id="cancel-withdraw" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">取消</button>
          <button id="confirm-withdraw" class="flex-1 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">確認撤回</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 深色模式設置
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
    });

    // 消費類別定義
    const expenseCategories = [
      { id: 'food', name: '食品', color: '#20c997', icon: 'ri-restaurant-line' },
      { id: 'clothing', name: '服飾', color: '#6f42c1', icon: 'ri-t-shirt-line' },
      { id: 'entertainment', name: '娛樂', color: '#fd7e14', icon: 'ri-gamepad-line' },
      { id: 'pet', name: '寵物', color: '#e83e8c', icon: 'ri-footprint-line' },
      { id: 'transport', name: '交通', color: '#0d6efd', icon: 'ri-car-line' },
      { id: 'children', name: '兒童', color: '#ff78c7', icon: 'ri-parent-line' },
      { id: 'electronics', name: '電子', color: '#3a86ff', icon: 'ri-computer-line' },
      { id: 'other', name: '其他', color: '#6c757d', icon: 'ri-more-line' }
    ];

    // 活動週期數據
    const weekSchedule = [
      { week: 1, startDate: '2025-03-24', endDate: '2025-03-28', resetDate: '2025-03-29' },
      { week: 2, startDate: '2025-03-31', endDate: '2025-04-04', resetDate: '2025-04-05' },
      { week: 3, startDate: '2025-04-07', endDate: '2025-04-11', resetDate: '2025-04-12' },
      { week: 4, startDate: '2025-04-14', endDate: '2025-04-18', resetDate: '2025-04-19' },
      { week: 5, startDate: '2025-04-21', endDate: '2025-04-25', resetDate: '2025-04-26' },
      { week: 6, startDate: '2025-04-28', endDate: '2025-05-02', resetDate: '2025-05-03' },
      { week: 7, startDate: '2025-05-05', endDate: '2025-05-09', resetDate: '2025-05-10' },
      { week: 8, startDate: '2025-05-12', endDate: '2025-05-16', resetDate: '2025-05-17' },
      { week: 9, startDate: '2025-05-19', endDate: '2025-05-23', resetDate: '2025-05-24' },
      { week: 10, startDate: '2025-05-26', endDate: '2025-05-30', resetDate: '2025-05-31' }
    ];

    // 銀行支付工具
    const banks = [
      { id: 'boc', name: '中國銀行', color: 'boc', darkColor: 'boc-dark', logo: 'ri-bank-fill' },
      { id: 'icbc', name: '工商銀行', color: 'icbc', darkColor: 'icbc-dark', logo: 'ri-bank-fill' },
      { id: 'luso', name: '大豐銀行', color: 'luso', darkColor: 'luso-dark', logo: 'ri-bank-fill' },
      { id: 'bnu', name: '澳門國際銀行', color: 'primary', darkColor: 'primary-dark', logo: 'ri-bank-fill' },
      { id: 'macaupass', name: '澳門通', color: 'macaupass', darkColor: 'macaupass-dark', logo: 'ri-bank-card-fill' },
      { id: 'ant', name: '螞蟻銀行', color: 'ant', darkColor: 'ant-dark', logo: 'ri-bank-fill' },
      { id: 'mpay', name: '澳門極易付', color: 'mpay', darkColor: 'mpay-dark', logo: 'ri-wallet-fill' },
      { id: 'gdb', name: '廣發銀行', color: 'gdb', darkColor: 'gdb-dark', logo: 'ri-bank-fill' }
    ];

    // 初始化应用程序状态
    let appState = {
      vouchers: [],
      currentWeek: 1,
      preferredBank: null,
      weekRecords: [],
      selectedVouchers: [],
      redemptionHistory: [],
      nextRedemptionId: 1, // 從1開始的消費編號
      bankDisplayFilter: banks.map(bank => bank.id), // 初始化顯示所有銀行
      bankFilter: { active: false, selectedBanks: [] } // 初始化銀行篩選
    };

    // 圖表實例
    let statusChart, categoryChart, weeklyTrendChart, combinedChart;
    let currentChartMode = 'value'; // 當前顯示的是面值圖表還是銀行圖表
    let currentCategoryMode = 'count'; // 當前顯示的是按次數還是按金額
    let tempSelectedVouchers = []; // 臨時儲存兑換確認的優惠券
    let tempRedeemCategories = []; // 臨時儲存兑換類別
    let tempRedeemRemark = ''; // 臨時儲存兑換備註
    let currentRedemptionId = null; // 當前查看的兑換記錄ID，用於撤回功能
    
    /* ---------- 核心功能 ---------- */
    
    // 加載數據
    function loadAppState() {
      try {
        const savedState = localStorage.getItem('voucherAppState');
        if (savedState) {
          appState = JSON.parse(savedState);
          if (!appState.selectedVouchers) appState.selectedVouchers = [];
          if (!appState.weekRecords) appState.weekRecords = [];
          if (!appState.redemptionHistory) appState.redemptionHistory = [];
          // 確保有下一個消費編號
          if (!appState.nextRedemptionId) {
            appState.nextRedemptionId = appState.redemptionHistory.length > 0 ? 
              Math.max(...appState.redemptionHistory.map(r => Number(r.displayId) || 0)) + 1 : 1;
          }
          
          // 處理舊版本數據兼容性 - 在舊記錄中添加消費類別屬性
          appState.redemptionHistory.forEach(redemption => {
            if (!redemption.categories) {
              redemption.categories = ['other']; // 默認為其他類別
            }
          });
          
          // 確保銀行過濾和顯示設定已初始化
          if (!appState.bankDisplayFilter) {
            appState.bankDisplayFilter = banks.map(bank => bank.id);
          }
          
          if (!appState.bankFilter) {
            appState.bankFilter = {
              active: false,
              selectedBanks: []
            };
          }
        }
        
        // 更新當前週次
        appState.currentWeek = calculateCurrentWeek();
        
        // 更新週次記錄
        updateWeekRecords();
      } catch (e) {
        console.error('Failed to load app state:', e);
      }
    }

    // 保存數據
    function saveAppState() {
      try {
        localStorage.setItem('voucherAppState', JSON.stringify(appState));
        // 更新存儲使用量
        calculateStorageSize();
      } catch (e) {
        console.error('Failed to save app state:', e);
        alert('存儲數據失敗，可能是因為瀏覽器存儲空間已滿！');
      }
    }
    
    // 計算存儲大小
    function calculateStorageSize() {
      try {
        // 計算整個 appState 的大小
        const totalData = JSON.stringify(appState);
        const totalSizeBytes = new TextEncoder().encode(totalData).length;
        const totalSizeKB = (totalSizeBytes / 1024).toFixed(2);
        const totalSizeMB = (totalSizeBytes / (1024 * 1024)).toFixed(3);
        
        // 計算各部分的大小
        const vouchersData = JSON.stringify(appState.vouchers);
        const vouchersSizeKB = (new TextEncoder().encode(vouchersData).length / 1024).toFixed(2);
        
        const redemptionData = JSON.stringify(appState.redemptionHistory);
        const redemptionSizeKB = (new TextEncoder().encode(redemptionData).length / 1024).toFixed(2);
        
        const weekRecordsData = JSON.stringify(appState.weekRecords);
        const weekRecordsSizeKB = (new TextEncoder().encode(weekRecordsData).length / 1024).toFixed(2);
        
        // 其他數據大小
        const otherDataSizeKB = (totalSizeBytes / 1024 - 
                               parseFloat(vouchersSizeKB) - 
                               parseFloat(redemptionSizeKB) - 
                               parseFloat(weekRecordsSizeKB)).toFixed(2);
        
        // 估算使用率 (5MB 大約是瀏覽器限制)
        const estimatedPercentage = Math.min(Math.round(totalSizeBytes / (5 * 1024 * 1024) * 100), 100);
        
        // 更新主頁面存儲信息
        document.getElementById('storage-size').textContent = `${totalSizeKB} KB (${totalSizeMB} MB)`;
        document.getElementById('storage-percentage').textContent = estimatedPercentage;
        document.getElementById('storage-bar').style.width = `${estimatedPercentage}%`;
        
        // 更新模態框中的存儲信息
        if (document.getElementById('storage-used-modal')) {
          document.getElementById('storage-used-modal').textContent = `${totalSizeKB} KB`;
          document.getElementById('storage-percentage-modal').textContent = estimatedPercentage;
          document.getElementById('storage-bar-modal').style.width = `${estimatedPercentage}%`;
          
          // 更新詳細數據大小
          document.getElementById('vouchers-size').textContent = `${vouchersSizeKB} KB`;
          document.getElementById('redemption-size').textContent = `${redemptionSizeKB} KB`;
          document.getElementById('week-records-size').textContent = `${weekRecordsSizeKB} KB`;
          document.getElementById('other-data-size').textContent = `${otherDataSizeKB} KB`;
        }
        
        // 根據使用率改變顏色
        const storageBar = document.getElementById('storage-bar');
        const storageBarModal = document.getElementById('storage-bar-modal');
        
        if (estimatedPercentage > 80) {
          storageBar.classList.remove('bg-primary');
          storageBar.classList.add('bg-red-500');
          if (storageBarModal) {
            storageBarModal.classList.remove('bg-primary');
            storageBarModal.classList.add('bg-red-500');
          }
        } else if (estimatedPercentage > 60) {
          storageBar.classList.remove('bg-primary', 'bg-red-500');
          storageBar.classList.add('bg-yellow-500');
          if (storageBarModal) {
            storageBarModal.classList.remove('bg-primary', 'bg-red-500');
            storageBarModal.classList.add('bg-yellow-500');
          }
        } else {
          storageBar.classList.remove('bg-yellow-500', 'bg-red-500');
          storageBar.classList.add('bg-primary');
          if (storageBarModal) {
            storageBarModal.classList.remove('bg-yellow-500', 'bg-red-500');
            storageBarModal.classList.add('bg-primary');
          }
        }
        
        return totalSizeBytes;
      } catch (e) {
        console.error('計算存儲大小時出錯:', e);
        return 0;
      }
    }

    // 計算當前週次
    function calculateCurrentWeek() {
      const today = new Date();
      const dateString = today.toISOString().split('T')[0];
      
      for (let i = 0; i < weekSchedule.length; i++) {
        if (dateString >= weekSchedule[i].startDate && dateString <= weekSchedule[i].endDate) {
          return i + 1;
        }
      }
      
      // 如果在週末
      for (let i = 0; i < weekSchedule.length - 1; i++) {
        if (dateString > weekSchedule[i].endDate && dateString < weekSchedule[i + 1].startDate) {
          return i + 1;
        }
      }
      
      return dateString < weekSchedule[0].startDate ? 0 : 11;
    }

    // 格式化日期
    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getMonth() + 1}月${date.getDate()}日`;
    }

    // 根據日期獲取週次
    function getWeekNumberFromDate(dateString) {
      for (let i = 0; i < weekSchedule.length; i++) {
        if (dateString >= weekSchedule[i].startDate && dateString <= weekSchedule[i].endDate) {
          return i + 1;
        }
      }
      
      // 檢查週末
      for (let i = 0; i < weekSchedule.length; i++) {
        const resetDate = weekSchedule[i].resetDate;
        const nextDay = new Date(resetDate);
        nextDay.setDate(nextDay.getDate() + 1);
        const nextDayStr = nextDay.toISOString().split('T')[0];
        
        if (dateString === resetDate || dateString === nextDayStr) {
          return i + 1;
        }
      }
      
      return 1;
    }

    // 判斷優惠券是否過期
    function isVoucherExpired(voucher) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const weekNum = getWeekNumberFromDate(voucher.date) - 1;
      if (weekNum >= 0 && weekNum < weekSchedule.length) {
        const saturday = new Date(weekSchedule[weekNum].resetDate);
        const sunday = new Date(saturday);
        sunday.setDate(saturday.getDate() + 1);
        sunday.setHours(23, 59, 59, 999);
        
        return today > sunday;
      }
      
      return false;
    }

    // 計算銀行優惠券數量
    function getBankVoucherCount(bankId, weekNum) {
      return appState.vouchers.filter(v => 
        v.bankId === bankId && getWeekNumberFromDate(v.date) === weekNum
      ).length;
    }

    // 獲取銀行名稱
    function getBankName(bankId) {
      const bank = banks.find(b => b.id === bankId);
      return bank ? bank.name : '未知銀行';
    }

    // 格式化消費編號
    function formatRedemptionId(id) {
      return id.toString().padStart(4, '0');
    }

    // 獲取消費類別名稱
    function getCategoryName(categoryId) {
      const category = expenseCategories.find(c => c.id === categoryId);
      return category ? category.name : '其他';
    }

    // 獲取消費類別顏色
    function getCategoryColor(categoryId) {
      const category = expenseCategories.find(c => c.id === categoryId);
      return category ? category.color : '#6c757d';
    }

    // 獲取消費類別圖標
    function getCategoryIcon(categoryId) {
      const category = expenseCategories.find(c => c.id === categoryId);
      return category ? category.icon : 'ri-more-line';
    }
    
    // 判斷優惠券是否可兑換 (新增函數)
    function isVoucherRedeemable(voucher) {
      // 笑臉(0元)優惠券不可兑換
      if (voucher.amount === 0) return false;
      // 已使用或已過期的優惠券不可兑換
      return !voucher.used && !isVoucherExpired(voucher);
    }
    
    // 獲取可兑換優惠券數量 (新增函數)
    function getRedeemableVoucherCount() {
      return appState.vouchers.filter(isVoucherRedeemable).length;
    }
    
    // 獲取可兑換優惠券總值 (新增函數)
    function getRedeemableVoucherValue() {
      return appState.vouchers
        .filter(isVoucherRedeemable)
        .reduce((sum, v) => sum + v.amount, 0);
    }

    /* ---------- UI更新函數 ---------- */

    // 更新日期和週次顯示
    function updateDateDisplay() {
      document.getElementById('current-date').textContent = formatDate(new Date().toISOString().split('T')[0]);
      
      const weekNum = appState.currentWeek;
      const weekElem = document.getElementById('current-week');
      
      if (weekNum === 0) {
        weekElem.textContent = '活動尚未開始';
      } else if (weekNum > 10) {
        weekElem.textContent = '活動已結束';
      } else {
        const weekData = weekSchedule[weekNum - 1];
        weekElem.textContent = `第${weekNum}週 (${formatDate(weekData.startDate)} - ${formatDate(weekData.endDate)})`;
      }
    }

    // 更新週期時間表
    function updateWeekSchedule() {
      const tableBody = document.getElementById('week-schedule');
      tableBody.innerHTML = '';
      
      weekSchedule.forEach(week => {
        const row = document.createElement('tr');
        row.className = 'border-b dark:border-gray-700';
        row.innerHTML = `
          <td class="py-2">第${week.week}週</td>
          <td class="py-2">${formatDate(week.startDate)} - ${formatDate(week.endDate)}</td>
          <td class="py-2">${formatDate(week.resetDate)}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    // 更新銀行按鈕
    function updateBankButtons() {
      const bankButtonsContainer = document.getElementById('bank-buttons');
      bankButtonsContainer.innerHTML = '';
      
      // 根據選中的銀行過濾
      let visibleBanks = [...banks];
      
      // 如果有設置過濾器，且不是顯示全部
      if (appState.bankDisplayFilter && appState.bankDisplayFilter.length > 0) {
        visibleBanks = banks.filter(bank => appState.bankDisplayFilter.includes(bank.id));
      }
      
      // 如果沒有選中任何銀行，顯示所有銀行
      if (visibleBanks.length === 0) {
        visibleBanks = [...banks];
      }
      
      visibleBanks.forEach(bank => {
        const isSelected = appState.preferredBank === bank.id;
        const voucherCount = getBankVoucherCount(bank.id, appState.currentWeek);
        const isDisabled = voucherCount >= 3;
        
        const bankButton = document.createElement('div');
        bankButton.className = `p-2 rounded-lg ${!isDisabled ? 'cursor-pointer' : 'opacity-50'} flex flex-col items-center ${
          isSelected ? `bg-${bank.color} text-white` : `bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700`
        }`;
        bankButton.setAttribute('data-bank-id', bank.id);
        
        bankButton.innerHTML = `
          <i class="${bank.logo} text-2xl ${isSelected ? 'text-white' : `text-${bank.color} dark:text-${bank.color}`}"></i>
          <div class="text-xs mt-1 ${isSelected ? 'text-white' : ''}">${bank.name}</div>
          <div class="text-xs ${isSelected ? 'text-white' : 'text-gray-500 dark:text-gray-400'}">${voucherCount}/3</div>
        `;
        
        if (!isDisabled) {
          bankButton.addEventListener('click', () => {
            appState.preferredBank = bank.id;
            saveAppState();
            updateBankButtons();
            updateQuickAddPanel();
          });
        }
        
        bankButtonsContainer.appendChild(bankButton);
      });
      
      // 如果沒有可顯示的銀行
      if (bankButtonsContainer.children.length === 0) {
        const noResultMsg = document.createElement('div');
        noResultMsg.className = 'col-span-4 text-center py-4 text-gray-500 dark:text-gray-400';
        noResultMsg.textContent = '沒有可顯示的支付工具';
        bankButtonsContainer.appendChild(noResultMsg);
      }
    }

    // 更新快速添加面板
    function updateQuickAddPanel() {
      const quickAddContainer = document.getElementById('quick-add-container');
      
      if (appState.preferredBank) {
        const bank = banks.find(b => b.id === appState.preferredBank);
        document.getElementById('selected-bank-name-display').textContent = bank ? bank.name : '銀行';
        
        const voucherCount = getBankVoucherCount(appState.preferredBank, appState.currentWeek);
        document.getElementById('total-draws').textContent = voucherCount;
        
        // 如果已達到3個，禁用按鈕
        const isDisabled = voucherCount >= 3;
        document.querySelectorAll('.quick-add').forEach(btn => {
          if (isDisabled) {
            btn.classList.add('opacity-50');
            btn.classList.add('cursor-not-allowed');
            btn.disabled = true;
          } else {
            btn.classList.remove('opacity-50');
            btn.classList.remove('cursor-not-allowed');
            btn.disabled = false;
            
            btn.onclick = function() {
              const amount = parseInt(this.getAttribute('data-amount'));
              addVoucher(amount);
            };
          }
        });
        
        quickAddContainer.classList.remove('hidden');
      } else {
        quickAddContainer.classList.add('hidden');
      }
    }

    // 添加優惠券
    function addVoucher(amount) {
      if (!appState.preferredBank) {
        alert('請先選擇銀行！');
        return;
      }
      
      // 檢查是否超過每週3個優惠券限制
      const voucherCount = getBankVoucherCount(appState.preferredBank, appState.currentWeek);
      if (voucherCount >= 3) {
        alert(`${banks.find(b => b.id === appState.preferredBank)?.name || ''}本週已達3張優惠券上限！`);
        return;
      }
      
      // 創建新優惠券
      const newVoucher = {
        id: Date.now().toString(),
        amount: amount,
        date: new Date().toISOString().split('T')[0],
        used: false,
        bankId: appState.preferredBank
      };
      
      // 添加優惠券
      appState.vouchers.push(newVoucher);
      
      // 保存並更新UI
      saveAppState();
      updateWeekRecords();
      updateBankButtons();
      updateQuickAddPanel();
      updateBankOverview();
      updateRedeemableVouchers();
      updateVoucherSelection();
      updateSelectedVouchers();
      updateTotalStats();
      updateWeekRecordsDisplay();
      updateRedemptionHistory();
      updateDetailedAnalysis();
      updateCharts();
    }

    // 刪除優惠券
    function deleteVoucher(voucherId) {
      const index = appState.vouchers.findIndex(v => v.id === voucherId);
      if (index !== -1) {
        appState.vouchers.splice(index, 1);
        
        // 從選擇列表中移除
        appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
        
        saveAppState();
        updateWeekRecords();
        updateBankButtons();
        updateQuickAddPanel();
        updateBankOverview();
        updateRedeemableVouchers();
        updateVoucherSelection();
        updateSelectedVouchers();
        updateTotalStats();
        updateWeekRecordsDisplay();
        updateRedemptionHistory();
        updateDetailedAnalysis();
        updateCharts();
      }
    }
    
    // 初始化銀行過濾器
    function initBankFilters() {
      const bankFiltersContainer = document.getElementById('bank-filters');
      
      // 確保容器和數據已經存在
      if (!bankFiltersContainer) {
        console.error("找不到bank-filters容器");
        return;
      }
      
      // 清空現有內容
      bankFiltersContainer.innerHTML = '';
      
      // 確保銀行顯示過濾器已初始化
      if (!appState.bankDisplayFilter) {
        appState.bankDisplayFilter = banks.map(bank => bank.id);
      }
      
      // 為每個銀行創建過濾按鈕
      banks.forEach(bank => {
        const isSelected = appState.bankDisplayFilter.includes(bank.id);
        
        const filterBtn = document.createElement('button');
        filterBtn.className = `text-xs px-2 py-1 rounded-full flex items-center ${
          isSelected ? 'bg-' + bank.color + ' text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
        }`;
        filterBtn.setAttribute('data-bank', bank.id);
        filterBtn.innerHTML = `<i class="${bank.logo} mr-1"></i> ${bank.name}`;
        
        filterBtn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          
          // 切換選中狀態
          if (appState.bankDisplayFilter.includes(bankId)) {
            appState.bankDisplayFilter = appState.bankDisplayFilter.filter(id => id !== bankId);
          } else {
            appState.bankDisplayFilter.push(bankId);
          }
          
          saveAppState();
          initBankFilters();  // 重新初始化過濾器
        });
        
        bankFiltersContainer.appendChild(filterBtn);
      });
      
      // 添加全選和清空按鈕
      const allBtn = document.createElement('button');
      allBtn.className = 'text-xs px-2 py-1 rounded-full bg-primary text-white';
      allBtn.textContent = '全選';
      allBtn.addEventListener('click', function() {
        appState.bankDisplayFilter = banks.map(bank => bank.id);
        saveAppState();
        initBankFilters();
      });
      
      const clearBtn = document.createElement('button');
      clearBtn.className = 'text-xs px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
      clearBtn.textContent = '清空';
      clearBtn.addEventListener('click', function() {
        appState.bankDisplayFilter = [];
        saveAppState();
        initBankFilters();
      });
      
      bankFiltersContainer.appendChild(allBtn);
      bankFiltersContainer.appendChild(clearBtn);
    }
    
    // 更新銀行優惠券總覽
    function updateBankOverview() {
      const bankOverviewList = document.getElementById('bank-overview-list');
      bankOverviewList.innerHTML = '';
      
      // 計算各銀行面值分佈
      const bankDistribution = {};
      banks.forEach(bank => {
        bankDistribution[bank.id] = {
          0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
          count: 0, total: 0,
          unused: { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0, count: 0, total: 0 }
        };
      });
      
      // 計算總數據
      const totalCounts = {
        0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
        count: 0, total: 0,
        unused: { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0, count: 0, total: 0 },
        redeemable: { count: 0, total: 0 } // 新增可兑換統計
      };
      
      // 統計各銀行優惠券
      appState.vouchers.forEach(voucher => {
        if (voucher.bankId) {
          const bankData = bankDistribution[voucher.bankId];
          if (bankData) {
            // 添加到總數
            bankData[voucher.amount]++;
            bankData.count++;
            if (voucher.amount > 0) bankData.total += voucher.amount;
            
            // 添加到可用數量
            if (!voucher.used && !isVoucherExpired(voucher)) {
              bankData.unused[voucher.amount]++;
              bankData.unused.count++;
              if (voucher.amount > 0) bankData.unused.total += voucher.amount;
            }
            
            // 添加到總計
            totalCounts[voucher.amount]++;
            totalCounts.count++;
            if (voucher.amount > 0) totalCounts.total += voucher.amount;
            
            if (!voucher.used && !isVoucherExpired(voucher)) {
              totalCounts.unused[voucher.amount]++;
              totalCounts.unused.count++;
              if (voucher.amount > 0) totalCounts.unused.total += voucher.amount;
              
              // 更新可兑換統計 (不包含笑臉)
              if (voucher.amount > 0) {
                totalCounts.redeemable.count++;
                totalCounts.redeemable.total += voucher.amount;
              }
            }
          }
        }
      });
      
      // 如果沒有優惠券
      if (totalCounts.count === 0) {
        bankOverviewList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚未添加任何優惠券</div>';
        return;
      }
      
      // 添加總計卡片
      const totalCard = document.createElement('div');
      totalCard.className = 'bg-primary-50 dark:bg-primary-900/30 border-primary border rounded-lg p-3 mt-3';
      
      totalCard.innerHTML = `
        <div class="flex justify-between items-center mb-2 pb-2 border-b dark:border-gray-700">
          <div class="font-bold">總計</div>
          <div class="text-sm">
            ${totalCounts.count}張 (${totalCounts.total}元)
            <div class="text-xs text-green-600 dark:text-green-400">
              可兑換: ${totalCounts.redeemable.count}張 (${totalCounts.redeemable.total}元)
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-6 gap-1 text-center">
          <div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 ${totalCounts[0] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${totalCounts[0]}</div>
            <div class="text-xs">😄</div>
            ${totalCounts.unused[0] > 0 ? `<div class="text-xs text-gray-500 dark:text-gray-400">未使用: ${totalCounts.unused[0]}</div>` : ''}
          </div>
          <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${totalCounts[10] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${totalCounts[10]}</div>
            <div class="text-xs">10元</div>
            ${totalCounts.unused[10] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${totalCounts.unused[10]}</div>` : ''}
          </div>
          <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${totalCounts[20] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${totalCounts[20]}</div>
            <div class="text-xs">20元</div>
            ${totalCounts.unused[20] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${totalCounts.unused[20]}</div>` : ''}
          </div>
          <div class="bg-green-100 dark:bg-green-900 rounded p-2 ${totalCounts[50] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${totalCounts[50]}</div>
            <div class="text-xs">50元</div>
            ${totalCounts.unused[50] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${totalCounts.unused[50]}</div>` : ''}
          </div>
          <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${totalCounts[100] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${totalCounts[100]}</div>
            <div class="text-xs">100元</div>
            ${totalCounts.unused[100] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${totalCounts.unused[100]}</div>` : ''}
          </div>
          <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${totalCounts[200] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${totalCounts[200]}</div>
            <div class="text-xs">200元</div>
            ${totalCounts.unused[200] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${totalCounts.unused[200]}</div>` : ''}
          </div>
        </div>
      `;
      
      bankOverviewList.appendChild(totalCard);
      
      // 銀行過濾功能
      let banksToShow = banks.filter(bank => bankDistribution[bank.id].count > 0);
      
      // 如果篩選器啟用且有選中的銀行，只顯示選中的銀行
      if (appState.bankFilter && appState.bankFilter.active && appState.bankFilter.selectedBanks.length > 0) {
        banksToShow = banksToShow.filter(bank => appState.bankFilter.selectedBanks.includes(bank.id));
      }
      
      // 固定按字母順序排序銀行，避免位置跳動
      banksToShow.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
      
      // 添加各銀行卡片
      banksToShow.forEach(bank => {
        const data = bankDistribution[bank.id];
        
        // 計算可兑換優惠券數量 (不含笑臉)
        const redeemableCount = data.unused[10] + data.unused[20] + data.unused[50] + 
                                data.unused[100] + data.unused[200];
        const redeemableValue = data.unused[10] * 10 + data.unused[20] * 20 + data.unused[50] * 50 + 
                                data.unused[100] * 100 + data.unused[200] * 200;
        
        const bankCard = document.createElement('div');
        bankCard.className = 'bg-white dark:bg-gray-800 border rounded-lg p-3 mt-3';
        bankCard.setAttribute('data-bank-id', bank.id);
        
        bankCard.innerHTML = `
          <div class="flex items-center justify-between mb-2 pb-2 border-b dark:border-gray-700">
            <div class="flex items-center">
              <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
              <span class="font-bold">${bank.name}</span>
            </div>
            <div class="text-sm">
              ${data.count}張 (${data.total}元)
              <div class="text-xs text-green-600 dark:text-green-400">
                可兑換: ${redeemableCount}張 (${redeemableValue}元)
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-6 gap-1 text-center">
            <div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 relative ${data[0] > 0 ? '' : 'opacity-30'}">
              <div class="font-bold">${data[0]}</div>
              <div class="text-xs">😄</div>
              ${data.unused[0] > 0 ? `<div class="text-xs text-gray-500 dark:text-gray-400">未使用: ${data.unused[0]}</div>` : ''}
              <div class="flex gap-1 mt-1">
                <button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="0">+</button>
                <button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="0">-</button>
              </div>
            </div>
            <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 relative ${data[10] > 0 ? '' : 'opacity-30'}">
              <div class="font-bold">${data[10]}</div>
              <div class="text-xs">10元</div>
              ${data.unused[10] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${data.unused[10]}</div>` : ''}
              <div class="flex gap-1 mt-1">
                <button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="10">+</button>
                <button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="10">-</button>
              </div>
            </div>
            <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 relative ${data[20] > 0 ? '' : 'opacity-30'}">
              <div class="font-bold">${data[20]}</div>
              <div class="text-xs">20元</div>
              ${data.unused[20] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${data.unused[20]}</div>` : ''}
              <div class="flex gap-1 mt-1">
                <button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="20">+</button>
                <button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="20">-</button>
              </div>
            </div>
            <div class="bg-green-100 dark:bg-green-900 rounded p-2 relative ${data[50] > 0 ? '' : 'opacity-30'}">
              <div class="font-bold">${data[50]}</div>
              <div class="text-xs">50元</div>
              ${data.unused[50] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${data.unused[50]}</div>` : ''}
              <div class="flex gap-1 mt-1">
                <button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="50">+</button>
                <button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="50">-</button>
              </div>
            </div>
            <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 relative ${data[100] > 0 ? '' : 'opacity-30'}">
              <div class="font-bold">${data[100]}</div>
              <div class="text-xs">100元</div>
              ${data.unused[100] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${data.unused[100]}</div>` : ''}
              <div class="flex gap-1 mt-1">
                <button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="100">+</button>
                <button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="100">-</button>
              </div>
            </div>
            <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 relative ${data[200] > 0 ? '' : 'opacity-30'}">
              <div class="font-bold">${data[200]}</div>
              <div class="text-xs">200元</div>
              ${data.unused[200] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可兑換: ${data.unused[200]}</div>` : ''}
              <div class="flex gap-1 mt-1">
                <button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="200">+</button>
                <button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
                        data-bank="${bank.id}" data-amount="200">-</button>
              </div>
            </div>
          </div>
        `;
        
        bankOverviewList.appendChild(bankCard);
      });
      
      // 如果啟用了篩選但沒有顯示任何銀行
      if (appState.bankFilter && appState.bankFilter.active && banksToShow.length === 0 && appState.bankFilter.selectedBanks.length > 0) {
        const noMatchMessage = document.createElement('div');
        noMatchMessage.className = 'text-center text-gray-500 dark:text-gray-400 py-4 mt-3 bg-gray-100 dark:bg-gray-800 rounded-lg';
        noMatchMessage.innerHTML = '沒有符合篩選條件的銀行';
        bankOverviewList.appendChild(noMatchMessage);
      }
      
      // 添加快速添加按鈕事件
      document.querySelectorAll('.add-voucher-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const amount = parseInt(this.getAttribute('data-amount'));
          
          appState.preferredBank = bankId;
          addVoucher(amount);
        });
      });
      
      // 添加刪除按鈕事件
      document.querySelectorAll('.delete-voucher-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const amount = parseInt(this.getAttribute('data-amount'));
          
          // 找到該銀行該面值的最後一個優惠券
          const voucherToDelete = [...appState.vouchers]
            .filter(v => v.bankId === bankId && v.amount === amount)
            .pop();
            
          if (voucherToDelete) {
            deleteVoucher(voucherToDelete.id);
          }
        });
      });
    }

    // 更新可兑換優惠券列表
    function updateRedeemableVouchers() {
      const redeemableVouchersList = document.getElementById('redeemable-vouchers-list');
      const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);
      
      document.getElementById('unused-vouchers-count').textContent = redeemableVouchers.length;
      
      if (redeemableVouchers.length === 0) {
        redeemableVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">沒有可用的優惠券</div>';
        return;
      }
      
      // 計算各面值的優惠券數量
      const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, total: 0, count: 0};
      const bankCounts = {};
      
      banks.forEach(bank => {
        bankCounts[bank.id] = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, total: 0, count: 0};
      });
      
      redeemableVouchers.forEach(voucher => {
        // 更新面值统计
        valueCounts[voucher.amount]++;
        valueCounts.count++;
        valueCounts.total += voucher.amount;
        
        // 更新银行统计
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId][voucher.amount]++;
          bankCounts[voucher.bankId].count++;
          bankCounts[voucher.bankId].total += voucher.amount;
        }
      });
      
      // 显示總覽
      redeemableVouchersList.innerHTML = `
        <div class="flex justify-between items-center p-2 bg-primary-50 dark:bg-primary-900/20 rounded">
          <div>總計</div>
          <div class="text-right">${valueCounts.count}張 (${valueCounts.total}元)</div>
        </div>
        
        <div class="grid grid-cols-5 gap-1 text-center my-2">
          <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[10] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[10]}</div><div class="text-xs">10元</div>
          </div>
          <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[20] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[20]}</div><div class="text-xs">20元</div>
          </div>
          <div class="bg-green-100 dark:bg-green-900 rounded p-2 ${valueCounts[50] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[50]}</div><div class="text-xs">50元</div>
          </div>
          <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[100] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[100]}</div><div class="text-xs">100元</div>
          </div>
          <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[200] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[200]}</div><div class="text-xs">200元</div>
          </div>
        </div>
      `;
      
      // 添加各銀行摘要
      const sortedBanks = banks
        .filter(bank => bankCounts[bank.id].count > 0)
        .sort((a, b) => bankCounts[b.id].total - bankCounts[a.id].total);
      
      if (sortedBanks.length > 0) {
        const bankSummaryDiv = document.createElement('div');
        bankSummaryDiv.className = 'space-y-1 mt-3';
        
        sortedBanks.forEach(bank => {
          bankSummaryDiv.innerHTML += `
            <div class="flex justify-between items-center p-2 border-b dark:border-gray-700 last:border-0">
              <div class="flex items-center">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                <span>${bank.name}</span>
              </div>
              <div>${bankCounts[bank.id].count}張 (${bankCounts[bank.id].total}元)</div>
            </div>
          `;
        });
        
        redeemableVouchersList.appendChild(bankSummaryDiv);
      }
    }

    // 更新優惠券選擇區域
    function updateVoucherSelection() {
      const redeemedVoucherSelection = document.getElementById('redeem-voucher-selection');
      
      // 獲取未使用的可兑換優惠券
      const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);
      
      if (redeemableVouchers.length === 0) {
        redeemedVoucherSelection.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">沒有可用的優惠券</div>';
        return;
      }
      
      // 按銀行分組
      const vouchersByBank = {};
      redeemableVouchers.forEach(voucher => {
        if (!vouchersByBank[voucher.bankId]) vouchersByBank[voucher.bankId] = [];
        vouchersByBank[voucher.bankId].push(voucher);
      });
      
      redeemedVoucherSelection.innerHTML = '';
      
      // 按銀行名稱排序
      const sortedBanks = banks
        .filter(bank => vouchersByBank[bank.id] && vouchersByBank[bank.id].length > 0)
        .sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
      
      // 面值顏色
      const amountColors = {
        10: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100',
        20: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100',
        50: 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100',
        100: 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-100',
        200: 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-100'
      };
      
      sortedBanks.forEach(bank => {
        const bankVouchers = vouchersByBank[bank.id] || [];
        
        const bankSection = document.createElement('div');
        bankSection.className = 'border rounded-lg overflow-hidden';
        
        bankSection.innerHTML = `
          <div class="bg-${bank.color} bg-opacity-20 dark:bg-opacity-30 p-2 flex justify-between items-center">
            <div class="flex items-center font-bold">
              <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
              <span>${bank.name}</span>
            </div>
            <div class="flex items-center space-x-2">
              <button class="select-all-bank-btn text-xs bg-white dark:bg-gray-700 px-2 py-0.5 rounded"
                      data-bank="${bank.id}">全選</button>
              <div class="text-gray-700 dark:text-gray-300">${bankVouchers.length}張</div>
            </div>
          </div>
        `;
        
        // 按面值分組
        const vouchersByAmount = {};
        bankVouchers.forEach(voucher => {
          if (!vouchersByAmount[voucher.amount]) vouchersByAmount[voucher.amount] = [];
          vouchersByAmount[voucher.amount].push(voucher);
        });
        
        // 添加優惠券列表
        const vouchersList = document.createElement('div');
        vouchersList.className = 'p-2 space-y-1 bg-white dark:bg-gray-800';
        
        // 按面值從大到小顯示
        const amounts = [200, 100, 50, 20, 10].filter(a => vouchersByAmount[a]?.length > 0);
        
        amounts.forEach(amount => {
          const amountVouchers = vouchersByAmount[amount] || [];
          
          vouchersList.innerHTML += `
            <div class="flex justify-between items-center mb-1">
              <div class="flex items-center">
                <span class="inline-block w-12 text-center py-1 px-1 rounded text-xs font-medium ${amountColors[amount]}">
                  ${amount}元
                </span>
              </div>
              <div class="text-gray-500 dark:text-gray-400">${amountVouchers.length}張</div>
            </div>
            
            <div class="ml-4 space-y-1 mt-1 mb-2">
              ${amountVouchers.map(voucher => `
                <div class="flex items-center space-x-2">
                  <input type="checkbox" id="voucher-${voucher.id}" class="voucher-checkbox"
                         data-id="${voucher.id}" data-amount="${voucher.amount}" 
                         ${appState.selectedVouchers.includes(voucher.id) ? 'checked' : ''}>
                  <label for="voucher-${voucher.id}" class="text-sm">
                    ${amount}元 優惠券
                  </label>
                </div>
              `).join('')}
            </div>
          `;
        });
        
        bankSection.appendChild(vouchersList);
        redeemedVoucherSelection.appendChild(bankSection);
      });
      
      // 添加全選銀行事件
      document.querySelectorAll('.select-all-bank-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const bankVouchers = redeemableVouchers
            .filter(v => v.bankId === bankId)
            .map(v => v.id);
          
          // 添加銀行所有優惠券到已選擇列表
          bankVouchers.forEach(id => {
            if (!appState.selectedVouchers.includes(id)) {
              appState.selectedVouchers.push(id);
            }
          });
          
          saveAppState();
          updateVoucherSelection();
          updateSelectedVouchers();
        });
      });
      
      // 添加複選框事件
      document.querySelectorAll('.voucher-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const voucherId = this.getAttribute('data-id');
          
          if (this.checked) {
            if (!appState.selectedVouchers.includes(voucherId)) {
              appState.selectedVouchers.push(voucherId);
            }
          } else {
            appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
          }
          
          saveAppState();
          updateSelectedVouchers();
        });
      });
      
      // 設置消費類別選擇事件
      document.querySelectorAll('.expense-category').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          // 不需要處理任何狀態變更，因為這些將在兑換時一次性收集
        });
      });
    }

    // 更新已選擇的優惠券列表
    function updateSelectedVouchers() {
      const redeemOperations = document.getElementById('redeem-operations');
      const selectionSummary = document.getElementById('selection-summary');
      
      // 獲取已選擇的未使用優惠券
      const selectedVouchers = appState.selectedVouchers
        .map(id => appState.vouchers.find(v => v.id === id))
        .filter(isVoucherRedeemable);
      
      // 更新選擇摘要
      document.getElementById('selected-vouchers-count').textContent = selectedVouchers.length;
      document.getElementById('selected-vouchers-value').textContent = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
      
      // 顯示狀態及隱藏兑換區域
      if (selectedVouchers.length === 0) {
        redeemOperations.classList.add('hidden');
        selectionSummary.style.visibility = 'hidden';
      } else {
        redeemOperations.classList.remove('hidden');
        selectionSummary.style.visibility = 'visible';
        
        // 計算總值
        const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
        
        // 設置最小兑換金額
        document.getElementById('min-redeem-amount').textContent = totalValue * 3;
      }
      
      // 添加兑換按鈕事件
      document.getElementById('redeem-selected-vouchers').onclick = function() {
        const spendAmount = parseInt(document.getElementById('manual-spend-amount').value);
        
        // 收集選中的消費類別
        const selectedCategories = Array.from(document.querySelectorAll('.expense-category:checked')).map(
          checkbox => checkbox.value
        );
        
        // 如果沒有選擇類別，預設為「其他」
        if (selectedCategories.length === 0) {
          selectedCategories.push('other');
        }
        
        const remark = document.getElementById('redeem-remark').value.trim();
        showRedeemConfirmation(spendAmount, selectedCategories, remark);
      };
    }

    // 顯示兑換確認
    function showRedeemConfirmation(userSpendAmount, categories, remark) {
      // 獲取選中的未使用優惠券
      const selectedVouchers = appState.selectedVouchers
        .map(id => appState.vouchers.find(v => v.id === id))
        .filter(isVoucherRedeemable);
      
      if (selectedVouchers.length === 0) {
        alert('請先選擇要兑換的優惠券！');
        return;
      }
      
      // 計算總值和所需消費金額
      const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
      const requiredAmount = totalValue * 3;
      
      // 檢查用戶輸入的消費金額是否足夠
      if (userSpendAmount && userSpendAmount < requiredAmount) {
        alert(`消費金額必須至少為${requiredAmount}元才能兑換所選優惠券！`);
        return;
      }
      
      // 使用用戶輸入的金額或最低需求金額
      const spendAmount = userSpendAmount || requiredAmount;
      
      // 按銀行統計
      const bankSummary = {};
      selectedVouchers.forEach(voucher => {
        if (!bankSummary[voucher.bankId]) {
          bankSummary[voucher.bankId] = { count: 0, value: 0 };
        }
        bankSummary[voucher.bankId].count++;
        bankSummary[voucher.bankId].value += voucher.amount;
      });
      
      // 生成確認信息
      let infoHTML = `
        <div class="mb-3">
          <div class="font-medium">優惠券數量: ${selectedVouchers.length}張</div>
          <div class="font-medium text-primary">消費金額: ${spendAmount}元</div>
          <div class="text-green-600 dark:text-green-400">節省金額: ${totalValue}元</div>
          <div class="text-gray-500 dark:text-gray-400">自費金額: ${spendAmount - totalValue}元</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">最低需消費金額: ${requiredAmount}元</div>
        </div>
      `;
      
      // 顯示消費類別
      if (categories && categories.length > 0) {
        infoHTML += `<div class="mb-3">
          <div class="font-medium">消費類別:</div>
          <div class="flex flex-wrap gap-1 mt-1">
            ${categories.map(cat => `
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700">
                <i class="${getCategoryIcon(cat)} mr-1"></i> ${getCategoryName(cat)}
              </span>
            `).join('')}
          </div>
        </div>`;
      }
      
      // 添加備註
      if (remark) {
        infoHTML += `<div class="mb-3">
          <div class="font-medium">消費備註:</div>
          <div class="text-sm mt-1 p-2 bg-gray-50 dark:bg-gray-700 rounded">${remark}</div>
        </div>`;
      }
      
      // 添加銀行統計
      infoHTML += `<div class="text-sm">按銀行統計:</div>`;
      
      // 按金額排序銀行
      const sortedBankSummary = banks
        .filter(bank => bankSummary[bank.id])
        .sort((a, b) => bankSummary[b.id].value - bankSummary[a.id].value);
      
      sortedBankSummary.forEach(bank => {
        if (bankSummary[bank.id]) {
          infoHTML += `
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                <span>${bank.name}:</span>
              </div>
              <div>${bankSummary[bank.id].count}張 (${bankSummary[bank.id].value}元)</div>
            </div>
          `;
        }
      });
      
      // 顯示確認模態框
      document.getElementById('redeem-vouchers-info').innerHTML = infoHTML;
      document.getElementById('confirm-redeem-modal').classList.remove('hidden');
      
      // 保存臨時選擇的優惠券、類別和備註
      tempSelectedVouchers = [...selectedVouchers];
      tempRedeemCategories = [...categories];
      tempRedeemRemark = remark;
      
      // 確認兑換
      document.getElementById('confirm-redeem').onclick = function() {
        redeemVouchers(spendAmount, categories, remark);
        document.getElementById('confirm-redeem-modal').classList.add('hidden');
      };
      
      // 取消兑換
      document.getElementById('cancel-redeem').onclick = function() {
        document.getElementById('confirm-redeem-modal').classList.add('hidden');
      };
    }

    // 兑換優惠券
    function redeemVouchers(spendAmount, categories, remark) {
      // 檢查參數和臨時選中的優惠券
      if (!tempSelectedVouchers || tempSelectedVouchers.length === 0) {
        console.error("沒有選中的優惠券可供兑換");
        alert("兑換失敗：沒有選中的優惠券");
        return;
      }
      
      if (!spendAmount || isNaN(spendAmount) || spendAmount <= 0) {
        console.error("消費金額無效:", spendAmount);
        alert("兑換失敗：請輸入有效的消費金額");
        return;
      }
      
      try {
        console.log("執行兑換操作，選中優惠券:", tempSelectedVouchers.length, "張");
        
        // 計算總值
        const totalValue = tempSelectedVouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
        
        // 檢查最低消費要求
        const requiredAmount = totalValue * 3;
        if (spendAmount < requiredAmount) {
          alert(`消費金額必須至少為${requiredAmount}元才能兑換所選優惠券！`);
          return;
        }
        
        // 記錄兑換歷史
        const redemption = {
          id: Date.now().toString(),
          displayId: appState.nextRedemptionId,
          date: new Date().toISOString(),
          vouchers: tempSelectedVouchers.map(v => ({
            id: v.id,
            amount: v.amount,
            bankId: v.bankId
          })),
          voucherCount: tempSelectedVouchers.length,
          voucherValue: totalValue,
          spendAmount: spendAmount,
          categories: categories || ['other'], // 默認為其他類別
          remark: tempRedeemRemark || remark,
          weekNum: appState.currentWeek
        };
        
        appState.redemptionHistory.push(redemption);
        appState.nextRedemptionId++; // 增加消費編號
        
        // 標記優惠券為已使用
        let markedCount = 0;
        tempSelectedVouchers.forEach(voucher => {
          const v = appState.vouchers.find(v => v.id === voucher.id);
          if (v) {
            v.used = true;
            markedCount++;
          }
        });
        
        console.log(`成功標記 ${markedCount}/${tempSelectedVouchers.length} 張優惠券為已使用`);
        
        // 清空選擇列表和輸入欄位
        appState.selectedVouchers = [];
        document.getElementById('manual-spend-amount').value = '';
        document.getElementById('redeem-remark').value = '';
        
        // 清空類別選擇
        document.querySelectorAll('.expense-category').forEach(checkbox => {
          checkbox.checked = false;
        });
        
        // 更新週次記錄消費金額
        updateWeekRecord(appState.currentWeek, spendAmount);
        
        // 保存並更新UI
        saveAppState();
        updateBankOverview();
        updateRedeemableVouchers();
        updateVoucherSelection();
        updateSelectedVouchers();
        updateTotalStats();
        updateWeekRecordsDisplay();
        updateRedemptionHistory();
        updateDetailedAnalysis();
        updateCharts();
        
        alert(`成功兑換${tempSelectedVouchers.length}張優惠券！消費金額: ${spendAmount}元`);
      } catch (error) {
        console.error("兑換過程中發生錯誤:", error);
        alert(`兑換失敗：${error.message || "未知錯誤"}`);
      } finally {
        // 確保無論成功或失敗都清空臨時變量
        tempSelectedVouchers = [];
        tempRedeemCategories = [];
        tempRedeemRemark = '';
      }
    }
    
    // 撤回兑換 (新增功能)
    function withdrawRedemption(redemptionId) {
      // 查找兑換記錄
      const redemptionIndex = appState.redemptionHistory.findIndex(r => r.id === redemptionId);
      
      if (redemptionIndex === -1) {
        alert('找不到指定的兑換記錄！');
        return false;
      }
      
      const redemption = appState.redemptionHistory[redemptionIndex];
      
      // 檢查優惠券是否存在
      let allVouchersExist = true;
      redemption.vouchers.forEach(voucherInfo => {
        const voucher = appState.vouchers.find(v => v.id === voucherInfo.id);
        if (!voucher) {
          allVouchersExist = false;
        }
      });
      
      if (!allVouchersExist) {
        alert('部分優惠券記錄已不存在，無法撤回兑換！');
        return false;
      }
      
      // 將優惠券狀態改為未使用
      redemption.vouchers.forEach(voucherInfo => {
        const voucher = appState.vouchers.find(v => v.id === voucherInfo.id);
        if (voucher) {
          voucher.used = false;
        }
      });
      
      // 從兑換歷史記錄中移除
      appState.redemptionHistory.splice(redemptionIndex, 1);
      
      // 更新週次記錄消費金額（減掉撤回的消費金額）
      updateWeekRecord(redemption.weekNum, -redemption.spendAmount);
      
      // 保存並更新UI
      saveAppState();
      updateBankOverview();
      updateRedeemableVouchers();
      updateVoucherSelection();
      updateSelectedVouchers();
      updateTotalStats();
      updateWeekRecordsDisplay();
      updateRedemptionHistory();
      updateDetailedAnalysis();
      updateCharts();
      
      return true;
    }
    
    // 顯示撤回兑換確認框
    function showWithdrawConfirmation(redemptionId) {
      const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);
      if (!redemption) return;
      
      // 按銀行統計
      const bankSummary = {};
      redemption.vouchers.forEach(voucher => {
        if (!bankSummary[voucher.bankId]) {
          bankSummary[voucher.bankId] = { count: 0, value: 0 };
        }
        bankSummary[voucher.bankId].count++;
        bankSummary[voucher.bankId].value += voucher.amount;
      });
      
      // 生成確認信息
      let infoHTML = `
        <div class="mb-3">
          <div class="font-medium">兑換記錄 #${formatRedemptionId(redemption.displayId)}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">${new Date(redemption.date).toLocaleString()}</div>
          <div class="mt-2 space-y-1">
            <div>優惠券數量: ${redemption.voucherCount}張</div>
            <div>優惠券總值: ${redemption.voucherValue}元</div>
            <div>消費金額: ${redemption.spendAmount}元</div>
          </div>
        </div>
      `;
      
      // 添加銀行統計
      infoHTML += `<div class="text-sm font-medium mt-2">優惠券明細:</div>`;
      
      // 按金額排序銀行
      const sortedBankSummary = banks
        .filter(bank => bankSummary[bank.id])
        .sort((a, b) => bankSummary[b.id].value - bankSummary[a.id].value);
      
      sortedBankSummary.forEach(bank => {
        if (bankSummary[bank.id]) {
          infoHTML += `
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                <span>${bank.name}:</span>
              </div>
              <div>${bankSummary[bank.id].count}張 (${bankSummary[bank.id].value}元)</div>
            </div>
          `;
        }
      });
      
      // 顯示確認模態框
      document.getElementById('withdraw-vouchers-info').innerHTML = infoHTML;
      document.getElementById('confirm-withdraw-modal').classList.remove('hidden');
      
      // 確認撤回
      document.getElementById('confirm-withdraw').onclick = function() {
        const success = withdrawRedemption(redemptionId);
        document.getElementById('confirm-withdraw-modal').classList.add('hidden');
        
        if (success) {
          // 關閉兑換記錄詳情模態框
          document.getElementById('redemption-detail-modal').classList.add('hidden');
          alert('已成功撤回兑換，優惠券已恢復為未使用狀態！');
        }
      };
      
      // 取消撤回
      document.getElementById('cancel-withdraw').onclick = function() {
        document.getElementById('confirm-withdraw-modal').classList.add('hidden');
      };
    }

    // 更新週次記錄
    function updateWeekRecords() {
      // 確保每週都有記錄
      for (let weekNum = 1; weekNum <= 10; weekNum++) {
        // 檢查是否已有該週次記錄
        let weekRecord = appState.weekRecords.find(r => r.weekNum === weekNum);
        
        if (!weekRecord) {
          weekRecord = createWeekRecord(weekNum);
          appState.weekRecords.push(weekRecord);
        } else {
          // 更新現有記錄的優惠券數據
          updateWeekRecordData(weekRecord);
        }
      }
      
      // 按週次排序
      appState.weekRecords.sort((a, b) => a.weekNum - b.weekNum);
      
      saveAppState();
    }

    // 創建週次記錄
    function createWeekRecord(weekNum) {
      const weekData = weekSchedule[weekNum - 1];
      if (!weekData) return null;
      
      const record = {
        id: Date.now().toString() + weekNum,
        weekNum: weekNum,
        startDate: weekData.startDate,
        endDate: weekData.endDate,
        createdAt: new Date().toISOString(),
        notes: '',
        voucherCount: 0,
        voucherValue: 0,
        valueCounts: [0, 0, 0, 0, 0, 0], // 0元, 10, 20, 50, 100, 200
        bankCounts: {},
        usedCount: 0,
        spendAmount: 0,
        // 增加可兑換統計
        redeemableCount: 0,
        redeemableValue: 0
      };
      
      updateWeekRecordData(record);
      return record;
    }

    // 更新週次記錄數據
    function updateWeekRecordData(record) {
      const weekNum = record.weekNum;
      
      // 重置計數
      record.voucherCount = 0;
      record.voucherValue = 0;
      record.valueCounts = [0, 0, 0, 0, 0, 0];
      record.usedCount = 0;
      record.redeemableCount = 0;
      record.redeemableValue = 0;
      
      // 初始化銀行計數
      const bankCounts = {};
      banks.forEach(bank => {
        bankCounts[bank.id] = { 
          count: 0, 
          value: 0,
          redeemable: { count: 0, value: 0 } // 添加可兑換統計
        };
      });
      
      // 獲取該週的優惠券
      const weekVouchers = appState.vouchers.filter(voucher => {
        return getWeekNumberFromDate(voucher.date) === weekNum;
      });
      
      // 更新計數
      weekVouchers.forEach(voucher => {
        record.voucherCount++;
        
        // 更新面值統計
        switch(voucher.amount) {
          case 0: record.valueCounts[0]++; break;
          case 10: record.valueCounts[1]++; record.voucherValue += 10; break;
          case 20: record.valueCounts[2]++; record.voucherValue += 20; break;
          case 50: record.valueCounts[3]++; record.voucherValue += 50; break;
          case 100: record.valueCounts[4]++; record.voucherValue += 100; break;
          case 200: record.valueCounts[5]++; record.voucherValue += 200; break;
        }
        
        // 更新已使用統計
        if (voucher.used) {
          record.usedCount++;
        }
        
        // 更新可兑換統計
        if (isVoucherRedeemable(voucher)) {
          record.redeemableCount++;
          record.redeemableValue += voucher.amount;
        }
        
        // 更新銀行統計
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId].count++;
          bankCounts[voucher.bankId].value += voucher.amount;
          
          // 更新可兑換統計
          if (isVoucherRedeemable(voucher)) {
            bankCounts[voucher.bankId].redeemable.count++;
            bankCounts[voucher.bankId].redeemable.value += voucher.amount;
          }
        }
      });
      
      // 更新銀行統計
      record.bankCounts = bankCounts;
    }

    // 更新週次記錄消費金額
    function updateWeekRecord(weekNum, amount) {
      if (weekNum < 1 || weekNum > 10) return;
      
      // 查找週次記錄
      const record = appState.weekRecords.find(r => r.weekNum === weekNum);
      if (record) {
        record.spendAmount = (record.spendAmount || 0) + amount;
      }
    }

    // 更新週次記錄顯示
    function updateWeekRecordsDisplay() {
      const weekRecordsList = document.getElementById('week-records-list');
      const weekHistorySelect = document.getElementById('week-history-select');
      
      // 更新週次選擇器
      weekHistorySelect.innerHTML = '<option value="">-- 選擇週次 --</option>';
      weekSchedule.forEach(week => {
        const option = document.createElement('option');
        option.value = week.week;
        option.textContent = `第${week.week}週 (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
        weekHistorySelect.appendChild(option);
      });
      
      // 按週次排序（升序）
      const sortedRecords = [...appState.weekRecords].sort((a, b) => a.weekNum - b.weekNum);
      
      if (sortedRecords.length === 0) {
        weekRecordsList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8">尚無週次記錄</div>';
        return;
      }
      
      weekRecordsList.innerHTML = '';
      
      sortedRecords.forEach(record => {
        // 過濾有數據的銀行
        let bankHTML = '';
        let bankCount = 0;
        
        // 计算可兑换优惠券總數
        const redeemableCount = record.redeemableCount || (record.valueCounts[1] + record.valueCounts[2] + 
                             record.valueCounts[3] + record.valueCounts[4] + record.valueCounts[5] - record.usedCount);
        const redeemableValue = record.redeemableValue || record.voucherValue - 
                              (10 * record.valueCounts[1] + 20 * record.valueCounts[2] + 
                               50 * record.valueCounts[3] + 100 * record.valueCounts[4] + 
                               200 * record.valueCounts[5]);
        
        banks.forEach(bank => {
          const bankData = record.bankCounts?.[bank.id];
          if (bankData && bankData.count > 0) {
            bankCount++;
            
            // 计算可兑换数量
            const redeemableStats = bankData.redeemable || { count: 0, value: 0 };
            
            bankHTML += `
              <div class="flex items-center mb-1 text-xs">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                <span>${bank.name}: ${bankData.count}張 (${bankData.value}元)</span>
                ${redeemableStats.count > 0 ? 
                  `<span class="ml-2 text-green-600 dark:text-green-400">可兑換: ${redeemableStats.count}張</span>` : ''}
              </div>
            `;
          }
        });
        
        // 創建記錄卡片
        const recordItem = document.createElement('div');
        recordItem.className = 'border rounded-lg bg-white dark:bg-gray-800 overflow-hidden';
        recordItem.innerHTML = `
          <div class="px-4 py-3">
            <div class="flex justify-between items-start mb-2">
              <div class="font-bold text-lg">第${record.weekNum}週記錄</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">總優惠券</div>
                <div class="font-bold text-lg">${record.voucherCount}張</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">總價值</div>
                <div class="font-bold text-lg">${record.voucherValue}元</div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">可兑換</div>
                <div class="font-bold text-lg text-green-600 dark:text-green-400">${redeemableCount}張</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">已兑換</div>
                <div class="font-bold text-lg">${record.usedCount}張</div>
              </div>
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">優惠券分佈：</div>
            <div class="text-sm mb-2">
              ${record.valueCounts[0] > 0 ? `<span class="mr-2">😄: ${record.valueCounts[0]}張</span>` : ''}
              ${record.valueCounts[1] > 0 ? `<span class="mr-2">10元: ${record.valueCounts[1]}張</span>` : ''}
              ${record.valueCounts[2] > 0 ? `<span class="mr-2">20元: ${record.valueCounts[2]}張</span>` : ''}
              ${record.valueCounts[3] > 0 ? `<span class="mr-2">50元: ${record.valueCounts[3]}張</span>` : ''}
              ${record.valueCounts[4] > 0 ? `<span class="mr-2">100元: ${record.valueCounts[4]}張</span>` : ''}
              ${record.valueCounts[5] > 0 ? `<span class="mr-2">200元: ${record.valueCounts[5]}張</span>` : ''}
            </div>
            ${bankCount > 0 ? `
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">銀行分佈：</div>
              <div class="mb-2">${bankHTML}</div>
            ` : ''}
            ${record.notes ? `
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">備註：</div>
              <div class="text-sm mb-2">${record.notes}</div>
            ` : ''}
          </div>
          <div class="border-t px-3 py-2 flex justify-end">
            <button class="text-sm text-primary dark:text-primary hover:underline view-week-detail-btn" data-id="${record.id}">查看詳情</button>
          </div>
        `;
        
        weekRecordsList.appendChild(recordItem);
      });
      
      // 添加查看詳情事件
      document.querySelectorAll('.view-week-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          showWeekDetail(this.getAttribute('data-id'));
        });
      });
      
      // 添加週次選擇事件
      weekHistorySelect.onchange = function() {
        if (this.value) {
          const weekNum = parseInt(this.value);
          const weekRecord = appState.weekRecords.find(r => r.weekNum === weekNum);
          if (weekRecord) {
            showWeekDetail(weekRecord.id);
          }
        }
      };
    }

    // 顯示週次詳情
    function showWeekDetail(recordId) {
      const record = appState.weekRecords.find(r => r.id === recordId);
      if (!record) return;
      
      const weekDetailModal = document.getElementById('week-detail-modal');
      const weekDetailTitle = document.getElementById('week-detail-title');
      const weekDetailContent = document.getElementById('week-detail-content');
      
      // 計算已使用率
      const usedPercentage = record.voucherCount > 0 ? Math.round((record.usedCount / record.voucherCount) * 100) : 0;
      
      // 计算可兑换优惠券總數 (排除笑臉)
      const redeemableCount = record.redeemableCount || 
                              (record.voucherCount - record.usedCount - record.valueCounts[0]);
      
      // 更新標題和內容
      weekDetailTitle.textContent = `第${record.weekNum}週詳細記錄`;
      weekDetailContent.innerHTML = `
        <div class="space-y-4">
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">記錄時間</div>
            <div>${new Date(record.createdAt).toLocaleString()}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">週期範圍</div>
            <div>${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">優惠券使用情況</div>
            <div class="flex justify-between mb-1">
              <div>總數: ${record.voucherCount}張</div>
              <div>總值: ${record.voucherValue}元</div>
            </div>
            <div class="flex justify-between mb-1">
              <div>已兑換: ${record.usedCount}張</div>
              <div>可兑換: ${redeemableCount}張</div>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
              <div class="bg-primary h-2.5 rounded-full" style="width: ${usedPercentage}%"></div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">消費金額</div>
            <div class="font-bold text-lg">${record.spendAmount || 0}元</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">優惠券面值分佈</div>
            <div class="grid grid-cols-6 gap-2 mb-2">
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[0] || 0}</div>
                <div class="text-xs">😄</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[1] || 0}</div>
                <div class="text-xs">10元</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[2] || 0}</div>
                <div class="text-xs">20元</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[3] || 0}</div>
                <div class="text-xs">50元</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[4] || 0}</div>
                <div class="text-xs">100元</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[5] || 0}</div>
                <div class="text-xs">200元</div>
              </div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">各銀行優惠券</div>
            <div class="space-y-1">
              ${banks.map(bank => {
                const bankData = record.bankCounts?.[bank.id];
                if (!bankData || bankData.count === 0) return '';
                
                // 计算可兑换的优惠券
                const redeemableStats = bankData.redeemable || { count: 0, value: 0 };
                
                return `
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                      <span>${bank.name}</span>
                    </div>
                    <div>${bankData.count}張 (${bankData.value}元)
                      ${redeemableStats.count > 0 ? 
                        `<span class="ml-1 text-green-600 dark:text-green-400">可兑換: ${redeemableStats.count}張</span>` : ''}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">各銀行本週優惠券</div>
            <div class="space-y-1 border rounded-lg p-2">
              ${banks.map(bank => {
                const count = getBankVoucherCount(bank.id, record.weekNum);
                return `
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                      <span>${bank.name}</span>
                    </div>
                    <div>${count}/3張</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          
          ${record.notes ? `
            <div>
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">備註</div>
              <div class="border rounded-lg p-2">${record.notes}</div>
            </div>
          ` : ''}
        </div>
      `;
      
      // 顯示模態框
      weekDetailModal.classList.remove('hidden');
      
      // 添加關閉按鈕事件
      document.getElementById('close-detail-btn').onclick = function() {
        weekDetailModal.classList.add('hidden');
      };
      
      document.getElementById('close-week-detail').onclick = function() {
        weekDetailModal.classList.add('hidden');
      };
    }

    // 更新兑換記錄列表
    function updateRedemptionHistory() {
      const redemptionHistoryList = document.getElementById('redemption-history-list');
      const redeemedTotalCount = document.getElementById('redeemed-total-count');
      
      // 計算總已兑換優惠券數量
      const totalRedeemed = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherCount, 0);
      redeemedTotalCount.textContent = totalRedeemed;
      
      // 如果沒有兑換記錄
      if (appState.redemptionHistory.length === 0) {
        redemptionHistoryList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">尚無兑換記錄</div>';
        return;
      }
      
      // 按日期降序排序
      const sortedHistory = [...appState.redemptionHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // 清空列表
      redemptionHistoryList.innerHTML = '';
      
      // 添加每條兑換記錄
      sortedHistory.forEach(redemption => {
        const redemptionDate = new Date(redemption.date);
        const weekData = weekSchedule[redemption.weekNum - 1] || {};
        
        // 按銀行分組優惠券
        const vouchersByBank = {};
        redemption.vouchers.forEach(voucher => {
          if (!vouchersByBank[voucher.bankId]) {
            vouchersByBank[voucher.bankId] = [];
          }
          vouchersByBank[voucher.bankId].push(voucher);
        });
        
        // 生成銀行優惠券信息HTML
        let bankVouchersHTML = '';
        banks.forEach(bank => {
          const bankVouchers = vouchersByBank[bank.id] || [];
          if (bankVouchers.length > 0) {
            // 計算該銀行的總值
            const bankTotal = bankVouchers.reduce((sum, v) => sum + v.amount, 0);
            
            bankVouchersHTML += `
              <div class="flex items-center justify-between mb-1 text-xs">
                <div class="flex items-center">
                  <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                  <span>${bank.name}</span>
                </div>
                <div>${bankVouchers.length}張 (${bankTotal}元)</div>
              </div>
            `;
          }
        });
        
        // 顯示消費類別
        let categoriesHTML = '';
        if (redemption.categories && redemption.categories.length > 0) {
          categoriesHTML = `
            <div class="mb-1 flex flex-wrap gap-1">
              ${redemption.categories.map(category => `
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" 
                      style="background-color: ${getCategoryColor(category)}20; color: ${getCategoryColor(category)}">
                  <i class="${getCategoryIcon(category)} mr-1"></i> ${getCategoryName(category)}
                </span>
              `).join('')}
            </div>
          `;
        }
        
        // 創建記錄卡片
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-3';
        
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="font-bold">兑換記錄 #${formatRedemptionId(redemption.displayId)}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">${redemptionDate.toLocaleDateString()} ${redemptionDate.toLocaleTimeString()}</div>
          </div>
          
          <div class="grid grid-cols-2 gap-2 mb-2">
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">優惠券數量</div>
              <div class="font-bold">${redemption.voucherCount}張</div>
            </div>
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">節省金額</div>
              <div class="font-bold text-green-600 dark:text-green-400">${redemption.voucherValue}元</div>
            </div>
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">消費金額</div>
              <div class="font-bold">${redemption.spendAmount}元</div>
            </div>
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">週次</div>
              <div class="font-bold">第${redemption.weekNum}週</div>
            </div>
          </div>
          
          ${categoriesHTML}
          
          ${redemption.remark ? `
            <div class="mb-2">
              <div class="text-xs text-gray-500 dark:text-gray-400">消費備註</div>
              <div class="text-sm border-t dark:border-gray-700 pt-1">${redemption.remark}</div>
            </div>
          ` : ''}
          
          ${bankVouchersHTML ? `
            <div class="mb-2">
              <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">銀行優惠券</div>
              <div class="border-t dark:border-gray-700 pt-1">
                ${bankVouchersHTML}
              </div>
            </div>
          ` : ''}
          
          <div class="flex justify-end border-t dark:border-gray-700 pt-2">
            <button class="text-xs text-primary dark:text-primary view-redemption-detail-btn" data-id="${redemption.id}">查看詳情</button>
          </div>
        `;
        
        redemptionHistoryList.appendChild(card);
      });
      
      // 添加查看詳情事件
      document.querySelectorAll('.view-redemption-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          showRedemptionDetail(this.getAttribute('data-id'));
        });
      });
    }

    // 顯示兑換詳情
    function showRedemptionDetail(redemptionId) {
      const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);
      if (!redemption) return;
      
      // 保存當前兑換記錄ID以便撤回
      currentRedemptionId = redemption.id;
      
      const modal = document.getElementById('redemption-detail-modal');
      const title = document.getElementById('redemption-detail-title');
      const content = document.getElementById('redemption-detail-content');
      
      // 按面值分組
      const vouchersByAmount = {10: [], 20: [], 50: [], 100: [], 200: []};
      redemption.vouchers.forEach(voucher => {
        if (vouchersByAmount[voucher.amount]) {
          vouchersByAmount[voucher.amount].push(voucher);
        }
      });
      
      // 按銀行分組
      const vouchersByBank = {};
      redemption.vouchers.forEach(voucher => {
        if (!vouchersByBank[voucher.bankId]) {
          vouchersByBank[voucher.bankId] = [];
        }
        vouchersByBank[voucher.bankId].push(voucher);
      });
      
      // 生成內容
      title.textContent = `兑換詳情 #${formatRedemptionId(redemption.displayId)}`;
      
      content.innerHTML = `
        <div class="space-y-4">
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">兑換時間</div>
            <div>${new Date(redemption.date).toLocaleString()}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">週次</div>
            <div>第${redemption.weekNum}週</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">兑換摘要</div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="text-xs text-gray-500 dark:text-gray-400">優惠券數量</div>
                <div class="font-bold">${redemption.voucherCount}張</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 dark:text-gray-400">消費金額</div>
                <div class="font-bold text-primary">${redemption.spendAmount}元</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 dark:text-gray-400">節省金額</div>
                <div class="font-bold text-green-600 dark:text-green-400">${redemption.voucherValue}元</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 dark:text-gray-400">自費金額</div>
                <div class="text-sm">${redemption.spendAmount - redemption.voucherValue}元</div>
              </div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">消費類別</div>
            <div class="flex flex-wrap gap-1 mb-1">
              ${(redemption.categories || ['other']).map(category => `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" 
                      style="background-color: ${getCategoryColor(category)}20; color: ${getCategoryColor(category)}">
                  <i class="${getCategoryIcon(category)} mr-1"></i> ${getCategoryName(category)}
                </span>
              `).join('')}
            </div>
          </div>
          
          ${redemption.remark ? `
            <div>
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">消費備註</div>
              <div class="border rounded-lg p-2 text-sm">${redemption.remark}</div>
            </div>
          ` : ''}
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">優惠券分佈</div>
            <div class="grid grid-cols-5 gap-2 text-center">
              <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded ${vouchersByAmount[10].length > 0 ? '' : 'opacity-30'}">
                <div class="font-bold">${vouchersByAmount[10].length}</div>
                <div class="text-xs">10元</div>
              </div>
              <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded ${vouchersByAmount[20].length > 0 ? '' : 'opacity-30'}">
                <div class="font-bold">${vouchersByAmount[20].length}</div>
                <div class="text-xs">20元</div>
              </div>
              <div class="p-2 bg-green-100 dark:bg-green-900 rounded ${vouchersByAmount[50].length > 0 ? '' : 'opacity-30'}">
                <div class="font-bold">${vouchersByAmount[50].length}</div>
                <div class="text-xs">50元</div>
              </div>
              <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded ${vouchersByAmount[100].length > 0 ? '' : 'opacity-30'}">
                <div class="font-bold">${vouchersByAmount[100].length}</div>
                <div class="text-xs">100元</div>
              </div>
              <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded ${vouchersByAmount[200].length > 0 ? '' : 'opacity-30'}">
                <div class="font-bold">${vouchersByAmount[200].length}</div>
                <div class="text-xs">200元</div>
              </div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">按銀行分佈</div>
            <div class="space-y-2">
              ${banks.map(bank => {
                const bankVouchers = vouchersByBank[bank.id] || [];
                if (bankVouchers.length === 0) return '';
                
                // 按面值分組
                const bankAmounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0};
                let bankTotal = 0;
                
                bankVouchers.forEach(voucher => {
                  bankAmounts[voucher.amount]++;
                  bankTotal += voucher.amount;
                });
                
                return `
                  <div class="border rounded-lg p-2">
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center">
                        <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                        <span class="font-medium">${bank.name}</span>
                      </div>
                      <div class="text-sm">${bankVouchers.length}張 (${bankTotal}元)</div>
                    </div>
                    <div class="text-xs space-y-1">
                      ${bankAmounts[10] > 0 ? `<div>10元: ${bankAmounts[10]}張</div>` : ''}
                      ${bankAmounts[20] > 0 ? `<div>20元: ${bankAmounts[20]}張</div>` : ''}
                      ${bankAmounts[50] > 0 ? `<div>50元: ${bankAmounts[50]}張</div>` : ''}
                      ${bankAmounts[100] > 0 ? `<div>100元: ${bankAmounts[100]}張</div>` : ''}
                      ${bankAmounts[200] > 0 ? `<div>200元: ${bankAmounts[200]}張</div>` : ''}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
      
      // 顯示模態框
      modal.classList.remove('hidden');
      
      // 添加撤回兑換按鈕事件
      document.getElementById('withdraw-redemption-btn').onclick = function() {
        showWithdrawConfirmation(currentRedemptionId);
      };
      
      // 添加關閉按鈕事件
      document.getElementById('close-redemption-detail-btn').onclick = function() {
        modal.classList.add('hidden');
        currentRedemptionId = null; // 清除當前兑換記錄ID
      };
      
      document.getElementById('close-redemption-detail').onclick = function() {
        modal.classList.add('hidden');
        currentRedemptionId = null; // 清除當前兑換記錄ID
      };
    }

    // 更新總體統計
    function updateTotalStats() {
      // 計算總優惠券數量和價值
      const totalCount = appState.vouchers.length;
      const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
      
      // 計算可兑換優惠券數量和價值
      const redeemableCount = getRedeemableVoucherCount();
      const redeemableValue = getRedeemableVoucherValue();
      
      // 計算使用率 (基於可兑換的優惠券計算使用率，不包括笑臉)
      const usedCount = appState.vouchers.filter(v => v.used).length;
      
      // 計算可兑換總數 (包括已使用的)
      const totalRedeemable = appState.vouchers.filter(v => v.amount > 0).length;
      
      const usageRate = totalRedeemable > 0 ? Math.round((usedCount / totalRedeemable) * 100) : 0;
      
      // 計算過期率 (僅計算可兑換优惠券的过期率)
      const expiredCount = appState.vouchers
        .filter(v => !v.used && isVoucherExpired(v) && v.amount > 0)
        .length;
      
      const expiryRate = totalRedeemable > 0 ? Math.round((expiredCount / totalRedeemable) * 100) : 0;
      
      // 更新UI
      document.getElementById('total-vouchers').textContent = `${totalCount}張`;
      document.getElementById('total-value').textContent = `${totalValue}元`;
      document.getElementById('usage-rate').textContent = `${usageRate}%`;
      document.getElementById('expiry-rate').textContent = `${expiryRate}%`;
    }
    
    // 更新詳細分析報告
    function updateDetailedAnalysis() {
      // 面值分佈分析
      const valueDistributionRows = document.getElementById('value-distribution-rows');
      const valueDistributionSummary = document.getElementById('value-distribution-summary');
      
      // 計算面值分佈
      const valueCounts = {0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0, total: 0};
      appState.vouchers.forEach(voucher => {
        valueCounts[voucher.amount]++;
        valueCounts.total++;
      });
      
      if (valueCounts.total === 0) {
        valueDistributionRows.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚無優惠券數據</div>';
        valueDistributionSummary.innerHTML = '';
      } else {
        let valueHTML = '';
        let highestValueCount = 0;
        let highestValue = 0;
        
        // 計算最常見面值 (不包括笑臉)
        [0, 10, 20, 50, 100, 200].forEach(amount => {
          const count = valueCounts[amount];
          const percentage = Math.round((count / valueCounts.total) * 100) || 0;
          
          if (count > highestValueCount && amount > 0) {
            highestValueCount = count;
            highestValue = amount;
          }
          
          valueHTML += `
            <div class="flex justify-between items-center py-1 border-b dark:border-gray-700 last:border-0">
              <span>${amount === 0 ? '😄' : amount + '元'}</span>
              <span>${count}張</span>
              <span>${percentage}%</span>
            </div>
          `;
        });
        
        valueDistributionRows.innerHTML = valueHTML;
        
        // 生成摘要
        const smileyPercentage = Math.round((valueCounts[0] / valueCounts.total) * 100) || 0;
        
        // 計算可兑換比例 (不包括笑臉)
        const redeemablePercentage = Math.round(((valueCounts.total - valueCounts[0]) / valueCounts.total) * 100) || 0;
        
        valueDistributionSummary.innerHTML = `
          <div>最常見面值: <span class="font-medium">${highestValue}元</span> (${highestValueCount}張)</div>
          <div>笑臉佔比: <span class="font-medium">${smileyPercentage}%</span></div>
          <div>可兑換佔比: <span class="font-medium">${redeemablePercentage}%</span></div>
        `;
      }
      
      // 銀行優惠券分析
      const bankDistributionRows = document.getElementById('bank-distribution-rows');
      const bankDistributionSummary = document.getElementById('bank-distribution-summary');
      
      // 計算銀行分佈
      const bankCounts = {};
      const bankRedeemableCounts = {}; // 可兑換數量
      let totalBankVouchers = 0;
      let totalRedeemableVouchers = 0;
      
      banks.forEach(bank => {
        bankCounts[bank.id] = { count: 0, value: 0 };
        bankRedeemableCounts[bank.id] = { count: 0, value: 0 };
      });
      
      appState.vouchers.forEach(voucher => {
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId].count++;
          bankCounts[voucher.bankId].value += voucher.amount;
          totalBankVouchers++;
          
          // 計算可兑換優惠券 (不包括笑臉)
          if (isVoucherRedeemable(voucher)) {
            bankRedeemableCounts[voucher.bankId].count++;
            bankRedeemableCounts[voucher.bankId].value += voucher.amount;
            totalRedeemableVouchers++;
          }
        }
      });
      
      if (totalBankVouchers === 0) {
        bankDistributionRows.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚無銀行優惠券數據</div>';
        bankDistributionSummary.innerHTML = '';
      } else {
        // 按優惠券金額排序銀行
        const sortedBanks = [...banks]
          .filter(bank => bankCounts[bank.id].count > 0)
          .sort((a, b) => bankCounts[b.id].value - bankCounts[a.id].value);
        
        let bankHTML = '';
        sortedBanks.forEach(bank => {
          const data = bankCounts[bank.id];
          const redeemableData = bankRedeemableCounts[bank.id];
          
          bankHTML += `
            <div class="flex justify-between items-center py-1 border-b dark:border-gray-700 last:border-0">
              <div class="flex items-center">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                <span>${bank.name}</span>
              </div>
              <span>${data.count}張</span>
              <span>${data.value}元${redeemableData.count > 0 ? 
                ` <span class="text-xs text-green-600 dark:text-green-400">(可兑換: ${redeemableData.count}張)</span>` : ''}</span>
            </div>
          `;
        });
        
        bankDistributionRows.innerHTML = bankHTML;
        
        // 生成摘要
        if (sortedBanks.length > 0) {
          const topBank = sortedBanks[0];
          const topBankPercentage = Math.round((bankCounts[topBank.id].count / totalBankVouchers) * 100);
          
          bankDistributionSummary.innerHTML = `
            <div>最常用銀行: <span class="font-medium">${topBank.name}</span> (${topBankPercentage}%)</div>
            <div>銀行總數: <span class="font-medium">${sortedBanks.length}</span>/${banks.length}</div>
            <div>可兑換數量: <span class="font-medium">${totalRedeemableVouchers}</span>/${totalBankVouchers}張</div>
          `;
        } else {
          bankDistributionSummary.innerHTML = '';
        }
      }
      
      // 使用狀態分析
      const statusDistributionRows = document.getElementById('status-distribution-rows');
      const statusDistributionSummary = document.getElementById('status-distribution-summary');
      
      // 計算狀態分佈 (排除笑臉)
      const statusCounts = {unused: 0, used: 0, expired: 0, total: 0, redeemable: 0};
      
      appState.vouchers.forEach(voucher => {
        // 排除笑臉優惠券
        if (voucher.amount > 0) {
          if (voucher.used) {
            statusCounts.used++;
          } else if (isVoucherExpired(voucher)) {
            statusCounts.expired++;
          } else {
            statusCounts.unused++;
            statusCounts.redeemable++; // 可兑換數量
          }
          statusCounts.total++;
        }
      });
      
      if (statusCounts.total === 0) {
        statusDistributionRows.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚無可兑換優惠券數據</div>';
        statusDistributionSummary.innerHTML = '';
      } else {
        const statusHTML = `
          <div class="flex justify-between items-center py-1 border-b dark:border-gray-700">
            <span class="text-green-600 dark:text-green-400">未使用</span>
            <span>${statusCounts.unused}張</span>
            <span>${Math.round((statusCounts.unused / statusCounts.total) * 100)}%</span>
          </div>
          <div class="flex justify-between items-center py-1 border-b dark:border-gray-700">
            <span class="text-blue-600 dark:text-blue-400">已兑換</span>
            <span>${statusCounts.used}張</span>
            <span>${Math.round((statusCounts.used / statusCounts.total) * 100)}%</span>
          </div>
          <div class="flex justify-between items-center py-1">
            <span class="text-red-600 dark:text-red-400">已過期</span>
            <span>${statusCounts.expired}張</span>
            <span>${Math.round((statusCounts.expired / statusCounts.total) * 100)}%</span>
          </div>
        `;
        
        statusDistributionRows.innerHTML = statusHTML;
        
        // 計算可節省總金額
        const potentialSavings = appState.vouchers
          .filter(isVoucherRedeemable)
          .reduce((sum, v) => sum + v.amount, 0);
        
        // 計算已節省總金額
        const savedAmount = appState.vouchers
          .filter(v => v.used)
          .reduce((sum, v) => sum + v.amount, 0);
        
        statusDistributionSummary.innerHTML = `
          <div>已節省金額: <span class="font-medium text-green-600 dark:text-green-400">${savedAmount}元</span></div>
          <div>潛在節省金額: <span class="font-medium">${potentialSavings}元</span></div>
        `;
      }
      
      // 兑換效率分析
      const redemptionEfficiencyContent = document.getElementById('redemption-efficiency-content');
      
      if (appState.redemptionHistory.length === 0) {
        redemptionEfficiencyContent.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚無兑換記錄</div>';
      } else {
        // 計算平均每次兑換的優惠券數量
        const avgVouchersPerRedemption = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherCount, 0) / appState.redemptionHistory.length;
        
        // 計算平均節省金額
        const avgSavings = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherValue, 0) / appState.redemptionHistory.length;
        
        // 計算平均消費金額
        const avgSpending = appState.redemptionHistory.reduce((sum, r) => sum + r.spendAmount, 0) / appState.redemptionHistory.length;
        
        // 計算總節省率
        const totalSpending = appState.redemptionHistory.reduce((sum, r) => sum + r.spendAmount, 0);
        const totalSavings = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherValue, 0);
        const savingsRate = totalSpending > 0 ? Math.round((totalSavings / totalSpending) * 100) : 0;
        
        redemptionEfficiencyContent.innerHTML = `
          <div class="grid grid-cols-2 gap-x-4 gap-y-2">
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">兑換總次數</div>
              <div class="font-medium">${appState.redemptionHistory.length}次</div>
            </div>
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">平均每次優惠券</div>
              <div class="font-medium">${avgVouchersPerRedemption.toFixed(1)}張</div>
            </div>
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">平均節省金額</div>
              <div class="font-medium text-green-600 dark:text-green-400">${avgSavings.toFixed(1)}元</div>
            </div>
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">平均消費金額</div>
              <div class="font-medium">${avgSpending.toFixed(1)}元</div>
            </div>
          </div>
          <div class="mt-2 pt-2 border-t dark:border-gray-700">
            <div class="flex justify-between items-center">
              <div>總節省率:</div>
              <div class="font-medium text-green-600 dark:text-green-400">${savingsRate}%</div>
            </div>
            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-1">
              <div class="h-2 bg-green-500 rounded-full" style="width: ${savingsRate}%"></div>
            </div>
          </div>
        `;
      }
    }

    // 初始化圖表
    function initCharts() {
      Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
      Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';
      
      // 狀態分佈圖表
      const statusCtx = document.getElementById('status-chart').getContext('2d');
      statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
          labels: ['未使用', '已兑換', '已過期'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: [
              '#86efac', // 未使用
              '#93c5fd', // 已兑換
              '#f87171'  // 已過期
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 12,
                font: { size: 12 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${value} 張 (${percentage}%)`;
                }
              }
            }
          }
        },
        plugins: [{
          beforeDraw: function(chart) {
            const datasets = chart.data.datasets;
            if (datasets.length > 0) {
              const sum = datasets[0].data.reduce((a, b) => a + b, 0);
              if (sum === 0) {
                // 如果沒有數據，顯示無數據文本
                const ctx = chart.ctx;
                const width = chart.width;
                const height = chart.height;
                
                chart.clear();
                
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px sans-serif';
                ctx.fillStyle = chart.options.color;
                ctx.fillText('沒有數據', width / 2, height / 2);
                ctx.restore();
                
                return false; // 取消原本的繪製
              }
            }
          },
          afterDraw: function(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach((dataset, i) => {
              const meta = chart.getDatasetMeta(i);
              meta.data.forEach((element, index) => {
                // 獲取數據
                const data = dataset.data[index];
                if (data === 0) return;
                
                // 計算百分比
                const total = dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((data / total) * 100);
                
                // 獲取位置信息
                const position = element.tooltipPosition();
                const x = position.x;
                const y = position.y;
                
                // 繪製文本
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${data}張`, x, y - 8);
                ctx.fillText(`(${percentage}%)`, x, y + 8);
              });
            });
          }
        }]
      });
      
      // 初始化組合圖表（面值和銀行分佈共用）
      const combinedCtx = document.getElementById('combined-chart').getContext('2d');
      combinedChart = new Chart(combinedCtx, {
        type: 'bar',
        data: {
          labels: ['10元', '20元', '50元', '100元', '200元', '😄'],
          datasets: [{
            label: '數量',
            data: [0, 0, 0, 0, 0, 0],
            backgroundColor: document.documentElement.classList.contains('dark') ? 
              ['#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc', '#facc15'] : 
              ['#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff', '#fef08a']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (currentChartMode === 'value') {
                    return `${context.parsed.y} 張`;
                  } else {
                    return `${context.parsed.y} 元`;
                  }
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        },
        plugins: [{
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
              const meta = chart.getDatasetMeta(datasetIndex);
              if (!meta.hidden) {
                meta.data.forEach((element, index) => {
                  // 獲取數據
                  const data = dataset.data[index];
                  if (data === 0) return;
                  
                  // 計算位置 - 確保標籤在柱形上方而不是被遮擋
                  const position = element.tooltipPosition();
                  const x = position.x;
                  
                  // 確保標籤顯示在柱形的上方，而不是在柱形內部
                  const y = element.y - 10;
                  
                  // 繪製文本
                  ctx.fillStyle = '#000';
                  if (document.documentElement.classList.contains('dark')) {
                    ctx.fillStyle = '#fff';
                  }
                  ctx.font = 'bold 12px Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  if (currentChartMode === 'value') {
                    ctx.fillText(data + '張', x, y);
                  } else {
                    ctx.fillText(data + '元', x, y);
                  }
                });
              }
            });
          }
        }]
      });
      
      // 消費類別分佈圖表
      const categoryCtx = document.getElementById('category-chart').getContext('2d');
      categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: expenseCategories.map(cat => cat.name),
          datasets: [{
            data: Array(expenseCategories.length).fill(0),
            backgroundColor: expenseCategories.map(cat => cat.color)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 12,
                font: {
                  size: 10
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${value} 次 (${percentage}%)`;
                }
              }
            }
          }
        },
        plugins: [{
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach((dataset, i) => {
              const meta = chart.getDatasetMeta(i);
              meta.data.forEach((element, index) => {
                // 獲取數據
                const data = dataset.data[index];
                if (data === 0) return;
                
                // 計算百分比
                const total = dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((data / total) * 100);
                
                // 獲取位置信息
                const position = element.tooltipPosition();
                const x = position.x;
                const y = position.y;
                
                // 繪製文本
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                if (currentCategoryMode === 'count') {
                  ctx.fillText(`${data}次`, x, y - 5);
                } else {
                  ctx.fillText(`${data}元`, x, y - 5);
                }
                
                ctx.fillText(`(${percentage}%)`, x, y + 10);
              });
            });
          }
        }]
      });
      
      // 週次趨勢圖表 (顯示金額)
      const weeklyTrendCtx = document.getElementById('weekly-trend-chart').getContext('2d');
      weeklyTrendChart = new Chart(weeklyTrendCtx, {
        type: 'line',
        data: {
          labels: weekSchedule.map(w => `第${w.week}週`),
          datasets: [
            {
              label: '優惠券金額',
              data: Array(weekSchedule.length).fill(0),
              borderColor: '#5D5CDE',
              backgroundColor: 'rgba(93, 92, 222, 0.1)',
              tension: 0.3,
              fill: true
            },
            {
              label: '兑換金額',
              data: Array(weekSchedule.length).fill(0),
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                display: false
              },
              ticks: {
                callback: function(value) {
                  return value + '元';
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw} 元`;
                }
              }
            }
          }
        },
        plugins: [{
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
              const meta = chart.getDatasetMeta(datasetIndex);
              if (!meta.hidden) {
                meta.data.forEach((element, index) => {
                  // 獲取數據
                  const data = dataset.data[index];
                  if (data === 0) return;
                  
                  // 計算位置
                  const position = element.tooltipPosition();
                  const x = position.x;
                  const y = position.y - 15; // 調整文本位置
                  
                  // 繪製文本
                  ctx.fillStyle = dataset.borderColor;
                  ctx.font = 'bold 12px Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  ctx.fillText(data + '元', x, y);
                });
              }
            });
          }
        }]
      });
      
      // 切換面值與銀行圖表
      document.getElementById('show-value-chart').addEventListener('click', function() {
        if (currentChartMode === 'value') return;
        currentChartMode = 'value';
        this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        this.classList.add('bg-primary', 'text-white');
        document.getElementById('show-bank-chart').classList.remove('bg-primary', 'text-white');
        document.getElementById('show-bank-chart').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        updateCombinedChart();
      });
      
      document.getElementById('show-bank-chart').addEventListener('click', function() {
        if (currentChartMode === 'bank') return;
        currentChartMode = 'bank';
        this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        this.classList.add('bg-primary', 'text-white');
        document.getElementById('show-value-chart').classList.remove('bg-primary', 'text-white');
        document.getElementById('show-value-chart').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        updateCombinedChart();
      });
      
      // 切換消費類別圖表（按次數/按金額）
      document.getElementById('show-category-count').addEventListener('click', function() {
        if (this.classList.contains('bg-primary')) return;
        this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        this.classList.add('bg-primary', 'text-white');
        document.getElementById('show-category-amount').classList.remove('bg-primary', 'text-white');
        document.getElementById('show-category-amount').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        updateCategoryChart('count');
      });
      
      document.getElementById('show-category-amount').addEventListener('click', function() {
        if (this.classList.contains('bg-primary')) return;
        this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        this.classList.add('bg-primary', 'text-white');
        document.getElementById('show-category-count').classList.remove('bg-primary', 'text-white');
        document.getElementById('show-category-count').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        updateCategoryChart('amount');
      });
      
      updateCharts();
    }

    // 更新類別圖表
    function updateCategoryChart(mode = 'count') {
      if (!categoryChart) return;
      currentCategoryMode = mode;
      
      // 按次數或金額計算消費類別分佈
      const categoryCounts = Array(expenseCategories.length).fill(0);
      const categoryAmounts = Array(expenseCategories.length).fill(0);
      
      // 收集所有兑換記錄的類別數據
      appState.redemptionHistory.forEach(redemption => {
        if (redemption.categories && redemption.categories.length > 0) {
          redemption.categories.forEach(category => {
            const index = expenseCategories.findIndex(cat => cat.id === category);
            if (index !== -1) {
              categoryCounts[index]++;
              // 消費金額平均分配給所有選中的類別
              categoryAmounts[index] += redemption.spendAmount / redemption.categories.length;
            }
          });
        } else {
          // 如果沒有類別，算作「其他」
          const otherIndex = expenseCategories.findIndex(cat => cat.id === 'other');
          if (otherIndex !== -1) {
            categoryCounts[otherIndex]++;
            categoryAmounts[otherIndex] += redemption.spendAmount;
          }
        }
      });
      
      // 設置圖表數據
      if (mode === 'count') {
        categoryChart.data.datasets[0].data = categoryCounts;
        categoryChart.options.plugins.tooltip.callbacks.label = function(context) {
          const value = context.raw;
          const total = context.dataset.data.reduce((a, b) => a + b, 0);
          const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
          return `${value} 次 (${percentage}%)`;
        };
      } else {
        categoryChart.data.datasets[0].data = categoryAmounts.map(v => Math.round(v));
        categoryChart.options.plugins.tooltip.callbacks.label = function(context) {
          const value = context.raw;
          const total = context.dataset.data.reduce((a, b) => a + b, 0);
          const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
          return `${value} 元 (${percentage}%)`;
        };
      }
      
      categoryChart.update();
    }

    // 更新組合圖表（面值或銀行）
    function updateCombinedChart() {
      if (!combinedChart) return;
      
      if (currentChartMode === 'value') {
        // 面值分佈圖表 (不显示笑脸優惠券)
        const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0};
        const smileyCounts = 0; // 单独统计笑脸
        
        appState.vouchers.forEach(voucher => {
          if (voucher.amount === 0) {
            smileyCounts++;
          } else if (valueCounts.hasOwnProperty(voucher.amount)) {
            valueCounts[voucher.amount]++;
          }
        });
        
        // 將面值優惠券數據和笑臉数据组合到一起，但是笑臉放在最后
        const chartData = [
          valueCounts[10], 
          valueCounts[20], 
          valueCounts[50], 
          valueCounts[100], 
          valueCounts[200],
          smileyCounts
        ];
        
        combinedChart.data.labels = ['10元', '20元', '50元', '100元', '200元', '😄'];
        combinedChart.data.datasets[0].data = chartData;
        combinedChart.data.datasets[0].backgroundColor = document.documentElement.classList.contains('dark') ? 
          ['#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc', '#facc15'] : 
          ['#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff', '#fef08a'];
        
        // 修改柱狀圖高度設置，並預留足夠空間顯示數據標籤
        combinedChart.options.scales.y.beginAtZero = true;
        const maxCount = Math.max(...chartData);
        combinedChart.options.scales.y.max = maxCount > 0 ? Math.ceil(maxCount * 1.2) : 10;
        
        combinedChart.update();
      } else {
        // 銀行金額分佈圖表 (只计算可兑换的價值)
        const bankValues = {};
        banks.forEach(bank => {
          bankValues[bank.id] = 0;
        });
        
        // 只统计可兑换的優惠券金額
        appState.vouchers.forEach(voucher => {
          if (isVoucherRedeemable(voucher) && bankValues.hasOwnProperty(voucher.bankId)) {
            bankValues[voucher.bankId] += voucher.amount;
          }
        });
        
        // 過濾無數據的銀行並按金額排序
        const filteredBanks = banks
          .filter(bank => bankValues[bank.id] > 0)
          .sort((a, b) => bankValues[b.id] - bankValues[a.id]);
          
        const bankLabels = filteredBanks.map(bank => bank.name);
        const bankData = filteredBanks.map(bank => bankValues[bank.id]);
        
        // 銀行顏色
        const bankColors = filteredBanks.map((bank, i) => {
          const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#8b5cf6', '#ec4899', '#f43f5e'];
          return colors[i % colors.length];
        });
        
        combinedChart.data.labels = bankLabels;
        combinedChart.data.datasets[0].data = bankData;
        combinedChart.data.datasets[0].backgroundColor = bankColors;
        
        // 修改柱狀圖高度設置，並預留足夠空間顯示數據標籤
        combinedChart.options.scales.y.beginAtZero = true;
        const maxValue = Math.max(...bankData);
        combinedChart.options.scales.y.max = maxValue > 0 ? Math.ceil(maxValue * 1.2) : 500;
        
        combinedChart.update();
      }
    }

    // 更新圖表
    function updateCharts() {
      if (!statusChart || !categoryChart || !weeklyTrendChart || !combinedChart) return;
      
      // 更新組合圖表（面值或銀行）
      updateCombinedChart();
      
      // 計算優惠券狀態分佈 (只计算有效优惠券，排除笑臉)
      const statusCounts = [0, 0, 0]; // 未使用, 已兑換, 已過期
      
      appState.vouchers.forEach(voucher => {
        // 排除笑臉
        if (voucher.amount > 0) {
          if (voucher.used) {
            statusCounts[1]++; // 已兑換
          } else if (isVoucherExpired(voucher)) {
            statusCounts[2]++; // 已過期
          } else {
            statusCounts[0]++; // 未使用
          }
        }
      });
      
      // 更新狀態圖表
      statusChart.data.datasets[0].data = statusCounts;
      statusChart.update();
      
      // 更新消費類別圖表（按當前模式）
      updateCategoryChart(currentCategoryMode);
      
      // 完全重新計算每週優惠券金額和兑換金額
      // 首先初始化每個週次的數據為0
      const weeklyVoucherValues = Array(weekSchedule.length).fill(0);
      const weeklyRedemptionValues = Array(weekSchedule.length).fill(0);
      
      // 直接從vouchers數據中計算每週總金額
      // 注意：包括所有優惠券，無論是否已兑換或過期
      appState.vouchers.forEach(voucher => {
        if (voucher.amount > 0) {  // 排除笑臉
          const weekNum = getWeekNumberFromDate(voucher.date);
          if (weekNum >= 1 && weekNum <= weekSchedule.length) {
            weeklyVoucherValues[weekNum - 1] += voucher.amount;
          }
        }
      });
      
      // 按週次統計每週兑換金額
      appState.redemptionHistory.forEach(redemption => {
        const weekNum = redemption.weekNum;
        if (weekNum >= 1 && weekNum <= weekSchedule.length) {
          weeklyRedemptionValues[weekNum - 1] += redemption.voucherValue;
        }
      });
      
      // 更新週次趨勢圖表
      weeklyTrendChart.data.datasets[0].data = weeklyVoucherValues;
      weeklyTrendChart.data.datasets[1].data = weeklyRedemptionValues;
      weeklyTrendChart.update();
      
      // 檢查數據是否正確
      const totalVoucherAmount = appState.vouchers
        .filter(v => v.amount > 0)
        .reduce((sum, v) => sum + v.amount, 0);
      
      const chartTotal = weeklyVoucherValues.reduce((sum, v) => sum + v, 0);
      
      console.log("優惠券總金額檢查:", {
        "數據庫總金額": totalVoucherAmount,
        "圖表顯示總金額": chartTotal, 
        "週次數據": weeklyVoucherValues
      });
      
      // 如果發現總金額不匹配，記錄詳細的優惠券週次分佈
      if (totalVoucherAmount !== chartTotal) {
        console.warn("圖表金額與總金額不匹配！詳細週次分佈：");
        appState.vouchers.forEach(v => {
          if (v.amount > 0) {
            console.log(`優惠券ID: ${v.id}, 金額: ${v.amount}, 日期: ${v.date}, 計算週次: ${getWeekNumberFromDate(v.date)}`);
          }
        });
      }
    }

    // 初始化優惠券计算器
    function initVoucherCalculator() {
      document.getElementById('calculate-recommendation').addEventListener('click', function() {
        const amount = parseInt(document.getElementById('payment-amount').value);
        if (isNaN(amount) || amount <= 0) {
          alert('請輸入有效的消費金額！');
          return;
        }
        
        // 獲取未使用的優惠券（排除笑臉0元優惠券）
        const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);
        
        if (redeemableVouchers.length === 0) {
          document.getElementById('recommendation-result').innerHTML = `
            <div class="text-center py-4">
              <div class="text-red-500 dark:text-red-400">無法找到合適的優惠券組合</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">您目前沒有可用的優惠券</div>
            </div>
          `;
          document.getElementById('recommendation-result').classList.remove('hidden');
          return;
        }
        
        // 使用背包問題解決優惠券選擇問題
        // 目標：最大化優惠券總值，但總值的3倍不能超過消費金額
        const maxValue = Math.floor(amount / 3);
        
        // 排序優惠券（按面值大小由小到大）
        const sortedVouchers = [...redeemableVouchers].sort((a, b) => a.amount - b.amount);
        
        // 動態規劃求解
        const dp = new Array(maxValue + 1).fill(0); // dp[i] = 當面值不超過i時能達到的最大優惠券總值
        const selected = new Array(maxValue + 1).fill(null).map(() => []); // 記錄選中的優惠券
        
        for (const voucher of sortedVouchers) {
          for (let j = maxValue; j >= voucher.amount; j--) {
            const newValue = dp[j - voucher.amount] + voucher.amount;
            if (newValue > dp[j]) {
              dp[j] = newValue;
              selected[j] = [...selected[j - voucher.amount], voucher];
            }
          }
        }
        
        // 找出最佳組合
        const bestVouchers = selected[maxValue];
        
        if (bestVouchers.length === 0) {
          // 找不到完全匹配的組合，看是否需要多消費
          let closestVoucher = null;
          let smallestDiff = Infinity;
          
          for (const voucher of redeemableVouchers) {
            const diff = voucher.amount * 3 - amount;
            if (diff > 0 && diff < smallestDiff) {
              smallestDiff = diff;
              closestVoucher = voucher;
            }
          }
          
          if (closestVoucher) {
            document.getElementById('recommendation-result').innerHTML = `
              <div class="text-center py-4">
                <div class="text-yellow-500 dark:text-yellow-400">消費金額不足</div>
                <div class="text-sm mb-3">
                  最接近的優惠券為${closestVoucher.amount}元，需消費${closestVoucher.amount * 3}元
                </div>
                <div class="text-sm">您還需增加${closestVoucher.amount * 3 - amount}元消費金額</div>
                <button id="use-closest-voucher" class="mt-3 w-full py-2 bg-primary text-white rounded-lg">
                  選擇使用${closestVoucher.amount}元優惠券
                </button>
              </div>
            `;
            
            document.getElementById('use-closest-voucher').onclick = function() {
              appState.selectedVouchers = [closestVoucher.id];
              saveAppState();
              updateVoucherSelection();
              updateSelectedVouchers();
              document.querySelector('[data-tab="redeem"]').click();
              document.getElementById('recommendation-result').classList.add('hidden');
              document.getElementById('payment-amount').value = '';
              document.getElementById('manual-spend-amount').value = closestVoucher.amount * 3;
            };
          } else {
            document.getElementById('recommendation-result').innerHTML = `
              <div class="text-center py-4">
                <div class="text-red-500 dark:text-red-400">無法找到合適的優惠券組合</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">消費金額不足以兑換任何優惠券</div>
              </div>
            `;
          }
        } else {
          // 計算總值和所需消費金額
          const totalValue = bestVouchers.reduce((sum, v) => sum + v.amount, 0);
          const requiredAmount = totalValue * 3;
          
          // 按銀行分組
          const bankVouchers = {};
          bestVouchers.forEach(voucher => {
            if (!bankVouchers[voucher.bankId]) {
              bankVouchers[voucher.bankId] = [];
            }
            bankVouchers[voucher.bankId].push(voucher);
          });
          
          // 生成銀行列表
          let bankHTML = '';
          Object.entries(bankVouchers).forEach(([bankId, vouchers]) => {
            const bank = banks.find(b => b.id === bankId);
            if (!bank) return;
            
            // 按面值分組
            const amountCounts = {};
            vouchers.forEach(v => {
              if (!amountCounts[v.amount]) amountCounts[v.amount] = 0;
              amountCounts[v.amount]++;
            });
            
            const bankTotal = vouchers.reduce((sum, v) => sum + v.amount, 0);
            
            bankHTML += `
              <div class="mb-2 border rounded p-2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                    <span class="font-medium">${bank.name}</span>
                  </div>
                  <div>${vouchers.length}張 (${bankTotal}元)</div>
                </div>
                <div class="ml-4 text-xs text-gray-500 dark:text-gray-400 mt-1">
                  ${Object.entries(amountCounts).map(([amt, count]) => `${amt}元: ${count}張`).join(', ')}
                </div>
              </div>
            `;
          });
          
          document.getElementById('recommendation-result').innerHTML = `
            <div>
              <div class="text-green-500 dark:text-green-400 font-bold mb-2">找到最佳組合</div>
              <div class="text-sm mb-3">
                <div>消費金額: ${amount}元</div>
                <div>節省金額: ${totalValue}元</div>
                <div>自費金額: ${amount - totalValue}元</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">所需消費: ${requiredAmount}元</div>
                <div class="mt-1">使用優惠券: ${bestVouchers.length}張</div>
              </div>
              <div class="mt-3 pt-2 border-t">
                <div class="font-medium mb-1">優惠券明細:</div>
                ${bankHTML}
              </div>
              <div class="mt-3 pt-3 border-t">
                <button id="select-recommended-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white py-2 rounded-lg">
                  選擇這些優惠券
                </button>
              </div>
            </div>
          `;
          
          // 添加選擇按鈕事件
          document.getElementById('select-recommended-vouchers').onclick = function() {
            // 將推薦的優惠券添加到已選擇列表
            appState.selectedVouchers = bestVouchers.map(v => v.id);
            
            // 更新UI
            saveAppState();
            updateVoucherSelection();
            updateSelectedVouchers();
            
            // 設置消費金額
            document.getElementById('manual-spend-amount').value = amount;
            
            // 切換到兑換選項卡
            document.querySelector('[data-tab="redeem"]').click();
            
            // 隱藏結果
            document.getElementById('recommendation-result').classList.add('hidden');
            document.getElementById('payment-amount').value = '';
          };
        }
        
        document.getElementById('recommendation-result').classList.remove('hidden');
      });
      
      // Enter鍵觸發計算
      document.getElementById('payment-amount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('calculate-recommendation').click();
        }
      });
    }

    // 初始化選項卡功能
    function initTabs() {
      const tabButtons = document.querySelectorAll('#tabs button');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          
          // 更新按鈕樣式
          tabButtons.forEach(btn => {
            btn.classList.remove('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
            btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
          });
          
          this.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
          this.classList.add('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
          
          // 顯示對應內容
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          
          document.getElementById(`${tabName}-content`).classList.remove('hidden');
          
          // 更新圖表
          if (tabName === 'charts') {
            updateCharts();
          }
          
          // 更新統計分析
          if (tabName === 'stats') {
            updateDetailedAnalysis();
          }
        });
      });
    }

    // 初始化數據管理
    function initDataManagement() {
      // 匯出數據
      document.getElementById('export-data-btn').addEventListener('click', function() {
        // 生成匯出內容
        const summary = document.getElementById('export-summary');
        const valueDistribution = document.getElementById('export-value-distribution');
        const bankDistribution = document.getElementById('export-bank-distribution');
        const categoryDistribution = document.getElementById('export-category-distribution');
        const weeklyData = document.getElementById('export-weekly-data');
        
        // 1. 總覽統計
        const totalCount = appState.vouchers.length;
        const redeemableCount = getRedeemableVoucherCount();
        const smileCount = appState.vouchers.filter(v => v.amount === 0).length;
        const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
        const usedCount = appState.vouchers.filter(v => v.used).length;
        const expiredCount = appState.vouchers.filter(v => !v.used && isVoucherExpired(v) && v.amount > 0).length;
        const unusedCount = redeemableCount;
        const usageRate = (totalCount - smileCount) > 0 ? 
                         Math.round((usedCount / (totalCount - smileCount)) * 100) : 0;
        
        summary.innerHTML = `
          <div>總優惠券: ${totalCount}張 (總價值: ${totalValue}元)</div>
          <div>可兑換優惠券: ${redeemableCount}張</div>
          <div>笑臉優惠券: ${smileCount}張 (不可兑換)</div>
          <div>未使用: ${unusedCount}張, 已兑換: ${usedCount}張, 已過期: ${expiredCount}張</div>
          <div>使用率: ${usageRate}%</div>
        `;
        
        // 2. 面值分佈
        const valueCounts = {0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0};
        appState.vouchers.forEach(v => valueCounts[v.amount]++);
        
        valueDistribution.innerHTML = `
          <div>笑臉(0元): ${valueCounts[0]}張 (不可兑換)</div>
          <div>10元: ${valueCounts[10]}張</div>
          <div>20元: ${valueCounts[20]}張</div>
          <div>50元: ${valueCounts[50]}張</div>
          <div>100元: ${valueCounts[100]}張</div>
          <div>200元: ${valueCounts[200]}張</div>
        `;
        
        // 3. 銀行分佈
        const bankCounts = {};
        const bankValues = {};
        const bankRedeemableCounts = {};
        
        banks.forEach(bank => {
          bankCounts[bank.id] = 0;
          bankValues[bank.id] = 0;
          bankRedeemableCounts[bank.id] = 0;
        });
        
        appState.vouchers.forEach(v => {
          if (v.bankId) {
            bankCounts[v.bankId] = (bankCounts[v.bankId] || 0) + 1;
            bankValues[v.bankId] = (bankValues[v.bankId] || 0) + v.amount;
            
            // 計算可兑換數量
            if (isVoucherRedeemable(v)) {
              bankRedeemableCounts[v.bankId] = (bankRedeemableCounts[v.bankId] || 0) + 1;
            }
          }
        });
        
        let bankHTML = '';
        banks.forEach(bank => {
          if (bankCounts[bank.id] > 0) {
            bankHTML += `<div>${bank.name}: ${bankCounts[bank.id]}張 (${bankValues[bank.id]}元)`;
            
            // 添加可兑換數量
            if (bankRedeemableCounts[bank.id] > 0) {
              bankHTML += ` - 可兑換: ${bankRedeemableCounts[bank.id]}張`;
            }
            
            bankHTML += `</div>`;
          }
        });
        
        bankDistribution.innerHTML = bankHTML || '<div>無銀行數據</div>';
        
        // 4. 消費類別分析
        const categoryCounts = {};
        const categoryAmounts = {};
        
        expenseCategories.forEach(cat => {
          categoryCounts[cat.id] = 0;
          categoryAmounts[cat.id] = 0;
        });
        
        appState.redemptionHistory.forEach(redemption => {
          const categories = redemption.categories || ['other'];
          const amountPerCategory = redemption.spendAmount / categories.length;
          
          categories.forEach(category => {
            categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            categoryAmounts[category] = (categoryAmounts[category] || 0) + amountPerCategory;
          });
        });
        
        let categoryHTML = '';
        expenseCategories.forEach(cat => {
          if (categoryCounts[cat.id] > 0) {
            categoryHTML += `<div>${cat.name}: ${categoryCounts[cat.id]}次 (${Math.round(categoryAmounts[cat.id])}元)</div>`;
          }
        });
        
        categoryDistribution.innerHTML = categoryHTML || '<div>無消費類別數據</div>';
        
        // 5. 週次數據
        let weeklyHTML = '';
        appState.weekRecords.forEach(record => {
          if (record.voucherCount > 0) {
            // 計算可兑換
            const redeemableCount = record.redeemableCount || 
                                   (record.voucherCount - record.usedCount - record.valueCounts[0]);
            
            weeklyHTML += `
              <div>第${record.weekNum}週: ${record.voucherCount}張 (${record.voucherValue}元)</div>
              <div class="ml-2 text-xs">已兑換: ${record.usedCount}張, 可兑換: ${redeemableCount}張, 消費金額: ${record.spendAmount || 0}元</div>
            `;
          }
        });
        
        weeklyData.innerHTML = weeklyHTML || '<div>無週次數據</div>';
        
        // 生成匯出報告的純文本版本
        let reportText = `=== 2025年社區消費大獎賞追蹤器 - 報告 ===\n\n`;
        
        // 總覽
        reportText += `【總覽統計】\n`;
        reportText += `總優惠券: ${totalCount}張 (總價值: ${totalValue}元)\n`;
        reportText += `可兑換優惠券: ${redeemableCount}張\n`;
        reportText += `笑臉優惠券: ${smileCount}張 (不可兑換)\n`;
        reportText += `未使用: ${unusedCount}張, 已兑換: ${usedCount}張, 已過期: ${expiredCount}張\n`;
        reportText += `使用率: ${usageRate}%\n\n`;
        
        // 面值分佈
        reportText += `【面值分佈】\n`;
        reportText += `笑臉(0元): ${valueCounts[0]}張 (不可兑換)\n`;
        reportText += `10元: ${valueCounts[10]}張\n`;
        reportText += `20元: ${valueCounts[20]}張\n`;
        reportText += `50元: ${valueCounts[50]}張\n`;
        reportText += `100元: ${valueCounts[100]}張\n`;
        reportText += `200元: ${valueCounts[200]}張\n\n`;
        
        // 銀行分佈
        reportText += `【銀行分佈】\n`;
        banks.forEach(bank => {
          if (bankCounts[bank.id] > 0) {
            reportText += `${bank.name}: ${bankCounts[bank.id]}張 (${bankValues[bank.id]}元)`;
            
            // 添加可兑換數量
            if (bankRedeemableCounts[bank.id] > 0) {
              reportText += ` - 可兑換: ${bankRedeemableCounts[bank.id]}張`;
            }
            
            reportText += `\n`;
          }
        });
        reportText += `\n`;
        
        // 消費類別分析
        reportText += `【消費類別分析】\n`;
        expenseCategories.forEach(cat => {
          if (categoryCounts[cat.id] > 0) {
            reportText += `${cat.name}: ${categoryCounts[cat.id]}次 (${Math.round(categoryAmounts[cat.id])}元)\n`;
          }
        });
        reportText += `\n`;
        
        // 週次數據
        reportText += `【週次數據】\n`;
        appState.weekRecords.forEach(record => {
          if (record.voucherCount > 0) {
            const redeemableCount = record.redeemableCount || 
                                   (record.voucherCount - record.usedCount - record.valueCounts[0]);
                                   
            reportText += `第${record.weekNum}週: ${record.voucherCount}張 (${record.voucherValue}元)\n`;
            reportText += `  已兑換: ${record.usedCount}張, 可兑換: ${redeemableCount}張, 消費金額: ${record.spendAmount || 0}元\n`;
          }
        });
        
        // 創建當前日期字符串，格式為 YYYYMMDD
        const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        
        // 設置下載按鈕
        document.getElementById('download-export-btn').onclick = function() {
          // 創建Blob對象
          const blob = new Blob([reportText], {type: 'text/plain'});
          
          // 創建下載鏈接
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `優惠券統計報告_${dateStr}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };
        
        // 設置複製按鈕
        document.getElementById('copy-export-data-btn').onclick = function() {
          navigator.clipboard.writeText(reportText)
            .then(() => {
              alert('報告已成功複製到剪貼板！');
            })
            .catch(e => {
              alert('複製失敗，請手動複製報告。');
              console.error('複製失敗:', e);
            });
        };
        
        // 顯示匯出模態框
        document.getElementById('export-data-modal').classList.remove('hidden');
      });
      
      // 關閉匯出數據模態框
      document.getElementById('close-export-data').addEventListener('click', function() {
        document.getElementById('export-data-modal').classList.add('hidden');
      });
      
      document.getElementById('close-export-modal-btn').addEventListener('click', function() {
        document.getElementById('export-data-modal').classList.add('hidden');
      });
      
      // 備份/恢復數據
      document.getElementById('data-management-btn').addEventListener('click', function() {
        // 顯示備份數據畫面
        const dataStr = JSON.stringify(appState);
        document.getElementById('backup-code').textContent = dataStr;
        
        // 清空匯入框
        document.getElementById('import-data-textarea').value = '';
        
        // 計算並顯示存儲使用情況
        calculateStorageSize();
        
        // 顯示模態框
        document.getElementById('data-management-modal').classList.remove('hidden');
      });
      
      // 複製備份碼
      document.getElementById('copy-backup-code').addEventListener('click', function() {
        const backupCode = document.getElementById('backup-code').textContent;
        try {
          navigator.clipboard.writeText(backupCode)
            .then(() => {
              alert('備份碼已複製到剪貼板！');
            })
            .catch(e => {
              // 如果API複製失敗，提供其他複製方式
              const textArea = document.createElement('textarea');
              textArea.value = backupCode;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              alert('備份碼已複製到剪貼板！');
            });
        } catch (e) {
          alert('無法自動複製，請手動全選文本並按Ctrl+C複製');
        }
      });
      
      // 恢復數據
      document.getElementById('restore-data-btn').addEventListener('click', function() {
        const importData = document.getElementById('import-data-textarea').value.trim();
        if (!importData) {
          alert('請輸入備份碼！');
          return;
        }
        
        try {
          // 嘗試解析數據
          const parsedData = JSON.parse(importData);
          
          // 檢查是否包含必要的屬性
          if (!parsedData.vouchers) {
            throw new Error('無效的備份數據：缺少優惠券資料');
          }
          
          // 確認是否要覆蓋當前數據
          if (confirm('確定要使用備份數據覆蓋當前數據嗎？此操作無法撤銷！')) {
            // 保存當前數據為臨時備份，以防恢復失敗
            const tempBackup = JSON.stringify(appState);
            
            try {
              // 更新應用狀態
              appState = parsedData;
              
              // 確保兼容舊版本數據
              if (!appState.selectedVouchers) appState.selectedVouchers = [];
              if (!appState.weekRecords) appState.weekRecords = [];
              if (!appState.redemptionHistory) appState.redemptionHistory = [];
              if (!appState.bankDisplayFilter) appState.bankDisplayFilter = banks.map(bank => bank.id);
              if (!appState.bankFilter) appState.bankFilter = { active: false, selectedBanks: [] };
              
              // 確保有下一個消費編號
              if (!appState.nextRedemptionId) {
                appState.nextRedemptionId = appState.redemptionHistory.length > 0 ? 
                  Math.max(...appState.redemptionHistory.map(r => Number(r.displayId) || 0)) + 1 : 1;
              }
              
              // 處理舊版本數據兼容性 - 在舊記錄中添加消費類別屬性
              appState.redemptionHistory.forEach(redemption => {
                if (!redemption.categories) {
                  redemption.categories = ['other']; // 默認為其他類別
                }
              });
              
              // 更新當前週次
              appState.currentWeek = calculateCurrentWeek();
              
              // 更新週次記錄
              updateWeekRecords();
              
              // 保存到本地儲存
              saveAppState();
              
              // 更新UI
              updateDateDisplay();
              updateBankButtons();
              updateQuickAddPanel();
              updateBankOverview();
              updateRedeemableVouchers();
              updateVoucherSelection();
              updateSelectedVouchers();
              updateTotalStats();
              updateWeekRecordsDisplay();
              updateRedemptionHistory();
              updateDetailedAnalysis();
              updateCharts();
              
              // 關閉模態框
              document.getElementById('data-management-modal').classList.add('hidden');
              
              alert('數據恢復成功！');
            } catch (restoreError) {
              // 如果恢復過程中發生錯誤，嘗試恢復到臨時備份
              try {
                appState = JSON.parse(tempBackup);
                saveAppState();
                alert('恢復失敗，已還原到之前的數據。錯誤: ' + restoreError.message);
              } catch (backupError) {
                alert('恢復失敗，且無法還原到之前的數據。請重新加載頁面。錯誤: ' + restoreError.message);
              }
            }
          }
        } catch (e) {
          alert('無效的備份碼格式。請確保您複製了完整的備份碼。錯誤: ' + e.message);
        }
      });
      
      // 關閉數據管理模態框
      document.getElementById('close-data-management').addEventListener('click', function() {
        document.getElementById('data-management-modal').classList.add('hidden');
      });
      
      document.getElementById('close-management-btn').addEventListener('click', function() {
        document.getElementById('data-management-modal').classList.add('hidden');
      });
    }

    // 應用程序啟動
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化功能
      initTabs();
      initVoucherCalculator();
      initDataManagement();
      initCharts();
      
      // 確保初始化銀行顯示過濾器
      if (!appState.bankDisplayFilter) {
        appState.bankDisplayFilter = banks.map(bank => bank.id);
      }
      
      // 確保初始化銀行過濾器
      if (!appState.bankFilter) {
        appState.bankFilter = {
          active: false,
          selectedBanks: []
        };
      }
      
      // 初始化銀行過濾器
      function initBankFilters() {
        const bankFiltersContainer = document.getElementById('bank-filters');
        if (!bankFiltersContainer) {
          console.error("找不到bank-filters容器");
          return;
        }
        
        bankFiltersContainer.innerHTML = '';
        
        // 為每個銀行創建過濾按鈕
        banks.forEach(bank => {
          const isSelected = appState.bankDisplayFilter.includes(bank.id);
          
          const filterBtn = document.createElement('button');
          filterBtn.className = `text-xs px-2 py-1 rounded-full flex items-center ${
            isSelected ? 'bg-' + bank.color + ' text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
          }`;
          filterBtn.setAttribute('data-bank', bank.id);
          filterBtn.innerHTML = `<i class="${bank.logo} mr-1"></i> ${bank.name}`;
          
          filterBtn.addEventListener('click', function() {
            const bankId = this.getAttribute('data-bank');
            
            // 切換選中狀態
            if (appState.bankDisplayFilter.includes(bankId)) {
              appState.bankDisplayFilter = appState.bankDisplayFilter.filter(id => id !== bankId);
            } else {
              appState.bankDisplayFilter.push(bankId);
            }
            
            saveAppState();
            initBankFilters();  // 重新初始化過濾器
          });
          
          bankFiltersContainer.appendChild(filterBtn);
        });
        
        // 添加全選和清空按鈕
        const allBtn = document.createElement('button');
        allBtn.className = 'text-xs px-2 py-1 rounded-full bg-primary text-white';
        allBtn.textContent = '全選';
        allBtn.addEventListener('click', function() {
          appState.bankDisplayFilter = banks.map(bank => bank.id);
          saveAppState();
          initBankFilters();
        });
        
        const clearBtn = document.createElement('button');
        clearBtn.className = 'text-xs px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
        clearBtn.textContent = '清空';
        clearBtn.addEventListener('click', function() {
          appState.bankDisplayFilter = [];
          saveAppState();
          initBankFilters();
        });
        
        bankFiltersContainer.appendChild(allBtn);
        bankFiltersContainer.appendChild(clearBtn);
      }
      
      // 銀行顯示設置
      const bankSettingsBtn = document.getElementById('bank-display-settings-btn');
      if (bankSettingsBtn) {
        bankSettingsBtn.addEventListener('click', function() {
          initBankFilters();
          document.getElementById('bank-display-settings-modal').classList.remove('hidden');
        });
      }
      
      const closeBtn = document.getElementById('close-bank-display-settings');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          document.getElementById('bank-display-settings-modal').classList.add('hidden');
        });
      }
      
      const selectAllBtn = document.getElementById('select-all-display-banks');
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
          appState.bankDisplayFilter = banks.map(bank => bank.id);
          saveAppState();
          initBankFilters();
        });
      }
      
      const clearDisplayBtn = document.getElementById('clear-display-banks');
      if (clearDisplayBtn) {
        clearDisplayBtn.addEventListener('click', function() {
          appState.bankDisplayFilter = [];
          saveAppState();
          initBankFilters();
        });
      }
      
      const saveBtn = document.getElementById('save-bank-display-settings');
      if (saveBtn) {
        saveBtn.addEventListener('click', function() {
          document.getElementById('bank-display-settings-modal').classList.add('hidden');
          updateBankButtons();
          updateBankOverview();
          updateCharts();
        });
      }
      
      // 加載數據和初始化UI
      loadAppState();
      updateDateDisplay();
      updateWeekSchedule();
      updateBankButtons();
      updateQuickAddPanel();
      updateBankOverview();
      updateRedeemableVouchers();
      updateVoucherSelection();
      updateSelectedVouchers();
      updateTotalStats();
      updateWeekRecordsDisplay();
      updateRedemptionHistory();
      updateDetailedAnalysis();
      updateCharts();
      
      // 計算當前存儲使用量
      setTimeout(calculateStorageSize, 500); // 延遲計算以確保所有數據都已加載
    });
  </script>
</body>
</html>
