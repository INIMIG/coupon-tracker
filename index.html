<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025å¹´ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            'primary-dark': '#4B4AB2',
            'boc': '#c1272d',
            'boc-dark': '#a01e21',
            'icbc': '#c7000a',
            'icbc-dark': '#a00008',
            'macaupass': '#0c6e4f',
            'macaupass-dark': '#095338',
            'luso': '#00529b',
            'luso-dark': '#003e75',
            'ant': '#2c64ae',
            'ant-dark': '#1a4d8a',
            'mox': '#e20074',
            'mox-dark': '#b00058',
            'mpay': '#1e469a',
            'mpay-dark': '#173777'
          }
        }
      }
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
  <!-- é ‚éƒ¨çš„å€‹äººæª”æ¡ˆé¸æ“‡ -->
  <div class="fixed top-0 inset-x-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 shadow-sm z-10">
    <div class="max-w-md mx-auto px-4 py-2 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <span class="text-sm font-medium">ç•¶å‰ä½¿ç”¨è€…:</span>
        <select id="profile-selector" class="text-sm border rounded py-1 px-2 bg-white dark:bg-gray-800 dark:border-gray-600">
          <option value="default">é»˜èªä½¿ç”¨è€…</option>
          <!-- å…¶ä»–å€‹äººæª”æ¡ˆå°‡å‹•æ…‹æ·»åŠ  -->
        </select>
      </div>
      <button id="manage-profiles-btn" class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary-dark">
        ç®¡ç†
      </button>
    </div>
  </div>
  
  <div class="max-w-md mx-auto p-4 pt-14">
    <!-- æ¨™é¡Œå’Œè¨ˆæ•¸å™¨ -->
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold text-primary dark:text-primary mb-2">2025å¹´ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨</h1>
      <div class="text-sm bg-blue-50 dark:bg-blue-900 p-2 rounded-lg flex justify-between items-center">
        <div>
          ä»Šå¤©ï¼š<span id="current-date">è¼‰å…¥ä¸­...</span> | <span id="current-week">è¼‰å…¥ä¸­...</span>
        </div>
        <button id="view-past-records" class="text-primary dark:text-primary hover:underline text-xs">
          æŸ¥çœ‹éå»è¨˜éŒ„
        </button>
      </div>
    </div>

    <!-- æ¶ˆè²»é‡‘é¡è¨ˆç®—å™¨å€åŸŸ -->
    <div class="mb-4 bg-green-50 dark:bg-green-900/20 rounded-lg p-3 shadow">
      <div class="flex items-center justify-between mb-2">
        <div>
          <div class="text-sm font-medium">å„ªæƒ åˆ¸è¨ˆç®—å™¨</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">è¼¸å…¥é‡‘é¡è¨ˆç®—æœ€ä½³çµ„åˆ</div>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-500 dark:text-gray-400">æœªä½¿ç”¨å„ªæƒ åˆ¸</div>
          <div class="text-xl font-bold text-green-600 dark:text-green-400" id="unused-vouchers">0</div>
        </div>
      </div>
      
      <div class="flex space-x-2">
        <input type="number" id="payment-amount" min="1" placeholder="è¼¸å…¥æ¶ˆè²»é‡‘é¡" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
        <button id="calculate-recommendation" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
          è¨ˆç®—
        </button>
      </div>
      
      <!-- è¨ˆç®—çµæœå€åŸŸ -->
      <div id="recommendation-result" class="mt-3 border rounded-lg p-3 bg-white dark:bg-gray-800 hidden">
        <!-- æ¨è–¦çµæœå°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
      </div>
    </div>

    <!-- éŠ€è¡Œé¸æ“‡æŒ‰éˆ•çµ„ -->
    <div class="mb-4">
      <div class="text-sm font-medium mb-2">é¸æ“‡æ”¯ä»˜å·¥å…· (é»æ“ŠéŠ€è¡Œæ·»åŠ å„ªæƒ åˆ¸)</div>
      <div class="grid grid-cols-4 gap-2" id="bank-buttons">
        <!-- éŠ€è¡ŒæŒ‰éˆ•å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
      </div>
    </div>

    <!-- å¿«é€Ÿæ·»åŠ å„ªæƒ åˆ¸ (ç•¶é¸ä¸­éŠ€è¡Œæ™‚é¡¯ç¤º) -->
    <div id="quick-add-container" class="mb-4 hidden">
      <div class="text-sm font-medium mb-2">æ·»åŠ <span id="selected-bank-name-display">éŠ€è¡Œ</span>å„ªæƒ åˆ¸ (å‰©é¤˜: <span id="remaining-draws">3</span>æ¬¡)</div>
      <div class="grid grid-cols-3 gap-2 mb-2">
        <button data-amount="10" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
          10å…ƒ
        </button>
        <button data-amount="20" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
          20å…ƒ
        </button>
        <button data-amount="50" class="quick-add py-2 px-1 bg-green-100 dark:bg-green-900 rounded-lg text-center hover:bg-green-200 dark:hover:bg-green-800 transition-colors">
          50å…ƒ
        </button>
        <button data-amount="100" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">
          100å…ƒ
        </button>
        <button data-amount="200" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">
          200å…ƒ
        </button>
        <button data-amount="0" class="quick-add py-2 px-1 bg-yellow-100 dark:bg-yellow-900 rounded-lg text-center hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors">
          ğŸ˜„
        </button>
      </div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½é¸é …å¡ -->
    <div class="mb-4">
      <div class="border-b border-gray-200 dark:border-gray-700">
        <ul class="flex" id="tabs">
          <li class="flex-1 text-center">
            <button class="w-full py-2 px-1 text-primary dark:text-primary border-b-2 border-primary dark:border-primary tab-active" data-tab="vouchers">æˆ‘çš„å„ªæƒ åˆ¸</button>
          </li>
          <li class="flex-1 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="stats">çµ±è¨ˆåœ–è¡¨</button>
          </li>
          <li class="flex-1 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="history">é€±æ¬¡è¨˜éŒ„</button>
          </li>
          <li class="flex-1 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="info">æ´»å‹•è³‡è¨Š</button>
          </li>
          <li class="flex-1 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="profiles">å®¶äººå…±äº«</button>
          </li>
        </ul>
      </div>
    </div>

    <!-- æˆ‘çš„å„ªæƒ åˆ¸é¢æ¿ -->
    <div class="tab-content" id="vouchers-content">
      <!-- å„éŠ€è¡Œå„ªæƒ åˆ¸ç¸½å€¼çµ±è¨ˆ -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
        <h3 class="text-sm font-bold mb-2">å„éŠ€è¡Œå„ªæƒ åˆ¸ç¸½å€¼</h3>
        <div id="bank-totals-list" class="space-y-2">
          <!-- éŠ€è¡Œå„ªæƒ åˆ¸ç¸½å€¼å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
      </div>
      
      <!-- å„ªæƒ åˆ¸åˆ—è¡¨ -->
      <div id="voucher-list" class="space-y-3">
        <!-- å„ªæƒ åˆ¸å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
          å°šæœªè¨˜éŒ„å„ªæƒ åˆ¸<br>é»æ“Šä¸Šæ–¹éŠ€è¡Œå’Œé¢å€¼æ·»åŠ 
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆåœ–è¡¨é¢æ¿ -->
    <div class="tab-content hidden" id="stats-content">
      <!-- é€±æ¬¡ç¯©é¸ -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
        <label class="block text-sm font-medium mb-1">é¸æ“‡é€±æ¬¡ç¯©é¸</label>
        <select id="chart-week-filter" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
          <option value="all">æ‰€æœ‰é€±æ¬¡</option>
          <!-- é€±æ¬¡é¸é …å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </select>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">å„ªæƒ åˆ¸ç¸½å€¼</h3>
        <div class="h-60">
          <canvas id="value-chart"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">å„éŠ€è¡Œå„ªæƒ åˆ¸åˆ†ä½ˆ</h3>
        <div class="h-60">
          <canvas id="bank-chart"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">é€±æ¬¡åˆ†ä½ˆ</h3>
        <div class="h-60">
          <canvas id="week-chart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- å®¶äººå…±äº«é¢æ¿ -->
    <div class="tab-content hidden" id="profiles-content">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">å®¶äººå…±äº«ç®¡ç†</h3>
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
          å»ºç«‹å’Œç®¡ç†å®¶åº­æˆå“¡çš„ç¨ç«‹è¨˜éŒ„ï¼Œæ¯å€‹æˆå“¡éƒ½å¯ä»¥æ“æœ‰è‡ªå·±çš„å„ªæƒ åˆ¸è¨˜éŒ„
        </p>
        
        <div class="space-y-3" id="profiles-list">
          <!-- å€‹äººæª”æ¡ˆåˆ—è¡¨å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
        
        <div class="mt-4">
          <button id="add-profile-btn" class="w-full bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
            <i class="ri-add-line mr-1"></i> æ·»åŠ æ–°å®¶åº­æˆå“¡
          </button>
        </div>
      </div>
    </div>

    <!-- é€±æ¬¡è¨˜éŒ„é¢æ¿ -->
    <div class="tab-content hidden" id="history-content">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">æ­·é€±è¨˜éŒ„</h3>
          <button id="new-week-btn" class="text-sm bg-primary hover:bg-primary-dark text-white px-3 py-1 rounded-lg transition-colors">
            è¨˜éŒ„æ–°é€±æ¬¡
          </button>
        </div>
        
        <div id="week-records-list" class="space-y-3">
          <!-- é€±æ¬¡è¨˜éŒ„å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
          <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            å°šç„¡é€±æ¬¡è¨˜éŒ„
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ´»å‹•è³‡è¨Šé¢æ¿ -->
    <div class="tab-content hidden" id="info-content">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">æ´»å‹•æ™‚é–“</h3>
        <p class="mb-2">2025å¹´3æœˆ24æ—¥è‡³2025å¹´6æœˆ1æ—¥</p>
        
        <h3 class="font-bold mb-2 mt-4">æŠ½çè³‡æ ¼</h3>
        <p class="mb-2">é€±ä¸€è‡³é€±äº”åœ¨æ¯é–“æ‰¿è¾¦æ©Ÿæ§‹æ”¯ä»˜å·¥å…·æ¶ˆè²»æ»¿50æ¾³é–€å…ƒï¼Œå¯ç²3æ¬¡æŠ½çæ©Ÿæœƒ</p>
        <p class="mb-2">é€±æœ«æ¶ˆè²»æ»¿50æ¾³é–€å…ƒï¼Œå¯ç²å¾—é€±æŠ½çåŠçµ‚æ¥µå¤§æŠ½çè³‡æ ¼</p>
        
        <h3 class="font-bold mb-2 mt-4">å„ªæƒ åˆ¸é¢å€¼</h3>
        <p class="mb-2">ğŸ˜„(ç¬‘å“ˆå“ˆ)ã€10ã€20ã€50ã€100 æˆ– 200 æ¾³é–€å…ƒ</p>
        
        <h3 class="font-bold mb-2 mt-4">ä½¿ç”¨é™åˆ¶</h3>
        <p class="mb-2">å„ªæƒ åˆ¸é ˆæ–¼ç²å¾—å¾Œç·Šæ¥çš„é€±å…­åŠé€±æ—¥ä½¿ç”¨ï¼Œé€¾æœŸç„¡æ•ˆ</p>
        
        <h3 class="font-bold mb-2 mt-4">é€±æœŸæ™‚é–“è¡¨</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b dark:border-gray-700">
                <th class="text-left py-2">é€±æ¬¡</th>
                <th class="text-left py-2">æ´»å‹•æ™‚é–“</th>
                <th class="text-left py-2">æ¸…é›¶æ™‚é–“</th>
              </tr>
            </thead>
            <tbody id="week-schedule">
              <!-- é€±æœŸæ™‚é–“è¡¨å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- é‡ç½®æœ¬é€±æŠ½çæ¬¡æ•¸æŒ‰éˆ• -->
      <div class="mt-4 mb-4">
        <button id="reset-draws-btn" class="w-full bg-primary hover:bg-primary-dark text-white py-3 px-4 rounded-lg transition-colors">
          é‡ç½®æœ¬é€±æŠ½çæ¬¡æ•¸
        </button>
      </div>

      <!-- æ¸…é™¤æ‰€æœ‰æ•¸æ“šæŒ‰éˆ• -->
      <div class="mt-4">
        <button id="clear-all-data" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-lg transition-colors">
          æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        </button>
      </div>
    </div>

    <!-- æŸ¥çœ‹é€±æ¬¡è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="week-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold" id="week-detail-title">é€±æ¬¡è©³æƒ…</h3>
          <button id="close-week-detail" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div id="week-detail-content">
          <!-- é€±æ¬¡è©³æƒ…å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
        
        <div class="mt-4 flex justify-end">
          <button id="close-detail-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
    
    <!-- è¨˜éŒ„æ–°é€±æ¬¡æ¨¡æ…‹æ¡† -->
    <div id="new-week-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">è¨˜éŒ„æ–°é€±æ¬¡</h3>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">é¸æ“‡é€±æ¬¡</label>
          <select id="week-select" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
            <!-- é€±æ¬¡é¸é …å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
          </select>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">å‚™è¨» (é¸å¡«)</label>
          <input type="text" id="week-notes" placeholder="æ·»åŠ å‚™è¨»" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
        </div>

        <div class="flex space-x-2">
          <button id="cancel-new-week" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">å–æ¶ˆ</button>
          <button id="confirm-new-week" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">ç¢ºèª</button>
        </div>
      </div>
    </div>
    
    <!-- ç¢ºèªåˆªé™¤æ¨¡æ…‹æ¡† -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">ç¢ºèªåˆªé™¤</h3>
        <p class="mb-4">ç¢ºå®šè¦åˆªé™¤é€™å¼µå„ªæƒ åˆ¸å—ï¼Ÿ</p>
        <div class="flex space-x-2">
          <button id="cancel-delete" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">å–æ¶ˆ</button>
          <button id="confirm-delete" class="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ç¢ºèªåˆªé™¤</button>
        </div>
      </div>
    </div>
    
    <!-- æŸ¥çœ‹éå»è¨˜éŒ„æ¨¡æ…‹æ¡† -->
    <div id="past-records-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">æŸ¥çœ‹éå»è¨˜éŒ„</h3>
          <button id="close-past-records" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">é¸æ“‡é€±æ¬¡</label>
          <select id="past-week-select" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
            <option value="">--é¸æ“‡é€±æ¬¡--</option>
            <!-- é€±æ¬¡é¸é …å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
          </select>
        </div>
        
        <div class="flex space-x-2">
          <button id="view-past-week" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">æŸ¥çœ‹</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // è¨­ç½®æ·±è‰²æ¨¡å¼
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    // æ´»å‹•é€±æœŸæ•¸æ“š
    const weekSchedule = [
      { week: 1, startDate: '2025-03-24', endDate: '2025-03-28', resetDate: '2025-03-29' },
      { week: 2, startDate: '2025-03-31', endDate: '2025-04-04', resetDate: '2025-04-05' },
      { week: 3, startDate: '2025-04-07', endDate: '2025-04-11', resetDate: '2025-04-12' },
      { week: 4, startDate: '2025-04-14', endDate: '2025-04-18', resetDate: '2025-04-19' },
      { week: 5, startDate: '2025-04-21', endDate: '2025-04-25', resetDate: '2025-04-26' },
      { week: 6, startDate: '2025-04-28', endDate: '2025-05-02', resetDate: '2025-05-03' },
      { week: 7, startDate: '2025-05-05', endDate: '2025-05-09', resetDate: '2025-05-10' },
      { week: 8, startDate: '2025-05-12', endDate: '2025-05-16', resetDate: '2025-05-17' },
      { week: 9, startDate: '2025-05-19', endDate: '2025-05-23', resetDate: '2025-05-24' },
      { week: 10, startDate: '2025-05-26', endDate: '2025-05-30', resetDate: '2025-05-31' }
    ];

    // éŠ€è¡Œæ”¯ä»˜å·¥å…·
    const banks = [
      { id: 'boc', name: 'ä¸­åœ‹éŠ€è¡Œ', color: 'boc', darkColor: 'boc-dark', logo: 'ri-bank-fill' },
      { id: 'icbc', name: 'å·¥å•†éŠ€è¡Œ', color: 'icbc', darkColor: 'icbc-dark', logo: 'ri-bank-fill' },
      { id: 'luso', name: 'å¤§è±éŠ€è¡Œ', color: 'luso', darkColor: 'luso-dark', logo: 'ri-bank-fill' },
      { id: 'bnu', name: 'æ¾³é–€åœ‹éš›éŠ€è¡Œ', color: 'primary', darkColor: 'primary-dark', logo: 'ri-bank-fill' },
      { id: 'macaupass', name: 'æ¾³é–€é€š', color: 'macaupass', darkColor: 'macaupass-dark', logo: 'ri-bank-card-fill' },
      { id: 'ant', name: 'èèŸ»éŠ€è¡Œ', color: 'ant', darkColor: 'ant-dark', logo: 'ri-bank-fill' },
      { id: 'mpay', name: 'æ¾³é–€æ¥µæ˜“ä»˜', color: 'mpay', darkColor: 'mpay-dark', logo: 'ri-wallet-fill' }
    ];

    // åœ–è¡¨é¡è‰²
    const chartColors = {
      light: ['#5D5CDE', '#c1272d', '#c7000a', '#00529b', '#0c6e4f', '#2c64ae', '#e20074', '#1e469a'],
      dark: ['#7978E9', '#e04a4a', '#e03e47', '#4a8fd1', '#25a073', '#5589d4', '#fc4da0', '#4c76ca']
    };

    // ç”¨æˆ¶æª”æ¡ˆç®¡ç†
    let profiles = {
      default: {
        name: 'é»˜èªä½¿ç”¨è€…',
        created: new Date().toISOString()
      }
    };
    
    // ç•¶å‰é¸æ“‡çš„å€‹äººæª”æ¡ˆ
    let currentProfile = 'default';
    
    // å€‹äººæª”æ¡ˆç‹€æ…‹å­˜å„²
    let profileStates = {
      default: {
        vouchers: [],
        weekendSpends: [],
        currentWeek: 1,
        bankDraws: {}, // æ¯å®¶éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
        preferredBank: null,
        bankVouchers: {},
        weekRecords: [] // é€±æ¬¡è¨˜éŒ„
      }
    };
    
    // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹åºç‹€æ…‹ (æœƒæ ¹æ“šç•¶å‰é¸æ“‡çš„æª”æ¡ˆæ›´æ”¹)
    let appState = {
      vouchers: [],
      weekendSpends: [],
      currentWeek: 1,
      bankDraws: {}, // æ¯å®¶éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
      preferredBank: null,
      bankVouchers: {},
      weekRecords: [] // é€±æ¬¡è¨˜éŒ„
    };

    // åŠ è¼‰å€‹äººæª”æ¡ˆ
    function loadProfiles() {
      try {
        const savedProfiles = JSON.parse(localStorage.getItem('voucherAppProfiles'));
        if (savedProfiles) {
          profiles = savedProfiles;
        }
        
        const savedProfileStates = JSON.parse(localStorage.getItem('voucherAppProfileStates'));
        if (savedProfileStates) {
          profileStates = savedProfileStates;
        }
        
        // ç¢ºä¿é»˜èªç”¨æˆ¶å­˜åœ¨
        if (!profiles.default) {
          profiles.default = {
            name: 'é»˜èªä½¿ç”¨è€…',
            created: new Date().toISOString()
          };
        }
        
        if (!profileStates.default) {
          profileStates.default = {
            vouchers: [],
            weekendSpends: [],
            currentWeek: calculateCurrentWeek(),
            bankDraws: {},
            preferredBank: null,
            bankVouchers: {},
            weekRecords: []
          };
        }
        
        // åŠ è¼‰ä¸Šæ¬¡ä½¿ç”¨çš„å€‹äººæª”æ¡ˆ
        const lastProfile = localStorage.getItem('voucherAppCurrentProfile');
        if (lastProfile && profiles[lastProfile] && profileStates[lastProfile]) {
          currentProfile = lastProfile;
        } else {
          currentProfile = 'default';
        }
        
        // æ›´æ–°å€‹äººæª”æ¡ˆé¸æ“‡å™¨
        updateProfileSelector();
        
        // åŠ è¼‰ç•¶å‰å€‹äººæª”æ¡ˆçš„ç‹€æ…‹
        loadCurrentProfileState();
      } catch (e) {
        console.error('Failed to load profiles:', e);
      }
    }
    
    // åŠ è¼‰ç•¶å‰å€‹äººæª”æ¡ˆçš„ç‹€æ…‹
    function loadCurrentProfileState() {
      if (profileStates[currentProfile]) {
        appState = JSON.parse(JSON.stringify(profileStates[currentProfile]));
        
        // ç¢ºä¿bankDrawsçµæ§‹å­˜åœ¨
        if (!appState.bankDraws) {
          appState.bankDraws = {};
        }
        
        // ç¢ºä¿weekRecordsçµæ§‹å­˜åœ¨
        if (!appState.weekRecords) {
          appState.weekRecords = [];
        }
        
        // åˆå§‹åŒ–æ¯å®¶éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
        banks.forEach(bank => {
          if (!appState.bankDraws[bank.id]) {
            appState.bankDraws[bank.id] = {
              remaining: 3,
              used: 0
            };
          }
        });
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦è¨˜éŒ„ç•¶å‰é€±æ¬¡
        checkCurrentWeekRecord();
      }
      
      // ä¿å­˜ç•¶å‰å€‹äººæª”æ¡ˆ
      localStorage.setItem('voucherAppCurrentProfile', currentProfile);
      
      // æ›´æ–°UI
      updateUI();
    }
    
    // æ›´æ–°å€‹äººæª”æ¡ˆé¸æ“‡å™¨
    function updateProfileSelector() {
      const profileSelector = document.getElementById('profile-selector');
      profileSelector.innerHTML = '';
      
      // æ·»åŠ æ‰€æœ‰å€‹äººæª”æ¡ˆ
      Object.keys(profiles).forEach(profileId => {
        const profile = profiles[profileId];
        const option = document.createElement('option');
        option.value = profileId;
        option.textContent = profile.name;
        
        if (profileId === currentProfile) {
          option.selected = true;
        }
        
        profileSelector.appendChild(option);
      });
    }
    
    // ä¿å­˜ç•¶å‰å€‹äººæª”æ¡ˆç‹€æ…‹
    function saveCurrentProfileState() {
      profileStates[currentProfile] = JSON.parse(JSON.stringify(appState));
      
      try {
        localStorage.setItem('voucherAppProfileStates', JSON.stringify(profileStates));
        localStorage.setItem('voucherAppProfiles', JSON.stringify(profiles));
      } catch (e) {
        console.error('Failed to save profiles:', e);
      }
    }
    
    // åˆ‡æ›å€‹äººæª”æ¡ˆ
    function switchProfile(profileId) {
      if (profiles[profileId]) {
        // å…ˆä¿å­˜ç•¶å‰å€‹äººæª”æ¡ˆçš„ç‹€æ…‹
        saveCurrentProfileState();
        
        // åˆ‡æ›å€‹äººæª”æ¡ˆ
        currentProfile = profileId;
        
        // åŠ è¼‰æ–°å€‹äººæª”æ¡ˆçš„ç‹€æ…‹
        loadCurrentProfileState();
        
        // ä¿å­˜ç•¶å‰å€‹äººæª”æ¡ˆID
        localStorage.setItem('voucherAppCurrentProfile', profileId);
      }
    }
    
    // æ·»åŠ æ–°å€‹äººæª”æ¡ˆ
    function addNewProfile(name) {
      if (!name || name.trim() === '') {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åç¨±');
        return false;
      }
      
      // ç”Ÿæˆå”¯ä¸€ID
      const profileId = 'profile_' + Date.now();
      
      // æ·»åŠ å€‹äººæª”æ¡ˆ
      profiles[profileId] = {
        name: name.trim(),
        created: new Date().toISOString()
      };
      
      // å‰µå»ºåˆå§‹ç‹€æ…‹
      profileStates[profileId] = {
        vouchers: [],
        weekendSpends: [],
        currentWeek: calculateCurrentWeek(),
        bankDraws: {},
        preferredBank: null,
        bankVouchers: {},
        weekRecords: []
      };
      
      // åˆå§‹åŒ–æ¯å®¶éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
      banks.forEach(bank => {
        profileStates[profileId].bankDraws[bank.id] = {
          remaining: 3,
          used: 0
        };
      });
      
      // ä¿å­˜æ‰€æœ‰å€‹äººæª”æ¡ˆ
      localStorage.setItem('voucherAppProfiles', JSON.stringify(profiles));
      localStorage.setItem('voucherAppProfileStates', JSON.stringify(profileStates));
      
      // æ›´æ–°å€‹äººæª”æ¡ˆé¸æ“‡å™¨
      updateProfileSelector();
      
      return profileId;
    }
    
    // åˆªé™¤å€‹äººæª”æ¡ˆ
    function deleteProfile(profileId) {
      if (profileId === 'default') {
        alert('ç„¡æ³•åˆªé™¤é»˜èªä½¿ç”¨è€…');
        return false;
      }
      
      if (!profiles[profileId]) {
        return false;
      }
      
      // åˆªé™¤å€‹äººæª”æ¡ˆ
      delete profiles[profileId];
      delete profileStates[profileId];
      
      // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰å€‹äººæª”æ¡ˆï¼Œåˆ‡æ›åˆ°é»˜èªå€‹äººæª”æ¡ˆ
      if (profileId === currentProfile) {
        currentProfile = 'default';
        loadCurrentProfileState();
      }
      
      // ä¿å­˜æ‰€æœ‰å€‹äººæª”æ¡ˆ
      localStorage.setItem('voucherAppProfiles', JSON.stringify(profiles));
      localStorage.setItem('voucherAppProfileStates', JSON.stringify(profileStates));
      
      // æ›´æ–°å€‹äººæª”æ¡ˆé¸æ“‡å™¨
      updateProfileSelector();
      
      return true;
    }
    
    // æ›´æ–°å€‹äººæª”æ¡ˆåç¨±
    function updateProfileName(profileId, newName) {
      if (!profiles[profileId]) {
        return false;
      }
      
      if (!newName || newName.trim() === '') {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åç¨±');
        return false;
      }
      
      // æ›´æ–°åç¨±
      profiles[profileId].name = newName.trim();
      
      // ä¿å­˜æ‰€æœ‰å€‹äººæª”æ¡ˆ
      localStorage.setItem('voucherAppProfiles', JSON.stringify(profiles));
      
      // æ›´æ–°å€‹äººæª”æ¡ˆé¸æ“‡å™¨
      updateProfileSelector();
      
      return true;
    }
    
    // åˆå§‹åŒ–å€‹äººæª”æ¡ˆç•Œé¢
    function initProfilesUI() {
      const profileSelector = document.getElementById('profile-selector');
      const manageProfilesBtn = document.getElementById('manage-profiles-btn');
      const addProfileBtn = document.getElementById('add-profile-btn');
      
      // åˆ‡æ›å€‹äººæª”æ¡ˆ
      profileSelector.addEventListener('change', function() {
        const selectedProfile = this.value;
        switchProfile(selectedProfile);
      });
      
      // ç®¡ç†å€‹äººæª”æ¡ˆæŒ‰éˆ•
      manageProfilesBtn.addEventListener('click', function() {
        // åˆ‡æ›åˆ°å€‹äººæª”æ¡ˆç®¡ç†é é¢
        document.querySelectorAll('#tabs button').forEach(button => {
          if (button.getAttribute('data-tab') === 'profiles') {
            button.click();
          }
        });
      });
      
      // æ·»åŠ æ–°å€‹äººæª”æ¡ˆæŒ‰éˆ•
      addProfileBtn.addEventListener('click', function() {
        const name = prompt('è«‹è¼¸å…¥æ–°å®¶åº­æˆå“¡çš„åç¨±:');
        if (name) {
          const newProfileId = addNewProfile(name);
          if (newProfileId) {
            updateProfilesList();
          }
        }
      });
      
      // åˆå§‹åŒ–å€‹äººæª”æ¡ˆåˆ—è¡¨
      updateProfilesList();
    }
    
    // æ›´æ–°å€‹äººæª”æ¡ˆåˆ—è¡¨
    function updateProfilesList() {
      const profilesList = document.getElementById('profiles-list');
      profilesList.innerHTML = '';
      
      Object.keys(profiles).forEach(profileId => {
        const profile = profiles[profileId];
        const profileCard = document.createElement('div');
        
        // è¨­ç½®å¡ç‰‡æ¨£å¼
        const isCurrentProfile = (profileId === currentProfile);
        
        profileCard.className = `border rounded-lg p-3 ${isCurrentProfile ? 'bg-primary-100 dark:bg-primary-900 border-primary' : 'bg-white dark:bg-gray-800'}`;
        
        // è¨ˆç®—è©²å€‹äººæª”æ¡ˆçš„å„ªæƒ åˆ¸æ•¸é‡å’Œç¸½å€¼
        let voucherCount = 0;
        let voucherValue = 0;
        let unusedCount = 0;
        
        if (profileStates[profileId]?.vouchers) {
          voucherCount = profileStates[profileId].vouchers.length;
          profileStates[profileId].vouchers.forEach(v => {
            voucherValue += v.amount;
            if (!v.used) unusedCount++;
          });
        }
        
        profileCard.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-bold text-lg flex items-center">
                ${profile.name}
                ${isCurrentProfile ? '<span class="ml-2 text-xs bg-primary text-white px-2 py-0.5 rounded">ç•¶å‰ä½¿ç”¨</span>' : ''}
              </div>
              <div class="text-sm text-gray-500 dark:text-gray-400">
                å‰µå»ºæ—¥æœŸ: ${new Date(profile.created).toLocaleDateString()}
              </div>
            </div>
            <div class="text-right">
              <div class="text-sm">ç¸½å„ªæƒ åˆ¸: ${voucherCount}å¼µ</div>
              <div class="text-sm">æœªä½¿ç”¨: ${unusedCount}å¼µ</div>
              <div class="text-sm">ç¸½åƒ¹å€¼: ${voucherValue}å…ƒ</div>
            </div>
          </div>
          <div class="mt-3 flex justify-end space-x-2">
            ${profileId !== 'default' ? `
              <button class="delete-profile-btn text-sm text-red-500 dark:text-red-400 hover:underline" data-profile-id="${profileId}">
                åˆªé™¤
              </button>
            ` : ''}
            <button class="edit-profile-btn text-sm text-primary dark:text-primary hover:underline" data-profile-id="${profileId}">
              é‡å‘½å
            </button>
            ${!isCurrentProfile ? `
              <button class="switch-profile-btn text-sm bg-primary text-white px-2 py-1 rounded hover:bg-primary-dark" data-profile-id="${profileId}">
                åˆ‡æ›åˆ°æ­¤æª”æ¡ˆ
              </button>
            ` : ''}
          </div>
        `;
        
        profilesList.appendChild(profileCard);
      });
      
      // æ·»åŠ äº‹ä»¶ç›£è½å™¨
      document.querySelectorAll('.delete-profile-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const profileId = this.getAttribute('data-profile-id');
          if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${profiles[profileId].name} çš„æª”æ¡ˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼`)) {
            deleteProfile(profileId);
            updateProfilesList();
          }
        });
      });
      
      document.querySelectorAll('.edit-profile-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const profileId = this.getAttribute('data-profile-id');
          const newName = prompt('è«‹è¼¸å…¥æ–°åç¨±:', profiles[profileId].name);
          if (newName) {
            updateProfileName(profileId, newName);
            updateProfilesList();
          }
        });
      });
      
      document.querySelectorAll('.switch-profile-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const profileId = this.getAttribute('data-profile-id');
          switchProfile(profileId);
          updateProfilesList();
        });
      });
    }
    
    // å˜—è©¦å¾localStorageåŠ è¼‰æ•¸æ“š (å‘å¾Œå…¼å®¹èˆŠç‰ˆæœ¬)
    function loadLegacyAppState() {
      try {
        const savedState = JSON.parse(localStorage.getItem('voucherAppState'));
        if (savedState && !profileStates.default.vouchers.length) {
          // å°‡èˆŠæ•¸æ“šé·ç§»åˆ°é»˜èªå€‹äººæª”æ¡ˆ
          profileStates.default = savedState;
          saveCurrentProfileState();
          
          // åˆªé™¤èˆŠæ•¸æ“š
          localStorage.removeItem('voucherAppState');
        }
      } catch (e) {
        console.error('Failed to load legacy app state');
      }
    }

    // ä¿å­˜æ‡‰ç”¨ç¨‹åºç‹€æ…‹åˆ°localStorage (å³ä¿å­˜ç•¶å‰å€‹äººæª”æ¡ˆç‹€æ…‹)
    function saveAppState() {
      saveCurrentProfileState();
    }

    // è¨ˆç®—ç•¶å‰é€±æ¬¡
    function calculateCurrentWeek() {
      const today = new Date();
      const dateString = today.toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼
      
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (dateString >= week.startDate && dateString <= week.endDate) {
          return i + 1;
        }
      }
      
      // å¦‚æœç•¶å‰æ—¥æœŸä¸åœ¨ä»»ä½•é€±æ¬¡ç¯„åœå…§
      if (dateString < weekSchedule[0].startDate) {
        return 0; // æ´»å‹•å°šæœªé–‹å§‹
      } else if (dateString > weekSchedule[weekSchedule.length - 1].endDate) {
        return 11; // æ´»å‹•å·²çµæŸ
      }
      
      // æª¢æŸ¥æ˜¯å¦åœ¨é€±æœ«
      for (let i = 0; i < weekSchedule.length - 1; i++) {
        if (dateString > weekSchedule[i].endDate && dateString < weekSchedule[i + 1].startDate) {
          return i + 1; // è¿”å›ç•¶å‰çš„é€±æœ«æ‰€å±¬çš„é€±æ¬¡
        }
      }
      
      return 1; // é»˜èªè¿”å›ç¬¬ä¸€é€±
    }

    // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    }

    // é¡¯ç¤ºä»Šå¤©æ—¥æœŸ
    function updateCurrentDateDisplay() {
      const currentDateElem = document.getElementById('current-date');
      const today = new Date();
      currentDateElem.textContent = formatDate(today.toISOString().split('T')[0]);
    }

    // æª¢æŸ¥æ˜¯å¦éœ€è¦è¨˜éŒ„ç•¶å‰é€±æ¬¡
    function checkCurrentWeekRecord() {
      const currentWeek = calculateCurrentWeek();
      if (currentWeek < 1 || currentWeek > 10) return; // è¶…å‡ºæ´»å‹•ç¯„åœ
      
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç•¶å‰é€±æ¬¡çš„è¨˜éŒ„
      const hasCurrentWeekRecord = appState.weekRecords.some(record => record.weekNum === currentWeek);
      
      if (!hasCurrentWeekRecord) {
        // å¯ä»¥åœ¨é€™è£¡è‡ªå‹•æ·»åŠ ç•¶å‰é€±æ¬¡çš„è¨˜éŒ„
        // æˆ–è€…ç­‰å¾…ç”¨æˆ¶æ‰‹å‹•æ·»åŠ 
      }
    }

    // å‰µå»ºé€±æ¬¡è¨˜éŒ„
    function createWeekRecord(weekNum, notes = '') {
      const weekData = weekSchedule[weekNum - 1];
      
      if (!weekData) return null;
      
      // ç²å–è©²é€±çš„å„ªæƒ åˆ¸
      const weekVouchers = appState.vouchers.filter(voucher => {
        const voucherWeek = getWeekNumberFromDate(voucher.date);
        return voucherWeek === weekNum;
      });
      
      // è¨ˆç®—å„é¢å€¼å„ªæƒ åˆ¸æ•¸é‡
      const valueCounts = [0, 0, 0, 0, 0, 0]; // 0(ç¬‘å“ˆå“ˆ), 10, 20, 50, 100, 200
      let totalValue = 0;
      weekVouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // ç¬‘å“ˆå“ˆ
          case 10: valueCounts[1]++; totalValue += 10; break;
          case 20: valueCounts[2]++; totalValue += 20; break;
          case 50: valueCounts[3]++; totalValue += 50; break;
          case 100: valueCounts[4]++; totalValue += 100; break;
          case 200: valueCounts[5]++; totalValue += 200; break;
        }
      });
      
      // è¨ˆç®—å„éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡
      const bankCounts = {};
      banks.forEach(bank => {
        bankCounts[bank.id] = {
          count: 0,
          value: 0
        };
      });
      
      weekVouchers.forEach(voucher => {
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId].count++;
          bankCounts[voucher.bankId].value += voucher.amount;
        }
      });
      
      // ç²å–è©²é€±çš„é€±æœ«æ¶ˆè²»
      const weekendSpends = appState.weekendSpends.filter(spend => {
        const spendWeek = getWeekNumberFromDate(spend.date);
        return spendWeek === weekNum;
      });
      
      // å‰µå»ºé€±æ¬¡è¨˜éŒ„
      const weekRecord = {
        id: Date.now().toString(),
        weekNum: weekNum,
        startDate: weekData.startDate,
        endDate: weekData.endDate,
        createdAt: new Date().toISOString(),
        notes: notes,
        voucherCount: weekVouchers.length,
        voucherValue: totalValue,
        valueCounts: valueCounts,
        bankCounts: bankCounts,
        usedCount: weekVouchers.filter(v => v.used).length,
        weekendSpendsCount: weekendSpends.length,
        bankDraws: JSON.parse(JSON.stringify(appState.bankDraws)) // æ·±æ‹·è²ç•¶å‰éŠ€è¡ŒæŠ½çç‹€æ…‹
      };
      
      return weekRecord;
    }

    // æ·»åŠ é€±æ¬¡è¨˜éŒ„
    function addWeekRecord(weekNum, notes = '') {
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è©²é€±æ¬¡çš„è¨˜éŒ„
      const existingRecord = appState.weekRecords.find(record => record.weekNum === weekNum);
      if (existingRecord) {
        const overwrite = confirm(`å·²å­˜åœ¨ç¬¬${weekNum}é€±çš„è¨˜éŒ„ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`);
        if (!overwrite) return false;
        
        // ç§»é™¤ç¾æœ‰è¨˜éŒ„
        appState.weekRecords = appState.weekRecords.filter(record => record.weekNum !== weekNum);
      }
      
      // å‰µå»ºæ–°è¨˜éŒ„
      const newRecord = createWeekRecord(weekNum, notes);
      if (!newRecord) return false;
      
      // æ·»åŠ åˆ°è¨˜éŒ„åˆ—è¡¨
      appState.weekRecords.push(newRecord);
      
      // æŒ‰é€±æ¬¡æ’åº
      appState.weekRecords.sort((a, b) => b.weekNum - a.weekNum);
      
      // ä¿å­˜ç‹€æ…‹
      saveAppState();
      
      return true;
    }

    // æ›´æ–°é€±æœŸæ™‚é–“è¡¨
    function updateWeekSchedule() {
      const tableBody = document.getElementById('week-schedule');
      tableBody.innerHTML = '';
      
      weekSchedule.forEach(week => {
        const row = document.createElement('tr');
        row.className = 'border-b dark:border-gray-700';
        
        const weekCell = document.createElement('td');
        weekCell.className = 'py-2';
        weekCell.textContent = `ç¬¬${week.week}é€±`;
        
        const timeCell = document.createElement('td');
        timeCell.className = 'py-2';
        timeCell.textContent = `${formatDate(week.startDate)} - ${formatDate(week.endDate)}`;
        
        const resetCell = document.createElement('td');
        resetCell.className = 'py-2';
        resetCell.textContent = formatDate(week.resetDate);
        
        row.appendChild(weekCell);
        row.appendChild(timeCell);
        row.appendChild(resetCell);
        
        tableBody.appendChild(row);
      });
    }

    // æ›´æ–°ç•¶å‰é€±æ¬¡é¡¯ç¤º
    function updateCurrentWeekDisplay() {
      const currentWeekElem = document.getElementById('current-week');
      const weekNum = calculateCurrentWeek();
      appState.currentWeek = weekNum;
      
      if (weekNum === 0) {
        currentWeekElem.textContent = 'æ´»å‹•å°šæœªé–‹å§‹';
      } else if (weekNum > 10) {
        currentWeekElem.textContent = 'æ´»å‹•å·²çµæŸ';
      } else {
        const weekData = weekSchedule[weekNum - 1];
        currentWeekElem.textContent = `ç¬¬${weekNum}é€± (${formatDate(weekData.startDate)} - ${formatDate(weekData.endDate)})`;
      }
    }

    // æ›´æ–°éŠ€è¡ŒæŒ‰éˆ•é¡¯ç¤º
    function updateBankButtons() {
      const bankButtonsContainer = document.getElementById('bank-buttons');
      bankButtonsContainer.innerHTML = '';
      
      banks.forEach(bank => {
        const bankButton = document.createElement('div');
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºé¸ä¸­çš„éŠ€è¡Œ
        const isSelected = appState.preferredBank === bank.id;
        
        bankButton.className = `p-2 rounded-lg cursor-pointer flex flex-col items-center transition-colors ${
          isSelected ? 
          `bg-${bank.color} text-white` : 
          `bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700`
        }`;
        bankButton.setAttribute('data-bank-id', bank.id);
        
        // ç²å–è©²éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
        const bankDraws = appState.bankDraws[bank.id] || { remaining: 3, used: 0 };
        
        // è¨­ç½®æŒ‰éˆ•å…§å®¹
        bankButton.innerHTML = `
          <i class="${bank.logo} text-2xl ${isSelected ? 'text-white' : `text-${bank.color} dark:text-${bank.color}`}"></i>
          <div class="text-xs mt-1 ${isSelected ? 'text-white' : ''}">${bank.name}</div>
          <div class="text-xs ${isSelected ? 'text-white' : 'text-gray-500 dark:text-gray-400'}">${bankDraws.remaining}/3</div>
        `;
        
        // æ·»åŠ é»æ“Šäº‹ä»¶
        bankButton.addEventListener('click', () => {
          selectBank(bank.id);
        });
        
        bankButtonsContainer.appendChild(bankButton);
      });
    }

    // é¸æ“‡éŠ€è¡Œ
    function selectBank(bankId) {
      appState.preferredBank = bankId;
      
      // æ›´æ–°UI
      updateBankButtons();
      updateQuickAddPanel();
      
      // ä¿å­˜ç‹€æ…‹
      saveAppState();
    }

    // æ›´æ–°å¿«é€Ÿæ·»åŠ é¢æ¿
    function updateQuickAddPanel() {
      const quickAddContainer = document.getElementById('quick-add-container');
      const selectedBankNameDisplay = document.getElementById('selected-bank-name-display');
      const remainingDrawsDisplay = document.getElementById('remaining-draws');
      
      if (appState.preferredBank) {
        // é¡¯ç¤ºå¿«é€Ÿæ·»åŠ é¢æ¿
        quickAddContainer.classList.remove('hidden');
        
        // ç²å–éŠ€è¡Œä¿¡æ¯
        const bank = banks.find(b => b.id === appState.preferredBank);
        selectedBankNameDisplay.textContent = bank ? bank.name : 'éŠ€è¡Œ';
        
        // ç²å–å‰©é¤˜æŠ½çæ¬¡æ•¸
        const bankDraws = appState.bankDraws[appState.preferredBank];
        remainingDrawsDisplay.textContent = bankDraws ? bankDraws.remaining : 3;
      } else {
        // éš±è—å¿«é€Ÿæ·»åŠ é¢æ¿
        quickAddContainer.classList.add('hidden');
      }
    }

    // æ›´æ–°éŠ€è¡Œç¸½å€¼çµ±è¨ˆ
    function updateBankTotals() {
      const bankTotalsList = document.getElementById('bank-totals-list');
      bankTotalsList.innerHTML = '';
      
      // è¨ˆç®—å„éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡å’Œç¸½å€¼
      const bankTotals = {};
      
      // åˆå§‹åŒ–æ¯å€‹éŠ€è¡Œçš„è¨ˆæ•¸
      banks.forEach(bank => {
        bankTotals[bank.id] = {
          count: 0,
          value: 0
        };
      });
      
      // è¨ˆç®—æ¯å€‹éŠ€è¡Œçš„å„ªæƒ åˆ¸ç¸½æ•¸å’Œç¸½å€¼
      appState.vouchers.forEach(voucher => {
        if (voucher.bankId && bankTotals[voucher.bankId]) {
          bankTotals[voucher.bankId].count++;
          bankTotals[voucher.bankId].value += voucher.amount;
        }
      });
      
      // æŒ‰ç¸½å€¼å¾é«˜åˆ°ä½æ’åºéŠ€è¡Œ
      const sortedBanks = banks
        .filter(bank => bankTotals[bank.id].count > 0)
        .sort((a, b) => bankTotals[b.id].value - bankTotals[a.id].value);
      
      // å‰µå»ºéŠ€è¡Œå„ªæƒ åˆ¸ç¸½å€¼é¡¯ç¤º
      if (sortedBanks.length === 0) {
        bankTotalsList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šæœªæ·»åŠ ä»»ä½•å„ªæƒ åˆ¸</div>';
        return;
      }
      
      // è¨ˆç®—ç¸½å„ªæƒ åˆ¸æ•¸é‡å’Œç¸½å€¼
      let totalCount = 0;
      let totalValue = 0;
      Object.values(bankTotals).forEach(data => {
        totalCount += data.count;
        totalValue += data.value;
      });
      
      // æ·»åŠ ç¸½è¨ˆè¡Œ
      const totalRow = document.createElement('div');
      totalRow.className = 'flex justify-between items-center p-2 border-b dark:border-gray-700 font-bold';
      totalRow.innerHTML = `
        <div>ç¸½è¨ˆ</div>
        <div>${totalCount}å¼µ (${totalValue}å…ƒ)</div>
      `;
      bankTotalsList.appendChild(totalRow);
      
      // æ·»åŠ å„éŠ€è¡Œçš„çµ±è¨ˆæ•¸æ“š
      sortedBanks.forEach(bank => {
        const data = bankTotals[bank.id];
        const bankRow = document.createElement('div');
        bankRow.className = 'flex justify-between items-center p-2 border-b dark:border-gray-700 last:border-0';
        
        bankRow.innerHTML = `
          <div class="flex items-center">
            <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
            <span>${bank.name}</span>
          </div>
          <div>${data.count}å¼µ (${data.value}å…ƒ)</div>
        `;
        
        bankTotalsList.appendChild(bankRow);
      });
    }

    // æ›´æ–°å„ªæƒ åˆ¸åˆ—è¡¨
    function updateVoucherList() {
      const voucherList = document.getElementById('voucher-list');
      const unusedVouchersElem = document.getElementById('unused-vouchers');
      
      voucherList.innerHTML = '';
      
      // é¸æ“‡ç•¶å‰é€±æ¬¡çš„å„ªæƒ åˆ¸
      const selectedWeek = appState.currentWeek;
      const weekVouchers = appState.vouchers.filter(voucher => {
        return getWeekNumberFromDate(voucher.date) === selectedWeek;
      });
      
      // æœªä½¿ç”¨å„ªæƒ åˆ¸é¡¯ç¤º
      const unusedVouchers = appState.vouchers.filter(v => !v.used);
      unusedVouchersElem.textContent = unusedVouchers.length;
      
      // æ›´æ–°éŠ€è¡Œç¸½å€¼çµ±è¨ˆ
      updateBankTotals();
      
      if (weekVouchers.length === 0) {
        voucherList.innerHTML = `
          <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            è©²é€±æ¬¡æš«ç„¡å„ªæƒ åˆ¸è¨˜éŒ„<br>é»æ“Šä¸Šæ–¹éŠ€è¡Œå’Œé¢å€¼æ·»åŠ 
          </div>
        `;
        return;
      }
      
      // æŒ‰ç…§éŠ€è¡Œåˆ†çµ„é¡¯ç¤º
      const vouchersByBank = {};
      weekVouchers.forEach(voucher => {
        if (!vouchersByBank[voucher.bankId]) {
          vouchersByBank[voucher.bankId] = [];
        }
        vouchersByBank[voucher.bankId].push(voucher);
      });
      
      // æ·»åŠ éŠ€è¡Œåˆ†çµ„æ¨™é¡Œ
      Object.keys(vouchersByBank).forEach(bankId => {
        const bank = banks.find(b => b.id === bankId);
        
        // æ·»åŠ éŠ€è¡Œæ¨™é¡Œ
        const bankHeader = document.createElement('div');
        bankHeader.className = `text-sm font-bold mt-4 mb-2 flex items-center text-${bank.color} dark:text-${bank.color}`;
        bankHeader.innerHTML = `
          <i class="${bank.logo} mr-1"></i>
          <span>${bank.name}å„ªæƒ åˆ¸</span>
        `;
        voucherList.appendChild(bankHeader);
        
        // æ·»åŠ è©²éŠ€è¡Œçš„å„ªæƒ åˆ¸
        vouchersByBank[bankId].forEach(voucher => {
          const voucherCard = document.createElement('div');
          voucherCard.className = `border rounded-lg overflow-hidden ${voucher.used ? 'bg-gray-100 dark:bg-gray-800 opacity-60' : 'bg-white dark:bg-gray-800'}`;
          
          // è¨­ç½®å„ªæƒ åˆ¸é¡è‰²å’Œé¡¯ç¤ºæ–‡å­—
          let colorClass = 'bg-blue-100 dark:bg-blue-900';
          let displayText = `${voucher.amount}å…ƒ`;
          
          // ç‰¹åˆ¥è™•ç†"ç¬‘å“ˆå“ˆ"å„ªæƒ åˆ¸
          if (voucher.amount === 0) {
            colorClass = 'bg-yellow-100 dark:bg-yellow-900';
            displayText = 'ğŸ˜„';
          } else if (voucher.amount >= 100) {
            colorClass = 'bg-purple-100 dark:bg-purple-900';
          } else if (voucher.amount >= 50) {
            colorClass = 'bg-green-100 dark:bg-green-900';
          }
          
          // éæœŸè™•ç†
          const expired = isVoucherExpired(voucher);
          if (expired && !voucher.used) {
            colorClass = 'bg-gray-100 dark:bg-gray-700';
          }
          
          voucherCard.innerHTML = `
            <div class="flex">
              <div class="${colorClass} p-4 flex items-center justify-center w-24">
                <div class="text-center">
                  <div class="text-2xl font-bold">${displayText}</div>
                  ${voucher.amount > 0 ? '<div class="text-xs">æ¾³é–€å…ƒ</div>' : ''}
                </div>
              </div>
              <div class="flex-1 p-3">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">ç²å¾—æ—¥æœŸ</div>
                    <div>${formatDate(voucher.date)}</div>
                  </div>
                  <div>
                    ${voucher.used ? 
                      '<span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">å·²ä½¿ç”¨</span>' : 
                      expired ?
                      '<span class="text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-1 rounded">å·²éæœŸ</span>' :
                      '<span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">æœªä½¿ç”¨</span>'
                    }
                  </div>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                  ${expired ? 'å·²éæœŸ' : `ä½¿ç”¨æœŸé™: ${getWeekendDateRange(voucher.date)}`}
                </div>
              </div>
            </div>
            <div class="border-t px-3 py-2 flex justify-between">
              ${voucher.used || expired ? 
                '<button class="text-sm text-gray-400 dark:text-gray-500 cursor-not-allowed" disabled>æ¨™è¨˜ç‚ºå·²ä½¿ç”¨</button>' : 
                '<button class="text-sm text-primary dark:text-primary hover:underline use-voucher-btn" data-id="' + voucher.id + '">æ¨™è¨˜ç‚ºå·²ä½¿ç”¨</button>'
              }
              <button class="text-sm text-red-500 dark:text-red-400 hover:underline delete-voucher-btn" data-id="${voucher.id}">åˆªé™¤</button>
            </div>
          `;
          
          voucherList.appendChild(voucherCard);
        });
      });
      
      // æ·»åŠ ä½¿ç”¨å„ªæƒ åˆ¸åŠŸèƒ½
      document.querySelectorAll('.use-voucher-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const voucherId = this.getAttribute('data-id');
          markVoucherAsUsed(voucherId);
        });
      });
      
      // æ·»åŠ åˆªé™¤å„ªæƒ åˆ¸åŠŸèƒ½
      document.querySelectorAll('.delete-voucher-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const voucherId = this.getAttribute('data-id');
          showDeleteConfirmation(voucherId);
        });
      });
    }

    // æ›´æ–°é€±æ¬¡è¨˜éŒ„é¡¯ç¤º
    function updateWeekRecords() {
      const weekRecordsList = document.getElementById('week-records-list');
      
      // æ¸…ç©ºç¾æœ‰å…§å®¹
      weekRecordsList.innerHTML = '';
      
      if (appState.weekRecords.length === 0) {
        weekRecordsList.innerHTML = `
          <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            å°šç„¡é€±æ¬¡è¨˜éŒ„
          </div>
        `;
        return;
      }
      
      // æŒ‰é€±æ¬¡æ’åº
      const sortedRecords = [...appState.weekRecords].sort((a, b) => b.weekNum - a.weekNum);
      
      sortedRecords.forEach(record => {
        const recordItem = document.createElement('div');
        recordItem.className = 'border rounded-lg bg-white dark:bg-gray-800 overflow-hidden';
        
        // è¨ˆç®—ç¸½å€¼å’Œå„å€‹éŠ€è¡Œçš„å„ªæƒ åˆ¸æ•¸é‡
        let bankList = '';
        let bankCount = 0;
        
        banks.forEach(bank => {
          const bankData = record.bankCounts?.[bank.id];
          if (bankData && bankData.count > 0) {
            bankCount++;
            bankList += `
              <div class="flex items-center mb-1 text-xs">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                <span>${bank.name}: ${bankData.count}å¼µ (${bankData.value}å…ƒ)</span>
              </div>
            `;
          }
        });
        
        // å‰µå»ºè¨˜éŒ„å¡ç‰‡
        recordItem.innerHTML = `
          <div class="px-4 py-3">
            <div class="flex justify-between items-start mb-2">
              <div class="font-bold text-lg">ç¬¬${record.weekNum}é€±è¨˜éŒ„</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">ç¸½å„ªæƒ åˆ¸</div>
                <div class="font-bold text-lg">${record.voucherCount}å¼µ</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">ç¸½åƒ¹å€¼</div>
                <div class="font-bold text-lg">${record.voucherValue}å…ƒ</div>
              </div>
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">å„ªæƒ åˆ¸åˆ†ä½ˆï¼š</div>
            <div class="text-sm mb-2">
              ${record.valueCounts[0] > 0 ? `<span class="mr-2">ğŸ˜„: ${record.valueCounts[0]}å¼µ</span>` : ''}
              ${record.valueCounts[1] > 0 ? `<span class="mr-2">10å…ƒ: ${record.valueCounts[1]}å¼µ</span>` : ''}
              ${record.valueCounts[2] > 0 ? `<span class="mr-2">20å…ƒ: ${record.valueCounts[2]}å¼µ</span>` : ''}
              ${record.valueCounts[3] > 0 ? `<span class="mr-2">50å…ƒ: ${record.valueCounts[3]}å¼µ</span>` : ''}
              ${record.valueCounts[4] > 0 ? `<span class="mr-2">100å…ƒ: ${record.valueCounts[4]}å¼µ</span>` : ''}
              ${record.valueCounts[5] > 0 ? `<span class="mr-2">200å…ƒ: ${record.valueCounts[5]}å¼µ</span>` : ''}
            </div>
            ${bankCount > 0 ? `
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">éŠ€è¡Œåˆ†ä½ˆï¼š</div>
              <div class="mb-2">
                ${bankList}
              </div>
            ` : ''}
            ${record.notes ? `
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">å‚™è¨»ï¼š</div>
              <div class="text-sm mb-2">${record.notes}</div>
            ` : ''}
          </div>
          <div class="border-t px-3 py-2 flex justify-end">
            <button class="text-sm text-primary dark:text-primary hover:underline view-week-detail-btn" data-id="${record.id}">æŸ¥çœ‹è©³æƒ…</button>
          </div>
        `;
        
        weekRecordsList.appendChild(recordItem);
      });
      
      // æ·»åŠ æŸ¥çœ‹è©³æƒ…åŠŸèƒ½
      document.querySelectorAll('.view-week-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          showWeekDetail(recordId);
        });
      });
    }

    // é¡¯ç¤ºé€±æ¬¡è©³æƒ…
    function showWeekDetail(recordId) {
      const record = appState.weekRecords.find(r => r.id === recordId);
      if (!record) return;
      
      const weekDetailModal = document.getElementById('week-detail-modal');
      const weekDetailTitle = document.getElementById('week-detail-title');
      const weekDetailContent = document.getElementById('week-detail-content');
      const closeDetailBtn = document.getElementById('close-detail-btn');
      const closeWeekDetail = document.getElementById('close-week-detail');
      
      // è¨­ç½®æ¨™é¡Œ
      weekDetailTitle.textContent = `ç¬¬${record.weekNum}é€±è©³ç´°è¨˜éŒ„`;
      
      // è¨ˆç®—å·²ä½¿ç”¨å’Œæœªä½¿ç”¨å„ªæƒ åˆ¸
      const usedPercentage = record.voucherCount > 0 ? Math.round((record.usedCount / record.voucherCount) * 100) : 0;
      
      // ç”Ÿæˆå„éŠ€è¡ŒæŠ½çç‹€æ…‹
      let bankDrawsHtml = '';
      banks.forEach(bank => {
        const bankDraw = record.bankDraws?.[bank.id];
        if (bankDraw) {
          bankDrawsHtml += `
            <div class="flex items-center justify-between py-1">
              <div class="flex items-center">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                <span>${bank.name}</span>
              </div>
              <div>
                å·²ç”¨ ${bankDraw.used}/3 æ¬¡
              </div>
            </div>
          `;
        }
      });
      
      // è¨­ç½®å…§å®¹
      weekDetailContent.innerHTML = `
        <div class="space-y-4">
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">è¨˜éŒ„æ™‚é–“</div>
            <div>${new Date(record.createdAt).toLocaleString()}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">é€±æœŸç¯„åœ</div>
            <div>${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„ªæƒ åˆ¸ä½¿ç”¨æƒ…æ³</div>
            <div class="flex justify-between mb-1">
              <div>ç¸½æ•¸: ${record.voucherCount}å¼µ</div>
              <div>ç¸½å€¼: ${record.voucherValue}å…ƒ</div>
            </div>
            <div class="flex justify-between mb-1">
              <div>å·²ä½¿ç”¨: ${record.usedCount}å¼µ</div>
              <div>æœªä½¿ç”¨: ${record.voucherCount - record.usedCount}å¼µ</div>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
              <div class="bg-primary h-2.5 rounded-full" style="width: ${usedPercentage}%"></div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆ</div>
            <div class="grid grid-cols-6 gap-2 mb-2">
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[0] || 0}</div>
                <div class="text-xs">ğŸ˜„</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[1] || 0}</div>
                <div class="text-xs">10å…ƒ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[2] || 0}</div>
                <div class="text-xs">20å…ƒ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[3] || 0}</div>
                <div class="text-xs">50å…ƒ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[4] || 0}</div>
                <div class="text-xs">100å…ƒ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[5] || 0}</div>
                <div class="text-xs">200å…ƒ</div>
              </div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„éŠ€è¡Œå„ªæƒ åˆ¸</div>
            <div class="space-y-1">
              ${banks.map(bank => {
                const bankData = record.bankCounts?.[bank.id];
                return bankData && bankData.count > 0 ? `
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                      <span>${bank.name}</span>
                    </div>
                    <div>${bankData.count}å¼µ (${bankData.value}å…ƒ)</div>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">éŠ€è¡ŒæŠ½çç‹€æ…‹</div>
            <div class="space-y-1 border rounded-lg p-2">
              ${bankDrawsHtml}
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">é€±æœ«æ¶ˆè²»è¨˜éŒ„</div>
            <div>${record.weekendSpendsCount}ç­†</div>
          </div>
          
          ${record.notes ? `
            <div>
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å‚™è¨»</div>
              <div class="border rounded-lg p-2">${record.notes}</div>
            </div>
          ` : ''}
        </div>
      `;
      
      // é¡¯ç¤ºæ¨¡æ…‹æ¡†
      weekDetailModal.classList.remove('hidden');
      
      // é—œé–‰æŒ‰éˆ•
      closeDetailBtn.addEventListener('click', () => {
        weekDetailModal.classList.add('hidden');
      });
      
      closeWeekDetail.addEventListener('click', () => {
        weekDetailModal.classList.add('hidden');
      });
    }

    // ç²å–ç•¶å‰é€±æ¬¡çš„å„ªæƒ åˆ¸
    function getVouchersForCurrentWeek() {
      return appState.vouchers.filter(voucher => {
        return getWeekNumberFromDate(voucher.date) === appState.currentWeek;
      });
    }

    // æ ¹æ“šæ—¥æœŸç²å–é€±æ¬¡
    function getWeekNumberFromDate(dateString) {
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (dateString >= week.startDate && dateString <= week.endDate) {
          return i + 1;
        }
      }
      return 1; // é»˜èªè¿”å›ç¬¬ä¸€é€±
    }

    // ç²å–å°æ‡‰é€±æœ«çš„æ—¥æœŸç¯„åœ
    function getWeekendDateRange(weekdayDate) {
      // æ‰¾åˆ°å°æ‡‰çš„é€±æ¬¡
      let weekNum = -1;
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (weekdayDate >= week.startDate && weekdayDate <= week.endDate) {
          weekNum = i;
          break;
        }
      }
      
      if (weekNum >= 0) {
        const saturday = weekSchedule[weekNum].resetDate;
        
        // è¨ˆç®—é€±æ—¥ (Saturday + 1 day)
        const saturdayDate = new Date(saturday);
        const sundayDate = new Date(saturdayDate);
        sundayDate.setDate(saturdayDate.getDate() + 1);
        const sunday = sundayDate.toISOString().split('T')[0];
        
        return `${formatDate(saturday)} - ${formatDate(sunday)}`;
      }
      
      return 'æœªçŸ¥';
    }

    // åˆ¤æ–·å„ªæƒ åˆ¸æ˜¯å¦éæœŸ
    function isVoucherExpired(voucher) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // æ‰¾åˆ°å°æ‡‰çš„é€±æ¬¡
      let weekNum = -1;
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (voucher.date >= week.startDate && voucher.date <= week.endDate) {
          weekNum = i;
          break;
        }
      }
      
      if (weekNum >= 0) {
        const saturday = new Date(weekSchedule[weekNum].resetDate);
        
        // è¨ˆç®—é€±æ—¥ (Saturday + 1 day)
        const sunday = new Date(saturday);
        sunday.setDate(saturday.getDate() + 1);
        sunday.setHours(23, 59, 59, 999); // è¨­ç½®ç‚ºé€±æ—¥çš„æœ€å¾Œä¸€åˆ»
        
        return today > sunday;
      }
      
      return false;
    }

    // æ¨™è¨˜å„ªæƒ åˆ¸ç‚ºå·²ä½¿ç”¨
    function markVoucherAsUsed(voucherId) {
      const voucher = appState.vouchers.find(v => v.id === voucherId);
      if (voucher) {
        voucher.used = true;
        saveAppState();
        updateVoucherList();
        updateCharts();
      }
    }

    // é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
    function showDeleteConfirmation(voucherId) {
      const confirmDeleteModal = document.getElementById('confirm-delete-modal');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');
      
      // é¡¯ç¤ºæ¨¡æ…‹æ¡†
      confirmDeleteModal.classList.remove('hidden');
      
      // è¨­ç½®ç¢ºèªåˆªé™¤æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
      const confirmHandler = () => {
        deleteVoucher(voucherId);
        confirmDeleteModal.classList.add('hidden');
        confirmDeleteBtn.removeEventListener('click', confirmHandler);
      };
      
      confirmDeleteBtn.addEventListener('click', confirmHandler);
      
      // è¨­ç½®å–æ¶ˆæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
      cancelDeleteBtn.addEventListener('click', () => {
        confirmDeleteModal.classList.add('hidden');
        confirmDeleteBtn.removeEventListener('click', confirmHandler);
      });
    }

    // åˆªé™¤å„ªæƒ åˆ¸
    function deleteVoucher(voucherId) {
      const voucher = appState.vouchers.find(v => v.id === voucherId);
      
      if (voucher) {
        // å¦‚æœåˆªé™¤çš„æ˜¯æœªä½¿ç”¨çš„å„ªæƒ åˆ¸ï¼Œæ¢å¾©è©²éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
        if (!voucher.used && voucher.bankId && appState.bankDraws[voucher.bankId]) {
          appState.bankDraws[voucher.bankId].used--;
          appState.bankDraws[voucher.bankId].remaining++;
        }
        
        // å¾æ•¸çµ„ä¸­ç§»é™¤å„ªæƒ åˆ¸
        appState.vouchers = appState.vouchers.filter(v => v.id !== voucherId);
        
        // å¾éŠ€è¡Œè¨˜éŒ„ä¸­ç§»é™¤
        if (voucher.bankId && appState.bankVouchers[voucher.bankId]) {
          appState.bankVouchers[voucher.bankId] = appState.bankVouchers[voucher.bankId].filter(id => id !== voucherId);
        }
        
        saveAppState();
        updateUI();
        updateCharts();
      }
    }

    // æ·»åŠ å„ªæƒ åˆ¸
    function addVoucher(amount) {
      if (!appState.preferredBank) {
        alert('è«‹å…ˆé¸æ“‡éŠ€è¡Œï¼');
        return;
      }

      // ç²å–ç•¶å‰éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
      if (!appState.bankDraws[appState.preferredBank]) {
        appState.bankDraws[appState.preferredBank] = {
          remaining: 3,
          used: 0
        };
      }
      
      const bankDraws = appState.bankDraws[appState.preferredBank];
      
      if (bankDraws.remaining <= 0) {
        alert(`${getBankName(appState.preferredBank)}æœ¬é€±æŠ½çæ¬¡æ•¸å·²ç”¨å®Œï¼`);
        return;
      }

      // ä½¿ç”¨ç•¶å‰æ—¥æœŸ
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      
      // å‰µå»ºæ–°å„ªæƒ åˆ¸
      const newVoucher = {
        id: Date.now().toString(),
        amount: amount,
        date: todayString,
        used: false,
        bankId: appState.preferredBank
      };
      
      // æ·»åŠ å„ªæƒ åˆ¸
      appState.vouchers.push(newVoucher);
      
      // æ›´æ–°æŠ½çæ¬¡æ•¸
      bankDraws.used++;
      bankDraws.remaining = Math.max(0, bankDraws.remaining - 1);
      
      // æ·»åŠ åˆ°éŠ€è¡Œè¨˜éŒ„
      if (!appState.bankVouchers[appState.preferredBank]) {
        appState.bankVouchers[appState.preferredBank] = [];
      }
      appState.bankVouchers[appState.preferredBank].push(newVoucher.id);
      
      // ä¿å­˜ä¸¦æ›´æ–°UI
      saveAppState();
      updateUI();
      updateCharts();
    }

    // ç²å–éŠ€è¡Œåç¨±
    function getBankName(bankId) {
      const bank = banks.find(b => b.id === bankId);
      return bank ? bank.name : 'æœªçŸ¥éŠ€è¡Œ';
    }

    // é‡ç½®æœ¬é€±æŠ½çæ¬¡æ•¸
    function resetWeekDraws() {
      banks.forEach(bank => {
        if (!appState.bankDraws[bank.id]) {
          appState.bankDraws[bank.id] = {
            remaining: 3,
            used: 0
          };
        } else {
          appState.bankDraws[bank.id].remaining = 3;
          appState.bankDraws[bank.id].used = 0;
        }
      });
      
      saveAppState();
      updateUI();
      
      alert('å·²é‡ç½®æ‰€æœ‰éŠ€è¡Œæœ¬é€±æŠ½çæ¬¡æ•¸ï¼');
    }

    // é‡ç½®æ‰€æœ‰æ•¸æ“š
    function resetAllData() {
      appState = {
        vouchers: [],
        weekendSpends: [],
        currentWeek: calculateCurrentWeek(),
        bankDraws: {},
        preferredBank: null,
        bankVouchers: {},
        weekRecords: []
      };
      
      // åˆå§‹åŒ–æ¯å®¶éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
      banks.forEach(bank => {
        appState.bankDraws[bank.id] = {
          remaining: 3,
          used: 0
        };
      });
      
      saveAppState();
      updateUI();
      updateCharts();
      
      alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ï¼');
    }

    // æ›´æ–°æ•´å€‹UI
    function updateUI() {
      updateCurrentDateDisplay();
      updateCurrentWeekDisplay();
      updateBankButtons();
      updateQuickAddPanel();
      updateVoucherList();
      updateWeekRecords();
      updateWeekSchedule();
    }

    // åˆå§‹åŒ–åœ–è¡¨
    let valueChart, bankChart, weekChart;

    function initCharts() {
      // è¨­ç½®Chart.jså…¨å±€é…ç½®
      Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
      Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';
      
      // å„ªæƒ åˆ¸ç¸½å€¼åœ–è¡¨
      const valueCtx = document.getElementById('value-chart').getContext('2d');
      valueChart = new Chart(valueCtx, {
        type: 'bar',
        data: {
          labels: ['ğŸ˜„', '10å…ƒ', '20å…ƒ', '50å…ƒ', '100å…ƒ', '200å…ƒ'],
          datasets: [{
            label: 'æ•¸é‡',
            data: [0, 0, 0, 0, 0, 0],
            backgroundColor: document.documentElement.classList.contains('dark') ? 
              ['#facc15', '#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc'] : 
              ['#fef08a', '#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = [0, 10, 20, 50, 100, 200][context.dataIndex];
                  if (context.dataIndex === 0) {
                    return `æ•¸é‡: ${context.raw}å¼µ (ç¬‘å“ˆå“ˆ)`;
                  }
                  return `æ•¸é‡: ${context.raw}å¼µ (åƒ¹å€¼: ${context.raw * value}å…ƒ)`;
                }
              }
            }
          }
        }
      });
      
      // éŠ€è¡Œåˆ†ä½ˆåœ–è¡¨
      const bankCtx = document.getElementById('bank-chart').getContext('2d');
      bankChart = new Chart(bankCtx, {
        type: 'doughnut',
        data: {
          labels: banks.map(bank => bank.name),
          datasets: [{
            data: Array(banks.length).fill(0),
            backgroundColor: document.documentElement.classList.contains('dark') ? 
              chartColors.dark : chartColors.light
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 12,
                padding: 10
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${context.label}: ${value}å¼µ (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // é€±æ¬¡åˆ†ä½ˆåœ–è¡¨
      const weekCtx = document.getElementById('week-chart').getContext('2d');
      weekChart = new Chart(weekCtx, {
        type: 'line',
        data: {
          labels: Array.from({length: 10}, (_, i) => `ç¬¬${i+1}é€±`),
          datasets: [{
            label: 'å„ªæƒ åˆ¸æ•¸é‡',
            data: Array(10).fill(0),
            borderColor: document.documentElement.classList.contains('dark') ? 
              '#7978E9' : '#5D5CDE',
            backgroundColor: document.documentElement.classList.contains('dark') ? 
              'rgba(121, 120, 233, 0.2)' : 'rgba(93, 92, 222, 0.2)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // é¦–æ¬¡æ›´æ–°åœ–è¡¨
      updateCharts();
    }

    // æ›´æ–°åœ–è¡¨
    function updateCharts() {
      if (!valueChart || !bankChart || !weekChart) return;
      
      // è¨ˆç®—å„é¢å€¼å„ªæƒ åˆ¸æ•¸é‡
      const valueCounts = [0, 0, 0, 0, 0, 0]; // ç¬‘å“ˆå“ˆ, 10, 20, 50, 100, 200
      appState.vouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // ç¬‘å“ˆå“ˆ
          case 10: valueCounts[1]++; break;
          case 20: valueCounts[2]++; break;
          case 50: valueCounts[3]++; break;
          case 100: valueCounts[4]++; break;
          case 200: valueCounts[5]++; break;
        }
      });
      
      // æ›´æ–°å„ªæƒ åˆ¸ç¸½å€¼åœ–è¡¨
      valueChart.data.datasets[0].data = valueCounts;
      valueChart.update();
      
      // è¨ˆç®—å„éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡
      const bankCounts = Array(banks.length).fill(0);
      appState.vouchers.forEach(voucher => {
        if (voucher.bankId) {
          const bankIndex = banks.findIndex(bank => bank.id === voucher.bankId);
          if (bankIndex >= 0) {
            bankCounts[bankIndex]++;
          }
        }
      });
      
      // æ›´æ–°éŠ€è¡Œåˆ†ä½ˆåœ–è¡¨
      bankChart.data.datasets[0].data = bankCounts;
      bankChart.update();
      
      // è¨ˆç®—å„é€±å„ªæƒ åˆ¸æ•¸é‡
      const weekCounts = Array(10).fill(0);
      appState.vouchers.forEach(voucher => {
        const weekNum = getWeekNumberFromDate(voucher.date);
        if (weekNum >= 1 && weekNum <= 10) {
          weekCounts[weekNum - 1]++;
        }
      });
      
      // æ›´æ–°é€±æ¬¡åˆ†ä½ˆåœ–è¡¨
      weekChart.data.datasets[0].data = weekCounts;
      weekChart.update();
    }

    // è¨ˆç®—æœ€ä½³å„ªæƒ åˆ¸çµ„åˆ
    function calculateBestVoucherCombination(amount) {
      // ç²å–æ‰€æœ‰æœªä½¿ç”¨çš„å„ªæƒ åˆ¸
      const unusedVouchers = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v) && v.amount > 0); // éæ¿¾æ‰ç¬‘å“ˆå“ˆ(0å…ƒ)
      
      // æŒ‰é¢å€¼æ’åº
      const sortedVouchers = unusedVouchers.sort((a, b) => b.amount - a.amount);
      
      // æŒ‰éŠ€è¡Œåˆ†çµ„
      const vouchersByBank = {};
      sortedVouchers.forEach(voucher => {
        if (!vouchersByBank[voucher.bankId]) {
          vouchersByBank[voucher.bankId] = [];
        }
        vouchersByBank[voucher.bankId].push(voucher);
      });
      
      // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„çµ„åˆ (é‡å°æ¯å€‹éŠ€è¡Œ)
      const bankCombinations = {};
      Object.keys(vouchersByBank).forEach(bankId => {
        const bankVouchers = vouchersByBank[bankId];
        bankCombinations[bankId] = findCombinations(bankVouchers, amount);
      });
      
      // ç”Ÿæˆä¸åŒéŠ€è¡Œæ··åˆçš„çµ„åˆ
      const mixedCombinations = findMixedCombinations(sortedVouchers, amount);
      
      // æ‰¾å‡ºæœ€ä½³çµ„åˆ
      let bestCombination = null;
      let minDifference = Infinity;
      
      // æª¢æŸ¥æ¯å€‹éŠ€è¡Œçš„çµ„åˆ
      Object.keys(bankCombinations).forEach(bankId => {
        const combinations = bankCombinations[bankId];
        if (combinations.length > 0) {
          combinations.forEach(combo => {
            const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
            const difference = comboSum - amount;
            if (difference >= 0 && difference < minDifference) {
              minDifference = difference;
              bestCombination = {
                vouchers: combo,
                sum: comboSum,
                difference: difference,
                mixed: false,
                bankId: bankId
              };
            }
          });
        }
      });
      
      // æª¢æŸ¥æ··åˆéŠ€è¡Œçš„çµ„åˆ
      if (mixedCombinations.length > 0) {
        mixedCombinations.forEach(combo => {
          const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
          const difference = comboSum - amount;
          if (difference >= 0 && difference < minDifference) {
            minDifference = difference;
            bestCombination = {
              vouchers: combo,
              sum: comboSum,
              difference: difference,
              mixed: true
            };
          }
        });
      }
      
      // å¦‚æœæ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„çµ„åˆï¼Œè¿”å›null
      if (!bestCombination && unusedVouchers.length > 0) {
        // å˜—è©¦æ‰¾å‡ºæ¥è¿‘ä½†å°æ–¼ç›®æ¨™é‡‘é¡çš„çµ„åˆ
        let maxSum = 0;
        let closestCombination = null;
        
        // æª¢æŸ¥æ¯å€‹éŠ€è¡Œçš„çµ„åˆ
        Object.keys(bankCombinations).forEach(bankId => {
          const combinations = findCombinationsUnderTarget(vouchersByBank[bankId], amount);
          if (combinations.length > 0) {
            combinations.forEach(combo => {
              const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
              if (comboSum > maxSum) {
                maxSum = comboSum;
                closestCombination = {
                  vouchers: combo,
                  sum: comboSum,
                  difference: amount - comboSum,
                  mixed: false,
                  bankId: bankId,
                  underTarget: true
                };
              }
            });
          }
        });
        
        // æª¢æŸ¥æ··åˆéŠ€è¡Œçš„çµ„åˆ
        const underTargetMixedCombinations = findCombinationsUnderTarget(sortedVouchers, amount);
        if (underTargetMixedCombinations.length > 0) {
          underTargetMixedCombinations.forEach(combo => {
            const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
            if (comboSum > maxSum) {
              maxSum = comboSum;
              closestCombination = {
                vouchers: combo,
                sum: comboSum,
                difference: amount - comboSum,
                mixed: true,
                underTarget: true
              };
            }
          });
        }
        
        return closestCombination;
      }
      
      return bestCombination;
    }

    // å°‹æ‰¾ç­‰æ–¼æˆ–è¶…éç›®æ¨™é‡‘é¡çš„æ‰€æœ‰çµ„åˆ
    function findCombinations(vouchers, targetAmount) {
      const result = [];
      
      // æœ€å¤šå˜—è©¦5å¼µå„ªæƒ åˆ¸çš„çµ„åˆï¼Œé¿å…çµ„åˆçˆ†ç‚¸
      const maxVouchers = Math.min(5, vouchers.length);
      
      // è¼”åŠ©å‡½æ•¸ï¼Œä½¿ç”¨å›æº¯æ³•æŸ¥æ‰¾æ‰€æœ‰çµ„åˆ
      function backtrack(start, currentCombination, currentSum) {
        // å¦‚æœç•¶å‰ç¸½å’Œé”åˆ°æˆ–è¶…éç›®æ¨™é‡‘é¡ï¼Œæ·»åŠ åˆ°çµæœä¸­
        if (currentSum >= targetAmount) {
          result.push([...currentCombination]);
          return;
        }
        
        // å¦‚æœå·²ç¶“é”åˆ°æœ€å¤§å„ªæƒ åˆ¸æ•¸é‡ï¼Œè¿”å›
        if (currentCombination.length >= maxVouchers) {
          return;
        }
        
        // å˜—è©¦æ·»åŠ æ›´å¤šå„ªæƒ åˆ¸
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // é–‹å§‹å›æº¯
      backtrack(0, [], 0);
      
      // æŒ‰ç¸½å’Œæ’åºï¼Œå„ªå…ˆé¸æ“‡ç¸½å’Œæœ€æ¥è¿‘ç›®æ¨™é‡‘é¡çš„çµ„åˆ
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumA - sumB;
      });
    }

    // å°‹æ‰¾æ··åˆéŠ€è¡Œçš„çµ„åˆ
    function findMixedCombinations(vouchers, targetAmount) {
      // é€™è£¡æˆ‘å€‘ç°¡åŒ–ä¸€ä¸‹ï¼Œåªè€ƒæ…®æœ€å¤š3å¼µä¸åŒéŠ€è¡Œçš„å¡çš„çµ„åˆ
      const result = [];
      
      // æœ€å¤šå˜—è©¦3å¼µå„ªæƒ åˆ¸çš„çµ„åˆï¼Œé¿å…çµ„åˆçˆ†ç‚¸
      const maxVouchers = Math.min(3, vouchers.length);
      
      // è¼”åŠ©å‡½æ•¸ï¼Œä½¿ç”¨å›æº¯æ³•æŸ¥æ‰¾æ‰€æœ‰çµ„åˆ
      function backtrack(start, currentCombination, currentSum) {
        // å¦‚æœç•¶å‰ç¸½å’Œé”åˆ°æˆ–è¶…éç›®æ¨™é‡‘é¡ï¼Œæ·»åŠ åˆ°çµæœä¸­
        if (currentSum >= targetAmount) {
          result.push([...currentCombination]);
          return;
        }
        
        // å¦‚æœå·²ç¶“é”åˆ°æœ€å¤§å„ªæƒ åˆ¸æ•¸é‡ï¼Œè¿”å›
        if (currentCombination.length >= maxVouchers) {
          return;
        }
        
        // å˜—è©¦æ·»åŠ æ›´å¤šå„ªæƒ åˆ¸
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // é–‹å§‹å›æº¯
      backtrack(0, [], 0);
      
      // æŒ‰ç¸½å’Œæ’åºï¼Œå„ªå…ˆé¸æ“‡ç¸½å’Œæœ€æ¥è¿‘ç›®æ¨™é‡‘é¡çš„çµ„åˆ
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumA - sumB;
      });
    }

    // å°‹æ‰¾å°æ–¼ç›®æ¨™é‡‘é¡çš„æœ€å¤§çµ„åˆ
    function findCombinationsUnderTarget(vouchers, targetAmount) {
      const result = [];
      
      // æœ€å¤šå˜—è©¦5å¼µå„ªæƒ åˆ¸çš„çµ„åˆï¼Œé¿å…çµ„åˆçˆ†ç‚¸
      const maxVouchers = Math.min(5, vouchers.length);
      
      // è¼”åŠ©å‡½æ•¸ï¼Œä½¿ç”¨å›æº¯æ³•æŸ¥æ‰¾æ‰€æœ‰çµ„åˆ
      function backtrack(start, currentCombination, currentSum) {
        // å¦‚æœç•¶å‰ç¸½å’Œå°æ–¼ç›®æ¨™é‡‘é¡ï¼Œæ·»åŠ åˆ°çµæœä¸­
        if (currentSum > 0 && currentSum < targetAmount) {
          result.push([...currentCombination]);
        }
        
        // å¦‚æœå·²ç¶“é”åˆ°æœ€å¤§å„ªæƒ åˆ¸æ•¸é‡æˆ–ç•¶å‰ç¸½å’Œå·²ç¶“é”åˆ°æˆ–è¶…éç›®æ¨™é‡‘é¡ï¼Œè¿”å›
        if (currentCombination.length >= maxVouchers || currentSum >= targetAmount) {
          return;
        }
        
        // å˜—è©¦æ·»åŠ æ›´å¤šå„ªæƒ åˆ¸
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // é–‹å§‹å›æº¯
      backtrack(0, [], 0);
      
      // æŒ‰ç¸½å’Œé™åºæ’åºï¼Œå„ªå…ˆé¸æ“‡ç¸½å’Œæœ€æ¥è¿‘ç›®æ¨™é‡‘é¡çš„çµ„åˆ
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumB - sumA; // é™åºæ’åˆ—
      });
    }

    // åˆå§‹åŒ–é¸é …å¡åŠŸèƒ½
    function initTabs() {
      const tabButtons = document.querySelectorAll('#tabs button');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.getAttribute('data-tab');
          
          // æ›´æ–°æŒ‰éˆ•æ¨£å¼
          tabButtons.forEach(btn => {
            btn.classList.remove('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
            btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
          });
          
          button.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
          button.classList.add('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
          
          // é¡¯ç¤ºå°æ‡‰çš„å…§å®¹
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          
          document.getElementById(`${tabName}-content`).classList.remove('hidden');
          
          // å¦‚æœåˆ‡æ›åˆ°çµ±è¨ˆæ¨™ç±¤ï¼Œæ›´æ–°åœ–è¡¨
          if (tabName === 'stats') {
            updateCharts();
          }
        });
      });
    }

    // åˆå§‹åŒ–éå»è¨˜éŒ„æŸ¥çœ‹åŠŸèƒ½
    function initPastRecords() {
      const viewPastRecordsBtn = document.getElementById('view-past-records');
      const pastRecordsModal = document.getElementById('past-records-modal');
      const closePastRecordsBtn = document.getElementById('close-past-records');
      const pastWeekSelect = document.getElementById('past-week-select');
      const viewPastWeekBtn = document.getElementById('view-past-week');
      
      // å¡«å……é€±æ¬¡é¸æ“‡å™¨
      weekSchedule.forEach(week => {
        const option = document.createElement('option');
        option.value = week.week;
        option.textContent = `ç¬¬${week.week}é€± (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
        pastWeekSelect.appendChild(option);
      });
      
      // æ‰“é–‹æ¨¡æ…‹æ¡†
      viewPastRecordsBtn.addEventListener('click', () => {
        pastWeekSelect.value = '';
        pastRecordsModal.classList.remove('hidden');
      });
      
      // é—œé–‰æ¨¡æ…‹æ¡†
      closePastRecordsBtn.addEventListener('click', () => {
        pastRecordsModal.classList.add('hidden');
      });
      
      // æŸ¥çœ‹æŒ‰éˆ•
      viewPastWeekBtn.addEventListener('click', () => {
        if (pastWeekSelect.value) {
          const weekNum = parseInt(pastWeekSelect.value);
          if (weekNum >= 1 && weekNum <= 10) {
            // é¡¯ç¤ºè©²é€±çš„è¨˜éŒ„
            const weekRecord = appState.weekRecords.find(r => r.weekNum === weekNum);
            if (weekRecord) {
              showWeekDetail(weekRecord.id);
            } else {
              alert(`æ²’æœ‰ç¬¬${weekNum}é€±çš„è¨˜éŒ„ã€‚`);
            }
          }
        } else {
          alert('è«‹é¸æ“‡ä¸€å€‹é€±æ¬¡ï¼');
        }
        
        pastRecordsModal.classList.add('hidden');
      });
    }

    // åˆå§‹åŒ–å„ªæƒ åˆ¸çµ„åˆæ¨è–¦è¨ˆç®—åŠŸèƒ½
    function initVoucherRecommendation() {
      const paymentAmountInput = document.getElementById('payment-amount');
      const calculateRecommendationBtn = document.getElementById('calculate-recommendation');
      const recommendationResult = document.getElementById('recommendation-result');
      
      // è¨ˆç®—æ¨è–¦æŒ‰éˆ•
      calculateRecommendationBtn.addEventListener('click', () => {
        const amount = parseInt(paymentAmountInput.value);
        if (isNaN(amount) || amount <= 0) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¶ˆè²»é‡‘é¡ï¼');
          return;
        }
        
        // è¨ˆç®—æœ€ä½³çµ„åˆ
        const bestCombination = calculateBestVoucherCombination(amount);
        
        // é¡¯ç¤ºçµæœ
        recommendationResult.classList.remove('hidden');
        
        if (!bestCombination) {
          recommendationResult.innerHTML = `
            <div class="text-center py-4">
              <div class="text-red-500 dark:text-red-400 mb-2">ç„¡æ³•æ‰¾åˆ°åˆé©çš„å„ªæƒ åˆ¸çµ„åˆ</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">æ‚¨ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸ï¼Œæˆ–è€…å¯ç”¨å„ªæƒ åˆ¸ä¸è¶³ä»¥æ”¯ä»˜è©²é‡‘é¡</div>
            </div>
          `;
          return;
        }
        
        // æ ¹æ“šæ˜¯å¦å°æ–¼ç›®æ¨™é‡‘é¡é¡¯ç¤ºä¸åŒçš„æç¤º
        const headerClass = bestCombination.underTarget ? 'text-yellow-500 dark:text-yellow-400' : 'text-green-500 dark:text-green-400';
        const headerText = bestCombination.underTarget ? 
          `æ‰¾åˆ°æœ€æ¥è¿‘çš„çµ„åˆï¼ˆé‚„éœ€æ”¯ä»˜${bestCombination.difference}å…ƒï¼‰` : 
          `æ‰¾åˆ°æœ€ä½³çµ„åˆï¼ˆå¤š${bestCombination.difference}å…ƒï¼‰`;
        
        // æ ¹æ“šæ˜¯å¦æ··åˆéŠ€è¡Œé¡¯ç¤ºä¸åŒçš„æç¤º
        const bankText = bestCombination.mixed ? 
          'æ··åˆä½¿ç”¨å¤šå®¶éŠ€è¡Œçš„å„ªæƒ åˆ¸' : 
          `ä½¿ç”¨${getBankName(bestCombination.bankId)}çš„å„ªæƒ åˆ¸`;
        
        // ç”Ÿæˆå„ªæƒ åˆ¸åˆ—è¡¨
        let vouchersList = '';
        const vouchersByAmount = {};
        
        bestCombination.vouchers.forEach(voucher => {
          if (!vouchersByAmount[voucher.amount]) {
            vouchersByAmount[voucher.amount] = { count: 0, banks: {} };
          }
          
          vouchersByAmount[voucher.amount].count++;
          
          if (!vouchersByAmount[voucher.amount].banks[voucher.bankId]) {
            vouchersByAmount[voucher.amount].banks[voucher.bankId] = 0;
          }
          
          vouchersByAmount[voucher.amount].banks[voucher.bankId]++;
        });
        
        // æŒ‰é‡‘é¡å¾å¤§åˆ°å°æ’åº
        const amounts = Object.keys(vouchersByAmount).map(Number).sort((a, b) => b - a);
        
        amounts.forEach(amount => {
          const data = vouchersByAmount[amount];
          
          let bankDetails = '';
          Object.keys(data.banks).forEach(bankId => {
            const bank = banks.find(b => b.id === bankId);
            if (bank) {
              bankDetails += `
                <div class="flex items-center text-xs ml-4 mb-1">
                  <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                  <span>${bank.name}: ${data.banks[bankId]}å¼µ</span>
                </div>
              `;
            }
          });
          
          vouchersList += `
            <div class="mb-2">
              <div class="font-medium">${amount}å…ƒ Ã— ${data.count}å¼µ = ${amount * data.count}å…ƒ</div>
              ${bankDetails}
            </div>
          `;
        });
        
        recommendationResult.innerHTML = `
          <div>
            <div class="${headerClass} font-bold mb-2">${headerText}</div>
            <div class="text-sm mb-3">
              <div>æ¶ˆè²»é‡‘é¡: ${amount}å…ƒ</div>
              <div>å„ªæƒ åˆ¸ç¸½é¡: ${bestCombination.sum}å…ƒ</div>
              <div>ä½¿ç”¨å„ªæƒ åˆ¸æ•¸é‡: ${bestCombination.vouchers.length}å¼µ</div>
              <div>${bankText}</div>
            </div>
            <div class="border-t pt-2">
              <div class="font-medium mb-1">å„ªæƒ åˆ¸æ˜ç´°:</div>
              ${vouchersList}
            </div>
          </div>
        `;
      });
      
      // æŒ‰Enteréµä¹Ÿè§¸ç™¼è¨ˆç®—
      paymentAmountInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          calculateRecommendationBtn.click();
        }
      });
    }

    // åˆå§‹åŒ–é€±æ¬¡è¨˜éŒ„åŠŸèƒ½
    function initWeekRecords() {
      const newWeekBtn = document.getElementById('new-week-btn');
      const newWeekModal = document.getElementById('new-week-modal');
      const weekSelect = document.getElementById('week-select');
      const weekNotes = document.getElementById('week-notes');
      const cancelNewWeekBtn = document.getElementById('cancel-new-week');
      const confirmNewWeekBtn = document.getElementById('confirm-new-week');
      
      // åˆå§‹åŒ–é€±æ¬¡é¸æ“‡ä¸‹æ‹‰æ¡†
      weekSelect.innerHTML = '';
      weekSchedule.forEach(week => {
        const option = document.createElement('option');
        option.value = week.week;
        option.textContent = `ç¬¬${week.week}é€± (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
        weekSelect.appendChild(option);
      });
      
      // é»˜èªé¸æ“‡ç•¶å‰é€±æ¬¡
      const currentWeek = calculateCurrentWeek();
      if (currentWeek >= 1 && currentWeek <= 10) {
        weekSelect.value = currentWeek;
      }
      
      // æ‰“é–‹æ–°å¢é€±æ¬¡è¨˜éŒ„æ¨¡æ…‹æ¡†
      newWeekBtn.addEventListener('click', () => {
        newWeekModal.classList.remove('hidden');
      });
      
      // å–æ¶ˆæ·»åŠ 
      cancelNewWeekBtn.addEventListener('click', () => {
        newWeekModal.classList.add('hidden');
      });
      
      // ç¢ºèªæ·»åŠ 
      confirmNewWeekBtn.addEventListener('click', () => {
        const weekNum = parseInt(weekSelect.value);
        const notes = weekNotes.value.trim();
        
        if (weekNum >= 1 && weekNum <= 10) {
          const success = addWeekRecord(weekNum, notes);
          if (success) {
            updateWeekRecords();
          }
        }
        
        newWeekModal.classList.add('hidden');
        weekNotes.value = '';
      });
    }

    // åˆå§‹åŒ–é‡ç½®æŠ½çæ¬¡æ•¸æŒ‰éˆ•
    function initResetDrawsButton() {
      const resetDrawsBtn = document.getElementById('reset-draws-btn');
      
      resetDrawsBtn.addEventListener('click', () => {
        if (confirm('ç¢ºå®šè¦é‡ç½®æœ¬é€±æŠ½çæ¬¡æ•¸å—ï¼Ÿé€™å°‡æŠŠæ‰€æœ‰éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸æ¢å¾©åˆ°3æ¬¡')) {
          resetWeekDraws();
        }
      });
    }

    // åˆå§‹åŒ–æ¸…é™¤æ•¸æ“šæŒ‰éˆ•
    function initClearDataButton() {
      const clearAllDataBtn = document.getElementById('clear-all-data');
      
      clearAllDataBtn.addEventListener('click', () => {
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼')) {
          resetAllData();
        }
      });
    }

    // åˆå§‹åŒ–å¿«é€Ÿæ·»åŠ æŒ‰éˆ•
    function initQuickAdd() {
      const quickAddBtns = document.querySelectorAll('.quick-add');
      
      quickAddBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const amount = parseInt(this.getAttribute('data-amount'));
          addVoucher(amount);
        });
      });
    }

    // åˆå§‹åŒ–åœ–è¡¨é€±æ¬¡ç¯©é¸åŠŸèƒ½
    function initChartWeekFilter() {
      const chartWeekFilter = document.getElementById('chart-week-filter');
      
      // å¡«å……é€±æ¬¡é¸é …
      chartWeekFilter.innerHTML = '<option value="all">æ‰€æœ‰é€±æ¬¡</option>';
      weekSchedule.forEach(week => {
        const option = document.createElement('option');
        option.value = week.week;
        option.textContent = `ç¬¬${week.week}é€± (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
        chartWeekFilter.appendChild(option);
      });
      
      // é€±æ¬¡ç¯©é¸è®ŠåŒ–æ™‚æ›´æ–°åœ–è¡¨
      chartWeekFilter.addEventListener('change', function() {
        updateChartsWithWeekFilter(this.value);
      });
    }
    
    // æ ¹æ“šé€±æ¬¡ç¯©é¸æ›´æ–°åœ–è¡¨
    function updateChartsWithWeekFilter(weekFilter) {
      if (!valueChart || !bankChart || !weekChart) return;
      
      // ç²å–ç¯©é¸çš„é€±æ¬¡
      const selectedWeek = weekFilter === 'all' ? null : parseInt(weekFilter);
      
      // ç¯©é¸å„ªæƒ åˆ¸
      const filteredVouchers = selectedWeek ? 
        appState.vouchers.filter(v => getWeekNumberFromDate(v.date) === selectedWeek) : 
        appState.vouchers;
      
      // è¨ˆç®—å„é¢å€¼å„ªæƒ åˆ¸æ•¸é‡
      const valueCounts = [0, 0, 0, 0, 0, 0]; // ç¬‘å“ˆå“ˆ, 10, 20, 50, 100, 200
      filteredVouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // ç¬‘å“ˆå“ˆ
          case 10: valueCounts[1]++; break;
          case 20: valueCounts[2]++; break;
          case 50: valueCounts[3]++; break;
          case 100: valueCounts[4]++; break;
          case 200: valueCounts[5]++; break;
        }
      });
      
      // æ›´æ–°å„ªæƒ åˆ¸ç¸½å€¼åœ–è¡¨
      valueChart.data.datasets[0].data = valueCounts;
      valueChart.update();
      
      // è¨ˆç®—å„éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡
      const bankCounts = Array(banks.length).fill(0);
      filteredVouchers.forEach(voucher => {
        if (voucher.bankId) {
          const bankIndex = banks.findIndex(bank => bank.id === voucher.bankId);
          if (bankIndex >= 0) {
            bankCounts[bankIndex]++;
          }
        }
      });
      
      // æ›´æ–°éŠ€è¡Œåˆ†ä½ˆåœ–è¡¨
      bankChart.data.datasets[0].data = bankCounts;
      bankChart.update();
      
      // å¦‚æœé¸æ“‡äº†"æ‰€æœ‰é€±æ¬¡"ï¼Œå‰‡é¡¯ç¤ºé€±æ¬¡åˆ†ä½ˆåœ–
      if (!selectedWeek) {
        // è¨ˆç®—å„é€±å„ªæƒ åˆ¸æ•¸é‡
        const weekCounts = Array(10).fill(0);
        appState.vouchers.forEach(voucher => {
          const weekNum = getWeekNumberFromDate(voucher.date);
          if (weekNum >= 1 && weekNum <= 10) {
            weekCounts[weekNum - 1]++;
          }
        });
        
        // é¡¯ç¤ºé€±æ¬¡åˆ†ä½ˆåœ–è¡¨
        document.querySelector('.bg-white.dark\\:bg-gray-800.rounded-lg.shadow.p-4.mb-4:nth-child(4)').style.display = '';
        
        // æ›´æ–°é€±æ¬¡åˆ†ä½ˆåœ–è¡¨
        weekChart.data.datasets[0].data = weekCounts;
        weekChart.update();
      } else {
        // å¦‚æœé¸äº†ç‰¹å®šé€±æ¬¡ï¼Œéš±è—é€±æ¬¡åˆ†ä½ˆåœ–è¡¨
        document.querySelector('.bg-white.dark\\:bg-gray-800.rounded-lg.shadow.p-4.mb-4:nth-child(4)').style.display = 'none';
      }
    }
    
    // å•Ÿå‹•æ‡‰ç”¨ç¨‹åº
    document.addEventListener('DOMContentLoaded', function() {
      // å…ˆåŠ è¼‰å‚³çµ±ç‹€æ…‹
      loadLegacyAppState();
      
      // åŠ è¼‰å€‹äººæª”æ¡ˆ
      loadProfiles();
      
      // åˆå§‹åŒ–å„åŠŸèƒ½
      initTabs();
      initPastRecords();
      initVoucherRecommendation();
      initQuickAdd();
      initWeekRecords();
      initResetDrawsButton();
      initClearDataButton();
      initCharts();
      initProfilesUI();
      initChartWeekFilter();
      
      // æ›´æ–°ç•Œé¢
      updateUI();
    });
  </script>
</body>
</html>