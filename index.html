<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨é‹èšåŠ›â€§ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
colors: {
primary: '#5D5CDE', 'primary-dark': '#4B4AB2',
'boc': '#c1272d', 'boc-dark': '#a01e21',
'icbc': '#c7000a', 'icbc-dark': '#a00008',
'macaupass': '#0c6e4f', 'macaupass-dark': '#095338',
'luso': '#00529b', 'luso-dark': '#003e75',
'ant': '#2c64ae', 'ant-dark': '#1a4d8a',
'mpay': '#1e469a', 'mpay-dark': '#173777',
'gdb': '#e83828', 'gdb-dark': '#b82116'
}
}
}
}
</script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
<div class="max-w-md mx-auto p-4">
<!-- æ¨™é¡Œå’Œè¨ˆæ•¸å™¨ -->
<div class="text-center mb-4">
<h1 class="text-2xl font-bold text-primary dark:text-primary mb-2">å…¨é‹èšåŠ›â€§ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨</h1>
<div class="text-sm bg-blue-50 dark:bg-blue-900 p-2 rounded-lg">
<div>ä»Šå¤©ï¼š<span id="current-date">è¼‰å…¥ä¸­...</span> | <span id="current-week">è¼‰å…¥ä¸­...</span></div>
</div>
</div>

<!-- ä¸»è¦åŠŸèƒ½é¸é …å¡ -->
<div class="mb-4 border-b border-gray-200 dark:border-gray-700">
<ul class="flex flex-wrap" id="tabs">
<li class="w-1/4 text-center"><button class="w-full py-2 px-1 text-primary dark:text-primary border-b-2 border-primary dark:border-primary tab-active" data-tab="earn">è³ºå–</button></li>
<li class="w-1/4 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="redeem">å…‘æ›</button></li>
<li class="w-1/4 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="history">å·²å…‘æ›</button></li>
<li class="w-1/4 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="stats">çµ±è¨ˆ</button></li>
</ul>
</div>

<!-- è³ºå–å„ªæƒ åˆ¸é¢æ¿ -->
<div class="tab-content" id="earn-content">
<!-- éŠ€è¡Œé¸æ“‡æŒ‰éˆ•çµ„ -->
<div class="mb-4">
<div class="flex justify-between items-center mb-2">
<div class="text-sm font-medium">é¸æ“‡æ”¯ä»˜å·¥å…· (é»æ“ŠéŠ€è¡Œæ·»åŠ å„ªæƒ åˆ¸)</div>
<div class="flex gap-2">
<button id="admin-mode-btn" class="text-xs px-2 py-1 flex items-center bg-yellow-500 text-white rounded hover:bg-yellow-600">
<i class="ri-settings-5-line mr-1"></i> ç®¡ç†
</button>
<button id="bank-display-settings-btn" class="text-xs px-2 py-1 flex items-center bg-primary text-white rounded hover:bg-primary-dark">
<i class="ri-settings-3-line mr-1"></i> è¨­å®š
</button>
</div>
</div>

<div class="grid grid-cols-4 gap-2 mb-4" id="bank-buttons"></div>
</div>

<!-- å¿«é€Ÿæ·»åŠ å„ªæƒ åˆ¸ -->
<div id="quick-add-container" class="mb-4 hidden">
<div class="flex justify-between items-center mb-2">
<div class="text-sm font-medium"><span id="selected-bank-name-display">éŠ€è¡Œ</span>å„ªæƒ åˆ¸ (ç¸½è¨ˆ: <span id="total-draws">0</span>/3æ¬¡)</div>
</div>
<div class="grid grid-cols-3 gap-2 mb-2">
<button data-amount="10" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">10å…ƒ</button>
<button data-amount="20" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">20å…ƒ</button>
<button data-amount="50" class="quick-add py-2 px-1 bg-green-100 dark:bg-green-900 rounded-lg text-center hover:bg-green-200 dark:hover:bg-green-800 transition-colors">50å…ƒ</button>
<button data-amount="100" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">100å…ƒ</button>
<button data-amount="200" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">200å…ƒ</button>
<button data-amount="0" class="quick-add py-2 px-1 bg-yellow-100 dark:bg-yellow-900 rounded-lg text-center hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors">ğŸ˜„</button>
</div>
</div>

<!-- éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½ -->
<div class="mb-4">
<h3 class="text-sm font-bold mb-2">å„éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½ (æœ¬é€±)</h3>
<div id="bank-overview-list" class="space-y-3"></div>
</div>
</div>

<!-- å…‘æ›å„ªæƒ åˆ¸é¢æ¿ -->
<div class="tab-content hidden" id="redeem-content">
<!-- å„ªæƒ åˆ¸è¨ˆç®—å™¨ -->
<div class="mb-4 bg-green-50 dark:bg-green-900/20 rounded-lg p-3 shadow">
<div class="flex items-center justify-between mb-2">
<div>
<div class="text-sm font-medium">å„ªæƒ åˆ¸è¨ˆç®—å™¨</div>
<div class="text-xs text-gray-500 dark:text-gray-400">è¼¸å…¥é‡‘é¡è¨ˆç®—æœ€ä½³çµ„åˆ</div>
</div>
</div>

<div class="space-y-3">
<div class="flex space-x-2">
<input type="number" id="payment-amount" min="1" placeholder="è¼¸å…¥æ¶ˆè²»é‡‘é¡" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
</div>

<div class="grid grid-cols-2 gap-2">
<button id="calculate-max-value" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors text-sm">
<i class="ri-money-dollar-circle-line mr-1"></i>æœ€å¤§ç¯€çœ
</button>
<button id="calculate-max-quantity" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
<i class="ri-stack-line mr-1"></i>æœ€å¤šå„ªæƒ åˆ¸
</button>
<button id="calculate-high-value" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
<i class="ri-vip-crown-line mr-1"></i>å„ªå…ˆé«˜é¢å€¼
</button>
<button id="calculate-same-bank" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
<i class="ri-bank-line mr-1"></i>åŒè¡Œå„ªæƒ åˆ¸
</button>
</div>
</div>

<!-- è¨ˆç®—çµæœå€åŸŸ -->
<div id="recommendation-result" class="mt-3 border rounded-lg p-3 bg-white dark:bg-gray-800 hidden"></div>
</div>

<!-- å¯ç”¨å„ªæƒ åˆ¸ç¸½è¦½ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
<div class="flex justify-between items-center mb-2">
<h3 class="text-sm font-bold">å¯ç”¨å„ªæƒ åˆ¸ç¸½è¦½</h3>
<div class="text-sm text-gray-500 dark:text-gray-400">
æœªä½¿ç”¨: <span id="unused-vouchers-count" class="font-bold text-green-600 dark:text-green-400">0</span>å¼µ
</div>
</div>
<div id="redeemable-vouchers-list" class="space-y-2"></div>
</div>

<!-- å„ªæƒ åˆ¸é¸æ“‡å’Œå…‘æ›å€åŸŸ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-bold">é¸æ“‡ä¸¦å…‘æ›å„ªæƒ åˆ¸</h3>
<div id="selection-summary" class="text-sm">
å·²é¸: <span id="selected-vouchers-count">0</span>å¼µ (<span id="selected-vouchers-value">0</span>å…ƒ)
</div>
</div>

<!-- å„ªæƒ åˆ¸é¸æ“‡å€åŸŸ -->
<div id="redeem-voucher-selection" class="space-y-3 mb-4"></div>

<!-- å…‘æ›æ“ä½œå€åŸŸ -->
<div id="redeem-operations" class="mt-3 hidden">
<div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
æ¶ˆè²»é‡‘é¡å¿…é ˆç‚ºå„ªæƒ åˆ¸ç¸½é¡çš„3å€æˆ–ä»¥ä¸Šæ‰èƒ½å…‘æ›
</div>
<div class="grid grid-cols-1 gap-2">
<div id="redeem-amount-info" class="text-sm text-gray-700 dark:text-gray-300 py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
æœ€ä½éœ€æ¶ˆè²»é‡‘é¡: <span id="min-redeem-amount">0</span>å…ƒ
</div>
<div>
<input type="number" id="manual-spend-amount" placeholder="å¯¦éš›æ¶ˆè²»é‡‘é¡" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600 mb-2">
<div class="mb-2">
<div class="text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">æ¶ˆè²»é¡åˆ¥ (é¸å¡«)</div>
<div class="grid grid-cols-3 gap-2" id="consumption-category-buttons">
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="é¤é£²">
ğŸ½ï¸ é¤é£²
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="è³¼ç‰©">
ğŸ›ï¸ è³¼ç‰©
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="äº¤é€š">
ğŸš— äº¤é€š
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="è¶…å¸‚">
ğŸ›’ è¶…å¸‚
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="å¨›æ¨‚">
ğŸ® å¨›æ¨‚
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="é†«ç™‚">
ğŸ’Š é†«ç™‚
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="æ•™è‚²">
ğŸ“š æ•™è‚²
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="æœå‹™">
âš™ï¸ æœå‹™
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="å…¶ä»–">
ğŸ“¦ å…¶ä»–
</button>
</div>
</div>
<textarea id="redeem-remark" placeholder="æ¶ˆè²»å†…å®¹å‚™è¨» (é¸å¡«)" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600 mb-2" rows="2"></textarea>
<button id="redeem-selected-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
å…‘æ›å„ªæƒ åˆ¸
</button>
</div>
</div>
</div>
</div>
</div>

<!-- å·²å…‘æ›è¨˜éŒ„é¢æ¿ -->
<div class="tab-content hidden" id="history-content">
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<div class="flex items-center justify-between mb-3">
<h3 class="font-bold">å…‘æ›è¨˜éŒ„</h3>
<div class="text-sm text-gray-500 dark:text-gray-400">
ç¸½è¨ˆ: <span id="redeemed-total-count" class="font-bold">0</span>å¼µ
</div>
</div>

<div id="redemption-history-list" class="space-y-3">
<div class="text-center text-gray-500 dark:text-gray-400 py-4">å°šç„¡å…‘æ›è¨˜éŒ„</div>
</div>
</div>
</div>

<!-- çµ±è¨ˆé¢æ¿ -->
<div class="tab-content hidden" id="stats-content">
<!-- ç¸½é«”çµ±è¨ˆ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
<h3 class="font-bold mb-2">ç¸½é«”çµ±è¨ˆ</h3>
<div class="grid grid-cols-2 gap-3">
<div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">ç¸½å„ªæƒ åˆ¸</div>
<div class="text-xl font-bold" id="total-vouchers">0å¼µ</div>
</div>
<div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">ç¸½åƒ¹å€¼</div>
<div class="text-xl font-bold" id="total-value">0å…ƒ</div>
</div>
<div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">å·²å…‘æ›ç‡</div>
<div class="text-xl font-bold" id="usage-rate">0%</div>
</div>
<div class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">å·²éæœŸç‡</div>
<div class="text-xl font-bold" id="expiry-rate">0%</div>
</div>
</div>
</div>

<!-- åœ–è¡¨åˆ†æ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">å„ªæƒ åˆ¸ç‹€æ…‹åˆ†ä½ˆ</h3>
<div class="h-60">
<canvas id="status-chart"></canvas>
</div>
</div>

<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">å„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆ</h3>
<div class="mb-3 flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
<button id="value-chart-total-btn" class="flex-1 py-1 px-2 text-center rounded bg-primary text-white text-xs">
ç¸½é«”åˆ†ä½ˆ
</button>
<button id="value-chart-bank-btn" class="flex-1 py-1 px-2 text-center rounded text-gray-600 dark:text-gray-300 text-xs">
æŒ‰éŠ€è¡Œåˆ†ä½ˆ
</button>
</div>
<div class="h-60">
<canvas id="value-chart"></canvas>
</div>
</div>

<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">éŠ€è¡Œåˆ†ä½ˆ (æŒ‰åƒ¹å€¼)</h3>
<div class="h-60">
<canvas id="bank-chart"></canvas>
</div>
</div>

<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">é€±æ¬¡è¶¨å‹¢</h3>
<div class="h-60">
<canvas id="weekly-trend-chart"></canvas>
</div>
</div>

<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">æ¶ˆè²»é¡åˆ¥åˆ†æ</h3>
<div class="h-60">
<canvas id="category-chart"></canvas>
</div>
<!-- é¡åˆ¥è©³ç´°çµ±è¨ˆ -->
<div id="category-details" class="mt-3 pt-3 border-t dark:border-gray-700"></div>
</div>
</div>


</div>

<!-- éŠ€è¡Œé¡¯ç¤ºè¨­ç½®æ¨¡æ…‹æ¡† -->
<div id="bank-display-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-full max-w-sm mx-4">
<div class="flex justify-between items-center mb-3">
<h3 class="text-lg font-bold">æ”¯ä»˜å·¥å…·é¡¯ç¤ºè¨­å®š</h3>
<button id="close-bank-display-settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div class="mb-3">
<div class="text-sm mb-2">é¸æ“‡è¦åœ¨ä¸»ç•Œé¢é¡¯ç¤ºçš„æ”¯ä»˜å·¥å…·:</div>
<div class="flex flex-wrap gap-2 mb-3" id="bank-filters"></div>

<div class="flex space-x-2 mb-2">
<button id="select-all-display-banks" class="flex-1 bg-primary text-white py-1 px-3 rounded-lg text-sm">å…¨é¸</button>
<button id="clear-display-banks" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-1 px-3 rounded-lg text-sm">æ¸…ç©º</button>
</div>
</div>

<div class="flex justify-end">
<button id="save-bank-display-settings" class="bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark">
ç¢ºå®š
</button>
</div>
</div>
</div>

<!-- ç®¡ç†æ¨¡å¼æ¨¡æ…‹æ¡† -->
<div id="admin-mode-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-3">
<h3 class="text-lg font-bold">ç®¡ç†æ¨¡å¼</h3>
<button id="close-admin-mode" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div class="mb-3">
<div class="text-sm mb-2 text-yellow-600 dark:text-yellow-400">âš ï¸ ç®¡ç†æ¨¡å¼ç”¨æ–¼æ•¸æ“šä¿®å¾©ï¼Œè«‹è¬¹æ…æ“ä½œ</div>
<div class="border-t border-b dark:border-gray-700 py-3">
<div class="mb-2">
<label class="block text-sm font-medium mb-1">é€±æ¬¡é¸æ“‡</label>
<select id="admin-week-select" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
<!-- Week options will be added by JS -->
</select>
</div>
<div class="mb-2">
<label class="block text-sm font-medium mb-1">æ”¯ä»˜å·¥å…·</label>
<select id="admin-bank-select" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
<!-- Bank options will be added by JS -->
</select>
</div>
<div class="mb-2">
<label class="block text-sm font-medium mb-1">å„ªæƒ åˆ¸è³‡æ–™</label>
<div class="grid grid-cols-2 gap-2">
<div class="space-y-1 text-sm">
<div>10å…ƒ: <span id="admin-10-count">0</span>å¼µ</div>
<div>20å…ƒ: <span id="admin-20-count">0</span>å¼µ</div>
<div>50å…ƒ: <span id="admin-50-count">0</span>å¼µ</div>
</div>
<div class="space-y-1 text-sm">
<div>100å…ƒ: <span id="admin-100-count">0</span>å¼µ</div>
<div>200å…ƒ: <span id="admin-200-count">0</span>å¼µ</div>
<div>ğŸ˜„: <span id="admin-0-count">0</span>å¼µ</div>
</div>
</div>
</div>
<div class="mt-4 space-y-2">
<div class="flex space-x-2">
<select id="admin-amount-select" class="p-2 border rounded flex-grow dark:bg-gray-700 dark:border-gray-600">
<option value="10">10å…ƒ</option>
<option value="20">20å…ƒ</option>
<option value="50">50å…ƒ</option>
<option value="100">100å…ƒ</option>
<option value="200">200å…ƒ</option>
<option value="0">ğŸ˜„</option>
</select>
<button id="admin-add-btn" class="bg-green-500 text-white px-4 py-2 rounded">æ·»åŠ </button>
<button id="admin-remove-btn" class="bg-red-500 text-white px-4 py-2 rounded">åˆªé™¤</button>
</div>
</div>
</div>
</div>

<div class="flex justify-end space-x-2">
<button id="close-admin-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
é—œé–‰
</button>
</div>
</div>
</div>

<!-- ç¢ºèªå…‘æ›æ¨¡æ…‹æ¡† -->
<div id="confirm-redeem-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
<h3 class="text-lg font-bold mb-4">ç¢ºèªå…‘æ›</h3>
<p class="mb-4 text-sm">ç¢ºå®šè¦å…‘æ›ä»¥ä¸‹å„ªæƒ åˆ¸å—ï¼Ÿ</p>
<div id="redeem-vouchers-info" class="mb-4 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"></div>
<div class="flex space-x-2">
<button id="cancel-redeem" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">å–æ¶ˆ</button>
<button id="confirm-redeem" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">ç¢ºèªå…‘æ›</button>
</div>
</div>
</div>

<script>
// æ·±è‰²æ¨¡å¼è¨­ç½®
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
if (event.matches) document.documentElement.classList.add('dark');
else document.documentElement.classList.remove('dark');
});

// æ´»å‹•é€±æœŸæ•¸æ“š
const weekSchedule = [
{ week: 1, startDate: '2025-09-01', endDate: '2025-09-05', resetDate: '2025-09-06' },
{ week: 2, startDate: '2025-09-08', endDate: '2025-09-12', resetDate: '2025-09-13' },
{ week: 3, startDate: '2025-09-15', endDate: '2025-09-19', resetDate: '2025-09-20' },
{ week: 4, startDate: '2025-09-22', endDate: '2025-09-26', resetDate: '2025-09-27' },
{ week: 5, startDate: '2025-09-29', endDate: '2025-10-03', resetDate: '2025-10-04' },
{ week: 6, startDate: '2025-10-06', endDate: '2025-10-10', resetDate: '2025-10-11' },
{ week: 7, startDate: '2025-10-13', endDate: '2025-10-17', resetDate: '2025-10-18' },
{ week: 8, startDate: '2025-10-20', endDate: '2025-10-24', resetDate: '2025-10-25' },
{ week: 9, startDate: '2025-10-27', endDate: '2025-10-31', resetDate: '2025-11-01' },
{ week: 10, startDate: '2025-11-03', endDate: '2025-11-07', resetDate: '2025-11-08' },
{ week: 11, startDate: '2025-11-10', endDate: '2025-11-14', resetDate: '2025-11-15' },
{ week: 12, startDate: '2025-11-17', endDate: '2025-11-21', resetDate: '2025-11-22' },
{ week: 13, startDate: '2025-11-24', endDate: '2025-11-28', resetDate: '2025-11-29' }
];

// éŠ€è¡Œæ”¯ä»˜å·¥å…·
const banks = [
{ id: 'boc', name: 'ä¸­åœ‹éŠ€è¡Œ', color: 'boc', darkColor: 'boc-dark', logo: 'ri-bank-fill' },
{ id: 'icbc', name: 'å·¥å•†éŠ€è¡Œ', color: 'icbc', darkColor: 'icbc-dark', logo: 'ri-bank-fill' },
{ id: 'luso', name: 'å¤§è±éŠ€è¡Œ', color: 'luso', darkColor: 'luso-dark', logo: 'ri-bank-fill' },
{ id: 'bnu', name: 'æ¾³é–€åœ‹éš›éŠ€è¡Œ', color: 'primary', darkColor: 'primary-dark', logo: 'ri-bank-fill' },
{ id: 'macaupass', name: 'æ¾³é–€é€š', color: 'macaupass', darkColor: 'macaupass-dark', logo: 'ri-bank-card-fill' },
{ id: 'ant', name: 'èèŸ»éŠ€è¡Œ', color: 'ant', darkColor: 'ant-dark', logo: 'ri-bank-fill' },
{ id: 'mpay', name: 'æ¾³é–€æ¥µæ˜“ä»˜', color: 'mpay', darkColor: 'mpay-dark', logo: 'ri-wallet-fill' },
{ id: 'gdb', name: 'å»£ç™¼éŠ€è¡Œ', color: 'gdb', darkColor: 'gdb-dark', logo: 'ri-bank-fill' }
];

// åˆå§‹åŒ–åº”ç”¨ç¨‹åºçŠ¶æ…‹
let appState = {
vouchers: [],
currentWeek: 1,
preferredBank: null,
selectedVouchers: [],
redemptionHistory: [],
nextRedemptionId: 1,
bankDisplayFilter: banks.map(bank => bank.id) // åˆå§‹åŒ–é¡¯ç¤ºæ‰€æœ‰éŠ€è¡Œ
};

// åœ–è¡¨å¯¦ä¾‹
let statusChart, valueChart, bankChart, weeklyTrendChart, categoryChart;
let tempSelectedVouchers = [];
let tempRedeemRemark = '';

// é è¨­çš„æ¶ˆè²»é¡åˆ¥
const consumptionCategories = [
'é¤é£²', 'è³¼ç‰©', 'äº¤é€š', 'è¶…å¸‚', 'å¨›æ¨‚', 'é†«ç™‚', 'æ•™è‚²', 'æœå‹™', 'å…¶ä»–'
];

// æ¶ˆè²»é¡åˆ¥å°æ‡‰çš„åœ–ç¤º
const categoryIcons = {
'é¤é£²': 'ğŸ½ï¸',
'è³¼ç‰©': 'ğŸ›ï¸', 
'äº¤é€š': 'ğŸš—',
'è¶…å¸‚': 'ğŸ›’',
'å¨›æ¨‚': 'ğŸ®',
'é†«ç™‚': 'ğŸ’Š',
'æ•™è‚²': 'ğŸ“š',
'æœå‹™': 'âš™ï¸',
'å…¶ä»–': 'ğŸ“¦'
};

// è¨ˆç®—ç•¶å‰é€±æ¬¡ - ä½¿ç”¨å¯¦éš›çš„é€±æœŸæ™‚é–“è¡¨
function calculateCurrentWeek() {
const today = new Date().toISOString().split('T')[0];
return getWeekNumberFromDate(today);
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
const date = new Date(dateString);
return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
}

// æ ¹æ“šæ—¥æœŸç²å–é€±æ¬¡
function getWeekNumberFromDate(dateString) {
for (let i = 0; i < weekSchedule.length; i++) {
if (dateString >= weekSchedule[i].startDate && dateString <= weekSchedule[i].endDate) {
return i + 1;
}
}

// æª¢æŸ¥é€±æœ«
for (let i = 0; i < weekSchedule.length; i++) {
const resetDate = weekSchedule[i].resetDate;
const nextDay = new Date(resetDate);
nextDay.setDate(nextDay.getDate() + 1);
const nextDayStr = nextDay.toISOString().split('T')[0];

if (dateString === resetDate || dateString === nextDayStr) {
return i + 1;
}
}

return 1;
}

// åˆ¤æ–·å„ªæƒ åˆ¸æ˜¯å¦éæœŸ
function isVoucherExpired(voucher) {
const today = new Date();
today.setHours(0, 0, 0, 0);

const weekNum = getWeekNumberFromDate(voucher.date) - 1;
if (weekNum >= 0 && weekNum < weekSchedule.length) {
const saturday = new Date(weekSchedule[weekNum].resetDate);
const sunday = new Date(saturday);
sunday.setDate(saturday.getDate() + 1);
sunday.setHours(23, 59, 59, 999);

return today > sunday;
}

return false;
}

// è¨ˆç®—éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡
function getBankVoucherCount(bankId, weekNum) {
return appState.vouchers.filter(v =>
v.bankId === bankId && getWeekNumberFromDate(v.date) === weekNum
).length;
}

// ç²å–éŠ€è¡Œåç¨±
function getBankName(bankId) {
const bank = banks.find(b => b.id === bankId);
return bank ? bank.name : 'æœªçŸ¥éŠ€è¡Œ';
}

// åˆ¤æ–·å„ªæƒ åˆ¸æ˜¯å¦å¯å…‘æ›
function isVoucherRedeemable(voucher) {
if (voucher.amount === 0) return false;
return !voucher.used && !isVoucherExpired(voucher);
}

// åŠ è¼‰æ•¸æ“š
function loadAppState() {
try {
const savedState = localStorage.getItem('voucherAppState');
if (savedState) {
appState = JSON.parse(savedState);
if (!appState.selectedVouchers) appState.selectedVouchers = [];
if (!appState.redemptionHistory) appState.redemptionHistory = [];
if (!appState.nextRedemptionId) {
appState.nextRedemptionId = appState.redemptionHistory.length > 0 ?
Math.max(...appState.redemptionHistory.map(r => Number(r.displayId) || 0)) + 1 : 1;
}
if (!appState.bankDisplayFilter) {
appState.bankDisplayFilter = banks.map(bank => bank.id);
}
}

appState.currentWeek = calculateCurrentWeek();
} catch (e) {
console.error('Failed to load app state:', e);
}
}

// ä¿å­˜æ•¸æ“š
function saveAppState() {
try {
localStorage.setItem('voucherAppState', JSON.stringify(appState));
} catch (e) {
console.error('Failed to save app state:', e);
alert('å­˜å„²æ•¸æ“šå¤±æ•—ï¼Œå¯èƒ½æ˜¯å› ç‚ºç€è¦½å™¨å­˜å„²ç©ºé–“å·²æ»¿ï¼');
}
}

// æ›´æ–°æ—¥æœŸå’Œé€±æ¬¡é¡¯ç¤º
function updateDateDisplay() {
const today = new Date();
const currentDate = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
document.getElementById('current-date').textContent = currentDate;

const weekNum = appState.currentWeek;
const weekElem = document.getElementById('current-week');

if (weekNum === 0) {
weekElem.textContent = 'æ´»å‹•å°šæœªé–‹å§‹';
} else if (weekNum > 13) {
weekElem.textContent = 'æ´»å‹•å·²çµæŸ';
} else {
const weekData = weekSchedule[weekNum - 1];
weekElem.textContent = `ç¬¬${weekNum}é€± (${formatDate(weekData.startDate)} - ${formatDate(weekData.endDate)})`;
}
}

// æ›´æ–°éŠ€è¡ŒæŒ‰éˆ•
function updateBankButtons() {
const bankButtonsContainer = document.getElementById('bank-buttons');
bankButtonsContainer.innerHTML = '';

// åªæ˜¾ç¤ºåœ¨æ˜¾ç¤ºè¿‡æ»¤å™¨ä¸­çš„é“¶è¡Œ
const banksToShow = banks.filter(bank => 
appState.bankDisplayFilter && appState.bankDisplayFilter.includes(bank.id)
);

banksToShow.forEach(bank => {
const voucherCount = getBankVoucherCount(bank.id, appState.currentWeek);
const isDisabled = voucherCount >= 3;
const isSelected = !isDisabled && appState.preferredBank === bank.id;

const bankButton = document.createElement('div');
bankButton.className = `p-2 rounded-lg flex flex-col items-center ${
isDisabled ? 'opacity-50 cursor-default' : 'cursor-pointer'
} ${
isSelected ? `bg-${bank.color} text-white` : `bg-white dark:bg-gray-800 ${!isDisabled ? 'hover:bg-gray-100 dark:hover:bg-gray-700' : ''}`
}`;
bankButton.setAttribute('data-bank-id', bank.id);

bankButton.innerHTML = `
<i class="${bank.logo} text-2xl ${isSelected ? 'text-white' : `text-${bank.color} dark:text-${bank.color}`}"></i>
<div class="text-xs mt-1 ${isSelected ? 'text-white' : ''}">${bank.name}</div>
<div class="text-xs ${isSelected ? 'text-white' : 'text-gray-500 dark:text-gray-400'}">${voucherCount}/3</div>
`;

if (!isDisabled) {
bankButton.addEventListener('click', () => {
appState.preferredBank = bank.id;
saveAppState();
updateBankButtons();
updateQuickAddPanel();
});
}

bankButtonsContainer.appendChild(bankButton);
});
}

// æ›´æ–°å¿«é€Ÿæ·»åŠ é¢æ¿
function updateQuickAddPanel() {
const quickAddContainer = document.getElementById('quick-add-container');

if (appState.preferredBank) {
const bank = banks.find(b => b.id === appState.preferredBank);
document.getElementById('selected-bank-name-display').textContent = bank ? bank.name : 'éŠ€è¡Œ';

const voucherCount = getBankVoucherCount(appState.preferredBank, appState.currentWeek);
document.getElementById('total-draws').textContent = voucherCount;

const isDisabled = voucherCount >= 3;
document.querySelectorAll('.quick-add').forEach(btn => {
if (isDisabled) {
btn.classList.add('opacity-50', 'cursor-not-allowed');
btn.disabled = true;
} else {
btn.classList.remove('opacity-50', 'cursor-not-allowed');
btn.disabled = false;

btn.onclick = function() {
const amount = parseInt(this.getAttribute('data-amount'));
addVoucher(amount);
};
}
});

quickAddContainer.classList.remove('hidden');
} else {
quickAddContainer.classList.add('hidden');
}
}

// æ·»åŠ å„ªæƒ åˆ¸
function addVoucher(amount) {
const bankId = appState.preferredBank;
if (!bankId) {
alert('è«‹å…ˆé¸æ“‡éŠ€è¡Œï¼');
return;
}

const date = new Date().toISOString().split('T')[0];
const weekNum = getWeekNumberFromDate(date);

// æª¢æŸ¥æ˜¯å¦è¶…éæ¯é€±3å€‹å„ªæƒ åˆ¸é™åˆ¶
const voucherCount = getBankVoucherCount(bankId, weekNum);
if (voucherCount >= 3) {
alert(`${getBankName(bankId)}æœ¬é€±å·²é”3å¼µå„ªæƒ åˆ¸ä¸Šé™ï¼`);
return;
}

// å‰µå»ºæ–°å„ªæƒ åˆ¸
const newVoucher = {
id: Date.now().toString(),
amount: amount,
date: date,
used: false,
bankId: bankId
};

appState.vouchers.push(newVoucher);

saveAppState();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();

return true;
}

// æ›´æ–°éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½
function updateBankOverview() {
const bankOverviewList = document.getElementById('bank-overview-list');
bankOverviewList.innerHTML = '';

// è¨ˆç®—å„éŠ€è¡Œé¢å€¼åˆ†ä½ˆ
const bankDistribution = {};
banks.forEach(bank => {
bankDistribution[bank.id] = {
0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
count: 0, total: 0
};
});

// è¨ˆç®—ç¸½æ•¸æ“š
const totalCounts = { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0, count: 0, total: 0 };

// ç²å–ç•¶å‰é€±æ¬¡
const currentWeek = appState.currentWeek;

// çµ±è¨ˆå„éŠ€è¡Œå„ªæƒ åˆ¸ (åƒ…ç•¶å‰é€±æ¬¡)
appState.vouchers.forEach(voucher => {
if (voucher.bankId && getWeekNumberFromDate(voucher.date) === currentWeek) {
const bankData = bankDistribution[voucher.bankId];
if (bankData) {
bankData[voucher.amount]++;
bankData.count++;
if (voucher.amount > 0) bankData.total += voucher.amount;

totalCounts[voucher.amount]++;
totalCounts.count++;
if (voucher.amount > 0) totalCounts.total += voucher.amount;
}
}
});

if (totalCounts.count === 0) {
bankOverviewList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šæœªæ·»åŠ ä»»ä½•å„ªæƒ åˆ¸</div>';
return;
}

// æ·»åŠ ç¸½è¨ˆå¡ç‰‡
const totalCard = document.createElement('div');
totalCard.className = 'bg-primary-50 dark:bg-primary-900/30 border-primary border rounded-lg p-3';

totalCard.innerHTML = `
<div class="flex justify-between items-center mb-2 pb-2 border-b dark:border-gray-700">
<div class="font-bold">ç¸½è¨ˆ</div>
<div class="text-sm">${totalCounts.count}å¼µ (${totalCounts.total}å…ƒ)</div>
</div>

<div class="grid grid-cols-6 gap-1 text-center">
<div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 ${totalCounts[0] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[0]}</div>
<div class="text-xs">ğŸ˜„</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${totalCounts[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[10]}</div>
<div class="text-xs">10å…ƒ</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${totalCounts[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[20]}</div>
<div class="text-xs">20å…ƒ</div>
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 ${totalCounts[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[50]}</div>
<div class="text-xs">50å…ƒ</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${totalCounts[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[100]}</div>
<div class="text-xs">100å…ƒ</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${totalCounts[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[200]}</div>
<div class="text-xs">200å…ƒ</div>
</div>
</div>
`;

bankOverviewList.appendChild(totalCard);

// æ·»åŠ å„éŠ€è¡Œå¡ç‰‡
const banksToShow = banks.filter(bank => bankDistribution[bank.id].count > 0);
banksToShow.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));

banksToShow.forEach(bank => {
const data = bankDistribution[bank.id];

const bankCard = document.createElement('div');
bankCard.className = 'bg-white dark:bg-gray-800 border rounded-lg p-3';

bankCard.innerHTML = `
<div class="flex items-center justify-between mb-2 pb-2 border-b dark:border-gray-700">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-bold">${bank.name}</span>
</div>
<div class="text-sm">${data.count}å¼µ (${data.total}å…ƒ)</div>
</div>

<div class="grid grid-cols-6 gap-1 text-center">
<div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 ${data[0] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[0]}</div>
<div class="text-xs">ğŸ˜„</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${data[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[10]}</div>
<div class="text-xs">10å…ƒ</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${data[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[20]}</div>
<div class="text-xs">20å…ƒ</div>
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 ${data[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[50]}</div>
<div class="text-xs">50å…ƒ</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${data[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[100]}</div>
<div class="text-xs">100å…ƒ</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${data[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[200]}</div>
<div class="text-xs">200å…ƒ</div>
</div>
</div>
`;

bankOverviewList.appendChild(bankCard);
});
}

// æ›´æ–°å¯å…‘æ›å„ªæƒ åˆ¸åˆ—è¡¨
function updateRedeemableVouchers() {
const redeemableVouchersList = document.getElementById('redeemable-vouchers-list');
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

document.getElementById('unused-vouchers-count').textContent = redeemableVouchers.length;

if (redeemableVouchers.length === 0) {
redeemableVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>';
return;
}

// è¨ˆç®—å„é¢å€¼çš„å„ªæƒ åˆ¸æ•¸é‡
const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, total: 0, count: 0};

redeemableVouchers.forEach(voucher => {
valueCounts[voucher.amount]++;
valueCounts.count++;
valueCounts.total += voucher.amount;
});

// æ˜¾ç¤ºç¸½è¦½
redeemableVouchersList.innerHTML = `
<div class="flex justify-between items-center p-2 bg-primary-50 dark:bg-primary-900/20 rounded">
<div>ç¸½è¨ˆ</div>
<div class="text-right">${valueCounts.count}å¼µ (${valueCounts.total}å…ƒ)</div>
</div>

<div class="grid grid-cols-5 gap-1 text-center my-2">
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[10]}</div><div class="text-xs">10å…ƒ</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[20]}</div><div class="text-xs">20å…ƒ</div>
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 ${valueCounts[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[50]}</div><div class="text-xs">50å…ƒ</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[100]}</div><div class="text-xs">100å…ƒ</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[200]}</div><div class="text-xs">200å…ƒ</div>
</div>
</div>
`;
}

// æ›´æ–°å„ªæƒ åˆ¸é¸æ“‡å€åŸŸ
function updateVoucherSelection() {
const redeemedVoucherSelection = document.getElementById('redeem-voucher-selection');
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

if (redeemableVouchers.length === 0) {
redeemedVoucherSelection.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>';
return;
}

// æŒ‰éŠ€è¡Œåˆ†çµ„
const vouchersByBank = {};
redeemableVouchers.forEach(voucher => {
if (!vouchersByBank[voucher.bankId]) vouchersByBank[voucher.bankId] = [];
vouchersByBank[voucher.bankId].push(voucher);
});

redeemedVoucherSelection.innerHTML = '';

const sortedBanks = banks.filter(bank => vouchersByBank[bank.id]?.length > 0);

sortedBanks.forEach(bank => {
const bankVouchers = vouchersByBank[bank.id] || [];

const bankSection = document.createElement('div');
bankSection.className = 'border rounded-lg overflow-hidden';

bankSection.innerHTML = `
<div class="bg-${bank.color} bg-opacity-20 dark:bg-opacity-30 p-2 flex justify-between items-center">
<div class="flex items-center font-bold">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span>${bank.name}</span>
</div>
<div class="text-gray-700 dark:text-gray-300">${bankVouchers.length}å¼µ</div>
</div>
`;

// æŒ‰é¢å€¼åˆ†çµ„
const vouchersByAmount = {};
bankVouchers.forEach(voucher => {
if (!vouchersByAmount[voucher.amount]) vouchersByAmount[voucher.amount] = [];
vouchersByAmount[voucher.amount].push(voucher);
});

const vouchersList = document.createElement('div');
vouchersList.className = 'p-2 space-y-1 bg-white dark:bg-gray-800';

const amounts = [200, 100, 50, 20, 10].filter(a => vouchersByAmount[a]?.length > 0);

amounts.forEach(amount => {
const amountVouchers = vouchersByAmount[amount] || [];

vouchersList.innerHTML += `
<div class="flex justify-between items-center mb-1">
<div class="flex items-center">
<span class="inline-block w-12 text-center py-1 px-1 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700">
${amount}å…ƒ
</span>
</div>
<div class="text-gray-500 dark:text-gray-400">${amountVouchers.length}å¼µ</div>
</div>

<div class="ml-4 space-y-1 mt-1 mb-2">
${amountVouchers.map(voucher => `
<div class="flex items-center space-x-2">
<input type="checkbox" id="voucher-${voucher.id}" class="voucher-checkbox"
data-id="${voucher.id}" data-amount="${voucher.amount}"
${appState.selectedVouchers.includes(voucher.id) ? 'checked' : ''}>
<label for="voucher-${voucher.id}" class="text-sm">
${amount}å…ƒ å„ªæƒ åˆ¸
</label>
</div>
`).join('')}
</div>
`;
});

bankSection.appendChild(vouchersList);
redeemedVoucherSelection.appendChild(bankSection);
});

// æ·»åŠ è¤‡é¸æ¡†äº‹ä»¶
document.querySelectorAll('.voucher-checkbox').forEach(checkbox => {
checkbox.addEventListener('change', function() {
const voucherId = this.getAttribute('data-id');

if (this.checked) {
if (!appState.selectedVouchers.includes(voucherId)) {
appState.selectedVouchers.push(voucherId);
}
} else {
appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
}

saveAppState();
updateSelectedVouchers();
});
});
}

// æ›´æ–°å·²é¸æ“‡çš„å„ªæƒ åˆ¸åˆ—è¡¨
function updateSelectedVouchers() {
const redeemOperations = document.getElementById('redeem-operations');
const selectionSummary = document.getElementById('selection-summary');

const selectedVouchers = appState.selectedVouchers
.map(id => appState.vouchers.find(v => v.id === id))
.filter(isVoucherRedeemable);

document.getElementById('selected-vouchers-count').textContent = selectedVouchers.length;
document.getElementById('selected-vouchers-value').textContent = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);

if (selectedVouchers.length === 0) {
redeemOperations.classList.add('hidden');
selectionSummary.style.visibility = 'hidden';
} else {
redeemOperations.classList.remove('hidden');
selectionSummary.style.visibility = 'visible';

const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
document.getElementById('min-redeem-amount').textContent = totalValue * 3;
}

document.getElementById('redeem-selected-vouchers').onclick = function() {
const spendAmount = parseInt(document.getElementById('manual-spend-amount').value);
const remark = document.getElementById('redeem-remark').value.trim();
showRedeemConfirmation(spendAmount, remark);
};
}

// é¡¯ç¤ºå…‘æ›ç¢ºèª
function showRedeemConfirmation(userSpendAmount, remark) {
const selectedVouchers = appState.selectedVouchers
.map(id => appState.vouchers.find(v => v.id === id))
.filter(isVoucherRedeemable);

if (selectedVouchers.length === 0) {
alert('è«‹å…ˆé¸æ“‡è¦å…‘æ›çš„å„ªæƒ åˆ¸ï¼');
return;
}

const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
const requiredAmount = totalValue * 3;

if (userSpendAmount && userSpendAmount < requiredAmount) {
alert(`æ¶ˆè²»é‡‘é¡å¿…é ˆè‡³å°‘ç‚º${requiredAmount}å…ƒæ‰èƒ½å…‘æ›æ‰€é¸å„ªæƒ åˆ¸ï¼`);
return;
}

const spendAmount = userSpendAmount || requiredAmount;
const category = document.getElementById('consumption-category').value;

let infoHTML = `
<div class="mb-3">
<div class="font-medium">å„ªæƒ åˆ¸æ•¸é‡: ${selectedVouchers.length}å¼µ</div>
<div class="font-medium text-primary">æ¶ˆè²»é‡‘é¡: ${spendAmount}å…ƒ</div>
<div class="text-green-600 dark:text-green-400">ç¯€çœé‡‘é¡: ${totalValue}å…ƒ</div>
<div class="text-gray-500 dark:text-gray-400">è‡ªè²»é‡‘é¡: ${spendAmount - totalValue}å…ƒ</div>
</div>
`;

if (category) {
const categoryIcon = categoryIcons[category] || 'ğŸ“¦';
infoHTML += `<div class="mb-3">
<div class="font-medium">æ¶ˆè²»é¡åˆ¥:</div>
<div class="text-sm mt-1 p-2 bg-gray-50 dark:bg-gray-700 rounded flex items-center">
<span class="mr-2">${categoryIcon}</span>
<span>${category}</span>
</div>
</div>`;
}

if (remark) {
infoHTML += `<div class="mb-3">
<div class="font-medium">æ¶ˆè²»å‚™è¨»:</div>
<div class="text-sm mt-1 p-2 bg-gray-50 dark:bg-gray-700 rounded">${remark}</div>
</div>`;
}

document.getElementById('redeem-vouchers-info').innerHTML = infoHTML;
document.getElementById('confirm-redeem-modal').classList.remove('hidden');

tempSelectedVouchers = [...selectedVouchers];
tempRedeemRemark = remark;

document.getElementById('confirm-redeem').onclick = function() {
redeemVouchers(spendAmount, remark, category);
document.getElementById('confirm-redeem-modal').classList.add('hidden');
};

document.getElementById('cancel-redeem').onclick = function() {
document.getElementById('confirm-redeem-modal').classList.add('hidden');
};
}

// å…‘æ›å„ªæƒ åˆ¸
function redeemVouchers(spendAmount, remark, category) {
if (!tempSelectedVouchers || tempSelectedVouchers.length === 0) {
alert("å…‘æ›å¤±æ•—ï¼šæ²’æœ‰é¸ä¸­çš„å„ªæƒ åˆ¸");
return;
}

try {
const totalValue = tempSelectedVouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
const requiredAmount = totalValue * 3;

if (spendAmount < requiredAmount) {
alert(`æ¶ˆè²»é‡‘é¡å¿…é ˆè‡³å°‘ç‚º${requiredAmount}å…ƒæ‰èƒ½å…‘æ›æ‰€é¸å„ªæƒ åˆ¸ï¼`);
return;
}

// è¨˜éŒ„å…‘æ›æ­·å²
const redemption = {
id: Date.now().toString(),
displayId: appState.nextRedemptionId,
date: new Date().toISOString(),
vouchers: tempSelectedVouchers.map(v => ({
id: v.id,
amount: v.amount,
bankId: v.bankId
})),
voucherCount: tempSelectedVouchers.length,
voucherValue: totalValue,
spendAmount: spendAmount,
remark: tempRedeemRemark || remark,
category: category || null,
weekNum: appState.currentWeek
};

appState.redemptionHistory.push(redemption);
appState.nextRedemptionId++;

// æ¨™è¨˜å„ªæƒ åˆ¸ç‚ºå·²ä½¿ç”¨
tempSelectedVouchers.forEach(voucher => {
const v = appState.vouchers.find(v => v.id === voucher.id);
if (v) v.used = true;
});

// æ¸…ç©ºé¸æ“‡åˆ—è¡¨å’Œè¼¸å…¥æ¬„ä½
appState.selectedVouchers = [];
document.getElementById('manual-spend-amount').value = '';
document.getElementById('redeem-remark').value = '';
clearCategorySelection();

saveAppState();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();

alert(`æˆåŠŸå…‘æ›${tempSelectedVouchers.length}å¼µå„ªæƒ åˆ¸ï¼æ¶ˆè²»é‡‘é¡: ${spendAmount}å…ƒ`);
} catch (error) {
alert(`å…‘æ›å¤±æ•—ï¼š${error.message || "æœªçŸ¥éŒ¯èª¤"}`);
} finally {
tempSelectedVouchers = [];
tempRedeemRemark = '';
}
}

// æ›´æ–°å…‘æ›è¨˜éŒ„åˆ—è¡¨
function updateRedemptionHistory() {
const redemptionHistoryList = document.getElementById('redemption-history-list');
const redeemedTotalCount = document.getElementById('redeemed-total-count');

const totalRedeemed = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherCount, 0);
redeemedTotalCount.textContent = totalRedeemed;

if (appState.redemptionHistory.length === 0) {
redemptionHistoryList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">å°šç„¡å…‘æ›è¨˜éŒ„</div>';
return;
}

const sortedHistory = [...appState.redemptionHistory].sort((a, b) => new Date(b.date) - new Date(a.date));

redemptionHistoryList.innerHTML = '';

sortedHistory.forEach(redemption => {
const redemptionDate = new Date(redemption.date);

const card = document.createElement('div');
card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-3';

card.innerHTML = `
<div class="flex justify-between items-start mb-2">
<div class="font-bold">å…‘æ›è¨˜éŒ„ #${redemption.displayId.toString().padStart(4, '0')}</div>
<div class="flex items-center space-x-2">
<button class="withdraw-redemption text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" 
data-redemption-id="${redemption.id}" title="æ’¤å›å…Œæ›">
<i class="ri-arrow-go-back-line mr-1"></i>æ’¤å›
</button>
<div class="text-xs text-gray-500 dark:text-gray-400">${redemptionDate.toLocaleDateString()} ${redemptionDate.toLocaleTimeString()}</div>
</div>
</div>

<div class="grid grid-cols-2 gap-2 mb-2">
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">å„ªæƒ åˆ¸æ•¸é‡</div>
<div class="font-bold">${redemption.voucherCount}å¼µ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">ç¯€çœé‡‘é¡</div>
<div class="font-bold text-green-600 dark:text-green-400">${redemption.voucherValue}å…ƒ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">æ¶ˆè²»é‡‘é¡</div>
<div class="font-bold">${redemption.spendAmount}å…ƒ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">é€±æ¬¡</div>
<div class="font-bold">ç¬¬${redemption.weekNum}é€±</div>
</div>
</div>

${redemption.category ? `
<div class="mb-2">
<div class="text-xs text-gray-500 dark:text-gray-400">æ¶ˆè²»é¡åˆ¥</div>
<div class="text-sm border-t dark:border-gray-700 pt-1 flex items-center">
<span class="mr-2">${categoryIcons[redemption.category] || 'ğŸ“¦'}</span>
<span>${redemption.category}</span>
</div>
</div>
` : ''}
${redemption.remark ? `
<div class="mb-2">
<div class="text-xs text-gray-500 dark:text-gray-400">æ¶ˆè²»å‚™è¨»</div>
<div class="text-sm border-t dark:border-gray-700 pt-1">${redemption.remark}</div>
</div>
` : ''}
`;

redemptionHistoryList.appendChild(card);
});

// æ·»åŠ æ’¤å›å…Œæ›äº‹ä»¶ç›£è½å™¨
document.querySelectorAll('.withdraw-redemption').forEach(button => {
button.addEventListener('click', function() {
const redemptionId = this.getAttribute('data-redemption-id');
showWithdrawConfirmation(redemptionId);
});
});
}

// é¡¯ç¤ºæ’¤å›ç¢ºèªå°è©±æ¡†
function showWithdrawConfirmation(redemptionId) {
const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);
if (!redemption) {
alert('æ‰¾ä¸åˆ°å…Œæ›è¨˜éŒ„ï¼');
return;
}

// å‰µå»ºç¢ºèªå°è©±æ¡†
const modal = document.createElement('div');
modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
modal.innerHTML = `
<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
<h3 class="text-lg font-bold mb-4">ç¢ºèªæ’¤å›å…Œæ›</h3>
<div class="mb-4 text-sm">
<div class="mb-2">å…Œæ›è¨˜éŒ„ #${redemption.displayId.toString().padStart(4, '0')}</div>
<div class="text-gray-600 dark:text-gray-400">å„ªæƒ åˆ¸æ•¸é‡: ${redemption.voucherCount}å¼µ</div>
<div class="text-gray-600 dark:text-gray-400">æ¶ˆè²»é‡‘é¡: ${redemption.spendAmount}å…ƒ</div>
<div class="text-gray-600 dark:text-gray-400">ç¯€çœé‡‘é¡: ${redemption.voucherValue}å…ƒ</div>
</div>
<div class="text-sm text-red-600 dark:text-red-400 mb-4">
âš ï¸ æ’¤å›å¾Œï¼Œå„ªæƒ åˆ¸å°‡æ¢å¾©ç‚ºæœªä½¿ç”¨ç‹€æ…‹ï¼Œå…Œæ›è¨˜éŒ„å°‡è¢«åˆªé™¤
</div>
<div class="flex justify-end space-x-3">
<button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">å–æ¶ˆ</button>
<button class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded" onclick="withdrawRedemption('${redemptionId}'); this.closest('.fixed').remove()">ç¢ºèªæ’¤å›</button>
</div>
</div>
`;
document.body.appendChild(modal);
}

// æ’¤å›å…Œæ›åŠŸèƒ½
function withdrawRedemption(redemptionId) {
const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);
if (!redemption) {
alert('æ‰¾ä¸åˆ°å…Œæ›è¨˜éŒ„ï¼');
return;
}

try {
// æ¢å¾©å„ªæƒ åˆ¸ç‹€æ…‹
redemption.vouchers.forEach(voucherRecord => {
const voucher = appState.vouchers.find(v => v.id === voucherRecord.id);
if (voucher) {
voucher.used = false;
}
});

// å¾å…Œæ›æ­·å²ä¸­ç§»é™¤è¨˜éŒ„
const index = appState.redemptionHistory.findIndex(r => r.id === redemptionId);
if (index !== -1) {
appState.redemptionHistory.splice(index, 1);
}

// ä¿å­˜ç‹€æ…‹
saveAppState();

// æ›´æ–°æ‰€æœ‰UI
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();

alert(`å·²æˆåŠŸæ’¤å›å…Œæ›è¨˜éŒ„ #${redemption.displayId.toString().padStart(4, '0')}ï¼\n${redemption.voucherCount}å¼µå„ªæƒ åˆ¸å·²æ¢å¾©ç‚ºæœªä½¿ç”¨ç‹€æ…‹ã€‚`);
} catch (error) {
alert(`æ’¤å›å¤±æ•—ï¼š${error.message || "æœªçŸ¥éŒ¯èª¤"}`);
}
}

// æ›´æ–°ç¸½é«”çµ±è¨ˆ
function updateTotalStats() {
const totalCount = appState.vouchers.length;
const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
const usedCount = appState.vouchers.filter(v => v.used).length;
const totalRedeemable = appState.vouchers.filter(v => v.amount > 0).length;
const usageRate = totalRedeemable > 0 ? Math.round((usedCount / totalRedeemable) * 100) : 0;
const expiredCount = appState.vouchers.filter(v => !v.used && isVoucherExpired(v) && v.amount > 0).length;
const expiryRate = totalRedeemable > 0 ? Math.round((expiredCount / totalRedeemable) * 100) : 0;

document.getElementById('total-vouchers').textContent = `${totalCount}å¼µ`;
document.getElementById('total-value').textContent = `${totalValue}å…ƒ`;
document.getElementById('usage-rate').textContent = `${usageRate}%`;
document.getElementById('expiry-rate').textContent = `${expiryRate}%`;
}

// åˆå§‹åŒ–çµ±è¨ˆåˆ‡æ›åŠŸèƒ½
function initStatsToggle() {
// é¢å€¼åˆ†ä½ˆåœ–è¡¨åˆ‡æ›
document.getElementById('value-chart-total-btn').addEventListener('click', function() {
document.getElementById('value-chart-total-btn').className = 'flex-1 py-1 px-2 text-center rounded bg-primary text-white text-xs';
document.getElementById('value-chart-bank-btn').className = 'flex-1 py-1 px-2 text-center rounded text-gray-600 dark:text-gray-300 text-xs';
updateValueChart('total');
});

document.getElementById('value-chart-bank-btn').addEventListener('click', function() {
document.getElementById('value-chart-bank-btn').className = 'flex-1 py-1 px-2 text-center rounded bg-primary text-white text-xs';
document.getElementById('value-chart-total-btn').className = 'flex-1 py-1 px-2 text-center rounded text-gray-600 dark:text-gray-300 text-xs';
updateValueChart('bank');
});
}

// æ›´æ–°é¢å€¼åˆ†ä½ˆåœ–è¡¨
function updateValueChart(mode = 'total') {
if (!valueChart) return;

if (mode === 'total') {
// ç¸½é«”é¢å€¼åˆ†ä½ˆ
const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, 0: 0};

appState.vouchers.forEach(voucher => {
if (valueCounts.hasOwnProperty(voucher.amount)) {
valueCounts[voucher.amount]++;
}
});

// é‡æ–°é…ç½®ç‚ºæ™®é€šæŸ±ç‹€åœ–
valueChart.config.type = 'bar';
valueChart.data.labels = ['10å…ƒ', '20å…ƒ', '50å…ƒ', '100å…ƒ', '200å…ƒ', 'ğŸ˜„'];
valueChart.data.datasets = [{
label: 'æ•¸é‡',
data: [
valueCounts[10], valueCounts[20], valueCounts[50],
valueCounts[100], valueCounts[200], valueCounts[0]
],
backgroundColor: ['#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc', '#fbbf24'],
borderRadius: 4,
borderSkipped: false
}];

// æ›´æ–°åœ–è¡¨é¸é …
valueChart.options = {
responsive: true,
maintainAspectRatio: false,
plugins: { 
legend: { display: false }
},
scales: { 
y: { 
beginAtZero: true, 
ticks: { precision: 0 },
stacked: false
},
x: { 
grid: { display: false },
stacked: false
}
}
};
} else {
// æŒ‰éŠ€è¡Œåˆ†çµ„çš„é¢å€¼åˆ†ä½ˆ
const bankValueData = {};
const amounts = [10, 20, 50, 100, 200, 0];

banks.forEach(bank => {
bankValueData[bank.id] = {};
amounts.forEach(amount => {
bankValueData[bank.id][amount] = 0;
});
});

appState.vouchers.forEach(voucher => {
if (bankValueData[voucher.bankId] && amounts.includes(voucher.amount)) {
bankValueData[voucher.bankId][voucher.amount]++;
}
});

// å‰µå»ºå †ç–ŠæŸ±ç‹€åœ–æ•¸æ“š
const datasets = [];
const bankColors = {
'boc': '#c1272d', 'icbc': '#c7000a', 'luso': '#00529b', 'bnu': '#5D5CDE',
'macaupass': '#0c6e4f', 'ant': '#2c64ae', 'mpay': '#1e469a', 'gdb': '#e83828'
};

banks.forEach(bank => {
const hasData = amounts.some(amount => bankValueData[bank.id][amount] > 0);
if (hasData) {
datasets.push({
label: bank.name,
data: amounts.map(amount => bankValueData[bank.id][amount]),
backgroundColor: bankColors[bank.id] || '#6b7280',
borderRadius: 2,
borderSkipped: false
});
}
});

// é‡æ–°é…ç½®ç‚ºå †ç–ŠæŸ±ç‹€åœ–
valueChart.config.type = 'bar';
valueChart.data.labels = ['10å…ƒ', '20å…ƒ', '50å…ƒ', '100å…ƒ', '200å…ƒ', 'ğŸ˜„'];
valueChart.data.datasets = datasets;

// æ›´æ–°åœ–è¡¨é¸é …ç‚ºå †ç–Šæ¨¡å¼
valueChart.options = {
responsive: true,
maintainAspectRatio: false,
plugins: { 
legend: { 
display: true,
position: 'bottom',
labels: { boxWidth: 12, font: { size: 10 }, padding: 8 }
}
},
scales: { 
y: { 
beginAtZero: true, 
ticks: { precision: 0 },
stacked: true
},
x: { 
grid: { display: false },
stacked: true
}
}
};
}

valueChart.update();
}

// åˆå§‹åŒ–åœ–è¡¨
function initCharts() {
Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';

// ç‹€æ…‹åˆ†ä½ˆåœ–è¡¨
const statusCtx = document.getElementById('status-chart').getContext('2d');
statusChart = new Chart(statusCtx, {
type: 'doughnut',
data: {
labels: ['æœªä½¿ç”¨', 'å·²å…‘æ›', 'å·²éæœŸ'],
datasets: [{
data: [0, 0, 0],
backgroundColor: ['#86efac', '#60a5fa', '#f87171'],
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { 
position: 'bottom', 
labels: { boxWidth: 12, font: { size: 11 }, padding: 15 }
}
},
cutout: '60%'
}
});

// é¢å€¼åˆ†ä½ˆåœ–è¡¨
const valueCtx = document.getElementById('value-chart').getContext('2d');
valueChart = new Chart(valueCtx, {
type: 'bar',
data: {
labels: ['10å…ƒ', '20å…ƒ', '50å…ƒ', '100å…ƒ', '200å…ƒ', 'ğŸ˜„'],
datasets: [{
label: 'æ•¸é‡',
data: [0, 0, 0, 0, 0, 0],
backgroundColor: ['#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc', '#fbbf24'],
borderRadius: 4,
borderSkipped: false
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { display: false } },
scales: { 
y: { beginAtZero: true, ticks: { precision: 0 } },
x: { grid: { display: false } }
}
}
});

// éŠ€è¡Œåˆ†ä½ˆåœ–è¡¨
const bankCtx = document.getElementById('bank-chart').getContext('2d');
bankChart = new Chart(bankCtx, {
type: 'pie',
data: {
labels: [],
datasets: [{
data: [],
backgroundColor: [
'#c1272d', '#c7000a', '#00529b', '#5D5CDE', 
'#0c6e4f', '#2c64ae', '#1e469a', '#e83828'
],
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { 
position: 'bottom',
labels: { boxWidth: 12, font: { size: 10 }, padding: 10 }
}
}
}
});

// é€±æ¬¡è¶¨å‹¢åœ–è¡¨
const weeklyCtx = document.getElementById('weekly-trend-chart').getContext('2d');
weeklyTrendChart = new Chart(weeklyCtx, {
type: 'line',
data: {
labels: [],
datasets: [{
label: 'ç²å¾—é‡‘é¡ (å…ƒ)',
data: [],
borderColor: '#60a5fa',
backgroundColor: 'rgba(96, 165, 250, 0.1)',
fill: true,
tension: 0.4
}, {
label: 'å…‘æ›é‡‘é¡ (å…ƒ)',
data: [],
borderColor: '#34d399',
backgroundColor: 'rgba(52, 211, 153, 0.1)',
fill: true,
tension: 0.4
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { 
position: 'top',
labels: { boxWidth: 12, font: { size: 11 } }
}
},
scales: {
y: { beginAtZero: true, ticks: { precision: 0 } },
x: { grid: { display: false } }
}
}
});

// æ¶ˆè²»é¡åˆ¥åœ–è¡¨
const categoryCtx = document.getElementById('category-chart').getContext('2d');
categoryChart = new Chart(categoryCtx, {
type: 'doughnut',
data: {
labels: consumptionCategories,
datasets: [{
data: [],
backgroundColor: [
'#ef4444', '#f97316', '#eab308', 
'#22c55e', '#06b6d4', '#8b5cf6'
],
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { 
position: 'bottom',
labels: { boxWidth: 12, font: { size: 11 }, padding: 15 }
}
},
cutout: '50%'
}
});

updateCharts();
}

// æ›´æ–°åœ–è¡¨
function updateCharts() {
if (!statusChart || !valueChart || !bankChart || !weeklyTrendChart || !categoryChart) return;

// è¨ˆç®—å„ªæƒ åˆ¸ç‹€æ…‹åˆ†ä½ˆ (æ’é™¤ç¬‘è‡‰)
const statusCounts = [0, 0, 0]; // æœªä½¿ç”¨, å·²å…‘æ›, å·²éæœŸ

appState.vouchers.forEach(voucher => {
if (voucher.amount > 0) {
if (voucher.used) {
statusCounts[1]++; // å·²å…‘æ›
} else if (isVoucherExpired(voucher)) {
statusCounts[2]++; // å·²éæœŸ
} else {
statusCounts[0]++; // æœªä½¿ç”¨
}
}
});

statusChart.data.datasets[0].data = statusCounts;
statusChart.update();

// è¨ˆç®—é¢å€¼åˆ†ä½ˆ
const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, 0: 0};

appState.vouchers.forEach(voucher => {
if (valueCounts.hasOwnProperty(voucher.amount)) {
valueCounts[voucher.amount]++;
}
});

valueChart.data.datasets[0].data = [
valueCounts[10], valueCounts[20], valueCounts[50],
valueCounts[100], valueCounts[200], valueCounts[0]
];
valueChart.update();

// è¨ˆç®—éŠ€è¡Œåˆ†ä½ˆ (æŒ‰é‡‘é¡)
const bankAmounts = {};
banks.forEach(bank => bankAmounts[bank.id] = 0);

appState.vouchers.forEach(voucher => {
if (bankAmounts.hasOwnProperty(voucher.bankId)) {
bankAmounts[voucher.bankId] += voucher.amount;
}
});

const bankLabels = [];
const bankData = [];
banks.forEach(bank => {
if (bankAmounts[bank.id] > 0) {
bankLabels.push(bank.name);
bankData.push(bankAmounts[bank.id]);
}
});

bankChart.data.labels = bankLabels;
bankChart.data.datasets[0].data = bankData;
bankChart.update();

// è¨ˆç®—é€±æ¬¡è¶¨å‹¢
const weeklyData = { earned: [], redeemed: [] };
const weekLabels = [];

for (let week = 1; week <= 13; week++) {
weekLabels.push(`ç¬¬${week}é€±`);

// è¨ˆç®—è©²é€±ç²å¾—çš„å„ªæƒ åˆ¸ç¸½é‡‘é¡
const earnedAmount = appState.vouchers.filter(v => 
getWeekNumberFromDate(v.date) === week
).reduce((sum, v) => sum + v.amount, 0);
weeklyData.earned.push(earnedAmount);

// è¨ˆç®—è©²é€±å…‘æ›çš„å„ªæƒ åˆ¸ç¸½é‡‘é¡
const redeemedAmount = appState.redemptionHistory.filter(r => 
r.weekNum === week
).reduce((sum, r) => sum + r.voucherValue, 0);
weeklyData.redeemed.push(redeemedAmount);
}

weeklyTrendChart.data.labels = weekLabels;
weeklyTrendChart.data.datasets[0].data = weeklyData.earned;
weeklyTrendChart.data.datasets[1].data = weeklyData.redeemed;
weeklyTrendChart.update();

// è¨ˆç®—æ¶ˆè²»é¡åˆ¥åˆ†ä½ˆ (åŸºæ–¼é¸æ“‡çš„é¡åˆ¥å’Œå‚™è¨»é—œéµå­—)
const categoryCounts = {};
consumptionCategories.forEach(cat => categoryCounts[cat] = 0);

appState.redemptionHistory.forEach(redemption => {
let finalCategory = 'å…¶ä»–';

// å„ªå…ˆä½¿ç”¨æ‰‹å‹•é¸æ“‡çš„é¡åˆ¥
if (redemption.category && consumptionCategories.includes(redemption.category)) {
finalCategory = redemption.category;
} else if (redemption.remark) {
// å›é€€åˆ°åŸºæ–¼é—œéµå­—çš„è‡ªå‹•åˆ†é¡
const remark = redemption.remark.toLowerCase();

if (remark.includes('é¤') || remark.includes('é£Ÿ') || remark.includes('é£¯') || remark.includes('èŒ¶') || remark.includes('å’–å•¡') || remark.includes('é…’')) {
finalCategory = 'é¤é£²';
} else if (remark.includes('è³¼') || remark.includes('è²·') || remark.includes('å•†åº—') || remark.includes('åº—') || remark.includes('è¡£') || remark.includes('é‹')) {
finalCategory = 'è³¼ç‰©';
} else if (remark.includes('è»Š') || remark.includes('å·´å£«') || remark.includes('çš„å£«') || remark.includes('äº¤é€š') || remark.includes('æ²¹') || remark.includes('æ³Šè»Š')) {
finalCategory = 'äº¤é€š';
} else if (remark.includes('è¶…å¸‚') || remark.includes('å¸‚å ´') || remark.includes('èœ') || remark.includes('é›œè²¨') || remark.includes('ç”Ÿæ´»ç”¨å“')) {
finalCategory = 'è¶…å¸‚';
} else if (remark.includes('å¨›æ¨‚') || remark.includes('é›»å½±') || remark.includes('éŠæˆ²') || remark.includes('ç©') || remark.includes('é‹å‹•') || remark.includes('å¥èº«')) {
finalCategory = 'å¨›æ¨‚';
} else if (remark.includes('é†«') || remark.includes('è—¥') || remark.includes('è¨ºæ‰€') || remark.includes('é†«é™¢') || remark.includes('å¥åº·')) {
finalCategory = 'é†«ç™‚';
} else if (remark.includes('å­¸') || remark.includes('æ•™') || remark.includes('æ›¸') || remark.includes('èª²ç¨‹') || remark.includes('åŸ¹è¨“')) {
finalCategory = 'æ•™è‚²';
} else if (remark.includes('æœå‹™') || remark.includes('ä¿®ç†') || remark.includes('ç¶­ä¿®') || remark.includes('æ¸…æ½”') || remark.includes('ç¾å®¹')) {
finalCategory = 'æœå‹™';
}
}

categoryCounts[finalCategory] += redemption.voucherCount;
});

const categoryData = consumptionCategories.map(cat => categoryCounts[cat]);
const hasData = categoryData.some(count => count > 0);

if (hasData) {
categoryChart.data.datasets[0].data = categoryData;
categoryChart.data.datasets[0].backgroundColor = [
'#ef4444', '#f97316', '#eab308', '#22c55e', 
'#06b6d4', '#8b5cf6', '#ec4899', '#64748b', '#6b7280'
];
} else {
// å¦‚æœæ²’æœ‰æ¶ˆè²»è¨˜éŒ„ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
categoryChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0, 0, 1];
categoryChart.data.datasets[0].backgroundColor = [
'#ef4444', '#f97316', '#eab308', '#22c55e', 
'#06b6d4', '#8b5cf6', '#ec4899', '#64748b', '#d1d5db'
];
}
categoryChart.update();

// æ›´æ–°é¡åˆ¥è©³ç´°çµ±è¨ˆ
updateCategoryDetails(categoryCounts, hasData);
}

// æ›´æ–°é¡åˆ¥è©³ç´°çµ±è¨ˆ
function updateCategoryDetails(categoryCounts, hasData) {
const categoryDetails = document.getElementById('category-details');
if (!categoryDetails) return;

if (!hasData) {
categoryDetails.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 text-sm">å°šæœªæœ‰æ¶ˆè²»è¨˜éŒ„</div>';
return;
}

// è¨ˆç®—ç¸½æ¶ˆè²»é‡‘é¡å’Œå„ªæƒ åˆ¸æ•¸é‡
let totalSpent = 0;
let totalVouchers = 0;

appState.redemptionHistory.forEach(redemption => {
totalSpent += redemption.spendAmount;
totalVouchers += redemption.voucherCount;
});

// æŒ‰ä½¿ç”¨æ¬¡æ•¸æ’åºé¡åˆ¥
const sortedCategories = consumptionCategories
.map(cat => ({ name: cat, count: categoryCounts[cat] }))
.filter(cat => cat.count > 0)
.sort((a, b) => b.count - a.count);

let detailsHTML = `
<div class="grid grid-cols-2 gap-3 mb-3">
<div class="text-center">
<div class="text-xs text-gray-500 dark:text-gray-400">ç¸½æ¶ˆè²»</div>
<div class="font-bold text-lg">${totalSpent}å…ƒ</div>
</div>
<div class="text-center">
<div class="text-xs text-gray-500 dark:text-gray-400">ç¸½ç¯€çœ</div>
<div class="font-bold text-lg text-green-600 dark:text-green-400">${appState.redemptionHistory.reduce((sum, r) => sum + r.voucherValue, 0)}å…ƒ</div>
</div>
</div>
<div class="space-y-2">
`;

sortedCategories.forEach(category => {
const percentage = Math.round((category.count / totalVouchers) * 100);
const icon = categoryIcons[category.name] || 'ğŸ“¦';

detailsHTML += `
<div class="flex items-center justify-between text-sm">
<div class="flex items-center">
<span class="mr-2">${icon}</span>
<span>${category.name}</span>
</div>
<div class="flex items-center space-x-2">
<span class="text-gray-500 dark:text-gray-400">${category.count}å¼µ</span>
<span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">${percentage}%</span>
</div>
</div>
`;
});

detailsHTML += '</div>';
categoryDetails.innerHTML = detailsHTML;
}

// åˆå§‹åŒ–é¸é …å¡åŠŸèƒ½
function initTabs() {
const tabButtons = document.querySelectorAll('#tabs button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
button.addEventListener('click', function() {
const tabName = this.getAttribute('data-tab');

tabButtons.forEach(btn => {
btn.classList.remove('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
});

this.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
this.classList.add('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');

tabContents.forEach(content => {
content.classList.add('hidden');
});

document.getElementById(`${tabName}-content`).classList.remove('hidden');

if (tabName === 'stats') {
updateCharts();
}
});
});
}

// åˆå§‹åŒ–éŠ€è¡Œé¡¯ç¤ºéæ¿¾å™¨
function initBankFilters() {
const bankFiltersContainer = document.getElementById('bank-filters');
if (!bankFiltersContainer) return;

bankFiltersContainer.innerHTML = '';

if (!appState.bankDisplayFilter) {
appState.bankDisplayFilter = banks.map(bank => bank.id);
}

banks.forEach(bank => {
const isSelected = appState.bankDisplayFilter.includes(bank.id);

const filterBtn = document.createElement('button');
filterBtn.className = `text-xs px-2 py-1 rounded-full flex items-center ${
isSelected ? 'bg-' + bank.color + ' text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
}`;
filterBtn.setAttribute('data-bank', bank.id);
filterBtn.innerHTML = `<i class="${bank.logo} mr-1"></i> ${bank.name}`;

filterBtn.addEventListener('click', function() {
const bankId = this.getAttribute('data-bank');
if (appState.bankDisplayFilter.includes(bankId)) {
appState.bankDisplayFilter = appState.bankDisplayFilter.filter(id => id !== bankId);
} else {
appState.bankDisplayFilter.push(bankId);
}
saveAppState();
initBankFilters();
});

bankFiltersContainer.appendChild(filterBtn);
});
}

// æ›´æ–°ç®¡ç†æ¨¡å¼çš„å„ªæƒ åˆ¸è¨ˆæ•¸
function updateAdminVoucherCounts() {
const selectedWeek = parseInt(document.getElementById('admin-week-select').value);
const selectedBank = document.getElementById('admin-bank-select').value;

if (isNaN(selectedWeek) || !selectedBank) return;

const voucherCounts = { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0 };

appState.vouchers.forEach(voucher => {
if (voucher.bankId === selectedBank && getWeekNumberFromDate(voucher.date) === selectedWeek) {
voucherCounts[voucher.amount]++;
}
});

document.getElementById('admin-0-count').textContent = voucherCounts[0];
document.getElementById('admin-10-count').textContent = voucherCounts[10];
document.getElementById('admin-20-count').textContent = voucherCounts[20];
document.getElementById('admin-50-count').textContent = voucherCounts[50];
document.getElementById('admin-100-count').textContent = voucherCounts[100];
document.getElementById('admin-200-count').textContent = voucherCounts[200];
}

// åˆªé™¤ç‰¹å®šéŠ€è¡Œç‰¹å®šé‡‘é¡çš„å„ªæƒ åˆ¸ (çµ¦ç®¡ç†æ¨¡å¼ä½¿ç”¨)
function deleteVoucherByBankAndAmount(bankId, amount, weekNum) {
const voucher = [...appState.vouchers]
.filter(v =>
v.bankId === bankId &&
v.amount === amount &&
getWeekNumberFromDate(v.date) === weekNum
).pop();

if (voucher) {
const index = appState.vouchers.indexOf(voucher);
if (index !== -1) {
appState.vouchers.splice(index, 1);
appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucher.id);
saveAppState();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();
updateAdminVoucherCounts();
return true;
}
}
return false;
}

// å„ªæƒ åˆ¸è¨ˆç®—ç®—æ³•
function calculateVouchersByRule(amount, rule) {
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

if (redeemableVouchers.length === 0) {
return { vouchers: [], error: 'æ‚¨ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸' };
}

const maxValue = Math.floor(amount / 3);
let bestVouchers = [];

switch(rule) {
case 'max-value':
// æœ€å¤§ç¯€çœ - èƒŒåŒ…å•é¡Œå‹•æ…‹è¦åŠƒ
bestVouchers = calculateMaxValue(redeemableVouchers, maxValue);
break;
case 'max-quantity':
// æœ€å¤šå„ªæƒ åˆ¸ - å„ªå…ˆé¸æ“‡å°é¢å€¼
bestVouchers = calculateMaxQuantity(redeemableVouchers, maxValue);
break;
case 'high-value':
// å„ªå…ˆé«˜é¢å€¼ - å¾å¤§åˆ°å°é¸æ“‡
bestVouchers = calculateHighValue(redeemableVouchers, maxValue);
break;
case 'same-bank':
// åŒè¡Œå„ªæƒ åˆ¸ - å„ªå…ˆä½¿ç”¨åŒä¸€éŠ€è¡Œçš„å„ªæƒ åˆ¸
bestVouchers = calculateSameBank(redeemableVouchers, maxValue);
break;
}

if (bestVouchers.length === 0) {
// æ‰¾æœ€æ¥è¿‘çš„å–®å¼µå„ªæƒ åˆ¸
let closestVoucher = null;
let smallestDiff = Infinity;

for (const voucher of redeemableVouchers) {
const diff = voucher.amount * 3 - amount;
if (diff > 0 && diff < smallestDiff) {
smallestDiff = diff;
closestVoucher = voucher;
}
}

if (closestVoucher) {
return { 
vouchers: [], 
closest: closestVoucher,
shortfall: closestVoucher.amount * 3 - amount
};
} else {
return { vouchers: [], error: 'æ¶ˆè²»é‡‘é¡ä¸è¶³ä»¥å…‘æ›ä»»ä½•å„ªæƒ åˆ¸' };
}
}

return { vouchers: bestVouchers };
}

// æœ€å¤§ç¯€çœç®—æ³•
function calculateMaxValue(vouchers, maxValue) {
const dp = new Array(maxValue + 1).fill(0);
const selected = new Array(maxValue + 1).fill(null).map(() => []);

for (const voucher of vouchers) {
for (let j = maxValue; j >= voucher.amount; j--) {
const newValue = dp[j - voucher.amount] + voucher.amount;
if (newValue > dp[j]) {
dp[j] = newValue;
selected[j] = [...selected[j - voucher.amount], voucher];
}
}
}

return selected[maxValue] || [];
}

// æœ€å¤šå„ªæƒ åˆ¸ç®—æ³•
function calculateMaxQuantity(vouchers, maxValue) {
// æŒ‰é¢å€¼å¾å°åˆ°å¤§æ’åº
const sortedVouchers = [...vouchers].sort((a, b) => a.amount - b.amount);
const result = [];
let remaining = maxValue;

for (const voucher of sortedVouchers) {
if (voucher.amount <= remaining) {
result.push(voucher);
remaining -= voucher.amount;
}
}

return result;
}

// å„ªå…ˆé«˜é¢å€¼ç®—æ³•
function calculateHighValue(vouchers, maxValue) {
// æŒ‰é¢å€¼å¾å¤§åˆ°å°æ’åº
const sortedVouchers = [...vouchers].sort((a, b) => b.amount - a.amount);
const result = [];
let remaining = maxValue;

for (const voucher of sortedVouchers) {
if (voucher.amount <= remaining) {
result.push(voucher);
remaining -= voucher.amount;
}
}

return result;
}

// åŒè¡Œå„ªæƒ åˆ¸ç®—æ³•
function calculateSameBank(vouchers, maxValue) {
// æŒ‰éŠ€è¡Œåˆ†çµ„
const vouchersByBank = {};
vouchers.forEach(voucher => {
if (!vouchersByBank[voucher.bankId]) {
vouchersByBank[voucher.bankId] = [];
}
vouchersByBank[voucher.bankId].push(voucher);
});

let bestResult = [];
let bestValue = 0;
let bestBankName = '';

// å˜—è©¦æ¯å€‹éŠ€è¡Œ
Object.entries(vouchersByBank).forEach(([bankId, bankVouchers]) => {
// å°ç•¶å‰éŠ€è¡Œçš„å„ªæƒ åˆ¸ä½¿ç”¨æœ€å¤§ç¯€çœç®—æ³•
const bankResult = calculateMaxValue(bankVouchers, maxValue);
const bankValue = bankResult.reduce((sum, v) => sum + v.amount, 0);

// å¦‚æœé€™å€‹éŠ€è¡Œçš„çµæœæ›´å¥½ï¼Œå‰‡æ›¿æ›
if (bankValue > bestValue || (bankValue === bestValue && bankResult.length > bestResult.length)) {
bestResult = bankResult;
bestValue = bankValue;
bestBankName = getBankName(bankId);
}
});

// å¦‚æœå–®ä¸€éŠ€è¡Œç„¡æ³•æ»¿è¶³ï¼Œå‰‡ç”¨æ··åˆç­–ç•¥ä½†å„ªå…ˆå·²é¸éŠ€è¡Œ
if (bestResult.length === 0 || bestValue < maxValue * 0.7) {
// æ‰¾å‡ºå„ªæƒ åˆ¸æœ€å¤šçš„éŠ€è¡Œä½œç‚ºä¸»éŠ€è¡Œ
let mainBankId = '';
let maxBankVouchers = 0;
Object.entries(vouchersByBank).forEach(([bankId, bankVouchers]) => {
const bankValue = bankVouchers.reduce((sum, v) => sum + v.amount, 0);
if (bankValue > maxBankVouchers) {
maxBankVouchers = bankValue;
mainBankId = bankId;
}
});

// å„ªå…ˆä½¿ç”¨ä¸»éŠ€è¡Œï¼Œç„¶å¾Œè£œå……å…¶ä»–éŠ€è¡Œ
const result = [];
let remaining = maxValue;

// å…ˆå¾ä¸»éŠ€è¡Œé¸å–
if (mainBankId && vouchersByBank[mainBankId]) {
const mainBankResult = calculateMaxValue(vouchersByBank[mainBankId], remaining);
result.push(...mainBankResult);
remaining -= mainBankResult.reduce((sum, v) => sum + v.amount, 0);
}

// å¦‚æœé‚„æœ‰å‰©é¤˜ç©ºé–“ï¼Œå¾å…¶ä»–éŠ€è¡Œè£œå……
if (remaining > 0) {
const otherVouchers = [];
Object.entries(vouchersByBank).forEach(([bankId, bankVouchers]) => {
if (bankId !== mainBankId) {
otherVouchers.push(...bankVouchers);
}
});

if (otherVouchers.length > 0) {
const supplementResult = calculateMaxValue(otherVouchers, remaining);
result.push(...supplementResult);
}
}

return result;
}

return bestResult;
}

// åˆå§‹åŒ–å„ªæƒ åˆ¸è¨ˆç®—å™¨
function initVoucherCalculator() {
// æœ€å¤§ç¯€çœæŒ‰éˆ•
document.getElementById('calculate-max-value').addEventListener('click', function() {
const amount = parseInt(document.getElementById('payment-amount').value);
if (isNaN(amount) || amount <= 0) {
alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¶ˆè²»é‡‘é¡ï¼');
return;
}

// ç²å–æœªä½¿ç”¨çš„å„ªæƒ åˆ¸ï¼ˆæ’é™¤ç¬‘è‡‰0å…ƒå„ªæƒ åˆ¸ï¼‰
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

if (redeemableVouchers.length === 0) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-red-500 dark:text-red-400">ç„¡æ³•æ‰¾åˆ°åˆé©çš„å„ªæƒ åˆ¸çµ„åˆ</div>
<div class="text-sm text-gray-500 dark:text-gray-400">æ‚¨ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>
</div>
`;
document.getElementById('recommendation-result').classList.remove('hidden');
return;
}

// ä½¿ç”¨èƒŒåŒ…å•é¡Œè§£æ±ºå„ªæƒ åˆ¸é¸æ“‡å•é¡Œ
const maxValue = Math.floor(amount / 3);
const sortedVouchers = [...redeemableVouchers].sort((a, b) => a.amount - b.amount);

// å‹•æ…‹è¦åŠƒæ±‚è§£
const dp = new Array(maxValue + 1).fill(0);
const selected = new Array(maxValue + 1).fill(null).map(() => []);

for (const voucher of sortedVouchers) {
for (let j = maxValue; j >= voucher.amount; j--) {
const newValue = dp[j - voucher.amount] + voucher.amount;
if (newValue > dp[j]) {
dp[j] = newValue;
selected[j] = [...selected[j - voucher.amount], voucher];
}
}
}

const bestVouchers = selected[maxValue];

if (bestVouchers.length === 0) {
// æ‰¾ä¸åˆ°å®Œå…¨åŒ¹é…çš„çµ„åˆï¼Œçœ‹æ˜¯å¦éœ€è¦å¤šæ¶ˆè²»
let closestVoucher = null;
let smallestDiff = Infinity;

for (const voucher of redeemableVouchers) {
const diff = voucher.amount * 3 - amount;
if (diff > 0 && diff < smallestDiff) {
smallestDiff = diff;
closestVoucher = voucher;
}
}

if (closestVoucher) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-yellow-500 dark:text-yellow-400">æ¶ˆè²»é‡‘é¡ä¸è¶³</div>
<div class="text-sm mb-3">
æœ€æ¥è¿‘çš„å„ªæƒ åˆ¸ç‚º${closestVoucher.amount}å…ƒï¼Œéœ€æ¶ˆè²»${closestVoucher.amount * 3}å…ƒ
</div>
<div class="text-sm">æ‚¨é‚„éœ€å¢åŠ ${closestVoucher.amount * 3 - amount}å…ƒæ¶ˆè²»é‡‘é¡</div>
<button id="use-closest-voucher" class="mt-3 w-full py-2 bg-primary text-white rounded-lg">
é¸æ“‡ä½¿ç”¨${closestVoucher.amount}å…ƒå„ªæƒ åˆ¸
</button>
</div>
`;

document.getElementById('use-closest-voucher').onclick = function() {
appState.selectedVouchers = [closestVoucher.id];
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();
document.querySelector('[data-tab="redeem"]').click();
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
document.getElementById('manual-spend-amount').value = closestVoucher.amount * 3;
};
} else {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-red-500 dark:text-red-400">ç„¡æ³•æ‰¾åˆ°åˆé©çš„å„ªæƒ åˆ¸çµ„åˆ</div>
<div class="text-sm text-gray-500 dark:text-gray-400">æ¶ˆè²»é‡‘é¡ä¸è¶³ä»¥å…‘æ›ä»»ä½•å„ªæƒ åˆ¸</div>
</div>
`;
}
} else {
// è¨ˆç®—ç¸½å€¼å’Œæ‰€éœ€æ¶ˆè²»é‡‘é¡
const totalValue = bestVouchers.reduce((sum, v) => sum + v.amount, 0);
const requiredAmount = totalValue * 3;

// æŒ‰éŠ€è¡Œåˆ†çµ„
const bankVouchers = {};
bestVouchers.forEach(voucher => {
if (!bankVouchers[voucher.bankId]) {
bankVouchers[voucher.bankId] = [];
}
bankVouchers[voucher.bankId].push(voucher);
});

// ç”ŸæˆéŠ€è¡Œåˆ—è¡¨
let bankHTML = '';
Object.entries(bankVouchers).forEach(([bankId, vouchers]) => {
const bank = banks.find(b => b.id === bankId);
if (!bank) return;

// æŒ‰é¢å€¼åˆ†çµ„
const amountCounts = {};
vouchers.forEach(v => {
if (!amountCounts[v.amount]) amountCounts[v.amount] = 0;
amountCounts[v.amount]++;
});

const bankTotal = vouchers.reduce((sum, v) => sum + v.amount, 0);

bankHTML += `
<div class="mb-2 border rounded p-2">
<div class="flex items-center justify-between">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-medium">${bank.name}</span>
</div>
<div>${vouchers.length}å¼µ (${bankTotal}å…ƒ)</div>
</div>
<div class="ml-4 text-xs text-gray-500 dark:text-gray-400 mt-1">
${Object.entries(amountCounts).map(([amt, count]) => `${amt}å…ƒ: ${count}å¼µ`).join(', ')}
</div>
</div>
`;
});

document.getElementById('recommendation-result').innerHTML = `
<div>
<div class="text-green-500 dark:text-green-400 font-bold mb-2">æ‰¾åˆ°æœ€ä½³çµ„åˆ</div>
<div class="text-sm mb-3">
<div>æ¶ˆè²»é‡‘é¡: ${amount}å…ƒ</div>
<div>ç¯€çœé‡‘é¡: ${totalValue}å…ƒ</div>
<div>è‡ªè²»é‡‘é¡: ${amount - totalValue}å…ƒ</div>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">æ‰€éœ€æ¶ˆè²»: ${requiredAmount}å…ƒ</div>
<div class="mt-1">ä½¿ç”¨å„ªæƒ åˆ¸: ${bestVouchers.length}å¼µ</div>
</div>
<div class="mt-3 pt-2 border-t">
<div class="font-medium mb-1">å„ªæƒ åˆ¸æ˜ç´°:</div>
${bankHTML}
</div>
<div class="mt-3 pt-3 border-t">
<button id="select-recommended-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white py-2 rounded-lg">
é¸æ“‡é€™äº›å„ªæƒ åˆ¸
</button>
</div>
</div>
`;

// æ·»åŠ é¸æ“‡æŒ‰éˆ•äº‹ä»¶
document.getElementById('select-recommended-vouchers').onclick = function() {
// å°‡æ¨è–¦çš„å„ªæƒ åˆ¸æ·»åŠ åˆ°å·²é¸æ“‡åˆ—è¡¨
appState.selectedVouchers = bestVouchers.map(v => v.id);

// æ›´æ–°UI
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();

// è¨­ç½®æ¶ˆè²»é‡‘é¡
document.getElementById('manual-spend-amount').value = amount;

// åˆ‡æ›åˆ°å…‘æ›é¸é …å¡
document.querySelector('[data-tab="redeem"]').click();

// éš±è—çµæœ
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
};
}

document.getElementById('recommendation-result').classList.remove('hidden');
});

// å…¶ä»–è¨ˆç®—æŒ‰éˆ•äº‹ä»¶
['max-quantity', 'high-value', 'same-bank'].forEach(rule => {
document.getElementById(`calculate-${rule}`).addEventListener('click', function() {
calculateAndShowResult(rule);
});
});

// Enteréµè§¸ç™¼æœ€å¤§ç¯€çœè¨ˆç®—
document.getElementById('payment-amount').addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
document.getElementById('calculate-max-value').click();
}
});
}

// é€šç”¨è¨ˆç®—å‡½æ•¸
function calculateAndShowResult(rule) {
const amount = parseInt(document.getElementById('payment-amount').value);
if (isNaN(amount) || amount <= 0) {
alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¶ˆè²»é‡‘é¡ï¼');
return;
}

const result = calculateVouchersByRule(amount, rule);

if (result.error) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-red-500 dark:text-red-400">${result.error}</div>
</div>
`;
} else if (result.closest) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-yellow-500 dark:text-yellow-400">æ¶ˆè²»é‡‘é¡ä¸è¶³</div>
<div class="text-sm mb-3">
æœ€æ¥è¿‘çš„å„ªæƒ åˆ¸ç‚º${result.closest.amount}å…ƒï¼Œéœ€æ¶ˆè²»${result.closest.amount * 3}å…ƒ
</div>
<div class="text-sm">æ‚¨é‚„éœ€å¢åŠ ${result.shortfall}å…ƒæ¶ˆè²»é‡‘é¡</div>
<button id="use-closest-voucher" class="mt-3 w-full py-2 bg-primary text-white rounded-lg">
é¸æ“‡ä½¿ç”¨${result.closest.amount}å…ƒå„ªæƒ åˆ¸
</button>
</div>
`;

document.getElementById('use-closest-voucher').onclick = function() {
appState.selectedVouchers = [result.closest.id];
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();
document.querySelector('[data-tab="redeem"]').click();
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
document.getElementById('manual-spend-amount').value = result.closest.amount * 3;
};
} else if (result.vouchers.length > 0) {
const bestVouchers = result.vouchers;
const totalValue = bestVouchers.reduce((sum, v) => sum + v.amount, 0);
const requiredAmount = totalValue * 3;

// æŒ‰éŠ€è¡Œåˆ†çµ„
const bankVouchers = {};
bestVouchers.forEach(voucher => {
if (!bankVouchers[voucher.bankId]) {
bankVouchers[voucher.bankId] = [];
}
bankVouchers[voucher.bankId].push(voucher);
});

// ç”ŸæˆéŠ€è¡Œåˆ—è¡¨
let bankHTML = '';
Object.entries(bankVouchers).forEach(([bankId, vouchers]) => {
const bank = banks.find(b => b.id === bankId);
if (!bank) return;

// æŒ‰é¢å€¼åˆ†çµ„
const amountCounts = {};
vouchers.forEach(v => {
if (!amountCounts[v.amount]) amountCounts[v.amount] = 0;
amountCounts[v.amount]++;
});

const bankTotal = vouchers.reduce((sum, v) => sum + v.amount, 0);

bankHTML += `
<div class="mb-2 border rounded p-2">
<div class="flex items-center justify-between">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-medium">${bank.name}</span>
</div>
<div>${vouchers.length}å¼µ (${bankTotal}å…ƒ)</div>
</div>
<div class="ml-4 text-xs text-gray-500 dark:text-gray-400 mt-1">
${Object.entries(amountCounts).map(([amt, count]) => `${amt}å…ƒ: ${count}å¼µ`).join(', ')}
</div>
</div>
`;
});

// æ ¹æ“šè¦å‰‡è¨­ç½®æ¨™é¡Œå’Œæè¿°
const ruleInfo = {
'max-value': { title: 'æœ€å¤§ç¯€çœçµ„åˆ', color: 'primary' },
'max-quantity': { title: 'æœ€å¤šå„ªæƒ åˆ¸çµ„åˆ', color: 'green-500' },
'high-value': { title: 'å„ªå…ˆé«˜é¢å€¼çµ„åˆ', color: 'purple-500' },
'same-bank': { title: 'åŒè¡Œå„ªæƒ åˆ¸çµ„åˆ', color: 'orange-500' }
};

const info = ruleInfo[rule];

document.getElementById('recommendation-result').innerHTML = `
<div>
<div class="text-${info.color} dark:text-${info.color} font-bold mb-2">${info.title}</div>
<div class="text-sm mb-3">
<div>æ¶ˆè²»é‡‘é¡: ${amount}å…ƒ</div>
<div>ç¯€çœé‡‘é¡: ${totalValue}å…ƒ</div>
<div>è‡ªè²»é‡‘é¡: ${amount - totalValue}å…ƒ</div>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">æ‰€éœ€æ¶ˆè²»: ${requiredAmount}å…ƒ</div>
<div class="mt-1">ä½¿ç”¨å„ªæƒ åˆ¸: ${bestVouchers.length}å¼µ</div>
</div>
<div class="mt-3 pt-2 border-t">
<div class="font-medium mb-1">å„ªæƒ åˆ¸æ˜ç´°:</div>
${bankHTML}
</div>
<div class="mt-3 pt-3 border-t">
<button id="select-recommended-vouchers" class="w-full bg-${info.color} hover:bg-${info.color.replace('500', '600')} text-white py-2 rounded-lg">
é¸æ“‡é€™äº›å„ªæƒ åˆ¸
</button>
</div>
</div>
`;

// æ·»åŠ é¸æ“‡æŒ‰éˆ•äº‹ä»¶
document.getElementById('select-recommended-vouchers').onclick = function() {
// å°‡æ¨è–¦çš„å„ªæƒ åˆ¸æ·»åŠ åˆ°å·²é¸æ“‡åˆ—è¡¨
appState.selectedVouchers = bestVouchers.map(v => v.id);

// æ›´æ–°UI
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();

// è¨­ç½®æ¶ˆè²»é‡‘é¡
document.getElementById('manual-spend-amount').value = amount;

// åˆ‡æ›åˆ°å…‘æ›é¸é …å¡
document.querySelector('[data-tab="redeem"]').click();

// éš±è—çµæœ
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
};
}

document.getElementById('recommendation-result').classList.remove('hidden');
}

// åˆå§‹åŒ–ç®¡ç†æ¨¡å¼å’ŒéŠ€è¡Œè¨­å®š
function initAdminAndSettings() {
// éŠ€è¡Œé¡¯ç¤ºè¨­å®šæŒ‰éˆ•
document.getElementById('bank-display-settings-btn').addEventListener('click', function() {
initBankFilters();
document.getElementById('bank-display-settings-modal').classList.remove('hidden');
});

document.getElementById('close-bank-display-settings').addEventListener('click', function() {
document.getElementById('bank-display-settings-modal').classList.add('hidden');
});

document.getElementById('select-all-display-banks').addEventListener('click', function() {
appState.bankDisplayFilter = banks.map(bank => bank.id);
saveAppState();
initBankFilters();
});

document.getElementById('clear-display-banks').addEventListener('click', function() {
appState.bankDisplayFilter = [];
saveAppState();
initBankFilters();
});

document.getElementById('save-bank-display-settings').addEventListener('click', function() {
document.getElementById('bank-display-settings-modal').classList.add('hidden');
updateBankButtons();
updateBankOverview();
});

// ç®¡ç†æ¨¡å¼æŒ‰éˆ•
document.getElementById('admin-mode-btn').addEventListener('click', function() {
// å¡«å……é€±æ¬¡é¸æ“‡å™¨
const weekSelect = document.getElementById('admin-week-select');
weekSelect.innerHTML = '<option value="">-- é¸æ“‡é€±æ¬¡ --</option>';
weekSchedule.forEach(week => {
const option = document.createElement('option');
option.value = week.week;
option.textContent = `ç¬¬${week.week}é€± (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
weekSelect.appendChild(option);
});

// å¡«å……éŠ€è¡Œé¸æ“‡å™¨
const bankSelect = document.getElementById('admin-bank-select');
bankSelect.innerHTML = '<option value="">-- é¸æ“‡éŠ€è¡Œ --</option>';
banks.forEach(bank => {
const option = document.createElement('option');
option.value = bank.id;
option.textContent = bank.name;
bankSelect.appendChild(option);
});

// é‡ç½®è¨ˆæ•¸
document.getElementById('admin-0-count').textContent = '0';
document.getElementById('admin-10-count').textContent = '0';
document.getElementById('admin-20-count').textContent = '0';
document.getElementById('admin-50-count').textContent = '0';
document.getElementById('admin-100-count').textContent = '0';
document.getElementById('admin-200-count').textContent = '0';

document.getElementById('admin-mode-modal').classList.remove('hidden');
});

document.getElementById('close-admin-mode').addEventListener('click', function() {
document.getElementById('admin-mode-modal').classList.add('hidden');
});

document.getElementById('close-admin-btn').addEventListener('click', function() {
document.getElementById('admin-mode-modal').classList.add('hidden');
});

// ç®¡ç†æ¨¡å¼é¸æ“‡è®Šæ›´äº‹ä»¶
document.getElementById('admin-week-select').addEventListener('change', updateAdminVoucherCounts);
document.getElementById('admin-bank-select').addEventListener('change', updateAdminVoucherCounts);

// ç®¡ç†æ¨¡å¼æ·»åŠ å„ªæƒ åˆ¸
document.getElementById('admin-add-btn').addEventListener('click', function() {
const weekNum = parseInt(document.getElementById('admin-week-select').value);
const bankId = document.getElementById('admin-bank-select').value;
const amount = parseInt(document.getElementById('admin-amount-select').value);

if (isNaN(weekNum) || !bankId || isNaN(amount)) {
alert('è«‹å…ˆé¸æ“‡é€±æ¬¡ã€éŠ€è¡Œå’Œé¢å€¼ï¼');
return;
}

const weekData = weekSchedule[weekNum - 1];
if (!weekData) {
alert('ç„¡æ•ˆçš„é€±æ¬¡ï¼');
return;
}

const date = weekData.startDate;
const newVoucher = {
id: Date.now().toString(),
amount: amount,
date: date,
used: false,
bankId: bankId
};

appState.vouchers.push(newVoucher);
saveAppState();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();
updateAdminVoucherCounts();

alert(`æˆåŠŸæ·»åŠ  ${amount}${amount === 0 ? 'å…ƒ(ğŸ˜„)' : 'å…ƒ'} å„ªæƒ åˆ¸è‡³ ${getBankName(bankId)} çš„ç¬¬${weekNum}é€±è¨˜éŒ„`);
});

// ç®¡ç†æ¨¡å¼åˆªé™¤å„ªæƒ åˆ¸
document.getElementById('admin-remove-btn').addEventListener('click', function() {
const weekNum = parseInt(document.getElementById('admin-week-select').value);
const bankId = document.getElementById('admin-bank-select').value;
const amount = parseInt(document.getElementById('admin-amount-select').value);

if (isNaN(weekNum) || !bankId || isNaN(amount)) {
alert('è«‹å…ˆé¸æ“‡é€±æ¬¡ã€éŠ€è¡Œå’Œé¢å€¼ï¼');
return;
}

if (deleteVoucherByBankAndAmount(bankId, amount, weekNum)) {
alert(`æˆåŠŸåˆªé™¤ ${getBankName(bankId)} çš„ç¬¬${weekNum}é€± ${amount}${amount === 0 ? 'å…ƒ(ğŸ˜„)' : 'å…ƒ'} å„ªæƒ åˆ¸`);
} else {
alert(`æ‰¾ä¸åˆ° ${getBankName(bankId)} çš„ç¬¬${weekNum}é€± ${amount}${amount === 0 ? 'å…ƒ(ğŸ˜„)' : 'å…ƒ'} å„ªæƒ åˆ¸`);
}
});
}

// åˆå§‹åŒ–æ¶ˆè²»é¡åˆ¥æŒ‰éˆ•çµ„
function initCategoryButtons() {
const categoryButtons = document.querySelectorAll('.category-btn');
let selectedCategory = '';

categoryButtons.forEach(button => {
button.addEventListener('click', function() {
const category = this.getAttribute('data-category');

// å¦‚æœé»æ“Šç›¸åŒçš„æŒ‰éˆ•ï¼Œå‰‡å–æ¶ˆé¸æ“‡
if (selectedCategory === category) {
this.classList.remove('bg-primary', 'text-white');
this.classList.add('border', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
selectedCategory = '';
} else {
// æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
categoryButtons.forEach(btn => {
btn.classList.remove('bg-primary', 'text-white');
btn.classList.add('border', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
});

// è¨­ç½®ç•¶å‰æŒ‰éˆ•ç‚ºé¸ä¸­ç‹€æ…‹
this.classList.add('bg-primary', 'text-white');
this.classList.remove('border', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
selectedCategory = category;
}

// å­˜å„²é¸ä¸­çš„é¡åˆ¥åˆ°éš±è—è¼¸å…¥(æ¨¡æ“¬åŸä¾†çš„select)
document.getElementById('consumption-category').value = selectedCategory;
});
});

// å‰µå»ºéš±è—çš„è¼¸å…¥å…ƒç´ ä¾†å­˜å„²é¸ä¸­çš„å€¼
if (!document.getElementById('consumption-category')) {
const hiddenInput = document.createElement('input');
hiddenInput.type = 'hidden';
hiddenInput.id = 'consumption-category';
hiddenInput.value = '';
document.getElementById('consumption-category-buttons').parentNode.appendChild(hiddenInput);
}
}

// æ¸…é™¤æ¶ˆè²»é¡åˆ¥é¸æ“‡
function clearCategorySelection() {
const categoryButtons = document.querySelectorAll('.category-btn');
categoryButtons.forEach(btn => {
btn.classList.remove('bg-primary', 'text-white');
btn.classList.add('border', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
});
document.getElementById('consumption-category').value = '';
}

// æ‡‰ç”¨ç¨‹åºå•Ÿå‹•
document.addEventListener('DOMContentLoaded', function() {
initTabs();
initCharts();
initStatsToggle();
initAdminAndSettings();
initVoucherCalculator();
initCategoryButtons();

loadAppState();
updateDateDisplay();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();
});
</script>
</body>
</html>
