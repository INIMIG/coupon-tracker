<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025年社區消費大獎賞追蹤器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            'primary-dark': '#4B4AB2',
            'boc': '#c1272d',
            'boc-dark': '#a01e21',
            'icbc': '#c7000a',
            'icbc-dark': '#a00008',
            'macaupass': '#0c6e4f',
            'macaupass-dark': '#095338',
            'luso': '#00529b',
            'luso-dark': '#003e75',
            'ant': '#2c64ae',
            'ant-dark': '#1a4d8a',
            'mox': '#e20074',
            'mox-dark': '#b00058',
            'mpay': '#1e469a',
            'mpay-dark': '#173777',
            'gdb': '#e83828',
            'gdb-dark': '#b82116'
          }
        }
      }
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
  <div class="max-w-md mx-auto p-4">
    <!-- 標題和計數器 -->
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold text-primary dark:text-primary mb-2">2025年社區消費大獎賞追蹤器</h1>
      <div class="text-sm bg-blue-50 dark:bg-blue-900 p-2 rounded-lg">
        <div>
          今天：<span id="current-date">載入中...</span> | <span id="current-week">載入中...</span>
        </div>
      </div>
    </div>

    <!-- 主要功能選項卡 -->
    <div class="mb-4">
      <div class="border-b border-gray-200 dark:border-gray-700">
        <ul class="flex flex-wrap" id="tabs">
          <li class="w-1/2 text-center">
            <button class="w-full py-2 px-1 text-primary dark:text-primary border-b-2 border-primary dark:border-primary tab-active" data-tab="earn">賺取優惠券</button>
          </li>
          <li class="w-1/2 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="redeem">兑換優惠券</button>
          </li>
          <li class="w-1/3 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="stats">統計圖表</button>
          </li>
          <li class="w-1/3 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="history">週次記錄</button>
          </li>
          <li class="w-1/3 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="info">活動資訊</button>
          </li>
        </ul>
      </div>
    </div>

    <!-- 賺取優惠券面板 -->
    <div class="tab-content" id="earn-content">
      <!-- 銀行選擇按鈕組 -->
      <div class="mb-4">
        <div class="text-sm font-medium mb-2">選擇支付工具 (點擊銀行添加優惠券)</div>
        <div class="grid grid-cols-4 gap-2" id="bank-buttons">
          <!-- 銀行按鈕將通過JavaScript動態添加 -->
        </div>
      </div>

      <!-- 快速添加優惠券 (當選中銀行時顯示) -->
      <div id="quick-add-container" class="mb-4 hidden">
        <div class="text-sm font-medium mb-2">添加<span id="selected-bank-name-display">銀行</span>優惠券 (剩餘: <span id="remaining-draws">3</span>次)</div>
        <div class="grid grid-cols-3 gap-2 mb-2">
          <button data-amount="10" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
            10元
          </button>
          <button data-amount="20" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
            20元
          </button>
          <button data-amount="50" class="quick-add py-2 px-1 bg-green-100 dark:bg-green-900 rounded-lg text-center hover:bg-green-200 dark:hover:bg-green-800 transition-colors">
            50元
          </button>
          <button data-amount="100" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">
            100元
          </button>
          <button data-amount="200" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">
            200元
          </button>
          <button data-amount="0" class="quick-add py-2 px-1 bg-yellow-100 dark:bg-yellow-900 rounded-lg text-center hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors">
            😄
          </button>
        </div>
      </div>

      <!-- 銀行優惠券總覽 -->
      <div class="mb-4">
        <h3 class="text-sm font-bold mb-2">各銀行優惠券總覽</h3>
        <div id="bank-overview-list" class="space-y-3">
          <!-- 各銀行優惠券總覽將通過JavaScript動態添加 -->
        </div>
      </div>

      <!-- 匯出數據按鈕 -->
      <div class="mt-6">
        <button id="export-data-btn" class="w-full bg-primary hover:bg-primary-dark text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
          <i class="ri-download-line mr-1"></i> 匯出數據分享給朋友
        </button>
      </div>
    </div>

    <!-- 兑換優惠券面板 -->
    <div class="tab-content hidden" id="redeem-content">
      <!-- 可用優惠券總覽 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-sm font-bold">可用優惠券總覽</h3>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            未使用: <span id="unused-vouchers-count" class="font-bold text-green-600 dark:text-green-400">0</span>張
          </div>
        </div>
        <div id="redeemable-vouchers-list" class="space-y-2">
          <!-- 可用優惠券列表將通過JavaScript動態添加 -->
        </div>
      </div>

      <!-- 優惠券選擇區域 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
        <h3 class="text-sm font-bold mb-2">選擇要兑換的優惠券</h3>
        <div id="redeem-voucher-selection" class="space-y-3">
          <!-- 優惠券選擇區域將通過JavaScript動態添加 -->
        </div>
      </div>

      <!-- 優惠券計算器 -->
      <div class="mb-4 bg-green-50 dark:bg-green-900/20 rounded-lg p-3 shadow">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-sm font-medium">優惠券計算器</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">輸入金額計算最佳組合</div>
          </div>
        </div>
        
        <div class="flex space-x-2">
          <input type="number" id="payment-amount" min="1" placeholder="輸入消費金額" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
          <button id="calculate-recommendation" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
            計算
          </button>
        </div>
        
        <!-- 計算結果區域 -->
        <div id="recommendation-result" class="mt-3 border rounded-lg p-3 bg-white dark:bg-gray-800 hidden">
          <!-- 推薦結果將通過JavaScript動態添加 -->
        </div>
      </div>

      <!-- 已選擇的優惠券列表 -->
      <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow mb-4">
        <h3 class="text-sm font-bold mb-2">已選擇的優惠券</h3>
        <div id="selected-vouchers-list" class="space-y-2 mb-3">
          <div class="text-center text-gray-500 dark:text-gray-400 py-2">尚未選擇優惠券</div>
        </div>
        <div id="selected-vouchers-summary" class="border-t pt-2 hidden">
          <div class="flex justify-between font-medium">
            <div>總計:</div>
            <div><span id="selected-vouchers-count">0</span>張 (<span id="selected-vouchers-value">0</span>元)</div>
          </div>
          <div class="mt-2">
            <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
              消費金額必須為優惠券總額的3倍或以上才能兑換
            </div>
            <div class="flex space-x-2">
              <input type="number" id="redeem-amount" min="1" placeholder="輸入消費金額" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
              <button id="redeem-selected-vouchers" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
                兑換
              </button>
            </div>
            <div id="redeem-error" class="text-red-500 dark:text-red-400 text-sm mt-1 hidden"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 統計圖表面板 -->
    <div class="tab-content hidden" id="stats-content">
      <!-- 總體統計 -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
        <h3 class="font-bold mb-2">總體統計</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">總優惠券</div>
            <div class="text-xl font-bold" id="total-vouchers">0張</div>
          </div>
          <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">總價值</div>
            <div class="text-xl font-bold" id="total-value">0元</div>
          </div>
          <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">已兑換率</div>
            <div class="text-xl font-bold" id="usage-rate">0%</div>
          </div>
          <div class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">已過期率</div>
            <div class="text-xl font-bold" id="expiry-rate">0%</div>
          </div>
        </div>
      </div>
      
      <!-- 週次篩選 -->
      <div class="mb-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-3">
          <div class="flex justify-between items-center">
            <label class="block text-sm font-medium">選擇週次篩選</label>
            <button id="toggle-chart-period" class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary-dark">
              <span id="toggle-text">切換至全部期間</span>
            </button>
          </div>
          <select id="chart-week-filter" class="w-full mt-2 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
            <option value="all">所有週次</option>
            <!-- 週次選項將通過JavaScript動態添加 -->
          </select>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">優惠券面值分佈</h3>
        <div class="h-60">
          <canvas id="value-chart"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">各銀行優惠券分佈</h3>
        <div class="h-60">
          <canvas id="bank-chart"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4" id="week-amount-chart-container">
        <h3 class="font-bold mb-3">週次面值分佈</h3>
        <div class="h-60">
          <canvas id="week-amount-chart"></canvas>
        </div>
        <div class="mt-4 pt-3 border-t" id="week-amount-details">
          <h4 class="font-medium mb-2 text-sm">詳細數據</h4>
          <div class="space-y-2 text-sm" id="week-amount-details-content">
            <!-- 詳細數據將通過JavaScript動態添加 -->
          </div>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4" id="bank-value-chart-container">
        <h3 class="font-bold mb-3">銀行優惠券面值分佈</h3>
        <div class="h-80">
          <canvas id="bank-value-chart"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4" id="status-chart-container">
        <h3 class="font-bold mb-3">優惠券狀態分佈</h3>
        <div class="h-60">
          <canvas id="status-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- 週次記錄面板 -->
    <div class="tab-content hidden" id="history-content">
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">歷週記錄</h3>
          <div class="flex space-x-2">
            <select id="week-history-select" class="text-sm border rounded-lg px-2 py-1 dark:bg-gray-700 dark:border-gray-600">
              <option value="">-- 選擇週次 --</option>
              <!-- 週次選項將通過JavaScript動態添加 -->
            </select>
          </div>
        </div>
        
        <div id="week-records-list" class="space-y-3">
          <!-- 週次記錄將通過JavaScript動態添加 -->
        </div>
      </div>
    </div>
    
    <!-- 活動資訊面板 -->
    <div class="tab-content hidden" id="info-content">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">活動時間</h3>
        <p class="mb-2">2025年3月24日至2025年6月1日</p>
        
        <h3 class="font-bold mb-2 mt-4">抽獎資格</h3>
        <p class="mb-2">週一至週五在每間承辦機構支付工具消費滿50澳門元，可獲3次抽獎機會</p>
        <p class="mb-2">週末消費滿50澳門元，可獲得週抽獎及終極大抽獎資格</p>
        
        <h3 class="font-bold mb-2 mt-4">優惠券面值</h3>
        <p class="mb-2">0、10、20、50、100 或 200 澳門元</p>
        
        <h3 class="font-bold mb-2 mt-4">使用限制</h3>
        <p class="mb-2">優惠券須於獲得後緊接的週六及週日使用，逾期無效</p>
        <p class="mb-2">兑換時消費金額必須為優惠券總額的3倍或以上</p>
        
        <h3 class="font-bold mb-2 mt-4">週期時間表</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b dark:border-gray-700">
                <th class="text-left py-2">週次</th>
                <th class="text-left py-2">活動時間</th>
                <th class="text-left py-2">清零時間</th>
              </tr>
            </thead>
            <tbody id="week-schedule">
              <!-- 週期時間表將通過JavaScript動態添加 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 查看週次詳情模態框 -->
    <div id="week-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold" id="week-detail-title">週次詳情</h3>
          <button id="close-week-detail" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div id="week-detail-content">
          <!-- 週次詳情將通過JavaScript動態添加 -->
        </div>
        
        <div class="mt-4 flex justify-end">
          <button id="close-detail-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            關閉
          </button>
        </div>
      </div>
    </div>
    
    <!-- 確認刪除模態框 -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">確認刪除</h3>
        <p class="mb-4">確定要刪除這張優惠券嗎？</p>
        <div class="flex space-x-2">
          <button id="cancel-delete" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">取消</button>
          <button id="confirm-delete" class="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">確認刪除</button>
        </div>
      </div>
    </div>

    <!-- 匯出數據模態框 -->
    <div id="export-data-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">匯出數據</h3>
          <button id="close-export-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div class="mb-4">
          <p class="mb-2">請選擇匯出格式:</p>
          <div class="space-y-2">
            <button id="export-text" class="w-full py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
              匯出文字摘要
            </button>
            <button id="export-json" class="w-full py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
              匯出完整JSON數據
            </button>
          </div>
        </div>
        
        <div id="export-result" class="border p-3 rounded-lg bg-gray-50 dark:bg-gray-900 max-h-60 overflow-y-auto mb-4 hidden">
          <pre id="export-content" class="text-xs whitespace-pre-wrap break-words"></pre>
        </div>
        
        <div class="flex space-x-2">
          <button id="copy-export" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors hidden">
            複製到剪貼板
          </button>
          <button id="close-export" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            關閉
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 設置深色模式
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    // 活動週期數據
    const weekSchedule = [
      { week: 1, startDate: '2025-03-24', endDate: '2025-03-28', resetDate: '2025-03-29' },
      { week: 2, startDate: '2025-03-31', endDate: '2025-04-04', resetDate: '2025-04-05' },
      { week: 3, startDate: '2025-04-07', endDate: '2025-04-11', resetDate: '2025-04-12' },
      { week: 4, startDate: '2025-04-14', endDate: '2025-04-18', resetDate: '2025-04-19' },
      { week: 5, startDate: '2025-04-21', endDate: '2025-04-25', resetDate: '2025-04-26' },
      { week: 6, startDate: '2025-04-28', endDate: '2025-05-02', resetDate: '2025-05-03' },
      { week: 7, startDate: '2025-05-05', endDate: '2025-05-09', resetDate: '2025-05-10' },
      { week: 8, startDate: '2025-05-12', endDate: '2025-05-16', resetDate: '2025-05-17' },
      { week: 9, startDate: '2025-05-19', endDate: '2025-05-23', resetDate: '2025-05-24' },
      { week: 10, startDate: '2025-05-26', endDate: '2025-05-30', resetDate: '2025-05-31' }
    ];

    // 銀行支付工具
    const banks = [
      { id: 'boc', name: '中國銀行', color: 'boc', darkColor: 'boc-dark', logo: 'ri-bank-fill' },
      { id: 'icbc', name: '工商銀行', color: 'icbc', darkColor: 'icbc-dark', logo: 'ri-bank-fill' },
      { id: 'luso', name: '大豐銀行', color: 'luso', darkColor: 'luso-dark', logo: 'ri-bank-fill' },
      { id: 'bnu', name: '澳門國際銀行', color: 'primary', darkColor: 'primary-dark', logo: 'ri-bank-fill' },
      { id: 'macaupass', name: '澳門通', color: 'macaupass', darkColor: 'macaupass-dark', logo: 'ri-bank-card-fill' },
      { id: 'ant', name: '螞蟻銀行', color: 'ant', darkColor: 'ant-dark', logo: 'ri-bank-fill' },
      { id: 'mpay', name: '澳門極易付', color: 'mpay', darkColor: 'mpay-dark', logo: 'ri-wallet-fill' },
      { id: 'gdb', name: '廣發銀行', color: 'gdb', darkColor: 'gdb-dark', logo: 'ri-bank-fill' }
    ];

    // 圖表顏色
    const chartColors = {
      light: ['#c1272d', '#c7000a', '#00529b', '#5D5CDE', '#0c6e4f', '#2c64ae', '#1e469a', '#e83828'],
      dark: ['#e04a4a', '#e03e47', '#4a8fd1', '#7978E9', '#25a073', '#5589d4', '#4c76ca', '#f05a4a']
    };

    // 优惠券顏色
    const voucherColors = {
      0: { light: '#fef08a', dark: '#facc15' }, // 0元
      10: { light: '#dbeafe', dark: '#93c5fd' }, // 10元
      20: { light: '#dbeafe', dark: '#93c5fd' }, // 20元
      50: { light: '#dcfce7', dark: '#86efac' }, // 50元
      100: { light: '#f3e8ff', dark: '#c084fc' }, // 100元
      200: { light: '#f3e8ff', dark: '#c084fc' }  // 200元
    };

    // 初始化应用程序状态
    let appState = {
      vouchers: [],
      weekendSpends: [],
      currentWeek: 1,
      bankDraws: {}, // 每家銀行的抽獎次數
      preferredBank: null,
      bankVouchers: {},
      weekRecords: [], // 週次記錄
      selectedVouchers: [], // 兑換時選擇的優惠券
      redeemHistory: [] // 兑換歷史
    };

    // 圖表週期模式
    let chartPeriodMode = 'week'; // 'week' or 'all'

    // 嘗試從localStorage加載數據
    function loadAppState() {
      try {
        const savedState = JSON.parse(localStorage.getItem('voucherAppState'));
        if (savedState) {
          appState = savedState;
          
          // 確保selectedVouchers結構存在
          if (!appState.selectedVouchers) {
            appState.selectedVouchers = [];
          }
          
          // 確保redeemHistory結構存在
          if (!appState.redeemHistory) {
            appState.redeemHistory = [];
          }
        }
        
        // 確保bankDraws結構存在
        if (!appState.bankDraws) {
          appState.bankDraws = {};
        }
        
        // 確保weekRecords結構存在
        if (!appState.weekRecords) {
          appState.weekRecords = [];
        }
        
        // 初始化每家銀行的抽獎次數
        banks.forEach(bank => {
          if (!appState.bankDraws[bank.id]) {
            appState.bankDraws[bank.id] = {
              remaining: 3,
              used: 0
            };
          }
        });
        
        // 檢查是否需要更新週次記錄
        updateCurrentWeekRecord();
      } catch (e) {
        console.error('Failed to load app state:', e);
      }
      
      updateUI();
    }

    // 保存應用程序狀態到localStorage
    function saveAppState() {
      try {
        localStorage.setItem('voucherAppState', JSON.stringify(appState));
      } catch (e) {
        console.error('Failed to save app state:', e);
      }
    }

    // 計算當前週次
    function calculateCurrentWeek() {
      const today = new Date();
      const dateString = today.toISOString().split('T')[0]; // YYYY-MM-DD格式
      
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (dateString >= week.startDate && dateString <= week.endDate) {
          return i + 1;
        }
      }
      
      // 如果當前日期不在任何週次範圍內
      if (dateString < weekSchedule[0].startDate) {
        return 0; // 活動尚未開始
      } else if (dateString > weekSchedule[weekSchedule.length - 1].endDate) {
        return 11; // 活動已結束
      }
      
      // 檢查是否在週末
      for (let i = 0; i < weekSchedule.length - 1; i++) {
        if (dateString > weekSchedule[i].endDate && dateString < weekSchedule[i + 1].startDate) {
          return i + 1; // 返回當前的週末所屬的週次
        }
      }
      
      return 1; // 默認返回第一週
    }

    // 格式化日期顯示
    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getMonth() + 1}月${date.getDate()}日`;
    }

    // 顯示今天日期
    function updateCurrentDateDisplay() {
      const currentDateElem = document.getElementById('current-date');
      const today = new Date();
      currentDateElem.textContent = formatDate(today.toISOString().split('T')[0]);
    }

    // 更新當前週次記錄
    function updateCurrentWeekRecord() {
      const currentWeek = calculateCurrentWeek();
      if (currentWeek < 1 || currentWeek > 10) return; // 超出活動範圍
      
      appState.currentWeek = currentWeek;
      
      // 檢查是否已有當前週次的記錄
      const existingRecord = appState.weekRecords.find(record => record.weekNum === currentWeek);
      
      // 如果沒有當前週次的記錄，生成一個
      if (!existingRecord) {
        const newRecord = createWeekRecord(currentWeek);
        if (newRecord) {
          appState.weekRecords.push(newRecord);
          appState.weekRecords.sort((a, b) => b.weekNum - a.weekNum);
        }
      } else {
        // 更新現有的記錄
        const index = appState.weekRecords.findIndex(record => record.weekNum === currentWeek);
        if (index !== -1) {
          const updatedRecord = createWeekRecord(currentWeek, existingRecord.notes);
          updatedRecord.id = existingRecord.id; // 保留原ID
          updatedRecord.createdAt = existingRecord.createdAt; // 保留原创建时间
          updatedRecord.spendAmount = existingRecord.spendAmount || 0; // 保留消費金額
          appState.weekRecords[index] = updatedRecord;
        }
      }
      
      saveAppState();
    }

    // 創建週次記錄
    function createWeekRecord(weekNum, notes = '') {
      const weekData = weekSchedule[weekNum - 1];
      
      if (!weekData) return null;
      
      // 獲取該週的優惠券
      const weekVouchers = appState.vouchers.filter(voucher => {
        const voucherWeek = getWeekNumberFromDate(voucher.date);
        return voucherWeek === weekNum;
      });
      
      // 計算各面值優惠券數量
      const valueCounts = [0, 0, 0, 0, 0, 0]; // 0元, 10, 20, 50, 100, 200
      let totalValue = 0;
      weekVouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // 0元
          case 10: valueCounts[1]++; totalValue += 10; break;
          case 20: valueCounts[2]++; totalValue += 20; break;
          case 50: valueCounts[3]++; totalValue += 50; break;
          case 100: valueCounts[4]++; totalValue += 100; break;
          case 200: valueCounts[5]++; totalValue += 200; break;
        }
      });
      
      // 計算各銀行優惠券數量
      const bankCounts = {};
      banks.forEach(bank => {
        bankCounts[bank.id] = {
          count: 0,
          value: 0
        };
      });
      
      weekVouchers.forEach(voucher => {
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId].count++;
          bankCounts[voucher.bankId].value += voucher.amount;
        }
      });
      
      // 獲取該週的週末消費
      const weekendSpends = appState.weekendSpends.filter(spend => {
        const spendWeek = getWeekNumberFromDate(spend.date);
        return spendWeek === weekNum;
      });
      
      // 創建週次記錄
      const weekRecord = {
        id: Date.now().toString(),
        weekNum: weekNum,
        startDate: weekData.startDate,
        endDate: weekData.endDate,
        createdAt: new Date().toISOString(),
        notes: notes,
        voucherCount: weekVouchers.length,
        voucherValue: totalValue,
        valueCounts: valueCounts,
        bankCounts: bankCounts,
        usedCount: weekVouchers.filter(v => v.used).length,
        weekendSpendsCount: weekendSpends.length,
        bankDraws: JSON.parse(JSON.stringify(appState.bankDraws)), // 深拷貝當前銀行抽獎狀態
        spendAmount: 0 // 初始消費金額為0
      };
      
      return weekRecord;
    }

    // 更新週期時間表
    function updateWeekSchedule() {
      const tableBody = document.getElementById('week-schedule');
      tableBody.innerHTML = '';
      
      weekSchedule.forEach(week => {
        const row = document.createElement('tr');
        row.className = 'border-b dark:border-gray-700';
        
        const weekCell = document.createElement('td');
        weekCell.className = 'py-2';
        weekCell.textContent = `第${week.week}週`;
        
        const timeCell = document.createElement('td');
        timeCell.className = 'py-2';
        timeCell.textContent = `${formatDate(week.startDate)} - ${formatDate(week.endDate)}`;
        
        const resetCell = document.createElement('td');
        resetCell.className = 'py-2';
        resetCell.textContent = formatDate(week.resetDate);
        
        row.appendChild(weekCell);
        row.appendChild(timeCell);
        row.appendChild(resetCell);
        
        tableBody.appendChild(row);
      });
    }

    // 更新當前週次顯示
    function updateCurrentWeekDisplay() {
      const currentWeekElem = document.getElementById('current-week');
      const weekNum = calculateCurrentWeek();
      appState.currentWeek = weekNum;
      
      if (weekNum === 0) {
        currentWeekElem.textContent = '活動尚未開始';
      } else if (weekNum > 10) {
        currentWeekElem.textContent = '活動已結束';
      } else {
        const weekData = weekSchedule[weekNum - 1];
        currentWeekElem.textContent = `第${weekNum}週 (${formatDate(weekData.startDate)} - ${formatDate(weekData.endDate)})`;
      }
    }

    // 更新銀行按鈕顯示
    function updateBankButtons() {
      const bankButtonsContainer = document.getElementById('bank-buttons');
      bankButtonsContainer.innerHTML = '';
      
      banks.forEach(bank => {
        const bankButton = document.createElement('div');
        
        // 判斷是否為選中的銀行
        const isSelected = appState.preferredBank === bank.id;
        
        bankButton.className = `p-2 rounded-lg cursor-pointer flex flex-col items-center transition-colors ${
          isSelected ? 
          `bg-${bank.color} text-white` : 
          `bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700`
        }`;
        bankButton.setAttribute('data-bank-id', bank.id);
        
        // 獲取該銀行的抽獎次數
        const bankDraws = appState.bankDraws[bank.id] || { remaining: 3, used: 0 };
        
        // 設置按鈕內容
        bankButton.innerHTML = `
          <i class="${bank.logo} text-2xl ${isSelected ? 'text-white' : `text-${bank.color} dark:text-${bank.color}`}"></i>
          <div class="text-xs mt-1 ${isSelected ? 'text-white' : ''}">${bank.name}</div>
          <div class="text-xs ${isSelected ? 'text-white' : 'text-gray-500 dark:text-gray-400'}">${bankDraws.remaining}/3</div>
        `;
        
        // 添加點擊事件
        bankButton.addEventListener('click', () => {
          selectBank(bank.id);
        });
        
        bankButtonsContainer.appendChild(bankButton);
      });
    }

    // 選擇銀行
    function selectBank(bankId) {
      appState.preferredBank = bankId;
      
      // 更新UI
      updateBankButtons();
      updateQuickAddPanel();
      
      // 保存狀態
      saveAppState();
    }

    // 更新快速添加面板
    function updateQuickAddPanel() {
      const quickAddContainer = document.getElementById('quick-add-container');
      const selectedBankNameDisplay = document.getElementById('selected-bank-name-display');
      const remainingDrawsDisplay = document.getElementById('remaining-draws');
      
      if (appState.preferredBank) {
        // 顯示快速添加面板
        quickAddContainer.classList.remove('hidden');
        
        // 獲取銀行信息
        const bank = banks.find(b => b.id === appState.preferredBank);
        selectedBankNameDisplay.textContent = bank ? bank.name : '銀行';
        
        // 獲取剩餘抽獎次數
        const bankDraws = appState.bankDraws[appState.preferredBank];
        remainingDrawsDisplay.textContent = bankDraws ? bankDraws.remaining : 3;
      } else {
        // 隱藏快速添加面板
        quickAddContainer.classList.add('hidden');
      }
    }

    // 更新銀行優惠券總覽
    function updateBankOverview() {
      const bankOverviewList = document.getElementById('bank-overview-list');
      bankOverviewList.innerHTML = '';
      
      // 計算各銀行優惠券面值分佈
      const bankDistribution = {};
      
      // 初始化每個銀行的面值分佈
      banks.forEach(bank => {
        bankDistribution[bank.id] = {
          0: 0,    // 0元
          10: 0,   // 10元
          20: 0,   // 20元
          50: 0,   // 50元
          100: 0,  // 100元
          200: 0,  // 200元
          count: 0, // 總數
          total: 0, // 總值
          unused: {
            0: 0,
            10: 0,
            20: 0,
            50: 0,
            100: 0,
            200: 0,
            count: 0,
            total: 0
          }
        };
      });
      
      // 計算每個銀行的優惠券面值分佈
      appState.vouchers.forEach(voucher => {
        if (voucher.bankId && bankDistribution[voucher.bankId]) {
          if (voucher.amount in bankDistribution[voucher.bankId]) {
            bankDistribution[voucher.bankId][voucher.amount]++;
            bankDistribution[voucher.bankId].count++;
            if (voucher.amount > 0) {
              bankDistribution[voucher.bankId].total += voucher.amount;
            }
            
            // 計算未使用的優惠券
            if (!voucher.used && !isVoucherExpired(voucher)) {
              bankDistribution[voucher.bankId].unused[voucher.amount]++;
              bankDistribution[voucher.bankId].unused.count++;
              if (voucher.amount > 0) {
                bankDistribution[voucher.bankId].unused.total += voucher.amount;
              }
            }
          }
        }
      });
      
      // 按總數從高到低排序銀行
      const sortedBanks = banks
        .filter(bank => bankDistribution[bank.id].count > 0)
        .sort((a, b) => bankDistribution[b.id].total - bankDistribution[a.id].total);
      
      // 創建銀行優惠券面值分佈顯示
      if (sortedBanks.length === 0) {
        bankOverviewList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚未添加任何優惠券</div>';
        return;
      }
      
      // 計算總計
      const totalCounts = {
        0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
        count: 0,
        total: 0,
        unused: {
          0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
          count: 0,
          total: 0
        }
      };
      
      Object.values(bankDistribution).forEach(data => {
        totalCounts[0] += data[0];
        totalCounts[10] += data[10];
        totalCounts[20] += data[20];
        totalCounts[50] += data[50];
        totalCounts[100] += data[100];
        totalCounts[200] += data[200];
        totalCounts.count += data.count;
        totalCounts.total += data.total;
        
        totalCounts.unused[0] += data.unused[0];
        totalCounts.unused[10] += data.unused[10];
        totalCounts.unused[20] += data.unused[20];
        totalCounts.unused[50] += data.unused[50];
        totalCounts.unused[100] += data.unused[100];
        totalCounts.unused[200] += data.unused[200];
        totalCounts.unused.count += data.unused.count;
        totalCounts.unused.total += data.unused.total;
      });
      
      // 總計卡片
      const totalCard = document.createElement('div');
      totalCard.className = 'bg-primary-50 dark:bg-primary-900/30 border-primary border rounded-lg p-3';
      
      // 面值分佈
      const distributionDiv = document.createElement('div');
      distributionDiv.className = 'grid grid-cols-6 gap-1 text-center';
      
      // 添加各面值顯示
      const denominations = [0, 10, 20, 50, 100, 200];
      const colorClasses = [
        'bg-yellow-100 dark:bg-yellow-900', // 0元
        'bg-blue-100 dark:bg-blue-900',     // 10元
        'bg-blue-100 dark:bg-blue-900',     // 20元
        'bg-green-100 dark:bg-green-900',   // 50元
        'bg-purple-100 dark:bg-purple-900', // 100元
        'bg-purple-100 dark:bg-purple-900'  // 200元
      ];
      
      const totalHeader = document.createElement('div');
      totalHeader.className = 'flex justify-between items-center mb-2 pb-2 border-b dark:border-gray-700';
      totalHeader.innerHTML = `
        <div class="font-bold">總計</div>
        <div class="text-sm">
          ${totalCounts.count}張 (${totalCounts.total}元)
          <div class="text-xs text-green-600 dark:text-green-400">
            可用: ${totalCounts.unused.count}張 (${totalCounts.unused.total}元)
          </div>
        </div>
      `;
      
      denominations.forEach((value, index) => {
        const count = totalCounts[value] || 0;
        const unusedCount = totalCounts.unused[value] || 0;
        const valueBlock = document.createElement('div');
        valueBlock.className = `${colorClasses[index]} rounded p-2 ${count > 0 ? '' : 'opacity-30'}`;
        
        const displayText = value === 0 ? '0' : `${value}元`;
        
        valueBlock.innerHTML = `
          <div class="font-bold">${count}</div>
          <div class="text-xs">${displayText}</div>
          ${unusedCount > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可用: ${unusedCount}</div>` : ''}
        `;
        
        distributionDiv.appendChild(valueBlock);
      });
      
      totalCard.appendChild(totalHeader);
      totalCard.appendChild(distributionDiv);
      bankOverviewList.appendChild(totalCard);
      
      // 添加各銀行的面值分佈
      sortedBanks.forEach(bank => {
        const data = bankDistribution[bank.id];
        const bankCard = document.createElement('div');
        bankCard.className = 'bg-white dark:bg-gray-800 border rounded-lg p-3 mt-3';
        
        // 銀行標題
        const bankHeader = document.createElement('div');
        bankHeader.className = `flex items-center justify-between mb-2 pb-2 border-b dark:border-gray-700`;
        bankHeader.innerHTML = `
          <div class="flex items-center">
            <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
            <span class="font-bold">${bank.name}</span>
          </div>
          <div class="text-sm">
            ${data.count}張 (${data.total}元)
            <div class="text-xs text-green-600 dark:text-green-400">
              可用: ${data.unused.count}張 (${data.unused.total}元)
            </div>
          </div>
        `;
        
        // 面值分佈
        const bankDistributionDiv = document.createElement('div');
        bankDistributionDiv.className = 'grid grid-cols-6 gap-1 text-center';
        
        denominations.forEach((value, index) => {
          const count = data[value] || 0;
          const unusedCount = data.unused[value] || 0;
          const valueBlock = document.createElement('div');
          
          // 建立一個可編輯的塊，帶有增加/減少按鈕
          valueBlock.className = `${colorClasses[index]} rounded p-2 relative ${count > 0 ? '' : 'opacity-30'}`;
          
          const displayText = value === 0 ? '0' : `${value}元`;
          
          valueBlock.innerHTML = `
            <div class="font-bold">${count}</div>
            <div class="text-xs">${displayText}</div>
            ${unusedCount > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">可用: ${unusedCount}</div>` : ''}
            <div class="absolute bottom-1 right-1 flex flex-col space-y-0.5 opacity-0 group-hover:opacity-100 hover:opacity-100">
              <button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded-full w-4 h-4 flex items-center justify-center text-xs hover:bg-gray-300 dark:hover:bg-gray-600"
                      data-bank="${bank.id}" data-amount="${value}">+</button>
            </div>
          `;
          
          // 添加編輯功能
          valueBlock.addEventListener('mouseenter', function() {
            this.querySelector('div:last-child').classList.remove('opacity-0');
          });
          
          valueBlock.addEventListener('mouseleave', function() {
            this.querySelector('div:last-child').classList.add('opacity-0');
          });
          
          bankDistributionDiv.appendChild(valueBlock);
        });
        
        // 添加編輯按鈕的事件監聽器
        bankCard.appendChild(bankHeader);
        bankCard.appendChild(bankDistributionDiv);
        bankOverviewList.appendChild(bankCard);
      });
      
      // 添加增加優惠券按鈕的事件監聽器
      document.querySelectorAll('.add-voucher-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const amount = parseInt(this.getAttribute('data-amount'));
          
          appState.preferredBank = bankId;
          addVoucher(amount);
        });
      });
    }

    // 更新可兑換優惠券列表
    function updateRedeemableVouchers() {
      const redeemableVouchersList = document.getElementById('redeemable-vouchers-list');
      const unusedVouchersCount = document.getElementById('unused-vouchers-count');
      
      // 获取所有未使用且未过期的优惠券
      const unusedVouchers = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v));
      
      // 更新未使用優惠券數量
      unusedVouchersCount.textContent = unusedVouchers.length;
      
      // 如果没有可用优惠券，显示提示信息
      if (unusedVouchers.length === 0) {
        redeemableVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">沒有可用的優惠券</div>';
        return;
      }
      
      // 计算各面值的優惠券数量
      const valueCounts = {
        0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
        total: 0, count: 0
      };
      
      // 计算各银行的優惠券数量
      const bankCounts = {};
      banks.forEach(bank => {
        bankCounts[bank.id] = {
          0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
          total: 0, count: 0
        };
      });
      
      unusedVouchers.forEach(voucher => {
        // 更新面值统计
        valueCounts[voucher.amount]++;
        valueCounts.count++;
        if (voucher.amount > 0) {
          valueCounts.total += voucher.amount;
        }
        
        // 更新银行统计
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId][voucher.amount]++;
          bankCounts[voucher.bankId].count++;
          if (voucher.amount > 0) {
            bankCounts[voucher.bankId].total += voucher.amount;
          }
        }
      });
      
      // 创建总体摘要
      redeemableVouchersList.innerHTML = `
        <div class="flex justify-between items-center p-2 bg-primary-50 dark:bg-primary-900/20 rounded">
          <div>總計</div>
          <div class="text-right">
            <div>${valueCounts.count}張 (${valueCounts.total}元)</div>
          </div>
        </div>
        
        <div class="grid grid-cols-6 gap-1 text-center my-2">
          <div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 ${valueCounts[0] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[0]}</div>
            <div class="text-xs">0</div>
          </div>
          <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[10] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[10]}</div>
            <div class="text-xs">10元</div>
          </div>
          <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[20] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[20]}</div>
            <div class="text-xs">20元</div>
          </div>
          <div class="bg-green-100 dark:bg-green-900 rounded p-2 ${valueCounts[50] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[50]}</div>
            <div class="text-xs">50元</div>
          </div>
          <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[100] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[100]}</div>
            <div class="text-xs">100元</div>
          </div>
          <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[200] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[200]}</div>
            <div class="text-xs">200元</div>
          </div>
        </div>
      `;
      
      // 按总值从高到低排序银行
      const sortedBanks = banks
        .filter(bank => bankCounts[bank.id].count > 0)
        .sort((a, b) => bankCounts[b.id].total - bankCounts[a.id].total);
      
      // 添加各银行的摘要
      if (sortedBanks.length > 0) {
        const bankSummaryDiv = document.createElement('div');
        bankSummaryDiv.className = 'space-y-1 mt-3';
        
        sortedBanks.forEach(bank => {
          const data = bankCounts[bank.id];
          
          const bankRow = document.createElement('div');
          bankRow.className = 'flex justify-between items-center p-2 border-b dark:border-gray-700 last:border-0';
          
          bankRow.innerHTML = `
            <div class="flex items-center">
              <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
              <span>${bank.name}</span>
            </div>
            <div>${data.count}張 (${data.total}元)</div>
          `;
          
          bankSummaryDiv.appendChild(bankRow);
        });
        
        redeemableVouchersList.appendChild(bankSummaryDiv);
      }
    }

    // 更新優惠券選擇區域
    function updateVoucherSelection() {
      const redeemedVoucherSelection = document.getElementById('redeem-voucher-selection');
      
      // 获取所有未使用且未过期的優惠券
      const unusedVouchers = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v));
      
      // 如果没有可用优惠券，显示提示信息
      if (unusedVouchers.length === 0) {
        redeemedVoucherSelection.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">沒有可用的優惠券</div>';
        return;
      }
      
      // 按銀行分組
      const vouchersByBank = {};
      unusedVouchers.forEach(voucher => {
        if (!vouchersByBank[voucher.bankId]) {
          vouchersByBank[voucher.bankId] = [];
        }
        vouchersByBank[voucher.bankId].push(voucher);
      });
      
      // 清空選擇區域
      redeemedVoucherSelection.innerHTML = '';
      
      // 按面值分组并添加選項
      const amounts = [0, 10, 20, 50, 100, 200];
      const amountColors = {
        0: 'bg-yellow-100 dark:bg-yellow-900',
        10: 'bg-blue-100 dark:bg-blue-900',
        20: 'bg-blue-100 dark:bg-blue-900',
        50: 'bg-green-100 dark:bg-green-900',
        100: 'bg-purple-100 dark:bg-purple-900',
        200: 'bg-purple-100 dark:bg-purple-900'
      };
      
      // 添加各面值的選擇區域
      amounts.forEach(amount => {
        const vouchersWithAmount = unusedVouchers.filter(v => v.amount === amount);
        
        // 如果没有此面值的優惠券则跳过
        if (vouchersWithAmount.length === 0) return;
        
        const amountSection = document.createElement('div');
        amountSection.className = 'border rounded-lg overflow-hidden';
        
        // 面值标题
        const amountHeader = document.createElement('div');
        amountHeader.className = `${amountColors[amount]} p-2 flex justify-between items-center`;
        amountHeader.innerHTML = `
          <div class="font-bold">${amount === 0 ? '0' : `${amount}元`}</div>
          <div>${vouchersWithAmount.length}張</div>
        `;
        
        // 創建優惠券列表
        const vouchersList = document.createElement('div');
        vouchersList.className = 'p-2 space-y-1 bg-white dark:bg-gray-800';
        
        // 按銀行分組顯示優惠券
        Object.keys(vouchersByBank).forEach(bankId => {
          const bankVouchers = vouchersByBank[bankId].filter(v => v.amount === amount);
          if (bankVouchers.length === 0) return;
          
          const bank = banks.find(b => b.id === bankId);
          if (!bank) return;
          
          const bankRow = document.createElement('div');
          bankRow.className = 'flex items-center justify-between';
          
          bankRow.innerHTML = `
            <div class="flex items-center">
              <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
              <span>${bank.name}</span>
            </div>
            <div class="flex items-center space-x-2">
              <button class="select-all-btn text-xs bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600"
                      data-bank="${bankId}" data-amount="${amount}">全選</button>
              <div class="text-gray-500 dark:text-gray-400">${bankVouchers.length}張</div>
            </div>
          `;
          
          vouchersList.appendChild(bankRow);
          
          // 添加該銀行的優惠券選擇項
          const bankVouchersList = document.createElement('div');
          bankVouchersList.className = 'ml-4 space-y-1 mt-1';
          
          bankVouchers.forEach(voucher => {
            const voucherItem = document.createElement('div');
            voucherItem.className = 'flex items-center space-x-2';
            
            // 檢查是否已選中
            const isSelected = appState.selectedVouchers.includes(voucher.id);
            
            voucherItem.innerHTML = `
              <input type="checkbox" id="voucher-${voucher.id}" class="voucher-checkbox"
                     data-id="${voucher.id}" data-amount="${voucher.amount}" ${isSelected ? 'checked' : ''}>
              <label for="voucher-${voucher.id}" class="text-sm">
                ${formatDate(voucher.date)}獲得
              </label>
            `;
            
            bankVouchersList.appendChild(voucherItem);
          });
          
          vouchersList.appendChild(bankVouchersList);
        });
        
        amountSection.appendChild(amountHeader);
        amountSection.appendChild(vouchersList);
        redeemedVoucherSelection.appendChild(amountSection);
      });
      
      // 添加全選按鈕的事件
      document.querySelectorAll('.select-all-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const amount = parseInt(this.getAttribute('data-amount'));
          
          // 找到所有符合條件的未選中的優惠券
          const bankVouchers = unusedVouchers.filter(v => 
            v.bankId === bankId && v.amount === amount && !appState.selectedVouchers.includes(v.id)
          );
          
          // 添加到已選擇列表
          bankVouchers.forEach(voucher => {
            if (!appState.selectedVouchers.includes(voucher.id)) {
              appState.selectedVouchers.push(voucher.id);
            }
          });
          
          // 更新UI
          updateVoucherSelection();
          updateSelectedVouchers();
          saveAppState();
        });
      });
      
      // 添加複選框的事件
      document.querySelectorAll('.voucher-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const voucherId = this.getAttribute('data-id');
          
          if (this.checked) {
            // 添加到已選擇列表
            if (!appState.selectedVouchers.includes(voucherId)) {
              appState.selectedVouchers.push(voucherId);
            }
          } else {
            // 從已選擇列表中移除
            appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
          }
          
          // 更新UI
          updateSelectedVouchers();
          saveAppState();
        });
      });
    }

    // 更新已選擇的優惠券列表
    function updateSelectedVouchers() {
      const selectedVouchersList = document.getElementById('selected-vouchers-list');
      const selectedVouchersSummary = document.getElementById('selected-vouchers-summary');
      const selectedVouchersCount = document.getElementById('selected-vouchers-count');
      const selectedVouchersValue = document.getElementById('selected-vouchers-value');
      const redeemAmount = document.getElementById('redeem-amount');
      const redeemError = document.getElementById('redeem-error');
      
      // 如果沒有選擇任何優惠券，顯示提示信息
      if (appState.selectedVouchers.length === 0) {
        selectedVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚未選擇優惠券</div>';
        selectedVouchersSummary.classList.add('hidden');
        return;
      }
      
      // 獲取所有已選擇的優惠券
      const selectedVouchers = appState.selectedVouchers
        .map(id => appState.vouchers.find(v => v.id === id))
        .filter(v => v && !v.used && !isVoucherExpired(v));
      
      // 計算總值
      const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
      
      // 更新摘要數據
      selectedVouchersCount.textContent = selectedVouchers.length;
      selectedVouchersValue.textContent = totalValue;
      selectedVouchersSummary.classList.remove('hidden');
      
      // 設置最小消費金額為優惠券總額的3倍
      redeemAmount.min = totalValue * 3;
      redeemAmount.placeholder = `最少消費${totalValue * 3}元`;
      
      // 檢查當前消費金額是否足夠
      const currentAmount = parseFloat(redeemAmount.value) || 0;
      if (currentAmount > 0 && currentAmount < totalValue * 3) {
        redeemError.classList.remove('hidden');
        redeemError.textContent = `消費金額必須至少為${totalValue * 3}元`;
      } else {
        redeemError.classList.add('hidden');
      }
      
      // 按面值分组
      const vouchersByAmount = {};
      selectedVouchers.forEach(voucher => {
        if (!vouchersByAmount[voucher.amount]) {
          vouchersByAmount[voucher.amount] = [];
        }
        vouchersByAmount[voucher.amount].push(voucher);
      });
      
      // 清空列表
      selectedVouchersList.innerHTML = '';
      
      // 按面值從大到小顯示優惠券
      const amounts = [200, 100, 50, 20, 10, 0].filter(a => vouchersByAmount[a]?.length > 0);
      
      if (amounts.length === 0) {
        selectedVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚未選擇優惠券</div>';
        selectedVouchersSummary.classList.add('hidden');
        return;
      }
      
      // 添加各面值的優惠券
      amounts.forEach(amount => {
        const vouchers = vouchersByAmount[amount];
        
        // 面值摘要
        const amountSummary = document.createElement('div');
        amountSummary.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded mb-1';
        amountSummary.innerHTML = `
          <div class="font-medium">${amount === 0 ? '0' : `${amount}元`}</div>
          <div class="flex items-center space-x-2">
            <button class="remove-all-amount text-xs bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 px-2 py-0.5 rounded" data-amount="${amount}">
              移除全部
            </button>
            <div>${vouchers.length}張 ${amount > 0 ? `(${amount * vouchers.length}元)` : ''}</div>
          </div>
        `;
        
        selectedVouchersList.appendChild(amountSummary);
        
        // 分銀行顯示
        const bankGroups = {};
        vouchers.forEach(voucher => {
          if (!bankGroups[voucher.bankId]) {
            bankGroups[voucher.bankId] = [];
          }
          bankGroups[voucher.bankId].push(voucher);
        });
        
        // 顯示各銀行的優惠券
        Object.keys(bankGroups).forEach(bankId => {
          const bank = banks.find(b => b.id === bankId);
          if (!bank) return;
          
          const bankVouchers = bankGroups[bankId];
          
          // 顯示銀行標題
          const bankHeader = document.createElement('div');
          bankHeader.className = 'flex justify-between items-center px-2 py-1';
          bankHeader.innerHTML = `
            <div class="flex items-center">
              <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
              <span>${bank.name}</span>
            </div>
            <div>${bankVouchers.length}張</div>
          `;
          
          selectedVouchersList.appendChild(bankHeader);
          
          // 顯示個別優惠券
          bankVouchers.forEach(voucher => {
            const voucherItem = document.createElement('div');
            voucherItem.className = 'flex justify-between items-center px-2 py-1 border-b dark:border-gray-700 last:border-0 ml-4';
            
            voucherItem.innerHTML = `
              <div class="text-sm">${formatDate(voucher.date)}獲得</div>
              <button class="remove-voucher text-xs text-red-500 dark:text-red-400" data-id="${voucher.id}">移除</button>
            `;
            
            selectedVouchersList.appendChild(voucherItem);
          });
        });
      });
      
      // 添加移除按鈕的事件
      document.querySelectorAll('.remove-voucher').forEach(btn => {
        btn.addEventListener('click', function() {
          const voucherId = this.getAttribute('data-id');
          appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
          updateVoucherSelection();
          updateSelectedVouchers();
          saveAppState();
        });
      });
      
      // 添加移除全部面值按鈕的事件
      document.querySelectorAll('.remove-all-amount').forEach(btn => {
        btn.addEventListener('click', function() {
          const amount = parseInt(this.getAttribute('data-amount'));
          
          // 獲取該面值的所有已選擇優惠券ID
          const amountVoucherIds = selectedVouchers
            .filter(v => v.amount === amount)
            .map(v => v.id);
          
          // 從已選擇列表中移除
          appState.selectedVouchers = appState.selectedVouchers.filter(id => !amountVoucherIds.includes(id));
          
          updateVoucherSelection();
          updateSelectedVouchers();
          saveAppState();
        });
      });
      
      // 添加兑換按鈕的事件
      document.getElementById('redeem-selected-vouchers').addEventListener('click', function() {
        const spendAmount = parseFloat(redeemAmount.value) || 0;
        const requiredAmount = totalValue * 3;
        
        if (spendAmount < requiredAmount) {
          redeemError.classList.remove('hidden');
          redeemError.textContent = `消費金額必須至少為${requiredAmount}元`;
          return;
        }
        
        if (confirm(`確定要兑換${selectedVouchers.length}張優惠券，總值${totalValue}元嗎？`)) {
          // 記錄消費金額到週記錄
          const weekIndex = appState.weekRecords.findIndex(record => record.weekNum === appState.currentWeek);
          if (weekIndex !== -1) {
            appState.weekRecords[weekIndex].spendAmount = (appState.weekRecords[weekIndex].spendAmount || 0) + spendAmount;
          }
          
          // 記錄兑換歷史
          appState.redeemHistory.push({
            date: new Date().toISOString(),
            voucherIds: [...appState.selectedVouchers],
            voucherCount: selectedVouchers.length,
            voucherValue: totalValue,
            spendAmount: spendAmount,
            weekNum: appState.currentWeek
          });
          
          // 標記所有選擇的優惠券為已兑換
          selectedVouchers.forEach(voucher => {
            const v = appState.vouchers.find(v => v.id === voucher.id);
            if (v) v.used = true;
          });
          
          // 清空已選擇列表
          appState.selectedVouchers = [];
          
          // 更新UI
          saveAppState();
          updateUI();
          updateCharts(chartPeriodMode);
          
          // 清空消費金額輸入
          redeemAmount.value = '';
          
          // 顯示成功信息
          alert(`成功兑換${selectedVouchers.length}張優惠券！消費金額: ${spendAmount}元`);
        }
      });
      
      // 添加消費金額輸入框事件監聽
      redeemAmount.addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        const requiredAmount = totalValue * 3;
        
        if (amount > 0 && amount < requiredAmount) {
          redeemError.classList.remove('hidden');
          redeemError.textContent = `消費金額必須至少為${requiredAmount}元`;
        } else {
          redeemError.classList.add('hidden');
        }
      });
    }

    // 更新週次記錄顯示
    function updateWeekRecords() {
      const weekRecordsList = document.getElementById('week-records-list');
      const weekHistorySelect = document.getElementById('week-history-select');
      
      // 清空週次記錄列表
      weekRecordsList.innerHTML = '';
      
      // 清空週次選擇器並重新填充
      weekHistorySelect.innerHTML = '<option value="">-- 選擇週次 --</option>';
      weekSchedule.forEach(week => {
        const option = document.createElement('option');
        option.value = week.week;
        option.textContent = `第${week.week}週 (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
        weekHistorySelect.appendChild(option);
      });
      
      // 獲取當前週次
      const currentWeek = calculateCurrentWeek();
      
      // 確保有當前週次的記錄
      let currentWeekRecord = appState.weekRecords.find(r => r.weekNum === currentWeek);
      if (!currentWeekRecord && currentWeek >= 1 && currentWeek <= 10) {
        // 創建當前週次的記錄
        currentWeekRecord = createWeekRecord(currentWeek);
        if (currentWeekRecord) {
          appState.weekRecords.push(currentWeekRecord);
          saveAppState();
        }
      }
      
      // 如果沒有週次記錄，顯示提示信息
      if (appState.weekRecords.length === 0) {
        weekRecordsList.innerHTML = `
          <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            尚無週次記錄
          </div>
        `;
        return;
      }
      
      // 按週次排序
      const sortedRecords = [...appState.weekRecords].sort((a, b) => b.weekNum - a.weekNum);
      
      sortedRecords.forEach(record => {
        const recordItem = document.createElement('div');
        recordItem.className = 'border rounded-lg bg-white dark:bg-gray-800 overflow-hidden';
        
        // 計算總值和各個銀行的優惠券數量
        let bankList = '';
        let bankCount = 0;
        
        banks.forEach(bank => {
          const bankData = record.bankCounts?.[bank.id];
          if (bankData && bankData.count > 0) {
            bankCount++;
            bankList += `
              <div class="flex items-center mb-1 text-xs">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                <span>${bank.name}: ${bankData.count}張 (${bankData.value}元)</span>
              </div>
            `;
          }
        });
        
        // 創建記錄卡片
        recordItem.innerHTML = `
          <div class="px-4 py-3">
            <div class="flex justify-between items-start mb-2">
              <div class="font-bold text-lg">第${record.weekNum}週記錄</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">總優惠券</div>
                <div class="font-bold text-lg">${record.voucherCount}張</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">總價值</div>
                <div class="font-bold text-lg">${record.voucherValue}元</div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">消費金額</div>
                <div class="font-bold text-lg">${record.spendAmount || 0}元</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">已兑換</div>
                <div class="font-bold text-lg">${record.usedCount}張</div>
              </div>
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">優惠券分佈：</div>
            <div class="text-sm mb-2">
              ${record.valueCounts[0] > 0 ? `<span class="mr-2">0: ${record.valueCounts[0]}張</span>` : ''}
              ${record.valueCounts[1] > 0 ? `<span class="mr-2">10元: ${record.valueCounts[1]}張</span>` : ''}
              ${record.valueCounts[2] > 0 ? `<span class="mr-2">20元: ${record.valueCounts[2]}張</span>` : ''}
              ${record.valueCounts[3] > 0 ? `<span class="mr-2">50元: ${record.valueCounts[3]}張</span>` : ''}
              ${record.valueCounts[4] > 0 ? `<span class="mr-2">100元: ${record.valueCounts[4]}張</span>` : ''}
              ${record.valueCounts[5] > 0 ? `<span class="mr-2">200元: ${record.valueCounts[5]}張</span>` : ''}
            </div>
            ${bankCount > 0 ? `
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">銀行分佈：</div>
              <div class="mb-2">
                ${bankList}
              </div>
            ` : ''}
            ${record.notes ? `
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">備註：</div>
              <div class="text-sm mb-2">${record.notes}</div>
            ` : ''}
          </div>
          <div class="border-t px-3 py-2 flex justify-end">
            <button class="text-sm text-primary dark:text-primary hover:underline view-week-detail-btn" data-id="${record.id}">查看詳情</button>
          </div>
        `;
        
        weekRecordsList.appendChild(recordItem);
      });
      
      // 添加查看詳情功能
      document.querySelectorAll('.view-week-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          showWeekDetail(recordId);
        });
      });
      
      // 添加週次選擇下拉框的事件監聽
      weekHistorySelect.addEventListener('change', function() {
        const selectedWeek = this.value;
        if (selectedWeek) {
          const weekNum = parseInt(selectedWeek);
          // 查找該週次的記錄
          let weekRecord = appState.weekRecords.find(r => r.weekNum === weekNum);
          
          // 如果沒有該週次的記錄，則建立臨時記錄
          if (!weekRecord) {
            weekRecord = createWeekRecord(weekNum);
            // 如果是當前週次，保存記錄
            if (weekNum === currentWeek) {
              appState.weekRecords.push(weekRecord);
              saveAppState();
              updateWeekRecords(); // 重新加載列表
            }
          }
          
          if (weekRecord) {
            showWeekDetail(weekRecord.id);
          } else {
            alert(`無法查看第${weekNum}週的記錄。`);
          }
        }
      });
    }

    // 顯示週次詳情
    function showWeekDetail(recordId) {
      const record = appState.weekRecords.find(r => r.id === recordId);
      if (!record) return;
      
      const weekDetailModal = document.getElementById('week-detail-modal');
      const weekDetailTitle = document.getElementById('week-detail-title');
      const weekDetailContent = document.getElementById('week-detail-content');
      const closeDetailBtn = document.getElementById('close-detail-btn');
      const closeWeekDetail = document.getElementById('close-week-detail');
      
      // 設置標題
      weekDetailTitle.textContent = `第${record.weekNum}週詳細記錄`;
      
      // 計算已使用和未使用優惠券
      const usedPercentage = record.voucherCount > 0 ? Math.round((record.usedCount / record.voucherCount) * 100) : 0;
      
      // 生成各銀行抽獎狀態
      let bankDrawsHtml = '';
      banks.forEach(bank => {
        const bankDraw = record.bankDraws?.[bank.id];
        if (bankDraw) {
          bankDrawsHtml += `
            <div class="flex items-center justify-between py-1">
              <div class="flex items-center">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                <span>${bank.name}</span>
              </div>
              <div>
                已用 ${bankDraw.used}/3 次
              </div>
            </div>
          `;
        }
      });
      
      // 設置內容
      weekDetailContent.innerHTML = `
        <div class="space-y-4">
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">記錄時間</div>
            <div>${new Date(record.createdAt).toLocaleString()}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">週期範圍</div>
            <div>${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">優惠券使用情況</div>
            <div class="flex justify-between mb-1">
              <div>總數: ${record.voucherCount}張</div>
              <div>總值: ${record.voucherValue}元</div>
            </div>
            <div class="flex justify-between mb-1">
              <div>已兑換: ${record.usedCount}張</div>
              <div>未使用: ${record.voucherCount - record.usedCount}張</div>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
              <div class="bg-primary h-2.5 rounded-full" style="width: ${usedPercentage}%"></div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">消費金額</div>
            <div class="font-bold text-lg">${record.spendAmount || 0}元</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">優惠券面值分佈</div>
            <div class="grid grid-cols-6 gap-2 mb-2">
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[0] || 0}</div>
                <div class="text-xs">0</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[1] || 0}</div>
                <div class="text-xs">10元</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[2] || 0}</div>
                <div class="text-xs">20元</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[3] || 0}</div>
                <div class="text-xs">50元</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[4] || 0}</div>
                <div class="text-xs">100元</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[5] || 0}</div>
                <div class="text-xs">200元</div>
              </div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">各銀行優惠券</div>
            <div class="space-y-1">
              ${banks.map(bank => {
                const bankData = record.bankCounts?.[bank.id];
                return bankData && bankData.count > 0 ? `
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                      <span>${bank.name}</span>
                    </div>
                    <div>${bankData.count}張 (${bankData.value}元)</div>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">銀行抽獎狀態</div>
            <div class="space-y-1 border rounded-lg p-2">
              ${bankDrawsHtml}
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">週末消費記錄</div>
            <div>${record.weekendSpendsCount}筆</div>
          </div>
          
          ${record.notes ? `
            <div>
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">備註</div>
              <div class="border rounded-lg p-2">${record.notes}</div>
            </div>
          ` : ''}
        </div>
      `;
      
      // 顯示模態框
      weekDetailModal.classList.remove('hidden');
      
      // 關閉按鈕
      closeDetailBtn.addEventListener('click', () => {
        weekDetailModal.classList.add('hidden');
      });
      
      closeWeekDetail.addEventListener('click', () => {
        weekDetailModal.classList.add('hidden');
      });
    }

    // 獲取當前週次的優惠券
    function getVouchersForCurrentWeek() {
      return appState.vouchers.filter(voucher => {
        return getWeekNumberFromDate(voucher.date) === appState.currentWeek;
      });
    }

    // 根據日期獲取週次
    function getWeekNumberFromDate(dateString) {
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (dateString >= week.startDate && dateString <= week.endDate) {
          return i + 1;
        }
      }
      
      // 檢查週末日期
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        const resetDate = new Date(week.resetDate);
        const nextDay = new Date(resetDate);
        nextDay.setDate(resetDate.getDate() + 1);
        const nextDayStr = nextDay.toISOString().split('T')[0];
        
        if (dateString === week.resetDate || dateString === nextDayStr) {
          return i + 1;
        }
      }
      
      return 1; // 默認返回第一週
    }

    // 獲取對應週末的日期範圍
    function getWeekendDateRange(weekdayDate) {
      // 找到對應的週次
      let weekNum = -1;
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (weekdayDate >= week.startDate && weekdayDate <= week.endDate) {
          weekNum = i;
          break;
        }
      }
      
      if (weekNum >= 0) {
        const saturday = weekSchedule[weekNum].resetDate;
        
        // 計算週日 (Saturday + 1 day)
        const saturdayDate = new Date(saturday);
        const sundayDate = new Date(saturdayDate);
        sundayDate.setDate(saturdayDate.getDate() + 1);
        const sunday = sundayDate.toISOString().split('T')[0];
        
        return `${formatDate(saturday)} - ${formatDate(sunday)}`;
      }
      
      return '未知';
    }

    // 判斷優惠券是否過期
    function isVoucherExpired(voucher) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // 找到對應的週次
      let weekNum = -1;
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (voucher.date >= week.startDate && voucher.date <= week.endDate) {
          weekNum = i;
          break;
        }
      }
      
      if (weekNum >= 0) {
        const saturday = new Date(weekSchedule[weekNum].resetDate);
        
        // 計算週日 (Saturday + 1 day)
        const sunday = new Date(saturday);
        sunday.setDate(saturday.getDate() + 1);
        sunday.setHours(23, 59, 59, 999); // 設置為週日的最後一刻
        
        return today > sunday;
      }
      
      return false;
    }

    // 標記優惠券為已使用
    function markVoucherAsUsed(voucherId) {
      const voucher = appState.vouchers.find(v => v.id === voucherId);
      if (voucher) {
        voucher.used = true;
        saveAppState();
        updateUI();
        updateCharts(chartPeriodMode);
      }
    }

    // 顯示刪除確認對話框
    function showDeleteConfirmation(voucherId) {
      const confirmDeleteModal = document.getElementById('confirm-delete-modal');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');
      
      // 顯示模態框
      confirmDeleteModal.classList.remove('hidden');
      
      // 設置確認刪除按鈕的點擊事件
      const confirmHandler = () => {
        deleteVoucher(voucherId);
        confirmDeleteModal.classList.add('hidden');
        confirmDeleteBtn.removeEventListener('click', confirmHandler);
      };
      
      confirmDeleteBtn.addEventListener('click', confirmHandler);
      
      // 設置取消按鈕的點擊事件
      cancelDeleteBtn.addEventListener('click', () => {
        confirmDeleteModal.classList.add('hidden');
        confirmDeleteBtn.removeEventListener('click', confirmHandler);
      });
    }

    // 刪除優惠券
    function deleteVoucher(voucherId) {
      const voucher = appState.vouchers.find(v => v.id === voucherId);
      
      if (voucher) {
        // 如果刪除的是未使用的優惠券，恢復該銀行的抽獎次數
        if (!voucher.used && voucher.bankId && appState.bankDraws[voucher.bankId]) {
          appState.bankDraws[voucher.bankId].used--;
          appState.bankDraws[voucher.bankId].remaining++;
        }
        
        // 從數組中移除優惠券
        appState.vouchers = appState.vouchers.filter(v => v.id !== voucherId);
        
        // 從銀行記錄中移除
        if (voucher.bankId && appState.bankVouchers[voucher.bankId]) {
          appState.bankVouchers[voucher.bankId] = appState.bankVouchers[voucher.bankId].filter(id => id !== voucherId);
        }
        
        // 從已選擇列表中移除
        appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
        
        saveAppState();
        updateUI();
        updateCharts(chartPeriodMode);
      }
    }

    // 添加優惠券
    function addVoucher(amount) {
      if (!appState.preferredBank) {
        alert('請先選擇銀行！');
        return;
      }

      // 獲取當前銀行的抽獎次數
      if (!appState.bankDraws[appState.preferredBank]) {
        appState.bankDraws[appState.preferredBank] = {
          remaining: 3,
          used: 0
        };
      }
      
      const bankDraws = appState.bankDraws[appState.preferredBank];
      
      if (bankDraws.remaining <= 0) {
        alert(`${getBankName(appState.preferredBank)}本週抽獎次數已用完！`);
        return;
      }

      // 使用當前日期
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      
      // 創建新優惠券
      const newVoucher = {
        id: Date.now().toString(),
        amount: amount,
        date: todayString,
        used: false,
        bankId: appState.preferredBank
      };
      
      // 添加優惠券
      appState.vouchers.push(newVoucher);
      
      // 更新抽獎次數
      bankDraws.used++;
      bankDraws.remaining = Math.max(0, bankDraws.remaining - 1);
      
      // 添加到銀行記錄
      if (!appState.bankVouchers[appState.preferredBank]) {
        appState.bankVouchers[appState.preferredBank] = [];
      }
      appState.bankVouchers[appState.preferredBank].push(newVoucher.id);
      
      // 保存並更新UI
      saveAppState();
      updateUI();
      updateCharts(chartPeriodMode);
      updateCurrentWeekRecord(); // 更新当前周记录
    }

    // 獲取銀行名稱
    function getBankName(bankId) {
      const bank = banks.find(b => b.id === bankId);
      return bank ? bank.name : '未知銀行';
    }

    // 更新總體統計數據
    function updateTotalStats() {
      const totalVouchersElem = document.getElementById('total-vouchers');
      const totalValueElem = document.getElementById('total-value');
      const usageRateElem = document.getElementById('usage-rate');
      const expiryRateElem = document.getElementById('expiry-rate');
      
      // 計算總優惠券數量和總值
      const totalCount = appState.vouchers.length;
      const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
      
      // 計算已使用率
      const usedCount = appState.vouchers.filter(v => v.used).length;
      const usageRate = totalCount > 0 ? Math.round((usedCount / totalCount) * 100) : 0;
      
      // 計算已過期率
      const expiredCount = appState.vouchers.filter(v => !v.used && isVoucherExpired(v)).length;
      const expiryRate = totalCount > 0 ? Math.round((expiredCount / totalCount) * 100) : 0;
      
      // 更新UI
      totalVouchersElem.textContent = `${totalCount}張`;
      totalValueElem.textContent = `${totalValue}元`;
      usageRateElem.textContent = `${usageRate}%`;
      expiryRateElem.textContent = `${expiryRate}%`;
    }

    // 更新整個UI
    function updateUI() {
      updateCurrentDateDisplay();
      updateCurrentWeekDisplay();
      updateBankButtons();
      updateQuickAddPanel();
      updateBankOverview();
      updateRedeemableVouchers();
      updateVoucherSelection();
      updateSelectedVouchers();
      updateWeekRecords();
      updateWeekSchedule();
      updateTotalStats();
      updateWeekAmountDetailsContent();
    }

    // 匯出數據
    function exportData(format) {
      const exportModal = document.getElementById('export-data-modal');
      const exportContent = document.getElementById('export-content');
      const exportResult = document.getElementById('export-result');
      const copyExportBtn = document.getElementById('copy-export');
      
      let content = '';
      
      if (format === 'text') {
        // 生成文字摘要
        content = generateTextSummary();
      } else if (format === 'json') {
        // 生成JSON數據
        content = JSON.stringify(appState, null, 2);
      }
      
      // 顯示結果
      exportContent.textContent = content;
      exportResult.classList.remove('hidden');
      copyExportBtn.classList.remove('hidden');
      
      // 顯示模態框
      exportModal.classList.remove('hidden');
    }
    
    // 生成文字摘要
    function generateTextSummary() {
      let summary = `=== 2025年社區消費大獎賞 - 數據摘要 ===\n`;
      summary += `生成時間: ${new Date().toLocaleString()}\n\n`;
      
      // 總體統計
      const totalCount = appState.vouchers.length;
      const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
      const usedCount = appState.vouchers.filter(v => v.used).length;
      const unusedCount = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v)).length;
      const expiredCount = appState.vouchers.filter(v => !v.used && isVoucherExpired(v)).length;
      
      summary += `== 總體統計 ==\n`;
      summary += `總優惠券: ${totalCount}張 (${totalValue}元)\n`;
      summary += `已兑換: ${usedCount}張\n`;
      summary += `未使用: ${unusedCount}張\n`;
      summary += `已過期: ${expiredCount}張\n\n`;
      
      // 面值分佈
      const valueCounts = [0, 0, 0, 0, 0, 0]; // 0元, 10, 20, 50, 100, 200
      appState.vouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // 0元
          case 10: valueCounts[1]++; break;
          case 20: valueCounts[2]++; break;
          case 50: valueCounts[3]++; break;
          case 100: valueCounts[4]++; break;
          case 200: valueCounts[5]++; break;
        }
      });
      
      summary += `== 面值分佈 ==\n`;
      summary += `0: ${valueCounts[0]}張\n`;
      summary += `10元: ${valueCounts[1]}張\n`;
      summary += `20元: ${valueCounts[2]}張\n`;
      summary += `50元: ${valueCounts[3]}張\n`;
      summary += `100元: ${valueCounts[4]}張\n`;
      summary += `200元: ${valueCounts[5]}張\n\n`;
      
      // 銀行分佈
      summary += `== 銀行分佈 ==\n`;
      
      // 計算各銀行優惠券數量
      const bankCounts = {};
      banks.forEach(bank => {
        bankCounts[bank.id] = {
          count: 0,
          value: 0
        };
      });
      
      appState.vouchers.forEach(voucher => {
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId].count++;
          bankCounts[voucher.bankId].value += voucher.amount;
        }
      });
      
      // 按總值從高到低排序銀行
      const sortedBanks = banks
        .filter(bank => bankCounts[bank.id].count > 0)
        .sort((a, b) => bankCounts[b.id].value - bankCounts[a.id].value);
      
      sortedBanks.forEach(bank => {
        const data = bankCounts[bank.id];
        summary += `${bank.name}: ${data.count}張 (${data.value}元)\n`;
      });
      
      summary += `\n== 週次記錄 ==\n`;
      
      // 排序週次記錄
      const sortedRecords = [...appState.weekRecords].sort((a, b) => a.weekNum - b.weekNum);
      
      sortedRecords.forEach(record => {
        summary += `第${record.weekNum}週 (${formatDate(record.startDate)} - ${formatDate(record.endDate)}):\n`;
        summary += `  優惠券: ${record.voucherCount}張 (${record.voucherValue}元)\n`;
        summary += `  已兑換: ${record.usedCount}張\n`;
        summary += `  消費金額: ${record.spendAmount || 0}元\n`;
        
        if (record.notes) {
          summary += `  備註: ${record.notes}\n`;
        }
        
        summary += `\n`;
      });
      
      return summary;
    }

    // 初始化圖表
    let valueChart, bankChart, weekAmountChart, bankValueChart, statusChart;

    function initCharts() {
      // 設置Chart.js全局配置
      Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
      Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';
      
      // 優惠券總值圖表
      const valueCtx = document.getElementById('value-chart').getContext('2d');
      valueChart = new Chart(valueCtx, {
        type: 'bar',
        data: {
          labels: ['0', '10元', '20元', '50元', '100元', '200元'],
          datasets: [{
            label: '數量',
            data: [0, 0, 0, 0, 0, 0],
            backgroundColor: document.documentElement.classList.contains('dark') ? 
              ['#facc15', '#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc'] : 
              ['#fef08a', '#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = [0, 10, 20, 50, 100, 200][context.dataIndex];
                  if (context.dataIndex === 0) {
                    return `數量: ${context.raw}張 (0)`;
                  }
                  return `數量: ${context.raw}張 (價值: ${context.raw * value}元)`;
                }
              }
            }
          }
        }
      });
      
      // 銀行分佈圖表
      const bankCtx = document.getElementById('bank-chart').getContext('2d');
      bankChart = new Chart(bankCtx, {
        type: 'doughnut',
        data: {
          labels: banks.map(bank => bank.name),
          datasets: [{
            data: Array(banks.length).fill(0),
            backgroundColor: document.documentElement.classList.contains('dark') ? 
              chartColors.dark : chartColors.light
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 12,
                padding: 10
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${context.label}: ${value}張 (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // 週次面值分佈圖表
      const weekAmountCtx = document.getElementById('week-amount-chart').getContext('2d');
      weekAmountChart = new Chart(weekAmountCtx, {
        type: 'bar',
        data: {
          labels: Array.from({length: 10}, (_, i) => `第${i+1}週`),
          datasets: [
            {
              label: '0',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#facc15' : '#fef08a',
              stack: 'stack1'
            },
            {
              label: '10元',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#93c5fd' : '#dbeafe',
              stack: 'stack1'
            },
            {
              label: '20元',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#93c5fd' : '#dbeafe',
              stack: 'stack1'
            },
            {
              label: '50元',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#86efac' : '#dcfce7',
              stack: 'stack1'
            },
            {
              label: '100元',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#c084fc' : '#f3e8ff',
              stack: 'stack1'
            },
            {
              label: '200元',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#c084fc' : '#f3e8ff',
              stack: 'stack1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                boxWidth: 12,
                padding: 6
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw;
                  return `${label}: ${value}張`;
                }
              }
            }
          }
        }
      });
      
      // 銀行優惠券面值分佈圖表
      const bankValueCtx = document.getElementById('bank-value-chart').getContext('2d');
      bankValueChart = new Chart(bankValueCtx, {
        type: 'bar',
        data: {
          labels: banks.map(bank => bank.name),
          datasets: [
            {
              label: '0',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#facc15' : '#fef08a',
              stack: 'stack1'
            },
            {
              label: '10元',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#93c5fd' : '#dbeafe',
              stack: 'stack1'
            },
            {
              label: '20元',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#93c5fd' : '#dbeafe',
              stack: 'stack1'
            },
            {
              label: '50元',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#86efac' : '#dcfce7',
              stack: 'stack1'
            },
            {
              label: '100元',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#c084fc' : '#f3e8ff',
              stack: 'stack1'
            },
            {
              label: '200元',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#c084fc' : '#f3e8ff',
              stack: 'stack1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw;
                  return `${label}: ${value}張`;
                }
              }
            }
          }
        }
      });
      
      // 狀態分佈圖表
      const statusCtx = document.getElementById('status-chart').getContext('2d');
      statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
          labels: ['未使用', '已兑換', '已過期'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: [
              '#86efac', // 未使用
              '#93c5fd', // 已兑換
              '#f87171'  // 已過期
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value}張 (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // 首次更新圖表
      updateCharts(chartPeriodMode);
    }

    // 更新圖表
    function updateCharts(mode, selectedWeek = null) {
      if (!valueChart || !bankChart || !weekAmountChart || !bankValueChart || !statusChart) return;
      
      // 確定篩選的週次
      const filterWeek = selectedWeek || (mode === 'week' ? document.getElementById('chart-week-filter').value : 'all');
      
      // 篩選優惠券
      let filteredVouchers;
      if (filterWeek === 'all') {
        filteredVouchers = appState.vouchers;
      } else {
        const weekNum = parseInt(filterWeek);
        filteredVouchers = appState.vouchers.filter(v => getWeekNumberFromDate(v.date) === weekNum);
      }
      
      // 計算各面值優惠券數量
      const valueCounts = [0, 0, 0, 0, 0, 0]; // 0元, 10, 20, 50, 100, 200
      filteredVouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // 0元
          case 10: valueCounts[1]++; break;
          case 20: valueCounts[2]++; break;
          case 50: valueCounts[3]++; break;
          case 100: valueCounts[4]++; break;
          case 200: valueCounts[5]++; break;
        }
      });
      
      // 更新優惠券總值圖表
      valueChart.data.datasets[0].data = valueCounts;
      valueChart.update();
      
      // 計算各銀行優惠券數量
      const bankCounts = Array(banks.length).fill(0);
      filteredVouchers.forEach(voucher => {
        if (voucher.bankId) {
          const bankIndex = banks.findIndex(bank => bank.id === voucher.bankId);
          if (bankIndex >= 0) {
            bankCounts[bankIndex]++;
          }
        }
      });
      
      // 更新銀行分佈圖表
      bankChart.data.datasets[0].data = bankCounts;
      bankChart.update();
      
      // 銀行優惠券面值分佈數據
      const bankValueData = banks.map(() => ({
        0: 0,  // 0元
        10: 0, // 10元
        20: 0, // 20元
        50: 0, // 50元
        100: 0, // 100元
        200: 0  // 200元
      }));
      
      filteredVouchers.forEach(voucher => {
        if (voucher.bankId) {
          const bankIndex = banks.findIndex(bank => bank.id === voucher.bankId);
          if (bankIndex >= 0 && voucher.amount in bankValueData[bankIndex]) {
            bankValueData[bankIndex][voucher.amount]++;
          }
        }
      });
      
      // 更新銀行優惠券面值分佈圖表
      bankValueChart.data.datasets[0].data = bankValueData.map(data => data[0]); // 0元
      bankValueChart.data.datasets[1].data = bankValueData.map(data => data[10]); // 10元
      bankValueChart.data.datasets[2].data = bankValueData.map(data => data[20]); // 20元
      bankValueChart.data.datasets[3].data = bankValueData.map(data => data[50]); // 50元
      bankValueChart.data.datasets[4].data = bankValueData.map(data => data[100]); // 100元
      bankValueChart.data.datasets[5].data = bankValueData.map(data => data[200]); // 200元
      bankValueChart.update();
      
      // 優惠券狀態計數
      const statusCounts = [0, 0, 0]; // 未使用, 已兑換, 已過期
      
      filteredVouchers.forEach(voucher => {
        if (voucher.used) {
          statusCounts[1]++; // 已兑換
        } else if (isVoucherExpired(voucher)) {
          statusCounts[2]++; // 已過期
        } else {
          statusCounts[0]++; // 未使用
        }
      });
      
      // 更新狀態分佈圖表
      statusChart.data.datasets[0].data = statusCounts;
      statusChart.update();
      
      // 週次面值分佈
      if (filterWeek === 'all') {
        // 各週的面值分佈數據
        const weekAmountData = Array(10).fill().map(() => ({
          0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0
        }));
        
        // 計算各週的面值分佈
        appState.vouchers.forEach(voucher => {
          const weekNum = getWeekNumberFromDate(voucher.date);
          if (weekNum >= 1 && weekNum <= 10) {
            if (voucher.amount in weekAmountData[weekNum - 1]) {
              weekAmountData[weekNum - 1][voucher.amount]++;
            }
          }
        });
        
        // 更新週次面值分佈圖表
        weekAmountChart.data.datasets[0].data = weekAmountData.map(data => data[0]); // 0元
        weekAmountChart.data.datasets[1].data = weekAmountData.map(data => data[10]); // 10元
        weekAmountChart.data.datasets[2].data = weekAmountData.map(data => data[20]); // 20元
        weekAmountChart.data.datasets[3].data = weekAmountData.map(data => data[50]); // 50元
        weekAmountChart.data.datasets[4].data = weekAmountData.map(data => data[100]); // 100元
        weekAmountChart.data.datasets[5].data = weekAmountData.map(data => data[200]); // 200元
        weekAmountChart.update();
        
        // 顯示週次面值分佈圖表
        document.getElementById('week-amount-chart-container').style.display = '';
        updateWeekAmountDetailsContent();
      } else {
        // 如果選了特定週次，隱藏週次面值分佈圖表
        document.getElementById('week-amount-chart-container').style.display = 'none';
      }
    }

    // 更新週次面值详情数据
    function updateWeekAmountDetailsContent() {
      const weekAmountDetailsContent = document.getElementById('week-amount-details-content');
      weekAmountDetailsContent.innerHTML = '';
      
      // 計算各週的數據統計
      const weekStats = Array(10).fill().map(() => ({
        count: 0,
        value: 0,
        used: 0,
        spendAmount: 0,
        amounts: {0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0}
      }));
      
      // 計算各週的優惠券統計
      appState.vouchers.forEach(voucher => {
        const weekNum = getWeekNumberFromDate(voucher.date);
        if (weekNum >= 1 && weekNum <= 10) {
          weekStats[weekNum - 1].count++;
          weekStats[weekNum - 1].amounts[voucher.amount]++;
          if (voucher.amount > 0) {
            weekStats[weekNum - 1].value += voucher.amount;
          }
          if (voucher.used) {
            weekStats[weekNum - 1].used++;
          }
        }
      });
      
      // 添加消費金額數據
      appState.weekRecords.forEach(record => {
        if (record.weekNum >= 1 && record.weekNum <= 10) {
          weekStats[record.weekNum - 1].spendAmount = record.spendAmount || 0;
        }
      });
      
      // 生成詳細數據HTML
      for (let i = 0; i < weekStats.length; i++) {
        const stats = weekStats[i];
        if (stats.count > 0) {
          const weekDetail = document.createElement('div');
          weekDetail.className = 'p-2 border rounded';
          
          weekDetail.innerHTML = `
            <div class="font-medium">第${i + 1}週</div>
            <div class="grid grid-cols-2 gap-2 mt-1">
              <div>總計: ${stats.count}張 (${stats.value}元)</div>
              <div>已兑換: ${stats.used}張</div>
              <div>消費金額: ${stats.spendAmount}元</div>
              <div>未使用: ${stats.count - stats.used}張</div>
            </div>
            <div class="mt-1">面值分佈:</div>
            <div class="grid grid-cols-6 gap-1 mt-1">
              <div class="text-center text-xs ${stats.amounts[0] > 0 ? 'bg-yellow-100 dark:bg-yellow-900/30' : ''} rounded p-1">
                <div>${stats.amounts[0]}</div>
                <div>0</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[10] > 0 ? 'bg-blue-100 dark:bg-blue-900/30' : ''} rounded p-1">
                <div>${stats.amounts[10]}</div>
                <div>10元</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[20] > 0 ? 'bg-blue-100 dark:bg-blue-900/30' : ''} rounded p-1">
                <div>${stats.amounts[20]}</div>
                <div>20元</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[50] > 0 ? 'bg-green-100 dark:bg-green-900/30' : ''} rounded p-1">
                <div>${stats.amounts[50]}</div>
                <div>50元</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[100] > 0 ? 'bg-purple-100 dark:bg-purple-900/30' : ''} rounded p-1">
                <div>${stats.amounts[100]}</div>
                <div>100元</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[200] > 0 ? 'bg-purple-100 dark:bg-purple-900/30' : ''} rounded p-1">
                <div>${stats.amounts[200]}</div>
                <div>200元</div>
              </div>
            </div>
          `;
          
          weekAmountDetailsContent.appendChild(weekDetail);
        }
      }
      
      if (weekAmountDetailsContent.children.length === 0) {
        weekAmountDetailsContent.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">暫無數據</div>';
      }
    }

    // 計算最佳優惠券組合
    function calculateBestVoucherCombination(amount) {
      // 獲取所有未使用的優惠券
      const unusedVouchers = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v) && v.amount > 0); // 過濾掉0元
      
      // 按面值排序
      const sortedVouchers = unusedVouchers.sort((a, b) => b.amount - a.amount);
      
      // 按銀行分組
      const vouchersByBank = {};
      sortedVouchers.forEach(voucher => {
        if (!vouchersByBank[voucher.bankId]) {
          vouchersByBank[voucher.bankId] = [];
        }
        vouchersByBank[voucher.bankId].push(voucher);
      });
      
      // 生成所有可能的組合 (針對每個銀行)
      const bankCombinations = {};
      Object.keys(vouchersByBank).forEach(bankId => {
        const bankVouchers = vouchersByBank[bankId];
        bankCombinations[bankId] = findCombinations(bankVouchers, amount);
      });
      
      // 生成不同銀行混合的組合
      const mixedCombinations = findMixedCombinations(sortedVouchers, amount);
      
      // 找出最佳組合
      let bestCombination = null;
      let minDifference = Infinity;
      
      // 檢查每個銀行的組合
      Object.keys(bankCombinations).forEach(bankId => {
        const combinations = bankCombinations[bankId];
        if (combinations.length > 0) {
          combinations.forEach(combo => {
            const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
            const difference = comboSum - amount;
            if (difference >= 0 && difference < minDifference) {
              minDifference = difference;
              bestCombination = {
                vouchers: combo,
                sum: comboSum,
                difference: difference,
                mixed: false,
                bankId: bankId
              };
            }
          });
        }
      });
      
      // 檢查混合銀行的組合
      if (mixedCombinations.length > 0) {
        mixedCombinations.forEach(combo => {
          const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
          const difference = comboSum - amount;
          if (difference >= 0 && difference < minDifference) {
            minDifference = difference;
            bestCombination = {
              vouchers: combo,
              sum: comboSum,
              difference: difference,
              mixed: true
            };
          }
        });
      }
      
      // 如果沒有找到符合條件的組合，返回null
      if (!bestCombination && unusedVouchers.length > 0) {
        // 嘗試找出接近但小於目標金額的組合
        let maxSum = 0;
        let closestCombination = null;
        
        // 檢查每個銀行的組合
        Object.keys(bankCombinations).forEach(bankId => {
          const combinations = findCombinationsUnderTarget(vouchersByBank[bankId], amount);
          if (combinations.length > 0) {
            combinations.forEach(combo => {
              const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
              if (comboSum > maxSum) {
                maxSum = comboSum;
                closestCombination = {
                  vouchers: combo,
                  sum: comboSum,
                  difference: amount - comboSum,
                  mixed: false,
                  bankId: bankId,
                  underTarget: true
                };
              }
            });
          }
        });
        
        // 檢查混合銀行的組合
        const underTargetMixedCombinations = findCombinationsUnderTarget(sortedVouchers, amount);
        if (underTargetMixedCombinations.length > 0) {
          underTargetMixedCombinations.forEach(combo => {
            const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
            if (comboSum > maxSum) {
              maxSum = comboSum;
              closestCombination = {
                vouchers: combo,
                sum: comboSum,
                difference: amount - comboSum,
                mixed: true,
                underTarget: true
              };
            }
          });
        }
        
        return closestCombination;
      }
      
      return bestCombination;
    }

    // 尋找等於或超過目標金額的所有組合
    function findCombinations(vouchers, targetAmount) {
      const result = [];
      
      // 最多嘗試5張優惠券的組合，避免組合爆炸
      const maxVouchers = Math.min(5, vouchers.length);
      
      // 輔助函數，使用回溯法查找所有組合
      function backtrack(start, currentCombination, currentSum) {
        // 如果當前總和達到或超過目標金額，添加到結果中
        if (currentSum >= targetAmount) {
          result.push([...currentCombination]);
          return;
        }
        
        // 如果已經達到最大優惠券數量，返回
        if (currentCombination.length >= maxVouchers) {
          return;
        }
        
        // 嘗試添加更多優惠券
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // 開始回溯
      backtrack(0, [], 0);
      
      // 按總和排序，優先選擇總和最接近目標金額的組合
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumA - sumB;
      });
    }

    // 尋找混合銀行的組合
    function findMixedCombinations(vouchers, targetAmount) {
      // 這裡我們簡化一下，只考慮最多3張不同銀行的卡的組合
      const result = [];
      
      // 最多嘗試3張優惠券的組合，避免組合爆炸
      const maxVouchers = Math.min(3, vouchers.length);
      
      // 輔助函數，使用回溯法查找所有組合
      function backtrack(start, currentCombination, currentSum) {
        // 如果當前總和達到或超過目標金額，添加到結果中
        if (currentSum >= targetAmount) {
          result.push([...currentCombination]);
          return;
        }
        
        // 如果已經達到最大優惠券數量，返回
        if (currentCombination.length >= maxVouchers) {
          return;
        }
        
        // 嘗試添加更多優惠券
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // 開始回溯
      backtrack(0, [], 0);
      
      // 按總和排序，優先選擇總和最接近目標金額的組合
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumA - sumB;
      });
    }

    // 尋找小於目標金額的最大組合
    function findCombinationsUnderTarget(vouchers, targetAmount) {
      const result = [];
      
      // 最多嘗試5張優惠券的組合，避免組合爆炸
      const maxVouchers = Math.min(5, vouchers.length);
      
      // 輔助函數，使用回溯法查找所有組合
      function backtrack(start, currentCombination, currentSum) {
        // 如果當前總和小於目標金額，添加到結果中
        if (currentSum > 0 && currentSum < targetAmount) {
          result.push([...currentCombination]);
        }
        
        // 如果已經達到最大優惠券數量或當前總和已經達到或超過目標金額，返回
        if (currentCombination.length >= maxVouchers || currentSum >= targetAmount) {
          return;
        }
        
        // 嘗試添加更多優惠券
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // 開始回溯
      backtrack(0, [], 0);
      
      // 按總和降序排序，優先選擇總和最接近目標金額的組合
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumB - sumA; // 降序排列
      });
    }

    // 初始化選項卡功能
    function initTabs() {
      const tabButtons = document.querySelectorAll('#tabs button');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.getAttribute('data-tab');
          
          // 更新按鈕樣式
          tabButtons.forEach(btn => {
            btn.classList.remove('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
            btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
          });
          
          button.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
          button.classList.add('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
          
          // 顯示對應的內容
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          
          document.getElementById(`${tabName}-content`).classList.remove('hidden');
          
          // 如果切換到統計標籤，更新圖表
          if (tabName === 'stats') {
            updateCharts(chartPeriodMode);
          }
        });
      });
    }

    // 初始化圖表週次篩選功能
    function initChartWeekFilter() {
      const chartWeekFilter = document.getElementById('chart-week-filter');
      const toggleChartPeriod = document.getElementById('toggle-chart-period');
      const toggleText = document.getElementById('toggle-text');
      
      // 填充週次選項
      chartWeekFilter.innerHTML = '<option value="all">所有週次</option>';
      weekSchedule.forEach(week => {
        const option = document.createElement('option');
        option.value = week.week;
        option.textContent = `第${week.week}週 (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
        chartWeekFilter.appendChild(option);
      });
      
      // 週次篩選變化時更新圖表
      chartWeekFilter.addEventListener('change', function() {
        updateCharts(chartPeriodMode, this.value);
      });
      
      // 切換圖表週期模式按鈕
      toggleChartPeriod.addEventListener('click', function() {
        if (chartPeriodMode === 'week') {
          chartPeriodMode = 'all';
          toggleText.textContent = '切換至週次篩選';
          chartWeekFilter.style.display = 'none';
        } else {
          chartPeriodMode = 'week';
          toggleText.textContent = '切換至全部期間';
          chartWeekFilter.style.display = '';
        }
        updateCharts(chartPeriodMode);
      });
    }

    // 初始化優惠券組合推薦計算功能
    function initVoucherRecommendation() {
      const paymentAmountInput = document.getElementById('payment-amount');
      const calculateRecommendationBtn = document.getElementById('calculate-recommendation');
      const recommendationResult = document.getElementById('recommendation-result');
      
      // 計算推薦按鈕
      calculateRecommendationBtn.addEventListener('click', () => {
        const amount = parseInt(paymentAmountInput.value);
        if (isNaN(amount) || amount <= 0) {
          alert('請輸入有效的消費金額！');
          return;
        }
        
        // 計算最佳組合
        const bestCombination = calculateBestVoucherCombination(amount);
        
        // 顯示結果
        recommendationResult.classList.remove('hidden');
        
        if (!bestCombination) {
          recommendationResult.innerHTML = `
            <div class="text-center py-4">
              <div class="text-red-500 dark:text-red-400 mb-2">無法找到合適的優惠券組合</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">您目前沒有可用的優惠券，或者可用優惠券不足以支付該金額</div>
            </div>
          `;
          return;
        }
        
        // 根據是否小於目標金額顯示不同的提示
        const headerClass = bestCombination.underTarget ? 'text-yellow-500 dark:text-yellow-400' : 'text-green-500 dark:text-green-400';
        const headerText = bestCombination.underTarget ? 
          `找到最接近的組合（還需支付${bestCombination.difference}元）` : 
          `找到最佳組合（多${bestCombination.difference}元）`;
        
        // 根據是否混合銀行顯示不同的提示
        const bankText = bestCombination.mixed ? 
          '混合使用多家銀行的優惠券' : 
          `使用${getBankName(bestCombination.bankId)}的優惠券`;
        
        // 生成優惠券列表
        let vouchersList = '';
        const vouchersByAmount = {};
        
        bestCombination.vouchers.forEach(voucher => {
          if (!vouchersByAmount[voucher.amount]) {
            vouchersByAmount[voucher.amount] = { count: 0, banks: {} };
          }
          
          vouchersByAmount[voucher.amount].count++;
          
          if (!vouchersByAmount[voucher.amount].banks[voucher.bankId]) {
            vouchersByAmount[voucher.amount].banks[voucher.bankId] = 0;
          }
          
          vouchersByAmount[voucher.amount].banks[voucher.bankId]++;
        });
        
        // 按金額從大到小排序
        const amounts = Object.keys(vouchersByAmount).map(Number).sort((a, b) => b - a);
        
        amounts.forEach(amount => {
          const data = vouchersByAmount[amount];
          
          let bankDetails = '';
          Object.keys(data.banks).forEach(bankId => {
            const bank = banks.find(b => b.id === bankId);
            if (bank) {
              bankDetails += `
                <div class="flex items-center text-xs ml-4 mb-1">
                  <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                  <span>${bank.name}: ${data.banks[bankId]}張</span>
                </div>
              `;
            }
          });
          
          vouchersList += `
            <div class="mb-2">
              <div class="font-medium">${amount}元 × ${data.count}張 = ${amount * data.count}元</div>
              ${bankDetails}
            </div>
          `;
        });
        
        // 添加選擇按鈕
        const selectButtonsHtml = `
          <div class="mt-3 pt-3 border-t">
            <button id="select-recommended-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white py-2 rounded-lg">
              選擇這些優惠券
            </button>
          </div>
        `;
        
        recommendationResult.innerHTML = `
          <div>
            <div class="${headerClass} font-bold mb-2">${headerText}</div>
            <div class="text-sm mb-3">
              <div>消費金額: ${amount}元</div>
              <div>優惠券總額: ${bestCombination.sum}元</div>
              <div>使用優惠券數量: ${bestCombination.vouchers.length}張</div>
              <div>${bankText}</div>
            </div>
            <div class="border-t pt-2">
              <div class="font-medium mb-1">優惠券明細:</div>
              ${vouchersList}
            </div>
            ${!bestCombination.underTarget ? selectButtonsHtml : ''}
          </div>
        `;
        
        // 添加選擇推薦優惠券的功能
        if (!bestCombination.underTarget) {
          document.getElementById('select-recommended-vouchers').addEventListener('click', function() {
            // 添加選擇的優惠券到已選擇列表
            bestCombination.vouchers.forEach(voucher => {
              if (!appState.selectedVouchers.includes(voucher.id)) {
                appState.selectedVouchers.push(voucher.id);
              }
            });
            
            // 更新UI
            saveAppState();
            updateVoucherSelection();
            updateSelectedVouchers();
            
            // 如果不在兑換選項卡，切換到兑換選項卡
            document.querySelectorAll('#tabs button').forEach(button => {
              if (button.getAttribute('data-tab') === 'redeem') {
                button.click();
              }
            });
            
            // 隱藏結果面板並清空輸入框
            recommendationResult.classList.add('hidden');
            paymentAmountInput.value = '';
          });
        }
      });
      
      // 按Enter鍵也觸發計算
      paymentAmountInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          calculateRecommendationBtn.click();
        }
      });
    }

    // 初始化匯出數據功能
    function initExportData() {
      const exportDataBtn = document.getElementById('export-data-btn');
      const exportDataModal = document.getElementById('export-data-modal');
      const exportTextBtn = document.getElementById('export-text');
      const exportJsonBtn = document.getElementById('export-json');
      const closeExportModalBtn = document.getElementById('close-export-modal');
      const closeExportBtn = document.getElementById('close-export');
      const copyExportBtn = document.getElementById('copy-export');
      
      // 打開匯出數據模態框
      exportDataBtn.addEventListener('click', () => {
        exportDataModal.classList.remove('hidden');
        document.getElementById('export-result').classList.add('hidden');
        copyExportBtn.classList.add('hidden');
      });
      
      // 匯出文字摘要
      exportTextBtn.addEventListener('click', () => {
        exportData('text');
      });
      
      // 匯出JSON數據
      exportJsonBtn.addEventListener('click', () => {
        exportData('json');
      });
      
      // 複製到剪貼板
      copyExportBtn.addEventListener('click', () => {
        const content = document.getElementById('export-content').textContent;
        navigator.clipboard.writeText(content)
          .then(() => {
            copyExportBtn.textContent = '已複製!';
            setTimeout(() => {
              copyExportBtn.textContent = '複製到剪貼板';
            }, 2000);
          })
          .catch(err => {
            alert('複製失敗: ' + err);
          });
      });
      
      // 關閉匯出數據模態框
      closeExportModalBtn.addEventListener('click', () => {
        exportDataModal.classList.add('hidden');
      });
      
      closeExportBtn.addEventListener('click', () => {
        exportDataModal.classList.add('hidden');
      });
    }

    // 啟動應用程序
    document.addEventListener('DOMContentLoaded', function() {
      // 加載應用程序狀態
      loadAppState();
      
      // 初始化各功能
      initTabs();
      initVoucherRecommendation();
      initCharts();
      initChartWeekFilter();
      initExportData();
      
      // 更新界面
      updateUI();
      
      // 監聽深色模式變化來更新圖表顏色
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (valueChart && bankChart && weekAmountChart && bankValueChart && statusChart) {
          // 更新圖表顏色
          valueChart.data.datasets[0].backgroundColor = document.documentElement.classList.contains('dark') ? 
            ['#facc15', '#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc'] : 
            ['#fef08a', '#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff'];
          
          bankChart.data.datasets[0].backgroundColor = document.documentElement.classList.contains('dark') ? 
            chartColors.dark : chartColors.light;
          
          // 更新狀態圖表顏色
          statusChart.data.datasets[0].backgroundColor = document.documentElement.classList.contains('dark') ? 
            ['#86efac', '#93c5fd', '#f87171'] : 
            ['#dcfce7', '#dbeafe', '#fecaca'];
          
          // 更新所有圖表
          valueChart.update();
          bankChart.update();
          weekAmountChart.update();
          bankValueChart.update();
          statusChart.update();
          
          // 更新Chart.js全局配置
          Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
          Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';
        }
      });
    });
  </script>
</body>
</html>
