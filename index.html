<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025å¹´ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            'primary-dark': '#4B4AB2',
            'boc': '#c1272d',
            'boc-dark': '#a01e21',
            'icbc': '#c7000a',
            'icbc-dark': '#a00008',
            'macaupass': '#0c6e4f',
            'macaupass-dark': '#095338',
            'luso': '#00529b',
            'luso-dark': '#003e75',
            'ant': '#2c64ae',
            'ant-dark': '#1a4d8a',
            'mox': '#e20074',
            'mox-dark': '#b00058',
            'mpay': '#1e469a',
            'mpay-dark': '#173777',
            'gdb': '#e83828',
            'gdb-dark': '#b82116'
          }
        }
      }
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
  <div class="max-w-md mx-auto p-4">
    <!-- æ¨™é¡Œå’Œè¨ˆæ•¸å™¨ -->
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold text-primary dark:text-primary mb-2">2025å¹´ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨</h1>
      <div class="text-sm bg-blue-50 dark:bg-blue-900 p-2 rounded-lg">
        <div>
          ä»Šå¤©ï¼š<span id="current-date">è¼‰å…¥ä¸­...</span> | <span id="current-week">è¼‰å…¥ä¸­...</span>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½é¸é …å¡ -->
    <div class="mb-4">
      <div class="border-b border-gray-200 dark:border-gray-700">
        <ul class="flex flex-wrap" id="tabs">
          <li class="w-1/2 text-center">
            <button class="w-full py-2 px-1 text-primary dark:text-primary border-b-2 border-primary dark:border-primary tab-active" data-tab="earn">è³ºå–å„ªæƒ åˆ¸</button>
          </li>
          <li class="w-1/2 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="redeem">å…‘æ›å„ªæƒ åˆ¸</button>
          </li>
          <li class="w-1/3 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="stats">çµ±è¨ˆåœ–è¡¨</button>
          </li>
          <li class="w-1/3 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="history">é€±æ¬¡è¨˜éŒ„</button>
          </li>
          <li class="w-1/3 text-center">
            <button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="info">æ´»å‹•è³‡è¨Š</button>
          </li>
        </ul>
      </div>
    </div>

    <!-- è³ºå–å„ªæƒ åˆ¸é¢æ¿ -->
    <div class="tab-content" id="earn-content">
      <!-- éŠ€è¡Œé¸æ“‡æŒ‰éˆ•çµ„ -->
      <div class="mb-4">
        <div class="text-sm font-medium mb-2">é¸æ“‡æ”¯ä»˜å·¥å…· (é»æ“ŠéŠ€è¡Œæ·»åŠ å„ªæƒ åˆ¸)</div>
        <div class="grid grid-cols-4 gap-2" id="bank-buttons">
          <!-- éŠ€è¡ŒæŒ‰éˆ•å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
      </div>

      <!-- å¿«é€Ÿæ·»åŠ å„ªæƒ åˆ¸ (ç•¶é¸ä¸­éŠ€è¡Œæ™‚é¡¯ç¤º) -->
      <div id="quick-add-container" class="mb-4 hidden">
        <div class="text-sm font-medium mb-2">æ·»åŠ <span id="selected-bank-name-display">éŠ€è¡Œ</span>å„ªæƒ åˆ¸ (å‰©é¤˜: <span id="remaining-draws">3</span>æ¬¡)</div>
        <div class="grid grid-cols-3 gap-2 mb-2">
          <button data-amount="10" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
            10å…ƒ
          </button>
          <button data-amount="20" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
            20å…ƒ
          </button>
          <button data-amount="50" class="quick-add py-2 px-1 bg-green-100 dark:bg-green-900 rounded-lg text-center hover:bg-green-200 dark:hover:bg-green-800 transition-colors">
            50å…ƒ
          </button>
          <button data-amount="100" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">
            100å…ƒ
          </button>
          <button data-amount="200" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">
            200å…ƒ
          </button>
          <button data-amount="0" class="quick-add py-2 px-1 bg-yellow-100 dark:bg-yellow-900 rounded-lg text-center hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors">
            ğŸ˜„
          </button>
        </div>
      </div>

      <!-- éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½ -->
      <div class="mb-4">
        <h3 class="text-sm font-bold mb-2">å„éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½</h3>
        <div id="bank-overview-list" class="space-y-3">
          <!-- å„éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
      </div>

      <!-- åŒ¯å‡ºæ•¸æ“šæŒ‰éˆ• -->
      <div class="mt-6">
        <button id="export-data-btn" class="w-full bg-primary hover:bg-primary-dark text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
          <i class="ri-download-line mr-1"></i> åŒ¯å‡ºæ•¸æ“šåˆ†äº«çµ¦æœ‹å‹
        </button>
      </div>
    </div>

    <!-- å…‘æ›å„ªæƒ åˆ¸é¢æ¿ -->
    <div class="tab-content hidden" id="redeem-content">
      <!-- å¯ç”¨å„ªæƒ åˆ¸ç¸½è¦½ -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-sm font-bold">å¯ç”¨å„ªæƒ åˆ¸ç¸½è¦½</h3>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            æœªä½¿ç”¨: <span id="unused-vouchers-count" class="font-bold text-green-600 dark:text-green-400">0</span>å¼µ
          </div>
        </div>
        <div id="redeemable-vouchers-list" class="space-y-2">
          <!-- å¯ç”¨å„ªæƒ åˆ¸åˆ—è¡¨å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
      </div>

      <!-- å„ªæƒ åˆ¸é¸æ“‡å€åŸŸ -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
        <h3 class="text-sm font-bold mb-2">é¸æ“‡è¦å…‘æ›çš„å„ªæƒ åˆ¸</h3>
        <div id="redeem-voucher-selection" class="space-y-3">
          <!-- å„ªæƒ åˆ¸é¸æ“‡å€åŸŸå°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
      </div>

      <!-- å„ªæƒ åˆ¸è¨ˆç®—å™¨ -->
      <div class="mb-4 bg-green-50 dark:bg-green-900/20 rounded-lg p-3 shadow">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-sm font-medium">å„ªæƒ åˆ¸è¨ˆç®—å™¨</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">è¼¸å…¥é‡‘é¡è¨ˆç®—æœ€ä½³çµ„åˆ</div>
          </div>
        </div>
        
        <div class="flex space-x-2">
          <input type="number" id="payment-amount" min="1" placeholder="è¼¸å…¥æ¶ˆè²»é‡‘é¡" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
          <button id="calculate-recommendation" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
            è¨ˆç®—
          </button>
        </div>
        
        <!-- è¨ˆç®—çµæœå€åŸŸ -->
        <div id="recommendation-result" class="mt-3 border rounded-lg p-3 bg-white dark:bg-gray-800 hidden">
          <!-- æ¨è–¦çµæœå°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
      </div>

      <!-- å·²é¸æ“‡çš„å„ªæƒ åˆ¸åˆ—è¡¨ -->
      <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow mb-4">
        <h3 class="text-sm font-bold mb-2">å·²é¸æ“‡çš„å„ªæƒ åˆ¸</h3>
        <div id="selected-vouchers-list" class="space-y-2 mb-3">
          <div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šæœªé¸æ“‡å„ªæƒ åˆ¸</div>
        </div>
        <div id="selected-vouchers-summary" class="border-t pt-2 hidden">
          <div class="flex justify-between font-medium">
            <div>ç¸½è¨ˆ:</div>
            <div><span id="selected-vouchers-count">0</span>å¼µ (<span id="selected-vouchers-value">0</span>å…ƒ)</div>
          </div>
          <div class="mt-2">
            <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
              æ¶ˆè²»é‡‘é¡å¿…é ˆç‚ºå„ªæƒ åˆ¸ç¸½é¡çš„3å€æˆ–ä»¥ä¸Šæ‰èƒ½å…‘æ›
            </div>
            <div class="flex space-x-2">
              <input type="number" id="redeem-amount" min="1" placeholder="è¼¸å…¥æ¶ˆè²»é‡‘é¡" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
              <button id="redeem-selected-vouchers" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
                å…‘æ›
              </button>
            </div>
            <div id="redeem-error" class="text-red-500 dark:text-red-400 text-sm mt-1 hidden"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆåœ–è¡¨é¢æ¿ -->
    <div class="tab-content hidden" id="stats-content">
      <!-- ç¸½é«”çµ±è¨ˆ -->
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
        <h3 class="font-bold mb-2">ç¸½é«”çµ±è¨ˆ</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">ç¸½å„ªæƒ åˆ¸</div>
            <div class="text-xl font-bold" id="total-vouchers">0å¼µ</div>
          </div>
          <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">ç¸½åƒ¹å€¼</div>
            <div class="text-xl font-bold" id="total-value">0å…ƒ</div>
          </div>
          <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">å·²å…‘æ›ç‡</div>
            <div class="text-xl font-bold" id="usage-rate">0%</div>
          </div>
          <div class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400">å·²éæœŸç‡</div>
            <div class="text-xl font-bold" id="expiry-rate">0%</div>
          </div>
        </div>
      </div>
      
      <!-- é€±æ¬¡ç¯©é¸ -->
      <div class="mb-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-3">
          <div class="flex justify-between items-center">
            <label class="block text-sm font-medium">é¸æ“‡é€±æ¬¡ç¯©é¸</label>
            <button id="toggle-chart-period" class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary-dark">
              <span id="toggle-text">åˆ‡æ›è‡³å…¨éƒ¨æœŸé–“</span>
            </button>
          </div>
          <select id="chart-week-filter" class="w-full mt-2 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
            <option value="all">æ‰€æœ‰é€±æ¬¡</option>
            <!-- é€±æ¬¡é¸é …å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
          </select>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">å„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆ</h3>
        <div class="h-60">
          <canvas id="value-chart"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">å„éŠ€è¡Œå„ªæƒ åˆ¸åˆ†ä½ˆ</h3>
        <div class="h-60">
          <canvas id="bank-chart"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4" id="week-amount-chart-container">
        <h3 class="font-bold mb-3">é€±æ¬¡é¢å€¼åˆ†ä½ˆ</h3>
        <div class="h-60">
          <canvas id="week-amount-chart"></canvas>
        </div>
        <div class="mt-4 pt-3 border-t" id="week-amount-details">
          <h4 class="font-medium mb-2 text-sm">è©³ç´°æ•¸æ“š</h4>
          <div class="space-y-2 text-sm" id="week-amount-details-content">
            <!-- è©³ç´°æ•¸æ“šå°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
          </div>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4" id="bank-value-chart-container">
        <h3 class="font-bold mb-3">éŠ€è¡Œå„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆ</h3>
        <div class="h-80">
          <canvas id="bank-value-chart"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4" id="status-chart-container">
        <h3 class="font-bold mb-3">å„ªæƒ åˆ¸ç‹€æ…‹åˆ†ä½ˆ</h3>
        <div class="h-60">
          <canvas id="status-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- é€±æ¬¡è¨˜éŒ„é¢æ¿ -->
    <div class="tab-content hidden" id="history-content">
      <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">æ­·é€±è¨˜éŒ„</h3>
          <div class="flex space-x-2">
            <select id="week-history-select" class="text-sm border rounded-lg px-2 py-1 dark:bg-gray-700 dark:border-gray-600">
              <option value="">-- é¸æ“‡é€±æ¬¡ --</option>
              <!-- é€±æ¬¡é¸é …å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
            </select>
          </div>
        </div>
        
        <div id="week-records-list" class="space-y-3">
          <!-- é€±æ¬¡è¨˜éŒ„å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
      </div>
    </div>
    
    <!-- æ´»å‹•è³‡è¨Šé¢æ¿ -->
    <div class="tab-content hidden" id="info-content">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h3 class="font-bold mb-3">æ´»å‹•æ™‚é–“</h3>
        <p class="mb-2">2025å¹´3æœˆ24æ—¥è‡³2025å¹´6æœˆ1æ—¥</p>
        
        <h3 class="font-bold mb-2 mt-4">æŠ½çè³‡æ ¼</h3>
        <p class="mb-2">é€±ä¸€è‡³é€±äº”åœ¨æ¯é–“æ‰¿è¾¦æ©Ÿæ§‹æ”¯ä»˜å·¥å…·æ¶ˆè²»æ»¿50æ¾³é–€å…ƒï¼Œå¯ç²3æ¬¡æŠ½çæ©Ÿæœƒ</p>
        <p class="mb-2">é€±æœ«æ¶ˆè²»æ»¿50æ¾³é–€å…ƒï¼Œå¯ç²å¾—é€±æŠ½çåŠçµ‚æ¥µå¤§æŠ½çè³‡æ ¼</p>
        
        <h3 class="font-bold mb-2 mt-4">å„ªæƒ åˆ¸é¢å€¼</h3>
        <p class="mb-2">0ã€10ã€20ã€50ã€100 æˆ– 200 æ¾³é–€å…ƒ</p>
        
        <h3 class="font-bold mb-2 mt-4">ä½¿ç”¨é™åˆ¶</h3>
        <p class="mb-2">å„ªæƒ åˆ¸é ˆæ–¼ç²å¾—å¾Œç·Šæ¥çš„é€±å…­åŠé€±æ—¥ä½¿ç”¨ï¼Œé€¾æœŸç„¡æ•ˆ</p>
        <p class="mb-2">å…‘æ›æ™‚æ¶ˆè²»é‡‘é¡å¿…é ˆç‚ºå„ªæƒ åˆ¸ç¸½é¡çš„3å€æˆ–ä»¥ä¸Š</p>
        
        <h3 class="font-bold mb-2 mt-4">é€±æœŸæ™‚é–“è¡¨</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b dark:border-gray-700">
                <th class="text-left py-2">é€±æ¬¡</th>
                <th class="text-left py-2">æ´»å‹•æ™‚é–“</th>
                <th class="text-left py-2">æ¸…é›¶æ™‚é–“</th>
              </tr>
            </thead>
            <tbody id="week-schedule">
              <!-- é€±æœŸæ™‚é–“è¡¨å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æŸ¥çœ‹é€±æ¬¡è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="week-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold" id="week-detail-title">é€±æ¬¡è©³æƒ…</h3>
          <button id="close-week-detail" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div id="week-detail-content">
          <!-- é€±æ¬¡è©³æƒ…å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
        </div>
        
        <div class="mt-4 flex justify-end">
          <button id="close-detail-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
    
    <!-- ç¢ºèªåˆªé™¤æ¨¡æ…‹æ¡† -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">ç¢ºèªåˆªé™¤</h3>
        <p class="mb-4">ç¢ºå®šè¦åˆªé™¤é€™å¼µå„ªæƒ åˆ¸å—ï¼Ÿ</p>
        <div class="flex space-x-2">
          <button id="cancel-delete" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">å–æ¶ˆ</button>
          <button id="confirm-delete" class="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ç¢ºèªåˆªé™¤</button>
        </div>
      </div>
    </div>

    <!-- åŒ¯å‡ºæ•¸æ“šæ¨¡æ…‹æ¡† -->
    <div id="export-data-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">åŒ¯å‡ºæ•¸æ“š</h3>
          <button id="close-export-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div class="mb-4">
          <p class="mb-2">è«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼:</p>
          <div class="space-y-2">
            <button id="export-text" class="w-full py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
              åŒ¯å‡ºæ–‡å­—æ‘˜è¦
            </button>
            <button id="export-json" class="w-full py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
              åŒ¯å‡ºå®Œæ•´JSONæ•¸æ“š
            </button>
          </div>
        </div>
        
        <div id="export-result" class="border p-3 rounded-lg bg-gray-50 dark:bg-gray-900 max-h-60 overflow-y-auto mb-4 hidden">
          <pre id="export-content" class="text-xs whitespace-pre-wrap break-words"></pre>
        </div>
        
        <div class="flex space-x-2">
          <button id="copy-export" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors hidden">
            è¤‡è£½åˆ°å‰ªè²¼æ¿
          </button>
          <button id="close-export" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // è¨­ç½®æ·±è‰²æ¨¡å¼
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    // æ´»å‹•é€±æœŸæ•¸æ“š
    const weekSchedule = [
      { week: 1, startDate: '2025-03-24', endDate: '2025-03-28', resetDate: '2025-03-29' },
      { week: 2, startDate: '2025-03-31', endDate: '2025-04-04', resetDate: '2025-04-05' },
      { week: 3, startDate: '2025-04-07', endDate: '2025-04-11', resetDate: '2025-04-12' },
      { week: 4, startDate: '2025-04-14', endDate: '2025-04-18', resetDate: '2025-04-19' },
      { week: 5, startDate: '2025-04-21', endDate: '2025-04-25', resetDate: '2025-04-26' },
      { week: 6, startDate: '2025-04-28', endDate: '2025-05-02', resetDate: '2025-05-03' },
      { week: 7, startDate: '2025-05-05', endDate: '2025-05-09', resetDate: '2025-05-10' },
      { week: 8, startDate: '2025-05-12', endDate: '2025-05-16', resetDate: '2025-05-17' },
      { week: 9, startDate: '2025-05-19', endDate: '2025-05-23', resetDate: '2025-05-24' },
      { week: 10, startDate: '2025-05-26', endDate: '2025-05-30', resetDate: '2025-05-31' }
    ];

    // éŠ€è¡Œæ”¯ä»˜å·¥å…·
    const banks = [
      { id: 'boc', name: 'ä¸­åœ‹éŠ€è¡Œ', color: 'boc', darkColor: 'boc-dark', logo: 'ri-bank-fill' },
      { id: 'icbc', name: 'å·¥å•†éŠ€è¡Œ', color: 'icbc', darkColor: 'icbc-dark', logo: 'ri-bank-fill' },
      { id: 'luso', name: 'å¤§è±éŠ€è¡Œ', color: 'luso', darkColor: 'luso-dark', logo: 'ri-bank-fill' },
      { id: 'bnu', name: 'æ¾³é–€åœ‹éš›éŠ€è¡Œ', color: 'primary', darkColor: 'primary-dark', logo: 'ri-bank-fill' },
      { id: 'macaupass', name: 'æ¾³é–€é€š', color: 'macaupass', darkColor: 'macaupass-dark', logo: 'ri-bank-card-fill' },
      { id: 'ant', name: 'èèŸ»éŠ€è¡Œ', color: 'ant', darkColor: 'ant-dark', logo: 'ri-bank-fill' },
      { id: 'mpay', name: 'æ¾³é–€æ¥µæ˜“ä»˜', color: 'mpay', darkColor: 'mpay-dark', logo: 'ri-wallet-fill' },
      { id: 'gdb', name: 'å»£ç™¼éŠ€è¡Œ', color: 'gdb', darkColor: 'gdb-dark', logo: 'ri-bank-fill' }
    ];

    // åœ–è¡¨é¡è‰²
    const chartColors = {
      light: ['#c1272d', '#c7000a', '#00529b', '#5D5CDE', '#0c6e4f', '#2c64ae', '#1e469a', '#e83828'],
      dark: ['#e04a4a', '#e03e47', '#4a8fd1', '#7978E9', '#25a073', '#5589d4', '#4c76ca', '#f05a4a']
    };

    // ä¼˜æƒ åˆ¸é¡è‰²
    const voucherColors = {
      0: { light: '#fef08a', dark: '#facc15' }, // 0å…ƒ
      10: { light: '#dbeafe', dark: '#93c5fd' }, // 10å…ƒ
      20: { light: '#dbeafe', dark: '#93c5fd' }, // 20å…ƒ
      50: { light: '#dcfce7', dark: '#86efac' }, // 50å…ƒ
      100: { light: '#f3e8ff', dark: '#c084fc' }, // 100å…ƒ
      200: { light: '#f3e8ff', dark: '#c084fc' }  // 200å…ƒ
    };

    // åˆå§‹åŒ–åº”ç”¨ç¨‹åºçŠ¶æ€
    let appState = {
      vouchers: [],
      weekendSpends: [],
      currentWeek: 1,
      bankDraws: {}, // æ¯å®¶éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
      preferredBank: null,
      bankVouchers: {},
      weekRecords: [], // é€±æ¬¡è¨˜éŒ„
      selectedVouchers: [], // å…‘æ›æ™‚é¸æ“‡çš„å„ªæƒ åˆ¸
      redeemHistory: [] // å…‘æ›æ­·å²
    };

    // åœ–è¡¨é€±æœŸæ¨¡å¼
    let chartPeriodMode = 'week'; // 'week' or 'all'

    // å˜—è©¦å¾localStorageåŠ è¼‰æ•¸æ“š
    function loadAppState() {
      try {
        const savedState = JSON.parse(localStorage.getItem('voucherAppState'));
        if (savedState) {
          appState = savedState;
          
          // ç¢ºä¿selectedVouchersçµæ§‹å­˜åœ¨
          if (!appState.selectedVouchers) {
            appState.selectedVouchers = [];
          }
          
          // ç¢ºä¿redeemHistoryçµæ§‹å­˜åœ¨
          if (!appState.redeemHistory) {
            appState.redeemHistory = [];
          }
        }
        
        // ç¢ºä¿bankDrawsçµæ§‹å­˜åœ¨
        if (!appState.bankDraws) {
          appState.bankDraws = {};
        }
        
        // ç¢ºä¿weekRecordsçµæ§‹å­˜åœ¨
        if (!appState.weekRecords) {
          appState.weekRecords = [];
        }
        
        // åˆå§‹åŒ–æ¯å®¶éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
        banks.forEach(bank => {
          if (!appState.bankDraws[bank.id]) {
            appState.bankDraws[bank.id] = {
              remaining: 3,
              used: 0
            };
          }
        });
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°é€±æ¬¡è¨˜éŒ„
        updateCurrentWeekRecord();
      } catch (e) {
        console.error('Failed to load app state:', e);
      }
      
      updateUI();
    }

    // ä¿å­˜æ‡‰ç”¨ç¨‹åºç‹€æ…‹åˆ°localStorage
    function saveAppState() {
      try {
        localStorage.setItem('voucherAppState', JSON.stringify(appState));
      } catch (e) {
        console.error('Failed to save app state:', e);
      }
    }

    // è¨ˆç®—ç•¶å‰é€±æ¬¡
    function calculateCurrentWeek() {
      const today = new Date();
      const dateString = today.toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼
      
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (dateString >= week.startDate && dateString <= week.endDate) {
          return i + 1;
        }
      }
      
      // å¦‚æœç•¶å‰æ—¥æœŸä¸åœ¨ä»»ä½•é€±æ¬¡ç¯„åœå…§
      if (dateString < weekSchedule[0].startDate) {
        return 0; // æ´»å‹•å°šæœªé–‹å§‹
      } else if (dateString > weekSchedule[weekSchedule.length - 1].endDate) {
        return 11; // æ´»å‹•å·²çµæŸ
      }
      
      // æª¢æŸ¥æ˜¯å¦åœ¨é€±æœ«
      for (let i = 0; i < weekSchedule.length - 1; i++) {
        if (dateString > weekSchedule[i].endDate && dateString < weekSchedule[i + 1].startDate) {
          return i + 1; // è¿”å›ç•¶å‰çš„é€±æœ«æ‰€å±¬çš„é€±æ¬¡
        }
      }
      
      return 1; // é»˜èªè¿”å›ç¬¬ä¸€é€±
    }

    // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
    function formatDate(dateString) {
      const date = new Date(dateString);
      return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    }

    // é¡¯ç¤ºä»Šå¤©æ—¥æœŸ
    function updateCurrentDateDisplay() {
      const currentDateElem = document.getElementById('current-date');
      const today = new Date();
      currentDateElem.textContent = formatDate(today.toISOString().split('T')[0]);
    }

    // æ›´æ–°ç•¶å‰é€±æ¬¡è¨˜éŒ„
    function updateCurrentWeekRecord() {
      const currentWeek = calculateCurrentWeek();
      if (currentWeek < 1 || currentWeek > 10) return; // è¶…å‡ºæ´»å‹•ç¯„åœ
      
      appState.currentWeek = currentWeek;
      
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç•¶å‰é€±æ¬¡çš„è¨˜éŒ„
      const existingRecord = appState.weekRecords.find(record => record.weekNum === currentWeek);
      
      // å¦‚æœæ²’æœ‰ç•¶å‰é€±æ¬¡çš„è¨˜éŒ„ï¼Œç”Ÿæˆä¸€å€‹
      if (!existingRecord) {
        const newRecord = createWeekRecord(currentWeek);
        if (newRecord) {
          appState.weekRecords.push(newRecord);
          appState.weekRecords.sort((a, b) => b.weekNum - a.weekNum);
        }
      } else {
        // æ›´æ–°ç¾æœ‰çš„è¨˜éŒ„
        const index = appState.weekRecords.findIndex(record => record.weekNum === currentWeek);
        if (index !== -1) {
          const updatedRecord = createWeekRecord(currentWeek, existingRecord.notes);
          updatedRecord.id = existingRecord.id; // ä¿ç•™åŸID
          updatedRecord.createdAt = existingRecord.createdAt; // ä¿ç•™åŸåˆ›å»ºæ—¶é—´
          updatedRecord.spendAmount = existingRecord.spendAmount || 0; // ä¿ç•™æ¶ˆè²»é‡‘é¡
          appState.weekRecords[index] = updatedRecord;
        }
      }
      
      saveAppState();
    }

    // å‰µå»ºé€±æ¬¡è¨˜éŒ„
    function createWeekRecord(weekNum, notes = '') {
      const weekData = weekSchedule[weekNum - 1];
      
      if (!weekData) return null;
      
      // ç²å–è©²é€±çš„å„ªæƒ åˆ¸
      const weekVouchers = appState.vouchers.filter(voucher => {
        const voucherWeek = getWeekNumberFromDate(voucher.date);
        return voucherWeek === weekNum;
      });
      
      // è¨ˆç®—å„é¢å€¼å„ªæƒ åˆ¸æ•¸é‡
      const valueCounts = [0, 0, 0, 0, 0, 0]; // 0å…ƒ, 10, 20, 50, 100, 200
      let totalValue = 0;
      weekVouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // 0å…ƒ
          case 10: valueCounts[1]++; totalValue += 10; break;
          case 20: valueCounts[2]++; totalValue += 20; break;
          case 50: valueCounts[3]++; totalValue += 50; break;
          case 100: valueCounts[4]++; totalValue += 100; break;
          case 200: valueCounts[5]++; totalValue += 200; break;
        }
      });
      
      // è¨ˆç®—å„éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡
      const bankCounts = {};
      banks.forEach(bank => {
        bankCounts[bank.id] = {
          count: 0,
          value: 0
        };
      });
      
      weekVouchers.forEach(voucher => {
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId].count++;
          bankCounts[voucher.bankId].value += voucher.amount;
        }
      });
      
      // ç²å–è©²é€±çš„é€±æœ«æ¶ˆè²»
      const weekendSpends = appState.weekendSpends.filter(spend => {
        const spendWeek = getWeekNumberFromDate(spend.date);
        return spendWeek === weekNum;
      });
      
      // å‰µå»ºé€±æ¬¡è¨˜éŒ„
      const weekRecord = {
        id: Date.now().toString(),
        weekNum: weekNum,
        startDate: weekData.startDate,
        endDate: weekData.endDate,
        createdAt: new Date().toISOString(),
        notes: notes,
        voucherCount: weekVouchers.length,
        voucherValue: totalValue,
        valueCounts: valueCounts,
        bankCounts: bankCounts,
        usedCount: weekVouchers.filter(v => v.used).length,
        weekendSpendsCount: weekendSpends.length,
        bankDraws: JSON.parse(JSON.stringify(appState.bankDraws)), // æ·±æ‹·è²ç•¶å‰éŠ€è¡ŒæŠ½çç‹€æ…‹
        spendAmount: 0 // åˆå§‹æ¶ˆè²»é‡‘é¡ç‚º0
      };
      
      return weekRecord;
    }

    // æ›´æ–°é€±æœŸæ™‚é–“è¡¨
    function updateWeekSchedule() {
      const tableBody = document.getElementById('week-schedule');
      tableBody.innerHTML = '';
      
      weekSchedule.forEach(week => {
        const row = document.createElement('tr');
        row.className = 'border-b dark:border-gray-700';
        
        const weekCell = document.createElement('td');
        weekCell.className = 'py-2';
        weekCell.textContent = `ç¬¬${week.week}é€±`;
        
        const timeCell = document.createElement('td');
        timeCell.className = 'py-2';
        timeCell.textContent = `${formatDate(week.startDate)} - ${formatDate(week.endDate)}`;
        
        const resetCell = document.createElement('td');
        resetCell.className = 'py-2';
        resetCell.textContent = formatDate(week.resetDate);
        
        row.appendChild(weekCell);
        row.appendChild(timeCell);
        row.appendChild(resetCell);
        
        tableBody.appendChild(row);
      });
    }

    // æ›´æ–°ç•¶å‰é€±æ¬¡é¡¯ç¤º
    function updateCurrentWeekDisplay() {
      const currentWeekElem = document.getElementById('current-week');
      const weekNum = calculateCurrentWeek();
      appState.currentWeek = weekNum;
      
      if (weekNum === 0) {
        currentWeekElem.textContent = 'æ´»å‹•å°šæœªé–‹å§‹';
      } else if (weekNum > 10) {
        currentWeekElem.textContent = 'æ´»å‹•å·²çµæŸ';
      } else {
        const weekData = weekSchedule[weekNum - 1];
        currentWeekElem.textContent = `ç¬¬${weekNum}é€± (${formatDate(weekData.startDate)} - ${formatDate(weekData.endDate)})`;
      }
    }

    // æ›´æ–°éŠ€è¡ŒæŒ‰éˆ•é¡¯ç¤º
    function updateBankButtons() {
      const bankButtonsContainer = document.getElementById('bank-buttons');
      bankButtonsContainer.innerHTML = '';
      
      banks.forEach(bank => {
        const bankButton = document.createElement('div');
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºé¸ä¸­çš„éŠ€è¡Œ
        const isSelected = appState.preferredBank === bank.id;
        
        bankButton.className = `p-2 rounded-lg cursor-pointer flex flex-col items-center transition-colors ${
          isSelected ? 
          `bg-${bank.color} text-white` : 
          `bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700`
        }`;
        bankButton.setAttribute('data-bank-id', bank.id);
        
        // ç²å–è©²éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
        const bankDraws = appState.bankDraws[bank.id] || { remaining: 3, used: 0 };
        
        // è¨­ç½®æŒ‰éˆ•å…§å®¹
        bankButton.innerHTML = `
          <i class="${bank.logo} text-2xl ${isSelected ? 'text-white' : `text-${bank.color} dark:text-${bank.color}`}"></i>
          <div class="text-xs mt-1 ${isSelected ? 'text-white' : ''}">${bank.name}</div>
          <div class="text-xs ${isSelected ? 'text-white' : 'text-gray-500 dark:text-gray-400'}">${bankDraws.remaining}/3</div>
        `;
        
        // æ·»åŠ é»æ“Šäº‹ä»¶
        bankButton.addEventListener('click', () => {
          selectBank(bank.id);
        });
        
        bankButtonsContainer.appendChild(bankButton);
      });
    }

    // é¸æ“‡éŠ€è¡Œ
    function selectBank(bankId) {
      appState.preferredBank = bankId;
      
      // æ›´æ–°UI
      updateBankButtons();
      updateQuickAddPanel();
      
      // ä¿å­˜ç‹€æ…‹
      saveAppState();
    }

    // æ›´æ–°å¿«é€Ÿæ·»åŠ é¢æ¿
    function updateQuickAddPanel() {
      const quickAddContainer = document.getElementById('quick-add-container');
      const selectedBankNameDisplay = document.getElementById('selected-bank-name-display');
      const remainingDrawsDisplay = document.getElementById('remaining-draws');
      
      if (appState.preferredBank) {
        // é¡¯ç¤ºå¿«é€Ÿæ·»åŠ é¢æ¿
        quickAddContainer.classList.remove('hidden');
        
        // ç²å–éŠ€è¡Œä¿¡æ¯
        const bank = banks.find(b => b.id === appState.preferredBank);
        selectedBankNameDisplay.textContent = bank ? bank.name : 'éŠ€è¡Œ';
        
        // ç²å–å‰©é¤˜æŠ½çæ¬¡æ•¸
        const bankDraws = appState.bankDraws[appState.preferredBank];
        remainingDrawsDisplay.textContent = bankDraws ? bankDraws.remaining : 3;
      } else {
        // éš±è—å¿«é€Ÿæ·»åŠ é¢æ¿
        quickAddContainer.classList.add('hidden');
      }
    }

    // æ›´æ–°éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½
    function updateBankOverview() {
      const bankOverviewList = document.getElementById('bank-overview-list');
      bankOverviewList.innerHTML = '';
      
      // è¨ˆç®—å„éŠ€è¡Œå„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆ
      const bankDistribution = {};
      
      // åˆå§‹åŒ–æ¯å€‹éŠ€è¡Œçš„é¢å€¼åˆ†ä½ˆ
      banks.forEach(bank => {
        bankDistribution[bank.id] = {
          0: 0,    // 0å…ƒ
          10: 0,   // 10å…ƒ
          20: 0,   // 20å…ƒ
          50: 0,   // 50å…ƒ
          100: 0,  // 100å…ƒ
          200: 0,  // 200å…ƒ
          count: 0, // ç¸½æ•¸
          total: 0, // ç¸½å€¼
          unused: {
            0: 0,
            10: 0,
            20: 0,
            50: 0,
            100: 0,
            200: 0,
            count: 0,
            total: 0
          }
        };
      });
      
      // è¨ˆç®—æ¯å€‹éŠ€è¡Œçš„å„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆ
      appState.vouchers.forEach(voucher => {
        if (voucher.bankId && bankDistribution[voucher.bankId]) {
          if (voucher.amount in bankDistribution[voucher.bankId]) {
            bankDistribution[voucher.bankId][voucher.amount]++;
            bankDistribution[voucher.bankId].count++;
            if (voucher.amount > 0) {
              bankDistribution[voucher.bankId].total += voucher.amount;
            }
            
            // è¨ˆç®—æœªä½¿ç”¨çš„å„ªæƒ åˆ¸
            if (!voucher.used && !isVoucherExpired(voucher)) {
              bankDistribution[voucher.bankId].unused[voucher.amount]++;
              bankDistribution[voucher.bankId].unused.count++;
              if (voucher.amount > 0) {
                bankDistribution[voucher.bankId].unused.total += voucher.amount;
              }
            }
          }
        }
      });
      
      // æŒ‰ç¸½æ•¸å¾é«˜åˆ°ä½æ’åºéŠ€è¡Œ
      const sortedBanks = banks
        .filter(bank => bankDistribution[bank.id].count > 0)
        .sort((a, b) => bankDistribution[b.id].total - bankDistribution[a.id].total);
      
      // å‰µå»ºéŠ€è¡Œå„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆé¡¯ç¤º
      if (sortedBanks.length === 0) {
        bankOverviewList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šæœªæ·»åŠ ä»»ä½•å„ªæƒ åˆ¸</div>';
        return;
      }
      
      // è¨ˆç®—ç¸½è¨ˆ
      const totalCounts = {
        0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
        count: 0,
        total: 0,
        unused: {
          0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
          count: 0,
          total: 0
        }
      };
      
      Object.values(bankDistribution).forEach(data => {
        totalCounts[0] += data[0];
        totalCounts[10] += data[10];
        totalCounts[20] += data[20];
        totalCounts[50] += data[50];
        totalCounts[100] += data[100];
        totalCounts[200] += data[200];
        totalCounts.count += data.count;
        totalCounts.total += data.total;
        
        totalCounts.unused[0] += data.unused[0];
        totalCounts.unused[10] += data.unused[10];
        totalCounts.unused[20] += data.unused[20];
        totalCounts.unused[50] += data.unused[50];
        totalCounts.unused[100] += data.unused[100];
        totalCounts.unused[200] += data.unused[200];
        totalCounts.unused.count += data.unused.count;
        totalCounts.unused.total += data.unused.total;
      });
      
      // ç¸½è¨ˆå¡ç‰‡
      const totalCard = document.createElement('div');
      totalCard.className = 'bg-primary-50 dark:bg-primary-900/30 border-primary border rounded-lg p-3';
      
      // é¢å€¼åˆ†ä½ˆ
      const distributionDiv = document.createElement('div');
      distributionDiv.className = 'grid grid-cols-6 gap-1 text-center';
      
      // æ·»åŠ å„é¢å€¼é¡¯ç¤º
      const denominations = [0, 10, 20, 50, 100, 200];
      const colorClasses = [
        'bg-yellow-100 dark:bg-yellow-900', // 0å…ƒ
        'bg-blue-100 dark:bg-blue-900',     // 10å…ƒ
        'bg-blue-100 dark:bg-blue-900',     // 20å…ƒ
        'bg-green-100 dark:bg-green-900',   // 50å…ƒ
        'bg-purple-100 dark:bg-purple-900', // 100å…ƒ
        'bg-purple-100 dark:bg-purple-900'  // 200å…ƒ
      ];
      
      const totalHeader = document.createElement('div');
      totalHeader.className = 'flex justify-between items-center mb-2 pb-2 border-b dark:border-gray-700';
      totalHeader.innerHTML = `
        <div class="font-bold">ç¸½è¨ˆ</div>
        <div class="text-sm">
          ${totalCounts.count}å¼µ (${totalCounts.total}å…ƒ)
          <div class="text-xs text-green-600 dark:text-green-400">
            å¯ç”¨: ${totalCounts.unused.count}å¼µ (${totalCounts.unused.total}å…ƒ)
          </div>
        </div>
      `;
      
      denominations.forEach((value, index) => {
        const count = totalCounts[value] || 0;
        const unusedCount = totalCounts.unused[value] || 0;
        const valueBlock = document.createElement('div');
        valueBlock.className = `${colorClasses[index]} rounded p-2 ${count > 0 ? '' : 'opacity-30'}`;
        
        const displayText = value === 0 ? '0' : `${value}å…ƒ`;
        
        valueBlock.innerHTML = `
          <div class="font-bold">${count}</div>
          <div class="text-xs">${displayText}</div>
          ${unusedCount > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯ç”¨: ${unusedCount}</div>` : ''}
        `;
        
        distributionDiv.appendChild(valueBlock);
      });
      
      totalCard.appendChild(totalHeader);
      totalCard.appendChild(distributionDiv);
      bankOverviewList.appendChild(totalCard);
      
      // æ·»åŠ å„éŠ€è¡Œçš„é¢å€¼åˆ†ä½ˆ
      sortedBanks.forEach(bank => {
        const data = bankDistribution[bank.id];
        const bankCard = document.createElement('div');
        bankCard.className = 'bg-white dark:bg-gray-800 border rounded-lg p-3 mt-3';
        
        // éŠ€è¡Œæ¨™é¡Œ
        const bankHeader = document.createElement('div');
        bankHeader.className = `flex items-center justify-between mb-2 pb-2 border-b dark:border-gray-700`;
        bankHeader.innerHTML = `
          <div class="flex items-center">
            <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
            <span class="font-bold">${bank.name}</span>
          </div>
          <div class="text-sm">
            ${data.count}å¼µ (${data.total}å…ƒ)
            <div class="text-xs text-green-600 dark:text-green-400">
              å¯ç”¨: ${data.unused.count}å¼µ (${data.unused.total}å…ƒ)
            </div>
          </div>
        `;
        
        // é¢å€¼åˆ†ä½ˆ
        const bankDistributionDiv = document.createElement('div');
        bankDistributionDiv.className = 'grid grid-cols-6 gap-1 text-center';
        
        denominations.forEach((value, index) => {
          const count = data[value] || 0;
          const unusedCount = data.unused[value] || 0;
          const valueBlock = document.createElement('div');
          
          // å»ºç«‹ä¸€å€‹å¯ç·¨è¼¯çš„å¡Šï¼Œå¸¶æœ‰å¢åŠ /æ¸›å°‘æŒ‰éˆ•
          valueBlock.className = `${colorClasses[index]} rounded p-2 relative ${count > 0 ? '' : 'opacity-30'}`;
          
          const displayText = value === 0 ? '0' : `${value}å…ƒ`;
          
          valueBlock.innerHTML = `
            <div class="font-bold">${count}</div>
            <div class="text-xs">${displayText}</div>
            ${unusedCount > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯ç”¨: ${unusedCount}</div>` : ''}
            <div class="absolute bottom-1 right-1 flex flex-col space-y-0.5 opacity-0 group-hover:opacity-100 hover:opacity-100">
              <button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded-full w-4 h-4 flex items-center justify-center text-xs hover:bg-gray-300 dark:hover:bg-gray-600"
                      data-bank="${bank.id}" data-amount="${value}">+</button>
            </div>
          `;
          
          // æ·»åŠ ç·¨è¼¯åŠŸèƒ½
          valueBlock.addEventListener('mouseenter', function() {
            this.querySelector('div:last-child').classList.remove('opacity-0');
          });
          
          valueBlock.addEventListener('mouseleave', function() {
            this.querySelector('div:last-child').classList.add('opacity-0');
          });
          
          bankDistributionDiv.appendChild(valueBlock);
        });
        
        // æ·»åŠ ç·¨è¼¯æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
        bankCard.appendChild(bankHeader);
        bankCard.appendChild(bankDistributionDiv);
        bankOverviewList.appendChild(bankCard);
      });
      
      // æ·»åŠ å¢åŠ å„ªæƒ åˆ¸æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
      document.querySelectorAll('.add-voucher-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const amount = parseInt(this.getAttribute('data-amount'));
          
          appState.preferredBank = bankId;
          addVoucher(amount);
        });
      });
    }

    // æ›´æ–°å¯å…‘æ›å„ªæƒ åˆ¸åˆ—è¡¨
    function updateRedeemableVouchers() {
      const redeemableVouchersList = document.getElementById('redeemable-vouchers-list');
      const unusedVouchersCount = document.getElementById('unused-vouchers-count');
      
      // è·å–æ‰€æœ‰æœªä½¿ç”¨ä¸”æœªè¿‡æœŸçš„ä¼˜æƒ åˆ¸
      const unusedVouchers = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v));
      
      // æ›´æ–°æœªä½¿ç”¨å„ªæƒ åˆ¸æ•¸é‡
      unusedVouchersCount.textContent = unusedVouchers.length;
      
      // å¦‚æœæ²¡æœ‰å¯ç”¨ä¼˜æƒ åˆ¸ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
      if (unusedVouchers.length === 0) {
        redeemableVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>';
        return;
      }
      
      // è®¡ç®—å„é¢å€¼çš„å„ªæƒ åˆ¸æ•°é‡
      const valueCounts = {
        0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
        total: 0, count: 0
      };
      
      // è®¡ç®—å„é“¶è¡Œçš„å„ªæƒ åˆ¸æ•°é‡
      const bankCounts = {};
      banks.forEach(bank => {
        bankCounts[bank.id] = {
          0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
          total: 0, count: 0
        };
      });
      
      unusedVouchers.forEach(voucher => {
        // æ›´æ–°é¢å€¼ç»Ÿè®¡
        valueCounts[voucher.amount]++;
        valueCounts.count++;
        if (voucher.amount > 0) {
          valueCounts.total += voucher.amount;
        }
        
        // æ›´æ–°é“¶è¡Œç»Ÿè®¡
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId][voucher.amount]++;
          bankCounts[voucher.bankId].count++;
          if (voucher.amount > 0) {
            bankCounts[voucher.bankId].total += voucher.amount;
          }
        }
      });
      
      // åˆ›å»ºæ€»ä½“æ‘˜è¦
      redeemableVouchersList.innerHTML = `
        <div class="flex justify-between items-center p-2 bg-primary-50 dark:bg-primary-900/20 rounded">
          <div>ç¸½è¨ˆ</div>
          <div class="text-right">
            <div>${valueCounts.count}å¼µ (${valueCounts.total}å…ƒ)</div>
          </div>
        </div>
        
        <div class="grid grid-cols-6 gap-1 text-center my-2">
          <div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 ${valueCounts[0] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[0]}</div>
            <div class="text-xs">0</div>
          </div>
          <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[10] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[10]}</div>
            <div class="text-xs">10å…ƒ</div>
          </div>
          <div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[20] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[20]}</div>
            <div class="text-xs">20å…ƒ</div>
          </div>
          <div class="bg-green-100 dark:bg-green-900 rounded p-2 ${valueCounts[50] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[50]}</div>
            <div class="text-xs">50å…ƒ</div>
          </div>
          <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[100] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[100]}</div>
            <div class="text-xs">100å…ƒ</div>
          </div>
          <div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[200] > 0 ? '' : 'opacity-30'}">
            <div class="font-bold">${valueCounts[200]}</div>
            <div class="text-xs">200å…ƒ</div>
          </div>
        </div>
      `;
      
      // æŒ‰æ€»å€¼ä»é«˜åˆ°ä½æ’åºé“¶è¡Œ
      const sortedBanks = banks
        .filter(bank => bankCounts[bank.id].count > 0)
        .sort((a, b) => bankCounts[b.id].total - bankCounts[a.id].total);
      
      // æ·»åŠ å„é“¶è¡Œçš„æ‘˜è¦
      if (sortedBanks.length > 0) {
        const bankSummaryDiv = document.createElement('div');
        bankSummaryDiv.className = 'space-y-1 mt-3';
        
        sortedBanks.forEach(bank => {
          const data = bankCounts[bank.id];
          
          const bankRow = document.createElement('div');
          bankRow.className = 'flex justify-between items-center p-2 border-b dark:border-gray-700 last:border-0';
          
          bankRow.innerHTML = `
            <div class="flex items-center">
              <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
              <span>${bank.name}</span>
            </div>
            <div>${data.count}å¼µ (${data.total}å…ƒ)</div>
          `;
          
          bankSummaryDiv.appendChild(bankRow);
        });
        
        redeemableVouchersList.appendChild(bankSummaryDiv);
      }
    }

    // æ›´æ–°å„ªæƒ åˆ¸é¸æ“‡å€åŸŸ
    function updateVoucherSelection() {
      const redeemedVoucherSelection = document.getElementById('redeem-voucher-selection');
      
      // è·å–æ‰€æœ‰æœªä½¿ç”¨ä¸”æœªè¿‡æœŸçš„å„ªæƒ åˆ¸
      const unusedVouchers = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v));
      
      // å¦‚æœæ²¡æœ‰å¯ç”¨ä¼˜æƒ åˆ¸ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
      if (unusedVouchers.length === 0) {
        redeemedVoucherSelection.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>';
        return;
      }
      
      // æŒ‰éŠ€è¡Œåˆ†çµ„
      const vouchersByBank = {};
      unusedVouchers.forEach(voucher => {
        if (!vouchersByBank[voucher.bankId]) {
          vouchersByBank[voucher.bankId] = [];
        }
        vouchersByBank[voucher.bankId].push(voucher);
      });
      
      // æ¸…ç©ºé¸æ“‡å€åŸŸ
      redeemedVoucherSelection.innerHTML = '';
      
      // æŒ‰é¢å€¼åˆ†ç»„å¹¶æ·»åŠ é¸é …
      const amounts = [0, 10, 20, 50, 100, 200];
      const amountColors = {
        0: 'bg-yellow-100 dark:bg-yellow-900',
        10: 'bg-blue-100 dark:bg-blue-900',
        20: 'bg-blue-100 dark:bg-blue-900',
        50: 'bg-green-100 dark:bg-green-900',
        100: 'bg-purple-100 dark:bg-purple-900',
        200: 'bg-purple-100 dark:bg-purple-900'
      };
      
      // æ·»åŠ å„é¢å€¼çš„é¸æ“‡å€åŸŸ
      amounts.forEach(amount => {
        const vouchersWithAmount = unusedVouchers.filter(v => v.amount === amount);
        
        // å¦‚æœæ²¡æœ‰æ­¤é¢å€¼çš„å„ªæƒ åˆ¸åˆ™è·³è¿‡
        if (vouchersWithAmount.length === 0) return;
        
        const amountSection = document.createElement('div');
        amountSection.className = 'border rounded-lg overflow-hidden';
        
        // é¢å€¼æ ‡é¢˜
        const amountHeader = document.createElement('div');
        amountHeader.className = `${amountColors[amount]} p-2 flex justify-between items-center`;
        amountHeader.innerHTML = `
          <div class="font-bold">${amount === 0 ? '0' : `${amount}å…ƒ`}</div>
          <div>${vouchersWithAmount.length}å¼µ</div>
        `;
        
        // å‰µå»ºå„ªæƒ åˆ¸åˆ—è¡¨
        const vouchersList = document.createElement('div');
        vouchersList.className = 'p-2 space-y-1 bg-white dark:bg-gray-800';
        
        // æŒ‰éŠ€è¡Œåˆ†çµ„é¡¯ç¤ºå„ªæƒ åˆ¸
        Object.keys(vouchersByBank).forEach(bankId => {
          const bankVouchers = vouchersByBank[bankId].filter(v => v.amount === amount);
          if (bankVouchers.length === 0) return;
          
          const bank = banks.find(b => b.id === bankId);
          if (!bank) return;
          
          const bankRow = document.createElement('div');
          bankRow.className = 'flex items-center justify-between';
          
          bankRow.innerHTML = `
            <div class="flex items-center">
              <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
              <span>${bank.name}</span>
            </div>
            <div class="flex items-center space-x-2">
              <button class="select-all-btn text-xs bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600"
                      data-bank="${bankId}" data-amount="${amount}">å…¨é¸</button>
              <div class="text-gray-500 dark:text-gray-400">${bankVouchers.length}å¼µ</div>
            </div>
          `;
          
          vouchersList.appendChild(bankRow);
          
          // æ·»åŠ è©²éŠ€è¡Œçš„å„ªæƒ åˆ¸é¸æ“‡é …
          const bankVouchersList = document.createElement('div');
          bankVouchersList.className = 'ml-4 space-y-1 mt-1';
          
          bankVouchers.forEach(voucher => {
            const voucherItem = document.createElement('div');
            voucherItem.className = 'flex items-center space-x-2';
            
            // æª¢æŸ¥æ˜¯å¦å·²é¸ä¸­
            const isSelected = appState.selectedVouchers.includes(voucher.id);
            
            voucherItem.innerHTML = `
              <input type="checkbox" id="voucher-${voucher.id}" class="voucher-checkbox"
                     data-id="${voucher.id}" data-amount="${voucher.amount}" ${isSelected ? 'checked' : ''}>
              <label for="voucher-${voucher.id}" class="text-sm">
                ${formatDate(voucher.date)}ç²å¾—
              </label>
            `;
            
            bankVouchersList.appendChild(voucherItem);
          });
          
          vouchersList.appendChild(bankVouchersList);
        });
        
        amountSection.appendChild(amountHeader);
        amountSection.appendChild(vouchersList);
        redeemedVoucherSelection.appendChild(amountSection);
      });
      
      // æ·»åŠ å…¨é¸æŒ‰éˆ•çš„äº‹ä»¶
      document.querySelectorAll('.select-all-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const amount = parseInt(this.getAttribute('data-amount'));
          
          // æ‰¾åˆ°æ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„æœªé¸ä¸­çš„å„ªæƒ åˆ¸
          const bankVouchers = unusedVouchers.filter(v => 
            v.bankId === bankId && v.amount === amount && !appState.selectedVouchers.includes(v.id)
          );
          
          // æ·»åŠ åˆ°å·²é¸æ“‡åˆ—è¡¨
          bankVouchers.forEach(voucher => {
            if (!appState.selectedVouchers.includes(voucher.id)) {
              appState.selectedVouchers.push(voucher.id);
            }
          });
          
          // æ›´æ–°UI
          updateVoucherSelection();
          updateSelectedVouchers();
          saveAppState();
        });
      });
      
      // æ·»åŠ è¤‡é¸æ¡†çš„äº‹ä»¶
      document.querySelectorAll('.voucher-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const voucherId = this.getAttribute('data-id');
          
          if (this.checked) {
            // æ·»åŠ åˆ°å·²é¸æ“‡åˆ—è¡¨
            if (!appState.selectedVouchers.includes(voucherId)) {
              appState.selectedVouchers.push(voucherId);
            }
          } else {
            // å¾å·²é¸æ“‡åˆ—è¡¨ä¸­ç§»é™¤
            appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
          }
          
          // æ›´æ–°UI
          updateSelectedVouchers();
          saveAppState();
        });
      });
    }

    // æ›´æ–°å·²é¸æ“‡çš„å„ªæƒ åˆ¸åˆ—è¡¨
    function updateSelectedVouchers() {
      const selectedVouchersList = document.getElementById('selected-vouchers-list');
      const selectedVouchersSummary = document.getElementById('selected-vouchers-summary');
      const selectedVouchersCount = document.getElementById('selected-vouchers-count');
      const selectedVouchersValue = document.getElementById('selected-vouchers-value');
      const redeemAmount = document.getElementById('redeem-amount');
      const redeemError = document.getElementById('redeem-error');
      
      // å¦‚æœæ²’æœ‰é¸æ“‡ä»»ä½•å„ªæƒ åˆ¸ï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
      if (appState.selectedVouchers.length === 0) {
        selectedVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šæœªé¸æ“‡å„ªæƒ åˆ¸</div>';
        selectedVouchersSummary.classList.add('hidden');
        return;
      }
      
      // ç²å–æ‰€æœ‰å·²é¸æ“‡çš„å„ªæƒ åˆ¸
      const selectedVouchers = appState.selectedVouchers
        .map(id => appState.vouchers.find(v => v.id === id))
        .filter(v => v && !v.used && !isVoucherExpired(v));
      
      // è¨ˆç®—ç¸½å€¼
      const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
      
      // æ›´æ–°æ‘˜è¦æ•¸æ“š
      selectedVouchersCount.textContent = selectedVouchers.length;
      selectedVouchersValue.textContent = totalValue;
      selectedVouchersSummary.classList.remove('hidden');
      
      // è¨­ç½®æœ€å°æ¶ˆè²»é‡‘é¡ç‚ºå„ªæƒ åˆ¸ç¸½é¡çš„3å€
      redeemAmount.min = totalValue * 3;
      redeemAmount.placeholder = `æœ€å°‘æ¶ˆè²»${totalValue * 3}å…ƒ`;
      
      // æª¢æŸ¥ç•¶å‰æ¶ˆè²»é‡‘é¡æ˜¯å¦è¶³å¤ 
      const currentAmount = parseFloat(redeemAmount.value) || 0;
      if (currentAmount > 0 && currentAmount < totalValue * 3) {
        redeemError.classList.remove('hidden');
        redeemError.textContent = `æ¶ˆè²»é‡‘é¡å¿…é ˆè‡³å°‘ç‚º${totalValue * 3}å…ƒ`;
      } else {
        redeemError.classList.add('hidden');
      }
      
      // æŒ‰é¢å€¼åˆ†ç»„
      const vouchersByAmount = {};
      selectedVouchers.forEach(voucher => {
        if (!vouchersByAmount[voucher.amount]) {
          vouchersByAmount[voucher.amount] = [];
        }
        vouchersByAmount[voucher.amount].push(voucher);
      });
      
      // æ¸…ç©ºåˆ—è¡¨
      selectedVouchersList.innerHTML = '';
      
      // æŒ‰é¢å€¼å¾å¤§åˆ°å°é¡¯ç¤ºå„ªæƒ åˆ¸
      const amounts = [200, 100, 50, 20, 10, 0].filter(a => vouchersByAmount[a]?.length > 0);
      
      if (amounts.length === 0) {
        selectedVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šæœªé¸æ“‡å„ªæƒ åˆ¸</div>';
        selectedVouchersSummary.classList.add('hidden');
        return;
      }
      
      // æ·»åŠ å„é¢å€¼çš„å„ªæƒ åˆ¸
      amounts.forEach(amount => {
        const vouchers = vouchersByAmount[amount];
        
        // é¢å€¼æ‘˜è¦
        const amountSummary = document.createElement('div');
        amountSummary.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded mb-1';
        amountSummary.innerHTML = `
          <div class="font-medium">${amount === 0 ? '0' : `${amount}å…ƒ`}</div>
          <div class="flex items-center space-x-2">
            <button class="remove-all-amount text-xs bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 px-2 py-0.5 rounded" data-amount="${amount}">
              ç§»é™¤å…¨éƒ¨
            </button>
            <div>${vouchers.length}å¼µ ${amount > 0 ? `(${amount * vouchers.length}å…ƒ)` : ''}</div>
          </div>
        `;
        
        selectedVouchersList.appendChild(amountSummary);
        
        // åˆ†éŠ€è¡Œé¡¯ç¤º
        const bankGroups = {};
        vouchers.forEach(voucher => {
          if (!bankGroups[voucher.bankId]) {
            bankGroups[voucher.bankId] = [];
          }
          bankGroups[voucher.bankId].push(voucher);
        });
        
        // é¡¯ç¤ºå„éŠ€è¡Œçš„å„ªæƒ åˆ¸
        Object.keys(bankGroups).forEach(bankId => {
          const bank = banks.find(b => b.id === bankId);
          if (!bank) return;
          
          const bankVouchers = bankGroups[bankId];
          
          // é¡¯ç¤ºéŠ€è¡Œæ¨™é¡Œ
          const bankHeader = document.createElement('div');
          bankHeader.className = 'flex justify-between items-center px-2 py-1';
          bankHeader.innerHTML = `
            <div class="flex items-center">
              <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
              <span>${bank.name}</span>
            </div>
            <div>${bankVouchers.length}å¼µ</div>
          `;
          
          selectedVouchersList.appendChild(bankHeader);
          
          // é¡¯ç¤ºå€‹åˆ¥å„ªæƒ åˆ¸
          bankVouchers.forEach(voucher => {
            const voucherItem = document.createElement('div');
            voucherItem.className = 'flex justify-between items-center px-2 py-1 border-b dark:border-gray-700 last:border-0 ml-4';
            
            voucherItem.innerHTML = `
              <div class="text-sm">${formatDate(voucher.date)}ç²å¾—</div>
              <button class="remove-voucher text-xs text-red-500 dark:text-red-400" data-id="${voucher.id}">ç§»é™¤</button>
            `;
            
            selectedVouchersList.appendChild(voucherItem);
          });
        });
      });
      
      // æ·»åŠ ç§»é™¤æŒ‰éˆ•çš„äº‹ä»¶
      document.querySelectorAll('.remove-voucher').forEach(btn => {
        btn.addEventListener('click', function() {
          const voucherId = this.getAttribute('data-id');
          appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
          updateVoucherSelection();
          updateSelectedVouchers();
          saveAppState();
        });
      });
      
      // æ·»åŠ ç§»é™¤å…¨éƒ¨é¢å€¼æŒ‰éˆ•çš„äº‹ä»¶
      document.querySelectorAll('.remove-all-amount').forEach(btn => {
        btn.addEventListener('click', function() {
          const amount = parseInt(this.getAttribute('data-amount'));
          
          // ç²å–è©²é¢å€¼çš„æ‰€æœ‰å·²é¸æ“‡å„ªæƒ åˆ¸ID
          const amountVoucherIds = selectedVouchers
            .filter(v => v.amount === amount)
            .map(v => v.id);
          
          // å¾å·²é¸æ“‡åˆ—è¡¨ä¸­ç§»é™¤
          appState.selectedVouchers = appState.selectedVouchers.filter(id => !amountVoucherIds.includes(id));
          
          updateVoucherSelection();
          updateSelectedVouchers();
          saveAppState();
        });
      });
      
      // æ·»åŠ å…‘æ›æŒ‰éˆ•çš„äº‹ä»¶
      document.getElementById('redeem-selected-vouchers').addEventListener('click', function() {
        const spendAmount = parseFloat(redeemAmount.value) || 0;
        const requiredAmount = totalValue * 3;
        
        if (spendAmount < requiredAmount) {
          redeemError.classList.remove('hidden');
          redeemError.textContent = `æ¶ˆè²»é‡‘é¡å¿…é ˆè‡³å°‘ç‚º${requiredAmount}å…ƒ`;
          return;
        }
        
        if (confirm(`ç¢ºå®šè¦å…‘æ›${selectedVouchers.length}å¼µå„ªæƒ åˆ¸ï¼Œç¸½å€¼${totalValue}å…ƒå—ï¼Ÿ`)) {
          // è¨˜éŒ„æ¶ˆè²»é‡‘é¡åˆ°é€±è¨˜éŒ„
          const weekIndex = appState.weekRecords.findIndex(record => record.weekNum === appState.currentWeek);
          if (weekIndex !== -1) {
            appState.weekRecords[weekIndex].spendAmount = (appState.weekRecords[weekIndex].spendAmount || 0) + spendAmount;
          }
          
          // è¨˜éŒ„å…‘æ›æ­·å²
          appState.redeemHistory.push({
            date: new Date().toISOString(),
            voucherIds: [...appState.selectedVouchers],
            voucherCount: selectedVouchers.length,
            voucherValue: totalValue,
            spendAmount: spendAmount,
            weekNum: appState.currentWeek
          });
          
          // æ¨™è¨˜æ‰€æœ‰é¸æ“‡çš„å„ªæƒ åˆ¸ç‚ºå·²å…‘æ›
          selectedVouchers.forEach(voucher => {
            const v = appState.vouchers.find(v => v.id === voucher.id);
            if (v) v.used = true;
          });
          
          // æ¸…ç©ºå·²é¸æ“‡åˆ—è¡¨
          appState.selectedVouchers = [];
          
          // æ›´æ–°UI
          saveAppState();
          updateUI();
          updateCharts(chartPeriodMode);
          
          // æ¸…ç©ºæ¶ˆè²»é‡‘é¡è¼¸å…¥
          redeemAmount.value = '';
          
          // é¡¯ç¤ºæˆåŠŸä¿¡æ¯
          alert(`æˆåŠŸå…‘æ›${selectedVouchers.length}å¼µå„ªæƒ åˆ¸ï¼æ¶ˆè²»é‡‘é¡: ${spendAmount}å…ƒ`);
        }
      });
      
      // æ·»åŠ æ¶ˆè²»é‡‘é¡è¼¸å…¥æ¡†äº‹ä»¶ç›£è½
      redeemAmount.addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        const requiredAmount = totalValue * 3;
        
        if (amount > 0 && amount < requiredAmount) {
          redeemError.classList.remove('hidden');
          redeemError.textContent = `æ¶ˆè²»é‡‘é¡å¿…é ˆè‡³å°‘ç‚º${requiredAmount}å…ƒ`;
        } else {
          redeemError.classList.add('hidden');
        }
      });
    }

    // æ›´æ–°é€±æ¬¡è¨˜éŒ„é¡¯ç¤º
    function updateWeekRecords() {
      const weekRecordsList = document.getElementById('week-records-list');
      const weekHistorySelect = document.getElementById('week-history-select');
      
      // æ¸…ç©ºé€±æ¬¡è¨˜éŒ„åˆ—è¡¨
      weekRecordsList.innerHTML = '';
      
      // æ¸…ç©ºé€±æ¬¡é¸æ“‡å™¨ä¸¦é‡æ–°å¡«å……
      weekHistorySelect.innerHTML = '<option value="">-- é¸æ“‡é€±æ¬¡ --</option>';
      weekSchedule.forEach(week => {
        const option = document.createElement('option');
        option.value = week.week;
        option.textContent = `ç¬¬${week.week}é€± (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
        weekHistorySelect.appendChild(option);
      });
      
      // ç²å–ç•¶å‰é€±æ¬¡
      const currentWeek = calculateCurrentWeek();
      
      // ç¢ºä¿æœ‰ç•¶å‰é€±æ¬¡çš„è¨˜éŒ„
      let currentWeekRecord = appState.weekRecords.find(r => r.weekNum === currentWeek);
      if (!currentWeekRecord && currentWeek >= 1 && currentWeek <= 10) {
        // å‰µå»ºç•¶å‰é€±æ¬¡çš„è¨˜éŒ„
        currentWeekRecord = createWeekRecord(currentWeek);
        if (currentWeekRecord) {
          appState.weekRecords.push(currentWeekRecord);
          saveAppState();
        }
      }
      
      // å¦‚æœæ²’æœ‰é€±æ¬¡è¨˜éŒ„ï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
      if (appState.weekRecords.length === 0) {
        weekRecordsList.innerHTML = `
          <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            å°šç„¡é€±æ¬¡è¨˜éŒ„
          </div>
        `;
        return;
      }
      
      // æŒ‰é€±æ¬¡æ’åº
      const sortedRecords = [...appState.weekRecords].sort((a, b) => b.weekNum - a.weekNum);
      
      sortedRecords.forEach(record => {
        const recordItem = document.createElement('div');
        recordItem.className = 'border rounded-lg bg-white dark:bg-gray-800 overflow-hidden';
        
        // è¨ˆç®—ç¸½å€¼å’Œå„å€‹éŠ€è¡Œçš„å„ªæƒ åˆ¸æ•¸é‡
        let bankList = '';
        let bankCount = 0;
        
        banks.forEach(bank => {
          const bankData = record.bankCounts?.[bank.id];
          if (bankData && bankData.count > 0) {
            bankCount++;
            bankList += `
              <div class="flex items-center mb-1 text-xs">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                <span>${bank.name}: ${bankData.count}å¼µ (${bankData.value}å…ƒ)</span>
              </div>
            `;
          }
        });
        
        // å‰µå»ºè¨˜éŒ„å¡ç‰‡
        recordItem.innerHTML = `
          <div class="px-4 py-3">
            <div class="flex justify-between items-start mb-2">
              <div class="font-bold text-lg">ç¬¬${record.weekNum}é€±è¨˜éŒ„</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">ç¸½å„ªæƒ åˆ¸</div>
                <div class="font-bold text-lg">${record.voucherCount}å¼µ</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">ç¸½åƒ¹å€¼</div>
                <div class="font-bold text-lg">${record.voucherValue}å…ƒ</div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">æ¶ˆè²»é‡‘é¡</div>
                <div class="font-bold text-lg">${record.spendAmount || 0}å…ƒ</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">å·²å…‘æ›</div>
                <div class="font-bold text-lg">${record.usedCount}å¼µ</div>
              </div>
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">å„ªæƒ åˆ¸åˆ†ä½ˆï¼š</div>
            <div class="text-sm mb-2">
              ${record.valueCounts[0] > 0 ? `<span class="mr-2">0: ${record.valueCounts[0]}å¼µ</span>` : ''}
              ${record.valueCounts[1] > 0 ? `<span class="mr-2">10å…ƒ: ${record.valueCounts[1]}å¼µ</span>` : ''}
              ${record.valueCounts[2] > 0 ? `<span class="mr-2">20å…ƒ: ${record.valueCounts[2]}å¼µ</span>` : ''}
              ${record.valueCounts[3] > 0 ? `<span class="mr-2">50å…ƒ: ${record.valueCounts[3]}å¼µ</span>` : ''}
              ${record.valueCounts[4] > 0 ? `<span class="mr-2">100å…ƒ: ${record.valueCounts[4]}å¼µ</span>` : ''}
              ${record.valueCounts[5] > 0 ? `<span class="mr-2">200å…ƒ: ${record.valueCounts[5]}å¼µ</span>` : ''}
            </div>
            ${bankCount > 0 ? `
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">éŠ€è¡Œåˆ†ä½ˆï¼š</div>
              <div class="mb-2">
                ${bankList}
              </div>
            ` : ''}
            ${record.notes ? `
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">å‚™è¨»ï¼š</div>
              <div class="text-sm mb-2">${record.notes}</div>
            ` : ''}
          </div>
          <div class="border-t px-3 py-2 flex justify-end">
            <button class="text-sm text-primary dark:text-primary hover:underline view-week-detail-btn" data-id="${record.id}">æŸ¥çœ‹è©³æƒ…</button>
          </div>
        `;
        
        weekRecordsList.appendChild(recordItem);
      });
      
      // æ·»åŠ æŸ¥çœ‹è©³æƒ…åŠŸèƒ½
      document.querySelectorAll('.view-week-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          showWeekDetail(recordId);
        });
      });
      
      // æ·»åŠ é€±æ¬¡é¸æ“‡ä¸‹æ‹‰æ¡†çš„äº‹ä»¶ç›£è½
      weekHistorySelect.addEventListener('change', function() {
        const selectedWeek = this.value;
        if (selectedWeek) {
          const weekNum = parseInt(selectedWeek);
          // æŸ¥æ‰¾è©²é€±æ¬¡çš„è¨˜éŒ„
          let weekRecord = appState.weekRecords.find(r => r.weekNum === weekNum);
          
          // å¦‚æœæ²’æœ‰è©²é€±æ¬¡çš„è¨˜éŒ„ï¼Œå‰‡å»ºç«‹è‡¨æ™‚è¨˜éŒ„
          if (!weekRecord) {
            weekRecord = createWeekRecord(weekNum);
            // å¦‚æœæ˜¯ç•¶å‰é€±æ¬¡ï¼Œä¿å­˜è¨˜éŒ„
            if (weekNum === currentWeek) {
              appState.weekRecords.push(weekRecord);
              saveAppState();
              updateWeekRecords(); // é‡æ–°åŠ è¼‰åˆ—è¡¨
            }
          }
          
          if (weekRecord) {
            showWeekDetail(weekRecord.id);
          } else {
            alert(`ç„¡æ³•æŸ¥çœ‹ç¬¬${weekNum}é€±çš„è¨˜éŒ„ã€‚`);
          }
        }
      });
    }

    // é¡¯ç¤ºé€±æ¬¡è©³æƒ…
    function showWeekDetail(recordId) {
      const record = appState.weekRecords.find(r => r.id === recordId);
      if (!record) return;
      
      const weekDetailModal = document.getElementById('week-detail-modal');
      const weekDetailTitle = document.getElementById('week-detail-title');
      const weekDetailContent = document.getElementById('week-detail-content');
      const closeDetailBtn = document.getElementById('close-detail-btn');
      const closeWeekDetail = document.getElementById('close-week-detail');
      
      // è¨­ç½®æ¨™é¡Œ
      weekDetailTitle.textContent = `ç¬¬${record.weekNum}é€±è©³ç´°è¨˜éŒ„`;
      
      // è¨ˆç®—å·²ä½¿ç”¨å’Œæœªä½¿ç”¨å„ªæƒ åˆ¸
      const usedPercentage = record.voucherCount > 0 ? Math.round((record.usedCount / record.voucherCount) * 100) : 0;
      
      // ç”Ÿæˆå„éŠ€è¡ŒæŠ½çç‹€æ…‹
      let bankDrawsHtml = '';
      banks.forEach(bank => {
        const bankDraw = record.bankDraws?.[bank.id];
        if (bankDraw) {
          bankDrawsHtml += `
            <div class="flex items-center justify-between py-1">
              <div class="flex items-center">
                <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                <span>${bank.name}</span>
              </div>
              <div>
                å·²ç”¨ ${bankDraw.used}/3 æ¬¡
              </div>
            </div>
          `;
        }
      });
      
      // è¨­ç½®å…§å®¹
      weekDetailContent.innerHTML = `
        <div class="space-y-4">
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">è¨˜éŒ„æ™‚é–“</div>
            <div>${new Date(record.createdAt).toLocaleString()}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">é€±æœŸç¯„åœ</div>
            <div>${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„ªæƒ åˆ¸ä½¿ç”¨æƒ…æ³</div>
            <div class="flex justify-between mb-1">
              <div>ç¸½æ•¸: ${record.voucherCount}å¼µ</div>
              <div>ç¸½å€¼: ${record.voucherValue}å…ƒ</div>
            </div>
            <div class="flex justify-between mb-1">
              <div>å·²å…‘æ›: ${record.usedCount}å¼µ</div>
              <div>æœªä½¿ç”¨: ${record.voucherCount - record.usedCount}å¼µ</div>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
              <div class="bg-primary h-2.5 rounded-full" style="width: ${usedPercentage}%"></div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">æ¶ˆè²»é‡‘é¡</div>
            <div class="font-bold text-lg">${record.spendAmount || 0}å…ƒ</div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆ</div>
            <div class="grid grid-cols-6 gap-2 mb-2">
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[0] || 0}</div>
                <div class="text-xs">0</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[1] || 0}</div>
                <div class="text-xs">10å…ƒ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[2] || 0}</div>
                <div class="text-xs">20å…ƒ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[3] || 0}</div>
                <div class="text-xs">50å…ƒ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[4] || 0}</div>
                <div class="text-xs">100å…ƒ</div>
              </div>
              <div class="text-center">
                <div class="text-sm font-bold">${record.valueCounts[5] || 0}</div>
                <div class="text-xs">200å…ƒ</div>
              </div>
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„éŠ€è¡Œå„ªæƒ åˆ¸</div>
            <div class="space-y-1">
              ${banks.map(bank => {
                const bankData = record.bankCounts?.[bank.id];
                return bankData && bankData.count > 0 ? `
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
                      <span>${bank.name}</span>
                    </div>
                    <div>${bankData.count}å¼µ (${bankData.value}å…ƒ)</div>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">éŠ€è¡ŒæŠ½çç‹€æ…‹</div>
            <div class="space-y-1 border rounded-lg p-2">
              ${bankDrawsHtml}
            </div>
          </div>
          
          <div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">é€±æœ«æ¶ˆè²»è¨˜éŒ„</div>
            <div>${record.weekendSpendsCount}ç­†</div>
          </div>
          
          ${record.notes ? `
            <div>
              <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å‚™è¨»</div>
              <div class="border rounded-lg p-2">${record.notes}</div>
            </div>
          ` : ''}
        </div>
      `;
      
      // é¡¯ç¤ºæ¨¡æ…‹æ¡†
      weekDetailModal.classList.remove('hidden');
      
      // é—œé–‰æŒ‰éˆ•
      closeDetailBtn.addEventListener('click', () => {
        weekDetailModal.classList.add('hidden');
      });
      
      closeWeekDetail.addEventListener('click', () => {
        weekDetailModal.classList.add('hidden');
      });
    }

    // ç²å–ç•¶å‰é€±æ¬¡çš„å„ªæƒ åˆ¸
    function getVouchersForCurrentWeek() {
      return appState.vouchers.filter(voucher => {
        return getWeekNumberFromDate(voucher.date) === appState.currentWeek;
      });
    }

    // æ ¹æ“šæ—¥æœŸç²å–é€±æ¬¡
    function getWeekNumberFromDate(dateString) {
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (dateString >= week.startDate && dateString <= week.endDate) {
          return i + 1;
        }
      }
      
      // æª¢æŸ¥é€±æœ«æ—¥æœŸ
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        const resetDate = new Date(week.resetDate);
        const nextDay = new Date(resetDate);
        nextDay.setDate(resetDate.getDate() + 1);
        const nextDayStr = nextDay.toISOString().split('T')[0];
        
        if (dateString === week.resetDate || dateString === nextDayStr) {
          return i + 1;
        }
      }
      
      return 1; // é»˜èªè¿”å›ç¬¬ä¸€é€±
    }

    // ç²å–å°æ‡‰é€±æœ«çš„æ—¥æœŸç¯„åœ
    function getWeekendDateRange(weekdayDate) {
      // æ‰¾åˆ°å°æ‡‰çš„é€±æ¬¡
      let weekNum = -1;
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (weekdayDate >= week.startDate && weekdayDate <= week.endDate) {
          weekNum = i;
          break;
        }
      }
      
      if (weekNum >= 0) {
        const saturday = weekSchedule[weekNum].resetDate;
        
        // è¨ˆç®—é€±æ—¥ (Saturday + 1 day)
        const saturdayDate = new Date(saturday);
        const sundayDate = new Date(saturdayDate);
        sundayDate.setDate(saturdayDate.getDate() + 1);
        const sunday = sundayDate.toISOString().split('T')[0];
        
        return `${formatDate(saturday)} - ${formatDate(sunday)}`;
      }
      
      return 'æœªçŸ¥';
    }

    // åˆ¤æ–·å„ªæƒ åˆ¸æ˜¯å¦éæœŸ
    function isVoucherExpired(voucher) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // æ‰¾åˆ°å°æ‡‰çš„é€±æ¬¡
      let weekNum = -1;
      for (let i = 0; i < weekSchedule.length; i++) {
        const week = weekSchedule[i];
        if (voucher.date >= week.startDate && voucher.date <= week.endDate) {
          weekNum = i;
          break;
        }
      }
      
      if (weekNum >= 0) {
        const saturday = new Date(weekSchedule[weekNum].resetDate);
        
        // è¨ˆç®—é€±æ—¥ (Saturday + 1 day)
        const sunday = new Date(saturday);
        sunday.setDate(saturday.getDate() + 1);
        sunday.setHours(23, 59, 59, 999); // è¨­ç½®ç‚ºé€±æ—¥çš„æœ€å¾Œä¸€åˆ»
        
        return today > sunday;
      }
      
      return false;
    }

    // æ¨™è¨˜å„ªæƒ åˆ¸ç‚ºå·²ä½¿ç”¨
    function markVoucherAsUsed(voucherId) {
      const voucher = appState.vouchers.find(v => v.id === voucherId);
      if (voucher) {
        voucher.used = true;
        saveAppState();
        updateUI();
        updateCharts(chartPeriodMode);
      }
    }

    // é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
    function showDeleteConfirmation(voucherId) {
      const confirmDeleteModal = document.getElementById('confirm-delete-modal');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');
      
      // é¡¯ç¤ºæ¨¡æ…‹æ¡†
      confirmDeleteModal.classList.remove('hidden');
      
      // è¨­ç½®ç¢ºèªåˆªé™¤æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
      const confirmHandler = () => {
        deleteVoucher(voucherId);
        confirmDeleteModal.classList.add('hidden');
        confirmDeleteBtn.removeEventListener('click', confirmHandler);
      };
      
      confirmDeleteBtn.addEventListener('click', confirmHandler);
      
      // è¨­ç½®å–æ¶ˆæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
      cancelDeleteBtn.addEventListener('click', () => {
        confirmDeleteModal.classList.add('hidden');
        confirmDeleteBtn.removeEventListener('click', confirmHandler);
      });
    }

    // åˆªé™¤å„ªæƒ åˆ¸
    function deleteVoucher(voucherId) {
      const voucher = appState.vouchers.find(v => v.id === voucherId);
      
      if (voucher) {
        // å¦‚æœåˆªé™¤çš„æ˜¯æœªä½¿ç”¨çš„å„ªæƒ åˆ¸ï¼Œæ¢å¾©è©²éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
        if (!voucher.used && voucher.bankId && appState.bankDraws[voucher.bankId]) {
          appState.bankDraws[voucher.bankId].used--;
          appState.bankDraws[voucher.bankId].remaining++;
        }
        
        // å¾æ•¸çµ„ä¸­ç§»é™¤å„ªæƒ åˆ¸
        appState.vouchers = appState.vouchers.filter(v => v.id !== voucherId);
        
        // å¾éŠ€è¡Œè¨˜éŒ„ä¸­ç§»é™¤
        if (voucher.bankId && appState.bankVouchers[voucher.bankId]) {
          appState.bankVouchers[voucher.bankId] = appState.bankVouchers[voucher.bankId].filter(id => id !== voucherId);
        }
        
        // å¾å·²é¸æ“‡åˆ—è¡¨ä¸­ç§»é™¤
        appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
        
        saveAppState();
        updateUI();
        updateCharts(chartPeriodMode);
      }
    }

    // æ·»åŠ å„ªæƒ åˆ¸
    function addVoucher(amount) {
      if (!appState.preferredBank) {
        alert('è«‹å…ˆé¸æ“‡éŠ€è¡Œï¼');
        return;
      }

      // ç²å–ç•¶å‰éŠ€è¡Œçš„æŠ½çæ¬¡æ•¸
      if (!appState.bankDraws[appState.preferredBank]) {
        appState.bankDraws[appState.preferredBank] = {
          remaining: 3,
          used: 0
        };
      }
      
      const bankDraws = appState.bankDraws[appState.preferredBank];
      
      if (bankDraws.remaining <= 0) {
        alert(`${getBankName(appState.preferredBank)}æœ¬é€±æŠ½çæ¬¡æ•¸å·²ç”¨å®Œï¼`);
        return;
      }

      // ä½¿ç”¨ç•¶å‰æ—¥æœŸ
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      
      // å‰µå»ºæ–°å„ªæƒ åˆ¸
      const newVoucher = {
        id: Date.now().toString(),
        amount: amount,
        date: todayString,
        used: false,
        bankId: appState.preferredBank
      };
      
      // æ·»åŠ å„ªæƒ åˆ¸
      appState.vouchers.push(newVoucher);
      
      // æ›´æ–°æŠ½çæ¬¡æ•¸
      bankDraws.used++;
      bankDraws.remaining = Math.max(0, bankDraws.remaining - 1);
      
      // æ·»åŠ åˆ°éŠ€è¡Œè¨˜éŒ„
      if (!appState.bankVouchers[appState.preferredBank]) {
        appState.bankVouchers[appState.preferredBank] = [];
      }
      appState.bankVouchers[appState.preferredBank].push(newVoucher.id);
      
      // ä¿å­˜ä¸¦æ›´æ–°UI
      saveAppState();
      updateUI();
      updateCharts(chartPeriodMode);
      updateCurrentWeekRecord(); // æ›´æ–°å½“å‰å‘¨è®°å½•
    }

    // ç²å–éŠ€è¡Œåç¨±
    function getBankName(bankId) {
      const bank = banks.find(b => b.id === bankId);
      return bank ? bank.name : 'æœªçŸ¥éŠ€è¡Œ';
    }

    // æ›´æ–°ç¸½é«”çµ±è¨ˆæ•¸æ“š
    function updateTotalStats() {
      const totalVouchersElem = document.getElementById('total-vouchers');
      const totalValueElem = document.getElementById('total-value');
      const usageRateElem = document.getElementById('usage-rate');
      const expiryRateElem = document.getElementById('expiry-rate');
      
      // è¨ˆç®—ç¸½å„ªæƒ åˆ¸æ•¸é‡å’Œç¸½å€¼
      const totalCount = appState.vouchers.length;
      const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
      
      // è¨ˆç®—å·²ä½¿ç”¨ç‡
      const usedCount = appState.vouchers.filter(v => v.used).length;
      const usageRate = totalCount > 0 ? Math.round((usedCount / totalCount) * 100) : 0;
      
      // è¨ˆç®—å·²éæœŸç‡
      const expiredCount = appState.vouchers.filter(v => !v.used && isVoucherExpired(v)).length;
      const expiryRate = totalCount > 0 ? Math.round((expiredCount / totalCount) * 100) : 0;
      
      // æ›´æ–°UI
      totalVouchersElem.textContent = `${totalCount}å¼µ`;
      totalValueElem.textContent = `${totalValue}å…ƒ`;
      usageRateElem.textContent = `${usageRate}%`;
      expiryRateElem.textContent = `${expiryRate}%`;
    }

    // æ›´æ–°æ•´å€‹UI
    function updateUI() {
      updateCurrentDateDisplay();
      updateCurrentWeekDisplay();
      updateBankButtons();
      updateQuickAddPanel();
      updateBankOverview();
      updateRedeemableVouchers();
      updateVoucherSelection();
      updateSelectedVouchers();
      updateWeekRecords();
      updateWeekSchedule();
      updateTotalStats();
      updateWeekAmountDetailsContent();
    }

    // åŒ¯å‡ºæ•¸æ“š
    function exportData(format) {
      const exportModal = document.getElementById('export-data-modal');
      const exportContent = document.getElementById('export-content');
      const exportResult = document.getElementById('export-result');
      const copyExportBtn = document.getElementById('copy-export');
      
      let content = '';
      
      if (format === 'text') {
        // ç”Ÿæˆæ–‡å­—æ‘˜è¦
        content = generateTextSummary();
      } else if (format === 'json') {
        // ç”ŸæˆJSONæ•¸æ“š
        content = JSON.stringify(appState, null, 2);
      }
      
      // é¡¯ç¤ºçµæœ
      exportContent.textContent = content;
      exportResult.classList.remove('hidden');
      copyExportBtn.classList.remove('hidden');
      
      // é¡¯ç¤ºæ¨¡æ…‹æ¡†
      exportModal.classList.remove('hidden');
    }
    
    // ç”Ÿæˆæ–‡å­—æ‘˜è¦
    function generateTextSummary() {
      let summary = `=== 2025å¹´ç¤¾å€æ¶ˆè²»å¤§çè³ - æ•¸æ“šæ‘˜è¦ ===\n`;
      summary += `ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString()}\n\n`;
      
      // ç¸½é«”çµ±è¨ˆ
      const totalCount = appState.vouchers.length;
      const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
      const usedCount = appState.vouchers.filter(v => v.used).length;
      const unusedCount = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v)).length;
      const expiredCount = appState.vouchers.filter(v => !v.used && isVoucherExpired(v)).length;
      
      summary += `== ç¸½é«”çµ±è¨ˆ ==\n`;
      summary += `ç¸½å„ªæƒ åˆ¸: ${totalCount}å¼µ (${totalValue}å…ƒ)\n`;
      summary += `å·²å…‘æ›: ${usedCount}å¼µ\n`;
      summary += `æœªä½¿ç”¨: ${unusedCount}å¼µ\n`;
      summary += `å·²éæœŸ: ${expiredCount}å¼µ\n\n`;
      
      // é¢å€¼åˆ†ä½ˆ
      const valueCounts = [0, 0, 0, 0, 0, 0]; // 0å…ƒ, 10, 20, 50, 100, 200
      appState.vouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // 0å…ƒ
          case 10: valueCounts[1]++; break;
          case 20: valueCounts[2]++; break;
          case 50: valueCounts[3]++; break;
          case 100: valueCounts[4]++; break;
          case 200: valueCounts[5]++; break;
        }
      });
      
      summary += `== é¢å€¼åˆ†ä½ˆ ==\n`;
      summary += `0: ${valueCounts[0]}å¼µ\n`;
      summary += `10å…ƒ: ${valueCounts[1]}å¼µ\n`;
      summary += `20å…ƒ: ${valueCounts[2]}å¼µ\n`;
      summary += `50å…ƒ: ${valueCounts[3]}å¼µ\n`;
      summary += `100å…ƒ: ${valueCounts[4]}å¼µ\n`;
      summary += `200å…ƒ: ${valueCounts[5]}å¼µ\n\n`;
      
      // éŠ€è¡Œåˆ†ä½ˆ
      summary += `== éŠ€è¡Œåˆ†ä½ˆ ==\n`;
      
      // è¨ˆç®—å„éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡
      const bankCounts = {};
      banks.forEach(bank => {
        bankCounts[bank.id] = {
          count: 0,
          value: 0
        };
      });
      
      appState.vouchers.forEach(voucher => {
        if (voucher.bankId && bankCounts[voucher.bankId]) {
          bankCounts[voucher.bankId].count++;
          bankCounts[voucher.bankId].value += voucher.amount;
        }
      });
      
      // æŒ‰ç¸½å€¼å¾é«˜åˆ°ä½æ’åºéŠ€è¡Œ
      const sortedBanks = banks
        .filter(bank => bankCounts[bank.id].count > 0)
        .sort((a, b) => bankCounts[b.id].value - bankCounts[a.id].value);
      
      sortedBanks.forEach(bank => {
        const data = bankCounts[bank.id];
        summary += `${bank.name}: ${data.count}å¼µ (${data.value}å…ƒ)\n`;
      });
      
      summary += `\n== é€±æ¬¡è¨˜éŒ„ ==\n`;
      
      // æ’åºé€±æ¬¡è¨˜éŒ„
      const sortedRecords = [...appState.weekRecords].sort((a, b) => a.weekNum - b.weekNum);
      
      sortedRecords.forEach(record => {
        summary += `ç¬¬${record.weekNum}é€± (${formatDate(record.startDate)} - ${formatDate(record.endDate)}):\n`;
        summary += `  å„ªæƒ åˆ¸: ${record.voucherCount}å¼µ (${record.voucherValue}å…ƒ)\n`;
        summary += `  å·²å…‘æ›: ${record.usedCount}å¼µ\n`;
        summary += `  æ¶ˆè²»é‡‘é¡: ${record.spendAmount || 0}å…ƒ\n`;
        
        if (record.notes) {
          summary += `  å‚™è¨»: ${record.notes}\n`;
        }
        
        summary += `\n`;
      });
      
      return summary;
    }

    // åˆå§‹åŒ–åœ–è¡¨
    let valueChart, bankChart, weekAmountChart, bankValueChart, statusChart;

    function initCharts() {
      // è¨­ç½®Chart.jså…¨å±€é…ç½®
      Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
      Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';
      
      // å„ªæƒ åˆ¸ç¸½å€¼åœ–è¡¨
      const valueCtx = document.getElementById('value-chart').getContext('2d');
      valueChart = new Chart(valueCtx, {
        type: 'bar',
        data: {
          labels: ['0', '10å…ƒ', '20å…ƒ', '50å…ƒ', '100å…ƒ', '200å…ƒ'],
          datasets: [{
            label: 'æ•¸é‡',
            data: [0, 0, 0, 0, 0, 0],
            backgroundColor: document.documentElement.classList.contains('dark') ? 
              ['#facc15', '#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc'] : 
              ['#fef08a', '#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = [0, 10, 20, 50, 100, 200][context.dataIndex];
                  if (context.dataIndex === 0) {
                    return `æ•¸é‡: ${context.raw}å¼µ (0)`;
                  }
                  return `æ•¸é‡: ${context.raw}å¼µ (åƒ¹å€¼: ${context.raw * value}å…ƒ)`;
                }
              }
            }
          }
        }
      });
      
      // éŠ€è¡Œåˆ†ä½ˆåœ–è¡¨
      const bankCtx = document.getElementById('bank-chart').getContext('2d');
      bankChart = new Chart(bankCtx, {
        type: 'doughnut',
        data: {
          labels: banks.map(bank => bank.name),
          datasets: [{
            data: Array(banks.length).fill(0),
            backgroundColor: document.documentElement.classList.contains('dark') ? 
              chartColors.dark : chartColors.light
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 12,
                padding: 10
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${context.label}: ${value}å¼µ (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // é€±æ¬¡é¢å€¼åˆ†ä½ˆåœ–è¡¨
      const weekAmountCtx = document.getElementById('week-amount-chart').getContext('2d');
      weekAmountChart = new Chart(weekAmountCtx, {
        type: 'bar',
        data: {
          labels: Array.from({length: 10}, (_, i) => `ç¬¬${i+1}é€±`),
          datasets: [
            {
              label: '0',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#facc15' : '#fef08a',
              stack: 'stack1'
            },
            {
              label: '10å…ƒ',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#93c5fd' : '#dbeafe',
              stack: 'stack1'
            },
            {
              label: '20å…ƒ',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#93c5fd' : '#dbeafe',
              stack: 'stack1'
            },
            {
              label: '50å…ƒ',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#86efac' : '#dcfce7',
              stack: 'stack1'
            },
            {
              label: '100å…ƒ',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#c084fc' : '#f3e8ff',
              stack: 'stack1'
            },
            {
              label: '200å…ƒ',
              data: Array(10).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#c084fc' : '#f3e8ff',
              stack: 'stack1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                boxWidth: 12,
                padding: 6
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw;
                  return `${label}: ${value}å¼µ`;
                }
              }
            }
          }
        }
      });
      
      // éŠ€è¡Œå„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆåœ–è¡¨
      const bankValueCtx = document.getElementById('bank-value-chart').getContext('2d');
      bankValueChart = new Chart(bankValueCtx, {
        type: 'bar',
        data: {
          labels: banks.map(bank => bank.name),
          datasets: [
            {
              label: '0',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#facc15' : '#fef08a',
              stack: 'stack1'
            },
            {
              label: '10å…ƒ',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#93c5fd' : '#dbeafe',
              stack: 'stack1'
            },
            {
              label: '20å…ƒ',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#93c5fd' : '#dbeafe',
              stack: 'stack1'
            },
            {
              label: '50å…ƒ',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#86efac' : '#dcfce7',
              stack: 'stack1'
            },
            {
              label: '100å…ƒ',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#c084fc' : '#f3e8ff',
              stack: 'stack1'
            },
            {
              label: '200å…ƒ',
              data: Array(banks.length).fill(0),
              backgroundColor: document.documentElement.classList.contains('dark') ? '#c084fc' : '#f3e8ff',
              stack: 'stack1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw;
                  return `${label}: ${value}å¼µ`;
                }
              }
            }
          }
        }
      });
      
      // ç‹€æ…‹åˆ†ä½ˆåœ–è¡¨
      const statusCtx = document.getElementById('status-chart').getContext('2d');
      statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
          labels: ['æœªä½¿ç”¨', 'å·²å…‘æ›', 'å·²éæœŸ'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: [
              '#86efac', // æœªä½¿ç”¨
              '#93c5fd', // å·²å…‘æ›
              '#f87171'  // å·²éæœŸ
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value}å¼µ (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // é¦–æ¬¡æ›´æ–°åœ–è¡¨
      updateCharts(chartPeriodMode);
    }

    // æ›´æ–°åœ–è¡¨
    function updateCharts(mode, selectedWeek = null) {
      if (!valueChart || !bankChart || !weekAmountChart || !bankValueChart || !statusChart) return;
      
      // ç¢ºå®šç¯©é¸çš„é€±æ¬¡
      const filterWeek = selectedWeek || (mode === 'week' ? document.getElementById('chart-week-filter').value : 'all');
      
      // ç¯©é¸å„ªæƒ åˆ¸
      let filteredVouchers;
      if (filterWeek === 'all') {
        filteredVouchers = appState.vouchers;
      } else {
        const weekNum = parseInt(filterWeek);
        filteredVouchers = appState.vouchers.filter(v => getWeekNumberFromDate(v.date) === weekNum);
      }
      
      // è¨ˆç®—å„é¢å€¼å„ªæƒ åˆ¸æ•¸é‡
      const valueCounts = [0, 0, 0, 0, 0, 0]; // 0å…ƒ, 10, 20, 50, 100, 200
      filteredVouchers.forEach(voucher => {
        switch(voucher.amount) {
          case 0: valueCounts[0]++; break; // 0å…ƒ
          case 10: valueCounts[1]++; break;
          case 20: valueCounts[2]++; break;
          case 50: valueCounts[3]++; break;
          case 100: valueCounts[4]++; break;
          case 200: valueCounts[5]++; break;
        }
      });
      
      // æ›´æ–°å„ªæƒ åˆ¸ç¸½å€¼åœ–è¡¨
      valueChart.data.datasets[0].data = valueCounts;
      valueChart.update();
      
      // è¨ˆç®—å„éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡
      const bankCounts = Array(banks.length).fill(0);
      filteredVouchers.forEach(voucher => {
        if (voucher.bankId) {
          const bankIndex = banks.findIndex(bank => bank.id === voucher.bankId);
          if (bankIndex >= 0) {
            bankCounts[bankIndex]++;
          }
        }
      });
      
      // æ›´æ–°éŠ€è¡Œåˆ†ä½ˆåœ–è¡¨
      bankChart.data.datasets[0].data = bankCounts;
      bankChart.update();
      
      // éŠ€è¡Œå„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆæ•¸æ“š
      const bankValueData = banks.map(() => ({
        0: 0,  // 0å…ƒ
        10: 0, // 10å…ƒ
        20: 0, // 20å…ƒ
        50: 0, // 50å…ƒ
        100: 0, // 100å…ƒ
        200: 0  // 200å…ƒ
      }));
      
      filteredVouchers.forEach(voucher => {
        if (voucher.bankId) {
          const bankIndex = banks.findIndex(bank => bank.id === voucher.bankId);
          if (bankIndex >= 0 && voucher.amount in bankValueData[bankIndex]) {
            bankValueData[bankIndex][voucher.amount]++;
          }
        }
      });
      
      // æ›´æ–°éŠ€è¡Œå„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆåœ–è¡¨
      bankValueChart.data.datasets[0].data = bankValueData.map(data => data[0]); // 0å…ƒ
      bankValueChart.data.datasets[1].data = bankValueData.map(data => data[10]); // 10å…ƒ
      bankValueChart.data.datasets[2].data = bankValueData.map(data => data[20]); // 20å…ƒ
      bankValueChart.data.datasets[3].data = bankValueData.map(data => data[50]); // 50å…ƒ
      bankValueChart.data.datasets[4].data = bankValueData.map(data => data[100]); // 100å…ƒ
      bankValueChart.data.datasets[5].data = bankValueData.map(data => data[200]); // 200å…ƒ
      bankValueChart.update();
      
      // å„ªæƒ åˆ¸ç‹€æ…‹è¨ˆæ•¸
      const statusCounts = [0, 0, 0]; // æœªä½¿ç”¨, å·²å…‘æ›, å·²éæœŸ
      
      filteredVouchers.forEach(voucher => {
        if (voucher.used) {
          statusCounts[1]++; // å·²å…‘æ›
        } else if (isVoucherExpired(voucher)) {
          statusCounts[2]++; // å·²éæœŸ
        } else {
          statusCounts[0]++; // æœªä½¿ç”¨
        }
      });
      
      // æ›´æ–°ç‹€æ…‹åˆ†ä½ˆåœ–è¡¨
      statusChart.data.datasets[0].data = statusCounts;
      statusChart.update();
      
      // é€±æ¬¡é¢å€¼åˆ†ä½ˆ
      if (filterWeek === 'all') {
        // å„é€±çš„é¢å€¼åˆ†ä½ˆæ•¸æ“š
        const weekAmountData = Array(10).fill().map(() => ({
          0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0
        }));
        
        // è¨ˆç®—å„é€±çš„é¢å€¼åˆ†ä½ˆ
        appState.vouchers.forEach(voucher => {
          const weekNum = getWeekNumberFromDate(voucher.date);
          if (weekNum >= 1 && weekNum <= 10) {
            if (voucher.amount in weekAmountData[weekNum - 1]) {
              weekAmountData[weekNum - 1][voucher.amount]++;
            }
          }
        });
        
        // æ›´æ–°é€±æ¬¡é¢å€¼åˆ†ä½ˆåœ–è¡¨
        weekAmountChart.data.datasets[0].data = weekAmountData.map(data => data[0]); // 0å…ƒ
        weekAmountChart.data.datasets[1].data = weekAmountData.map(data => data[10]); // 10å…ƒ
        weekAmountChart.data.datasets[2].data = weekAmountData.map(data => data[20]); // 20å…ƒ
        weekAmountChart.data.datasets[3].data = weekAmountData.map(data => data[50]); // 50å…ƒ
        weekAmountChart.data.datasets[4].data = weekAmountData.map(data => data[100]); // 100å…ƒ
        weekAmountChart.data.datasets[5].data = weekAmountData.map(data => data[200]); // 200å…ƒ
        weekAmountChart.update();
        
        // é¡¯ç¤ºé€±æ¬¡é¢å€¼åˆ†ä½ˆåœ–è¡¨
        document.getElementById('week-amount-chart-container').style.display = '';
        updateWeekAmountDetailsContent();
      } else {
        // å¦‚æœé¸äº†ç‰¹å®šé€±æ¬¡ï¼Œéš±è—é€±æ¬¡é¢å€¼åˆ†ä½ˆåœ–è¡¨
        document.getElementById('week-amount-chart-container').style.display = 'none';
      }
    }

    // æ›´æ–°é€±æ¬¡é¢å€¼è¯¦æƒ…æ•°æ®
    function updateWeekAmountDetailsContent() {
      const weekAmountDetailsContent = document.getElementById('week-amount-details-content');
      weekAmountDetailsContent.innerHTML = '';
      
      // è¨ˆç®—å„é€±çš„æ•¸æ“šçµ±è¨ˆ
      const weekStats = Array(10).fill().map(() => ({
        count: 0,
        value: 0,
        used: 0,
        spendAmount: 0,
        amounts: {0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0}
      }));
      
      // è¨ˆç®—å„é€±çš„å„ªæƒ åˆ¸çµ±è¨ˆ
      appState.vouchers.forEach(voucher => {
        const weekNum = getWeekNumberFromDate(voucher.date);
        if (weekNum >= 1 && weekNum <= 10) {
          weekStats[weekNum - 1].count++;
          weekStats[weekNum - 1].amounts[voucher.amount]++;
          if (voucher.amount > 0) {
            weekStats[weekNum - 1].value += voucher.amount;
          }
          if (voucher.used) {
            weekStats[weekNum - 1].used++;
          }
        }
      });
      
      // æ·»åŠ æ¶ˆè²»é‡‘é¡æ•¸æ“š
      appState.weekRecords.forEach(record => {
        if (record.weekNum >= 1 && record.weekNum <= 10) {
          weekStats[record.weekNum - 1].spendAmount = record.spendAmount || 0;
        }
      });
      
      // ç”Ÿæˆè©³ç´°æ•¸æ“šHTML
      for (let i = 0; i < weekStats.length; i++) {
        const stats = weekStats[i];
        if (stats.count > 0) {
          const weekDetail = document.createElement('div');
          weekDetail.className = 'p-2 border rounded';
          
          weekDetail.innerHTML = `
            <div class="font-medium">ç¬¬${i + 1}é€±</div>
            <div class="grid grid-cols-2 gap-2 mt-1">
              <div>ç¸½è¨ˆ: ${stats.count}å¼µ (${stats.value}å…ƒ)</div>
              <div>å·²å…‘æ›: ${stats.used}å¼µ</div>
              <div>æ¶ˆè²»é‡‘é¡: ${stats.spendAmount}å…ƒ</div>
              <div>æœªä½¿ç”¨: ${stats.count - stats.used}å¼µ</div>
            </div>
            <div class="mt-1">é¢å€¼åˆ†ä½ˆ:</div>
            <div class="grid grid-cols-6 gap-1 mt-1">
              <div class="text-center text-xs ${stats.amounts[0] > 0 ? 'bg-yellow-100 dark:bg-yellow-900/30' : ''} rounded p-1">
                <div>${stats.amounts[0]}</div>
                <div>0</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[10] > 0 ? 'bg-blue-100 dark:bg-blue-900/30' : ''} rounded p-1">
                <div>${stats.amounts[10]}</div>
                <div>10å…ƒ</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[20] > 0 ? 'bg-blue-100 dark:bg-blue-900/30' : ''} rounded p-1">
                <div>${stats.amounts[20]}</div>
                <div>20å…ƒ</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[50] > 0 ? 'bg-green-100 dark:bg-green-900/30' : ''} rounded p-1">
                <div>${stats.amounts[50]}</div>
                <div>50å…ƒ</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[100] > 0 ? 'bg-purple-100 dark:bg-purple-900/30' : ''} rounded p-1">
                <div>${stats.amounts[100]}</div>
                <div>100å…ƒ</div>
              </div>
              <div class="text-center text-xs ${stats.amounts[200] > 0 ? 'bg-purple-100 dark:bg-purple-900/30' : ''} rounded p-1">
                <div>${stats.amounts[200]}</div>
                <div>200å…ƒ</div>
              </div>
            </div>
          `;
          
          weekAmountDetailsContent.appendChild(weekDetail);
        }
      }
      
      if (weekAmountDetailsContent.children.length === 0) {
        weekAmountDetailsContent.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">æš«ç„¡æ•¸æ“š</div>';
      }
    }

    // è¨ˆç®—æœ€ä½³å„ªæƒ åˆ¸çµ„åˆ
    function calculateBestVoucherCombination(amount) {
      // ç²å–æ‰€æœ‰æœªä½¿ç”¨çš„å„ªæƒ åˆ¸
      const unusedVouchers = appState.vouchers.filter(v => !v.used && !isVoucherExpired(v) && v.amount > 0); // éæ¿¾æ‰0å…ƒ
      
      // æŒ‰é¢å€¼æ’åº
      const sortedVouchers = unusedVouchers.sort((a, b) => b.amount - a.amount);
      
      // æŒ‰éŠ€è¡Œåˆ†çµ„
      const vouchersByBank = {};
      sortedVouchers.forEach(voucher => {
        if (!vouchersByBank[voucher.bankId]) {
          vouchersByBank[voucher.bankId] = [];
        }
        vouchersByBank[voucher.bankId].push(voucher);
      });
      
      // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„çµ„åˆ (é‡å°æ¯å€‹éŠ€è¡Œ)
      const bankCombinations = {};
      Object.keys(vouchersByBank).forEach(bankId => {
        const bankVouchers = vouchersByBank[bankId];
        bankCombinations[bankId] = findCombinations(bankVouchers, amount);
      });
      
      // ç”Ÿæˆä¸åŒéŠ€è¡Œæ··åˆçš„çµ„åˆ
      const mixedCombinations = findMixedCombinations(sortedVouchers, amount);
      
      // æ‰¾å‡ºæœ€ä½³çµ„åˆ
      let bestCombination = null;
      let minDifference = Infinity;
      
      // æª¢æŸ¥æ¯å€‹éŠ€è¡Œçš„çµ„åˆ
      Object.keys(bankCombinations).forEach(bankId => {
        const combinations = bankCombinations[bankId];
        if (combinations.length > 0) {
          combinations.forEach(combo => {
            const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
            const difference = comboSum - amount;
            if (difference >= 0 && difference < minDifference) {
              minDifference = difference;
              bestCombination = {
                vouchers: combo,
                sum: comboSum,
                difference: difference,
                mixed: false,
                bankId: bankId
              };
            }
          });
        }
      });
      
      // æª¢æŸ¥æ··åˆéŠ€è¡Œçš„çµ„åˆ
      if (mixedCombinations.length > 0) {
        mixedCombinations.forEach(combo => {
          const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
          const difference = comboSum - amount;
          if (difference >= 0 && difference < minDifference) {
            minDifference = difference;
            bestCombination = {
              vouchers: combo,
              sum: comboSum,
              difference: difference,
              mixed: true
            };
          }
        });
      }
      
      // å¦‚æœæ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„çµ„åˆï¼Œè¿”å›null
      if (!bestCombination && unusedVouchers.length > 0) {
        // å˜—è©¦æ‰¾å‡ºæ¥è¿‘ä½†å°æ–¼ç›®æ¨™é‡‘é¡çš„çµ„åˆ
        let maxSum = 0;
        let closestCombination = null;
        
        // æª¢æŸ¥æ¯å€‹éŠ€è¡Œçš„çµ„åˆ
        Object.keys(bankCombinations).forEach(bankId => {
          const combinations = findCombinationsUnderTarget(vouchersByBank[bankId], amount);
          if (combinations.length > 0) {
            combinations.forEach(combo => {
              const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
              if (comboSum > maxSum) {
                maxSum = comboSum;
                closestCombination = {
                  vouchers: combo,
                  sum: comboSum,
                  difference: amount - comboSum,
                  mixed: false,
                  bankId: bankId,
                  underTarget: true
                };
              }
            });
          }
        });
        
        // æª¢æŸ¥æ··åˆéŠ€è¡Œçš„çµ„åˆ
        const underTargetMixedCombinations = findCombinationsUnderTarget(sortedVouchers, amount);
        if (underTargetMixedCombinations.length > 0) {
          underTargetMixedCombinations.forEach(combo => {
            const comboSum = combo.reduce((sum, v) => sum + v.amount, 0);
            if (comboSum > maxSum) {
              maxSum = comboSum;
              closestCombination = {
                vouchers: combo,
                sum: comboSum,
                difference: amount - comboSum,
                mixed: true,
                underTarget: true
              };
            }
          });
        }
        
        return closestCombination;
      }
      
      return bestCombination;
    }

    // å°‹æ‰¾ç­‰æ–¼æˆ–è¶…éç›®æ¨™é‡‘é¡çš„æ‰€æœ‰çµ„åˆ
    function findCombinations(vouchers, targetAmount) {
      const result = [];
      
      // æœ€å¤šå˜—è©¦5å¼µå„ªæƒ åˆ¸çš„çµ„åˆï¼Œé¿å…çµ„åˆçˆ†ç‚¸
      const maxVouchers = Math.min(5, vouchers.length);
      
      // è¼”åŠ©å‡½æ•¸ï¼Œä½¿ç”¨å›æº¯æ³•æŸ¥æ‰¾æ‰€æœ‰çµ„åˆ
      function backtrack(start, currentCombination, currentSum) {
        // å¦‚æœç•¶å‰ç¸½å’Œé”åˆ°æˆ–è¶…éç›®æ¨™é‡‘é¡ï¼Œæ·»åŠ åˆ°çµæœä¸­
        if (currentSum >= targetAmount) {
          result.push([...currentCombination]);
          return;
        }
        
        // å¦‚æœå·²ç¶“é”åˆ°æœ€å¤§å„ªæƒ åˆ¸æ•¸é‡ï¼Œè¿”å›
        if (currentCombination.length >= maxVouchers) {
          return;
        }
        
        // å˜—è©¦æ·»åŠ æ›´å¤šå„ªæƒ åˆ¸
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // é–‹å§‹å›æº¯
      backtrack(0, [], 0);
      
      // æŒ‰ç¸½å’Œæ’åºï¼Œå„ªå…ˆé¸æ“‡ç¸½å’Œæœ€æ¥è¿‘ç›®æ¨™é‡‘é¡çš„çµ„åˆ
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumA - sumB;
      });
    }

    // å°‹æ‰¾æ··åˆéŠ€è¡Œçš„çµ„åˆ
    function findMixedCombinations(vouchers, targetAmount) {
      // é€™è£¡æˆ‘å€‘ç°¡åŒ–ä¸€ä¸‹ï¼Œåªè€ƒæ…®æœ€å¤š3å¼µä¸åŒéŠ€è¡Œçš„å¡çš„çµ„åˆ
      const result = [];
      
      // æœ€å¤šå˜—è©¦3å¼µå„ªæƒ åˆ¸çš„çµ„åˆï¼Œé¿å…çµ„åˆçˆ†ç‚¸
      const maxVouchers = Math.min(3, vouchers.length);
      
      // è¼”åŠ©å‡½æ•¸ï¼Œä½¿ç”¨å›æº¯æ³•æŸ¥æ‰¾æ‰€æœ‰çµ„åˆ
      function backtrack(start, currentCombination, currentSum) {
        // å¦‚æœç•¶å‰ç¸½å’Œé”åˆ°æˆ–è¶…éç›®æ¨™é‡‘é¡ï¼Œæ·»åŠ åˆ°çµæœä¸­
        if (currentSum >= targetAmount) {
          result.push([...currentCombination]);
          return;
        }
        
        // å¦‚æœå·²ç¶“é”åˆ°æœ€å¤§å„ªæƒ åˆ¸æ•¸é‡ï¼Œè¿”å›
        if (currentCombination.length >= maxVouchers) {
          return;
        }
        
        // å˜—è©¦æ·»åŠ æ›´å¤šå„ªæƒ åˆ¸
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // é–‹å§‹å›æº¯
      backtrack(0, [], 0);
      
      // æŒ‰ç¸½å’Œæ’åºï¼Œå„ªå…ˆé¸æ“‡ç¸½å’Œæœ€æ¥è¿‘ç›®æ¨™é‡‘é¡çš„çµ„åˆ
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumA - sumB;
      });
    }

    // å°‹æ‰¾å°æ–¼ç›®æ¨™é‡‘é¡çš„æœ€å¤§çµ„åˆ
    function findCombinationsUnderTarget(vouchers, targetAmount) {
      const result = [];
      
      // æœ€å¤šå˜—è©¦5å¼µå„ªæƒ åˆ¸çš„çµ„åˆï¼Œé¿å…çµ„åˆçˆ†ç‚¸
      const maxVouchers = Math.min(5, vouchers.length);
      
      // è¼”åŠ©å‡½æ•¸ï¼Œä½¿ç”¨å›æº¯æ³•æŸ¥æ‰¾æ‰€æœ‰çµ„åˆ
      function backtrack(start, currentCombination, currentSum) {
        // å¦‚æœç•¶å‰ç¸½å’Œå°æ–¼ç›®æ¨™é‡‘é¡ï¼Œæ·»åŠ åˆ°çµæœä¸­
        if (currentSum > 0 && currentSum < targetAmount) {
          result.push([...currentCombination]);
        }
        
        // å¦‚æœå·²ç¶“é”åˆ°æœ€å¤§å„ªæƒ åˆ¸æ•¸é‡æˆ–ç•¶å‰ç¸½å’Œå·²ç¶“é”åˆ°æˆ–è¶…éç›®æ¨™é‡‘é¡ï¼Œè¿”å›
        if (currentCombination.length >= maxVouchers || currentSum >= targetAmount) {
          return;
        }
        
        // å˜—è©¦æ·»åŠ æ›´å¤šå„ªæƒ åˆ¸
        for (let i = start; i < vouchers.length; i++) {
          currentCombination.push(vouchers[i]);
          backtrack(i + 1, currentCombination, currentSum + vouchers[i].amount);
          currentCombination.pop();
        }
      }
      
      // é–‹å§‹å›æº¯
      backtrack(0, [], 0);
      
      // æŒ‰ç¸½å’Œé™åºæ’åºï¼Œå„ªå…ˆé¸æ“‡ç¸½å’Œæœ€æ¥è¿‘ç›®æ¨™é‡‘é¡çš„çµ„åˆ
      return result.sort((a, b) => {
        const sumA = a.reduce((sum, v) => sum + v.amount, 0);
        const sumB = b.reduce((sum, v) => sum + v.amount, 0);
        return sumB - sumA; // é™åºæ’åˆ—
      });
    }

    // åˆå§‹åŒ–é¸é …å¡åŠŸèƒ½
    function initTabs() {
      const tabButtons = document.querySelectorAll('#tabs button');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.getAttribute('data-tab');
          
          // æ›´æ–°æŒ‰éˆ•æ¨£å¼
          tabButtons.forEach(btn => {
            btn.classList.remove('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
            btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
          });
          
          button.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
          button.classList.add('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
          
          // é¡¯ç¤ºå°æ‡‰çš„å…§å®¹
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          
          document.getElementById(`${tabName}-content`).classList.remove('hidden');
          
          // å¦‚æœåˆ‡æ›åˆ°çµ±è¨ˆæ¨™ç±¤ï¼Œæ›´æ–°åœ–è¡¨
          if (tabName === 'stats') {
            updateCharts(chartPeriodMode);
          }
        });
      });
    }

    // åˆå§‹åŒ–åœ–è¡¨é€±æ¬¡ç¯©é¸åŠŸèƒ½
    function initChartWeekFilter() {
      const chartWeekFilter = document.getElementById('chart-week-filter');
      const toggleChartPeriod = document.getElementById('toggle-chart-period');
      const toggleText = document.getElementById('toggle-text');
      
      // å¡«å……é€±æ¬¡é¸é …
      chartWeekFilter.innerHTML = '<option value="all">æ‰€æœ‰é€±æ¬¡</option>';
      weekSchedule.forEach(week => {
        const option = document.createElement('option');
        option.value = week.week;
        option.textContent = `ç¬¬${week.week}é€± (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
        chartWeekFilter.appendChild(option);
      });
      
      // é€±æ¬¡ç¯©é¸è®ŠåŒ–æ™‚æ›´æ–°åœ–è¡¨
      chartWeekFilter.addEventListener('change', function() {
        updateCharts(chartPeriodMode, this.value);
      });
      
      // åˆ‡æ›åœ–è¡¨é€±æœŸæ¨¡å¼æŒ‰éˆ•
      toggleChartPeriod.addEventListener('click', function() {
        if (chartPeriodMode === 'week') {
          chartPeriodMode = 'all';
          toggleText.textContent = 'åˆ‡æ›è‡³é€±æ¬¡ç¯©é¸';
          chartWeekFilter.style.display = 'none';
        } else {
          chartPeriodMode = 'week';
          toggleText.textContent = 'åˆ‡æ›è‡³å…¨éƒ¨æœŸé–“';
          chartWeekFilter.style.display = '';
        }
        updateCharts(chartPeriodMode);
      });
    }

    // åˆå§‹åŒ–å„ªæƒ åˆ¸çµ„åˆæ¨è–¦è¨ˆç®—åŠŸèƒ½
    function initVoucherRecommendation() {
      const paymentAmountInput = document.getElementById('payment-amount');
      const calculateRecommendationBtn = document.getElementById('calculate-recommendation');
      const recommendationResult = document.getElementById('recommendation-result');
      
      // è¨ˆç®—æ¨è–¦æŒ‰éˆ•
      calculateRecommendationBtn.addEventListener('click', () => {
        const amount = parseInt(paymentAmountInput.value);
        if (isNaN(amount) || amount <= 0) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¶ˆè²»é‡‘é¡ï¼');
          return;
        }
        
        // è¨ˆç®—æœ€ä½³çµ„åˆ
        const bestCombination = calculateBestVoucherCombination(amount);
        
        // é¡¯ç¤ºçµæœ
        recommendationResult.classList.remove('hidden');
        
        if (!bestCombination) {
          recommendationResult.innerHTML = `
            <div class="text-center py-4">
              <div class="text-red-500 dark:text-red-400 mb-2">ç„¡æ³•æ‰¾åˆ°åˆé©çš„å„ªæƒ åˆ¸çµ„åˆ</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">æ‚¨ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸ï¼Œæˆ–è€…å¯ç”¨å„ªæƒ åˆ¸ä¸è¶³ä»¥æ”¯ä»˜è©²é‡‘é¡</div>
            </div>
          `;
          return;
        }
        
        // æ ¹æ“šæ˜¯å¦å°æ–¼ç›®æ¨™é‡‘é¡é¡¯ç¤ºä¸åŒçš„æç¤º
        const headerClass = bestCombination.underTarget ? 'text-yellow-500 dark:text-yellow-400' : 'text-green-500 dark:text-green-400';
        const headerText = bestCombination.underTarget ? 
          `æ‰¾åˆ°æœ€æ¥è¿‘çš„çµ„åˆï¼ˆé‚„éœ€æ”¯ä»˜${bestCombination.difference}å…ƒï¼‰` : 
          `æ‰¾åˆ°æœ€ä½³çµ„åˆï¼ˆå¤š${bestCombination.difference}å…ƒï¼‰`;
        
        // æ ¹æ“šæ˜¯å¦æ··åˆéŠ€è¡Œé¡¯ç¤ºä¸åŒçš„æç¤º
        const bankText = bestCombination.mixed ? 
          'æ··åˆä½¿ç”¨å¤šå®¶éŠ€è¡Œçš„å„ªæƒ åˆ¸' : 
          `ä½¿ç”¨${getBankName(bestCombination.bankId)}çš„å„ªæƒ åˆ¸`;
        
        // ç”Ÿæˆå„ªæƒ åˆ¸åˆ—è¡¨
        let vouchersList = '';
        const vouchersByAmount = {};
        
        bestCombination.vouchers.forEach(voucher => {
          if (!vouchersByAmount[voucher.amount]) {
            vouchersByAmount[voucher.amount] = { count: 0, banks: {} };
          }
          
          vouchersByAmount[voucher.amount].count++;
          
          if (!vouchersByAmount[voucher.amount].banks[voucher.bankId]) {
            vouchersByAmount[voucher.amount].banks[voucher.bankId] = 0;
          }
          
          vouchersByAmount[voucher.amount].banks[voucher.bankId]++;
        });
        
        // æŒ‰é‡‘é¡å¾å¤§åˆ°å°æ’åº
        const amounts = Object.keys(vouchersByAmount).map(Number).sort((a, b) => b - a);
        
        amounts.forEach(amount => {
          const data = vouchersByAmount[amount];
          
          let bankDetails = '';
          Object.keys(data.banks).forEach(bankId => {
            const bank = banks.find(b => b.id === bankId);
            if (bank) {
              bankDetails += `
                <div class="flex items-center text-xs ml-4 mb-1">
                  <i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
                  <span>${bank.name}: ${data.banks[bankId]}å¼µ</span>
                </div>
              `;
            }
          });
          
          vouchersList += `
            <div class="mb-2">
              <div class="font-medium">${amount}å…ƒ Ã— ${data.count}å¼µ = ${amount * data.count}å…ƒ</div>
              ${bankDetails}
            </div>
          `;
        });
        
        // æ·»åŠ é¸æ“‡æŒ‰éˆ•
        const selectButtonsHtml = `
          <div class="mt-3 pt-3 border-t">
            <button id="select-recommended-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white py-2 rounded-lg">
              é¸æ“‡é€™äº›å„ªæƒ åˆ¸
            </button>
          </div>
        `;
        
        recommendationResult.innerHTML = `
          <div>
            <div class="${headerClass} font-bold mb-2">${headerText}</div>
            <div class="text-sm mb-3">
              <div>æ¶ˆè²»é‡‘é¡: ${amount}å…ƒ</div>
              <div>å„ªæƒ åˆ¸ç¸½é¡: ${bestCombination.sum}å…ƒ</div>
              <div>ä½¿ç”¨å„ªæƒ åˆ¸æ•¸é‡: ${bestCombination.vouchers.length}å¼µ</div>
              <div>${bankText}</div>
            </div>
            <div class="border-t pt-2">
              <div class="font-medium mb-1">å„ªæƒ åˆ¸æ˜ç´°:</div>
              ${vouchersList}
            </div>
            ${!bestCombination.underTarget ? selectButtonsHtml : ''}
          </div>
        `;
        
        // æ·»åŠ é¸æ“‡æ¨è–¦å„ªæƒ åˆ¸çš„åŠŸèƒ½
        if (!bestCombination.underTarget) {
          document.getElementById('select-recommended-vouchers').addEventListener('click', function() {
            // æ·»åŠ é¸æ“‡çš„å„ªæƒ åˆ¸åˆ°å·²é¸æ“‡åˆ—è¡¨
            bestCombination.vouchers.forEach(voucher => {
              if (!appState.selectedVouchers.includes(voucher.id)) {
                appState.selectedVouchers.push(voucher.id);
              }
            });
            
            // æ›´æ–°UI
            saveAppState();
            updateVoucherSelection();
            updateSelectedVouchers();
            
            // å¦‚æœä¸åœ¨å…‘æ›é¸é …å¡ï¼Œåˆ‡æ›åˆ°å…‘æ›é¸é …å¡
            document.querySelectorAll('#tabs button').forEach(button => {
              if (button.getAttribute('data-tab') === 'redeem') {
                button.click();
              }
            });
            
            // éš±è—çµæœé¢æ¿ä¸¦æ¸…ç©ºè¼¸å…¥æ¡†
            recommendationResult.classList.add('hidden');
            paymentAmountInput.value = '';
          });
        }
      });
      
      // æŒ‰Enteréµä¹Ÿè§¸ç™¼è¨ˆç®—
      paymentAmountInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          calculateRecommendationBtn.click();
        }
      });
    }

    // åˆå§‹åŒ–åŒ¯å‡ºæ•¸æ“šåŠŸèƒ½
    function initExportData() {
      const exportDataBtn = document.getElementById('export-data-btn');
      const exportDataModal = document.getElementById('export-data-modal');
      const exportTextBtn = document.getElementById('export-text');
      const exportJsonBtn = document.getElementById('export-json');
      const closeExportModalBtn = document.getElementById('close-export-modal');
      const closeExportBtn = document.getElementById('close-export');
      const copyExportBtn = document.getElementById('copy-export');
      
      // æ‰“é–‹åŒ¯å‡ºæ•¸æ“šæ¨¡æ…‹æ¡†
      exportDataBtn.addEventListener('click', () => {
        exportDataModal.classList.remove('hidden');
        document.getElementById('export-result').classList.add('hidden');
        copyExportBtn.classList.add('hidden');
      });
      
      // åŒ¯å‡ºæ–‡å­—æ‘˜è¦
      exportTextBtn.addEventListener('click', () => {
        exportData('text');
      });
      
      // åŒ¯å‡ºJSONæ•¸æ“š
      exportJsonBtn.addEventListener('click', () => {
        exportData('json');
      });
      
      // è¤‡è£½åˆ°å‰ªè²¼æ¿
      copyExportBtn.addEventListener('click', () => {
        const content = document.getElementById('export-content').textContent;
        navigator.clipboard.writeText(content)
          .then(() => {
            copyExportBtn.textContent = 'å·²è¤‡è£½!';
            setTimeout(() => {
              copyExportBtn.textContent = 'è¤‡è£½åˆ°å‰ªè²¼æ¿';
            }, 2000);
          })
          .catch(err => {
            alert('è¤‡è£½å¤±æ•—: ' + err);
          });
      });
      
      // é—œé–‰åŒ¯å‡ºæ•¸æ“šæ¨¡æ…‹æ¡†
      closeExportModalBtn.addEventListener('click', () => {
        exportDataModal.classList.add('hidden');
      });
      
      closeExportBtn.addEventListener('click', () => {
        exportDataModal.classList.add('hidden');
      });
    }

    // å•Ÿå‹•æ‡‰ç”¨ç¨‹åº
    document.addEventListener('DOMContentLoaded', function() {
      // åŠ è¼‰æ‡‰ç”¨ç¨‹åºç‹€æ…‹
      loadAppState();
      
      // åˆå§‹åŒ–å„åŠŸèƒ½
      initTabs();
      initVoucherRecommendation();
      initCharts();
      initChartWeekFilter();
      initExportData();
      
      // æ›´æ–°ç•Œé¢
      updateUI();
      
      // ç›£è½æ·±è‰²æ¨¡å¼è®ŠåŒ–ä¾†æ›´æ–°åœ–è¡¨é¡è‰²
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (valueChart && bankChart && weekAmountChart && bankValueChart && statusChart) {
          // æ›´æ–°åœ–è¡¨é¡è‰²
          valueChart.data.datasets[0].backgroundColor = document.documentElement.classList.contains('dark') ? 
            ['#facc15', '#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc'] : 
            ['#fef08a', '#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff'];
          
          bankChart.data.datasets[0].backgroundColor = document.documentElement.classList.contains('dark') ? 
            chartColors.dark : chartColors.light;
          
          // æ›´æ–°ç‹€æ…‹åœ–è¡¨é¡è‰²
          statusChart.data.datasets[0].backgroundColor = document.documentElement.classList.contains('dark') ? 
            ['#86efac', '#93c5fd', '#f87171'] : 
            ['#dcfce7', '#dbeafe', '#fecaca'];
          
          // æ›´æ–°æ‰€æœ‰åœ–è¡¨
          valueChart.update();
          bankChart.update();
          weekAmountChart.update();
          bankValueChart.update();
          statusChart.update();
          
          // æ›´æ–°Chart.jså…¨å±€é…ç½®
          Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
          Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';
        }
      });
    });
  </script>
</body>
</html>
