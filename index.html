<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>全運聚力‧社區消費大獎賞追蹤器</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
colors: {
primary: '#5D5CDE', 'primary-dark': '#4B4AB2',
'boc': '#c1272d', 'boc-dark': '#a01e21',
'icbc': '#c7000a', 'icbc-dark': '#a00008',
'macaupass': '#0c6e4f', 'macaupass-dark': '#095338',
'luso': '#00529b', 'luso-dark': '#003e75',
'ant': '#2c64ae', 'ant-dark': '#1a4d8a',
'mpay': '#1e469a', 'mpay-dark': '#173777',
'gdb': '#e83828', 'gdb-dark': '#b82116'
}
}
}
}
</script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
<div class="max-w-md mx-auto p-4">
<!-- 標題和計數器 -->
<div class="text-center mb-4">
<h1 class="text-2xl font-bold text-primary dark:text-primary mb-2">全運聚力‧社區消費大獎賞追蹤器</h1>
<div class="text-sm bg-blue-50 dark:bg-blue-900 p-2 rounded-lg">
<div>今天：<span id="current-date">載入中...</span> | <span id="current-week">載入中...</span></div>
</div>
</div>

<!-- 主要功能選項卡 -->
<div class="mb-4 border-b border-gray-200 dark:border-gray-700">
<ul class="flex flex-wrap" id="tabs">
<li class="w-1/4 text-center"><button class="w-full py-2 px-1 text-primary dark:text-primary border-b-2 border-primary dark:border-primary tab-active" data-tab="earn">賺取</button></li>
<li class="w-1/4 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="redeem">兑換</button></li>
<li class="w-1/4 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="history">已兑換</button></li>
<li class="w-1/4 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="stats">統計</button></li>
</ul>
</div>

<!-- 賺取優惠券面板 -->
<div class="tab-content" id="earn-content">
<!-- 銀行選擇按鈕組 -->
<div class="mb-4">
<div class="flex justify-between items-center mb-2">
<div class="text-sm font-medium">選擇支付工具 (點擊銀行添加優惠券)</div>
<div class="flex gap-2">
<button id="admin-mode-btn" class="text-xs px-2 py-1 flex items-center bg-yellow-500 text-white rounded hover:bg-yellow-600">
<i class="ri-settings-5-line mr-1"></i> 管理
</button>
<button id="bank-display-settings-btn" class="text-xs px-2 py-1 flex items-center bg-primary text-white rounded hover:bg-primary-dark">
<i class="ri-settings-3-line mr-1"></i> 設定
</button>
</div>
</div>

<div class="grid grid-cols-4 gap-2 mb-4" id="bank-buttons"></div>
</div>

<!-- 快速添加優惠券 -->
<div id="quick-add-container" class="mb-4 hidden">
<div class="flex justify-between items-center mb-2">
<div class="text-sm font-medium"><span id="selected-bank-name-display">銀行</span>優惠券 (總計: <span id="total-draws">0</span>/3次)</div>
</div>
<div class="grid grid-cols-3 gap-2 mb-2">
<button data-amount="10" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">10元</button>
<button data-amount="20" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">20元</button>
<button data-amount="50" class="quick-add py-2 px-1 bg-green-100 dark:bg-green-900 rounded-lg text-center hover:bg-green-200 dark:hover:bg-green-800 transition-colors">50元</button>
<button data-amount="100" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">100元</button>
<button data-amount="200" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">200元</button>
<button data-amount="0" class="quick-add py-2 px-1 bg-yellow-100 dark:bg-yellow-900 rounded-lg text-center hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors">😄</button>
</div>
</div>

<!-- 銀行優惠券總覽 -->
<div class="mb-4">
<h3 class="text-sm font-bold mb-2">各銀行優惠券總覽 (本週)</h3>
<div id="bank-overview-list" class="space-y-3"></div>
</div>
</div>

<!-- 兑換優惠券面板 -->
<div class="tab-content hidden" id="redeem-content">
<!-- 優惠券計算器 -->
<div class="mb-4 bg-green-50 dark:bg-green-900/20 rounded-lg p-3 shadow">
<div class="flex items-center justify-between mb-2">
<div>
<div class="text-sm font-medium">優惠券計算器</div>
<div class="text-xs text-gray-500 dark:text-gray-400">輸入金額計算最佳組合</div>
</div>
</div>

<div class="space-y-3">
<div class="flex space-x-2">
<input type="number" id="payment-amount" min="1" placeholder="輸入消費金額" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
</div>

<div class="grid grid-cols-2 gap-2">
<button id="calculate-max-value" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors text-sm">
<i class="ri-money-dollar-circle-line mr-1"></i>最大節省
</button>
<button id="calculate-max-quantity" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
<i class="ri-stack-line mr-1"></i>最多優惠券
</button>
<button id="calculate-high-value" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
<i class="ri-vip-crown-line mr-1"></i>優先高面值
</button>
<button id="calculate-same-bank" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
<i class="ri-bank-line mr-1"></i>同行優惠券
</button>
</div>
</div>

<!-- 計算結果區域 -->
<div id="recommendation-result" class="mt-3 border rounded-lg p-3 bg-white dark:bg-gray-800 hidden"></div>
</div>

<!-- 可用優惠券總覽 -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
<div class="flex justify-between items-center mb-2">
<h3 class="text-sm font-bold">可用優惠券總覽</h3>
<div class="text-sm text-gray-500 dark:text-gray-400">
未使用: <span id="unused-vouchers-count" class="font-bold text-green-600 dark:text-green-400">0</span>張
</div>
</div>
<div id="redeemable-vouchers-list" class="space-y-2"></div>
</div>

<!-- 優惠券選擇和兑換區域 -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-bold">選擇並兑換優惠券</h3>
<div id="selection-summary" class="text-sm">
已選: <span id="selected-vouchers-count">0</span>張 (<span id="selected-vouchers-value">0</span>元)
</div>
</div>

<!-- 優惠券選擇區域 -->
<div id="redeem-voucher-selection" class="space-y-3 mb-4"></div>

<!-- 兑換操作區域 -->
<div id="redeem-operations" class="mt-3 hidden">
<div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
消費金額必須為優惠券總額的3倍或以上才能兑換
</div>
<div class="grid grid-cols-1 gap-2">
<div id="redeem-amount-info" class="text-sm text-gray-700 dark:text-gray-300 py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
最低需消費金額: <span id="min-redeem-amount">0</span>元
</div>
<div>
<input type="number" id="manual-spend-amount" placeholder="實際消費金額" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600 mb-2">
<div class="mb-2">
<div class="text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">消費類別 (選填)</div>
<div class="grid grid-cols-3 gap-2" id="consumption-category-buttons">
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="餐飲">
🍽️ 餐飲
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="購物">
🛍️ 購物
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="交通">
🚗 交通
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="超市">
🛒 超市
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="娛樂">
🎮 娛樂
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="醫療">
💊 醫療
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="教育">
📚 教育
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="服務">
⚙️ 服務
</button>
<button type="button" class="category-btn p-2 border rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-category="其他">
📦 其他
</button>
</div>
</div>
<textarea id="redeem-remark" placeholder="消費内容備註 (選填)" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600 mb-2" rows="2"></textarea>
<button id="redeem-selected-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
兑換優惠券
</button>
</div>
</div>
</div>
</div>
</div>

<!-- 已兑換記錄面板 -->
<div class="tab-content hidden" id="history-content">
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<div class="flex items-center justify-between mb-3">
<h3 class="font-bold">兑換記錄</h3>
<div class="text-sm text-gray-500 dark:text-gray-400">
總計: <span id="redeemed-total-count" class="font-bold">0</span>張
</div>
</div>

<div id="redemption-history-list" class="space-y-3">
<div class="text-center text-gray-500 dark:text-gray-400 py-4">尚無兑換記錄</div>
</div>
</div>
</div>

<!-- 統計面板 -->
<div class="tab-content hidden" id="stats-content">
<!-- 總體統計 -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
<h3 class="font-bold mb-2">總體統計</h3>
<div class="grid grid-cols-2 gap-3">
<div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">總優惠券</div>
<div class="text-xl font-bold" id="total-vouchers">0張</div>
</div>
<div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">總價值</div>
<div class="text-xl font-bold" id="total-value">0元</div>
</div>
<div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">已兑換率</div>
<div class="text-xl font-bold" id="usage-rate">0%</div>
</div>
<div class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">已過期率</div>
<div class="text-xl font-bold" id="expiry-rate">0%</div>
</div>
</div>
</div>

<!-- 圖表分析 -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">優惠券狀態分佈</h3>
<div class="h-60">
<canvas id="status-chart"></canvas>
</div>
</div>

<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">優惠券面值分佈</h3>
<div class="mb-3 flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
<button id="value-chart-total-btn" class="flex-1 py-1 px-2 text-center rounded bg-primary text-white text-xs">
總體分佈
</button>
<button id="value-chart-bank-btn" class="flex-1 py-1 px-2 text-center rounded text-gray-600 dark:text-gray-300 text-xs">
按銀行分佈
</button>
</div>
<div class="h-60">
<canvas id="value-chart"></canvas>
</div>
</div>

<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">銀行分佈 (按價值)</h3>
<div class="h-60">
<canvas id="bank-chart"></canvas>
</div>
</div>

<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">週次趨勢</h3>
<div class="h-60">
<canvas id="weekly-trend-chart"></canvas>
</div>
</div>

<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">消費類別分析</h3>
<div class="h-60">
<canvas id="category-chart"></canvas>
</div>
<!-- 類別詳細統計 -->
<div id="category-details" class="mt-3 pt-3 border-t dark:border-gray-700"></div>
</div>
</div>


</div>

<!-- 銀行顯示設置模態框 -->
<div id="bank-display-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-full max-w-sm mx-4">
<div class="flex justify-between items-center mb-3">
<h3 class="text-lg font-bold">支付工具顯示設定</h3>
<button id="close-bank-display-settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div class="mb-3">
<div class="text-sm mb-2">選擇要在主界面顯示的支付工具:</div>
<div class="flex flex-wrap gap-2 mb-3" id="bank-filters"></div>

<div class="flex space-x-2 mb-2">
<button id="select-all-display-banks" class="flex-1 bg-primary text-white py-1 px-3 rounded-lg text-sm">全選</button>
<button id="clear-display-banks" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-1 px-3 rounded-lg text-sm">清空</button>
</div>
</div>

<div class="flex justify-end">
<button id="save-bank-display-settings" class="bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark">
確定
</button>
</div>
</div>
</div>

<!-- 管理模式模態框 -->
<div id="admin-mode-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-3">
<h3 class="text-lg font-bold">管理模式</h3>
<button id="close-admin-mode" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div class="mb-3">
<div class="text-sm mb-2 text-yellow-600 dark:text-yellow-400">⚠️ 管理模式用於數據修復，請謹慎操作</div>
<div class="border-t border-b dark:border-gray-700 py-3">
<div class="mb-2">
<label class="block text-sm font-medium mb-1">週次選擇</label>
<select id="admin-week-select" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
<!-- Week options will be added by JS -->
</select>
</div>
<div class="mb-2">
<label class="block text-sm font-medium mb-1">支付工具</label>
<select id="admin-bank-select" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
<!-- Bank options will be added by JS -->
</select>
</div>
<div class="mb-2">
<label class="block text-sm font-medium mb-1">優惠券資料</label>
<div class="grid grid-cols-2 gap-2">
<div class="space-y-1 text-sm">
<div>10元: <span id="admin-10-count">0</span>張</div>
<div>20元: <span id="admin-20-count">0</span>張</div>
<div>50元: <span id="admin-50-count">0</span>張</div>
</div>
<div class="space-y-1 text-sm">
<div>100元: <span id="admin-100-count">0</span>張</div>
<div>200元: <span id="admin-200-count">0</span>張</div>
<div>😄: <span id="admin-0-count">0</span>張</div>
</div>
</div>
</div>
<div class="mt-4 space-y-2">
<div class="flex space-x-2">
<select id="admin-amount-select" class="p-2 border rounded flex-grow dark:bg-gray-700 dark:border-gray-600">
<option value="10">10元</option>
<option value="20">20元</option>
<option value="50">50元</option>
<option value="100">100元</option>
<option value="200">200元</option>
<option value="0">😄</option>
</select>
<button id="admin-add-btn" class="bg-green-500 text-white px-4 py-2 rounded">添加</button>
<button id="admin-remove-btn" class="bg-red-500 text-white px-4 py-2 rounded">刪除</button>
</div>
</div>
</div>
</div>

<div class="flex justify-end space-x-2">
<button id="close-admin-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
關閉
</button>
</div>
</div>
</div>

<!-- 確認兑換模態框 -->
<div id="confirm-redeem-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
<h3 class="text-lg font-bold mb-4">確認兑換</h3>
<p class="mb-4 text-sm">確定要兑換以下優惠券嗎？</p>
<div id="redeem-vouchers-info" class="mb-4 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"></div>
<div class="flex space-x-2">
<button id="cancel-redeem" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">取消</button>
<button id="confirm-redeem" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">確認兑換</button>
</div>
</div>
</div>

<script>
// 深色模式設置
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
if (event.matches) document.documentElement.classList.add('dark');
else document.documentElement.classList.remove('dark');
});

// 活動週期數據
const weekSchedule = [
{ week: 1, startDate: '2025-09-01', endDate: '2025-09-05', resetDate: '2025-09-06' },
{ week: 2, startDate: '2025-09-08', endDate: '2025-09-12', resetDate: '2025-09-13' },
{ week: 3, startDate: '2025-09-15', endDate: '2025-09-19', resetDate: '2025-09-20' },
{ week: 4, startDate: '2025-09-22', endDate: '2025-09-26', resetDate: '2025-09-27' },
{ week: 5, startDate: '2025-09-29', endDate: '2025-10-03', resetDate: '2025-10-04' },
{ week: 6, startDate: '2025-10-06', endDate: '2025-10-10', resetDate: '2025-10-11' },
{ week: 7, startDate: '2025-10-13', endDate: '2025-10-17', resetDate: '2025-10-18' },
{ week: 8, startDate: '2025-10-20', endDate: '2025-10-24', resetDate: '2025-10-25' },
{ week: 9, startDate: '2025-10-27', endDate: '2025-10-31', resetDate: '2025-11-01' },
{ week: 10, startDate: '2025-11-03', endDate: '2025-11-07', resetDate: '2025-11-08' },
{ week: 11, startDate: '2025-11-10', endDate: '2025-11-14', resetDate: '2025-11-15' },
{ week: 12, startDate: '2025-11-17', endDate: '2025-11-21', resetDate: '2025-11-22' },
{ week: 13, startDate: '2025-11-24', endDate: '2025-11-28', resetDate: '2025-11-29' }
];

// 銀行支付工具
const banks = [
{ id: 'boc', name: '中國銀行', color: 'boc', darkColor: 'boc-dark', logo: 'ri-bank-fill' },
{ id: 'icbc', name: '工商銀行', color: 'icbc', darkColor: 'icbc-dark', logo: 'ri-bank-fill' },
{ id: 'luso', name: '大豐銀行', color: 'luso', darkColor: 'luso-dark', logo: 'ri-bank-fill' },
{ id: 'bnu', name: '澳門國際銀行', color: 'primary', darkColor: 'primary-dark', logo: 'ri-bank-fill' },
{ id: 'macaupass', name: '澳門通', color: 'macaupass', darkColor: 'macaupass-dark', logo: 'ri-bank-card-fill' },
{ id: 'ant', name: '螞蟻銀行', color: 'ant', darkColor: 'ant-dark', logo: 'ri-bank-fill' },
{ id: 'mpay', name: '澳門極易付', color: 'mpay', darkColor: 'mpay-dark', logo: 'ri-wallet-fill' },
{ id: 'gdb', name: '廣發銀行', color: 'gdb', darkColor: 'gdb-dark', logo: 'ri-bank-fill' }
];

// 初始化应用程序状態
let appState = {
vouchers: [],
currentWeek: 1,
preferredBank: null,
selectedVouchers: [],
redemptionHistory: [],
nextRedemptionId: 1,
bankDisplayFilter: banks.map(bank => bank.id) // 初始化顯示所有銀行
};

// 圖表實例
let statusChart, valueChart, bankChart, weeklyTrendChart, categoryChart;
let tempSelectedVouchers = [];
let tempRedeemRemark = '';

// 預設的消費類別
const consumptionCategories = [
'餐飲', '購物', '交通', '超市', '娛樂', '醫療', '教育', '服務', '其他'
];

// 消費類別對應的圖示
const categoryIcons = {
'餐飲': '🍽️',
'購物': '🛍️', 
'交通': '🚗',
'超市': '🛒',
'娛樂': '🎮',
'醫療': '💊',
'教育': '📚',
'服務': '⚙️',
'其他': '📦'
};

// 計算當前週次 - 使用實際的週期時間表
function calculateCurrentWeek() {
const today = new Date().toISOString().split('T')[0];
return getWeekNumberFromDate(today);
}

// 格式化日期
function formatDate(dateString) {
const date = new Date(dateString);
return `${date.getMonth() + 1}月${date.getDate()}日`;
}

// 根據日期獲取週次
function getWeekNumberFromDate(dateString) {
for (let i = 0; i < weekSchedule.length; i++) {
if (dateString >= weekSchedule[i].startDate && dateString <= weekSchedule[i].endDate) {
return i + 1;
}
}

// 檢查週末
for (let i = 0; i < weekSchedule.length; i++) {
const resetDate = weekSchedule[i].resetDate;
const nextDay = new Date(resetDate);
nextDay.setDate(nextDay.getDate() + 1);
const nextDayStr = nextDay.toISOString().split('T')[0];

if (dateString === resetDate || dateString === nextDayStr) {
return i + 1;
}
}

return 1;
}

// 判斷優惠券是否過期
function isVoucherExpired(voucher) {
const today = new Date();
today.setHours(0, 0, 0, 0);

const weekNum = getWeekNumberFromDate(voucher.date) - 1;
if (weekNum >= 0 && weekNum < weekSchedule.length) {
const saturday = new Date(weekSchedule[weekNum].resetDate);
const sunday = new Date(saturday);
sunday.setDate(saturday.getDate() + 1);
sunday.setHours(23, 59, 59, 999);

return today > sunday;
}

return false;
}

// 計算銀行優惠券數量
function getBankVoucherCount(bankId, weekNum) {
return appState.vouchers.filter(v =>
v.bankId === bankId && getWeekNumberFromDate(v.date) === weekNum
).length;
}

// 獲取銀行名稱
function getBankName(bankId) {
const bank = banks.find(b => b.id === bankId);
return bank ? bank.name : '未知銀行';
}

// 判斷優惠券是否可兑換
function isVoucherRedeemable(voucher) {
if (voucher.amount === 0) return false;
return !voucher.used && !isVoucherExpired(voucher);
}

// 加載數據
function loadAppState() {
try {
const savedState = localStorage.getItem('voucherAppState');
if (savedState) {
appState = JSON.parse(savedState);
if (!appState.selectedVouchers) appState.selectedVouchers = [];
if (!appState.redemptionHistory) appState.redemptionHistory = [];
if (!appState.nextRedemptionId) {
appState.nextRedemptionId = appState.redemptionHistory.length > 0 ?
Math.max(...appState.redemptionHistory.map(r => Number(r.displayId) || 0)) + 1 : 1;
}
if (!appState.bankDisplayFilter) {
appState.bankDisplayFilter = banks.map(bank => bank.id);
}
}

appState.currentWeek = calculateCurrentWeek();
} catch (e) {
console.error('Failed to load app state:', e);
}
}

// 保存數據
function saveAppState() {
try {
localStorage.setItem('voucherAppState', JSON.stringify(appState));
} catch (e) {
console.error('Failed to save app state:', e);
alert('存儲數據失敗，可能是因為瀏覽器存儲空間已滿！');
}
}

// 更新日期和週次顯示
function updateDateDisplay() {
const today = new Date();
const currentDate = `${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日`;
document.getElementById('current-date').textContent = currentDate;

const weekNum = appState.currentWeek;
const weekElem = document.getElementById('current-week');

if (weekNum === 0) {
weekElem.textContent = '活動尚未開始';
} else if (weekNum > 13) {
weekElem.textContent = '活動已結束';
} else {
const weekData = weekSchedule[weekNum - 1];
weekElem.textContent = `第${weekNum}週 (${formatDate(weekData.startDate)} - ${formatDate(weekData.endDate)})`;
}
}

// 更新銀行按鈕
function updateBankButtons() {
const bankButtonsContainer = document.getElementById('bank-buttons');
bankButtonsContainer.innerHTML = '';

// 只显示在显示过滤器中的银行
const banksToShow = banks.filter(bank => 
appState.bankDisplayFilter && appState.bankDisplayFilter.includes(bank.id)
);

banksToShow.forEach(bank => {
const voucherCount = getBankVoucherCount(bank.id, appState.currentWeek);
const isDisabled = voucherCount >= 3;
const isSelected = !isDisabled && appState.preferredBank === bank.id;

const bankButton = document.createElement('div');
bankButton.className = `p-2 rounded-lg flex flex-col items-center ${
isDisabled ? 'opacity-50 cursor-default' : 'cursor-pointer'
} ${
isSelected ? `bg-${bank.color} text-white` : `bg-white dark:bg-gray-800 ${!isDisabled ? 'hover:bg-gray-100 dark:hover:bg-gray-700' : ''}`
}`;
bankButton.setAttribute('data-bank-id', bank.id);

bankButton.innerHTML = `
<i class="${bank.logo} text-2xl ${isSelected ? 'text-white' : `text-${bank.color} dark:text-${bank.color}`}"></i>
<div class="text-xs mt-1 ${isSelected ? 'text-white' : ''}">${bank.name}</div>
<div class="text-xs ${isSelected ? 'text-white' : 'text-gray-500 dark:text-gray-400'}">${voucherCount}/3</div>
`;

if (!isDisabled) {
bankButton.addEventListener('click', () => {
appState.preferredBank = bank.id;
saveAppState();
updateBankButtons();
updateQuickAddPanel();
});
}

bankButtonsContainer.appendChild(bankButton);
});
}

// 更新快速添加面板
function updateQuickAddPanel() {
const quickAddContainer = document.getElementById('quick-add-container');

if (appState.preferredBank) {
const bank = banks.find(b => b.id === appState.preferredBank);
document.getElementById('selected-bank-name-display').textContent = bank ? bank.name : '銀行';

const voucherCount = getBankVoucherCount(appState.preferredBank, appState.currentWeek);
document.getElementById('total-draws').textContent = voucherCount;

const isDisabled = voucherCount >= 3;
document.querySelectorAll('.quick-add').forEach(btn => {
if (isDisabled) {
btn.classList.add('opacity-50', 'cursor-not-allowed');
btn.disabled = true;
} else {
btn.classList.remove('opacity-50', 'cursor-not-allowed');
btn.disabled = false;

btn.onclick = function() {
const amount = parseInt(this.getAttribute('data-amount'));
addVoucher(amount);
};
}
});

quickAddContainer.classList.remove('hidden');
} else {
quickAddContainer.classList.add('hidden');
}
}

// 添加優惠券
function addVoucher(amount) {
const bankId = appState.preferredBank;
if (!bankId) {
alert('請先選擇銀行！');
return;
}

const date = new Date().toISOString().split('T')[0];
const weekNum = getWeekNumberFromDate(date);

// 檢查是否超過每週3個優惠券限制
const voucherCount = getBankVoucherCount(bankId, weekNum);
if (voucherCount >= 3) {
alert(`${getBankName(bankId)}本週已達3張優惠券上限！`);
return;
}

// 創建新優惠券
const newVoucher = {
id: Date.now().toString(),
amount: amount,
date: date,
used: false,
bankId: bankId
};

appState.vouchers.push(newVoucher);

saveAppState();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();

return true;
}

// 更新銀行優惠券總覽
function updateBankOverview() {
const bankOverviewList = document.getElementById('bank-overview-list');
bankOverviewList.innerHTML = '';

// 計算各銀行面值分佈
const bankDistribution = {};
banks.forEach(bank => {
bankDistribution[bank.id] = {
0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
count: 0, total: 0
};
});

// 計算總數據
const totalCounts = { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0, count: 0, total: 0 };

// 獲取當前週次
const currentWeek = appState.currentWeek;

// 統計各銀行優惠券 (僅當前週次)
appState.vouchers.forEach(voucher => {
if (voucher.bankId && getWeekNumberFromDate(voucher.date) === currentWeek) {
const bankData = bankDistribution[voucher.bankId];
if (bankData) {
bankData[voucher.amount]++;
bankData.count++;
if (voucher.amount > 0) bankData.total += voucher.amount;

totalCounts[voucher.amount]++;
totalCounts.count++;
if (voucher.amount > 0) totalCounts.total += voucher.amount;
}
}
});

if (totalCounts.count === 0) {
bankOverviewList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">尚未添加任何優惠券</div>';
return;
}

// 添加總計卡片
const totalCard = document.createElement('div');
totalCard.className = 'bg-primary-50 dark:bg-primary-900/30 border-primary border rounded-lg p-3';

totalCard.innerHTML = `
<div class="flex justify-between items-center mb-2 pb-2 border-b dark:border-gray-700">
<div class="font-bold">總計</div>
<div class="text-sm">${totalCounts.count}張 (${totalCounts.total}元)</div>
</div>

<div class="grid grid-cols-6 gap-1 text-center">
<div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 ${totalCounts[0] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[0]}</div>
<div class="text-xs">😄</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${totalCounts[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[10]}</div>
<div class="text-xs">10元</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${totalCounts[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[20]}</div>
<div class="text-xs">20元</div>
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 ${totalCounts[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[50]}</div>
<div class="text-xs">50元</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${totalCounts[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[100]}</div>
<div class="text-xs">100元</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${totalCounts[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[200]}</div>
<div class="text-xs">200元</div>
</div>
</div>
`;

bankOverviewList.appendChild(totalCard);

// 添加各銀行卡片
const banksToShow = banks.filter(bank => bankDistribution[bank.id].count > 0);
banksToShow.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));

banksToShow.forEach(bank => {
const data = bankDistribution[bank.id];

const bankCard = document.createElement('div');
bankCard.className = 'bg-white dark:bg-gray-800 border rounded-lg p-3';

bankCard.innerHTML = `
<div class="flex items-center justify-between mb-2 pb-2 border-b dark:border-gray-700">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-bold">${bank.name}</span>
</div>
<div class="text-sm">${data.count}張 (${data.total}元)</div>
</div>

<div class="grid grid-cols-6 gap-1 text-center">
<div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 ${data[0] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[0]}</div>
<div class="text-xs">😄</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${data[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[10]}</div>
<div class="text-xs">10元</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${data[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[20]}</div>
<div class="text-xs">20元</div>
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 ${data[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[50]}</div>
<div class="text-xs">50元</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${data[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[100]}</div>
<div class="text-xs">100元</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${data[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[200]}</div>
<div class="text-xs">200元</div>
</div>
</div>
`;

bankOverviewList.appendChild(bankCard);
});
}

// 更新可兑換優惠券列表
function updateRedeemableVouchers() {
const redeemableVouchersList = document.getElementById('redeemable-vouchers-list');
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

document.getElementById('unused-vouchers-count').textContent = redeemableVouchers.length;

if (redeemableVouchers.length === 0) {
redeemableVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">沒有可用的優惠券</div>';
return;
}

// 計算各面值的優惠券數量
const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, total: 0, count: 0};

redeemableVouchers.forEach(voucher => {
valueCounts[voucher.amount]++;
valueCounts.count++;
valueCounts.total += voucher.amount;
});

// 显示總覽
redeemableVouchersList.innerHTML = `
<div class="flex justify-between items-center p-2 bg-primary-50 dark:bg-primary-900/20 rounded">
<div>總計</div>
<div class="text-right">${valueCounts.count}張 (${valueCounts.total}元)</div>
</div>

<div class="grid grid-cols-5 gap-1 text-center my-2">
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[10]}</div><div class="text-xs">10元</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[20]}</div><div class="text-xs">20元</div>
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 ${valueCounts[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[50]}</div><div class="text-xs">50元</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[100]}</div><div class="text-xs">100元</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[200]}</div><div class="text-xs">200元</div>
</div>
</div>
`;
}

// 更新優惠券選擇區域
function updateVoucherSelection() {
const redeemedVoucherSelection = document.getElementById('redeem-voucher-selection');
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

if (redeemableVouchers.length === 0) {
redeemedVoucherSelection.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">沒有可用的優惠券</div>';
return;
}

// 按銀行分組
const vouchersByBank = {};
redeemableVouchers.forEach(voucher => {
if (!vouchersByBank[voucher.bankId]) vouchersByBank[voucher.bankId] = [];
vouchersByBank[voucher.bankId].push(voucher);
});

redeemedVoucherSelection.innerHTML = '';

const sortedBanks = banks.filter(bank => vouchersByBank[bank.id]?.length > 0);

sortedBanks.forEach(bank => {
const bankVouchers = vouchersByBank[bank.id] || [];

const bankSection = document.createElement('div');
bankSection.className = 'border rounded-lg overflow-hidden';

bankSection.innerHTML = `
<div class="bg-${bank.color} bg-opacity-20 dark:bg-opacity-30 p-2 flex justify-between items-center">
<div class="flex items-center font-bold">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span>${bank.name}</span>
</div>
<div class="text-gray-700 dark:text-gray-300">${bankVouchers.length}張</div>
</div>
`;

// 按面值分組
const vouchersByAmount = {};
bankVouchers.forEach(voucher => {
if (!vouchersByAmount[voucher.amount]) vouchersByAmount[voucher.amount] = [];
vouchersByAmount[voucher.amount].push(voucher);
});

const vouchersList = document.createElement('div');
vouchersList.className = 'p-2 space-y-1 bg-white dark:bg-gray-800';

const amounts = [200, 100, 50, 20, 10].filter(a => vouchersByAmount[a]?.length > 0);

amounts.forEach(amount => {
const amountVouchers = vouchersByAmount[amount] || [];

vouchersList.innerHTML += `
<div class="flex justify-between items-center mb-1">
<div class="flex items-center">
<span class="inline-block w-12 text-center py-1 px-1 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700">
${amount}元
</span>
</div>
<div class="text-gray-500 dark:text-gray-400">${amountVouchers.length}張</div>
</div>

<div class="ml-4 space-y-1 mt-1 mb-2">
${amountVouchers.map(voucher => `
<div class="flex items-center space-x-2">
<input type="checkbox" id="voucher-${voucher.id}" class="voucher-checkbox"
data-id="${voucher.id}" data-amount="${voucher.amount}"
${appState.selectedVouchers.includes(voucher.id) ? 'checked' : ''}>
<label for="voucher-${voucher.id}" class="text-sm">
${amount}元 優惠券
</label>
</div>
`).join('')}
</div>
`;
});

bankSection.appendChild(vouchersList);
redeemedVoucherSelection.appendChild(bankSection);
});

// 添加複選框事件
document.querySelectorAll('.voucher-checkbox').forEach(checkbox => {
checkbox.addEventListener('change', function() {
const voucherId = this.getAttribute('data-id');

if (this.checked) {
if (!appState.selectedVouchers.includes(voucherId)) {
appState.selectedVouchers.push(voucherId);
}
} else {
appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
}

saveAppState();
updateSelectedVouchers();
});
});
}

// 更新已選擇的優惠券列表
function updateSelectedVouchers() {
const redeemOperations = document.getElementById('redeem-operations');
const selectionSummary = document.getElementById('selection-summary');

const selectedVouchers = appState.selectedVouchers
.map(id => appState.vouchers.find(v => v.id === id))
.filter(isVoucherRedeemable);

document.getElementById('selected-vouchers-count').textContent = selectedVouchers.length;
document.getElementById('selected-vouchers-value').textContent = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);

if (selectedVouchers.length === 0) {
redeemOperations.classList.add('hidden');
selectionSummary.style.visibility = 'hidden';
} else {
redeemOperations.classList.remove('hidden');
selectionSummary.style.visibility = 'visible';

const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
document.getElementById('min-redeem-amount').textContent = totalValue * 3;
}

document.getElementById('redeem-selected-vouchers').onclick = function() {
const spendAmount = parseInt(document.getElementById('manual-spend-amount').value);
const remark = document.getElementById('redeem-remark').value.trim();
showRedeemConfirmation(spendAmount, remark);
};
}

// 顯示兑換確認
function showRedeemConfirmation(userSpendAmount, remark) {
const selectedVouchers = appState.selectedVouchers
.map(id => appState.vouchers.find(v => v.id === id))
.filter(isVoucherRedeemable);

if (selectedVouchers.length === 0) {
alert('請先選擇要兑換的優惠券！');
return;
}

const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
const requiredAmount = totalValue * 3;

if (userSpendAmount && userSpendAmount < requiredAmount) {
alert(`消費金額必須至少為${requiredAmount}元才能兑換所選優惠券！`);
return;
}

const spendAmount = userSpendAmount || requiredAmount;
const category = document.getElementById('consumption-category').value;

let infoHTML = `
<div class="mb-3">
<div class="font-medium">優惠券數量: ${selectedVouchers.length}張</div>
<div class="font-medium text-primary">消費金額: ${spendAmount}元</div>
<div class="text-green-600 dark:text-green-400">節省金額: ${totalValue}元</div>
<div class="text-gray-500 dark:text-gray-400">自費金額: ${spendAmount - totalValue}元</div>
</div>
`;

if (category) {
const categoryIcon = categoryIcons[category] || '📦';
infoHTML += `<div class="mb-3">
<div class="font-medium">消費類別:</div>
<div class="text-sm mt-1 p-2 bg-gray-50 dark:bg-gray-700 rounded flex items-center">
<span class="mr-2">${categoryIcon}</span>
<span>${category}</span>
</div>
</div>`;
}

if (remark) {
infoHTML += `<div class="mb-3">
<div class="font-medium">消費備註:</div>
<div class="text-sm mt-1 p-2 bg-gray-50 dark:bg-gray-700 rounded">${remark}</div>
</div>`;
}

document.getElementById('redeem-vouchers-info').innerHTML = infoHTML;
document.getElementById('confirm-redeem-modal').classList.remove('hidden');

tempSelectedVouchers = [...selectedVouchers];
tempRedeemRemark = remark;

document.getElementById('confirm-redeem').onclick = function() {
redeemVouchers(spendAmount, remark, category);
document.getElementById('confirm-redeem-modal').classList.add('hidden');
};

document.getElementById('cancel-redeem').onclick = function() {
document.getElementById('confirm-redeem-modal').classList.add('hidden');
};
}

// 兑換優惠券
function redeemVouchers(spendAmount, remark, category) {
if (!tempSelectedVouchers || tempSelectedVouchers.length === 0) {
alert("兑換失敗：沒有選中的優惠券");
return;
}

try {
const totalValue = tempSelectedVouchers.reduce((sum, v) => sum + (v.amount || 0), 0);
const requiredAmount = totalValue * 3;

if (spendAmount < requiredAmount) {
alert(`消費金額必須至少為${requiredAmount}元才能兑換所選優惠券！`);
return;
}

// 記錄兑換歷史
const redemption = {
id: Date.now().toString(),
displayId: appState.nextRedemptionId,
date: new Date().toISOString(),
vouchers: tempSelectedVouchers.map(v => ({
id: v.id,
amount: v.amount,
bankId: v.bankId
})),
voucherCount: tempSelectedVouchers.length,
voucherValue: totalValue,
spendAmount: spendAmount,
remark: tempRedeemRemark || remark,
category: category || null,
weekNum: appState.currentWeek
};

appState.redemptionHistory.push(redemption);
appState.nextRedemptionId++;

// 標記優惠券為已使用
tempSelectedVouchers.forEach(voucher => {
const v = appState.vouchers.find(v => v.id === voucher.id);
if (v) v.used = true;
});

// 清空選擇列表和輸入欄位
appState.selectedVouchers = [];
document.getElementById('manual-spend-amount').value = '';
document.getElementById('redeem-remark').value = '';
clearCategorySelection();

saveAppState();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();

alert(`成功兑換${tempSelectedVouchers.length}張優惠券！消費金額: ${spendAmount}元`);
} catch (error) {
alert(`兑換失敗：${error.message || "未知錯誤"}`);
} finally {
tempSelectedVouchers = [];
tempRedeemRemark = '';
}
}

// 更新兑換記錄列表
function updateRedemptionHistory() {
const redemptionHistoryList = document.getElementById('redemption-history-list');
const redeemedTotalCount = document.getElementById('redeemed-total-count');

const totalRedeemed = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherCount, 0);
redeemedTotalCount.textContent = totalRedeemed;

if (appState.redemptionHistory.length === 0) {
redemptionHistoryList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">尚無兑換記錄</div>';
return;
}

const sortedHistory = [...appState.redemptionHistory].sort((a, b) => new Date(b.date) - new Date(a.date));

redemptionHistoryList.innerHTML = '';

sortedHistory.forEach(redemption => {
const redemptionDate = new Date(redemption.date);

const card = document.createElement('div');
card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-3';

card.innerHTML = `
<div class="flex justify-between items-start mb-2">
<div class="font-bold">兑換記錄 #${redemption.displayId.toString().padStart(4, '0')}</div>
<div class="flex items-center space-x-2">
<button class="withdraw-redemption text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" 
data-redemption-id="${redemption.id}" title="撤回兌換">
<i class="ri-arrow-go-back-line mr-1"></i>撤回
</button>
<div class="text-xs text-gray-500 dark:text-gray-400">${redemptionDate.toLocaleDateString()} ${redemptionDate.toLocaleTimeString()}</div>
</div>
</div>

<div class="grid grid-cols-2 gap-2 mb-2">
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">優惠券數量</div>
<div class="font-bold">${redemption.voucherCount}張</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">節省金額</div>
<div class="font-bold text-green-600 dark:text-green-400">${redemption.voucherValue}元</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">消費金額</div>
<div class="font-bold">${redemption.spendAmount}元</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">週次</div>
<div class="font-bold">第${redemption.weekNum}週</div>
</div>
</div>

${redemption.category ? `
<div class="mb-2">
<div class="text-xs text-gray-500 dark:text-gray-400">消費類別</div>
<div class="text-sm border-t dark:border-gray-700 pt-1 flex items-center">
<span class="mr-2">${categoryIcons[redemption.category] || '📦'}</span>
<span>${redemption.category}</span>
</div>
</div>
` : ''}
${redemption.remark ? `
<div class="mb-2">
<div class="text-xs text-gray-500 dark:text-gray-400">消費備註</div>
<div class="text-sm border-t dark:border-gray-700 pt-1">${redemption.remark}</div>
</div>
` : ''}
`;

redemptionHistoryList.appendChild(card);
});

// 添加撤回兌換事件監聽器
document.querySelectorAll('.withdraw-redemption').forEach(button => {
button.addEventListener('click', function() {
const redemptionId = this.getAttribute('data-redemption-id');
showWithdrawConfirmation(redemptionId);
});
});
}

// 顯示撤回確認對話框
function showWithdrawConfirmation(redemptionId) {
const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);
if (!redemption) {
alert('找不到兌換記錄！');
return;
}

// 創建確認對話框
const modal = document.createElement('div');
modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
modal.innerHTML = `
<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
<h3 class="text-lg font-bold mb-4">確認撤回兌換</h3>
<div class="mb-4 text-sm">
<div class="mb-2">兌換記錄 #${redemption.displayId.toString().padStart(4, '0')}</div>
<div class="text-gray-600 dark:text-gray-400">優惠券數量: ${redemption.voucherCount}張</div>
<div class="text-gray-600 dark:text-gray-400">消費金額: ${redemption.spendAmount}元</div>
<div class="text-gray-600 dark:text-gray-400">節省金額: ${redemption.voucherValue}元</div>
</div>
<div class="text-sm text-red-600 dark:text-red-400 mb-4">
⚠️ 撤回後，優惠券將恢復為未使用狀態，兌換記錄將被刪除
</div>
<div class="flex justify-end space-x-3">
<button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">取消</button>
<button class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded" onclick="withdrawRedemption('${redemptionId}'); this.closest('.fixed').remove()">確認撤回</button>
</div>
</div>
`;
document.body.appendChild(modal);
}

// 撤回兌換功能
function withdrawRedemption(redemptionId) {
const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);
if (!redemption) {
alert('找不到兌換記錄！');
return;
}

try {
// 恢復優惠券狀態
redemption.vouchers.forEach(voucherRecord => {
const voucher = appState.vouchers.find(v => v.id === voucherRecord.id);
if (voucher) {
voucher.used = false;
}
});

// 從兌換歷史中移除記錄
const index = appState.redemptionHistory.findIndex(r => r.id === redemptionId);
if (index !== -1) {
appState.redemptionHistory.splice(index, 1);
}

// 保存狀態
saveAppState();

// 更新所有UI
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();

alert(`已成功撤回兌換記錄 #${redemption.displayId.toString().padStart(4, '0')}！\n${redemption.voucherCount}張優惠券已恢復為未使用狀態。`);
} catch (error) {
alert(`撤回失敗：${error.message || "未知錯誤"}`);
}
}

// 更新總體統計
function updateTotalStats() {
const totalCount = appState.vouchers.length;
const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
const usedCount = appState.vouchers.filter(v => v.used).length;
const totalRedeemable = appState.vouchers.filter(v => v.amount > 0).length;
const usageRate = totalRedeemable > 0 ? Math.round((usedCount / totalRedeemable) * 100) : 0;
const expiredCount = appState.vouchers.filter(v => !v.used && isVoucherExpired(v) && v.amount > 0).length;
const expiryRate = totalRedeemable > 0 ? Math.round((expiredCount / totalRedeemable) * 100) : 0;

document.getElementById('total-vouchers').textContent = `${totalCount}張`;
document.getElementById('total-value').textContent = `${totalValue}元`;
document.getElementById('usage-rate').textContent = `${usageRate}%`;
document.getElementById('expiry-rate').textContent = `${expiryRate}%`;
}

// 初始化統計切換功能
function initStatsToggle() {
// 面值分佈圖表切換
document.getElementById('value-chart-total-btn').addEventListener('click', function() {
document.getElementById('value-chart-total-btn').className = 'flex-1 py-1 px-2 text-center rounded bg-primary text-white text-xs';
document.getElementById('value-chart-bank-btn').className = 'flex-1 py-1 px-2 text-center rounded text-gray-600 dark:text-gray-300 text-xs';
updateValueChart('total');
});

document.getElementById('value-chart-bank-btn').addEventListener('click', function() {
document.getElementById('value-chart-bank-btn').className = 'flex-1 py-1 px-2 text-center rounded bg-primary text-white text-xs';
document.getElementById('value-chart-total-btn').className = 'flex-1 py-1 px-2 text-center rounded text-gray-600 dark:text-gray-300 text-xs';
updateValueChart('bank');
});
}

// 更新面值分佈圖表
function updateValueChart(mode = 'total') {
if (!valueChart) return;

if (mode === 'total') {
// 總體面值分佈
const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, 0: 0};

appState.vouchers.forEach(voucher => {
if (valueCounts.hasOwnProperty(voucher.amount)) {
valueCounts[voucher.amount]++;
}
});

// 重新配置為普通柱狀圖
valueChart.config.type = 'bar';
valueChart.data.labels = ['10元', '20元', '50元', '100元', '200元', '😄'];
valueChart.data.datasets = [{
label: '數量',
data: [
valueCounts[10], valueCounts[20], valueCounts[50],
valueCounts[100], valueCounts[200], valueCounts[0]
],
backgroundColor: ['#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc', '#fbbf24'],
borderRadius: 4,
borderSkipped: false
}];

// 更新圖表選項
valueChart.options = {
responsive: true,
maintainAspectRatio: false,
plugins: { 
legend: { display: false }
},
scales: { 
y: { 
beginAtZero: true, 
ticks: { precision: 0 },
stacked: false
},
x: { 
grid: { display: false },
stacked: false
}
}
};
} else {
// 按銀行分組的面值分佈
const bankValueData = {};
const amounts = [10, 20, 50, 100, 200, 0];

banks.forEach(bank => {
bankValueData[bank.id] = {};
amounts.forEach(amount => {
bankValueData[bank.id][amount] = 0;
});
});

appState.vouchers.forEach(voucher => {
if (bankValueData[voucher.bankId] && amounts.includes(voucher.amount)) {
bankValueData[voucher.bankId][voucher.amount]++;
}
});

// 創建堆疊柱狀圖數據
const datasets = [];
const bankColors = {
'boc': '#c1272d', 'icbc': '#c7000a', 'luso': '#00529b', 'bnu': '#5D5CDE',
'macaupass': '#0c6e4f', 'ant': '#2c64ae', 'mpay': '#1e469a', 'gdb': '#e83828'
};

banks.forEach(bank => {
const hasData = amounts.some(amount => bankValueData[bank.id][amount] > 0);
if (hasData) {
datasets.push({
label: bank.name,
data: amounts.map(amount => bankValueData[bank.id][amount]),
backgroundColor: bankColors[bank.id] || '#6b7280',
borderRadius: 2,
borderSkipped: false
});
}
});

// 重新配置為堆疊柱狀圖
valueChart.config.type = 'bar';
valueChart.data.labels = ['10元', '20元', '50元', '100元', '200元', '😄'];
valueChart.data.datasets = datasets;

// 更新圖表選項為堆疊模式
valueChart.options = {
responsive: true,
maintainAspectRatio: false,
plugins: { 
legend: { 
display: true,
position: 'bottom',
labels: { boxWidth: 12, font: { size: 10 }, padding: 8 }
}
},
scales: { 
y: { 
beginAtZero: true, 
ticks: { precision: 0 },
stacked: true
},
x: { 
grid: { display: false },
stacked: true
}
}
};
}

valueChart.update();
}

// 初始化圖表
function initCharts() {
Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';

// 狀態分佈圖表
const statusCtx = document.getElementById('status-chart').getContext('2d');
statusChart = new Chart(statusCtx, {
type: 'doughnut',
data: {
labels: ['未使用', '已兑換', '已過期'],
datasets: [{
data: [0, 0, 0],
backgroundColor: ['#86efac', '#60a5fa', '#f87171'],
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { 
position: 'bottom', 
labels: { boxWidth: 12, font: { size: 11 }, padding: 15 }
}
},
cutout: '60%'
}
});

// 面值分佈圖表
const valueCtx = document.getElementById('value-chart').getContext('2d');
valueChart = new Chart(valueCtx, {
type: 'bar',
data: {
labels: ['10元', '20元', '50元', '100元', '200元', '😄'],
datasets: [{
label: '數量',
data: [0, 0, 0, 0, 0, 0],
backgroundColor: ['#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc', '#fbbf24'],
borderRadius: 4,
borderSkipped: false
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { display: false } },
scales: { 
y: { beginAtZero: true, ticks: { precision: 0 } },
x: { grid: { display: false } }
}
}
});

// 銀行分佈圖表
const bankCtx = document.getElementById('bank-chart').getContext('2d');
bankChart = new Chart(bankCtx, {
type: 'pie',
data: {
labels: [],
datasets: [{
data: [],
backgroundColor: [
'#c1272d', '#c7000a', '#00529b', '#5D5CDE', 
'#0c6e4f', '#2c64ae', '#1e469a', '#e83828'
],
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { 
position: 'bottom',
labels: { boxWidth: 12, font: { size: 10 }, padding: 10 }
}
}
}
});

// 週次趨勢圖表
const weeklyCtx = document.getElementById('weekly-trend-chart').getContext('2d');
weeklyTrendChart = new Chart(weeklyCtx, {
type: 'line',
data: {
labels: [],
datasets: [{
label: '獲得金額 (元)',
data: [],
borderColor: '#60a5fa',
backgroundColor: 'rgba(96, 165, 250, 0.1)',
fill: true,
tension: 0.4
}, {
label: '兑換金額 (元)',
data: [],
borderColor: '#34d399',
backgroundColor: 'rgba(52, 211, 153, 0.1)',
fill: true,
tension: 0.4
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { 
position: 'top',
labels: { boxWidth: 12, font: { size: 11 } }
}
},
scales: {
y: { beginAtZero: true, ticks: { precision: 0 } },
x: { grid: { display: false } }
}
}
});

// 消費類別圖表
const categoryCtx = document.getElementById('category-chart').getContext('2d');
categoryChart = new Chart(categoryCtx, {
type: 'doughnut',
data: {
labels: consumptionCategories,
datasets: [{
data: [],
backgroundColor: [
'#ef4444', '#f97316', '#eab308', 
'#22c55e', '#06b6d4', '#8b5cf6'
],
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { 
position: 'bottom',
labels: { boxWidth: 12, font: { size: 11 }, padding: 15 }
}
},
cutout: '50%'
}
});

updateCharts();
}

// 更新圖表
function updateCharts() {
if (!statusChart || !valueChart || !bankChart || !weeklyTrendChart || !categoryChart) return;

// 計算優惠券狀態分佈 (排除笑臉)
const statusCounts = [0, 0, 0]; // 未使用, 已兑換, 已過期

appState.vouchers.forEach(voucher => {
if (voucher.amount > 0) {
if (voucher.used) {
statusCounts[1]++; // 已兑換
} else if (isVoucherExpired(voucher)) {
statusCounts[2]++; // 已過期
} else {
statusCounts[0]++; // 未使用
}
}
});

statusChart.data.datasets[0].data = statusCounts;
statusChart.update();

// 計算面值分佈
const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, 0: 0};

appState.vouchers.forEach(voucher => {
if (valueCounts.hasOwnProperty(voucher.amount)) {
valueCounts[voucher.amount]++;
}
});

valueChart.data.datasets[0].data = [
valueCounts[10], valueCounts[20], valueCounts[50],
valueCounts[100], valueCounts[200], valueCounts[0]
];
valueChart.update();

// 計算銀行分佈 (按金額)
const bankAmounts = {};
banks.forEach(bank => bankAmounts[bank.id] = 0);

appState.vouchers.forEach(voucher => {
if (bankAmounts.hasOwnProperty(voucher.bankId)) {
bankAmounts[voucher.bankId] += voucher.amount;
}
});

const bankLabels = [];
const bankData = [];
banks.forEach(bank => {
if (bankAmounts[bank.id] > 0) {
bankLabels.push(bank.name);
bankData.push(bankAmounts[bank.id]);
}
});

bankChart.data.labels = bankLabels;
bankChart.data.datasets[0].data = bankData;
bankChart.update();

// 計算週次趨勢
const weeklyData = { earned: [], redeemed: [] };
const weekLabels = [];

for (let week = 1; week <= 13; week++) {
weekLabels.push(`第${week}週`);

// 計算該週獲得的優惠券總金額
const earnedAmount = appState.vouchers.filter(v => 
getWeekNumberFromDate(v.date) === week
).reduce((sum, v) => sum + v.amount, 0);
weeklyData.earned.push(earnedAmount);

// 計算該週兑換的優惠券總金額
const redeemedAmount = appState.redemptionHistory.filter(r => 
r.weekNum === week
).reduce((sum, r) => sum + r.voucherValue, 0);
weeklyData.redeemed.push(redeemedAmount);
}

weeklyTrendChart.data.labels = weekLabels;
weeklyTrendChart.data.datasets[0].data = weeklyData.earned;
weeklyTrendChart.data.datasets[1].data = weeklyData.redeemed;
weeklyTrendChart.update();

// 計算消費類別分佈 (基於選擇的類別和備註關鍵字)
const categoryCounts = {};
consumptionCategories.forEach(cat => categoryCounts[cat] = 0);

appState.redemptionHistory.forEach(redemption => {
let finalCategory = '其他';

// 優先使用手動選擇的類別
if (redemption.category && consumptionCategories.includes(redemption.category)) {
finalCategory = redemption.category;
} else if (redemption.remark) {
// 回退到基於關鍵字的自動分類
const remark = redemption.remark.toLowerCase();

if (remark.includes('餐') || remark.includes('食') || remark.includes('飯') || remark.includes('茶') || remark.includes('咖啡') || remark.includes('酒')) {
finalCategory = '餐飲';
} else if (remark.includes('購') || remark.includes('買') || remark.includes('商店') || remark.includes('店') || remark.includes('衣') || remark.includes('鞋')) {
finalCategory = '購物';
} else if (remark.includes('車') || remark.includes('巴士') || remark.includes('的士') || remark.includes('交通') || remark.includes('油') || remark.includes('泊車')) {
finalCategory = '交通';
} else if (remark.includes('超市') || remark.includes('市場') || remark.includes('菜') || remark.includes('雜貨') || remark.includes('生活用品')) {
finalCategory = '超市';
} else if (remark.includes('娛樂') || remark.includes('電影') || remark.includes('遊戲') || remark.includes('玩') || remark.includes('運動') || remark.includes('健身')) {
finalCategory = '娛樂';
} else if (remark.includes('醫') || remark.includes('藥') || remark.includes('診所') || remark.includes('醫院') || remark.includes('健康')) {
finalCategory = '醫療';
} else if (remark.includes('學') || remark.includes('教') || remark.includes('書') || remark.includes('課程') || remark.includes('培訓')) {
finalCategory = '教育';
} else if (remark.includes('服務') || remark.includes('修理') || remark.includes('維修') || remark.includes('清潔') || remark.includes('美容')) {
finalCategory = '服務';
}
}

categoryCounts[finalCategory] += redemption.voucherCount;
});

const categoryData = consumptionCategories.map(cat => categoryCounts[cat]);
const hasData = categoryData.some(count => count > 0);

if (hasData) {
categoryChart.data.datasets[0].data = categoryData;
categoryChart.data.datasets[0].backgroundColor = [
'#ef4444', '#f97316', '#eab308', '#22c55e', 
'#06b6d4', '#8b5cf6', '#ec4899', '#64748b', '#6b7280'
];
} else {
// 如果沒有消費記錄，顯示空狀態
categoryChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0, 0, 1];
categoryChart.data.datasets[0].backgroundColor = [
'#ef4444', '#f97316', '#eab308', '#22c55e', 
'#06b6d4', '#8b5cf6', '#ec4899', '#64748b', '#d1d5db'
];
}
categoryChart.update();

// 更新類別詳細統計
updateCategoryDetails(categoryCounts, hasData);
}

// 更新類別詳細統計
function updateCategoryDetails(categoryCounts, hasData) {
const categoryDetails = document.getElementById('category-details');
if (!categoryDetails) return;

if (!hasData) {
categoryDetails.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 text-sm">尚未有消費記錄</div>';
return;
}

// 計算總消費金額和優惠券數量
let totalSpent = 0;
let totalVouchers = 0;

appState.redemptionHistory.forEach(redemption => {
totalSpent += redemption.spendAmount;
totalVouchers += redemption.voucherCount;
});

// 按使用次數排序類別
const sortedCategories = consumptionCategories
.map(cat => ({ name: cat, count: categoryCounts[cat] }))
.filter(cat => cat.count > 0)
.sort((a, b) => b.count - a.count);

let detailsHTML = `
<div class="grid grid-cols-2 gap-3 mb-3">
<div class="text-center">
<div class="text-xs text-gray-500 dark:text-gray-400">總消費</div>
<div class="font-bold text-lg">${totalSpent}元</div>
</div>
<div class="text-center">
<div class="text-xs text-gray-500 dark:text-gray-400">總節省</div>
<div class="font-bold text-lg text-green-600 dark:text-green-400">${appState.redemptionHistory.reduce((sum, r) => sum + r.voucherValue, 0)}元</div>
</div>
</div>
<div class="space-y-2">
`;

sortedCategories.forEach(category => {
const percentage = Math.round((category.count / totalVouchers) * 100);
const icon = categoryIcons[category.name] || '📦';

detailsHTML += `
<div class="flex items-center justify-between text-sm">
<div class="flex items-center">
<span class="mr-2">${icon}</span>
<span>${category.name}</span>
</div>
<div class="flex items-center space-x-2">
<span class="text-gray-500 dark:text-gray-400">${category.count}張</span>
<span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">${percentage}%</span>
</div>
</div>
`;
});

detailsHTML += '</div>';
categoryDetails.innerHTML = detailsHTML;
}

// 初始化選項卡功能
function initTabs() {
const tabButtons = document.querySelectorAll('#tabs button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
button.addEventListener('click', function() {
const tabName = this.getAttribute('data-tab');

tabButtons.forEach(btn => {
btn.classList.remove('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
});

this.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
this.classList.add('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');

tabContents.forEach(content => {
content.classList.add('hidden');
});

document.getElementById(`${tabName}-content`).classList.remove('hidden');

if (tabName === 'stats') {
updateCharts();
}
});
});
}

// 初始化銀行顯示過濾器
function initBankFilters() {
const bankFiltersContainer = document.getElementById('bank-filters');
if (!bankFiltersContainer) return;

bankFiltersContainer.innerHTML = '';

if (!appState.bankDisplayFilter) {
appState.bankDisplayFilter = banks.map(bank => bank.id);
}

banks.forEach(bank => {
const isSelected = appState.bankDisplayFilter.includes(bank.id);

const filterBtn = document.createElement('button');
filterBtn.className = `text-xs px-2 py-1 rounded-full flex items-center ${
isSelected ? 'bg-' + bank.color + ' text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
}`;
filterBtn.setAttribute('data-bank', bank.id);
filterBtn.innerHTML = `<i class="${bank.logo} mr-1"></i> ${bank.name}`;

filterBtn.addEventListener('click', function() {
const bankId = this.getAttribute('data-bank');
if (appState.bankDisplayFilter.includes(bankId)) {
appState.bankDisplayFilter = appState.bankDisplayFilter.filter(id => id !== bankId);
} else {
appState.bankDisplayFilter.push(bankId);
}
saveAppState();
initBankFilters();
});

bankFiltersContainer.appendChild(filterBtn);
});
}

// 更新管理模式的優惠券計數
function updateAdminVoucherCounts() {
const selectedWeek = parseInt(document.getElementById('admin-week-select').value);
const selectedBank = document.getElementById('admin-bank-select').value;

if (isNaN(selectedWeek) || !selectedBank) return;

const voucherCounts = { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0 };

appState.vouchers.forEach(voucher => {
if (voucher.bankId === selectedBank && getWeekNumberFromDate(voucher.date) === selectedWeek) {
voucherCounts[voucher.amount]++;
}
});

document.getElementById('admin-0-count').textContent = voucherCounts[0];
document.getElementById('admin-10-count').textContent = voucherCounts[10];
document.getElementById('admin-20-count').textContent = voucherCounts[20];
document.getElementById('admin-50-count').textContent = voucherCounts[50];
document.getElementById('admin-100-count').textContent = voucherCounts[100];
document.getElementById('admin-200-count').textContent = voucherCounts[200];
}

// 刪除特定銀行特定金額的優惠券 (給管理模式使用)
function deleteVoucherByBankAndAmount(bankId, amount, weekNum) {
const voucher = [...appState.vouchers]
.filter(v =>
v.bankId === bankId &&
v.amount === amount &&
getWeekNumberFromDate(v.date) === weekNum
).pop();

if (voucher) {
const index = appState.vouchers.indexOf(voucher);
if (index !== -1) {
appState.vouchers.splice(index, 1);
appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucher.id);
saveAppState();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();
updateAdminVoucherCounts();
return true;
}
}
return false;
}

// 優惠券計算算法
function calculateVouchersByRule(amount, rule) {
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

if (redeemableVouchers.length === 0) {
return { vouchers: [], error: '您目前沒有可用的優惠券' };
}

const maxValue = Math.floor(amount / 3);
let bestVouchers = [];

switch(rule) {
case 'max-value':
// 最大節省 - 背包問題動態規劃
bestVouchers = calculateMaxValue(redeemableVouchers, maxValue);
break;
case 'max-quantity':
// 最多優惠券 - 優先選擇小面值
bestVouchers = calculateMaxQuantity(redeemableVouchers, maxValue);
break;
case 'high-value':
// 優先高面值 - 從大到小選擇
bestVouchers = calculateHighValue(redeemableVouchers, maxValue);
break;
case 'same-bank':
// 同行優惠券 - 優先使用同一銀行的優惠券
bestVouchers = calculateSameBank(redeemableVouchers, maxValue);
break;
}

if (bestVouchers.length === 0) {
// 找最接近的單張優惠券
let closestVoucher = null;
let smallestDiff = Infinity;

for (const voucher of redeemableVouchers) {
const diff = voucher.amount * 3 - amount;
if (diff > 0 && diff < smallestDiff) {
smallestDiff = diff;
closestVoucher = voucher;
}
}

if (closestVoucher) {
return { 
vouchers: [], 
closest: closestVoucher,
shortfall: closestVoucher.amount * 3 - amount
};
} else {
return { vouchers: [], error: '消費金額不足以兑換任何優惠券' };
}
}

return { vouchers: bestVouchers };
}

// 最大節省算法
function calculateMaxValue(vouchers, maxValue) {
const dp = new Array(maxValue + 1).fill(0);
const selected = new Array(maxValue + 1).fill(null).map(() => []);

for (const voucher of vouchers) {
for (let j = maxValue; j >= voucher.amount; j--) {
const newValue = dp[j - voucher.amount] + voucher.amount;
if (newValue > dp[j]) {
dp[j] = newValue;
selected[j] = [...selected[j - voucher.amount], voucher];
}
}
}

return selected[maxValue] || [];
}

// 最多優惠券算法
function calculateMaxQuantity(vouchers, maxValue) {
// 按面值從小到大排序
const sortedVouchers = [...vouchers].sort((a, b) => a.amount - b.amount);
const result = [];
let remaining = maxValue;

for (const voucher of sortedVouchers) {
if (voucher.amount <= remaining) {
result.push(voucher);
remaining -= voucher.amount;
}
}

return result;
}

// 優先高面值算法
function calculateHighValue(vouchers, maxValue) {
// 按面值從大到小排序
const sortedVouchers = [...vouchers].sort((a, b) => b.amount - a.amount);
const result = [];
let remaining = maxValue;

for (const voucher of sortedVouchers) {
if (voucher.amount <= remaining) {
result.push(voucher);
remaining -= voucher.amount;
}
}

return result;
}

// 同行優惠券算法
function calculateSameBank(vouchers, maxValue) {
// 按銀行分組
const vouchersByBank = {};
vouchers.forEach(voucher => {
if (!vouchersByBank[voucher.bankId]) {
vouchersByBank[voucher.bankId] = [];
}
vouchersByBank[voucher.bankId].push(voucher);
});

let bestResult = [];
let bestValue = 0;
let bestBankName = '';

// 嘗試每個銀行
Object.entries(vouchersByBank).forEach(([bankId, bankVouchers]) => {
// 對當前銀行的優惠券使用最大節省算法
const bankResult = calculateMaxValue(bankVouchers, maxValue);
const bankValue = bankResult.reduce((sum, v) => sum + v.amount, 0);

// 如果這個銀行的結果更好，則替換
if (bankValue > bestValue || (bankValue === bestValue && bankResult.length > bestResult.length)) {
bestResult = bankResult;
bestValue = bankValue;
bestBankName = getBankName(bankId);
}
});

// 如果單一銀行無法滿足，則用混合策略但優先已選銀行
if (bestResult.length === 0 || bestValue < maxValue * 0.7) {
// 找出優惠券最多的銀行作為主銀行
let mainBankId = '';
let maxBankVouchers = 0;
Object.entries(vouchersByBank).forEach(([bankId, bankVouchers]) => {
const bankValue = bankVouchers.reduce((sum, v) => sum + v.amount, 0);
if (bankValue > maxBankVouchers) {
maxBankVouchers = bankValue;
mainBankId = bankId;
}
});

// 優先使用主銀行，然後補充其他銀行
const result = [];
let remaining = maxValue;

// 先從主銀行選取
if (mainBankId && vouchersByBank[mainBankId]) {
const mainBankResult = calculateMaxValue(vouchersByBank[mainBankId], remaining);
result.push(...mainBankResult);
remaining -= mainBankResult.reduce((sum, v) => sum + v.amount, 0);
}

// 如果還有剩餘空間，從其他銀行補充
if (remaining > 0) {
const otherVouchers = [];
Object.entries(vouchersByBank).forEach(([bankId, bankVouchers]) => {
if (bankId !== mainBankId) {
otherVouchers.push(...bankVouchers);
}
});

if (otherVouchers.length > 0) {
const supplementResult = calculateMaxValue(otherVouchers, remaining);
result.push(...supplementResult);
}
}

return result;
}

return bestResult;
}

// 初始化優惠券計算器
function initVoucherCalculator() {
// 最大節省按鈕
document.getElementById('calculate-max-value').addEventListener('click', function() {
const amount = parseInt(document.getElementById('payment-amount').value);
if (isNaN(amount) || amount <= 0) {
alert('請輸入有效的消費金額！');
return;
}

// 獲取未使用的優惠券（排除笑臉0元優惠券）
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

if (redeemableVouchers.length === 0) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-red-500 dark:text-red-400">無法找到合適的優惠券組合</div>
<div class="text-sm text-gray-500 dark:text-gray-400">您目前沒有可用的優惠券</div>
</div>
`;
document.getElementById('recommendation-result').classList.remove('hidden');
return;
}

// 使用背包問題解決優惠券選擇問題
const maxValue = Math.floor(amount / 3);
const sortedVouchers = [...redeemableVouchers].sort((a, b) => a.amount - b.amount);

// 動態規劃求解
const dp = new Array(maxValue + 1).fill(0);
const selected = new Array(maxValue + 1).fill(null).map(() => []);

for (const voucher of sortedVouchers) {
for (let j = maxValue; j >= voucher.amount; j--) {
const newValue = dp[j - voucher.amount] + voucher.amount;
if (newValue > dp[j]) {
dp[j] = newValue;
selected[j] = [...selected[j - voucher.amount], voucher];
}
}
}

const bestVouchers = selected[maxValue];

if (bestVouchers.length === 0) {
// 找不到完全匹配的組合，看是否需要多消費
let closestVoucher = null;
let smallestDiff = Infinity;

for (const voucher of redeemableVouchers) {
const diff = voucher.amount * 3 - amount;
if (diff > 0 && diff < smallestDiff) {
smallestDiff = diff;
closestVoucher = voucher;
}
}

if (closestVoucher) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-yellow-500 dark:text-yellow-400">消費金額不足</div>
<div class="text-sm mb-3">
最接近的優惠券為${closestVoucher.amount}元，需消費${closestVoucher.amount * 3}元
</div>
<div class="text-sm">您還需增加${closestVoucher.amount * 3 - amount}元消費金額</div>
<button id="use-closest-voucher" class="mt-3 w-full py-2 bg-primary text-white rounded-lg">
選擇使用${closestVoucher.amount}元優惠券
</button>
</div>
`;

document.getElementById('use-closest-voucher').onclick = function() {
appState.selectedVouchers = [closestVoucher.id];
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();
document.querySelector('[data-tab="redeem"]').click();
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
document.getElementById('manual-spend-amount').value = closestVoucher.amount * 3;
};
} else {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-red-500 dark:text-red-400">無法找到合適的優惠券組合</div>
<div class="text-sm text-gray-500 dark:text-gray-400">消費金額不足以兑換任何優惠券</div>
</div>
`;
}
} else {
// 計算總值和所需消費金額
const totalValue = bestVouchers.reduce((sum, v) => sum + v.amount, 0);
const requiredAmount = totalValue * 3;

// 按銀行分組
const bankVouchers = {};
bestVouchers.forEach(voucher => {
if (!bankVouchers[voucher.bankId]) {
bankVouchers[voucher.bankId] = [];
}
bankVouchers[voucher.bankId].push(voucher);
});

// 生成銀行列表
let bankHTML = '';
Object.entries(bankVouchers).forEach(([bankId, vouchers]) => {
const bank = banks.find(b => b.id === bankId);
if (!bank) return;

// 按面值分組
const amountCounts = {};
vouchers.forEach(v => {
if (!amountCounts[v.amount]) amountCounts[v.amount] = 0;
amountCounts[v.amount]++;
});

const bankTotal = vouchers.reduce((sum, v) => sum + v.amount, 0);

bankHTML += `
<div class="mb-2 border rounded p-2">
<div class="flex items-center justify-between">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-medium">${bank.name}</span>
</div>
<div>${vouchers.length}張 (${bankTotal}元)</div>
</div>
<div class="ml-4 text-xs text-gray-500 dark:text-gray-400 mt-1">
${Object.entries(amountCounts).map(([amt, count]) => `${amt}元: ${count}張`).join(', ')}
</div>
</div>
`;
});

document.getElementById('recommendation-result').innerHTML = `
<div>
<div class="text-green-500 dark:text-green-400 font-bold mb-2">找到最佳組合</div>
<div class="text-sm mb-3">
<div>消費金額: ${amount}元</div>
<div>節省金額: ${totalValue}元</div>
<div>自費金額: ${amount - totalValue}元</div>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">所需消費: ${requiredAmount}元</div>
<div class="mt-1">使用優惠券: ${bestVouchers.length}張</div>
</div>
<div class="mt-3 pt-2 border-t">
<div class="font-medium mb-1">優惠券明細:</div>
${bankHTML}
</div>
<div class="mt-3 pt-3 border-t">
<button id="select-recommended-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white py-2 rounded-lg">
選擇這些優惠券
</button>
</div>
</div>
`;

// 添加選擇按鈕事件
document.getElementById('select-recommended-vouchers').onclick = function() {
// 將推薦的優惠券添加到已選擇列表
appState.selectedVouchers = bestVouchers.map(v => v.id);

// 更新UI
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();

// 設置消費金額
document.getElementById('manual-spend-amount').value = amount;

// 切換到兑換選項卡
document.querySelector('[data-tab="redeem"]').click();

// 隱藏結果
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
};
}

document.getElementById('recommendation-result').classList.remove('hidden');
});

// 其他計算按鈕事件
['max-quantity', 'high-value', 'same-bank'].forEach(rule => {
document.getElementById(`calculate-${rule}`).addEventListener('click', function() {
calculateAndShowResult(rule);
});
});

// Enter鍵觸發最大節省計算
document.getElementById('payment-amount').addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
document.getElementById('calculate-max-value').click();
}
});
}

// 通用計算函數
function calculateAndShowResult(rule) {
const amount = parseInt(document.getElementById('payment-amount').value);
if (isNaN(amount) || amount <= 0) {
alert('請輸入有效的消費金額！');
return;
}

const result = calculateVouchersByRule(amount, rule);

if (result.error) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-red-500 dark:text-red-400">${result.error}</div>
</div>
`;
} else if (result.closest) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-yellow-500 dark:text-yellow-400">消費金額不足</div>
<div class="text-sm mb-3">
最接近的優惠券為${result.closest.amount}元，需消費${result.closest.amount * 3}元
</div>
<div class="text-sm">您還需增加${result.shortfall}元消費金額</div>
<button id="use-closest-voucher" class="mt-3 w-full py-2 bg-primary text-white rounded-lg">
選擇使用${result.closest.amount}元優惠券
</button>
</div>
`;

document.getElementById('use-closest-voucher').onclick = function() {
appState.selectedVouchers = [result.closest.id];
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();
document.querySelector('[data-tab="redeem"]').click();
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
document.getElementById('manual-spend-amount').value = result.closest.amount * 3;
};
} else if (result.vouchers.length > 0) {
const bestVouchers = result.vouchers;
const totalValue = bestVouchers.reduce((sum, v) => sum + v.amount, 0);
const requiredAmount = totalValue * 3;

// 按銀行分組
const bankVouchers = {};
bestVouchers.forEach(voucher => {
if (!bankVouchers[voucher.bankId]) {
bankVouchers[voucher.bankId] = [];
}
bankVouchers[voucher.bankId].push(voucher);
});

// 生成銀行列表
let bankHTML = '';
Object.entries(bankVouchers).forEach(([bankId, vouchers]) => {
const bank = banks.find(b => b.id === bankId);
if (!bank) return;

// 按面值分組
const amountCounts = {};
vouchers.forEach(v => {
if (!amountCounts[v.amount]) amountCounts[v.amount] = 0;
amountCounts[v.amount]++;
});

const bankTotal = vouchers.reduce((sum, v) => sum + v.amount, 0);

bankHTML += `
<div class="mb-2 border rounded p-2">
<div class="flex items-center justify-between">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-medium">${bank.name}</span>
</div>
<div>${vouchers.length}張 (${bankTotal}元)</div>
</div>
<div class="ml-4 text-xs text-gray-500 dark:text-gray-400 mt-1">
${Object.entries(amountCounts).map(([amt, count]) => `${amt}元: ${count}張`).join(', ')}
</div>
</div>
`;
});

// 根據規則設置標題和描述
const ruleInfo = {
'max-value': { title: '最大節省組合', color: 'primary' },
'max-quantity': { title: '最多優惠券組合', color: 'green-500' },
'high-value': { title: '優先高面值組合', color: 'purple-500' },
'same-bank': { title: '同行優惠券組合', color: 'orange-500' }
};

const info = ruleInfo[rule];

document.getElementById('recommendation-result').innerHTML = `
<div>
<div class="text-${info.color} dark:text-${info.color} font-bold mb-2">${info.title}</div>
<div class="text-sm mb-3">
<div>消費金額: ${amount}元</div>
<div>節省金額: ${totalValue}元</div>
<div>自費金額: ${amount - totalValue}元</div>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">所需消費: ${requiredAmount}元</div>
<div class="mt-1">使用優惠券: ${bestVouchers.length}張</div>
</div>
<div class="mt-3 pt-2 border-t">
<div class="font-medium mb-1">優惠券明細:</div>
${bankHTML}
</div>
<div class="mt-3 pt-3 border-t">
<button id="select-recommended-vouchers" class="w-full bg-${info.color} hover:bg-${info.color.replace('500', '600')} text-white py-2 rounded-lg">
選擇這些優惠券
</button>
</div>
</div>
`;

// 添加選擇按鈕事件
document.getElementById('select-recommended-vouchers').onclick = function() {
// 將推薦的優惠券添加到已選擇列表
appState.selectedVouchers = bestVouchers.map(v => v.id);

// 更新UI
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();

// 設置消費金額
document.getElementById('manual-spend-amount').value = amount;

// 切換到兑換選項卡
document.querySelector('[data-tab="redeem"]').click();

// 隱藏結果
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
};
}

document.getElementById('recommendation-result').classList.remove('hidden');
}

// 初始化管理模式和銀行設定
function initAdminAndSettings() {
// 銀行顯示設定按鈕
document.getElementById('bank-display-settings-btn').addEventListener('click', function() {
initBankFilters();
document.getElementById('bank-display-settings-modal').classList.remove('hidden');
});

document.getElementById('close-bank-display-settings').addEventListener('click', function() {
document.getElementById('bank-display-settings-modal').classList.add('hidden');
});

document.getElementById('select-all-display-banks').addEventListener('click', function() {
appState.bankDisplayFilter = banks.map(bank => bank.id);
saveAppState();
initBankFilters();
});

document.getElementById('clear-display-banks').addEventListener('click', function() {
appState.bankDisplayFilter = [];
saveAppState();
initBankFilters();
});

document.getElementById('save-bank-display-settings').addEventListener('click', function() {
document.getElementById('bank-display-settings-modal').classList.add('hidden');
updateBankButtons();
updateBankOverview();
});

// 管理模式按鈕
document.getElementById('admin-mode-btn').addEventListener('click', function() {
// 填充週次選擇器
const weekSelect = document.getElementById('admin-week-select');
weekSelect.innerHTML = '<option value="">-- 選擇週次 --</option>';
weekSchedule.forEach(week => {
const option = document.createElement('option');
option.value = week.week;
option.textContent = `第${week.week}週 (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
weekSelect.appendChild(option);
});

// 填充銀行選擇器
const bankSelect = document.getElementById('admin-bank-select');
bankSelect.innerHTML = '<option value="">-- 選擇銀行 --</option>';
banks.forEach(bank => {
const option = document.createElement('option');
option.value = bank.id;
option.textContent = bank.name;
bankSelect.appendChild(option);
});

// 重置計數
document.getElementById('admin-0-count').textContent = '0';
document.getElementById('admin-10-count').textContent = '0';
document.getElementById('admin-20-count').textContent = '0';
document.getElementById('admin-50-count').textContent = '0';
document.getElementById('admin-100-count').textContent = '0';
document.getElementById('admin-200-count').textContent = '0';

document.getElementById('admin-mode-modal').classList.remove('hidden');
});

document.getElementById('close-admin-mode').addEventListener('click', function() {
document.getElementById('admin-mode-modal').classList.add('hidden');
});

document.getElementById('close-admin-btn').addEventListener('click', function() {
document.getElementById('admin-mode-modal').classList.add('hidden');
});

// 管理模式選擇變更事件
document.getElementById('admin-week-select').addEventListener('change', updateAdminVoucherCounts);
document.getElementById('admin-bank-select').addEventListener('change', updateAdminVoucherCounts);

// 管理模式添加優惠券
document.getElementById('admin-add-btn').addEventListener('click', function() {
const weekNum = parseInt(document.getElementById('admin-week-select').value);
const bankId = document.getElementById('admin-bank-select').value;
const amount = parseInt(document.getElementById('admin-amount-select').value);

if (isNaN(weekNum) || !bankId || isNaN(amount)) {
alert('請先選擇週次、銀行和面值！');
return;
}

const weekData = weekSchedule[weekNum - 1];
if (!weekData) {
alert('無效的週次！');
return;
}

const date = weekData.startDate;
const newVoucher = {
id: Date.now().toString(),
amount: amount,
date: date,
used: false,
bankId: bankId
};

appState.vouchers.push(newVoucher);
saveAppState();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();
updateAdminVoucherCounts();

alert(`成功添加 ${amount}${amount === 0 ? '元(😄)' : '元'} 優惠券至 ${getBankName(bankId)} 的第${weekNum}週記錄`);
});

// 管理模式刪除優惠券
document.getElementById('admin-remove-btn').addEventListener('click', function() {
const weekNum = parseInt(document.getElementById('admin-week-select').value);
const bankId = document.getElementById('admin-bank-select').value;
const amount = parseInt(document.getElementById('admin-amount-select').value);

if (isNaN(weekNum) || !bankId || isNaN(amount)) {
alert('請先選擇週次、銀行和面值！');
return;
}

if (deleteVoucherByBankAndAmount(bankId, amount, weekNum)) {
alert(`成功刪除 ${getBankName(bankId)} 的第${weekNum}週 ${amount}${amount === 0 ? '元(😄)' : '元'} 優惠券`);
} else {
alert(`找不到 ${getBankName(bankId)} 的第${weekNum}週 ${amount}${amount === 0 ? '元(😄)' : '元'} 優惠券`);
}
});
}

// 初始化消費類別按鈕組
function initCategoryButtons() {
const categoryButtons = document.querySelectorAll('.category-btn');
let selectedCategory = '';

categoryButtons.forEach(button => {
button.addEventListener('click', function() {
const category = this.getAttribute('data-category');

// 如果點擊相同的按鈕，則取消選擇
if (selectedCategory === category) {
this.classList.remove('bg-primary', 'text-white');
this.classList.add('border', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
selectedCategory = '';
} else {
// 清除所有按鈕的選中狀態
categoryButtons.forEach(btn => {
btn.classList.remove('bg-primary', 'text-white');
btn.classList.add('border', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
});

// 設置當前按鈕為選中狀態
this.classList.add('bg-primary', 'text-white');
this.classList.remove('border', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
selectedCategory = category;
}

// 存儲選中的類別到隱藏輸入(模擬原來的select)
document.getElementById('consumption-category').value = selectedCategory;
});
});

// 創建隱藏的輸入元素來存儲選中的值
if (!document.getElementById('consumption-category')) {
const hiddenInput = document.createElement('input');
hiddenInput.type = 'hidden';
hiddenInput.id = 'consumption-category';
hiddenInput.value = '';
document.getElementById('consumption-category-buttons').parentNode.appendChild(hiddenInput);
}
}

// 清除消費類別選擇
function clearCategorySelection() {
const categoryButtons = document.querySelectorAll('.category-btn');
categoryButtons.forEach(btn => {
btn.classList.remove('bg-primary', 'text-white');
btn.classList.add('border', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
});
document.getElementById('consumption-category').value = '';
}

// 應用程序啟動
document.addEventListener('DOMContentLoaded', function() {
initTabs();
initCharts();
initStatsToggle();
initAdminAndSettings();
initVoucherCalculator();
initCategoryButtons();

loadAppState();
updateDateDisplay();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateRedemptionHistory();
updateCharts();
});
</script>
</body>
</html>
