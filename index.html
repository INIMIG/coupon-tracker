<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨é‹èšåŠ›â€§ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
colors: {
primary: '#5D5CDE', 'primary-dark': '#4B4AB2',
'boc': '#c1272d', 'boc-dark': '#a01e21',
'icbc': '#c7000a', 'icbc-dark': '#a00008',
'macaupass': '#0c6e4f', 'macaupass-dark': '#095338',
'luso': '#00529b', 'luso-dark': '#003e75',
'ant': '#2c64ae', 'ant-dark': '#1a4d8a',
'mpay': '#1e469a', 'mpay-dark': '#173777',
'gdb': '#e83828', 'gdb-dark': '#b82116'
}
}
}
}
</script>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
<div class="max-w-md mx-auto p-4">
<!-- æ¨™é¡Œå’Œè¨ˆæ•¸å™¨ -->
<div class="text-center mb-4">
<h1 class="text-2xl font-bold text-primary dark:text-primary mb-2">å…¨é‹èšåŠ›â€§ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨</h1>
<div class="text-sm bg-blue-50 dark:bg-blue-900 p-2 rounded-lg">
<div>ä»Šå¤©ï¼š<span id="current-date">è¼‰å…¥ä¸­...</span> | <span id="current-week">è¼‰å…¥ä¸­...</span></div>
</div>
</div>

<!-- ä¸»è¦åŠŸèƒ½é¸é …å¡ -->
<div class="mb-4 border-b border-gray-200 dark:border-gray-700">
<ul class="flex flex-wrap" id="tabs">
<li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-primary dark:text-primary border-b-2 border-primary dark:border-primary tab-active" data-tab="earn">è³ºå–</button></li>
<li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="redeem">å…‘æ›</button></li>
<li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="history">å·²å…‘æ›</button></li>
<li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="stats">çµ±è¨ˆ</button></li>
<li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="charts">åœ–è¡¨</button></li>
<li class="w-1/3 text-center"><button class="w-full py-2 px-1 text-gray-500 dark:text-gray-400 border-b-2 border-transparent" data-tab="info">è³‡è¨Š</button></li>
</ul>
</div>

<!-- è³ºå–å„ªæƒ åˆ¸é¢æ¿ -->
<div class="tab-content" id="earn-content">
<!-- éŠ€è¡Œé¸æ“‡æŒ‰éˆ•çµ„ -->
<div class="mb-4">
<div class="flex justify-between items-center mb-2">
<div class="text-sm font-medium">é¸æ“‡æ”¯ä»˜å·¥å…· (é»æ“ŠéŠ€è¡Œæ·»åŠ å„ªæƒ åˆ¸)</div>
<div class="flex gap-2">
<button id="admin-mode-btn" class="text-xs px-2 py-1 flex items-center bg-yellow-500 text-white rounded hover:bg-yellow-600">
<i class="ri-settings-5-line mr-1"></i> ç®¡ç†
</button>
<button id="bank-display-settings-btn" class="text-xs px-2 py-1 flex items-center bg-primary text-white rounded hover:bg-primary-dark">
<i class="ri-settings-3-line mr-1"></i> è¨­å®š
</button>
</div>
</div>

<div class="grid grid-cols-4 gap-2 mb-4" id="bank-buttons"></div>

<!-- éŠ€è¡Œé¡¯ç¤ºè¨­ç½®æ¨¡æ…‹æ¡† -->
<div id="bank-display-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-full max-w-sm mx-4">
<div class="flex justify-between items-center mb-3">
<h3 class="text-lg font-bold">æ”¯ä»˜å·¥å…·é¡¯ç¤ºè¨­å®š</h3>
<button id="close-bank-display-settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div class="mb-3">
<div class="text-sm mb-2">é¸æ“‡è¦åœ¨ä¸»ç•Œé¢é¡¯ç¤ºçš„æ”¯ä»˜å·¥å…·:</div>
<div class="flex flex-wrap gap-2 mb-3" id="bank-filters"></div>

<div class="flex space-x-2 mb-2">
<button id="select-all-display-banks" class="flex-1 bg-primary text-white py-1 px-3 rounded-lg text-sm">å…¨é¸</button>
<button id="clear-display-banks" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-1 px-3 rounded-lg text-sm">æ¸…ç©º</button>
</div>
</div>

<div class="flex justify-end">
<button id="save-bank-display-settings" class="bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark">
ç¢ºå®š
</button>
</div>
</div>
</div>

<!-- ç®¡ç†æ¨¡å¼æ¨¡æ…‹æ¡† -->
<div id="admin-mode-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-3">
<h3 class="text-lg font-bold">ç®¡ç†æ¨¡å¼</h3>
<button id="close-admin-mode" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div class="mb-3">
<div class="text-sm mb-2 text-yellow-600 dark:text-yellow-400">âš ï¸ ç®¡ç†æ¨¡å¼ç”¨æ–¼æ•¸æ“šä¿®å¾©ï¼Œè«‹è¬¹æ…æ“ä½œ</div>
<div class="border-t border-b dark:border-gray-700 py-3">
<div class="mb-2">
<label class="block text-sm font-medium mb-1">é€±æ¬¡é¸æ“‡</label>
<select id="admin-week-select" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
<!-- Week options will be added by JS -->
</select>
</div>
<div class="mb-2">
<label class="block text-sm font-medium mb-1">æ”¯ä»˜å·¥å…·</label>
<select id="admin-bank-select" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
<!-- Bank options will be added by JS -->
</select>
</div>
<div class="mb-2">
<label class="block text-sm font-medium mb-1">å„ªæƒ åˆ¸è³‡æ–™</label>
<div class="grid grid-cols-2 gap-2">
<div class="space-y-1 text-sm">
<div>10å…ƒ: <span id="admin-10-count">0</span>å¼µ</div>
<div>20å…ƒ: <span id="admin-20-count">0</span>å¼µ</div>
<div>50å…ƒ: <span id="admin-50-count">0</span>å¼µ</div>
</div>
<div class="space-y-1 text-sm">
<div>100å…ƒ: <span id="admin-100-count">0</span>å¼µ</div>
<div>200å…ƒ: <span id="admin-200-count">0</span>å¼µ</div>
<div>ğŸ˜„: <span id="admin-0-count">0</span>å¼µ</div>
</div>
</div>
</div>
<div class="mt-4 space-y-2">
<div class="flex space-x-2">
<select id="admin-amount-select" class="p-2 border rounded flex-grow dark:bg-gray-700 dark:border-gray-600">
<option value="10">10å…ƒ</option>
<option value="20">20å…ƒ</option>
<option value="50">50å…ƒ</option>
<option value="100">100å…ƒ</option>
<option value="200">200å…ƒ</option>
<option value="0">ğŸ˜„</option>
</select>
<button id="admin-add-btn" class="bg-green-500 text-white px-4 py-2 rounded">æ·»åŠ </button>
<button id="admin-remove-btn" class="bg-red-500 text-white px-4 py-2 rounded">åˆªé™¤</button>
</div>
<div class="mt-3 pt-3 border-t dark:border-gray-700">
<h4 class="text-sm font-medium mb-2">ç®¡ç†å…‘æ›æ“ä½œ</h4>
<div id="admin-redeemable-vouchers" class="mb-3 border rounded-lg p-2 max-h-40 overflow-y-auto">
<div class="text-xs text-gray-500">é¸æ“‡ç‰¹å®šå„ªæƒ åˆ¸é€²è¡Œå…‘æ›ï¼š</div>
<!-- Redeemable vouchers will be listed here -->
</div>
<div class="flex space-x-2">
<button id="admin-redeem-btn" class="bg-blue-500 text-white px-4 py-2 rounded w-full">æ¨™è¨˜é¸å®šå„ªæƒ åˆ¸ç‚ºå·²å…‘æ›</button>
</div>
<div class="mt-2 text-xs text-yellow-500">
æ³¨æ„ï¼šæ­¤æ“ä½œæœƒå°‡é¸å®šçš„å„ªæƒ åˆ¸æ¨™è¨˜ç‚ºå·²å…‘æ›ï¼Œä½†ä¸æœƒå‰µå»ºå…‘æ›è¨˜éŒ„ã€‚
</div>
</div>
</div>
</div>
</div>

<div class="flex justify-end space-x-2">
<button id="close-admin-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
é—œé–‰
</button>
</div>
</div>
</div>
</div>

<!-- å¿«é€Ÿæ·»åŠ å„ªæƒ åˆ¸ (ç•¶é¸ä¸­éŠ€è¡Œæ™‚é¡¯ç¤º) -->
<div id="quick-add-container" class="mb-4 hidden">
<div class="flex justify-between items-center mb-2">
<div class="text-sm font-medium"><span id="selected-bank-name-display">éŠ€è¡Œ</span>å„ªæƒ åˆ¸ (ç¸½è¨ˆ: <span id="total-draws">0</span>/3æ¬¡)</div>
</div>
<div class="grid grid-cols-3 gap-2 mb-2">
<button data-amount="10" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">10å…ƒ</button>
<button data-amount="20" class="quick-add py-2 px-1 bg-blue-100 dark:bg-blue-900 rounded-lg text-center hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">20å…ƒ</button>
<button data-amount="50" class="quick-add py-2 px-1 bg-green-100 dark:bg-green-900 rounded-lg text-center hover:bg-green-200 dark:hover:bg-green-800 transition-colors">50å…ƒ</button>
<button data-amount="100" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">100å…ƒ</button>
<button data-amount="200" class="quick-add py-2 px-1 bg-purple-100 dark:bg-purple-900 rounded-lg text-center hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors">200å…ƒ</button>
<button data-amount="0" class="quick-add py-2 px-1 bg-yellow-100 dark:bg-yellow-900 rounded-lg text-center hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors">ğŸ˜„</button>
</div>
</div>

<!-- éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½ -->
<div class="mb-4">
<h3 class="text-sm font-bold mb-2">å„éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½ (æœ¬é€±)</h3>
<div id="bank-overview-list" class="space-y-3"></div>
</div>

<!-- æ•¸æ“šç®¡ç†æŒ‰éˆ• -->
<div class="mt-6 grid grid-cols-2 gap-2">
<button id="export-data-btn" class="bg-primary hover:bg-primary-dark text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
<i class="ri-download-line mr-1"></i> åŒ¯å‡ºæ•¸æ“š
</button>
<button id="data-management-btn" class="bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
<i class="ri-database-2-line mr-1"></i> å‚™ä»½/æ¢å¾©
</button>
</div>

<!-- å­˜å„²ä½¿ç”¨é‡é¡¯ç¤º -->
<div class="mt-4 p-3 border rounded-lg bg-gray-50 dark:bg-gray-800 text-sm">
<div class="font-medium mb-2 flex justify-between items-center">
<span>æœ¬åœ°å­˜å„²ä½¿ç”¨é‡</span>
<span id="storage-size" class="px-2 py-1 bg-blue-100 dark:bg-blue-900 rounded text-xs">è¨ˆç®—ä¸­...</span>
</div>
<div class="relative pt-1">
<div class="flex mb-1 items-center justify-between">
<div class="text-xs text-gray-500">å·²ä½¿ç”¨</div>
<div class="text-xs text-right"><span id="storage-percentage">0</span>%</div>
</div>
<div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200 dark:bg-gray-700">
<div id="storage-bar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary" style="width: 0%"></div>
</div>
</div>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
ç€è¦½å™¨å­˜å„²é™åˆ¶ï¼šç´„ 5 MB (ç§»å‹•è¨­å‚™å¯èƒ½æ›´å°‘)
</div>
</div>
</div>

<!-- å…‘æ›å„ªæƒ åˆ¸é¢æ¿ -->
<div class="tab-content hidden" id="redeem-content">
<!-- å„ªæƒ åˆ¸è¨ˆç®—å™¨ -->
<div class="mb-4 bg-green-50 dark:bg-green-900/20 rounded-lg p-3 shadow">
<div class="flex items-center justify-between mb-2">
<div>
<div class="text-sm font-medium">å„ªæƒ åˆ¸è¨ˆç®—å™¨</div>
<div class="text-xs text-gray-500 dark:text-gray-400">è¼¸å…¥é‡‘é¡è¨ˆç®—æœ€ä½³çµ„åˆ</div>
</div>
</div>

<div class="flex space-x-2">
<input type="number" id="payment-amount" min="1" placeholder="è¼¸å…¥æ¶ˆè²»é‡‘é¡" class="flex-1 p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600">
<button id="calculate-recommendation" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
è¨ˆç®—
</button>
</div>

<!-- è¨ˆç®—çµæœå€åŸŸ -->
<div id="recommendation-result" class="mt-3 border rounded-lg p-3 bg-white dark:bg-gray-800 hidden"></div>
</div>

<!-- å¯ç”¨å„ªæƒ åˆ¸ç¸½è¦½ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
<div class="flex justify-between items-center mb-2">
<h3 class="text-sm font-bold">å¯ç”¨å„ªæƒ åˆ¸ç¸½è¦½</h3>
<div class="text-sm text-gray-500 dark:text-gray-400">
æœªä½¿ç”¨: <span id="unused-vouchers-count" class="font-bold text-green-600 dark:text-green-400">0</span>å¼µ
</div>
</div>
<div id="redeemable-vouchers-list" class="space-y-2"></div>
</div>

<!-- å®Œå…¨åˆä½µå¾Œçš„å„ªæƒ åˆ¸é¸æ“‡å’Œå…‘æ›å€åŸŸ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3 shadow">
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-bold">é¸æ“‡ä¸¦å…‘æ›å„ªæƒ åˆ¸</h3>
<div id="selection-summary" class="text-sm">
å·²é¸: <span id="selected-vouchers-count">0</span>å¼µ (<span id="selected-vouchers-value">0</span>å…ƒ)
</div>
</div>

<!-- å„ªæƒ åˆ¸é¸æ“‡å€åŸŸ -->
<div id="redeem-voucher-selection" class="space-y-3 mb-4"></div>

<!-- å…‘æ›æ“ä½œå€åŸŸ - åªåœ¨æœ‰é¸æ“‡å„ªæƒ åˆ¸æ™‚é¡¯ç¤º -->
<div id="redeem-operations" class="mt-3 hidden">
<div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
æ¶ˆè²»é‡‘é¡å¿…é ˆç‚ºå„ªæƒ åˆ¸ç¸½é¡çš„3å€æˆ–ä»¥ä¸Šæ‰èƒ½å…‘æ›
</div>
<div class="grid grid-cols-1 gap-2">
<div id="redeem-amount-info" class="text-sm text-gray-700 dark:text-gray-300 py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
æœ€ä½éœ€æ¶ˆè²»é‡‘é¡: <span id="min-redeem-amount">0</span>å…ƒ
</div>
<div>
<input type="number" id="manual-spend-amount" placeholder="å¯¦éš›æ¶ˆè²»é‡‘é¡" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600 mb-2">

<div class="mb-2">
<div class="text-sm font-medium mb-2">æ¶ˆè²»é¡åˆ¥ (å¯å¤šé¸):</div>
<div class="grid grid-cols-4 gap-2">
<label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
<input type="checkbox" name="expense-category" value="food" class="expense-category">
<span class="text-sm">é£Ÿå“</span>
</label>
<label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
<input type="checkbox" name="expense-category" value="clothing" class="expense-category">
<span class="text-sm">æœé£¾</span>
</label>
<label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
<input type="checkbox" name="expense-category" value="entertainment" class="expense-category">
<span class="text-sm">å¨›æ¨‚</span>
</label>
<label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
<input type="checkbox" name="expense-category" value="pet" class="expense-category">
<span class="text-sm">å¯µç‰©</span>
</label>
<label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
<input type="checkbox" name="expense-category" value="transport" class="expense-category">
<span class="text-sm">äº¤é€š</span>
</label>
<label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
<input type="checkbox" name="expense-category" value="children" class="expense-category">
<span class="text-sm">å…’ç«¥</span>
</label>
<label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
<input type="checkbox" name="expense-category" value="electronics" class="expense-category">
<span class="text-sm">é›»å­</span>
</label>
<label class="flex items-center space-x-2 p-2 border rounded-lg dark:border-gray-600 cursor-pointer">
<input type="checkbox" name="expense-category" value="other" class="expense-category">
<span class="text-sm">å…¶ä»–</span>
</label>
</div>
</div>

<textarea id="redeem-remark" placeholder="æ¶ˆè²»å†…å®¹å‚™è¨» (é¸å¡«)" class="w-full p-2 border rounded-lg text-base dark:bg-gray-700 dark:border-gray-600 mb-2" rows="2"></textarea>
<button id="redeem-selected-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg transition-colors">
å…‘æ›å„ªæƒ åˆ¸
</button>
</div>
</div>
</div>
</div>
</div>

<!-- å·²å…‘æ›è¨˜éŒ„é¢æ¿ -->
<div class="tab-content hidden" id="history-content">
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<div class="flex items-center justify-between mb-3">
<h3 class="font-bold">å…‘æ›è¨˜éŒ„</h3>
<div class="text-sm text-gray-500 dark:text-gray-400">
ç¸½è¨ˆ: <span id="redeemed-total-count" class="font-bold">0</span>å¼µ
</div>
</div>

<div id="redemption-history-list" class="space-y-3">
<div class="text-center text-gray-500 dark:text-gray-400 py-4">å°šç„¡å…‘æ›è¨˜éŒ„</div>
</div>
</div>
</div>

<!-- çµ±è¨ˆåœ–è¡¨é¢æ¿ -->
<div class="tab-content hidden" id="stats-content">
<!-- ç¸½é«”çµ±è¨ˆ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
<h3 class="font-bold mb-2">ç¸½é«”çµ±è¨ˆ</h3>
<div class="grid grid-cols-2 gap-3">
<div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">ç¸½å„ªæƒ åˆ¸</div>
<div class="text-xl font-bold" id="total-vouchers">0å¼µ</div>
</div>
<div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">ç¸½åƒ¹å€¼</div>
<div class="text-xl font-bold" id="total-value">0å…ƒ</div>
</div>
<div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">å·²å…‘æ›ç‡</div>
<div class="text-xl font-bold" id="usage-rate">0%</div>
</div>
<div class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
<div class="text-sm text-gray-500 dark:text-gray-400">å·²éæœŸç‡</div>
<div class="text-xl font-bold" id="expiry-rate">0%</div>
</div>
</div>
</div>

<!-- æ·±å…¥åˆ†æå ±å‘Š -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">æ·±å…¥åˆ†æå ±å‘Š</h3>
<div id="detailed-analysis" class="space-y-4">
<div>
<h4 class="font-medium text-primary dark:text-primary mb-2">é¢å€¼åˆ†ä½ˆåˆ†æ</h4>
<div id="value-distribution-analysis" class="text-sm space-y-2">
<div class="flex justify-between border-b dark:border-gray-700 pb-1">
<span>é¢å€¼</span>
<span>æ•¸é‡</span>
<span>ä½”æ¯”</span>
</div>
<div id="value-distribution-rows">
<div class="text-center text-gray-500 dark:text-gray-400 py-2">åŠ è¼‰ä¸­...</div>
</div>
<div id="value-distribution-summary" class="mt-2 text-gray-600 dark:text-gray-300"></div>
</div>
</div>

<div>
<h4 class="font-medium text-primary dark:text-primary mb-2">éŠ€è¡Œå„ªæƒ åˆ¸åˆ†æ</h4>
<div id="bank-distribution-analysis" class="text-sm space-y-2">
<div class="flex justify-between border-b dark:border-gray-700 pb-1">
<span>éŠ€è¡Œ</span>
<span>æ•¸é‡</span>
<span>ç¸½å€¼</span>
</div>
<div id="bank-distribution-rows">
<div class="text-center text-gray-500 dark:text-gray-400 py-2">åŠ è¼‰ä¸­...</div>
</div>
<div id="bank-distribution-summary" class="mt-2 text-gray-600 dark:text-gray-300"></div>
</div>
</div>

<div>
<h4 class="font-medium text-primary dark:text-primary mb-2">ä½¿ç”¨ç‹€æ…‹åˆ†æ</h4>
<div id="status-distribution-analysis" class="text-sm space-y-2">
<div class="flex justify-between border-b dark:border-gray-700 pb-1">
<span>ç‹€æ…‹</span>
<span>æ•¸é‡</span>
<span>ä½”æ¯”</span>
</div>
<div id="status-distribution-rows">
<div class="text-center text-gray-500 dark:text-gray-400 py-2">åŠ è¼‰ä¸­...</div>
</div>
<div id="status-distribution-summary" class="mt-2 text-gray-600 dark:text-gray-300"></div>
</div>
</div>

<div>
<h4 class="font-medium text-primary dark:text-primary mb-2">å…‘æ›æ•ˆç‡åˆ†æ</h4>
<div id="redemption-efficiency-analysis" class="text-sm space-y-2">
<div id="redemption-efficiency-content">
<div class="text-center text-gray-500 dark:text-gray-400 py-2">åŠ è¼‰ä¸­...</div>
</div>
</div>
</div>
</div>
</div>

<!-- é€±æ¬¡è¨˜éŒ„ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<div class="flex items-center justify-between mb-3">
<h3 class="font-bold">é€±æ¬¡è¨˜éŒ„</h3>
<div class="flex space-x-2">
<select id="week-history-select" class="text-sm border rounded-lg px-2 py-1 dark:bg-gray-700 dark:border-gray-600">
<option value="">-- é¸æ“‡é€±æ¬¡ --</option>
</select>
</div>
</div>
<div id="week-records-list" class="space-y-3"></div>
</div>
</div>

<!-- åœ–è¡¨åˆ†æé¢æ¿ -->
<div class="tab-content hidden" id="charts-content">
<!-- ç‹€æ…‹åˆ†ä½ˆåœ–è¡¨ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">å„ªæƒ åˆ¸ç‹€æ…‹åˆ†ä½ˆ</h3>
<div class="h-60">
<canvas id="status-chart"></canvas>
</div>
</div>

<!-- é¢å€¼å’ŒéŠ€è¡Œåˆ†ä½ˆåœ–è¡¨ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">å„ªæƒ åˆ¸åˆ†ä½ˆ</h3>
<div class="flex justify-center gap-4 mb-2">
<button id="show-value-chart" class="bg-primary text-white px-3 py-1 rounded text-sm">é¢å€¼åˆ†ä½ˆ</button>
<button id="show-bank-chart" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded text-sm">éŠ€è¡Œé‡‘é¡</button>
</div>
<div class="h-72">
<canvas id="combined-chart"></canvas>
</div>
</div>

<!-- æ¶ˆè²»é¡åˆ¥åˆ†ä½ˆåœ–è¡¨ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">æ¶ˆè²»é¡åˆ¥åˆ†ä½ˆ</h3>
<div class="flex justify-center gap-4 mb-2">
<button id="show-category-count" class="bg-primary text-white px-3 py-1 rounded text-sm">æŒ‰æ¬¡æ•¸</button>
<button id="show-category-amount" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded text-sm">æŒ‰é‡‘é¡</button>
</div>
<div class="h-60">
<canvas id="category-chart"></canvas>
</div>
</div>

<!-- é€±æ¬¡è¶¨å‹¢åœ–è¡¨ -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
<h3 class="font-bold mb-3">é€±æ¬¡å„ªæƒ åˆ¸é‡‘é¡è¶¨å‹¢</h3>
<div class="h-60">
<canvas id="weekly-trend-chart"></canvas>
</div>
</div>
</div>

<!-- æ´»å‹•è³‡è¨Šé¢æ¿ -->
<div class="tab-content hidden" id="info-content">
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
<h3 class="font-bold mb-3">æ´»å‹•æ™‚é–“</h3>
<p class="mb-2">2025å¹´9æœˆ1æ—¥è‡³2025å¹´11æœˆ30æ—¥</p>
<h3 class="font-bold mb-2 mt-4">æŠ½çè³‡æ ¼</h3>
<p class="mb-2">é€±ä¸€è‡³é€±äº”åœ¨æ¯é–“æ‰¿è¾¦æ©Ÿæ§‹æ”¯ä»˜å·¥å…·æ¶ˆè²»æ»¿50æ¾³é–€å…ƒï¼Œå¯ç²3æ¬¡æŠ½çæ©Ÿæœƒ</p>
<p class="mb-2">é€±æœ«æ¶ˆè²»æ»¿50æ¾³é–€å…ƒï¼Œå¯ç²å¾—é€±æŠ½çåŠçµ‚æ¥µå¤§æŠ½çè³‡æ ¼</p>
<h3 class="font-bold mb-2 mt-4">å„ªæƒ åˆ¸é¢å€¼</h3>
<p class="mb-2">10ã€20ã€50ã€100 æˆ– 200 æ¾³é–€å…ƒï¼Œæˆ–æ˜¯æŠ½ä¸­ã€Œç¬‘è‡‰ã€</p>
<h3 class="font-bold mb-2 mt-4">ä½¿ç”¨é™åˆ¶</h3>
<p class="mb-2">å„ªæƒ åˆ¸é ˆæ–¼ç²å¾—å¾Œç·Šæ¥çš„é€±å…­åŠé€±æ—¥ä½¿ç”¨ï¼Œé€¾æœŸç„¡æ•ˆ</p>
<p class="mb-2">å…‘æ›æ™‚æ¶ˆè²»é‡‘é¡å¿…é ˆç‚ºå„ªæƒ åˆ¸ç¸½é¡çš„3å€æˆ–ä»¥ä¸Š</p>
<p class="mb-2">æŠ½ä¸­ã€Œç¬‘è‡‰ã€çš„å„ªæƒ åˆ¸ä¸èƒ½å…‘æ›</p>
<h3 class="font-bold mb-2 mt-4">é€±æœŸæ™‚é–“è¡¨</h3>
<div class="overflow-x-auto">
<table class="min-w-full text-sm">
<thead>
<tr class="border-b dark:border-gray-700">
<th class="text-left py-2">é€±æ¬¡</th>
<th class="text-left py-2">æ´»å‹•æ™‚é–“</th>
<th class="text-left py-2">æ¸…é›¶æ™‚é–“</th>
</tr>
</thead>
<tbody id="week-schedule"></tbody>
</table>
</div>
</div>
</div>

<!-- æŸ¥çœ‹é€±æ¬¡è©³æƒ…æ¨¡æ…‹æ¡† -->
<div id="week-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-bold" id="week-detail-title">é€±æ¬¡è©³æƒ…</h3>
<button id="close-week-detail" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>
<div id="week-detail-content"></div>
<div class="mt-4 flex justify-end">
<button id="close-detail-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
é—œé–‰
</button>
</div>
</div>
</div>

<!-- ç¢ºèªå…‘æ›æ¨¡æ…‹æ¡† -->
<div id="confirm-redeem-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
<h3 class="text-lg font-bold mb-4">ç¢ºèªå…‘æ›</h3>
<p class="mb-4 text-sm">ç¢ºå®šè¦å…‘æ›ä»¥ä¸‹å„ªæƒ åˆ¸å—ï¼Ÿ</p>
<div id="redeem-vouchers-info" class="mb-4 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"></div>
<div class="flex space-x-2">
<button id="cancel-redeem" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">å–æ¶ˆ</button>
<button id="confirm-redeem" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">ç¢ºèªå…‘æ›</button>
</div>
</div>
</div>

<!-- å…‘æ›è¨˜éŒ„è©³æƒ…æ¨¡æ…‹æ¡† -->
<div id="redemption-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-bold" id="redemption-detail-title">å…‘æ›è©³æƒ…</h3>
<button id="close-redemption-detail" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>
<div id="redemption-detail-content"></div>
<div class="mt-4 flex justify-end space-x-2">
<!-- æ’¤å›å…‘æ›æŒ‰éˆ• -->
<button id="withdraw-redemption-btn" class="py-2 px-4 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors">
æ’¤å›å…‘æ›
</button>
<button id="close-redemption-detail-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
é—œé–‰
</button>
</div>
</div>
</div>

<!-- æ•¸æ“šç®¡ç†æ¨¡æ…‹æ¡† -->
<div id="data-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-bold">æ•¸æ“šç®¡ç†</h3>
<button id="close-data-management" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div class="space-y-4">
<!-- å­˜å„²ä½¿ç”¨ä¿¡æ¯ -->
<div class="mb-3 border-b pb-4 dark:border-gray-700">
<h4 class="font-medium mb-2">å­˜å„²ä½¿ç”¨æƒ…æ³</h4>
<div class="grid grid-cols-2 gap-2 text-sm">
<div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded">
<div class="text-xs text-gray-500 dark:text-gray-400">å·²ä½¿ç”¨ç©ºé–“</div>
<div id="storage-used-modal" class="font-bold">è¨ˆç®—ä¸­...</div>
</div>
<div class="p-2 bg-green-50 dark:bg-green-900/20 rounded">
<div class="text-xs text-gray-500 dark:text-gray-400">ç€è¦½å™¨é™åˆ¶</div>
<div id="storage-limit" class="font-bold">5 MB (é ä¼°)</div>
</div>
</div>
<div class="mt-2">
<div class="relative pt-1">
<div class="flex mb-1 items-center justify-between">
<div class="text-xs">å·²ä½¿ç”¨ç©ºé–“</div>
<div class="text-xs text-right"><span id="storage-percentage-modal">0</span>%</div>
</div>
<div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200 dark:bg-gray-700">
<div id="storage-bar-modal" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary" style="width: 0%"></div>
</div>
</div>
</div>

<!-- æ·»åŠ è©³ç´°å­˜å„²ä¿¡æ¯ -->
<div class="mt-3 text-xs">
<div class="font-medium mb-1">å­˜å„²å…§å®¹æ˜ç´°ï¼š</div>
<div class="space-y-1 pl-2">
<div class="flex justify-between">
<span>å„ªæƒ åˆ¸è¨˜éŒ„:</span>
<span id="vouchers-size">è¨ˆç®—ä¸­...</span>
</div>
<div class="flex justify-between">
<span>å…‘æ›è¨˜éŒ„:</span>
<span id="redemption-size">è¨ˆç®—ä¸­...</span>
</div>
<div class="flex justify-between">
<span>é€±æ¬¡è¨˜éŒ„:</span>
<span id="week-records-size">è¨ˆç®—ä¸­...</span>
</div>
<div class="flex justify-between">
<span>å…¶ä»–æ•¸æ“š:</span>
<span id="other-data-size">è¨ˆç®—ä¸­...</span>
</div>
</div>
</div>
</div>

<div class="border-b pb-4 dark:border-gray-700">
<h4 class="font-medium mb-2">å‚™ä»½æ•¸æ“š</h4>
<p class="text-sm mb-2">å°‡æ‚¨çš„æ•¸æ“šå‚™ä»½åˆ°æ‰‹æ©Ÿï¼Œä»¥é˜²æ­¢æ•¸æ“šä¸Ÿå¤±ã€‚</p>

<div class="border p-2 bg-gray-50 dark:bg-gray-700 rounded-lg mb-3">
<p class="text-xs mb-1 text-gray-500 dark:text-gray-400">æ‚¨çš„å‚™ä»½ç¢¼ï¼š</p>
<p id="backup-code" class="text-xs break-all font-mono bg-white dark:bg-gray-800 p-2 rounded border max-h-20 overflow-y-auto"></p>
</div>

<div class="flex space-x-2">
<button id="copy-backup-code" class="flex-1 bg-primary text-white py-2 px-3 rounded-lg hover:bg-primary-dark flex items-center justify-center">
<i class="ri-file-copy-line mr-1"></i> è¤‡è£½å‚™ä»½ç¢¼
</button>
</div>
</div>

<div>
<h4 class="font-medium mb-2">æ¢å¾©æ•¸æ“š</h4>
<p class="text-sm mb-2">å¾ä¹‹å‰çš„å‚™ä»½ä¸­æ¢å¾©æ‚¨çš„æ•¸æ“šã€‚</p>

<div class="bg-yellow-50 dark:bg-yellow-900/30 p-2 rounded-lg text-sm text-yellow-800 dark:text-yellow-200 mb-3">
<strong>æ³¨æ„ï¼š</strong> æ¢å¾©æ•¸æ“šå°‡è¦†è“‹ç•¶å‰æ‰€æœ‰æ•¸æ“šï¼Œç„¡æ³•æ’¤éŠ·ï¼
</div>

<textarea id="import-data-textarea" class="w-full h-24 p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-sm font-mono mb-3" placeholder="åœ¨æ­¤ç²˜è²¼æ‚¨çš„å‚™ä»½ç¢¼..."></textarea>

<div class="flex space-x-2">
<button id="restore-data-btn" class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700 flex items-center justify-center">
<i class="ri-refresh-line mr-1"></i> æ¢å¾©æ•¸æ“š
</button>
</div>
</div>
</div>

<div class="mt-4 flex justify-end">
<button id="close-management-btn" class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
é—œé–‰
</button>
</div>
</div>
</div>

<!-- åŒ¯å‡ºæ•¸æ“šæ¨¡æ…‹æ¡† -->
<div id="export-data-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4 max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-bold">åŒ¯å‡ºæ•¸æ“š</h3>
<button id="close-export-data" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div>
<p class="mb-2 text-sm">ä»¥ä¸‹æ˜¯æ‚¨çš„å„ªæƒ åˆ¸çµ±è¨ˆæ•¸æ“šï¼š</p>

<div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg mb-3 text-sm space-y-4">
<div>
<h4 class="font-medium mb-1 text-primary">å„ªæƒ åˆ¸ç¸½è¦½</h4>
<div id="export-summary" class="space-y-1"></div>
</div>

<div>
<h4 class="font-medium mb-1 text-primary">é¢å€¼åˆ†ä½ˆ</h4>
<div id="export-value-distribution" class="space-y-1"></div>
</div>

<div>
<h4 class="font-medium mb-1 text-primary">éŠ€è¡Œåˆ†ä½ˆ</h4>
<div id="export-bank-distribution" class="space-y-1"></div>
</div>

<div>
<h4 class="font-medium mb-1 text-primary">æ¶ˆè²»é¡åˆ¥åˆ†ä½ˆ</h4>
<div id="export-category-distribution" class="space-y-1"></div>
</div>

<div>
<h4 class="font-medium mb-1 text-primary">é€±æ¬¡æ•¸æ“š</h4>
<div id="export-weekly-data" class="space-y-1"></div>
</div>

<button id="download-export-btn" class="w-full py-2 px-3 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors flex items-center justify-center">
<i class="ri-download-line mr-1"></i> ä¸‹è¼‰çµ±è¨ˆå ±å‘Š
</button>
</div>

<div class="flex space-x-2">
<button id="copy-export-data-btn" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">
è¤‡è£½å ±å‘Š
</button>
<button id="close-export-modal-btn" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
é—œé–‰
</button>
</div>
</div>
</div>
</div>

<!-- ç¢ºèªæ’¤å›å…‘æ›æ¨¡æ…‹æ¡† -->
<div id="confirm-withdraw-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
<h3 class="text-lg font-bold mb-4">ç¢ºèªæ’¤å›å…‘æ›</h3>
<p class="mb-4 text-sm text-yellow-600 dark:text-yellow-400">
<i class="ri-alert-line text-lg mr-1"></i>
æ­¤æ“ä½œå°‡æ’¤å›æ‰€é¸å…‘æ›è¨˜éŒ„ï¼Œä¸¦å°‡å„ªæƒ åˆ¸ç‹€æ…‹æ¢å¾©ç‚ºæœªä½¿ç”¨ã€‚è«‹ç¢ºèªé€™æ˜¯æ‚¨æƒ³è¦çš„æ“ä½œã€‚
</p>
<div id="withdraw-vouchers-info" class="mb-4 text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"></div>
<div class="flex space-x-2">
<button id="cancel-withdraw" class="flex-1 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">å–æ¶ˆ</button>
<button id="confirm-withdraw" class="flex-1 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">ç¢ºèªæ’¤å›</button>
</div>
</div>
</div>
</div>

<script>
// æ·±è‰²æ¨¡å¼è¨­ç½®
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
if (event.matches) document.documentElement.classList.add('dark');
else document.documentElement.classList.remove('dark');
});

// æ¶ˆè²»é¡åˆ¥å®šç¾©
const expenseCategories = [
{ id: 'food', name: 'é£Ÿå“', color: '#20c997', icon: 'ri-restaurant-line' },
{ id: 'clothing', name: 'æœé£¾', color: '#6f42c1', icon: 'ri-t-shirt-line' },
{ id: 'entertainment', name: 'å¨›æ¨‚', color: '#fd7e14', icon: 'ri-gamepad-line' },
{ id: 'pet', name: 'å¯µç‰©', color: '#e83e8c', icon: 'ri-footprint-line' },
{ id: 'transport', name: 'äº¤é€š', color: '#0d6efd', icon: 'ri-car-line' },
{ id: 'children', name: 'å…’ç«¥', color: '#ff78c7', icon: 'ri-parent-line' },
{ id: 'electronics', name: 'é›»å­', color: '#3a86ff', icon: 'ri-computer-line' },
{ id: 'other', name: 'å…¶ä»–', color: '#6c757d', icon: 'ri-more-line' }
];

// æ´»å‹•é€±æœŸæ•¸æ“š
const weekSchedule = [
{ week: 1, startDate: '2025-09-01', endDate: '2025-09-05', resetDate: '2025-09-06' },
{ week: 2, startDate: '2025-09-08', endDate: '2025-09-12', resetDate: '2025-09-13' },
{ week: 3, startDate: '2025-09-15', endDate: '2025-09-19', resetDate: '2025-09-20' },
{ week: 4, startDate: '2025-09-22', endDate: '2025-09-26', resetDate: '2025-09-27' },
{ week: 5, startDate: '2025-09-29', endDate: '2025-10-03', resetDate: '2025-10-04' },
{ week: 6, startDate: '2025-10-06', endDate: '2025-10-10', resetDate: '2025-10-11' },
{ week: 7, startDate: '2025-10-13', endDate: '2025-10-17', resetDate: '2025-10-18' },
{ week: 8, startDate: '2025-10-20', endDate: '2025-10-24', resetDate: '2025-10-25' },
{ week: 9, startDate: '2025-10-27', endDate: '2025-10-31', resetDate: '2025-11-01' },
{ week: 10, startDate: '2025-11-03', endDate: '2025-11-07', resetDate: '2025-11-08' },
{ week: 11, startDate: '2025-11-10', endDate: '2025-11-14', resetDate: '2025-11-15' },
{ week: 12, startDate: '2025-11-17', endDate: '2025-11-21', resetDate: '2025-11-22' },
{ week: 13, startDate: '2025-11-24', endDate: '2025-11-28', resetDate: '2025-11-29' }
];

// éŠ€è¡Œæ”¯ä»˜å·¥å…·
const banks = [
{ id: 'boc', name: 'ä¸­åœ‹éŠ€è¡Œ', color: 'boc', darkColor: 'boc-dark', logo: 'ri-bank-fill' },
{ id: 'icbc', name: 'å·¥å•†éŠ€è¡Œ', color: 'icbc', darkColor: 'icbc-dark', logo: 'ri-bank-fill' },
{ id: 'luso', name: 'å¤§è±éŠ€è¡Œ', color: 'luso', darkColor: 'luso-dark', logo: 'ri-bank-fill' },
{ id: 'bnu', name: 'æ¾³é–€åœ‹éš›éŠ€è¡Œ', color: 'primary', darkColor: 'primary-dark', logo: 'ri-bank-fill' },
{ id: 'macaupass', name: 'æ¾³é–€é€š', color: 'macaupass', darkColor: 'macaupass-dark', logo: 'ri-bank-card-fill' },
{ id: 'ant', name: 'èèŸ»éŠ€è¡Œ', color: 'ant', darkColor: 'ant-dark', logo: 'ri-bank-fill' },
{ id: 'mpay', name: 'æ¾³é–€æ¥µæ˜“ä»˜', color: 'mpay', darkColor: 'mpay-dark', logo: 'ri-wallet-fill' },
{ id: 'gdb', name: 'å»£ç™¼éŠ€è¡Œ', color: 'gdb', darkColor: 'gdb-dark', logo: 'ri-bank-fill' }
];

// åˆå§‹åŒ–åº”ç”¨ç¨‹åºçŠ¶æ€
let appState = {
vouchers: [],
currentWeek: 1,
preferredBank: null,
weekRecords: [],
selectedVouchers: [],
redemptionHistory: [],
nextRedemptionId: 1, // å¾1é–‹å§‹çš„æ¶ˆè²»ç·¨è™Ÿ
bankDisplayFilter: banks.map(bank => bank.id), // åˆå§‹åŒ–é¡¯ç¤ºæ‰€æœ‰éŠ€è¡Œ
bankFilter: { active: false, selectedBanks: [] } // åˆå§‹åŒ–éŠ€è¡Œç¯©é¸
};

// åœ–è¡¨å¯¦ä¾‹
let statusChart, categoryChart, weeklyTrendChart, combinedChart;
let currentChartMode = 'value'; // ç•¶å‰é¡¯ç¤ºçš„æ˜¯é¢å€¼åœ–è¡¨é‚„æ˜¯éŠ€è¡Œåœ–è¡¨
let currentCategoryMode = 'count'; // ç•¶å‰é¡¯ç¤ºçš„æ˜¯æŒ‰æ¬¡æ•¸é‚„æ˜¯æŒ‰é‡‘é¡
let tempSelectedVouchers = []; // è‡¨æ™‚å„²å­˜å…‘æ›ç¢ºèªçš„å„ªæƒ åˆ¸
let tempRedeemCategories = []; // è‡¨æ™‚å„²å­˜å…‘æ›é¡åˆ¥
let tempRedeemRemark = ''; // è‡¨æ™‚å„²å­˜å…‘æ›å‚™è¨»
let currentRedemptionId = null; // ç•¶å‰æŸ¥çœ‹çš„å…‘æ›è¨˜éŒ„IDï¼Œç”¨æ–¼æ’¤å›åŠŸèƒ½

/* ---------- æ ¸å¿ƒåŠŸèƒ½ ---------- */

// åŠ è¼‰æ•¸æ“š
function loadAppState() {
try {
const savedState = localStorage.getItem('voucherAppState');
if (savedState) {
appState = JSON.parse(savedState);
if (!appState.selectedVouchers) appState.selectedVouchers = [];
if (!appState.weekRecords) appState.weekRecords = [];
if (!appState.redemptionHistory) appState.redemptionHistory = [];
// ç¢ºä¿æœ‰ä¸‹ä¸€å€‹æ¶ˆè²»ç·¨è™Ÿ
if (!appState.nextRedemptionId) {
appState.nextRedemptionId = appState.redemptionHistory.length > 0 ?
Math.max(...appState.redemptionHistory.map(r => Number(r.displayId) || 0)) + 1 : 1;
}

// è™•ç†èˆŠç‰ˆæœ¬æ•¸æ“šå…¼å®¹æ€§ - åœ¨èˆŠè¨˜éŒ„ä¸­æ·»åŠ æ¶ˆè²»é¡åˆ¥å±¬æ€§
appState.redemptionHistory.forEach(redemption => {
if (!redemption.categories) {
redemption.categories = ['other']; // é»˜èªç‚ºå…¶ä»–é¡åˆ¥
}
// æ·»åŠ æ’¤å›ç‹€æ…‹å±¬æ€§
if (redemption.withdrawn === undefined) {
redemption.withdrawn = false;
}
});

// ç¢ºä¿éŠ€è¡Œéæ¿¾å’Œé¡¯ç¤ºè¨­å®šå·²åˆå§‹åŒ–
if (!appState.bankDisplayFilter) {
appState.bankDisplayFilter = banks.map(bank => bank.id);
}

if (!appState.bankFilter) {
appState.bankFilter = {
active: false,
selectedBanks: []
};
}
}

// æ›´æ–°ç•¶å‰é€±æ¬¡
appState.currentWeek = calculateCurrentWeek();

// æ›´æ–°é€±æ¬¡è¨˜éŒ„
updateWeekRecords();
} catch (e) {
console.error('Failed to load app state:', e);
}
}

// ä¿å­˜æ•¸æ“š
function saveAppState() {
try {
localStorage.setItem('voucherAppState', JSON.stringify(appState));
// æ›´æ–°å­˜å„²ä½¿ç”¨é‡
calculateStorageSize();
} catch (e) {
console.error('Failed to save app state:', e);
alert('å­˜å„²æ•¸æ“šå¤±æ•—ï¼Œå¯èƒ½æ˜¯å› ç‚ºç€è¦½å™¨å­˜å„²ç©ºé–“å·²æ»¿ï¼');
}
}

// è¨ˆç®—å­˜å„²å¤§å°
function calculateStorageSize() {
try {
// è¨ˆç®—æ•´å€‹ appState çš„å¤§å°
const totalData = JSON.stringify(appState);
const totalSizeBytes = new TextEncoder().encode(totalData).length;
const totalSizeKB = (totalSizeBytes / 1024).toFixed(2);
const totalSizeMB = (totalSizeBytes / (1024 * 1024)).toFixed(3);

// è¨ˆç®—å„éƒ¨åˆ†çš„å¤§å°
const vouchersData = JSON.stringify(appState.vouchers);
const vouchersSizeKB = (new TextEncoder().encode(vouchersData).length / 1024).toFixed(2);

const redemptionData = JSON.stringify(appState.redemptionHistory);
const redemptionSizeKB = (new TextEncoder().encode(redemptionData).length / 1024).toFixed(2);

const weekRecordsData = JSON.stringify(appState.weekRecords);
const weekRecordsSizeKB = (new TextEncoder().encode(weekRecordsData).length / 1024).toFixed(2);

// å…¶ä»–æ•¸æ“šå¤§å°
const otherDataSizeKB = (totalSizeBytes / 1024 -
parseFloat(vouchersSizeKB) -
parseFloat(redemptionSizeKB) -
parseFloat(weekRecordsSizeKB)).toFixed(2);

// ä¼°ç®—ä½¿ç”¨ç‡ (5MB å¤§ç´„æ˜¯ç€è¦½å™¨é™åˆ¶)
const estimatedPercentage = Math.min(Math.round(totalSizeBytes / (5 * 1024 * 1024) * 100), 100);

// æ›´æ–°ä¸»é é¢å­˜å„²ä¿¡æ¯
document.getElementById('storage-size').textContent = `${totalSizeKB} KB (${totalSizeMB} MB)`;
document.getElementById('storage-percentage').textContent = estimatedPercentage;
document.getElementById('storage-bar').style.width = `${estimatedPercentage}%`;

// æ›´æ–°æ¨¡æ…‹æ¡†ä¸­çš„å­˜å„²ä¿¡æ¯
if (document.getElementById('storage-used-modal')) {
document.getElementById('storage-used-modal').textContent = `${totalSizeKB} KB`;
document.getElementById('storage-percentage-modal').textContent = estimatedPercentage;
document.getElementById('storage-bar-modal').style.width = `${estimatedPercentage}%`;

// æ›´æ–°è©³ç´°æ•¸æ“šå¤§å°
document.getElementById('vouchers-size').textContent = `${vouchersSizeKB} KB`;
document.getElementById('redemption-size').textContent = `${redemptionSizeKB} KB`;
document.getElementById('week-records-size').textContent = `${weekRecordsSizeKB} KB`;
document.getElementById('other-data-size').textContent = `${otherDataSizeKB} KB`;
}

// æ ¹æ“šä½¿ç”¨ç‡æ”¹è®Šé¡è‰²
const storageBar = document.getElementById('storage-bar');
const storageBarModal = document.getElementById('storage-bar-modal');

if (estimatedPercentage > 80) {
storageBar.classList.remove('bg-primary');
storageBar.classList.add('bg-red-500');
if (storageBarModal) {
storageBarModal.classList.remove('bg-primary');
storageBarModal.classList.add('bg-red-500');
}
} else if (estimatedPercentage > 60) {
storageBar.classList.remove('bg-primary', 'bg-red-500');
storageBar.classList.add('bg-yellow-500');
if (storageBarModal) {
storageBarModal.classList.remove('bg-primary', 'bg-red-500');
storageBarModal.classList.add('bg-yellow-500');
}
} else {
storageBar.classList.remove('bg-yellow-500', 'bg-red-500');
storageBar.classList.add('bg-primary');
if (storageBarModal) {
storageBarModal.classList.remove('bg-yellow-500', 'bg-red-500');
storageBarModal.classList.add('bg-primary');
}
}

return totalSizeBytes;
} catch (e) {
console.error('è¨ˆç®—å­˜å„²å¤§å°æ™‚å‡ºéŒ¯:', e);
return 0;
}
}

// è¨ˆç®—ç•¶å‰é€±æ¬¡ - ç°¡åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨æ—¥æœŸç›´æ¥å°æ‡‰é€±æ¬¡
function calculateCurrentWeek() {
// ä½¿ç”¨ç•¶å‰æ—¥æœŸä¸­çš„æ—¥ä¾†ç¢ºå®šé€±æ¬¡
const today = new Date();
const currentDay = today.getDate();

// ç°¡å–®çš„æ˜ å°„ï¼šæœˆä¸­çš„ç¬¬å¹¾å¤©å°æ‡‰é€±æ¬¡
// 1-3è™Ÿæ˜¯ç¬¬1é€±ï¼Œ4-6è™Ÿæ˜¯ç¬¬2é€±ï¼Œä¾æ­¤é¡æ¨...
if (currentDay <= 3) return 1;
else if (currentDay <= 6) return 2;
else if (currentDay <= 9) return 3;
else if (currentDay <= 12) return 4;
else if (currentDay <= 15) return 5;
else if (currentDay <= 18) return 6;
else if (currentDay <= 21) return 7;
else if (currentDay <= 24) return 8;
else if (currentDay <= 27) return 9;
else return 10;
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
const date = new Date(dateString);
return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
}

// æ ¹æ“šæ—¥æœŸç²å–é€±æ¬¡
function getWeekNumberFromDate(dateString) {
for (let i = 0; i < weekSchedule.length; i++) {
if (dateString >= weekSchedule[i].startDate && dateString <= weekSchedule[i].endDate) {
return i + 1;
}
}

// æª¢æŸ¥é€±æœ«
for (let i = 0; i < weekSchedule.length; i++) {
const resetDate = weekSchedule[i].resetDate;
const nextDay = new Date(resetDate);
nextDay.setDate(nextDay.getDate() + 1);
const nextDayStr = nextDay.toISOString().split('T')[0];

if (dateString === resetDate || dateString === nextDayStr) {
return i + 1;
}
}

return 1;
}

// æª¢æŸ¥æ˜¯å¦æ˜¯éå»çš„é€±æ¬¡
function isPastWeek(weekNum) {
return weekNum < appState.currentWeek;
}

// åˆ¤æ–·å„ªæƒ åˆ¸æ˜¯å¦éæœŸ
function isVoucherExpired(voucher) {
const today = new Date();
today.setHours(0, 0, 0, 0);

const weekNum = getWeekNumberFromDate(voucher.date) - 1;
if (weekNum >= 0 && weekNum < weekSchedule.length) {
const saturday = new Date(weekSchedule[weekNum].resetDate);
const sunday = new Date(saturday);
sunday.setDate(saturday.getDate() + 1);
sunday.setHours(23, 59, 59, 999);

return today > sunday;
}

return false;
}

// è¨ˆç®—éŠ€è¡Œå„ªæƒ åˆ¸æ•¸é‡
function getBankVoucherCount(bankId, weekNum) {
return appState.vouchers.filter(v =>
v.bankId === bankId && getWeekNumberFromDate(v.date) === weekNum
).length;
}

// ç²å–éŠ€è¡Œåç¨±
function getBankName(bankId) {
const bank = banks.find(b => b.id === bankId);
return bank ? bank.name : 'æœªçŸ¥éŠ€è¡Œ';
}

// æ ¼å¼åŒ–æ¶ˆè²»ç·¨è™Ÿ
function formatRedemptionId(id) {
return id.toString().padStart(4, '0');
}

// ç²å–æ¶ˆè²»é¡åˆ¥åç¨±
function getCategoryName(categoryId) {
const category = expenseCategories.find(c => c.id === categoryId);
return category ? category.name : 'å…¶ä»–';
}

// ç²å–æ¶ˆè²»é¡åˆ¥é¡è‰²
function getCategoryColor(categoryId) {
const category = expenseCategories.find(c => c.id === categoryId);
return category ? category.color : '#6c757d';
}

// ç²å–æ¶ˆè²»é¡åˆ¥åœ–æ¨™
function getCategoryIcon(categoryId) {
const category = expenseCategories.find(c => c.id === categoryId);
return category ? category.icon : 'ri-more-line';
}

// åˆ¤æ–·å„ªæƒ åˆ¸æ˜¯å¦å¯å…‘æ› (æ–°å¢å‡½æ•¸)
function isVoucherRedeemable(voucher) {
// ç¬‘è‡‰(0å…ƒ)å„ªæƒ åˆ¸ä¸å¯å…‘æ›
if (voucher.amount === 0) return false;
// å·²ä½¿ç”¨æˆ–å·²éæœŸçš„å„ªæƒ åˆ¸ä¸å¯å…‘æ›
return !voucher.used && !isVoucherExpired(voucher);
}

// ç²å–å¯å…‘æ›å„ªæƒ åˆ¸æ•¸é‡ (æ–°å¢å‡½æ•¸)
function getRedeemableVoucherCount() {
return appState.vouchers.filter(isVoucherRedeemable).length;
}

// ç²å–å¯å…‘æ›å„ªæƒ åˆ¸ç¸½å€¼ (æ–°å¢å‡½æ•¸)
function getRedeemableVoucherValue() {
return appState.vouchers
.filter(isVoucherRedeemable)
.reduce((sum, v) => sum + v.amount, 0);
}

/* ---------- UIæ›´æ–°å‡½æ•¸ ---------- */

// æ›´æ–°æ—¥æœŸå’Œé€±æ¬¡é¡¯ç¤º
function updateDateDisplay() {
// é¡¯ç¤ºç•¶å‰æ—¥æœŸ
const today = new Date();
const currentDate = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
document.getElementById('current-date').textContent = currentDate;

// é¡¯ç¤ºæ´»å‹•é€±æ¬¡
const weekNum = appState.currentWeek;
const weekElem = document.getElementById('current-week');

if (weekNum === 0) {
weekElem.textContent = 'æ´»å‹•å°šæœªé–‹å§‹';
} else if (weekNum > 10) {
weekElem.textContent = 'æ´»å‹•å·²çµæŸ';
} else {
const weekData = weekSchedule[weekNum - 1];
weekElem.textContent = `ç¬¬${weekNum}é€± (${formatDate(weekData.startDate)} - ${formatDate(weekData.endDate)})`;
}
}

// æ›´æ–°é€±æœŸæ™‚é–“è¡¨
function updateWeekSchedule() {
const tableBody = document.getElementById('week-schedule');
tableBody.innerHTML = '';

weekSchedule.forEach(week => {
const row = document.createElement('tr');
row.className = 'border-b dark:border-gray-700';
row.innerHTML = `
<td class="py-2">ç¬¬${week.week}é€±</td>
<td class="py-2">${formatDate(week.startDate)} - ${formatDate(week.endDate)}</td>
<td class="py-2">${formatDate(week.resetDate)}</td>
`;
tableBody.appendChild(row);
});
}

// æ›´æ–°éŠ€è¡ŒæŒ‰éˆ•
function updateBankButtons() {
const bankButtonsContainer = document.getElementById('bank-buttons');
bankButtonsContainer.innerHTML = '';

// æ ¹æ“šé¸ä¸­çš„éŠ€è¡Œéæ¿¾
let visibleBanks = [...banks];

// å¦‚æœæœ‰è¨­ç½®éæ¿¾å™¨ï¼Œä¸”ä¸æ˜¯é¡¯ç¤ºå…¨éƒ¨
if (appState.bankDisplayFilter && appState.bankDisplayFilter.length > 0) {
visibleBanks = banks.filter(bank => appState.bankDisplayFilter.includes(bank.id));
}

// å¦‚æœæ²’æœ‰é¸ä¸­ä»»ä½•éŠ€è¡Œï¼Œé¡¯ç¤ºæ‰€æœ‰éŠ€è¡Œ
if (visibleBanks.length === 0) {
visibleBanks = [...banks];
}

// æª¢æŸ¥ç•¶å‰é¸ä¸­çš„éŠ€è¡Œæ˜¯å¦å·²é”åˆ°3æ¬¡ä¸Šé™ï¼Œå¦‚æœé”åˆ°ä¸Šé™ï¼Œå‰‡æ¸…é™¤é¸æ“‡
if (appState.preferredBank) {
const selectedBankCount = getBankVoucherCount(appState.preferredBank, appState.currentWeek);
if (selectedBankCount >= 3) {
appState.preferredBank = null; // æ¸…é™¤å·²é¸éŠ€è¡Œ
saveAppState();
}
}

visibleBanks.forEach(bank => {
const voucherCount = getBankVoucherCount(bank.id, appState.currentWeek);
const isDisabled = voucherCount >= 3;
// åªæœ‰æœªé”åˆ°ä¸Šé™çš„éŠ€è¡Œæ‰èƒ½è¢«é¸ä¸­
const isSelected = !isDisabled && appState.preferredBank === bank.id;

const bankButton = document.createElement('div');
bankButton.className = `p-2 rounded-lg flex flex-col items-center ${
isDisabled ? 'opacity-50 cursor-default' : 'cursor-pointer'
} ${
isSelected ? `bg-${bank.color} text-white` : `bg-white dark:bg-gray-800 ${!isDisabled ? 'hover:bg-gray-100 dark:hover:bg-gray-700' : ''}`
}`;
bankButton.setAttribute('data-bank-id', bank.id);

bankButton.innerHTML = `
<i class="${bank.logo} text-2xl ${isSelected ? 'text-white' : `text-${bank.color} dark:text-${bank.color}`}"></i>
<div class="text-xs mt-1 ${isSelected ? 'text-white' : ''}">${bank.name}</div>
<div class="text-xs ${isSelected ? 'text-white' : 'text-gray-500 dark:text-gray-400'}">${voucherCount}/3</div>
`;

if (!isDisabled) {
bankButton.addEventListener('click', () => {
appState.preferredBank = bank.id;
saveAppState();
updateBankButtons();
updateQuickAddPanel();
});
}

bankButtonsContainer.appendChild(bankButton);
});

// å¦‚æœæ²’æœ‰å¯é¡¯ç¤ºçš„éŠ€è¡Œ
if (bankButtonsContainer.children.length === 0) {
const noResultMsg = document.createElement('div');
noResultMsg.className = 'col-span-4 text-center py-4 text-gray-500 dark:text-gray-400';
noResultMsg.textContent = 'æ²’æœ‰å¯é¡¯ç¤ºçš„æ”¯ä»˜å·¥å…·';
bankButtonsContainer.appendChild(noResultMsg);
}
}

// æ›´æ–°å¿«é€Ÿæ·»åŠ é¢æ¿
function updateQuickAddPanel() {
const quickAddContainer = document.getElementById('quick-add-container');

if (appState.preferredBank) {
const bank = banks.find(b => b.id === appState.preferredBank);
document.getElementById('selected-bank-name-display').textContent = bank ? bank.name : 'éŠ€è¡Œ';

const voucherCount = getBankVoucherCount(appState.preferredBank, appState.currentWeek);
document.getElementById('total-draws').textContent = voucherCount;

// å¦‚æœå·²é”åˆ°3å€‹ï¼Œç¦ç”¨æŒ‰éˆ•
const isDisabled = voucherCount >= 3;
document.querySelectorAll('.quick-add').forEach(btn => {
if (isDisabled) {
btn.classList.add('opacity-50');
btn.classList.add('cursor-not-allowed');
btn.disabled = true;
} else {
btn.classList.remove('opacity-50');
btn.classList.remove('cursor-not-allowed');
btn.disabled = false;

btn.onclick = function() {
const amount = parseInt(this.getAttribute('data-amount'));
addVoucher(amount);
};
}
});

quickAddContainer.classList.remove('hidden');
} else {
quickAddContainer.classList.add('hidden');
}
}

// æ·»åŠ å„ªæƒ åˆ¸
function addVoucher(amount, customDate = null, customBankId = null) {
const bankId = customBankId || appState.preferredBank;
if (!bankId) {
alert('è«‹å…ˆé¸æ“‡éŠ€è¡Œï¼');
return;
}

const date = customDate || new Date().toISOString().split('T')[0];
const weekNum = getWeekNumberFromDate(date);

// æª¢æŸ¥æ˜¯å¦æ˜¯æ·»åŠ éå»é€±æ¬¡çš„è¨˜éŒ„ï¼Œæ˜¯å¦åœ¨ç®¡ç†æ¨¡å¼ä¸‹
const isPast = isPastWeek(weekNum);
const isAdminMode = customDate !== null && customBankId !== null;
if (isPast && !isAdminMode) {
alert(`ç„¡æ³•æ·»åŠ éå»é€±æ¬¡çš„å„ªæƒ åˆ¸ï¼`);
return;
}

// æª¢æŸ¥æ˜¯å¦è¶…éæ¯é€±3å€‹å„ªæƒ åˆ¸é™åˆ¶
const voucherCount = getBankVoucherCount(bankId, weekNum);
if (voucherCount >= 3 && !isAdminMode) {
alert(`${getBankName(bankId)}æœ¬é€±å·²é”3å¼µå„ªæƒ åˆ¸ä¸Šé™ï¼`);
return;
}

// å‰µå»ºæ–°å„ªæƒ åˆ¸
const newVoucher = {
id: Date.now().toString(),
amount: amount,
date: date,
used: false,
bankId: bankId
};

// æ·»åŠ å„ªæƒ åˆ¸
appState.vouchers.push(newVoucher);

// ä¿å­˜ä¸¦æ›´æ–°UI
saveAppState();
updateWeekRecords();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateWeekRecordsDisplay();
updateRedemptionHistory();
updateDetailedAnalysis();
updateCharts();
updateAdminVoucherCounts();

return true;
}

// åˆªé™¤å„ªæƒ åˆ¸
function deleteVoucher(voucherId, isAdminMode = false) {
const voucher = appState.vouchers.find(v => v.id === voucherId);
if (!voucher) return false;

// æª¢æŸ¥æ˜¯å¦æ˜¯éå»é€±æ¬¡çš„è¨˜éŒ„ (éç®¡ç†æ¨¡å¼ä¸‹ä¸å…è¨±åˆªé™¤éå»çš„è¨˜éŒ„)
if (!isAdminMode) {
const weekNum = getWeekNumberFromDate(voucher.date);
if (isPastWeek(weekNum)) {
alert('ç„¡æ³•åˆªé™¤éå»é€±æ¬¡çš„å„ªæƒ åˆ¸ï¼');
return false;
}
}

const index = appState.vouchers.indexOf(voucher);
if (index !== -1) {
appState.vouchers.splice(index, 1);

// å¾é¸æ“‡åˆ—è¡¨ä¸­ç§»é™¤
appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);

saveAppState();
updateWeekRecords();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateWeekRecordsDisplay();
updateRedemptionHistory();
updateDetailedAnalysis();
updateCharts();
updateAdminVoucherCounts();
}

return true;
}

// åˆªé™¤ç‰¹å®šéŠ€è¡Œç‰¹å®šé‡‘é¡çš„å„ªæƒ åˆ¸ (çµ¦ç®¡ç†æ¨¡å¼ä½¿ç”¨)
function deleteVoucherByBankAndAmount(bankId, amount, weekNum) {
// æ‰¾åˆ°è©²éŠ€è¡Œè©²é¢å€¼ç•¶é€±çš„æœ€å¾Œä¸€å€‹å„ªæƒ åˆ¸
const voucher = [...appState.vouchers]
.filter(v =>
v.bankId === bankId &&
v.amount === amount &&
getWeekNumberFromDate(v.date) === weekNum
).pop();

if (voucher) {
return deleteVoucher(voucher.id, true);
}
return false;
}

// åˆå§‹åŒ–éŠ€è¡Œéæ¿¾å™¨
function initBankFilters() {
const bankFiltersContainer = document.getElementById('bank-filters');

// ç¢ºä¿å®¹å™¨å’Œæ•¸æ“šå·²ç¶“å­˜åœ¨
if (!bankFiltersContainer) {
console.error("æ‰¾ä¸åˆ°bank-filterså®¹å™¨");
return;
}

// æ¸…ç©ºç¾æœ‰å…§å®¹
bankFiltersContainer.innerHTML = '';

// ç¢ºä¿éŠ€è¡Œé¡¯ç¤ºéæ¿¾å™¨å·²åˆå§‹åŒ–
if (!appState.bankDisplayFilter) {
appState.bankDisplayFilter = banks.map(bank => bank.id);
}

// ç‚ºæ¯å€‹éŠ€è¡Œå‰µå»ºéæ¿¾æŒ‰éˆ•
banks.forEach(bank => {
const isSelected = appState.bankDisplayFilter.includes(bank.id);

const filterBtn = document.createElement('button');
filterBtn.className = `text-xs px-2 py-1 rounded-full flex items-center ${
isSelected ? 'bg-' + bank.color + ' text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
}`;
filterBtn.setAttribute('data-bank', bank.id);
filterBtn.innerHTML = `<i class="${bank.logo} mr-1"></i> ${bank.name}`;

filterBtn.addEventListener('click', function() {
const bankId = this.getAttribute('data-bank');

// åˆ‡æ›é¸ä¸­ç‹€æ…‹
if (appState.bankDisplayFilter.includes(bankId)) {
appState.bankDisplayFilter = appState.bankDisplayFilter.filter(id => id !== bankId);
} else {
appState.bankDisplayFilter.push(bankId);
}

saveAppState();
initBankFilters(); // é‡æ–°åˆå§‹åŒ–éæ¿¾å™¨
});

bankFiltersContainer.appendChild(filterBtn);
});

// æ·»åŠ å…¨é¸å’Œæ¸…ç©ºæŒ‰éˆ•
const allBtn = document.createElement('button');
allBtn.className = 'text-xs px-2 py-1 rounded-full bg-primary text-white';
allBtn.textContent = 'å…¨é¸';
allBtn.addEventListener('click', function() {
appState.bankDisplayFilter = banks.map(bank => bank.id);
saveAppState();
initBankFilters();
});

const clearBtn = document.createElement('button');
clearBtn.className = 'text-xs px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
clearBtn.textContent = 'æ¸…ç©º';
clearBtn.addEventListener('click', function() {
appState.bankDisplayFilter = [];
saveAppState();
initBankFilters();
});

bankFiltersContainer.appendChild(allBtn);
bankFiltersContainer.appendChild(clearBtn);
}

// æ›´æ–°éŠ€è¡Œå„ªæƒ åˆ¸ç¸½è¦½
function updateBankOverview() {
const bankOverviewList = document.getElementById('bank-overview-list');
bankOverviewList.innerHTML = '';

// è¨ˆç®—å„éŠ€è¡Œé¢å€¼åˆ†ä½ˆ
const bankDistribution = {};
banks.forEach(bank => {
bankDistribution[bank.id] = {
0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
count: 0, total: 0,
unused: { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0, count: 0, total: 0 }
};
});

// è¨ˆç®—ç¸½æ•¸æ“š
const totalCounts = {
0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0,
count: 0, total: 0,
unused: { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0, count: 0, total: 0 },
redeemable: { count: 0, total: 0 } // æ–°å¢å¯å…‘æ›çµ±è¨ˆ
};

// ç²å–ç•¶å‰é€±æ¬¡
const currentWeek = appState.currentWeek;

// çµ±è¨ˆå„éŠ€è¡Œå„ªæƒ åˆ¸ (åƒ…ç•¶å‰é€±æ¬¡)
appState.vouchers.forEach(voucher => {
// åªçµ±è¨ˆç•¶å‰é€±æ¬¡çš„å„ªæƒ åˆ¸
if (voucher.bankId && getWeekNumberFromDate(voucher.date) === currentWeek) {
const bankData = bankDistribution[voucher.bankId];
if (bankData) {
// æ·»åŠ åˆ°ç¸½æ•¸
bankData[voucher.amount]++;
bankData.count++;
if (voucher.amount > 0) bankData.total += voucher.amount;

// æ·»åŠ åˆ°å¯ç”¨æ•¸é‡
if (!voucher.used && !isVoucherExpired(voucher)) {
bankData.unused[voucher.amount]++;
bankData.unused.count++;
if (voucher.amount > 0) bankData.unused.total += voucher.amount;
}

// æ·»åŠ åˆ°ç¸½è¨ˆ
totalCounts[voucher.amount]++;
totalCounts.count++;
if (voucher.amount > 0) totalCounts.total += voucher.amount;

if (!voucher.used && !isVoucherExpired(voucher)) {
totalCounts.unused[voucher.amount]++;
totalCounts.unused.count++;
if (voucher.amount > 0) totalCounts.unused.total += voucher.amount;

// æ›´æ–°å¯å…‘æ›çµ±è¨ˆ (ä¸åŒ…å«ç¬‘è‡‰)
if (voucher.amount > 0) {
totalCounts.redeemable.count++;
totalCounts.redeemable.total += voucher.amount;
}
}
}
}
});

// å¦‚æœæ²’æœ‰å„ªæƒ åˆ¸
if (totalCounts.count === 0) {
bankOverviewList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šæœªæ·»åŠ ä»»ä½•å„ªæƒ åˆ¸</div>';
return;
}

// æ·»åŠ ç¸½è¨ˆå¡ç‰‡
const totalCard = document.createElement('div');
totalCard.className = 'bg-primary-50 dark:bg-primary-900/30 border-primary border rounded-lg p-3 mt-3';

totalCard.innerHTML = `
<div class="flex justify-between items-center mb-2 pb-2 border-b dark:border-gray-700">
<div class="font-bold">ç¸½è¨ˆ</div>
<div class="text-sm">
${totalCounts.count}å¼µ (${totalCounts.total}å…ƒ)
<div class="text-xs text-green-600 dark:text-green-400">
å¯å…‘æ›: ${totalCounts.redeemable.count}å¼µ (${totalCounts.redeemable.total}å…ƒ)
</div>
</div>
</div>

<div class="grid grid-cols-6 gap-1 text-center">
<div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 ${totalCounts[0] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[0]}</div>
<div class="text-xs">ğŸ˜„</div>
${totalCounts.unused[0] > 0 ? `<div class="text-xs text-gray-500 dark:text-gray-400">ä¸å¯å…‘æ›: ${totalCounts.unused[0]}</div>` : ''}
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${totalCounts[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[10]}</div>
<div class="text-xs">10å…ƒ</div>
${totalCounts.unused[10] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${totalCounts.unused[10]}</div>` : ''}
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${totalCounts[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[20]}</div>
<div class="text-xs">20å…ƒ</div>
${totalCounts.unused[20] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${totalCounts.unused[20]}</div>` : ''}
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 ${totalCounts[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[50]}</div>
<div class="text-xs">50å…ƒ</div>
${totalCounts.unused[50] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${totalCounts.unused[50]}</div>` : ''}
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${totalCounts[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[100]}</div>
<div class="text-xs">100å…ƒ</div>
${totalCounts.unused[100] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${totalCounts.unused[100]}</div>` : ''}
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${totalCounts[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${totalCounts[200]}</div>
<div class="text-xs">200å…ƒ</div>
${totalCounts.unused[200] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${totalCounts.unused[200]}</div>` : ''}
</div>
</div>
`;

bankOverviewList.appendChild(totalCard);

// éŠ€è¡Œéæ¿¾åŠŸèƒ½
let banksToShow = banks.filter(bank => bankDistribution[bank.id].count > 0);

// å¦‚æœç¯©é¸å™¨å•Ÿç”¨ä¸”æœ‰é¸ä¸­çš„éŠ€è¡Œï¼Œåªé¡¯ç¤ºé¸ä¸­çš„éŠ€è¡Œ
if (appState.bankFilter && appState.bankFilter.active && appState.bankFilter.selectedBanks.length > 0) {
banksToShow = banksToShow.filter(bank => appState.bankFilter.selectedBanks.includes(bank.id));
}

// å›ºå®šæŒ‰å­—æ¯é †åºæ’åºéŠ€è¡Œï¼Œé¿å…ä½ç½®è·³å‹•
banksToShow.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));

// æ·»åŠ å„éŠ€è¡Œå¡ç‰‡
banksToShow.forEach(bank => {
const data = bankDistribution[bank.id];

// è¨ˆç®—å¯å…‘æ›å„ªæƒ åˆ¸æ•¸é‡ (ä¸å«ç¬‘è‡‰)
const redeemableCount = data.unused[10] + data.unused[20] + data.unused[50] +
data.unused[100] + data.unused[200];
const redeemableValue = data.unused[10] * 10 + data.unused[20] * 20 + data.unused[50] * 50 +
data.unused[100] * 100 + data.unused[200] * 200;

const bankCard = document.createElement('div');
bankCard.className = 'bg-white dark:bg-gray-800 border rounded-lg p-3 mt-3';
bankCard.setAttribute('data-bank-id', bank.id);

bankCard.innerHTML = `
<div class="flex items-center justify-between mb-2 pb-2 border-b dark:border-gray-700">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-bold">${bank.name}</span>
</div>
<div class="text-sm">
${data.count}å¼µ (${data.total}å…ƒ)
<div class="text-xs text-green-600 dark:text-green-400">
å¯å…‘æ›: ${redeemableCount}å¼µ (${redeemableValue}å…ƒ)
</div>
</div>
</div>

<div class="grid grid-cols-6 gap-1 text-center">
<div class="bg-yellow-100 dark:bg-yellow-900 rounded p-2 relative ${data[0] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[0]}</div>
<div class="text-xs">ğŸ˜„</div>
${data.unused[0] > 0 ? `<div class="text-xs text-gray-500 dark:text-gray-400">ä¸å¯å…‘æ›: ${data.unused[0]}</div>` : ''}
<div class="flex gap-1 mt-1">
<button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="0">+</button>
<button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="0">-</button>
</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 relative ${data[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[10]}</div>
<div class="text-xs">10å…ƒ</div>
${data.unused[10] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${data.unused[10]}</div>` : ''}
<div class="flex gap-1 mt-1">
<button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="10">+</button>
<button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="10">-</button>
</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 relative ${data[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[20]}</div>
<div class="text-xs">20å…ƒ</div>
${data.unused[20] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${data.unused[20]}</div>` : ''}
<div class="flex gap-1 mt-1">
<button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="20">+</button>
<button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="20">-</button>
</div>
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 relative ${data[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[50]}</div>
<div class="text-xs">50å…ƒ</div>
${data.unused[50] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${data.unused[50]}</div>` : ''}
<div class="flex gap-1 mt-1">
<button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="50">+</button>
<button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="50">-</button>
</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 relative ${data[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[100]}</div>
<div class="text-xs">100å…ƒ</div>
${data.unused[100] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${data.unused[100]}</div>` : ''}
<div class="flex gap-1 mt-1">
<button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="100">+</button>
<button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="100">-</button>
</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 relative ${data[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${data[200]}</div>
<div class="text-xs">200å…ƒ</div>
${data.unused[200] > 0 ? `<div class="text-xs text-green-600 dark:text-green-400">å¯å…‘æ›: ${data.unused[200]}</div>` : ''}
<div class="flex gap-1 mt-1">
<button class="add-voucher-btn bg-gray-200 dark:bg-gray-700 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="200">+</button>
<button class="delete-voucher-btn bg-red-200 dark:bg-red-900 rounded w-full flex items-center justify-center text-xs"
data-bank="${bank.id}" data-amount="200">-</button>
</div>
</div>
</div>
`;

bankOverviewList.appendChild(bankCard);
});

// å¦‚æœå•Ÿç”¨äº†ç¯©é¸ä½†æ²’æœ‰é¡¯ç¤ºä»»ä½•éŠ€è¡Œ
if (appState.bankFilter && appState.bankFilter.active && banksToShow.length === 0 && appState.bankFilter.selectedBanks.length > 0) {
const noMatchMessage = document.createElement('div');
noMatchMessage.className = 'text-center text-gray-500 dark:text-gray-400 py-4 mt-3 bg-gray-100 dark:bg-gray-800 rounded-lg';
noMatchMessage.innerHTML = 'æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„éŠ€è¡Œ';
bankOverviewList.appendChild(noMatchMessage);
}

// æ·»åŠ å¿«é€Ÿæ·»åŠ æŒ‰éˆ•äº‹ä»¶
document.querySelectorAll('.add-voucher-btn').forEach(btn => {
btn.addEventListener('click', function() {
const bankId = this.getAttribute('data-bank');
const amount = parseInt(this.getAttribute('data-amount'));

// éç®¡ç†æ¨¡å¼ä¸‹ï¼Œæª¢æŸ¥æ˜¯å¦æ˜¯éå»é€±æ¬¡çš„æ“ä½œ
const weekNum = getWeekNumberFromDate(new Date().toISOString().split('T')[0]);
if (isPastWeek(weekNum)) {
alert('ç„¡æ³•æ·»åŠ éå»é€±æ¬¡çš„å„ªæƒ åˆ¸ï¼');
return;
}

// æª¢æŸ¥æ˜¯å¦è¶…éæ¯é€±3å€‹å„ªæƒ åˆ¸é™åˆ¶
const voucherCount = getBankVoucherCount(bankId, appState.currentWeek);
if (voucherCount >= 3) {
alert(`${getBankName(bankId)}æœ¬é€±å·²é”3å¼µå„ªæƒ åˆ¸ä¸Šé™ï¼`);
return;
}

appState.preferredBank = bankId;
addVoucher(amount);
});
});

// æ·»åŠ åˆªé™¤æŒ‰éˆ•äº‹ä»¶
document.querySelectorAll('.delete-voucher-btn').forEach(btn => {
btn.addEventListener('click', function() {
const bankId = this.getAttribute('data-bank');
const amount = parseInt(this.getAttribute('data-amount'));

// æ‰¾åˆ°è©²éŠ€è¡Œè©²é¢å€¼çš„æœ€å¾Œä¸€å€‹å„ªæƒ åˆ¸
const voucherToDelete = [...appState.vouchers]
.filter(v => v.bankId === bankId && v.amount === amount)
.pop();

if (voucherToDelete) {
// æª¢æŸ¥æ˜¯å¦æ˜¯éå»é€±æ¬¡çš„æ“ä½œ
const weekNum = getWeekNumberFromDate(voucherToDelete.date);
if (isPastWeek(weekNum)) {
alert('ç„¡æ³•åˆªé™¤éå»é€±æ¬¡çš„å„ªæƒ åˆ¸ï¼');
return;
}
deleteVoucher(voucherToDelete.id);
}
});
});
}

// æ›´æ–°å¯å…‘æ›å„ªæƒ åˆ¸åˆ—è¡¨
function updateRedeemableVouchers() {
const redeemableVouchersList = document.getElementById('redeemable-vouchers-list');
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

document.getElementById('unused-vouchers-count').textContent = redeemableVouchers.length;

if (redeemableVouchers.length === 0) {
redeemableVouchersList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>';
return;
}

// è¨ˆç®—å„é¢å€¼çš„å„ªæƒ åˆ¸æ•¸é‡
const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, total: 0, count: 0};
const bankCounts = {};

banks.forEach(bank => {
bankCounts[bank.id] = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0, total: 0, count: 0};
});

redeemableVouchers.forEach(voucher => {
// æ›´æ–°é¢å€¼ç»Ÿè®¡
valueCounts[voucher.amount]++;
valueCounts.count++;
valueCounts.total += voucher.amount;

// æ›´æ–°é“¶è¡Œç»Ÿè®¡
if (voucher.bankId && bankCounts[voucher.bankId]) {
bankCounts[voucher.bankId][voucher.amount]++;
bankCounts[voucher.bankId].count++;
bankCounts[voucher.bankId].total += voucher.amount;
}
});

// æ˜¾ç¤ºç¸½è¦½
redeemableVouchersList.innerHTML = `
<div class="flex justify-between items-center p-2 bg-primary-50 dark:bg-primary-900/20 rounded">
<div>ç¸½è¨ˆ</div>
<div class="text-right">${valueCounts.count}å¼µ (${valueCounts.total}å…ƒ)</div>
</div>

<div class="grid grid-cols-5 gap-1 text-center my-2">
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[10] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[10]}</div><div class="text-xs">10å…ƒ</div>
</div>
<div class="bg-blue-100 dark:bg-blue-900 rounded p-2 ${valueCounts[20] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[20]}</div><div class="text-xs">20å…ƒ</div>
</div>
<div class="bg-green-100 dark:bg-green-900 rounded p-2 ${valueCounts[50] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[50]}</div><div class="text-xs">50å…ƒ</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[100] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[100]}</div><div class="text-xs">100å…ƒ</div>
</div>
<div class="bg-purple-100 dark:bg-purple-900 rounded p-2 ${valueCounts[200] > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${valueCounts[200]}</div><div class="text-xs">200å…ƒ</div>
</div>
</div>
`;

// æŒ‰éŠ€è¡Œåˆ†çµ„çš„ä¼˜æƒ åˆ¸ä¿¡æ¯
const sortedBanks = banks
.filter(bank => bankCounts[bank.id].count > 0)
.sort((a, b) => bankCounts[b.id].total - bankCounts[a.id].total);

if (sortedBanks.length > 0) {
const bankSummaryDiv = document.createElement('div');
bankSummaryDiv.className = 'mt-3';

// æ¯å€‹éŠ€è¡Œçš„é¢å€¼åˆ†ä½ˆ
sortedBanks.forEach(bank => {
const bankData = bankCounts[bank.id];
const valueBreakdown =
`<div class="text-xs text-gray-500 dark:text-gray-400 pl-6 pt-1">
${bankData[10] > 0 ? `10å…ƒ: ${bankData[10]}å¼µ, ` : ''}
${bankData[20] > 0 ? `20å…ƒ: ${bankData[20]}å¼µ, ` : ''}
${bankData[50] > 0 ? `50å…ƒ: ${bankData[50]}å¼µ, ` : ''}
${bankData[100] > 0 ? `100å…ƒ: ${bankData[100]}å¼µ, ` : ''}
${bankData[200] > 0 ? `200å…ƒ: ${bankData[200]}å¼µ` : ''}
</div>`;

bankSummaryDiv.innerHTML += `
<div class="border-b dark:border-gray-700 last:border-0 pb-2">
<div class="flex justify-between items-center p-2">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span>${bank.name}</span>
</div>
<div>${bankData.count}å¼µ (${bankData.total}å…ƒ)</div>
</div>
${valueBreakdown}
</div>
`;
});

redeemableVouchersList.appendChild(bankSummaryDiv);
}
}

// æ›´æ–°å„ªæƒ åˆ¸é¸æ“‡å€åŸŸ
function updateVoucherSelection() {
const redeemedVoucherSelection = document.getElementById('redeem-voucher-selection');

// ç²å–æœªä½¿ç”¨çš„å¯å…‘æ›å„ªæƒ åˆ¸
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

if (redeemableVouchers.length === 0) {
redeemedVoucherSelection.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>';
return;
}

// æŒ‰éŠ€è¡Œåˆ†çµ„
const vouchersByBank = {};
redeemableVouchers.forEach(voucher => {
if (!vouchersByBank[voucher.bankId]) vouchersByBank[voucher.bankId] = [];
vouchersByBank[voucher.bankId].push(voucher);
});

redeemedVoucherSelection.innerHTML = '';

// æŒ‰éŠ€è¡Œåç¨±æ’åº
const sortedBanks = banks
.filter(bank => vouchersByBank[bank.id] && vouchersByBank[bank.id].length > 0)
.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));

// é¢å€¼é¡è‰²
const amountColors = {
10: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100',
20: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100',
50: 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100',
100: 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-100',
200: 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-100'
};

sortedBanks.forEach(bank => {
const bankVouchers = vouchersByBank[bank.id] || [];

const bankSection = document.createElement('div');
bankSection.className = 'border rounded-lg overflow-hidden';

bankSection.innerHTML = `
<div class="bg-${bank.color} bg-opacity-20 dark:bg-opacity-30 p-2 flex justify-between items-center">
<div class="flex items-center font-bold">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span>${bank.name}</span>
</div>
<div class="flex items-center space-x-2">
<button class="select-all-bank-btn text-xs bg-white dark:bg-gray-700 px-2 py-0.5 rounded"
data-bank="${bank.id}">å…¨é¸</button>
<div class="text-gray-700 dark:text-gray-300">${bankVouchers.length}å¼µ</div>
</div>
</div>
`;

// æŒ‰é¢å€¼åˆ†çµ„
const vouchersByAmount = {};
bankVouchers.forEach(voucher => {
if (!vouchersByAmount[voucher.amount]) vouchersByAmount[voucher.amount] = [];
vouchersByAmount[voucher.amount].push(voucher);
});

// æ·»åŠ å„ªæƒ åˆ¸åˆ—è¡¨
const vouchersList = document.createElement('div');
vouchersList.className = 'p-2 space-y-1 bg-white dark:bg-gray-800';

// æŒ‰é¢å€¼å¾å¤§åˆ°å°é¡¯ç¤º
const amounts = [200, 100, 50, 20, 10].filter(a => vouchersByAmount[a]?.length > 0);

amounts.forEach(amount => {
const amountVouchers = vouchersByAmount[amount] || [];

vouchersList.innerHTML += `
<div class="flex justify-between items-center mb-1">
<div class="flex items-center">
<span class="inline-block w-12 text-center py-1 px-1 rounded text-xs font-medium ${amountColors[amount]}">
${amount}å…ƒ
</span>
</div>
<div class="text-gray-500 dark:text-gray-400">${amountVouchers.length}å¼µ</div>
</div>

<div class="ml-4 space-y-1 mt-1 mb-2">
${amountVouchers.map(voucher => `
<div class="flex items-center space-x-2">
<input type="checkbox" id="voucher-${voucher.id}" class="voucher-checkbox"
data-id="${voucher.id}" data-amount="${voucher.amount}"
${appState.selectedVouchers.includes(voucher.id) ? 'checked' : ''}>
<label for="voucher-${voucher.id}" class="text-sm">
${amount}å…ƒ å„ªæƒ åˆ¸
</label>
</div>
`).join('')}
</div>
`;
});

bankSection.appendChild(vouchersList);
redeemedVoucherSelection.appendChild(bankSection);
});

// æ·»åŠ å…¨é¸éŠ€è¡Œäº‹ä»¶
document.querySelectorAll('.select-all-bank-btn').forEach(btn => {
btn.addEventListener('click', function() {
const bankId = this.getAttribute('data-bank');
const bankVouchers = redeemableVouchers
.filter(v => v.bankId === bankId)
.map(v => v.id);

// æ·»åŠ éŠ€è¡Œæ‰€æœ‰å„ªæƒ åˆ¸åˆ°å·²é¸æ“‡åˆ—è¡¨
bankVouchers.forEach(id => {
if (!appState.selectedVouchers.includes(id)) {
appState.selectedVouchers.push(id);
}
});

saveAppState();
updateVoucherSelection();
updateSelectedVouchers();
});
});

// æ·»åŠ è¤‡é¸æ¡†äº‹ä»¶
document.querySelectorAll('.voucher-checkbox').forEach(checkbox => {
checkbox.addEventListener('change', function() {
const voucherId = this.getAttribute('data-id');

if (this.checked) {
if (!appState.selectedVouchers.includes(voucherId)) {
appState.selectedVouchers.push(voucherId);
}
} else {
appState.selectedVouchers = appState.selectedVouchers.filter(id => id !== voucherId);
}

saveAppState();
updateSelectedVouchers();
});
});

// è¨­ç½®æ¶ˆè²»é¡åˆ¥é¸æ“‡äº‹ä»¶
document.querySelectorAll('.expense-category').forEach(checkbox => {
checkbox.addEventListener('change', function() {
// ä¸éœ€è¦è™•ç†ä»»ä½•ç‹€æ…‹è®Šæ›´ï¼Œå› ç‚ºé€™äº›å°‡åœ¨å…‘æ›æ™‚ä¸€æ¬¡æ€§æ”¶é›†
});
});
}

// æ›´æ–°å·²é¸æ“‡çš„å„ªæƒ åˆ¸åˆ—è¡¨
function updateSelectedVouchers() {
const redeemOperations = document.getElementById('redeem-operations');
const selectionSummary = document.getElementById('selection-summary');

// ç²å–å·²é¸æ“‡çš„æœªä½¿ç”¨å„ªæƒ åˆ¸
const selectedVouchers = appState.selectedVouchers
.map(id => appState.vouchers.find(v => v.id === id))
.filter(isVoucherRedeemable);

// æ›´æ–°é¸æ“‡æ‘˜è¦
document.getElementById('selected-vouchers-count').textContent = selectedVouchers.length;
document.getElementById('selected-vouchers-value').textContent = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);

// é¡¯ç¤ºç‹€æ…‹åŠéš±è—å…‘æ›å€åŸŸ
if (selectedVouchers.length === 0) {
redeemOperations.classList.add('hidden');
selectionSummary.style.visibility = 'hidden';
} else {
redeemOperations.classList.remove('hidden');
selectionSummary.style.visibility = 'visible';

// è¨ˆç®—ç¸½å€¼
const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);

// è¨­ç½®æœ€å°å…‘æ›é‡‘é¡
document.getElementById('min-redeem-amount').textContent = totalValue * 3;
}

// æ·»åŠ å…‘æ›æŒ‰éˆ•äº‹ä»¶
document.getElementById('redeem-selected-vouchers').onclick = function() {
const spendAmount = parseInt(document.getElementById('manual-spend-amount').value);

// æ”¶é›†é¸ä¸­çš„æ¶ˆè²»é¡åˆ¥
const selectedCategories = Array.from(document.querySelectorAll('.expense-category:checked')).map(
checkbox => checkbox.value
);

// å¦‚æœæ²’æœ‰é¸æ“‡é¡åˆ¥ï¼Œé è¨­ç‚ºã€Œå…¶ä»–ã€
if (selectedCategories.length === 0) {
selectedCategories.push('other');
}

const remark = document.getElementById('redeem-remark').value.trim();
showRedeemConfirmation(spendAmount, selectedCategories, remark);
};
}

// é¡¯ç¤ºå…‘æ›ç¢ºèª
function showRedeemConfirmation(userSpendAmount, categories, remark) {
// ç²å–é¸ä¸­çš„æœªä½¿ç”¨å„ªæƒ åˆ¸
const selectedVouchers = appState.selectedVouchers
.map(id => appState.vouchers.find(v => v.id === id))
.filter(isVoucherRedeemable);

if (selectedVouchers.length === 0) {
alert('è«‹å…ˆé¸æ“‡è¦å…‘æ›çš„å„ªæƒ åˆ¸ï¼');
return;
}

// è¨ˆç®—ç¸½å€¼å’Œæ‰€éœ€æ¶ˆè²»é‡‘é¡
const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);
const requiredAmount = totalValue * 3;

// æª¢æŸ¥ç”¨æˆ¶è¼¸å…¥çš„æ¶ˆè²»é‡‘é¡æ˜¯å¦è¶³å¤ 
if (userSpendAmount && userSpendAmount < requiredAmount) {
alert(`æ¶ˆè²»é‡‘é¡å¿…é ˆè‡³å°‘ç‚º${requiredAmount}å…ƒæ‰èƒ½å…‘æ›æ‰€é¸å„ªæƒ åˆ¸ï¼`);
return;
}

// ä½¿ç”¨ç”¨æˆ¶è¼¸å…¥çš„é‡‘é¡æˆ–æœ€ä½éœ€æ±‚é‡‘é¡
const spendAmount = userSpendAmount || requiredAmount;

// æŒ‰éŠ€è¡Œçµ±è¨ˆ
const bankSummary = {};
selectedVouchers.forEach(voucher => {
if (!bankSummary[voucher.bankId]) {
bankSummary[voucher.bankId] = { count: 0, value: 0 };
}
bankSummary[voucher.bankId].count++;
bankSummary[voucher.bankId].value += voucher.amount;
});

// ç”Ÿæˆç¢ºèªä¿¡æ¯
let infoHTML = `
<div class="mb-3">
<div class="font-medium">å„ªæƒ åˆ¸æ•¸é‡: ${selectedVouchers.length}å¼µ</div>
<div class="font-medium text-primary">æ¶ˆè²»é‡‘é¡: ${spendAmount}å…ƒ</div>
<div class="text-green-600 dark:text-green-400">ç¯€çœé‡‘é¡: ${totalValue}å…ƒ</div>
<div class="text-gray-500 dark:text-gray-400">è‡ªè²»é‡‘é¡: ${spendAmount - totalValue}å…ƒ</div>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">æœ€ä½éœ€æ¶ˆè²»é‡‘é¡: ${requiredAmount}å…ƒ</div>
</div>
`;

// é¡¯ç¤ºæ¶ˆè²»é¡åˆ¥
if (categories && categories.length > 0) {
infoHTML += `<div class="mb-3">
<div class="font-medium">æ¶ˆè²»é¡åˆ¥:</div>
<div class="flex flex-wrap gap-1 mt-1">
${categories.map(cat => `
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700">
<i class="${getCategoryIcon(cat)} mr-1"></i> ${getCategoryName(cat)}
</span>
`).join('')}
</div>
</div>`;
}

// æ·»åŠ å‚™è¨»
if (remark) {
infoHTML += `<div class="mb-3">
<div class="font-medium">æ¶ˆè²»å‚™è¨»:</div>
<div class="text-sm mt-1 p-2 bg-gray-50 dark:bg-gray-700 rounded">${remark}</div>
</div>`;
}

// æ·»åŠ éŠ€è¡Œçµ±è¨ˆ
infoHTML += `<div class="text-sm">æŒ‰éŠ€è¡Œçµ±è¨ˆ:</div>`;

// æŒ‰é‡‘é¡æ’åºéŠ€è¡Œ
const sortedBankSummary = banks
.filter(bank => bankSummary[bank.id])
.sort((a, b) => bankSummary[b.id].value - bankSummary[a.id].value);

sortedBankSummary.forEach(bank => {
if (bankSummary[bank.id]) {
infoHTML += `
<div class="flex items-center justify-between text-sm">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
<span>${bank.name}:</span>
</div>
<div>${bankSummary[bank.id].count}å¼µ (${bankSummary[bank.id].value}å…ƒ)</div>
</div>
`;
}
});

// é¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
document.getElementById('redeem-vouchers-info').innerHTML = infoHTML;
document.getElementById('confirm-redeem-modal').classList.remove('hidden');

// ä¿å­˜è‡¨æ™‚é¸æ“‡çš„å„ªæƒ åˆ¸ã€é¡åˆ¥å’Œå‚™è¨»
tempSelectedVouchers = [...selectedVouchers];
tempRedeemCategories = [...categories];
tempRedeemRemark = remark;

// ç¢ºèªå…‘æ›
document.getElementById('confirm-redeem').onclick = function() {
redeemVouchers(spendAmount, categories, remark);
document.getElementById('confirm-redeem-modal').classList.add('hidden');
};

// å–æ¶ˆå…‘æ›
document.getElementById('cancel-redeem').onclick = function() {
document.getElementById('confirm-redeem-modal').classList.add('hidden');
};
}

// å…‘æ›å„ªæƒ åˆ¸
function redeemVouchers(spendAmount, categories, remark) {
// æª¢æŸ¥åƒæ•¸å’Œè‡¨æ™‚é¸ä¸­çš„å„ªæƒ åˆ¸
if (!tempSelectedVouchers || tempSelectedVouchers.length === 0) {
console.error("æ²’æœ‰é¸ä¸­çš„å„ªæƒ åˆ¸å¯ä¾›å…‘æ›");
alert("å…‘æ›å¤±æ•—ï¼šæ²’æœ‰é¸ä¸­çš„å„ªæƒ åˆ¸");
return;
}

if (!spendAmount || isNaN(spendAmount) || spendAmount <= 0) {
console.error("æ¶ˆè²»é‡‘é¡ç„¡æ•ˆ:", spendAmount);
alert("å…‘æ›å¤±æ•—ï¼šè«‹è¼¸å…¥æœ‰æ•ˆçš„æ¶ˆè²»é‡‘é¡");
return;
}

try {
console.log("åŸ·è¡Œå…‘æ›æ“ä½œï¼Œé¸ä¸­å„ªæƒ åˆ¸:", tempSelectedVouchers.length, "å¼µ");

// è¨ˆç®—ç¸½å€¼
const totalValue = tempSelectedVouchers.reduce((sum, v) => sum + (v.amount || 0), 0);

// æª¢æŸ¥æœ€ä½æ¶ˆè²»è¦æ±‚
const requiredAmount = totalValue * 3;
if (spendAmount < requiredAmount) {
alert(`æ¶ˆè²»é‡‘é¡å¿…é ˆè‡³å°‘ç‚º${requiredAmount}å…ƒæ‰èƒ½å…‘æ›æ‰€é¸å„ªæƒ åˆ¸ï¼`);
return;
}

// è¨˜éŒ„å…‘æ›æ­·å²
const redemption = {
id: Date.now().toString(),
displayId: appState.nextRedemptionId,
date: new Date().toISOString(),
vouchers: tempSelectedVouchers.map(v => ({
id: v.id,
amount: v.amount,
bankId: v.bankId
})),
voucherCount: tempSelectedVouchers.length,
voucherValue: totalValue,
spendAmount: spendAmount,
categories: categories || ['other'], // é»˜èªç‚ºå…¶ä»–é¡åˆ¥
remark: tempRedeemRemark || remark,
weekNum: appState.currentWeek,
withdrawn: false // æ–°å¢æ ‡è®°ï¼Œè¡¨ç¤ºè¯¥è®°å½•æœªè¢«æ’¤å›
};

appState.redemptionHistory.push(redemption);
appState.nextRedemptionId++; // å¢åŠ æ¶ˆè²»ç·¨è™Ÿ

// æ¨™è¨˜å„ªæƒ åˆ¸ç‚ºå·²ä½¿ç”¨
let markedCount = 0;
tempSelectedVouchers.forEach(voucher => {
const v = appState.vouchers.find(v => v.id === voucher.id);
if (v) {
v.used = true;
markedCount++;
}
});

console.log(`æˆåŠŸæ¨™è¨˜ ${markedCount}/${tempSelectedVouchers.length} å¼µå„ªæƒ åˆ¸ç‚ºå·²ä½¿ç”¨`);

// æ¸…ç©ºé¸æ“‡åˆ—è¡¨å’Œè¼¸å…¥æ¬„ä½
appState.selectedVouchers = [];
document.getElementById('manual-spend-amount').value = '';
document.getElementById('redeem-remark').value = '';

// æ¸…ç©ºé¡åˆ¥é¸æ“‡
document.querySelectorAll('.expense-category').forEach(checkbox => {
checkbox.checked = false;
});

// æ›´æ–°é€±æ¬¡è¨˜éŒ„æ¶ˆè²»é‡‘é¡
updateWeekRecord(appState.currentWeek, spendAmount);

// ä¿å­˜ä¸¦æ›´æ–°UI
saveAppState();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateWeekRecordsDisplay();
updateRedemptionHistory();
updateDetailedAnalysis();
updateCharts();

alert(`æˆåŠŸå…‘æ›${tempSelectedVouchers.length}å¼µå„ªæƒ åˆ¸ï¼æ¶ˆè²»é‡‘é¡: ${spendAmount}å…ƒ`);
} catch (error) {
console.error("å…‘æ›éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:", error);
alert(`å…‘æ›å¤±æ•—ï¼š${error.message || "æœªçŸ¥éŒ¯èª¤"}`);
} finally {
// ç¢ºä¿ç„¡è«–æˆåŠŸæˆ–å¤±æ•—éƒ½æ¸…ç©ºè‡¨æ™‚è®Šé‡
tempSelectedVouchers = [];
tempRedeemCategories = [];
tempRedeemRemark = '';
}
}

// æ’¤å›å…‘æ› (ä¿®æ”¹ä¸ºæ ‡è®°è€Œä¸æ˜¯åˆ é™¤)
function withdrawRedemption(redemptionId) {
// æŸ¥æ‰¾å…‘æ›è¨˜éŒ„
const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);

if (!redemption) {
alert('æ‰¾ä¸åˆ°æŒ‡å®šçš„å…‘æ›è¨˜éŒ„ï¼');
return false;
}

// æª¢æŸ¥å„ªæƒ åˆ¸æ˜¯å¦å­˜åœ¨
let allVouchersExist = true;
redemption.vouchers.forEach(voucherInfo => {
const voucher = appState.vouchers.find(v => v.id === voucherInfo.id);
if (!voucher) {
allVouchersExist = false;
}
});

if (!allVouchersExist) {
alert('éƒ¨åˆ†å„ªæƒ åˆ¸è¨˜éŒ„å·²ä¸å­˜åœ¨ï¼Œç„¡æ³•æ’¤å›å…‘æ›ï¼');
return false;
}

// å°‡å„ªæƒ åˆ¸ç‹€æ…‹æ”¹ç‚ºæœªä½¿ç”¨
redemption.vouchers.forEach(voucherInfo => {
const voucher = appState.vouchers.find(v => v.id === voucherInfo.id);
if (voucher) {
voucher.used = false;
}
});

// æ¨™è¨˜å…‘æ›è¨˜éŒ„ç‚ºå·²æ’¤å›ï¼Œè€Œä¸æ˜¯åˆªé™¤å®ƒ
redemption.withdrawn = true;

// æ›´æ–°é€±æ¬¡è¨˜éŒ„æ¶ˆè²»é‡‘é¡ï¼ˆæ¸›æ‰æ’¤å›çš„æ¶ˆè²»é‡‘é¡ï¼‰
updateWeekRecord(redemption.weekNum, -redemption.spendAmount);

// ä¿å­˜ä¸¦æ›´æ–°UI
saveAppState();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateWeekRecordsDisplay();
updateRedemptionHistory();
updateDetailedAnalysis();
updateCharts();

return true;
}

// é¡¯ç¤ºæ’¤å›å…‘æ›ç¢ºèªæ¡†
function showWithdrawConfirmation(redemptionId) {
const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);
if (!redemption) return;

// æŒ‰éŠ€è¡Œçµ±è¨ˆ
const bankSummary = {};
redemption.vouchers.forEach(voucher => {
if (!bankSummary[voucher.bankId]) {
bankSummary[voucher.bankId] = { count: 0, value: 0 };
}
bankSummary[voucher.bankId].count++;
bankSummary[voucher.bankId].value += voucher.amount;
});

// ç”Ÿæˆç¢ºèªä¿¡æ¯
let infoHTML = `
<div class="mb-3">
<div class="font-medium">å…‘æ›è¨˜éŒ„ #${formatRedemptionId(redemption.displayId)}</div>
<div class="text-sm text-gray-600 dark:text-gray-400">${new Date(redemption.date).toLocaleString()}</div>
<div class="mt-2 space-y-1">
<div>å„ªæƒ åˆ¸æ•¸é‡: ${redemption.voucherCount}å¼µ</div>
<div>å„ªæƒ åˆ¸ç¸½å€¼: ${redemption.voucherValue}å…ƒ</div>
<div>æ¶ˆè²»é‡‘é¡: ${redemption.spendAmount}å…ƒ</div>
</div>
</div>
`;

// æ·»åŠ éŠ€è¡Œçµ±è¨ˆ
infoHTML += `<div class="text-sm font-medium mt-2">å„ªæƒ åˆ¸æ˜ç´°:</div>`;

// æŒ‰é‡‘é¡æ’åºéŠ€è¡Œ
const sortedBankSummary = banks
.filter(bank => bankSummary[bank.id])
.sort((a, b) => bankSummary[b.id].value - bankSummary[a.id].value);

sortedBankSummary.forEach(bank => {
if (bankSummary[bank.id]) {
infoHTML += `
<div class="flex items-center justify-between text-sm">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
<span>${bank.name}:</span>
</div>
<div>${bankSummary[bank.id].count}å¼µ (${bankSummary[bank.id].value}å…ƒ)</div>
</div>
`;
}
});

// é¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
document.getElementById('withdraw-vouchers-info').innerHTML = infoHTML;
document.getElementById('confirm-withdraw-modal').classList.remove('hidden');

// ç¢ºèªæ’¤å›
document.getElementById('confirm-withdraw').onclick = function() {
const success = withdrawRedemption(redemptionId);
document.getElementById('confirm-withdraw-modal').classList.add('hidden');

if (success) {
// é—œé–‰å…‘æ›è¨˜éŒ„è©³æƒ…æ¨¡æ…‹æ¡†
document.getElementById('redemption-detail-modal').classList.add('hidden');
alert('å·²æˆåŠŸæ’¤å›å…‘æ›ï¼Œå„ªæƒ åˆ¸å·²æ¢å¾©ç‚ºæœªä½¿ç”¨ç‹€æ…‹ï¼');
}
};

// å–æ¶ˆæ’¤å›
document.getElementById('cancel-withdraw').onclick = function() {
document.getElementById('confirm-withdraw-modal').classList.add('hidden');
};
}

// æ›´æ–°é€±æ¬¡è¨˜éŒ„
function updateWeekRecords() {
// ç¢ºä¿æ¯é€±éƒ½æœ‰è¨˜éŒ„
for (let weekNum = 1; weekNum <= 10; weekNum++) {
// æª¢æŸ¥æ˜¯å¦å·²æœ‰è©²é€±æ¬¡è¨˜éŒ„
let weekRecord = appState.weekRecords.find(r => r.weekNum === weekNum);

if (!weekRecord) {
weekRecord = createWeekRecord(weekNum);
appState.weekRecords.push(weekRecord);
} else {
// æ›´æ–°ç¾æœ‰è¨˜éŒ„çš„å„ªæƒ åˆ¸æ•¸æ“š
updateWeekRecordData(weekRecord);
}
}

// æŒ‰é€±æ¬¡æ’åº
appState.weekRecords.sort((a, b) => a.weekNum - b.weekNum);

saveAppState();
}

// å‰µå»ºé€±æ¬¡è¨˜éŒ„
function createWeekRecord(weekNum) {
const weekData = weekSchedule[weekNum - 1];
if (!weekData) return null;

const record = {
id: Date.now().toString() + weekNum,
weekNum: weekNum,
startDate: weekData.startDate,
endDate: weekData.endDate,
createdAt: new Date().toISOString(),
notes: '',
voucherCount: 0,
voucherValue: 0,
valueCounts: [0, 0, 0, 0, 0, 0], // 0å…ƒ, 10, 20, 50, 100, 200
bankCounts: {},
usedCount: 0,
spendAmount: 0,
// å¢åŠ å¯å…‘æ›çµ±è¨ˆ
redeemableCount: 0,
redeemableValue: 0
};

updateWeekRecordData(record);
return record;
}

// æ›´æ–°é€±æ¬¡è¨˜éŒ„æ•¸æ“š
function updateWeekRecordData(record) {
const weekNum = record.weekNum;

// é‡ç½®è¨ˆæ•¸
record.voucherCount = 0;
record.voucherValue = 0;
record.valueCounts = [0, 0, 0, 0, 0, 0];
record.usedCount = 0;
record.redeemableCount = 0;
record.redeemableValue = 0;

// åˆå§‹åŒ–éŠ€è¡Œè¨ˆæ•¸
const bankCounts = {};
banks.forEach(bank => {
bankCounts[bank.id] = {
count: 0,
value: 0,
redeemable: { count: 0, value: 0 } // æ·»åŠ å¯å…‘æ›çµ±è¨ˆ
};
});

// ç²å–è©²é€±çš„å„ªæƒ åˆ¸
const weekVouchers = appState.vouchers.filter(voucher => {
return getWeekNumberFromDate(voucher.date) === weekNum;
});

// æ›´æ–°è¨ˆæ•¸
weekVouchers.forEach(voucher => {
record.voucherCount++;

// æ›´æ–°é¢å€¼çµ±è¨ˆ
switch(voucher.amount) {
case 0: record.valueCounts[0]++; break;
case 10: record.valueCounts[1]++; record.voucherValue += 10; break;
case 20: record.valueCounts[2]++; record.voucherValue += 20; break;
case 50: record.valueCounts[3]++; record.voucherValue += 50; break;
case 100: record.valueCounts[4]++; record.voucherValue += 100; break;
case 200: record.valueCounts[5]++; record.voucherValue += 200; break;
}

// æ›´æ–°å·²ä½¿ç”¨çµ±è¨ˆ
if (voucher.used) {
record.usedCount++;
}

// æ›´æ–°å¯å…‘æ›çµ±è¨ˆ
if (isVoucherRedeemable(voucher)) {
record.redeemableCount++;
record.redeemableValue += voucher.amount;
}

// æ›´æ–°éŠ€è¡Œçµ±è¨ˆ
if (voucher.bankId && bankCounts[voucher.bankId]) {
bankCounts[voucher.bankId].count++;
bankCounts[voucher.bankId].value += voucher.amount;

// æ›´æ–°å¯å…‘æ›çµ±è¨ˆ
if (isVoucherRedeemable(voucher)) {
bankCounts[voucher.bankId].redeemable.count++;
bankCounts[voucher.bankId].redeemable.value += voucher.amount;
}
}
});

// æ›´æ–°éŠ€è¡Œçµ±è¨ˆ
record.bankCounts = bankCounts;
}

// æ›´æ–°é€±æ¬¡è¨˜éŒ„æ¶ˆè²»é‡‘é¡
function updateWeekRecord(weekNum, amount) {
if (weekNum < 1 || weekNum > 10) return;

// æŸ¥æ‰¾é€±æ¬¡è¨˜éŒ„
const record = appState.weekRecords.find(r => r.weekNum === weekNum);
if (record) {
record.spendAmount = (record.spendAmount || 0) + amount;
}
}

// æ›´æ–°é€±æ¬¡è¨˜éŒ„é¡¯ç¤º
function updateWeekRecordsDisplay() {
const weekRecordsList = document.getElementById('week-records-list');
const weekHistorySelect = document.getElementById('week-history-select');

// æ›´æ–°é€±æ¬¡é¸æ“‡å™¨
weekHistorySelect.innerHTML = '<option value="">-- é¸æ“‡é€±æ¬¡ --</option>';
weekSchedule.forEach(week => {
const option = document.createElement('option');
option.value = week.week;
option.textContent = `ç¬¬${week.week}é€± (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
weekHistorySelect.appendChild(option);
});

// æŒ‰é€±æ¬¡æ’åºï¼ˆå‡åºï¼‰
const sortedRecords = [...appState.weekRecords].sort((a, b) => a.weekNum - b.weekNum);

if (sortedRecords.length === 0) {
weekRecordsList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8">å°šç„¡é€±æ¬¡è¨˜éŒ„</div>';
return;
}

weekRecordsList.innerHTML = '';

sortedRecords.forEach(record => {
// éæ¿¾æœ‰æ•¸æ“šçš„éŠ€è¡Œ
let bankHTML = '';
let bankCount = 0;

// è®¡ç®—å¯å…‘æ¢ä¼˜æƒ åˆ¸ç¸½æ•¸
const redeemableCount = record.redeemableCount || (record.valueCounts[1] + record.valueCounts[2] +
record.valueCounts[3] + record.valueCounts[4] + record.valueCounts[5] - record.usedCount);
const redeemableValue = record.redeemableValue || record.voucherValue -
(10 * record.valueCounts[1] + 20 * record.valueCounts[2] +
50 * record.valueCounts[3] + 100 * record.valueCounts[4] +
200 * record.valueCounts[5]);

banks.forEach(bank => {
const bankData = record.bankCounts?.[bank.id];
if (bankData && bankData.count > 0) {
bankCount++;

// è®¡ç®—å¯å…‘æ¢æ•°é‡
const redeemableStats = bankData.redeemable || { count: 0, value: 0 };

bankHTML += `
<div class="flex items-center mb-1 text-xs">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
<span>${bank.name}: ${bankData.count}å¼µ (${bankData.value}å…ƒ)</span>
${redeemableStats.count > 0 ?
`<span class="ml-2 text-green-600 dark:text-green-400">å¯å…‘æ›: ${redeemableStats.count}å¼µ</span>` : ''}
</div>
`;
}
});

// å‰µå»ºè¨˜éŒ„å¡ç‰‡
const recordItem = document.createElement('div');
recordItem.className = 'border rounded-lg bg-white dark:bg-gray-800 overflow-hidden';
recordItem.innerHTML = `
<div class="px-4 py-3">
<div class="flex justify-between items-start mb-2">
<div class="font-bold text-lg">ç¬¬${record.weekNum}é€±è¨˜éŒ„</div>
<div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
</div>
<div class="grid grid-cols-2 gap-3 mb-3">
<div>
<div class="text-sm text-gray-500 dark:text-gray-400">ç¸½å„ªæƒ åˆ¸</div>
<div class="font-bold text-lg">${record.voucherCount}å¼µ</div>
</div>
<div>
<div class="text-sm text-gray-500 dark:text-gray-400">ç¸½åƒ¹å€¼</div>
<div class="font-bold text-lg">${record.voucherValue}å…ƒ</div>
</div>
</div>
<div class="grid grid-cols-2 gap-3 mb-3">
<div>
<div class="text-sm text-gray-500 dark:text-gray-400">å¯å…‘æ›</div>
<div class="font-bold text-lg text-green-600 dark:text-green-400">${redeemableCount}å¼µ</div>
</div>
<div>
<div class="text-sm text-gray-500 dark:text-gray-400">å·²å…‘æ›</div>
<div class="font-bold text-lg">${record.usedCount}å¼µ</div>
</div>
</div>
<div class="text-sm text-gray-600 dark:text-gray-300 mb-1">å„ªæƒ åˆ¸åˆ†ä½ˆï¼š</div>
<div class="text-sm mb-2">
${record.valueCounts[0] > 0 ? `<span class="mr-2">ğŸ˜„: ${record.valueCounts[0]}å¼µ</span>` : ''}
${record.valueCounts[1] > 0 ? `<span class="mr-2">10å…ƒ: ${record.valueCounts[1]}å¼µ</span>` : ''}
${record.valueCounts[2] > 0 ? `<span class="mr-2">20å…ƒ: ${record.valueCounts[2]}å¼µ</span>` : ''}
${record.valueCounts[3] > 0 ? `<span class="mr-2">50å…ƒ: ${record.valueCounts[3]}å¼µ</span>` : ''}
${record.valueCounts[4] > 0 ? `<span class="mr-2">100å…ƒ: ${record.valueCounts[4]}å¼µ</span>` : ''}
${record.valueCounts[5] > 0 ? `<span class="mr-2">200å…ƒ: ${record.valueCounts[5]}å¼µ</span>` : ''}
</div>
${bankCount > 0 ? `
<div class="text-sm text-gray-600 dark:text-gray-300 mb-1">éŠ€è¡Œåˆ†ä½ˆï¼š</div>
<div class="mb-2">${bankHTML}</div>
` : ''}
${record.notes ? `
<div class="text-sm text-gray-600 dark:text-gray-300 mb-1">å‚™è¨»ï¼š</div>
<div class="text-sm mb-2">${record.notes}</div>
` : ''}
</div>
<div class="border-t px-3 py-2 flex justify-end">
<button class="text-sm text-primary dark:text-primary hover:underline view-week-detail-btn" data-id="${record.id}">æŸ¥çœ‹è©³æƒ…</button>
</div>
`;

weekRecordsList.appendChild(recordItem);
});

// æ·»åŠ æŸ¥çœ‹è©³æƒ…äº‹ä»¶
document.querySelectorAll('.view-week-detail-btn').forEach(btn => {
btn.addEventListener('click', function() {
showWeekDetail(this.getAttribute('data-id'));
});
});

// æ·»åŠ é€±æ¬¡é¸æ“‡äº‹ä»¶
weekHistorySelect.onchange = function() {
if (this.value) {
const weekNum = parseInt(this.value);
const weekRecord = appState.weekRecords.find(r => r.weekNum === weekNum);
if (weekRecord) {
showWeekDetail(weekRecord.id);
}
}
};
}

// é¡¯ç¤ºé€±æ¬¡è©³æƒ…
function showWeekDetail(recordId) {
const record = appState.weekRecords.find(r => r.id === recordId);
if (!record) return;

const weekDetailModal = document.getElementById('week-detail-modal');
const weekDetailTitle = document.getElementById('week-detail-title');
const weekDetailContent = document.getElementById('week-detail-content');

// è¨ˆç®—å·²ä½¿ç”¨ç‡
const usedPercentage = record.voucherCount > 0 ? Math.round((record.usedCount / record.voucherCount) * 100) : 0;

// è®¡ç®—å¯å…‘æ¢ä¼˜æƒ åˆ¸ç¸½æ•¸ (æ’é™¤ç¬‘è‡‰)
const redeemableCount = record.redeemableCount ||
(record.voucherCount - record.usedCount - record.valueCounts[0]);

// æ›´æ–°æ¨™é¡Œå’Œå…§å®¹
weekDetailTitle.textContent = `ç¬¬${record.weekNum}é€±è©³ç´°è¨˜éŒ„`;
weekDetailContent.innerHTML = `
<div class="space-y-4">
<div>
<div class="text-sm text-gray-500 dark:text-gray-400">è¨˜éŒ„æ™‚é–“</div>
<div>${new Date(record.createdAt).toLocaleString()}</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400">é€±æœŸç¯„åœ</div>
<div>${formatDate(record.startDate)} - ${formatDate(record.endDate)}</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„ªæƒ åˆ¸ä½¿ç”¨æƒ…æ³</div>
<div class="flex justify-between mb-1">
<div>ç¸½æ•¸: ${record.voucherCount}å¼µ</div>
<div>ç¸½å€¼: ${record.voucherValue}å…ƒ</div>
</div>
<div class="flex justify-between mb-1">
<div>å·²å…‘æ›: ${record.usedCount}å¼µ</div>
<div>å¯å…‘æ›: ${redeemableCount}å¼µ</div>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
<div class="bg-primary h-2.5 rounded-full" style="width: ${usedPercentage}%"></div>
</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">æ¶ˆè²»é‡‘é¡</div>
<div class="font-bold text-lg">${record.spendAmount || 0}å…ƒ</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„ªæƒ åˆ¸é¢å€¼åˆ†ä½ˆ</div>
<div class="grid grid-cols-6 gap-2 mb-2">
<div class="text-center">
<div class="text-sm font-bold">${record.valueCounts[0] || 0}</div>
<div class="text-xs">ğŸ˜„</div>
</div>
<div class="text-center">
<div class="text-sm font-bold">${record.valueCounts[1] || 0}</div>
<div class="text-xs">10å…ƒ</div>
</div>
<div class="text-center">
<div class="text-sm font-bold">${record.valueCounts[2] || 0}</div>
<div class="text-xs">20å…ƒ</div>
</div>
<div class="text-center">
<div class="text-sm font-bold">${record.valueCounts[3] || 0}</div>
<div class="text-xs">50å…ƒ</div>
</div>
<div class="text-center">
<div class="text-sm font-bold">${record.valueCounts[4] || 0}</div>
<div class="text-xs">100å…ƒ</div>
</div>
<div class="text-center">
<div class="text-sm font-bold">${record.valueCounts[5] || 0}</div>
<div class="text-xs">200å…ƒ</div>
</div>
</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„éŠ€è¡Œå„ªæƒ åˆ¸</div>
<div class="space-y-1">
${banks.map(bank => {
const bankData = record.bankCounts?.[bank.id];
if (!bankData || bankData.count === 0) return '';

// è®¡ç®—å¯å…‘æ¢çš„ä¼˜æƒ åˆ¸
const redeemableStats = bankData.redeemable || { count: 0, value: 0 };

return `
<div class="flex items-center justify-between">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span>${bank.name}</span>
</div>
<div>${bankData.count}å¼µ (${bankData.value}å…ƒ)
${redeemableStats.count > 0 ?
`<span class="ml-1 text-green-600 dark:text-green-400">å¯å…‘æ›: ${redeemableStats.count}å¼µ</span>` : ''}
</div>
</div>
`;
}).join('')}
</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„éŠ€è¡Œæœ¬é€±å„ªæƒ åˆ¸</div>
<div class="space-y-1 border rounded-lg p-2">
${banks.map(bank => {
const count = getBankVoucherCount(bank.id, record.weekNum);
return `
<div class="flex items-center justify-between">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span>${bank.name}</span>
</div>
<div>${count}/3å¼µ</div>
</div>
`;
}).join('')}
</div>
</div>

${record.notes ? `
<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å‚™è¨»</div>
<div class="border rounded-lg p-2">${record.notes}</div>
</div>
` : ''}
</div>
`;

// é¡¯ç¤ºæ¨¡æ…‹æ¡†
weekDetailModal.classList.remove('hidden');

// æ·»åŠ é—œé–‰æŒ‰éˆ•äº‹ä»¶
document.getElementById('close-detail-btn').onclick = function() {
weekDetailModal.classList.add('hidden');
};

document.getElementById('close-week-detail').onclick = function() {
weekDetailModal.classList.add('hidden');
};
}

// æ›´æ–°å…‘æ›è¨˜éŒ„åˆ—è¡¨
function updateRedemptionHistory() {
const redemptionHistoryList = document.getElementById('redemption-history-list');
const redeemedTotalCount = document.getElementById('redeemed-total-count');

// è¨ˆç®—ç¸½å·²å…‘æ›å„ªæƒ åˆ¸æ•¸é‡ (åŒ…æ‹¬å·²æ’¤å›çš„ä½†æœƒé¡¯ç¤ºæ¨™è¨˜)
const totalRedeemed = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherCount, 0);
redeemedTotalCount.textContent = totalRedeemed;

// å¦‚æœæ²’æœ‰å…‘æ›è¨˜éŒ„
if (appState.redemptionHistory.length === 0) {
redemptionHistoryList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">å°šç„¡å…‘æ›è¨˜éŒ„</div>';
return;
}

// æŒ‰æ—¥æœŸé™åºæ’åº
const sortedHistory = [...appState.redemptionHistory].sort((a, b) => new Date(b.date) - new Date(a.date));

// æ¸…ç©ºåˆ—è¡¨
redemptionHistoryList.innerHTML = '';

// æ·»åŠ æ¯æ¢å…‘æ›è¨˜éŒ„
sortedHistory.forEach(redemption => {
const redemptionDate = new Date(redemption.date);
const weekData = weekSchedule[redemption.weekNum - 1] || {};

// æŒ‰éŠ€è¡Œåˆ†çµ„å„ªæƒ åˆ¸
const vouchersByBank = {};
redemption.vouchers.forEach(voucher => {
if (!vouchersByBank[voucher.bankId]) {
vouchersByBank[voucher.bankId] = [];
}
vouchersByBank[voucher.bankId].push(voucher);
});

// ç”ŸæˆéŠ€è¡Œå„ªæƒ åˆ¸ä¿¡æ¯HTML
let bankVouchersHTML = '';
banks.forEach(bank => {
const bankVouchers = vouchersByBank[bank.id] || [];
if (bankVouchers.length > 0) {
// è¨ˆç®—è©²éŠ€è¡Œçš„ç¸½å€¼
const bankTotal = bankVouchers.reduce((sum, v) => sum + v.amount, 0);

bankVouchersHTML += `
<div class="flex items-center justify-between mb-1 text-xs">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
<span>${bank.name}</span>
</div>
<div>${bankVouchers.length}å¼µ (${bankTotal}å…ƒ)</div>
</div>
`;
}
});

// é¡¯ç¤ºæ¶ˆè²»é¡åˆ¥
let categoriesHTML = '';
if (redemption.categories && redemption.categories.length > 0) {
categoriesHTML = `
<div class="mb-1 flex flex-wrap gap-1">
${redemption.categories.map(category => `
<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
style="background-color: ${getCategoryColor(category)}20; color: ${getCategoryColor(category)}">
<i class="${getCategoryIcon(category)} mr-1"></i> ${getCategoryName(category)}
</span>
`).join('')}
</div>
`;
}

// å‰µå»ºè¨˜éŒ„å¡ç‰‡
const card = document.createElement('div');
card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-3';

// æ·»åŠ å·²æ’¤å›æ¨™è¨˜ï¼Œå¦‚æœé©ç”¨
const withdrawnTag = redemption.withdrawn ?
`<span class="ml-2 px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-xs rounded-full">
<i class="ri-arrow-go-back-line mr-1"></i>å·²æ’¤å›
</span>` : '';

card.innerHTML = `
<div class="flex justify-between items-start mb-2">
<div class="font-bold flex items-center">å…‘æ›è¨˜éŒ„ #${formatRedemptionId(redemption.displayId)}${withdrawnTag}</div>
<div class="text-xs text-gray-500 dark:text-gray-400">${redemptionDate.toLocaleDateString()} ${redemptionDate.toLocaleTimeString()}</div>
</div>

<div class="grid grid-cols-2 gap-2 mb-2">
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">å„ªæƒ åˆ¸æ•¸é‡</div>
<div class="font-bold">${redemption.voucherCount}å¼µ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">ç¯€çœé‡‘é¡</div>
<div class="font-bold text-green-600 dark:text-green-400">${redemption.voucherValue}å…ƒ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">æ¶ˆè²»é‡‘é¡</div>
<div class="font-bold">${redemption.spendAmount}å…ƒ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">é€±æ¬¡</div>
<div class="font-bold">ç¬¬${redemption.weekNum}é€±</div>
</div>
</div>

${categoriesHTML}

${redemption.remark ? `
<div class="mb-2">
<div class="text-xs text-gray-500 dark:text-gray-400">æ¶ˆè²»å‚™è¨»</div>
<div class="text-sm border-t dark:border-gray-700 pt-1">${redemption.remark}</div>
</div>
` : ''}

${bankVouchersHTML ? `
<div class="mb-2">
<div class="text-xs text-gray-500 dark:text-gray-400 mb-1">éŠ€è¡Œå„ªæƒ åˆ¸</div>
<div class="border-t dark:border-gray-700 pt-1">
${bankVouchersHTML}
</div>
</div>
` : ''}

<div class="flex justify-end border-t dark:border-gray-700 pt-2">
<button class="text-xs text-primary dark:text-primary view-redemption-detail-btn" data-id="${redemption.id}">æŸ¥çœ‹è©³æƒ…</button>
</div>
`;

redemptionHistoryList.appendChild(card);
});

// æ·»åŠ æŸ¥çœ‹è©³æƒ…äº‹ä»¶
document.querySelectorAll('.view-redemption-detail-btn').forEach(btn => {
btn.addEventListener('click', function() {
showRedemptionDetail(this.getAttribute('data-id'));
});
});
}

// é¡¯ç¤ºå…‘æ›è©³æƒ…
function showRedemptionDetail(redemptionId) {
const redemption = appState.redemptionHistory.find(r => r.id === redemptionId);
if (!redemption) return;

// ä¿å­˜ç•¶å‰å…‘æ›è¨˜éŒ„IDä»¥ä¾¿æ’¤å›
currentRedemptionId = redemption.id;

const modal = document.getElementById('redemption-detail-modal');
const title = document.getElementById('redemption-detail-title');
const content = document.getElementById('redemption-detail-content');
const withdrawButton = document.getElementById('withdraw-redemption-btn');

// æŒ‰é¢å€¼åˆ†çµ„
const vouchersByAmount = {10: [], 20: [], 50: [], 100: [], 200: []};
redemption.vouchers.forEach(voucher => {
if (vouchersByAmount[voucher.amount]) {
vouchersByAmount[voucher.amount].push(voucher);
}
});

// æŒ‰éŠ€è¡Œåˆ†çµ„
const vouchersByBank = {};
redemption.vouchers.forEach(voucher => {
if (!vouchersByBank[voucher.bankId]) {
vouchersByBank[voucher.bankId] = [];
}
vouchersByBank[voucher.bankId].push(voucher);
});

// æ·»åŠ å·²æ’¤å›æ¨™è¨˜ï¼Œå¦‚æœé©ç”¨
const withdrawnTag = redemption.withdrawn ?
`<span class="ml-2 px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-xs rounded-full">
<i class="ri-arrow-go-back-line mr-1"></i>å·²æ’¤å›
</span>` : '';

// ç”Ÿæˆå…§å®¹
title.innerHTML = `å…‘æ›è©³æƒ… #${formatRedemptionId(redemption.displayId)}${withdrawnTag}`;

content.innerHTML = `
<div class="space-y-4">
<div>
<div class="text-sm text-gray-500 dark:text-gray-400">å…‘æ›æ™‚é–“</div>
<div>${new Date(redemption.date).toLocaleString()}</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400">é€±æ¬¡</div>
<div>ç¬¬${redemption.weekNum}é€±</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å…‘æ›æ‘˜è¦</div>
<div class="grid grid-cols-2 gap-2">
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">å„ªæƒ åˆ¸æ•¸é‡</div>
<div class="font-bold">${redemption.voucherCount}å¼µ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">æ¶ˆè²»é‡‘é¡</div>
<div class="font-bold text-primary">${redemption.spendAmount}å…ƒ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">ç¯€çœé‡‘é¡</div>
<div class="font-bold text-green-600 dark:text-green-400">${redemption.voucherValue}å…ƒ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">è‡ªè²»é‡‘é¡</div>
<div class="text-sm">${redemption.spendAmount - redemption.voucherValue}å…ƒ</div>
</div>
</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">æ¶ˆè²»é¡åˆ¥</div>
<div class="flex flex-wrap gap-1 mb-1">
${(redemption.categories || ['other']).map(category => `
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
style="background-color: ${getCategoryColor(category)}20; color: ${getCategoryColor(category)}">
<i class="${getCategoryIcon(category)} mr-1"></i> ${getCategoryName(category)}
</span>
`).join('')}
</div>
</div>

${redemption.remark ? `
<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">æ¶ˆè²»å‚™è¨»</div>
<div class="border rounded-lg p-2 text-sm">${redemption.remark}</div>
</div>
` : ''}

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">å„ªæƒ åˆ¸åˆ†ä½ˆ</div>
<div class="grid grid-cols-5 gap-2 text-center">
<div class="p-2 bg-blue-100 dark:bg-blue-900 rounded ${vouchersByAmount[10].length > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${vouchersByAmount[10].length}</div>
<div class="text-xs">10å…ƒ</div>
</div>
<div class="p-2 bg-blue-100 dark:bg-blue-900 rounded ${vouchersByAmount[20].length > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${vouchersByAmount[20].length}</div>
<div class="text-xs">20å…ƒ</div>
</div>
<div class="p-2 bg-green-100 dark:bg-green-900 rounded ${vouchersByAmount[50].length > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${vouchersByAmount[50].length}</div>
<div class="text-xs">50å…ƒ</div>
</div>
<div class="p-2 bg-purple-100 dark:bg-purple-900 rounded ${vouchersByAmount[100].length > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${vouchersByAmount[100].length}</div>
<div class="text-xs">100å…ƒ</div>
</div>
<div class="p-2 bg-purple-100 dark:bg-purple-900 rounded ${vouchersByAmount[200].length > 0 ? '' : 'opacity-30'}">
<div class="font-bold">${vouchersByAmount[200].length}</div>
<div class="text-xs">200å…ƒ</div>
</div>
</div>
</div>

<div>
<div class="text-sm text-gray-500 dark:text-gray-400 mb-1">æŒ‰éŠ€è¡Œåˆ†ä½ˆ</div>
<div class="space-y-2">
${banks.map(bank => {
const bankVouchers = vouchersByBank[bank.id] || [];
if (bankVouchers.length === 0) return '';

// æŒ‰é¢å€¼åˆ†çµ„
const bankAmounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0};
let bankTotal = 0;

bankVouchers.forEach(voucher => {
bankAmounts[voucher.amount]++;
bankTotal += voucher.amount;
});

return `
<div class="border rounded-lg p-2">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-medium">${bank.name}</span>
</div>
<div class="text-sm">${bankVouchers.length}å¼µ (${bankTotal}å…ƒ)</div>
</div>
<div class="text-xs space-y-1">
${bankAmounts[10] > 0 ? `<div>10å…ƒ: ${bankAmounts[10]}å¼µ</div>` : ''}
${bankAmounts[20] > 0 ? `<div>20å…ƒ: ${bankAmounts[20]}å¼µ</div>` : ''}
${bankAmounts[50] > 0 ? `<div>50å…ƒ: ${bankAmounts[50]}å¼µ</div>` : ''}
${bankAmounts[100] > 0 ? `<div>100å…ƒ: ${bankAmounts[100]}å¼µ</div>` : ''}
${bankAmounts[200] > 0 ? `<div>200å…ƒ: ${bankAmounts[200]}å¼µ</div>` : ''}
</div>
</div>
`;
}).join('')}
</div>
</div>
</div>
`;

// é¡¯ç¤ºæ¨¡æ…‹æ¡†
modal.classList.remove('hidden');

// å¦‚æœè¨˜éŒ„å·²è¢«æ’¤å›ï¼Œéš±è—æ’¤å›æŒ‰éˆ•
if (redemption.withdrawn) {
withdrawButton.style.display = 'none';
} else {
withdrawButton.style.display = 'block';
}

// æ·»åŠ æ’¤å›å…‘æ›æŒ‰éˆ•äº‹ä»¶
withdrawButton.onclick = function() {
showWithdrawConfirmation(currentRedemptionId);
};

// æ·»åŠ é—œé–‰æŒ‰éˆ•äº‹ä»¶
document.getElementById('close-redemption-detail-btn').onclick = function() {
modal.classList.add('hidden');
currentRedemptionId = null; // æ¸…é™¤ç•¶å‰å…‘æ›è¨˜éŒ„ID
};

document.getElementById('close-redemption-detail').onclick = function() {
modal.classList.add('hidden');
currentRedemptionId = null; // æ¸…é™¤ç•¶å‰å…‘æ›è¨˜éŒ„ID
};
}

// æ›´æ–°ç¸½é«”çµ±è¨ˆ
function updateTotalStats() {
// è¨ˆç®—ç¸½å„ªæƒ åˆ¸æ•¸é‡å’Œåƒ¹å€¼
const totalCount = appState.vouchers.length;
const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);

// è¨ˆç®—å¯å…‘æ›å„ªæƒ åˆ¸æ•¸é‡å’Œåƒ¹å€¼
const redeemableCount = getRedeemableVoucherCount();
const redeemableValue = getRedeemableVoucherValue();

// è¨ˆç®—ä½¿ç”¨ç‡ (åŸºæ–¼å¯å…‘æ›çš„å„ªæƒ åˆ¸è¨ˆç®—ä½¿ç”¨ç‡ï¼Œä¸åŒ…æ‹¬ç¬‘è‡‰)
const usedCount = appState.vouchers.filter(v => v.used).length;

// è¨ˆç®—å¯å…‘æ›ç¸½æ•¸ (åŒ…æ‹¬å·²ä½¿ç”¨çš„)
const totalRedeemable = appState.vouchers.filter(v => v.amount > 0).length;

const usageRate = totalRedeemable > 0 ? Math.round((usedCount / totalRedeemable) * 100) : 0;

// è¨ˆç®—éæœŸç‡ (åƒ…è¨ˆç®—å¯å…‘æ›ä¼˜æƒ åˆ¸çš„è¿‡æœŸç‡)
const expiredCount = appState.vouchers
.filter(v => !v.used && isVoucherExpired(v) && v.amount > 0)
.length;

const expiryRate = totalRedeemable > 0 ? Math.round((expiredCount / totalRedeemable) * 100) : 0;

// æ›´æ–°UI
document.getElementById('total-vouchers').textContent = `${totalCount}å¼µ`;
document.getElementById('total-value').textContent = `${totalValue}å…ƒ`;
document.getElementById('usage-rate').textContent = `${usageRate}%`;
document.getElementById('expiry-rate').textContent = `${expiryRate}%`;
}

// æ›´æ–°è©³ç´°åˆ†æå ±å‘Š
function updateDetailedAnalysis() {
// é¢å€¼åˆ†ä½ˆåˆ†æ
const valueDistributionRows = document.getElementById('value-distribution-rows');
const valueDistributionSummary = document.getElementById('value-distribution-summary');

// è¨ˆç®—é¢å€¼åˆ†ä½ˆ
const valueCounts = {0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0, total: 0};
appState.vouchers.forEach(voucher => {
valueCounts[voucher.amount]++;
valueCounts.total++;
});

if (valueCounts.total === 0) {
valueDistributionRows.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šç„¡å„ªæƒ åˆ¸æ•¸æ“š</div>';
valueDistributionSummary.innerHTML = '';
} else {
let valueHTML = '';
let highestValueCount = 0;
let highestValue = 0;

// è¨ˆç®—æœ€å¸¸è¦‹é¢å€¼ (ä¸åŒ…æ‹¬ç¬‘è‡‰)
[0, 10, 20, 50, 100, 200].forEach(amount => {
const count = valueCounts[amount];
const percentage = Math.round((count / valueCounts.total) * 100) || 0;

if (count > highestValueCount && amount > 0) {
highestValueCount = count;
highestValue = amount;
}

valueHTML += `
<div class="flex justify-between items-center py-1 border-b dark:border-gray-700 last:border-0">
<span>${amount === 0 ? 'ğŸ˜„' : amount + 'å…ƒ'}</span>
<span>${count}å¼µ</span>
<span>${percentage}%</span>
</div>
`;
});

valueDistributionRows.innerHTML = valueHTML;

// ç”Ÿæˆæ‘˜è¦
const smileyPercentage = Math.round((valueCounts[0] / valueCounts.total) * 100) || 0;

// è¨ˆç®—å¯å…‘æ›æ¯”ä¾‹ (ä¸åŒ…æ‹¬ç¬‘è‡‰)
const redeemablePercentage = Math.round(((valueCounts.total - valueCounts[0]) / valueCounts.total) * 100) || 0;

valueDistributionSummary.innerHTML = `
<div>æœ€å¸¸è¦‹é¢å€¼: <span class="font-medium">${highestValue}å…ƒ</span> (${highestValueCount}å¼µ)</div>
<div>ç¬‘è‡‰ä½”æ¯”: <span class="font-medium">${smileyPercentage}%</span></div>
<div>å¯å…‘æ›ä½”æ¯”: <span class="font-medium">${redeemablePercentage}%</span></div>
`;
}

// éŠ€è¡Œå„ªæƒ åˆ¸åˆ†æ
const bankDistributionRows = document.getElementById('bank-distribution-rows');
const bankDistributionSummary = document.getElementById('bank-distribution-summary');

// è¨ˆç®—éŠ€è¡Œåˆ†ä½ˆ
const bankCounts = {};
const bankRedeemableCounts = {}; // å¯å…‘æ›æ•¸é‡
let totalBankVouchers = 0;
let totalRedeemableVouchers = 0;

banks.forEach(bank => {
bankCounts[bank.id] = { count: 0, value: 0 };
bankRedeemableCounts[bank.id] = { count: 0, value: 0 };
});

appState.vouchers.forEach(voucher => {
if (voucher.bankId && bankCounts[voucher.bankId]) {
bankCounts[voucher.bankId].count++;
bankCounts[voucher.bankId].value += voucher.amount;
totalBankVouchers++;

// è¨ˆç®—å¯å…‘æ›å„ªæƒ åˆ¸ (ä¸åŒ…æ‹¬ç¬‘è‡‰)
if (isVoucherRedeemable(voucher)) {
bankRedeemableCounts[voucher.bankId].count++;
bankRedeemableCounts[voucher.bankId].value += voucher.amount;
totalRedeemableVouchers++;
}
}
});

if (totalBankVouchers === 0) {
bankDistributionRows.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šç„¡éŠ€è¡Œå„ªæƒ åˆ¸æ•¸æ“š</div>';
bankDistributionSummary.innerHTML = '';
} else {
// æŒ‰å„ªæƒ åˆ¸é‡‘é¡æ’åºéŠ€è¡Œ
const sortedBanks = [...banks]
.filter(bank => bankCounts[bank.id].count > 0)
.sort((a, b) => bankCounts[b.id].value - bankCounts[a.id].value);

let bankHTML = '';
sortedBanks.forEach(bank => {
const data = bankCounts[bank.id];
const redeemableData = bankRedeemableCounts[bank.id];

bankHTML += `
<div class="flex justify-between items-center py-1 border-b dark:border-gray-700 last:border-0">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-1"></i>
<span>${bank.name}</span>
</div>
<span>${data.count}å¼µ</span>
<span>${data.value}å…ƒ${redeemableData.count > 0 ?
` <span class="text-xs text-green-600 dark:text-green-400">(å¯å…‘æ›: ${redeemableData.count}å¼µ)</span>` : ''}</span>
</div>
`;
});

bankDistributionRows.innerHTML = bankHTML;

// ç”Ÿæˆæ‘˜è¦
if (sortedBanks.length > 0) {
const topBank = sortedBanks[0];
const topBankPercentage = Math.round((bankCounts[topBank.id].count / totalBankVouchers) * 100);

bankDistributionSummary.innerHTML = `
<div>æœ€å¸¸ç”¨éŠ€è¡Œ: <span class="font-medium">${topBank.name}</span> (${topBankPercentage}%)</div>
<div>éŠ€è¡Œç¸½æ•¸: <span class="font-medium">${sortedBanks.length}</span>/${banks.length}</div>
<div>å¯å…‘æ›æ•¸é‡: <span class="font-medium">${totalRedeemableVouchers}</span>/${totalBankVouchers}å¼µ</div>
`;
} else {
bankDistributionSummary.innerHTML = '';
}
}

// ä½¿ç”¨ç‹€æ…‹åˆ†æ
const statusDistributionRows = document.getElementById('status-distribution-rows');
const statusDistributionSummary = document.getElementById('status-distribution-summary');

// è¨ˆç®—ç‹€æ…‹åˆ†ä½ˆ (æ’é™¤ç¬‘è‡‰)
const statusCounts = {unused: 0, used: 0, expired: 0, total: 0, redeemable: 0};

appState.vouchers.forEach(voucher => {
// æ’é™¤ç¬‘è‡‰å„ªæƒ åˆ¸
if (voucher.amount > 0) {
if (voucher.used) {
statusCounts.used++;
} else if (isVoucherExpired(voucher)) {
statusCounts.expired++;
} else {
statusCounts.unused++;
statusCounts.redeemable++; // å¯å…‘æ›æ•¸é‡
}
statusCounts.total++;
}
});

if (statusCounts.total === 0) {
statusDistributionRows.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šç„¡å¯å…‘æ›å„ªæƒ åˆ¸æ•¸æ“š</div>';
statusDistributionSummary.innerHTML = '';
} else {
const statusHTML = `
<div class="flex justify-between items-center py-1 border-b dark:border-gray-700">
<span class="text-green-600 dark:text-green-400">æœªä½¿ç”¨</span>
<span>${statusCounts.unused}å¼µ</span>
<span>${Math.round((statusCounts.unused / statusCounts.total) * 100)}%</span>
</div>
<div class="flex justify-between items-center py-1 border-b dark:border-gray-700">
<span class="text-blue-600 dark:text-blue-400">å·²å…‘æ›</span>
<span>${statusCounts.used}å¼µ</span>
<span>${Math.round((statusCounts.used / statusCounts.total) * 100)}%</span>
</div>
<div class="flex justify-between items-center py-1">
<span class="text-red-600 dark:text-red-400">å·²éæœŸ</span>
<span>${statusCounts.expired}å¼µ</span>
<span>${Math.round((statusCounts.expired / statusCounts.total) * 100)}%</span>
</div>
`;

statusDistributionRows.innerHTML = statusHTML;

// è¨ˆç®—å¯ç¯€çœç¸½é‡‘é¡
const potentialSavings = appState.vouchers
.filter(isVoucherRedeemable)
.reduce((sum, v) => sum + v.amount, 0);

// è¨ˆç®—å·²ç¯€çœç¸½é‡‘é¡
const savedAmount = appState.vouchers
.filter(v => v.used)
.reduce((sum, v) => sum + v.amount, 0);

statusDistributionSummary.innerHTML = `
<div>å·²ç¯€çœé‡‘é¡: <span class="font-medium text-green-600 dark:text-green-400">${savedAmount}å…ƒ</span></div>
<div>æ½›åœ¨ç¯€çœé‡‘é¡: <span class="font-medium">${potentialSavings}å…ƒ</span></div>
`;
}

// å…‘æ›æ•ˆç‡åˆ†æ
const redemptionEfficiencyContent = document.getElementById('redemption-efficiency-content');

if (appState.redemptionHistory.length === 0) {
redemptionEfficiencyContent.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-2">å°šç„¡å…‘æ›è¨˜éŒ„</div>';
} else {
// è¨ˆç®—å¹³å‡æ¯æ¬¡å…‘æ›çš„å„ªæƒ åˆ¸æ•¸é‡
const avgVouchersPerRedemption = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherCount, 0) / appState.redemptionHistory.length;

// è¨ˆç®—å¹³å‡ç¯€çœé‡‘é¡
const avgSavings = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherValue, 0) / appState.redemptionHistory.length;

// è¨ˆç®—å¹³å‡æ¶ˆè²»é‡‘é¡
const avgSpending = appState.redemptionHistory.reduce((sum, r) => sum + r.spendAmount, 0) / appState.redemptionHistory.length;

// è¨ˆç®—ç¸½ç¯€çœç‡
const totalSpending = appState.redemptionHistory.reduce((sum, r) => sum + r.spendAmount, 0);
const totalSavings = appState.redemptionHistory.reduce((sum, r) => sum + r.voucherValue, 0);
const savingsRate = totalSpending > 0 ? Math.round((totalSavings / totalSpending) * 100) : 0;

redemptionEfficiencyContent.innerHTML = `
<div class="grid grid-cols-2 gap-x-4 gap-y-2">
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">å…‘æ›ç¸½æ¬¡æ•¸</div>
<div class="font-medium">${appState.redemptionHistory.length}æ¬¡</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">å¹³å‡æ¯æ¬¡å„ªæƒ åˆ¸</div>
<div class="font-medium">${avgVouchersPerRedemption.toFixed(1)}å¼µ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">å¹³å‡ç¯€çœé‡‘é¡</div>
<div class="font-medium text-green-600 dark:text-green-400">${avgSavings.toFixed(1)}å…ƒ</div>
</div>
<div>
<div class="text-xs text-gray-500 dark:text-gray-400">å¹³å‡æ¶ˆè²»é‡‘é¡</div>
<div class="font-medium">${avgSpending.toFixed(1)}å…ƒ</div>
</div>
</div>
<div class="mt-2 pt-2 border-t dark:border-gray-700">
<div class="flex justify-between items-center">
<div>ç¸½ç¯€çœç‡:</div>
<div class="font-medium text-green-600 dark:text-green-400">${savingsRate}%</div>
</div>
<div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-1">
<div class="h-2 bg-green-500 rounded-full" style="width: ${savingsRate}%"></div>
</div>
</div>
`;
}
}

// æ›´æ–°ç®¡ç†æ¨¡å¼çš„å„ªæƒ åˆ¸è¨ˆæ•¸
function updateAdminVoucherCounts() {
const selectedWeek = parseInt(document.getElementById('admin-week-select').value);
const selectedBank = document.getElementById('admin-bank-select').value;

if (isNaN(selectedWeek) || !selectedBank) return;

// æª¢ç´¢é¸å®šé€±æ¬¡å’ŒéŠ€è¡Œçš„å„ªæƒ åˆ¸
const voucherCounts = { 0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0 };

appState.vouchers.forEach(voucher => {
if (voucher.bankId === selectedBank && getWeekNumberFromDate(voucher.date) === selectedWeek) {
voucherCounts[voucher.amount]++;
}
});

// æ›´æ–°è¨ˆæ•¸é¡¯ç¤º
document.getElementById('admin-0-count').textContent = voucherCounts[0];
document.getElementById('admin-10-count').textContent = voucherCounts[10];
document.getElementById('admin-20-count').textContent = voucherCounts[20];
document.getElementById('admin-50-count').textContent = voucherCounts[50];
document.getElementById('admin-100-count').textContent = voucherCounts[100];
document.getElementById('admin-200-count').textContent = voucherCounts[200];
}

// åˆå§‹åŒ–ç®¡ç†æ¨¡å¼
function initAdminMode() {
// å¡«å……é€±æ¬¡é¸æ“‡å™¨
const weekSelect = document.getElementById('admin-week-select');
weekSelect.innerHTML = '<option value="">-- é¸æ“‡é€±æ¬¡ --</option>';
weekSchedule.forEach(week => {
const option = document.createElement('option');
option.value = week.week;
option.textContent = `ç¬¬${week.week}é€± (${formatDate(week.startDate)} - ${formatDate(week.endDate)})`;
weekSelect.appendChild(option);
});

// å¡«å……éŠ€è¡Œé¸æ“‡å™¨
const bankSelect = document.getElementById('admin-bank-select');
bankSelect.innerHTML = '<option value="">-- é¸æ“‡éŠ€è¡Œ --</option>';
banks.forEach(bank => {
const option = document.createElement('option');
option.value = bank.id;
option.textContent = bank.name;
bankSelect.appendChild(option);
});

// æ·»åŠ é¸æ“‡è®Šæ›´äº‹ä»¶
weekSelect.addEventListener('change', updateAdminVoucherCounts);
bankSelect.addEventListener('change', updateAdminVoucherCounts);

// æ·»åŠ ç®¡ç†æ“ä½œäº‹ä»¶
document.getElementById('admin-add-btn').addEventListener('click', function() {
const weekNum = parseInt(document.getElementById('admin-week-select').value);
const bankId = document.getElementById('admin-bank-select').value;
const amount = parseInt(document.getElementById('admin-amount-select').value);

if (isNaN(weekNum) || !bankId || isNaN(amount)) {
alert('è«‹å…ˆé¸æ“‡é€±æ¬¡ã€éŠ€è¡Œå’Œé¢å€¼ï¼');
return;
}

// å–å¾—è©²é€±çš„æ—¥æœŸ
const weekData = weekSchedule[weekNum - 1];
if (!weekData) {
alert('ç„¡æ•ˆçš„é€±æ¬¡ï¼');
return;
}

// ä½¿ç”¨é€±ä¸­çš„æŸä¸€å¤©ä½œç‚ºæ—¥æœŸï¼ˆä¾‹å¦‚ç¬¬ä¸€å¤©ï¼‰
const date = weekData.startDate;

// æ·»åŠ å„ªæƒ åˆ¸
if (addVoucher(amount, date, bankId)) {
updateAdminVoucherCounts();
alert(`æˆåŠŸæ·»åŠ  ${amount}${amount === 0 ? 'å…ƒ(ğŸ˜„)' : 'å…ƒ'} å„ªæƒ åˆ¸è‡³ ${getBankName(bankId)} çš„ç¬¬${weekNum}é€±è¨˜éŒ„`);
}
});

document.getElementById('admin-remove-btn').addEventListener('click', function() {
const weekNum = parseInt(document.getElementById('admin-week-select').value);
const bankId = document.getElementById('admin-bank-select').value;
const amount = parseInt(document.getElementById('admin-amount-select').value);

if (isNaN(weekNum) || !bankId || isNaN(amount)) {
alert('è«‹å…ˆé¸æ“‡é€±æ¬¡ã€éŠ€è¡Œå’Œé¢å€¼ï¼');
return;
}

// åˆªé™¤æŒ‡å®šå„ªæƒ åˆ¸
if (deleteVoucherByBankAndAmount(bankId, amount, weekNum)) {
updateAdminVoucherCounts();
alert(`æˆåŠŸåˆªé™¤ ${getBankName(bankId)} çš„ç¬¬${weekNum}é€± ${amount}${amount === 0 ? 'å…ƒ(ğŸ˜„)' : 'å…ƒ'} å„ªæƒ åˆ¸`);
} else {
alert(`æ‰¾ä¸åˆ° ${getBankName(bankId)} çš„ç¬¬${weekNum}é€± ${amount}${amount === 0 ? 'å…ƒ(ğŸ˜„)' : 'å…ƒ'} å„ªæƒ åˆ¸`);
}
});

// æ›´æ–°ç®¡ç†æ¨¡å¼çš„å„ªæƒ åˆ¸åˆ—è¡¨
function updateAdminRedeemableVouchers() {
const weekNum = parseInt(document.getElementById('admin-week-select').value);
const bankId = document.getElementById('admin-bank-select').value;
const vouchersContainer = document.getElementById('admin-redeemable-vouchers');

// æ¸…ç©ºç•¶å‰åˆ—è¡¨
vouchersContainer.innerHTML = '<div class="text-xs text-gray-500">é¸æ“‡ç‰¹å®šå„ªæƒ åˆ¸é€²è¡Œå…‘æ›ï¼š</div>';

if (isNaN(weekNum) || !bankId) {
vouchersContainer.innerHTML += '<div class="text-xs text-gray-500 mt-2">è«‹å…ˆé¸æ“‡é€±æ¬¡å’ŒéŠ€è¡Œ</div>';
return;
}

// ç²å–è©²éŠ€è¡Œè©²é€±æ¬¡çš„å¯å…‘æ›å„ªæƒ åˆ¸
const redeemableVouchers = appState.vouchers.filter(voucher =>
voucher.bankId === bankId &&
getWeekNumberFromDate(voucher.date) === weekNum &&
!voucher.used &&
voucher.amount > 0 // æ’é™¤ç¬‘è‡‰
);

if (redeemableVouchers.length === 0) {
vouchersContainer.innerHTML += `<div class="text-xs text-gray-500 mt-2">${getBankName(bankId)} çš„ç¬¬${weekNum}é€±æ²’æœ‰å¯å…‘æ›çš„å„ªæƒ åˆ¸</div>`;
return;
}

// æŒ‰é¢å€¼æ’åº
redeemableVouchers.sort((a, b) => b.amount - a.amount);

// ç”Ÿæˆå¯å…‘æ›å„ªæƒ åˆ¸åˆ—è¡¨
const voucherList = document.createElement('div');
voucherList.className = 'mt-2 space-y-1';

redeemableVouchers.forEach(voucher => {
const voucherItem = document.createElement('div');
voucherItem.className = 'flex items-center space-x-2';
voucherItem.innerHTML = `
<input type="checkbox" id="admin-voucher-${voucher.id}" class="admin-voucher-checkbox" data-id="${voucher.id}">
<label for="admin-voucher-${voucher.id}" class="text-xs">
${voucher.amount}å…ƒ å„ªæƒ åˆ¸
</label>
`;
voucherList.appendChild(voucherItem);
});

vouchersContainer.appendChild(voucherList);

// æ·»åŠ å…¨é¸æŒ‰éˆ•
const selectAllBtn = document.createElement('button');
selectAllBtn.className = 'text-xs mt-2 bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded';
selectAllBtn.textContent = 'å…¨é¸';
selectAllBtn.onclick = function() {
document.querySelectorAll('.admin-voucher-checkbox').forEach(checkbox => {
checkbox.checked = true;
});
};
vouchersContainer.appendChild(selectAllBtn);
}

// æ·»åŠ é€±æ¬¡å’ŒéŠ€è¡Œé¸æ“‡è®Šæ›´äº‹ä»¶
document.getElementById('admin-week-select').addEventListener('change', function() {
updateAdminVoucherCounts();
updateAdminRedeemableVouchers();
});

document.getElementById('admin-bank-select').addEventListener('change', function() {
updateAdminVoucherCounts();
updateAdminRedeemableVouchers();
});

// æ·»åŠ å…‘æ›æŒ‰éˆ•äº‹ä»¶ï¼ˆç®¡ç†æ¨¡å¼ï¼‰
document.getElementById('admin-redeem-btn').addEventListener('click', function() {
const weekNum = parseInt(document.getElementById('admin-week-select').value);
const bankId = document.getElementById('admin-bank-select').value;

if (isNaN(weekNum) || !bankId) {
alert('è«‹å…ˆé¸æ“‡é€±æ¬¡å’ŒéŠ€è¡Œï¼');
return;
}

// ç²å–é¸ä¸­çš„å„ªæƒ åˆ¸ID
const selectedVoucherIds = Array.from(document.querySelectorAll('.admin-voucher-checkbox:checked'))
.map(checkbox => checkbox.getAttribute('data-id'));

if (selectedVoucherIds.length === 0) {
alert('è«‹é¸æ“‡è‡³å°‘ä¸€å¼µè¦å…‘æ›çš„å„ªæƒ åˆ¸ï¼');
return;
}

// ç²å–é¸ä¸­çš„å„ªæƒ åˆ¸
const selectedVouchers = appState.vouchers.filter(voucher =>
selectedVoucherIds.includes(voucher.id) &&
!voucher.used &&
voucher.bankId === bankId &&
getWeekNumberFromDate(voucher.date) === weekNum
);

if (selectedVouchers.length === 0) {
alert('é¸ä¸­çš„å„ªæƒ åˆ¸å·²ä¸å¯ç”¨ï¼Œè«‹é‡æ–°é¸æ“‡ï¼');
updateAdminRedeemableVouchers();
return;
}

// è¨ˆç®—ç¸½åƒ¹å€¼
const totalValue = selectedVouchers.reduce((sum, v) => sum + v.amount, 0);

// ç¢ºèªæ“ä½œ
if (confirm(`ç¢ºå®šè¦å°‡ ${getBankName(bankId)} çš„ç¬¬${weekNum}é€±çš„ ${selectedVouchers.length}å¼µ å„ªæƒ åˆ¸ (ç¸½å€¼ ${totalValue}å…ƒ) æ¨™è¨˜ç‚ºå·²å…‘æ›å—ï¼Ÿ`)) {
// æ¨™è¨˜é¸ä¸­çš„å„ªæƒ åˆ¸ç‚ºå·²å…‘æ›
let redeemCount = 0;
selectedVouchers.forEach(voucher => {
voucher.used = true;
redeemCount++;
});

saveAppState();
updateAdminVoucherCounts();
updateAdminRedeemableVouchers();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateWeekRecordsDisplay();
updateRedemptionHistory();
updateDetailedAnalysis();
updateCharts();

alert(`æˆåŠŸå°‡ ${getBankName(bankId)} çš„ç¬¬${weekNum}é€±çš„ ${redeemCount}å¼µ å„ªæƒ åˆ¸æ¨™è¨˜ç‚ºå·²å…‘æ›`);
}
});

// ç®¡ç†æ¨¡å¼æŒ‰éˆ•äº‹ä»¶
document.getElementById('admin-mode-btn').addEventListener('click', function() {
document.getElementById('admin-mode-modal').classList.remove('hidden');
// æ¸…ç©ºé¸æ“‡
document.getElementById('admin-week-select').value = '';
document.getElementById('admin-bank-select').value = '';
document.getElementById('admin-amount-select').value = '10';

// é‡ç½®è¨ˆæ•¸
document.getElementById('admin-0-count').textContent = '0';
document.getElementById('admin-10-count').textContent = '0';
document.getElementById('admin-20-count').textContent = '0';
document.getElementById('admin-50-count').textContent = '0';
document.getElementById('admin-100-count').textContent = '0';
document.getElementById('admin-200-count').textContent = '0';
});

// é—œé–‰æŒ‰éˆ•äº‹ä»¶
document.getElementById('close-admin-mode').addEventListener('click', function() {
document.getElementById('admin-mode-modal').classList.add('hidden');
});

document.getElementById('close-admin-btn').addEventListener('click', function() {
document.getElementById('admin-mode-modal').classList.add('hidden');
});
}

// åˆå§‹åŒ–åœ–è¡¨
function initCharts() {
Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';
Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';

// ç‹€æ…‹åˆ†ä½ˆåœ–è¡¨
const statusCtx = document.getElementById('status-chart').getContext('2d');
statusChart = new Chart(statusCtx, {
type: 'pie',
data: {
labels: ['æœªä½¿ç”¨', 'å·²å…‘æ›', 'å·²éæœŸ'],
datasets: [{
data: [0, 0, 0],
backgroundColor: [
'#86efac', // æœªä½¿ç”¨
'#93c5fd', // å·²å…‘æ›
'#f87171' // å·²éæœŸ
]
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'right',
labels: {
boxWidth: 12,
font: { size: 12 }
}
},
tooltip: {
callbacks: {
label: function(context) {
const value = context.raw;
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = Math.round((value / total) * 100);
return `${value} å¼µ (${percentage}%)`;
}
}
}
}
},
plugins: [{
beforeDraw: function(chart) {
const datasets = chart.data.datasets;
if (datasets.length > 0) {
const sum = datasets[0].data.reduce((a, b) => a + b, 0);
if (sum === 0) {
// å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºç„¡æ•¸æ“šæ–‡æœ¬
const ctx = chart.ctx;
const width = chart.width;
const height = chart.height;

chart.clear();

ctx.save();
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
ctx.font = '16px sans-serif';
ctx.fillStyle = chart.options.color;
ctx.fillText('æ²’æœ‰æ•¸æ“š', width / 2, height / 2);
ctx.restore();

return false; // å–æ¶ˆåŸæœ¬çš„ç¹ªè£½
}
}
},
afterDraw: function(chart) {
const ctx = chart.ctx;
chart.data.datasets.forEach((dataset, i) => {
const meta = chart.getDatasetMeta(i);
meta.data.forEach((element, index) => {
// ç²å–æ•¸æ“š
const data = dataset.data[index];
if (data === 0) return;

// è¨ˆç®—ç™¾åˆ†æ¯”
const total = dataset.data.reduce((a, b) => a + b, 0);
const percentage = Math.round((data / total) * 100);

// ç²å–ä½ç½®ä¿¡æ¯
const position = element.tooltipPosition();
const x = position.x;
const y = position.y;

// ç¹ªè£½æ–‡æœ¬
ctx.fillStyle = '#fff';
ctx.font = 'bold 12px Arial';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
ctx.fillText(`${data}å¼µ`, x, y - 8);
ctx.fillText(`(${percentage}%)`, x, y + 8);
});
});
}
}]
});

// åˆå§‹åŒ–çµ„åˆåœ–è¡¨ï¼ˆé¢å€¼å’ŒéŠ€è¡Œåˆ†ä½ˆå…±ç”¨ï¼‰
const combinedCtx = document.getElementById('combined-chart').getContext('2d');
combinedChart = new Chart(combinedCtx, {
type: 'bar',
data: {
labels: ['10å…ƒ', '20å…ƒ', '50å…ƒ', '100å…ƒ', '200å…ƒ', 'ğŸ˜„'],
datasets: [{
label: 'æ•¸é‡',
data: [0, 0, 0, 0, 0, 0],
backgroundColor: document.documentElement.classList.contains('dark') ?
['#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc', '#facc15'] :
['#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff', '#fef08a']
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { display: false },
tooltip: {
callbacks: {
label: function(context) {
if (currentChartMode === 'value') {
return `${context.parsed.y} å¼µ`;
} else {
return `${context.parsed.y} å…ƒ`;
}
}
}
}
},
scales: {
y: {
beginAtZero: true,
ticks: {
precision: 0
}
}
}
},
plugins: [{
afterDatasetsDraw: function(chart) {
const ctx = chart.ctx;
chart.data.datasets.forEach((dataset, datasetIndex) => {
const meta = chart.getDatasetMeta(datasetIndex);
if (!meta.hidden) {
meta.data.forEach((element, index) => {
// ç²å–æ•¸æ“š
const data = dataset.data[index];
if (data === 0) return;

// è¨ˆç®—ä½ç½® - ç¢ºä¿æ¨™ç±¤åœ¨æŸ±å½¢ä¸Šæ–¹è€Œä¸æ˜¯è¢«é®æ“‹
const position = element.tooltipPosition();
const x = position.x;

// ç¢ºä¿æ¨™ç±¤é¡¯ç¤ºåœ¨æŸ±å½¢çš„ä¸Šæ–¹ï¼Œè€Œä¸æ˜¯åœ¨æŸ±å½¢å…§éƒ¨
const y = element.y - 10;

// ç¹ªè£½æ–‡æœ¬
ctx.fillStyle = '#000';
if (document.documentElement.classList.contains('dark')) {
ctx.fillStyle = '#fff';
}
ctx.font = 'bold 12px Arial';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
if (currentChartMode === 'value') {
ctx.fillText(data + 'å¼µ', x, y);
} else {
ctx.fillText(data + 'å…ƒ', x, y);
}
});
}
});
}
}]
});

// æ¶ˆè²»é¡åˆ¥åˆ†ä½ˆåœ–è¡¨
const categoryCtx = document.getElementById('category-chart').getContext('2d');
categoryChart = new Chart(categoryCtx, {
type: 'doughnut',
data: {
labels: expenseCategories.map(cat => cat.name),
datasets: [{
data: Array(expenseCategories.length).fill(0),
backgroundColor: expenseCategories.map(cat => cat.color)
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'right',
labels: {
boxWidth: 12,
font: {
size: 10
}
}
},
tooltip: {
callbacks: {
label: function(context) {
const value = context.raw;
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
return `${value} æ¬¡ (${percentage}%)`;
}
}
}
}
},
plugins: [{
afterDatasetsDraw: function(chart) {
const ctx = chart.ctx;
chart.data.datasets.forEach((dataset, i) => {
const meta = chart.getDatasetMeta(i);
meta.data.forEach((element, index) => {
// ç²å–æ•¸æ“š
const data = dataset.data[index];
if (data === 0) return;

// è¨ˆç®—ç™¾åˆ†æ¯”
const total = dataset.data.reduce((a, b) => a + b, 0);
const percentage = Math.round((data / total) * 100);

// ç²å–ä½ç½®ä¿¡æ¯
const position = element.tooltipPosition();
const x = position.x;
const y = position.y;

// ç¹ªè£½æ–‡æœ¬
ctx.fillStyle = '#fff';
ctx.font = 'bold 12px Arial';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';

if (currentCategoryMode === 'count') {
ctx.fillText(`${data}æ¬¡`, x, y - 5);
} else {
ctx.fillText(`${data}å…ƒ`, x, y - 5);
}

ctx.fillText(`(${percentage}%)`, x, y + 10);
});
});
}
}]
});

// é€±æ¬¡è¶¨å‹¢åœ–è¡¨ (é¡¯ç¤ºé‡‘é¡)
const weeklyTrendCtx = document.getElementById('weekly-trend-chart').getContext('2d');
weeklyTrendChart = new Chart(weeklyTrendCtx, {
type: 'line',
data: {
labels: weekSchedule.map(w => `ç¬¬${w.week}é€±`),
datasets: [
{
label: 'å„ªæƒ åˆ¸é‡‘é¡',
data: Array(weekSchedule.length).fill(0),
borderColor: '#5D5CDE',
backgroundColor: 'rgba(93, 92, 222, 0.1)',
tension: 0.3,
fill: true
},
{
label: 'å…‘æ›é‡‘é¡',
data: Array(weekSchedule.length).fill(0),
borderColor: '#10B981',
backgroundColor: 'rgba(16, 185, 129, 0.1)',
tension: 0.3,
fill: true
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
grid: {
display: false
},
ticks: {
callback: function(value) {
return value + 'å…ƒ';
}
}
},
x: {
grid: {
display: false
}
}
},
plugins: {
tooltip: {
callbacks: {
label: function(context) {
return `${context.dataset.label}: ${context.raw} å…ƒ`;
}
}
}
}
},
plugins: [{
afterDatasetsDraw: function(chart) {
const ctx = chart.ctx;
chart.data.datasets.forEach((dataset, datasetIndex) => {
const meta = chart.getDatasetMeta(datasetIndex);
if (!meta.hidden) {
meta.data.forEach((element, index) => {
// ç²å–æ•¸æ“š
const data = dataset.data[index];
if (data === 0) return;

// è¨ˆç®—ä½ç½®
const position = element.tooltipPosition();
const x = position.x;
const y = position.y - 15; // èª¿æ•´æ–‡æœ¬ä½ç½®

// ç¹ªè£½æ–‡æœ¬
ctx.fillStyle = dataset.borderColor;
ctx.font = 'bold 12px Arial';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
ctx.fillText(data + 'å…ƒ', x, y);
});
}
});
}
}]
});

// åˆ‡æ›é¢å€¼èˆ‡éŠ€è¡Œåœ–è¡¨
document.getElementById('show-value-chart').addEventListener('click', function() {
if (currentChartMode === 'value') return;
currentChartMode = 'value';
this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
this.classList.add('bg-primary', 'text-white');
document.getElementById('show-bank-chart').classList.remove('bg-primary', 'text-white');
document.getElementById('show-bank-chart').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
updateCombinedChart();
});

document.getElementById('show-bank-chart').addEventListener('click', function() {
if (currentChartMode === 'bank') return;
currentChartMode = 'bank';
this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
this.classList.add('bg-primary', 'text-white');
document.getElementById('show-value-chart').classList.remove('bg-primary', 'text-white');
document.getElementById('show-value-chart').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
updateCombinedChart();
});

// åˆ‡æ›æ¶ˆè²»é¡åˆ¥åœ–è¡¨ï¼ˆæŒ‰æ¬¡æ•¸/æŒ‰é‡‘é¡ï¼‰
document.getElementById('show-category-count').addEventListener('click', function() {
if (this.classList.contains('bg-primary')) return;
this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
this.classList.add('bg-primary', 'text-white');
document.getElementById('show-category-amount').classList.remove('bg-primary', 'text-white');
document.getElementById('show-category-amount').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
updateCategoryChart('count');
});

document.getElementById('show-category-amount').addEventListener('click', function() {
if (this.classList.contains('bg-primary')) return;
this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
this.classList.add('bg-primary', 'text-white');
document.getElementById('show-category-count').classList.remove('bg-primary', 'text-white');
document.getElementById('show-category-count').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
updateCategoryChart('amount');
});

updateCharts();
}

// æ›´æ–°é¡åˆ¥åœ–è¡¨
function updateCategoryChart(mode = 'count') {
if (!categoryChart) return;
currentCategoryMode = mode;

// æŒ‰æ¬¡æ•¸æˆ–é‡‘é¡è¨ˆç®—æ¶ˆè²»é¡åˆ¥åˆ†ä½ˆ
const categoryCounts = Array(expenseCategories.length).fill(0);
const categoryAmounts = Array(expenseCategories.length).fill(0);

// æ”¶é›†æ‰€æœ‰å…‘æ›è¨˜éŒ„çš„é¡åˆ¥æ•¸æ“š
appState.redemptionHistory.forEach(redemption => {
if (redemption.categories && redemption.categories.length > 0) {
redemption.categories.forEach(category => {
const index = expenseCategories.findIndex(cat => cat.id === category);
if (index !== -1) {
categoryCounts[index]++;
// æ¶ˆè²»é‡‘é¡å¹³å‡åˆ†é…çµ¦æ‰€æœ‰é¸ä¸­çš„é¡åˆ¥
categoryAmounts[index] += redemption.spendAmount / redemption.categories.length;
}
});
} else {
// å¦‚æœæ²’æœ‰é¡åˆ¥ï¼Œç®—ä½œã€Œå…¶ä»–ã€
const otherIndex = expenseCategories.findIndex(cat => cat.id === 'other');
if (otherIndex !== -1) {
categoryCounts[otherIndex]++;
categoryAmounts[otherIndex] += redemption.spendAmount;
}
}
});

// è¨­ç½®åœ–è¡¨æ•¸æ“š
if (mode === 'count') {
categoryChart.data.datasets[0].data = categoryCounts;
categoryChart.options.plugins.tooltip.callbacks.label = function(context) {
const value = context.raw;
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
return `${value} æ¬¡ (${percentage}%)`;
};
} else {
categoryChart.data.datasets[0].data = categoryAmounts.map(v => Math.round(v));
categoryChart.options.plugins.tooltip.callbacks.label = function(context) {
const value = context.raw;
const total = context.dataset.data.reduce((a, b) => a + b, 0);
const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
return `${value} å…ƒ (${percentage}%)`;
};
}

categoryChart.update();
}

// æ›´æ–°çµ„åˆåœ–è¡¨ï¼ˆé¢å€¼æˆ–éŠ€è¡Œï¼‰
function updateCombinedChart() {
if (!combinedChart) return;

if (currentChartMode === 'value') {
// é¢å€¼åˆ†ä½ˆåœ–è¡¨ (ä¸æ˜¾ç¤ºç¬‘è„¸å„ªæƒ åˆ¸)
const valueCounts = {10: 0, 20: 0, 50: 0, 100: 0, 200: 0};
let smileyCounts = 0; // å•ç‹¬ç»Ÿè®¡ç¬‘è„¸

appState.vouchers.forEach(voucher => {
if (voucher.amount === 0) {
smileyCounts++;
} else if (valueCounts.hasOwnProperty(voucher.amount)) {
valueCounts[voucher.amount]++;
}
});

// å°‡é¢å€¼å„ªæƒ åˆ¸æ•¸æ“šå’Œç¬‘è‡‰æ•°æ®ç»„åˆåˆ°ä¸€èµ·ï¼Œä½†æ˜¯ç¬‘è‡‰æ”¾åœ¨æœ€å
const chartData = [
valueCounts[10],
valueCounts[20],
valueCounts[50],
valueCounts[100],
valueCounts[200],
smileyCounts
];

combinedChart.data.labels = ['10å…ƒ', '20å…ƒ', '50å…ƒ', '100å…ƒ', '200å…ƒ', 'ğŸ˜„'];
combinedChart.data.datasets[0].data = chartData;
combinedChart.data.datasets[0].backgroundColor = document.documentElement.classList.contains('dark') ?
['#93c5fd', '#93c5fd', '#86efac', '#c084fc', '#c084fc', '#facc15'] :
['#dbeafe', '#dbeafe', '#dcfce7', '#f3e8ff', '#f3e8ff', '#fef08a'];

// ä¿®æ”¹æŸ±ç‹€åœ–é«˜åº¦è¨­ç½®ï¼Œä¸¦é ç•™è¶³å¤ ç©ºé–“é¡¯ç¤ºæ•¸æ“šæ¨™ç±¤
combinedChart.options.scales.y.beginAtZero = true;
const maxCount = Math.max(...chartData);
combinedChart.options.scales.y.max = maxCount > 0 ? Math.ceil(maxCount * 1.2) : 10;

combinedChart.update();
} else {
// éŠ€è¡Œé‡‘é¡åˆ†ä½ˆåœ–è¡¨
console.log("æº–å‚™è¨ˆç®—éŠ€è¡Œé‡‘é¡åˆ†ä½ˆ...");

const bankValues = {};
banks.forEach(bank => {
bankValues[bank.id] = 0;
});

// è¨ˆç®—æ¯å€‹éŠ€è¡Œçš„ç¸½é‡‘é¡ï¼ˆä¸åƒ…æ˜¯å¯å…Œæ›çš„ï¼‰
appState.vouchers.forEach(voucher => {
// å¢åŠ æ›´åš´æ ¼çš„æª¢æŸ¥
if (voucher && voucher.bankId && bankValues.hasOwnProperty(voucher.bankId) && voucher.amount > 0) {
bankValues[voucher.bankId] += voucher.amount;
}
});

console.log("å„éŠ€è¡Œé‡‘é¡:", JSON.stringify(bankValues));

// éæ¿¾ç„¡æ•¸æ“šçš„éŠ€è¡Œä¸¦æŒ‰é‡‘é¡æ’åº
const filteredBanks = banks
.filter(bank => bankValues[bank.id] > 0)
.sort((a, b) => bankValues[b.id] - bankValues[a.id]);

console.log(`éæ¿¾å¾Œæœ‰ ${filteredBanks.length} å€‹éŠ€è¡Œæœ‰æ•¸æ“š`);

const bankLabels = filteredBanks.map(bank => bank.name);
const bankData = filteredBanks.map(bank => {
console.log(`éŠ€è¡Œ ${bank.name}: ${bankValues[bank.id]}å…ƒ`);
return bankValues[bank.id];
});

// éŠ€è¡Œé¡è‰²
const bankColors = filteredBanks.map((bank, i) => {
const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#8b5cf6', '#ec4899', '#f43f5e'];
return colors[i % colors.length];
});

// å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
if (filteredBanks.length === 0) {
console.log("æ²’æœ‰å¯é¡¯ç¤ºçš„éŠ€è¡Œæ•¸æ“š");
combinedChart.data.labels = ['ç„¡æ•¸æ“š'];
combinedChart.data.datasets[0].data = [0];
combinedChart.data.datasets[0].backgroundColor = ['#ccc'];
} else {
combinedChart.data.labels = bankLabels;
combinedChart.data.datasets[0].data = bankData;
combinedChart.data.datasets[0].backgroundColor = bankColors;
}

// ä¿®æ”¹æŸ±ç‹€åœ–é«˜åº¦è¨­ç½®ï¼Œä¸¦é ç•™è¶³å¤ ç©ºé–“é¡¯ç¤ºæ•¸æ“šæ¨™ç±¤
combinedChart.options.scales.y.beginAtZero = true;
const maxValue = Math.max(...(bankData.length > 0 ? bankData : [0]));
combinedChart.options.scales.y.max = maxValue > 0 ? Math.ceil(maxValue * 1.2) : 500;

// å¼·åˆ¶æ›´æ–°åœ–è¡¨
combinedChart.update();
}
}

// æ›´æ–°åœ–è¡¨
function updateCharts() {
if (!statusChart || !categoryChart || !weeklyTrendChart || !combinedChart) return;

// æ›´æ–°çµ„åˆåœ–è¡¨ï¼ˆé¢å€¼æˆ–éŠ€è¡Œï¼‰
updateCombinedChart();

// è¨ˆç®—å„ªæƒ åˆ¸ç‹€æ…‹åˆ†ä½ˆ (åªè®¡ç®—æœ‰æ•ˆä¼˜æƒ åˆ¸ï¼Œæ’é™¤ç¬‘è‡‰)
const statusCounts = [0, 0, 0]; // æœªä½¿ç”¨, å·²å…‘æ›, å·²éæœŸ

appState.vouchers.forEach(voucher => {
// æ’é™¤ç¬‘è‡‰
if (voucher.amount > 0) {
if (voucher.used) {
statusCounts[1]++; // å·²å…‘æ›
} else if (isVoucherExpired(voucher)) {
statusCounts[2]++; // å·²éæœŸ
} else {
statusCounts[0]++; // æœªä½¿ç”¨
}
}
});

// æ›´æ–°ç‹€æ…‹åœ–è¡¨
statusChart.data.datasets[0].data = statusCounts;
statusChart.update();

// æ›´æ–°æ¶ˆè²»é¡åˆ¥åœ–è¡¨ï¼ˆæŒ‰ç•¶å‰æ¨¡å¼ï¼‰
updateCategoryChart(currentCategoryMode);

// å®Œå…¨é‡æ–°è¨ˆç®—æ¯é€±å„ªæƒ åˆ¸é‡‘é¡å’Œå…‘æ›é‡‘é¡
// é¦–å…ˆåˆå§‹åŒ–æ¯å€‹é€±æ¬¡çš„æ•¸æ“šç‚º0
const weeklyVoucherValues = Array(weekSchedule.length).fill(0);
const weeklyRedemptionValues = Array(weekSchedule.length).fill(0);

// ç›´æ¥å¾vouchersæ•¸æ“šä¸­è¨ˆç®—æ¯é€±ç¸½é‡‘é¡
// æ³¨æ„ï¼šåŒ…æ‹¬æ‰€æœ‰å„ªæƒ åˆ¸ï¼Œç„¡è«–æ˜¯å¦å·²å…‘æ›æˆ–éæœŸ
appState.vouchers.forEach(voucher => {
if (voucher.amount > 0) { // æ’é™¤ç¬‘è‡‰
const weekNum = getWeekNumberFromDate(voucher.date);
if (weekNum >= 1 && weekNum <= weekSchedule.length) {
weeklyVoucherValues[weekNum - 1] += voucher.amount;
}
}
});

// æŒ‰é€±æ¬¡çµ±è¨ˆæ¯é€±å…‘æ›é‡‘é¡
appState.redemptionHistory.forEach(redemption => {
const weekNum = redemption.weekNum;
if (weekNum >= 1 && weekNum <= weekSchedule.length) {
weeklyRedemptionValues[weekNum - 1] += redemption.voucherValue;
}
});

// æ›´æ–°é€±æ¬¡è¶¨å‹¢åœ–è¡¨
weeklyTrendChart.data.datasets[0].data = weeklyVoucherValues;
weeklyTrendChart.data.datasets[1].data = weeklyRedemptionValues;
weeklyTrendChart.update();

// æª¢æŸ¥æ•¸æ“šæ˜¯å¦æ­£ç¢º
const totalVoucherAmount = appState.vouchers
.filter(v => v.amount > 0)
.reduce((sum, v) => sum + v.amount, 0);

const chartTotal = weeklyVoucherValues.reduce((sum, v) => sum + v, 0);

console.log("å„ªæƒ åˆ¸ç¸½é‡‘é¡æª¢æŸ¥:", {
"æ•¸æ“šåº«ç¸½é‡‘é¡": totalVoucherAmount,
"åœ–è¡¨é¡¯ç¤ºç¸½é‡‘é¡": chartTotal,
"é€±æ¬¡æ•¸æ“š": weeklyVoucherValues
});

// å¦‚æœç™¼ç¾ç¸½é‡‘é¡ä¸åŒ¹é…ï¼Œè¨˜éŒ„è©³ç´°çš„å„ªæƒ åˆ¸é€±æ¬¡åˆ†ä½ˆ
if (totalVoucherAmount !== chartTotal) {
console.warn("åœ–è¡¨é‡‘é¡èˆ‡ç¸½é‡‘é¡ä¸åŒ¹é…ï¼è©³ç´°é€±æ¬¡åˆ†ä½ˆï¼š");
appState.vouchers.forEach(v => {
if (v.amount > 0) {
console.log(`å„ªæƒ åˆ¸ID: ${v.id}, é‡‘é¡: ${v.amount}, æ—¥æœŸ: ${v.date}, è¨ˆç®—é€±æ¬¡: ${getWeekNumberFromDate(v.date)}`);
}
});
}
}

// åˆå§‹åŒ–å„ªæƒ åˆ¸è®¡ç®—å™¨
function initVoucherCalculator() {
document.getElementById('calculate-recommendation').addEventListener('click', function() {
const amount = parseInt(document.getElementById('payment-amount').value);
if (isNaN(amount) || amount <= 0) {
alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¶ˆè²»é‡‘é¡ï¼');
return;
}

// ç²å–æœªä½¿ç”¨çš„å„ªæƒ åˆ¸ï¼ˆæ’é™¤ç¬‘è‡‰0å…ƒå„ªæƒ åˆ¸ï¼‰
const redeemableVouchers = appState.vouchers.filter(isVoucherRedeemable);

if (redeemableVouchers.length === 0) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-red-500 dark:text-red-400">ç„¡æ³•æ‰¾åˆ°åˆé©çš„å„ªæƒ åˆ¸çµ„åˆ</div>
<div class="text-sm text-gray-500 dark:text-gray-400">æ‚¨ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>
</div>
`;
document.getElementById('recommendation-result').classList.remove('hidden');
return;
}

// ä½¿ç”¨èƒŒåŒ…å•é¡Œè§£æ±ºå„ªæƒ åˆ¸é¸æ“‡å•é¡Œ
// ç›®æ¨™ï¼šæœ€å¤§åŒ–å„ªæƒ åˆ¸ç¸½å€¼ï¼Œä½†ç¸½å€¼çš„3å€ä¸èƒ½è¶…éæ¶ˆè²»é‡‘é¡
const maxValue = Math.floor(amount / 3);

// æ’åºå„ªæƒ åˆ¸ï¼ˆæŒ‰é¢å€¼å¤§å°ç”±å°åˆ°å¤§ï¼‰
const sortedVouchers = [...redeemableVouchers].sort((a, b) => a.amount - b.amount);

// æŒ‰éŠ€è¡Œåˆ†çµ„æ’åºå„ªæƒ åˆ¸
const vouchersByBank = {};
sortedVouchers.forEach(voucher => {
if (!vouchersByBank[voucher.bankId]) {
vouchersByBank[voucher.bankId] = [];
}
vouchersByBank[voucher.bankId].push(voucher);
});

// å‹•æ…‹è¦åŠƒæ±‚è§£
const dp = new Array(maxValue + 1).fill(0); // dp[i] = ç•¶é¢å€¼ä¸è¶…éiæ™‚èƒ½é”åˆ°çš„æœ€å¤§å„ªæƒ åˆ¸ç¸½å€¼
const selected = new Array(maxValue + 1).fill(null).map(() => []); // è¨˜éŒ„é¸ä¸­çš„å„ªæƒ åˆ¸

// å„ªå…ˆè™•ç†å–®ä¸€éŠ€è¡Œçš„æœ€ä½³çµ„åˆ
let bestBankCombination = null;
let bestBankValue = 0;

// å˜—è©¦æ¯å€‹éŠ€è¡Œçš„çµ„åˆ
Object.keys(vouchersByBank).forEach(bankId => {
const bankVouchers = vouchersByBank[bankId];

// ç‚ºè©²éŠ€è¡Œå–®ç¨åŸ·è¡Œå‹•æ…‹è¦åŠƒ
const bankDp = new Array(maxValue + 1).fill(0);
const bankSelected = new Array(maxValue + 1).fill(null).map(() => []);

for (const voucher of bankVouchers) {
for (let j = maxValue; j >= voucher.amount; j--) {
const newValue = bankDp[j - voucher.amount] + voucher.amount;
if (newValue > bankDp[j]) {
bankDp[j] = newValue;
bankSelected[j] = [...bankSelected[j - voucher.amount], voucher];
}
}
}

// å¦‚æœè©²éŠ€è¡Œçš„æœ€ä½³çµ„åˆæ¯”ä¹‹å‰æ‰¾åˆ°çš„æ›´å¥½ï¼Œå‰‡æ›´æ–°
if (bankDp[maxValue] > bestBankValue) {
bestBankValue = bankDp[maxValue];
bestBankCombination = bankSelected[maxValue];
}
});

// å¦‚æœå–®ä¸€éŠ€è¡Œçš„æœ€ä½³çµ„åˆå·²ç¶“è¶³å¤ å¥½ï¼Œç›´æ¥ä½¿ç”¨
if (bestBankCombination && bestBankCombination.length > 0) {
// å¦‚æœå–®ä¸€éŠ€è¡Œå„ªæƒ åˆ¸çš„ç¸½å€¼å·²ç¶“é”åˆ°å¯ç”¨ç¸½å€¼çš„75%ä»¥ä¸Šï¼Œå„ªå…ˆä½¿ç”¨å–®ä¸€éŠ€è¡Œçµ„åˆ
const totalPossibleValue = Math.min(maxValue, sortedVouchers.reduce((sum, v) => sum + v.amount, 0));
if (bestBankValue >= totalPossibleValue * 0.75) {
selected[maxValue] = bestBankCombination;
} else {
// å¦å‰‡åŸ·è¡Œæ­£å¸¸çš„è·¨è¡Œå‹•æ…‹è¦åŠƒ
for (const voucher of sortedVouchers) {
for (let j = maxValue; j >= voucher.amount; j--) {
const newValue = dp[j - voucher.amount] + voucher.amount;
if (newValue > dp[j]) {
dp[j] = newValue;
selected[j] = [...selected[j - voucher.amount], voucher];
}
}
}

// å„ªå…ˆé¸æ“‡å–®ä¸€éŠ€è¡Œçµ„åˆï¼Œé™¤éå¤šéŠ€è¡Œçµ„åˆèƒ½æä¾›æ˜é¡¯æ›´å¤šåƒ¹å€¼
if (dp[maxValue] > bestBankValue * 1.2) { // å¦‚æœå¤šéŠ€è¡Œçµ„åˆè‡³å°‘æä¾›20%æ›´å¤šåƒ¹å€¼
// ä½¿ç”¨å¤šéŠ€è¡Œæ–¹æ¡ˆ
} else {
selected[maxValue] = bestBankCombination; // å¦å‰‡å„ªå…ˆä½¿ç”¨å–®ä¸€éŠ€è¡Œæ–¹æ¡ˆ
}
}
} else {
// å¦‚æœæ²’æœ‰å–®ä¸€éŠ€è¡Œçš„æœ‰æ•ˆçµ„åˆï¼ŒåŸ·è¡Œå¸¸è¦çš„è·¨è¡Œå‹•æ…‹è¦åŠƒ
for (const voucher of sortedVouchers) {
for (let j = maxValue; j >= voucher.amount; j--) {
const newValue = dp[j - voucher.amount] + voucher.amount;
if (newValue > dp[j]) {
dp[j] = newValue;
selected[j] = [...selected[j - voucher.amount], voucher];
}
}
}
}

// æ‰¾å‡ºæœ€ä½³çµ„åˆ
const bestVouchers = selected[maxValue];

if (bestVouchers.length === 0) {
// æ‰¾ä¸åˆ°å®Œå…¨åŒ¹é…çš„çµ„åˆï¼Œçœ‹æ˜¯å¦éœ€è¦å¤šæ¶ˆè²»
let closestVoucher = null;
let smallestDiff = Infinity;

for (const voucher of redeemableVouchers) {
const diff = voucher.amount * 3 - amount;
if (diff > 0 && diff < smallestDiff) {
smallestDiff = diff;
closestVoucher = voucher;
}
}

if (closestVoucher) {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-yellow-500 dark:text-yellow-400">æ¶ˆè²»é‡‘é¡ä¸è¶³</div>
<div class="text-sm mb-3">
æœ€æ¥è¿‘çš„å„ªæƒ åˆ¸ç‚º${closestVoucher.amount}å…ƒï¼Œéœ€æ¶ˆè²»${closestVoucher.amount * 3}å…ƒ
</div>
<div class="text-sm">æ‚¨é‚„éœ€å¢åŠ ${closestVoucher.amount * 3 - amount}å…ƒæ¶ˆè²»é‡‘é¡</div>
<button id="use-closest-voucher" class="mt-3 w-full py-2 bg-primary text-white rounded-lg">
é¸æ“‡ä½¿ç”¨${closestVoucher.amount}å…ƒå„ªæƒ åˆ¸
</button>
</div>
`;

document.getElementById('use-closest-voucher').onclick = function() {
appState.selectedVouchers = [closestVoucher.id];
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();
document.querySelector('[data-tab="redeem"]').click();
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
document.getElementById('manual-spend-amount').value = closestVoucher.amount * 3;
};
} else {
document.getElementById('recommendation-result').innerHTML = `
<div class="text-center py-4">
<div class="text-red-500 dark:text-red-400">ç„¡æ³•æ‰¾åˆ°åˆé©çš„å„ªæƒ åˆ¸çµ„åˆ</div>
<div class="text-sm text-gray-500 dark:text-gray-400">æ¶ˆè²»é‡‘é¡ä¸è¶³ä»¥å…‘æ›ä»»ä½•å„ªæƒ åˆ¸</div>
</div>
`;
}
} else {
// è¨ˆç®—ç¸½å€¼å’Œæ‰€éœ€æ¶ˆè²»é‡‘é¡
const totalValue = bestVouchers.reduce((sum, v) => sum + v.amount, 0);
const requiredAmount = totalValue * 3;

// æŒ‰éŠ€è¡Œåˆ†çµ„
const bankVouchers = {};
bestVouchers.forEach(voucher => {
if (!bankVouchers[voucher.bankId]) {
bankVouchers[voucher.bankId] = [];
}
bankVouchers[voucher.bankId].push(voucher);
});

// ç”ŸæˆéŠ€è¡Œåˆ—è¡¨
let bankHTML = '';
Object.entries(bankVouchers).forEach(([bankId, vouchers]) => {
const bank = banks.find(b => b.id === bankId);
if (!bank) return;

// æŒ‰é¢å€¼åˆ†çµ„
const amountCounts = {};
vouchers.forEach(v => {
if (!amountCounts[v.amount]) amountCounts[v.amount] = 0;
amountCounts[v.amount]++;
});

const bankTotal = vouchers.reduce((sum, v) => sum + v.amount, 0);

bankHTML += `
<div class="mb-2 border rounded p-2">
<div class="flex items-center justify-between">
<div class="flex items-center">
<i class="${bank.logo} text-${bank.color} dark:text-${bank.color} mr-2"></i>
<span class="font-medium">${bank.name}</span>
</div>
<div>${vouchers.length}å¼µ (${bankTotal}å…ƒ)</div>
</div>
<div class="ml-4 text-xs text-gray-500 dark:text-gray-400 mt-1">
${Object.entries(amountCounts).map(([amt, count]) => `${amt}å…ƒ: ${count}å¼µ`).join(', ')}
</div>
</div>
`;
});

document.getElementById('recommendation-result').innerHTML = `
<div>
<div class="text-green-500 dark:text-green-400 font-bold mb-2">æ‰¾åˆ°æœ€ä½³çµ„åˆ</div>
<div class="text-sm mb-3">
<div>æ¶ˆè²»é‡‘é¡: ${amount}å…ƒ</div>
<div>ç¯€çœé‡‘é¡: ${totalValue}å…ƒ</div>
<div>è‡ªè²»é‡‘é¡: ${amount - totalValue}å…ƒ</div>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">æ‰€éœ€æ¶ˆè²»: ${requiredAmount}å…ƒ</div>
<div class="mt-1">ä½¿ç”¨å„ªæƒ åˆ¸: ${bestVouchers.length}å¼µ</div>
</div>
<div class="mt-3 pt-2 border-t">
<div class="font-medium mb-1">å„ªæƒ åˆ¸æ˜ç´°:</div>
${bankHTML}
</div>
<div class="mt-3 pt-3 border-t">
<button id="select-recommended-vouchers" class="w-full bg-primary hover:bg-primary-dark text-white py-2 rounded-lg">
é¸æ“‡é€™äº›å„ªæƒ åˆ¸
</button>
</div>
</div>
`;

// æ·»åŠ é¸æ“‡æŒ‰éˆ•äº‹ä»¶
document.getElementById('select-recommended-vouchers').onclick = function() {
// å°‡æ¨è–¦çš„å„ªæƒ åˆ¸æ·»åŠ åˆ°å·²é¸æ“‡åˆ—è¡¨
appState.selectedVouchers = bestVouchers.map(v => v.id);

// æ›´æ–°UI
saveAppState();
updateVoucherSelection();
updateSelectedVouchers();

// è¨­ç½®æ¶ˆè²»é‡‘é¡
document.getElementById('manual-spend-amount').value = amount;

// åˆ‡æ›åˆ°å…‘æ›é¸é …å¡
document.querySelector('[data-tab="redeem"]').click();

// éš±è—çµæœ
document.getElementById('recommendation-result').classList.add('hidden');
document.getElementById('payment-amount').value = '';
};
}

document.getElementById('recommendation-result').classList.remove('hidden');
});

// Enteréµè§¸ç™¼è¨ˆç®—
document.getElementById('payment-amount').addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
document.getElementById('calculate-recommendation').click();
}
});
}

// åˆå§‹åŒ–é¸é …å¡åŠŸèƒ½
function initTabs() {
const tabButtons = document.querySelectorAll('#tabs button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
button.addEventListener('click', function() {
const tabName = this.getAttribute('data-tab');

// æ›´æ–°æŒ‰éˆ•æ¨£å¼
tabButtons.forEach(btn => {
btn.classList.remove('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');
btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
});

this.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
this.classList.add('text-primary', 'dark:text-primary', 'border-primary', 'dark:border-primary', 'tab-active');

// é¡¯ç¤ºå°æ‡‰å…§å®¹
tabContents.forEach(content => {
content.classList.add('hidden');
});

document.getElementById(`${tabName}-content`).classList.remove('hidden');

// æ›´æ–°åœ–è¡¨
if (tabName === 'charts') {
updateCharts();
}

// æ›´æ–°çµ±è¨ˆåˆ†æ
if (tabName === 'stats') {
updateDetailedAnalysis();
}
});
});
}

// åˆå§‹åŒ–æ•¸æ“šç®¡ç†
function initDataManagement() {
// åŒ¯å‡ºæ•¸æ“š
document.getElementById('export-data-btn').addEventListener('click', function() {
// ç”ŸæˆåŒ¯å‡ºå…§å®¹
const summary = document.getElementById('export-summary');
const valueDistribution = document.getElementById('export-value-distribution');
const bankDistribution = document.getElementById('export-bank-distribution');
const categoryDistribution = document.getElementById('export-category-distribution');
const weeklyData = document.getElementById('export-weekly-data');

// 1. ç¸½è¦½çµ±è¨ˆ
const totalCount = appState.vouchers.length;
const redeemableCount = getRedeemableVoucherCount();
const smileCount = appState.vouchers.filter(v => v.amount === 0).length;
const totalValue = appState.vouchers.reduce((sum, v) => sum + v.amount, 0);
const usedCount = appState.vouchers.filter(v => v.used).length;
const expiredCount = appState.vouchers.filter(v => !v.used && isVoucherExpired(v) && v.amount > 0).length;
const unusedCount = redeemableCount;
const usageRate = (totalCount - smileCount) > 0 ?
Math.round((usedCount / (totalCount - smileCount)) * 100) : 0;

summary.innerHTML = `
<div>ç¸½å„ªæƒ åˆ¸: ${totalCount}å¼µ (ç¸½åƒ¹å€¼: ${totalValue}å…ƒ)</div>
<div>å¯å…‘æ›å„ªæƒ åˆ¸: ${redeemableCount}å¼µ</div>
<div>ç¬‘è‡‰å„ªæƒ åˆ¸: ${smileCount}å¼µ (ä¸å¯å…‘æ›)</div>
<div>æœªä½¿ç”¨: ${unusedCount}å¼µ, å·²å…‘æ›: ${usedCount}å¼µ, å·²éæœŸ: ${expiredCount}å¼µ</div>
<div>ä½¿ç”¨ç‡: ${usageRate}%</div>
`;

// 2. é¢å€¼åˆ†ä½ˆ
const valueCounts = {0: 0, 10: 0, 20: 0, 50: 0, 100: 0, 200: 0};
appState.vouchers.forEach(v => valueCounts[v.amount]++);

valueDistribution.innerHTML = `
<div>ç¬‘è‡‰(0å…ƒ): ${valueCounts[0]}å¼µ (ä¸å¯å…‘æ›)</div>
<div>10å…ƒ: ${valueCounts[10]}å¼µ</div>
<div>20å…ƒ: ${valueCounts[20]}å¼µ</div>
<div>50å…ƒ: ${valueCounts[50]}å¼µ</div>
<div>100å…ƒ: ${valueCounts[100]}å¼µ</div>
<div>200å…ƒ: ${valueCounts[200]}å¼µ</div>
`;

// 3. éŠ€è¡Œåˆ†ä½ˆ
const bankCounts = {};
const bankValues = {};
const bankRedeemableCounts = {};

banks.forEach(bank => {
bankCounts[bank.id] = 0;
bankValues[bank.id] = 0;
bankRedeemableCounts[bank.id] = 0;
});

appState.vouchers.forEach(v => {
if (v.bankId) {
bankCounts[v.bankId] = (bankCounts[v.bankId] || 0) + 1;
bankValues[v.bankId] = (bankValues[v.bankId] || 0) + v.amount;

// è¨ˆç®—å¯å…‘æ›æ•¸é‡
if (isVoucherRedeemable(v)) {
bankRedeemableCounts[v.bankId] = (bankRedeemableCounts[v.bankId] || 0) + 1;
}
}
});

let bankHTML = '';
banks.forEach(bank => {
if (bankCounts[bank.id] > 0) {
bankHTML += `<div>${bank.name}: ${bankCounts[bank.id]}å¼µ (${bankValues[bank.id]}å…ƒ)`;

// æ·»åŠ å¯å…‘æ›æ•¸é‡
if (bankRedeemableCounts[bank.id] > 0) {
bankHTML += ` - å¯å…‘æ›: ${bankRedeemableCounts[bank.id]}å¼µ`;
}

bankHTML += `</div>`;
}
});

bankDistribution.innerHTML = bankHTML || '<div>ç„¡éŠ€è¡Œæ•¸æ“š</div>';

// 4. æ¶ˆè²»é¡åˆ¥åˆ†æ
const categoryCounts = {};
const categoryAmounts = {};

expenseCategories.forEach(cat => {
categoryCounts[cat.id] = 0;
categoryAmounts[cat.id] = 0;
});

appState.redemptionHistory.forEach(redemption => {
const categories = redemption.categories || ['other'];
const amountPerCategory = redemption.spendAmount / categories.length;

categories.forEach(category => {
categoryCounts[category] = (categoryCounts[category] || 0) + 1;
categoryAmounts[category] = (categoryAmounts[category] || 0) + amountPerCategory;
});
});

let categoryHTML = '';
expenseCategories.forEach(cat => {
if (categoryCounts[cat.id] > 0) {
categoryHTML += `<div>${cat.name}: ${categoryCounts[cat.id]}æ¬¡ (${Math.round(categoryAmounts[cat.id])}å…ƒ)</div>`;
}
});

categoryDistribution.innerHTML = categoryHTML || '<div>ç„¡æ¶ˆè²»é¡åˆ¥æ•¸æ“š</div>';

// 5. é€±æ¬¡æ•¸æ“š
let weeklyHTML = '';
appState.weekRecords.forEach(record => {
if (record.voucherCount > 0) {
// è¨ˆç®—å¯å…‘æ›
const redeemableCount = record.redeemableCount ||
(record.voucherCount - record.usedCount - record.valueCounts[0]);

weeklyHTML += `
<div>ç¬¬${record.weekNum}é€±: ${record.voucherCount}å¼µ (${record.voucherValue}å…ƒ)</div>
<div class="ml-2 text-xs">å·²å…‘æ›: ${record.usedCount}å¼µ, å¯å…‘æ›: ${redeemableCount}å¼µ, æ¶ˆè²»é‡‘é¡: ${record.spendAmount || 0}å…ƒ</div>
`;
}
});

weeklyData.innerHTML = weeklyHTML || '<div>ç„¡é€±æ¬¡æ•¸æ“š</div>';

// ç”ŸæˆåŒ¯å‡ºå ±å‘Šçš„ç´”æ–‡æœ¬ç‰ˆæœ¬
let reportText = `=== 2025å¹´ç¤¾å€æ¶ˆè²»å¤§çè³è¿½è¹¤å™¨ - å ±å‘Š ===\n\n`;

// ç¸½è¦½
reportText += `ã€ç¸½è¦½çµ±è¨ˆã€‘\n`;
reportText += `ç¸½å„ªæƒ åˆ¸: ${totalCount}å¼µ (ç¸½åƒ¹å€¼: ${totalValue}å…ƒ)\n`;
reportText += `å¯å…‘æ›å„ªæƒ åˆ¸: ${redeemableCount}å¼µ\n`;
reportText += `ç¬‘è‡‰å„ªæƒ åˆ¸: ${smileCount}å¼µ (ä¸å¯å…‘æ›)\n`;
reportText += `æœªä½¿ç”¨: ${unusedCount}å¼µ, å·²å…‘æ›: ${usedCount}å¼µ, å·²éæœŸ: ${expiredCount}å¼µ\n`;
reportText += `ä½¿ç”¨ç‡: ${usageRate}%\n\n`;

// é¢å€¼åˆ†ä½ˆ
reportText += `ã€é¢å€¼åˆ†ä½ˆã€‘\n`;
reportText += `ç¬‘è‡‰(0å…ƒ): ${valueCounts[0]}å¼µ (ä¸å¯å…‘æ›)\n`;
reportText += `10å…ƒ: ${valueCounts[10]}å¼µ\n`;
reportText += `20å…ƒ: ${valueCounts[20]}å¼µ\n`;
reportText += `50å…ƒ: ${valueCounts[50]}å¼µ\n`;
reportText += `100å…ƒ: ${valueCounts[100]}å¼µ\n`;
reportText += `200å…ƒ: ${valueCounts[200]}å¼µ\n\n`;

// éŠ€è¡Œåˆ†ä½ˆ
reportText += `ã€éŠ€è¡Œåˆ†ä½ˆã€‘\n`;
banks.forEach(bank => {
if (bankCounts[bank.id] > 0) {
reportText += `${bank.name}: ${bankCounts[bank.id]}å¼µ (${bankValues[bank.id]}å…ƒ)`;

// æ·»åŠ å¯å…‘æ›æ•¸é‡
if (bankRedeemableCounts[bank.id] > 0) {
reportText += ` - å¯å…‘æ›: ${bankRedeemableCounts[bank.id]}å¼µ`;
}

reportText += `\n`;
}
});
reportText += `\n`;

// æ¶ˆè²»é¡åˆ¥åˆ†æ
reportText += `ã€æ¶ˆè²»é¡åˆ¥åˆ†æã€‘\n`;
expenseCategories.forEach(cat => {
if (categoryCounts[cat.id] > 0) {
reportText += `${cat.name}: ${categoryCounts[cat.id]}æ¬¡ (${Math.round(categoryAmounts[cat.id])}å…ƒ)\n`;
}
});
reportText += `\n`;

// é€±æ¬¡æ•¸æ“š
reportText += `ã€é€±æ¬¡æ•¸æ“šã€‘\n`;
appState.weekRecords.forEach(record => {
if (record.voucherCount > 0) {
const redeemableCount = record.redeemableCount ||
(record.voucherCount - record.usedCount - record.valueCounts[0]);

reportText += `ç¬¬${record.weekNum}é€±: ${record.voucherCount}å¼µ (${record.voucherValue}å…ƒ)\n`;
reportText += ` å·²å…‘æ›: ${record.usedCount}å¼µ, å¯å…‘æ›: ${redeemableCount}å¼µ, æ¶ˆè²»é‡‘é¡: ${record.spendAmount || 0}å…ƒ\n`;
}
});

// å‰µå»ºç•¶å‰æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ç‚º YYYYMMDD
const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');

// è¨­ç½®ä¸‹è¼‰æŒ‰éˆ•
document.getElementById('download-export-btn').onclick = function() {
// å‰µå»ºBlobå°è±¡
const blob = new Blob([reportText], {type: 'text/plain'});

// å‰µå»ºä¸‹è¼‰éˆæ¥
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `å„ªæƒ åˆ¸çµ±è¨ˆå ±å‘Š_${dateStr}.txt`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
};

// è¨­ç½®è¤‡è£½æŒ‰éˆ•
document.getElementById('copy-export-data-btn').onclick = function() {
navigator.clipboard.writeText(reportText)
.then(() => {
alert('å ±å‘Šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
})
.catch(e => {
alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½å ±å‘Šã€‚');
console.error('è¤‡è£½å¤±æ•—:', e);
});
};

// é¡¯ç¤ºåŒ¯å‡ºæ¨¡æ…‹æ¡†
document.getElementById('export-data-modal').classList.remove('hidden');
});

// é—œé–‰åŒ¯å‡ºæ•¸æ“šæ¨¡æ…‹æ¡†
document.getElementById('close-export-data').addEventListener('click', function() {
document.getElementById('export-data-modal').classList.add('hidden');
});

document.getElementById('close-export-modal-btn').addEventListener('click', function() {
document.getElementById('export-data-modal').classList.add('hidden');
});

// å‚™ä»½/æ¢å¾©æ•¸æ“š
document.getElementById('data-management-btn').addEventListener('click', function() {
// é¡¯ç¤ºå‚™ä»½æ•¸æ“šç•«é¢
const dataStr = JSON.stringify(appState);
document.getElementById('backup-code').textContent = dataStr;

// æ¸…ç©ºåŒ¯å…¥æ¡†
document.getElementById('import-data-textarea').value = '';

// è¨ˆç®—ä¸¦é¡¯ç¤ºå­˜å„²ä½¿ç”¨æƒ…æ³
calculateStorageSize();

// é¡¯ç¤ºæ¨¡æ…‹æ¡†
document.getElementById('data-management-modal').classList.remove('hidden');
});

// è¤‡è£½å‚™ä»½ç¢¼
document.getElementById('copy-backup-code').addEventListener('click', function() {
const backupCode = document.getElementById('backup-code').textContent;
try {
navigator.clipboard.writeText(backupCode)
.then(() => {
alert('å‚™ä»½ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
})
.catch(e => {
// å¦‚æœAPIè¤‡è£½å¤±æ•—ï¼Œæä¾›å…¶ä»–è¤‡è£½æ–¹å¼
const textArea = document.createElement('textarea');
textArea.value = backupCode;
document.body.appendChild(textArea);
textArea.select();
document.execCommand('copy');
document.body.removeChild(textArea);
alert('å‚™ä»½ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
});
} catch (e) {
alert('ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•å…¨é¸æ–‡æœ¬ä¸¦æŒ‰Ctrl+Cè¤‡è£½');
}
});

// æ¢å¾©æ•¸æ“š
document.getElementById('restore-data-btn').addEventListener('click', function() {
const importData = document.getElementById('import-data-textarea').value.trim();
if (!importData) {
alert('è«‹è¼¸å…¥å‚™ä»½ç¢¼ï¼');
return;
}

try {
// å˜—è©¦è§£ææ•¸æ“š
const parsedData = JSON.parse(importData);

// æª¢æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„å±¬æ€§
if (!parsedData.vouchers) {
throw new Error('ç„¡æ•ˆçš„å‚™ä»½æ•¸æ“šï¼šç¼ºå°‘å„ªæƒ åˆ¸è³‡æ–™');
}

// ç¢ºèªæ˜¯å¦è¦è¦†è“‹ç•¶å‰æ•¸æ“š
if (confirm('ç¢ºå®šè¦ä½¿ç”¨å‚™ä»½æ•¸æ“šè¦†è“‹ç•¶å‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) {
// ä¿å­˜ç•¶å‰æ•¸æ“šç‚ºè‡¨æ™‚å‚™ä»½ï¼Œä»¥é˜²æ¢å¾©å¤±æ•—
const tempBackup = JSON.stringify(appState);

try {
// æ›´æ–°æ‡‰ç”¨ç‹€æ…‹
appState = parsedData;

// ç¢ºä¿å…¼å®¹èˆŠç‰ˆæœ¬æ•¸æ“š
if (!appState.selectedVouchers) appState.selectedVouchers = [];
if (!appState.weekRecords) appState.weekRecords = [];
if (!appState.redemptionHistory) appState.redemptionHistory = [];
if (!appState.bankDisplayFilter) appState.bankDisplayFilter = banks.map(bank => bank.id);
if (!appState.bankFilter) appState.bankFilter = { active: false, selectedBanks: [] };

// ç¢ºä¿æœ‰ä¸‹ä¸€å€‹æ¶ˆè²»ç·¨è™Ÿ
if (!appState.nextRedemptionId) {
appState.nextRedemptionId = appState.redemptionHistory.length > 0 ?
Math.max(...appState.redemptionHistory.map(r => Number(r.displayId) || 0)) + 1 : 1;
}

// è™•ç†èˆŠç‰ˆæœ¬æ•¸æ“šå…¼å®¹æ€§ - åœ¨èˆŠè¨˜éŒ„ä¸­æ·»åŠ æ¶ˆè²»é¡åˆ¥å±¬æ€§
appState.redemptionHistory.forEach(redemption => {
if (!redemption.categories) {
redemption.categories = ['other']; // é»˜èªç‚ºå…¶ä»–é¡åˆ¥
}
// æ·»åŠ æ’¤å›ç‹€æ…‹å±¬æ€§
if (redemption.withdrawn === undefined) {
redemption.withdrawn = false;
}
});

// æ›´æ–°ç•¶å‰é€±æ¬¡
appState.currentWeek = calculateCurrentWeek();

// æ›´æ–°é€±æ¬¡è¨˜éŒ„
updateWeekRecords();

// ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
saveAppState();

// æ›´æ–°UI
updateDateDisplay();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateWeekRecordsDisplay();
updateRedemptionHistory();
updateDetailedAnalysis();
updateCharts();

// é—œé–‰æ¨¡æ…‹æ¡†
document.getElementById('data-management-modal').classList.add('hidden');

alert('æ•¸æ“šæ¢å¾©æˆåŠŸï¼');
} catch (restoreError) {
// å¦‚æœæ¢å¾©éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œå˜—è©¦æ¢å¾©åˆ°è‡¨æ™‚å‚™ä»½
try {
appState = JSON.parse(tempBackup);
saveAppState();
alert('æ¢å¾©å¤±æ•—ï¼Œå·²é‚„åŸåˆ°ä¹‹å‰çš„æ•¸æ“šã€‚éŒ¯èª¤: ' + restoreError.message);
} catch (backupError) {
alert('æ¢å¾©å¤±æ•—ï¼Œä¸”ç„¡æ³•é‚„åŸåˆ°ä¹‹å‰çš„æ•¸æ“šã€‚è«‹é‡æ–°åŠ è¼‰é é¢ã€‚éŒ¯èª¤: ' + restoreError.message);
}
}
}
} catch (e) {
alert('ç„¡æ•ˆçš„å‚™ä»½ç¢¼æ ¼å¼ã€‚è«‹ç¢ºä¿æ‚¨è¤‡è£½äº†å®Œæ•´çš„å‚™ä»½ç¢¼ã€‚éŒ¯èª¤: ' + e.message);
}
});

// é—œé–‰æ•¸æ“šç®¡ç†æ¨¡æ…‹æ¡†
document.getElementById('close-data-management').addEventListener('click', function() {
document.getElementById('data-management-modal').classList.add('hidden');
});

document.getElementById('close-management-btn').addEventListener('click', function() {
document.getElementById('data-management-modal').classList.add('hidden');
});
}

// æ‡‰ç”¨ç¨‹åºå•Ÿå‹•
document.addEventListener('DOMContentLoaded', function() {
// åˆå§‹åŒ–åŠŸèƒ½
initTabs();
initVoucherCalculator();
initDataManagement();
initCharts();
initAdminMode();

// ç¢ºä¿åˆå§‹åŒ–éŠ€è¡Œé¡¯ç¤ºéæ¿¾å™¨
if (!appState.bankDisplayFilter) {
appState.bankDisplayFilter = banks.map(bank => bank.id);
}

// ç¢ºä¿åˆå§‹åŒ–éŠ€è¡Œéæ¿¾å™¨
if (!appState.bankFilter) {
appState.bankFilter = {
active: false,
selectedBanks: []
};
}

// åˆå§‹åŒ–éŠ€è¡Œéæ¿¾å™¨
function initBankFilters() {
const bankFiltersContainer = document.getElementById('bank-filters');
if (!bankFiltersContainer) {
console.error("æ‰¾ä¸åˆ°bank-filterså®¹å™¨");
return;
}

bankFiltersContainer.innerHTML = '';

// ç‚ºæ¯å€‹éŠ€è¡Œå‰µå»ºéæ¿¾æŒ‰éˆ•
banks.forEach(bank => {
const isSelected = appState.bankDisplayFilter.includes(bank.id);

const filterBtn = document.createElement('button');
filterBtn.className = `text-xs px-2 py-1 rounded-full flex items-center ${
isSelected ? 'bg-' + bank.color + ' text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
}`;
filterBtn.setAttribute('data-bank', bank.id);
filterBtn.innerHTML = `<i class="${bank.logo} mr-1"></i> ${bank.name}`;

filterBtn.addEventListener('click', function() {
const bankId = this.getAttribute('data-bank');

// åˆ‡æ›é¸ä¸­ç‹€æ…‹
if (appState.bankDisplayFilter.includes(bankId)) {
appState.bankDisplayFilter = appState.bankDisplayFilter.filter(id => id !== bankId);
} else {
appState.bankDisplayFilter.push(bankId);
}

saveAppState();
initBankFilters(); // é‡æ–°åˆå§‹åŒ–éæ¿¾å™¨
});

bankFiltersContainer.appendChild(filterBtn);
});

// æ·»åŠ å…¨é¸å’Œæ¸…ç©ºæŒ‰éˆ•
const allBtn = document.createElement('button');
allBtn.className = 'text-xs px-2 py-1 rounded-full bg-primary text-white';
allBtn.textContent = 'å…¨é¸';
allBtn.addEventListener('click', function() {
appState.bankDisplayFilter = banks.map(bank => bank.id);
saveAppState();
initBankFilters();
});

const clearBtn = document.createElement('button');
clearBtn.className = 'text-xs px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
clearBtn.textContent = 'æ¸…ç©º';
clearBtn.addEventListener('click', function() {
appState.bankDisplayFilter = [];
saveAppState();
initBankFilters();
});

bankFiltersContainer.appendChild(allBtn);
bankFiltersContainer.appendChild(clearBtn);
}

// éŠ€è¡Œé¡¯ç¤ºè¨­ç½®
const bankSettingsBtn = document.getElementById('bank-display-settings-btn');
if (bankSettingsBtn) {
bankSettingsBtn.addEventListener('click', function() {
initBankFilters();
document.getElementById('bank-display-settings-modal').classList.remove('hidden');
});
}

const closeBtn = document.getElementById('close-bank-display-settings');
if (closeBtn) {
closeBtn.addEventListener('click', function() {
document.getElementById('bank-display-settings-modal').classList.add('hidden');
});
}

const selectAllBtn = document.getElementById('select-all-display-banks');
if (selectAllBtn) {
selectAllBtn.addEventListener('click', function() {
appState.bankDisplayFilter = banks.map(bank => bank.id);
saveAppState();
initBankFilters();
});
}

const clearDisplayBtn = document.getElementById('clear-display-banks');
if (clearDisplayBtn) {
clearDisplayBtn.addEventListener('click', function() {
appState.bankDisplayFilter = [];
saveAppState();
initBankFilters();
});
}

const saveBtn = document.getElementById('save-bank-display-settings');
if (saveBtn) {
saveBtn.addEventListener('click', function() {
document.getElementById('bank-display-settings-modal').classList.add('hidden');
updateBankButtons();
updateBankOverview();
updateCharts();
});
}

// åŠ è¼‰æ•¸æ“šå’Œåˆå§‹åŒ–UI
loadAppState();
updateDateDisplay();
updateWeekSchedule();
updateBankButtons();
updateQuickAddPanel();
updateBankOverview();
updateRedeemableVouchers();
updateVoucherSelection();
updateSelectedVouchers();
updateTotalStats();
updateWeekRecordsDisplay();
updateRedemptionHistory();
updateDetailedAnalysis();
updateCharts();

// è¨ˆç®—ç•¶å‰å­˜å„²ä½¿ç”¨é‡
setTimeout(calculateStorageSize, 500); // å»¶é²è¨ˆç®—ä»¥ç¢ºä¿æ‰€æœ‰æ•¸æ“šéƒ½å·²åŠ è¼‰
});
</script>
</body>
</html>

